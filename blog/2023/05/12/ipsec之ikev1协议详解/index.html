<!DOCTYPE HTML>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" /> 
    <title>IPSec之IKEv1协议详解 - Golang编程语言知识介绍</title>
    <meta name="keywords" content="git,Git,Lua,lua,Golang,go">
    
    <meta property="og:title" content="IPSec之IKEv1协议详解">
    <meta property="og:site_name" content="Golang编程语言知识介绍">
    <meta property="og:image" content="/img/author.jpg"> 
    <meta name="title" content="IPSec之IKEv1协议详解 - Golang编程语言知识介绍" />
    <meta name="description" content="愿星光伴你左右"> 
    <link rel="shortcut icon" href="http://shanks.link/img/favicon.ico" />
    <link rel="apple-touch-icon" href="http://shanks.link/img/apple-touch-icon.png" />
    <link rel="apple-touch-icon-precomposed" href="http://shanks.link/img/apple-touch-icon.png" />
    <link href="http://shanks.link/js/vendor/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />
    <link href="http://shanks.link/js/vendor/fancybox/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />
    <link href="http://shanks.link/css/main.css" rel="stylesheet" type="text/css" />
    <link href="http://shanks.link/css/syntax.css" rel="stylesheet" type="text/css" />
    <script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post"},
     fancybox: true, 
    motion: true
  };
</script>
</head>
<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">
<div class="container one-collumn sidebar-position-left page-home  ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"> <div class="site-meta  custom-logo ">

  <div class="custom-logo-site-title">
    <a href="http://shanks.link/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">Golang编程语言知识介绍</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle"></p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
    <ul id="menu" class="menu">
      
      
        <li class="menu-item ">
          <a href="http://shanks.link/post/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />首页
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/thinking/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />随想录
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/%E7%94%9F%E6%B4%BB/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />生活
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/os/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />OS
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/lua/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />lua
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/redis/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />redis
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/go/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />Golang
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/c/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />C
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/tcpip/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />TCP/IP
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/ebpf/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />ebpf
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/p4/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />p4
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/openvpn/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />OpenVPN
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/ipsec/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />IPSec
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/l2tp/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />L2TP
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/web/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />web
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/openwrt/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />OpenWRT
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/%E8%BF%90%E7%BB%B4/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />运维
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/git/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />Git
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/%E9%B8%9F%E5%93%A5%E7%9A%84%E7%A7%81%E6%88%BF%E8%8F%9C/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />鸟哥的私房菜
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/it/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />IT杂谈
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/about/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />About Me
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/links/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />友情链接
          </a>
        </li>
      
      <li class="menu-item menu-item-search">
        <a href="javascript:;" class="popup-trigger"> <i class="menu-item-icon fa fa-search fa-fw"></i> <br /> 搜索</a>
      </li>
    </ul>
    <div class="site-search">
      <div class="popup">
 <span class="search-icon fa fa-search"></span>
 <input type="text" id="local-search-input">
 <div id="local-search-result"></div>
 <span class="popup-btn-close">close</span>
</div>

    </div>
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
<section id="posts" class="posts-expand">
  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <header class="post-header">
      <h1 class="post-title" itemprop="name headline">
        <a class="post-title-link" href="http://shanks.link/blog/2023/05/12/ipsec%E4%B9%8Bikev1%E5%8D%8F%E8%AE%AE%E8%AF%A6%E8%A7%A3/" itemprop="url">
        IPSec之IKEv1协议详解
        </a>
      </h1>
      <div class="post-meta">
      <span class="post-time">
<span class="post-meta-item-icon">
    <i class="fa fa-calendar-o"></i>
</span>
<span class="post-meta-item-text">时间：</span>
<time itemprop="dateCreated" datetime="2016-03-22T13:04:35+08:00" content="2023-05-12">
    2023-05-12
</time>
</span> 
      

  <span class="post-category" >
  &nbsp; | &nbsp;
  <span class="post-meta-item-icon">
    <i class="fa fa-folder-o"></i>
  </span>
  <span class="post-meta-item-text">分类：</span>
  
    <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
      <a href="http://shanks.link/categories/ipsec" itemprop="url" rel="index">
        <span itemprop="name">ipsec</span>
      </a>
      &nbsp; 
    </span>
  
</span>


       <span>
&nbsp; | &nbsp;
<span class="post-meta-item-icon">
    <i class="fa fa-eye"></i>
</span>
<span class="post-meta-item-text">阅读：</span>
<span class="leancloud-visitors-count">8779 字 ~18分钟</span>
</span>
      </div>
    </header>
    <div class="post-body" itemprop="articleBody">
    <h1 id="ike简介">IKE简介</h1>
<h2 id="安全联盟sa">安全联盟SA：</h2>
<p><strong>定义：</strong> 安全联盟是要建立IPSec 隧道的通信双方对隧道参数的约定，包括隧道两端的IP地址、隧道采用的验证方式、验证算法、验证密钥、加密算法、共享密钥以及生命周期等一系列参数。</p>
<p>SA由三元组来<strong>唯一标识</strong>，这个三元组包括安全参数索引SPI（Security Parameter Index）、目的IP地址和使用的安全协议号（AH或ESP）。其中，SPI是为唯一标识SA而生成的一个32位比特的数值，它在AH和ESP头中传输。在手工配置SA时，需要手工指定SPI的取值。使用IKE协商产生SA时，SPI将随机生成。</p>
<p>SA是单向的逻辑连接，因此两个IPSec对等体之间的双向通信，最少需要建立两个SA来分别对两个方向的数据流进行安全保护。</p>
<p>SA是IPSec的一个基本组成部分，SA是SADB的一个条目，它包含双方关于IKE和IPSec已经协商完毕的安全信息。</p>
<ul>
<li>IKE or ISAKMP SA：双向的，决定了IKE协议处理相关细节</li>
<li>IPSec SA：单向的，与封装协议相关，决定了具体加密流量的处理方式。</li>
</ul>
<p>两种类型的SA都是由IKE协议协商产生的。</p>
<h2 id="建立ipsec-sa的方式">建立IPSec SA的方式：</h2>
<p>有两种方式建立IPSec安全联盟：手工方式和IKE自动协商方式。二者的主要区别为：</p>
<ul>
<li>
<p>密钥生成方式不同</p>
<p>手工方式下，建立SA所需的全部参数，包括加密、验证密钥，都需要用户手工配置，也只能手工刷新，在中大型网络中，这种方式的密钥管理成本很高；IKE方式下，建立SA需要的加密、验证密钥是通过DH算法生成的，可以动态刷新，因而密钥管理成本低，且安全性较高。</p>
</li>
<li>
<p>生存周期不同</p>
<p>手工方式建立的SA，一经建立永久存在；IKE方式建立的SA，其生存周期由双方配置的生存周期参数控制。</p>
</li>
</ul>
<h2 id="ike介绍">IKE介绍：</h2>
<p>IKE是一个复合协议。</p>
<p>因特网密钥交换IKE（Internet Key Exchange）协议建立在Internet安全联盟和密钥管理协议ISAKMP定义的框架上，是基于UDP（User Datagram Protocol）500 端口号，的应用层协议。</p>
<p>IKE协商两种SA：</p>
<ul>
<li>IKE(ISAKMP) SA (阶段一）</li>
<li>IPSEC SA（阶段二）</li>
</ul>
<p>IKE负责建立和维护IKE SAs 和 IPSec SAs。功能主要体现在如下几个方面：</p>
<ul>
<li>对双方进行认证</li>
<li>交换公共密钥，产生密钥资源，管理密钥</li>
<li>协商协议参数（封装、加密、验证…）</li>
</ul>
<p>IKE的三个组件：</p>
<ul>
<li>SKEME：实现公钥加密认证的机制</li>
<li>Oakley：基于到达两个对等体间的加密密钥的机制</li>
<li>ISAKMP：在两个实体间进行分组格式及状态转换的消息交换的体系结构。</li>
</ul>
<p><strong>IKE有两个版本:</strong></p>
<ul>
<li>IKEV1</li>
<li>IKEV2&mdash;华为默认</li>
</ul>
<h2 id="ike与ipsec的关系">IKE与IPSec的关系：</h2>
<p>IKE为IPSec提供了自动协商密钥、建立IPSec安全联盟的服务，能够简化IPSec的使用和管理，大大简化IPSec的配置和维护工作。</p>
<p><img src="http://shanks.link/img/ipsec/20190420210806222.png" alt="在这里插入图片描述"></p>
<p>图：IKE与IPSec的关系图</p>
<p>IKE与IPSec的关系如上图所示，对等体之间建立一个IKE SA完成身份验证和密钥信息交换后，在IKE SA的保护下，根据配置的AH/ESP安全协议等参数协商出一对IPSec SA。此后，对等体间的数据将在IPSec隧道中加密传输。</p>
<h2 id="ike的安全机制">IKE的安全机制：</h2>
<p>IKE具有一套自保护机制，可以在不安全的网络上安全地认证身份、分发密钥、建立IPsec SA：</p>
<p><strong>身份认证</strong></p>
<p>身份认证确认通信双方的身份（对等体的IP地址或名称），包括预共享密钥PSK（pre-shared key）认证、数字证书RSA（rsa-signature）认证和数字信封认证。</p>
<ul>
<li>在预共享密钥认证中，认证字作为一个输入来产生密钥，通信双方采用共享的密钥对报文进行Hash计算，判断双方的计算结果是否相同。如果相同，则认证通过；否则认证失败。</li>
<li>在数字证书认证中，通信双方使用CA证书进行数字证书合法性验证，双方各有自己的公钥（网络上传输）和私钥（自己持有）。发送方对原始报文进行Hash计算，并用自己的私钥对报文计算结果进行加密，生成数字签名。接收方使用发送方的公钥对数字签名进行解密，并对报文进行Hash计算，判断计算结果与解密后的结果是否相同。如果相同，则认证通过；否则认证失败。</li>
<li>在数字信封认证中，发送方首先随机产生一个对称密钥，使用接收方的公钥对此对称密钥进行加密（被公钥加密的对称密钥称为数字信封），发送方用对称密钥加密报文，同时用自己的私钥生成数字签名。接收方用自己的私钥解密数字信封得到对称密钥，再用对称密钥解密报文，同时根据发送方的公钥对数字签名进行解密，验证发送方的数字签名是否正确。如果正确，则认证通过；否则认证失败。</li>
</ul>
<p><strong>DH</strong></p>
<ul>
<li>
<p>DH是一种公共密钥交换方法，它用于产生密钥材料，并通过ISAKMP消息在发送和接收设备之间进行密钥材料交换。然后，两端设备各自计算出完全相同的对称密钥。该对称密钥用于计算加密和验证的密钥。在任何时候，通信双方都不交换真正的密钥。DH密钥交换是IKE的精髓所在。</p>
<p>MD5、SHA1、DES、3DES、AES等算法都可以采用DH算法来共享对称密钥。</p>
<p>DH使用密钥组定义自己产生的密钥长度。密钥组长度越长，产生的密钥就越强壮。</p>
<blockquote>
<p>IKE的精髓在于它永远不在不安全的网络上传送密钥，而是通过一些数据的交换，通信双方最终计算出共享的密钥，并且即使第三方截获了双方用于计算密钥的所有交换数据，也无法计算出真正的密钥。其中的核心技术就是DH（Diffie Hellman）交换技术。</p>
</blockquote>
</li>
</ul>
<p>PFS</p>
<ul>
<li>短暂的一次性密钥系统称为“完善的前向保密“PFS（Perfect Forward Secrecy）</li>
<li>如果加密系统中有个密钥是所有对称密钥的衍生者（始祖），便不能认为那是一个“完美向前保密”的系统。在这种情况下、一旦破解了跟密钥，便能拿到其他衍生的所有密钥，收那些密钥保护的全部数据都会曝光。</li>
<li>在IPsec 里，PFS是通过在IPSec SA协商阶段重新进行一个DH交换来实现的。</li>
<li>完善的前向安全性PFS（Perfect Forward Secrecy）是一种安全特性，指一个密钥被破解，并不影响其他密钥的安全性，因为这些密钥间没有派生关系。IPSec SA的密钥是从IKE SA的密钥导出的，由于一个IKE SA协商生成一对或多对IPSec SA，当IKE的密钥被窃取后，攻击者将可能收集到足够的信息来导出IPSec SA的密钥，PFS通过执行一次额外的DH交换，保证IPSec SA密钥的安全。</li>
</ul>
<h2 id="isakmp报文格式">ISAKMP报文格式：</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">       8      12      16              24              32
     0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    !                            发起者                              !
    !                      Initiator Cookie                         !
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    !                            应答                                !
    !                      Responder Cookie                         !
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    !   下一个载荷  ! MjVer ! MnVer !    交换类型   !     标志          !
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    !                            消息  ID                            !
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    !                             长度                               !
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
</code></pre></div><ul>
<li>Initiator Cookie ― Initiator Cookie：启动 SA 建立、SA 通知或 SA 删除的实体 Cookie。</li>
<li>Responder Cookie ― Responder Cookie：响应 SA 建立、SA 通知或 SA 删除的实体 Cookie。</li>
<li>Next Payload ― 信息中的 Next Payload 字段类型。</li>
<li>Major Version ― 使用的 ISAKMP 协议的主要版本。</li>
<li>Minor Version ― 使用的 ISAKMP 协议的次要版本。</li>
<li>Exchange Type ―</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">表示所用的交换类型。这表示消息和载荷遵循所用的交换顺序。
                        交换类型                值
                         NONE                    0
                         Base                    1
                         Identity Protection     2
                         Authentication Only     3
                         Aggressive              4
                         Informational           5
                         ISAKMP Future Use     6 - 31
                         DOI Specific Use     32 - 239
                         Private Use         240 - 255
</code></pre></div><ul>
<li>Flags ― 为 ISAKMP 交换设置的各种选项。</li>
<li>Message ID ― 唯一的信息标识符，用来识别第2阶段的协议状态。</li>
<li>Length ― 全部信息（头＋有效载荷）长（八位）。</li>
</ul>
<h2 id="ike的两个阶段">IKE的两个阶段：</h2>
<p>采用IKEv1协商安全联盟主要分为两个阶段：第一阶段，通信双方协商和建立IKE协议本身使用的安全通道，即建立一个IKE SA；第二阶段，利用第一阶段已通过认证和安全保护的安全通道，建立一对用于数据安全传输的IPSec安全联盟。</p>
<p>IKEv1协商阶段1支持两种协商模式：主模式（Main Mode）和野蛮模式（Aggressive Mode）。</p>
<p>经典版本的IKEv1有两个阶段：</p>
<ul>
<li>
<p>阶段一 ： IKE SA</p>
<p>主模式（6个包）</p>
<p>野蛮模式（3个包）</p>
</li>
<li>
<p>阶段二：IPSec SA</p>
<p>快速模式（3个包）</p>
</li>
</ul>
<h1 id="详解ikev1主模式的协商过程">详解IKEv1主模式的协商过程</h1>
<h2 id="ikev1阶段一协商过程">IKEv1阶段一协商过程：</h2>
<p>IKEv1的主模式协商：包含了三次双向交换，用到了六条ISAKMP信息。协商过程如下图所示：</p>
<p><img src="http://shanks.link/img/ipsec/20190420210817102.png" alt="在这里插入图片描述"></p>
<p>图：IKEv1主模式的协商过程</p>
<hr>
<p><img src="http://shanks.link/img/ipsec/20190420210827803.png" alt="在这里插入图片描述"></p>
<p>图：IKEv1主模式协商抓包</p>
<p>IKEv1的协商过程总用用到了9个包。</p>
<hr>
<p>这三次交换分别是：</p>
<ol>
<li>
<p>消息①和②用于策略交换</p>
<p>发起方发送一个或多个IKE安全提议，响应方查找最先匹配的IKE安全提议，并将这个IKE安全提议回应给发起方。匹配的原则为协商双方具有相同的加密算法、认证算法、认证方法和Diffie-Hellman组标识。</p>
</li>
<li>
<p>消息③和④用于密钥信息交换</p>
<p>双方交换Diffie-Hellman公共值和nonce值，用于IKE SA的认证和加密密钥在这个阶段产生。</p>
</li>
<li>
<p>消息⑤和⑥用于身份和认证信息交换（双方使用生成的密钥发送信息），双方进行身份认证和对整个主模式交换内容的认证。</p>
</li>
</ol>
<blockquote>
<p>IKE安全提议指IKE协商过程中用到的加密算法、认证算法、Diffie-Hellman组及认证方法等。</p>
<p>nonce是个随机数，用于保证IKE SA存活和抗重放攻击。</p>
</blockquote>
<hr>
<h2 id="使用预共享秘钥进行身份验证主模式的详细过程">使用预共享秘钥进行身份验证主模式的详细过程：</h2>
<p>当做一个预共享秘钥认证时，主模式的协商如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"> follows:

              Initiator                        Responder
             ----------                       -----------
        1      HDR, SA             --&gt;
        2                          &lt;--    HDR, SA
        3      HDR, KE, Ni         --&gt;
        4                          &lt;--    HDR, KE, Nr
        5      HDR*, IDii, HASH_I  --&gt;
        6                          &lt;--    HDR*, IDir, HASH_R
</code></pre></div><p><strong>缩写名词的解释：</strong></p>
<ul>
<li>
<p><strong>HDR</strong> ：是ISAKMP的标头。当记为 HDR* 表示该流量被加密。</p>
</li>
<li>
<p><strong>SA：</strong> 是SA带有一个或多个提议的有效载荷。针对多个提议，只回复一个。</p>
</li>
<li>
<p>KE：秘钥交换</p>
</li>
<li>
<p>IDii和IDir&mdash;&mdash;标识，通常要IP地址
HASH_I = prf(SKEYID,K| Ci | Cr| SAi | IDi )
HASH_R = prf(SKEYID, K| Ci | Cr | SAr | IDr )</p>
</li>
<li>
<p>Ni：第一个随机数，用于生成密钥</p>
</li>
<li>
<p>Nr：第二个随机数，用于生成密钥</p>
</li>
<li>
<p>Ni Nr&mdash;-代表随机数，通过KE交换素材得到公共的K值</p>
</li>
<li>
<p>K值为推导SKEYID使用</p>
</li>
<li>
<p>HASH值用进行身份数据验证。</p>
</li>
<li>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">  HASH_I = prf(SKEYID, g^xi | g^xr | CKY-I | CKY-R | SAi_b | IDii_b )
  HASH_R = prf(SKEYID, g^xr | g^xi | CKY-R | CKY-I | SAi_b | IDir_b )
    <span style="color:#f00;font-style:italic">//prf伪随机函数
</span><span style="color:#f00;font-style:italic"></span>    <span style="color:#f00;font-style:italic">//g^xy is the Diffie-Hellman shared secret.
</span><span style="color:#f00;font-style:italic"></span>    <span style="color:#f00;font-style:italic">// CKY-I and CKY-R are the Initiator&#39;s cookie and the Responder&#39;s cookie, respectively, from the ISAKMP header.
</span><span style="color:#f00;font-style:italic"></span>     <span style="color:#f00;font-style:italic">// SAi_b is the entire body of the SA payload (minus the ISAKMP generic header)-- i.e. the DOI, situation, all proposals and all transforms offered by the Initiator.
</span></code></pre></div></li>
</ul>
<hr>
<p><strong>笔记：报文协商参数拆解</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">阶段一: IKE SA	
主模式（6个包）
Initiator                        Responder
             ----------                       -----------
-----------------------------------------------------------
    1-2包，用于安全参数协商（明文）
 
              HDR, SA             --&gt;
              Ci  SAi
                                  &lt;--    HDR, SA

                                           Ci Cr  SAr

<span style="color:#c34e00">SA安全联盟</span>(协商各种参数  加密算法   验证算法  验证方式【预共享密钥  数字证书】 DH组  密钥有效期） 
HDR拆解为Ci，Cr，分别代表Initiator cookie和Responder Cookie。第一个包Cr为0。

------------------------------------------------------------
 
3-4个包   交换密钥素材，以及产生密钥(明文）

              HDR, KE, Ni         --&gt;
              Ci  Cr  K   Ni
                                  &lt;--    HDR, KE, Nr
                                           Ci Cr  k  Nr
 
Ni Nr----代表随机数
通过KE交换素材得到公共的K值

K值为推导SKEYID使用  K = g^xy
SKEYID ------基准密钥
使用预共享密钥
SKEYID = prf(pre-shared-key, Ni|Nr)

使用数字证书
SKEYID = prf(Ni | Nr, K) -----基准密钥

 通过SKEYID推导三个密钥
   SKEYID_d = prf(SKEYID, K | Ci | Cr | 0) -----------推导密钥，衍生密钥
  
   SKEYID_a = prf(SKEYID, SKEYID_d | K | Ci | Cr | 1)---------验证密钥
   SKEYID_e = prf(SKEYID, SKEYID_a | K | Ci | Cr | 2)---------加密密钥
   
-----------------------------------------------------------

5-6 两个包    做身份验证 （加密）

采用预共享密钥5 6两个包
   HDR*, IDii, HASH_I  --&gt; 
   Ci Cr  
                                  &lt;--    HDR*, IDir, HASH_R


IDii和IDir------标识，通常要IP地址
 HASH_I =   prf(SKEYID,K| Ci | Cr| SAi | IDi )
 HASH_R =  prf(SKEYID, K| Ci | Cr | SAr | IDr )



采用数字证书的5 6两个包
 HDR*, IDii, [ CERT, ] SIG_I --&gt;

                                    &lt;--    HDR*, IDir, [ CERT, ] SIG_R
                                    
-----------------------------------------------------------------
</code></pre></div><p><img src="http://shanks.link/img/ipsec/20190420210838778.png" alt="在这里插入图片描述"></p>
<p>图：通过DH算法得出密钥</p>
<hr>
<h3 id="阶段一的第1个包明文">阶段一的第1个包（明文）：</h3>
<p>第一包的作用是，协商发起发，发送IKE安全提议，给响应方。下图为抓包示例内容：</p>
<p><img src="http://shanks.link/img/ipsec/20190420210846786.png" alt="在这里插入图片描述"></p>
<p><img src="http://shanks.link/img/ipsec/20190420210854154.png" alt="在这里插入图片描述"></p>
<p>图：主模式的第一个包内容抓包示例</p>
<p>首先当两个路由器或防火墙启用IPSEC的时候，我们以其中之一为起点。A-&gt;B，那么A开始发送IKE的数据报文。报文是UDP的类型，封装在端口500里面。</p>
<p>首先是第一个信息被发送，主要内容是<strong>COOKIE号码，标识一个唯一的IPSEC会话，也有防止重放的功能</strong>。它的建立是通常是基于IP地址，端口的号码，时间和日期等等进行一个散列算法，生成一个8位的随机数。<strong>对方的COOKIE为0</strong>。</p>
<p><strong>内容还包含一个SA负载，还有提议负载，转换负载</strong>。sa的负载是定位这个ISAKMP是为了IPSEC工作。因为IKE是一个标准的协议，所以在SA负载中通过DOI，解释域，来说明这条消息交换用于IPSEC。</p>
<p>提议负载的内容包含一个提议号，协议ID，SPI，转换号，其中SPI为0，转换号指向了相应的转换负载</p>
<p>转换负载的内容是加密的参数，如des，dh算法，存活时间，hash算法等等。</p>
<h3 id="阶段一的第2个包明文">阶段一的第2个包（明文）：</h3>
<p>第2个包的作用主要是：通过查找第一个包的安全提议。给发送者回复一个确认的安全提议。下图是第二个包的抓包内容。</p>
<p><img src="http://shanks.link/img/ipsec/20190420210859266.png" alt="在这里插入图片描述"></p>
<p>图：IKEv1主模式协商第二个包抓包</p>
<p>第二个包是响应方响应一个信息，<strong>主要内容就是对方的COOKIE号码，和一个提议和一个策略</strong>，注意，<strong>这个提议和策略是和开始里面的一个对应的，否则，就回一个失败信息。</strong></p>
<h3 id="阶段一的第3个包明文">阶段一的第3个包（明文）：</h3>
<p>第三个包的作用：如果发起方接受了安全提议，就给对方发送密钥生成信息，对方用来生成IKE的秘钥。</p>
<p><img src="http://shanks.link/img/ipsec/20190420210904880.png" alt="在这里插入图片描述"></p>
<p>图：IKEv1主模式协商第三个包抓包示例</p>
<p>初始方然后回应第三个信息，内容是自己的公钥，发给对方，注意，此处我的理解是素数已经交换完毕，公钥就是根据自己随机产生的私钥加上素数和一个产生器g三者来产生的。同时传输一个随机数NI。</p>
<h3 id="阶段一第四个包明文">阶段一第四个包（明文）：</h3>
<p>主要作用：协商相应方给协商发起方发送密钥生成信息，使得协议发起方能生成密钥。</p>
<p><img src="http://shanks.link/img/ipsec/20190420210909449.png" alt="在这里插入图片描述"></p>
<p>图：IKEv1主模式协商第4个包抓包</p>
<p>接收方回应自己的公钥给初始方。包含一个随机数NR。</p>
<p>然后双方各自计算出共享的密钥，一共有三个密钥，SKEYID_a，d，e，其中d是根据z=pfs（pre-shared key，cookie_i，cookie_ni，nl|0），其中d用来给第二阶段提供密钥的素材。a用来对IKE的数据进行认证，e用来加密整个IKE协商的数据。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">K值为推导SKEYID使用 
	SKEYID ------基准密钥
使用预共享密钥

	SKEYID = prf(pre-shared-key, Ni|Nr)

使用数字证书
	SKEYID = prf(Ni | Nr, K) 

 通过SKEYID推导三个密钥
 	  SKEYID_d = prf(SKEYID, K | Ci | Cr | 0) -----------推导密钥
  	 SKEYID_a = prf(SKEYID, SKEYID_d | K | Ci | Cr | 1)---------验证密钥,对数据进行验证
 	  SKEYID_e = prf(SKEYID, SKEYID_a | K | Ci | Cr | 2)---------加密密钥
</code></pre></div><blockquote>
<p>当使用预共享密钥认证与主模式时，密钥可以只能通过对等点的IP地址来标识，因为必须使用HASH_I，在启动程序处理IDir之前计算。野蛮模式允许更大范围的预共享密钥标识符被使用。此外，野蛮模式允许双方进行维护多个不同的预共享密钥，并确定正确的密钥一个特定的交换。</p>
</blockquote>
<h3 id="阶段一的第5个包密文">阶段一的第5个包（密文）：</h3>
<p>主要作用：发起方发送身份和验证数据。</p>
<p><img src="http://shanks.link/img/ipsec/20190420210917633.png" alt="在这里插入图片描述"></p>
<p>图：IKEv1主模式协商第5个包抓包</p>
<p>初始方开始继续协商，发送第五个信息，注意，此刻所有的<strong>负载信息是被ekey加密过的</strong>。信息主要包含两个内容，其中之一是标识负载，另一个是散
列负载，标识负载的主要内容是包含自己的IP地址，就是我们所谓的ID_I，或者是主机名称。散列负载主要的内容是使用session_a进行的散列计 算，计算的参数有上述的Z，和两端的cookie，pre-share key ，提议，转换集，SA的内容。</p>
<h3 id="阶段一的第6个包密文">阶段一的第6个包（密文）：</h3>
<p>主要作用: 协商响应方给发起方发送身份和验证数据。</p>
<p><img src="http://shanks.link/img/ipsec/20190420210923372.png" alt="在这里插入图片描述"></p>
<p>图：IKEv1主模式协商第6个包抓包</p>
<p>然后当接收方收到的时候进行确认，先解密，然后根据ID找到pre-key，然后进行相同的计算，得出散列的值，然后对比接收呼叫。</p>
<p>总结：在这个过程中，所有的数据都是被封装在UDP 500的端口内进行协商的。</p>
<h2 id="ikev1阶段二-快速模式协商过程">IKEv1阶段二 快速模式协商过程：</h2>
<p>IKEv1协商阶段2的目的就是建立用来安全传输数据的IPSec SA，并为数据传输衍生出密钥。这一阶段采用快速模式（Quick Mode）。该模式使用IKEv1协商阶段1中生成的密钥对ISAKMP消息的完整性和身份进行验证，并对ISAKMP消息进行加密，故保证了交换的安全性。</p>
<p><img src="http://shanks.link/img/ipsec/201904202109295.png" alt="在这里插入图片描述"></p>
<p>图：IKEv1阶段二协商过程</p>
<p><strong>阶段二的快速模式的协商如下：</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"> Initiator                         Responder
   -----------                   -----------
   HDR*, HASH(1), SA, Ni
     [, KE ] [, IDci, IDcr ] --&gt;
                              &lt;--    HDR*, HASH(2), SA, Nr
                                     [, KE ] [, IDci, IDcr ]
      HDR*, HASH(3)       --&gt;

   HASH(1) = prf(SKEYID_a, M-ID | SA | Ni [ | KE ] [ | IDci | IDcr )
   HASH(2) = prf(SKEYID_a, M-ID | Ni_b | SA | Nr [ | KE ] [ | IDci |
   IDcr )
   HASH(3) = prf(SKEYID_a, 0 | M-ID | Ni_b | Nr_b)
</code></pre></div><p>IKEv1协商阶段2通过三条ISAKMP消息完成双方IPSec SA的建立：</p>
<ol>
<li>
<p>协商发起方发送本端的安全参数和身份认证信息。</p>
<p>安全参数包括被保护的数据流和IPSec安全提议等需要协商的参数。身份认证信息包括第一阶段计算出的密钥和第二阶段产生的密钥材料等，可以再次认证对等体。</p>
</li>
<li>
<p>协商响应方发送确认的安全参数和身份认证信息并生成新的密钥。</p>
<p>IPSec SA数据传输需要的加密、验证密钥由第一阶段产生的密钥、SPI、协议等参数衍生得出，以保证每个IPSec SA都有自己独一无二的密钥。</p>
<p>如果启用PSF，则需要再次应用DH算法计算出一个共享密钥，然后参与上述计算，因此在参数协商时要为PFS协商DH密钥组。</p>
</li>
<li>
<p>发送方发送确认信息，确认与响应方可以通信，协商结束。</p>
</li>
</ol>
<hr>
<p><img src="http://shanks.link/img/ipsec/20190420210936503.png" alt="在这里插入图片描述"></p>
<p>图：快速模式第1个包，第2个包，第3个包都除了加密数据格式都相同</p>
<p>第二阶段，当第一阶段结束后，根据session-d的密钥资源，然后继续进行两次交换：</p>
<p>第一次交换，首先，判断是否启用了PFS（完美转发安全），如果启用的话，根据pfs中定义的参数继续进 行一个协商。PFS是提议者向接收者提供建议 的属性。如果协商就支持，否则就不支持。它的作用是在快速模式中重新协商DH密钥的属性。这允许使用新的密钥进行ipsec加密，而不是使用第一阶段生产的密钥。</p>
<p>快速模式只有一次交换，DH交换必须马上发生。不能几次协商了。因此，两端的DH配置必须匹配。</p>
<p>当执行PFS的时候，再次执行DH算法，然后，重新生产密钥。</p>
<h2 id="配置感兴趣流时的注意事项">配置感兴趣流时的注意事项：</h2>
<p>在IKEv1中，双方的感兴趣刘必须互为镜像，不能取交集。而在IKEv2中可以取交集。</p>
<p>例如：在1.1.1.1/34 &mdash;-&gt; 2.2.2.2/32 与 2.2.2.2/32 &mdash;&mdash;&gt; 1.1.1.1/32 在IKEv1中可以协商。而1.1.1.1/34 &mdash;-&gt; 2.2.2.2/32 与 2.2.2.0/24 &mdash;-&gt;1.1.1.0/24 在IKEv1中不可以协商，在IKEv2中可以协商成功。</p>
<blockquote>
<p><strong>注意：SKEYID-e用来加密包弧ISAMKP的协议的数据，而不是用来保护感兴趣流。</strong></p>
<p>保护数据流的密钥用的是密钥是：KEYMAT。</p>
<ul>
<li>无PFS
KEYMAT = prf(SKEYID_d, protocol | SPI | Ni_b | Nr_b).</li>
<li>有PFS
KEYMAT = prf(SKEYID_d, g(qm)^xy | protocol | SPI | Ni_b | Nr_b)</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">If PFS is not needed, and KE payloads are not exchanged, the <span style="color:#00f">new</span>
   keying material is defined as

       KEYMAT = prf(SKEYID_d, protocol | SPI | Ni_b | Nr_b).

   If PFS is desired and KE payloads were exchanged, the <span style="color:#00f">new</span> keying
   material is defined as

       KEYMAT = prf(SKEYID_d, g(qm)^xy | protocol | SPI | Ni_b | Nr_b)

   where <span style="color:#c34e00">g</span>(qm)^xy is the shared secret from the ephemeral Diffie-Hellman
   exchange of <span style="color:#00f">this</span> Quick Mode.
</code></pre></div></blockquote>
<h1 id="详解ikev1野蛮模式的协商过程">详解IKEv1野蛮模式的协商过程</h1>
<h2 id="野蛮模式协商过程">野蛮模式协商过程：</h2>
<p><img src="http://shanks.link/img/ipsec/20190420210943836.png" alt="在这里插入图片描述"></p>
<p>图：野蛮模式协商过程</p>
<hr>
<p><img src="http://shanks.link/img/ipsec/20190420211001305.png" alt="在这里插入图片描述"></p>
<p>图：野蛮模式协商过程</p>
<hr>
<p>野蛮模式只用到三条信息：前两条消息①和②用于协商IKE安全提议，交换Diffie-Hellman公共值、必需的辅助信息以及身份信息，并且消息②中还包括响应方发送身份信息供发起方认证，消息③用于响应方认证发起方。</p>
<hr>
<h2 id="使用预共享秘钥进行身份验证野蛮模式的详细过程">使用预共享秘钥进行身份验证野蛮模式的详细过程：</h2>
<p>当做一个预共享秘钥认证时，野蛮模式的协商如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">  Initiator                        Responder
           -----------                      -----------
            HDR, SA, KE, Ni, IDii --&gt;
                                  &lt;--    HDR, SA, KE, Nr, IDir, HASH_R
            HDR, HASH_I           --&gt;
12345
野蛮模式（3个包）
      Initiator                        Responder
           -----------                      ----------- 
第1包-------安全提议（各种协商）  密钥交换素材   随机数  身份ID
            HDR, SA, KE, Ni, IDii --&gt;
                                  &lt;--    HDR, SA, KE, Nr, IDir, HASH_R

第2包---------安全提议，密钥交换素材  随机数  身份ID  HASH_R

第3包---------加密的环境
            HDR*, HASH_I           --&gt;
</code></pre></div><hr>
<p><strong>第一个包报文抓包：</strong></p>
<p><img src="http://shanks.link/img/ipsec/20190420211011752.png" alt="在这里插入图片描述"></p>
<p><img src="http://shanks.link/img/ipsec/20190420211016726.png" alt="在这里插入图片描述"></p>
<p>图：野蛮模式协商第一个包</p>
<p>主要携带了安全提议（各种协商） 密钥交换素材 随机数 身份ID等，发送给响应方。</p>
<hr>
<h3 id="第二个报文抓包">第二个报文抓包：</h3>
<p><img src="http://shanks.link/img/ipsec/20190420211023219.png" alt="在这里插入图片描述">
<img src="http://shanks.link/img/ipsec/20190420211033193.png" alt="在这里插入图片描述"></p>
<p>图：野蛮模式协商第二个包</p>
<p>第二个包：主要携带确认双方都支持的安全提议，密钥交换素材 随机数 身份ID HASH_R等，发送给协商发起方。</p>
<hr>
<h3 id="第三个包">第三个包：</h3>
<p><img src="http://shanks.link/img/ipsec/20190420211038387.png" alt="在这里插入图片描述"></p>
<p>图：野蛮模式协商第三个包</p>
<p>第三个包：的传输过程是加密的。主要用于响应方认证发起方。</p>
<h1 id="主模式与野蛮模式的区别">主模式与野蛮模式的区别：</h1>
<ol>
<li>交换的消息：主模式为6个包，野蛮模式为3个包，野蛮模式能够更快创建IKE SA</li>
<li>NAT支持：对预共享密钥认证：主模式不支持NAT转换，而野蛮模式支持。而对于证书方式认证：两种模式都能支持</li>
<li>对等体标识：主模式只能采用IP地址方式标识对等体；而野蛮模式可以采用IP地址方式或者Name方式标识对等体。这是由于主模式在交换完3、4消息以后，需要使用预共享密钥来计算SKEYID，当一个设备有多个对等体时，必须查找到该对等体对应的预共享密钥，但是由于其对等体的ID信息在消息5、6中才会发送，此时主模式的设备只能使用消息3、4中的IP报文源地址来找到与其对应的预共享密钥；如果主模式采用Name方式，Name信息却包含在消息5、6中，而设备必须在消息5、6之前找到其对等体的预共享密钥，所以就造成了矛盾，无法完成Name方式的标识。
而在野蛮模式中，ID消息在消息1、2中就已经发送了，设备可以根据ID信息查找到对应的预共享密钥，从而计算SKEYID。但是由于野蛮模式交换的2个消息没有经过加密，所以ID信息也是明文的，也相应造成了安全隐患。</li>
<li>提议转换对数量：在野蛮模式中，由于第一个消息就需要交换DH消息，而DH消息本身就决定了采用哪个DH组，这样在提议转换对中就确定了使用哪个DH组，如果第一个消息中包含多个提议转换对，那么这多个转换对的DH组必须相同(和DH消息确定的DH组一致)，否则消息1中只能携带和确定DH组相同的提议转换对。</li>
<li>协商能力：由于野蛮模式交换次数的限制，因此野蛮模式协商能力低于主模式。</li>
<li>主模式常用，野蛮已经不推荐使用,推荐使用模板方式</li>
<li>两者之间的协商过程不同</li>
<li>场景不同：</li>
</ol>
<p><strong>野蛮模式的场景：</strong></p>
<p>与主模式相比，野蛮模式减少了交换信息的数目，提高了协商的速度，<strong>但是没有对身份信息进行加密保护</strong>。虽然野蛮模式不提供身份保护，但它可以满足某些特定的网络环境需求：</p>
<ul>
<li>当IPSec隧道中存在NAT设备时，需要启动NAT穿越功能，而NAT转化会改变对等体的IP地址，由于野蛮模式不依赖于IP地址标识身份，使得采用预共享密钥验证方式时，NAT穿越只能在野蛮模式中实现。</li>
<li>如果发起方的IP地址不固定或者无法预知，而双方都希望采用预共享密钥验证方法来创建IKE SA，则只能采用野蛮模式。</li>
<li>如果发起方已知响应方的策略，或者对响应者的策略有全面的了解，采用野蛮模式能够更快地创建IKE SA。</li>
</ul>
<p><strong>主模式场景：</strong></p>
<blockquote>
<p><strong>要求两端都是固定IP地址</strong></p>
</blockquote>
<hr>
<blockquote>
<p>参考文档：RFC 2409， 华为HedEx文档</p>
</blockquote>

    </div>
    <footer class="post-footer">
     
 
<div class="post-tags">     
     
    <a href="http://shanks.link/tags/ipsec" rel="tag" title="ipsec">#ipsec#</a>
    
</div>



     <div class="post-nav">
    <div class="post-nav-next post-nav-item">
    
        <a href="http://shanks.link/blog/2023/05/29/linux-%E7%AE%80%E5%8D%95%E6%9F%A5%E7%9C%8B%E7%BD%91%E5%8D%A1%E5%AE%9E%E6%97%B6%E7%BD%91%E9%80%9F/" rel="next" title="Linux 简单查看网卡实时网速">
        <i class="fa fa-chevron-left"></i> Linux 简单查看网卡实时网速
        </a>
    
    </div>

    <div class="post-nav-prev post-nav-item">
    
        <a href="http://shanks.link/blog/2023/05/12/ipsec%E5%9F%BA%E6%9C%AC%E5%8E%9F%E7%90%86/" rel="prev" title="IPsec基本原理">
        IPsec基本原理 <i class="fa fa-chevron-right"></i>
        </a>
    
    </div>
</div>
      
     
     
     





<script src="https://utteranc.es/client.js"
        repo="shankusu2017@gmail.com/"
        issue-term="pathname"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>
<noscript>Please enable JavaScript to view the <a href="https://github.com/utterance">comments powered by utterances.</a></noscript>

    </footer>
  </article>
</section>

          </div>
        </div>
        <div class="sidebar-toggle">
  <div class="sidebar-toggle-line-wrap">
    <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
    <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
    <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
  </div>
</div>
<aside id="sidebar" class="sidebar">
  <div class="sidebar-inner">

    <section class="site-overview sidebar-panel  sidebar-panel-active ">
      <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image"
        src="http://shanks.link/img/logo.jpg"
        alt="shankusu2017@gmail.com" />
    <p class="site-author-name" itemprop="name">shankusu2017@gmail.com</p>
    <p class="site-description motion-element" itemprop="description"> </p>
</div>
      <nav class="site-state motion-element">
    <div class="site-state-item site-state-posts">
      <a href="http://shanks.link/post/">
        <span class="site-state-item-count">549</span>
        <span class="site-state-item-name">日志</span>
      </a>
    </div>
    <div class="site-state-item site-state-categories">    
        <a href="http://shanks.link/categories/">      
         
        <span class="site-state-item-count">43</span>
        
        <span class="site-state-item-name">分类</span>
        
        </a>
    </div>

    <div class="site-state-item site-state-tags">
        <a href="http://shanks.link/tags/">
         
        <span class="site-state-item-count">48</span>
        
        <span class="site-state-item-name">标签</span>
        </a>
    </div>
</nav>
      
      
<div class="links-of-author motion-element">
    
        <span class="links-of-author-item">
        <a href="https://github.com/shankusu2017" target="_blank" title="GitHub">
            <i class="fa fa-fw fa-github"></i>
            GitHub
        </a>
        </span>
    
</div>


      

      <div class="links-of-blogroll motion-element inline">
<script type="text/javascript" src="//rf.revolvermaps.com/0/0/8.js?i=5b4f2ucxar6&amp;m=0&amp;s=220&amp;c=ff0000&amp;cr1=ffffff&amp;f=arial&amp;l=33&amp;bv=35" async="async"></script>
</div>

    </section>
    
  </div>
</aside>

      </div>
    </main>
   
    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  <span itemprop="copyrightYear">  &copy; 
  2009 - 2023</span>
</div>
<div>
  <a href="https://beian.miit.gov.cn/" rel="noopener" target="_blank">粤ICP备2021068940号-1</a>
  <a href="https://www.beian.gov.cn/portal/registerSystemInfo?recordcode=44011302003059" rel="noopener" target="_blank">粤公网安备44011302003059</a>
</div>


      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
      <span id="scrollpercent"><span>0</span>%</span>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>
<script type="text/javascript" src="http://shanks.link/js/vendor/jquery/index.js?v=2.1.3"></script>
<script type="text/javascript" src="http://shanks.link/js/vendor/fastclick/lib/fastclick.min.js?v=1.0.6"></script> 
<script type="text/javascript" src="http://shanks.link/js/vendor/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
<script type="text/javascript" src="http://shanks.link/js/vendor/velocity/velocity.min.js?v=1.2.1"></script>
<script type="text/javascript" src="http://shanks.link/js/vendor/velocity/velocity.ui.min.js?v=1.2.1"></script>
<script src="http://shanks.link/js/vendor/ua-parser-js/dist/ua-parser.min.js?v=0.7.9"></script>

<script src="http://shanks.link/js/vendor/fancybox/jquery.fancybox.pack.js?v=2.1.5"></script>

<script type="text/javascript" src="http://shanks.link/js/utils.js"></script>
<script type="text/javascript" src="http://shanks.link/js/motion.js"></script>
<script type="text/javascript" src="http://shanks.link/js/affix.js"></script>
<script type="text/javascript" src="http://shanks.link/js/schemes/pisces.js"></script>

<script type="text/javascript" src="http://shanks.link/js/scrollspy.js"></script>
<script type="text/javascript" src="http://shanks.link/js/post-details.js"></script>
<script type="text/javascript" src="http://shanks.link/js/toc.js"></script>

<script type="text/javascript" src="http://shanks.link/js/bootstrap.js"></script>

<script type="text/javascript" src="http://shanks.link/js/search.js"></script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX", "output/HTML-CSS"],
    tex2jax: {
      inlineMath: [ ['$','$'] ],
      displayMath: [ ['$$','$$'] ],
      processEscapes: true
    },
    "HTML-CSS": { fonts: ["TeX"] }
  });
</script>
<script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML' async></script>
</body>
</html>