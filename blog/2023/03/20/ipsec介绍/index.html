<!DOCTYPE HTML>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" /> 
    <title>IPSec介绍 - Golang编程语言知识介绍</title>
    <meta name="keywords" content="git,Git,Lua,lua,Golang,go">
    
    <meta property="og:title" content="IPSec介绍">
    <meta property="og:site_name" content="Golang编程语言知识介绍">
    <meta property="og:image" content="/img/author.jpg"> 
    <meta name="title" content="IPSec介绍 - Golang编程语言知识介绍" />
    <meta name="description" content="愿星光伴你左右"> 
    <link rel="shortcut icon" href="http://shanks.link/img/favicon.ico" />
    <link rel="apple-touch-icon" href="http://shanks.link/img/apple-touch-icon.png" />
    <link rel="apple-touch-icon-precomposed" href="http://shanks.link/img/apple-touch-icon.png" />
    <link href="http://shanks.link/js/vendor/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />
    <link href="http://shanks.link/js/vendor/fancybox/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />
    <link href="http://shanks.link/css/main.css" rel="stylesheet" type="text/css" />
    <link href="http://shanks.link/css/syntax.css" rel="stylesheet" type="text/css" />
    <script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post"},
     fancybox: true, 
    motion: true
  };
</script>
</head>
<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">
<div class="container one-collumn sidebar-position-left page-home  ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"> <div class="site-meta  custom-logo ">

  <div class="custom-logo-site-title">
    <a href="http://shanks.link/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">Golang编程语言知识介绍</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle"></p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
    <ul id="menu" class="menu">
      
      
        <li class="menu-item ">
          <a href="http://shanks.link/post/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />首页
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/thinking/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />随想录
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/%E7%94%9F%E6%B4%BB/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />生活
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/os/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />OS
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/lua/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />lua
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/redis/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />redis
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/go/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />Golang
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/c/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />C
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/tcpip/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />TCP/IP
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/ebpf/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />ebpf
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/p4/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />p4
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/openvpn/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />OpenVPN
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/ipsec/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />IPSec
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/l2tp/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />L2TP
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/dns/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />DNS
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/web/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />web
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/openwrt/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />OpenWRT
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/%E8%BF%90%E7%BB%B4/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />运维
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/git/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />Git
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/%E9%B8%9F%E5%93%A5%E7%9A%84%E7%A7%81%E6%88%BF%E8%8F%9C/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />鸟哥的私房菜
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/it/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />IT杂谈
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/about/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />About Me
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/links/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />友情链接
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/ftp/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />FTP
          </a>
        </li>
      
      <li class="menu-item menu-item-search">
        <a href="javascript:;" class="popup-trigger"> <i class="menu-item-icon fa fa-search fa-fw"></i> <br /> 搜索</a>
      </li>
    </ul>
    <div class="site-search">
      <div class="popup">
 <span class="search-icon fa fa-search"></span>
 <input type="text" id="local-search-input">
 <div id="local-search-result"></div>
 <span class="popup-btn-close">close</span>
</div>

    </div>
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
<section id="posts" class="posts-expand">
  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <header class="post-header">
      <h1 class="post-title" itemprop="name headline">
        <a class="post-title-link" href="http://shanks.link/blog/2023/03/20/ipsec%E4%BB%8B%E7%BB%8D/" itemprop="url">
        IPSec介绍
        </a>
      </h1>
      <div class="post-meta">
      <span class="post-time">
<span class="post-meta-item-icon">
    <i class="fa fa-calendar-o"></i>
</span>
<span class="post-meta-item-text">时间：</span>
<time itemprop="dateCreated" datetime="2016-03-22T13:04:35+08:00" content="2023-03-20">
    2023-03-20
</time>
</span> 
      

  <span class="post-category" >
  &nbsp; | &nbsp;
  <span class="post-meta-item-icon">
    <i class="fa fa-folder-o"></i>
  </span>
  <span class="post-meta-item-text">分类：</span>
  
    <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
      <a href="http://shanks.link/categories/ipsec" itemprop="url" rel="index">
        <span itemprop="name">ipsec</span>
      </a>
      &nbsp; 
    </span>
  
</span>


       <span>
&nbsp; | &nbsp;
<span class="post-meta-item-icon">
    <i class="fa fa-eye"></i>
</span>
<span class="post-meta-item-text">阅读：</span>
<span class="leancloud-visitors-count">7366 字 ~15分钟</span>
</span>
      </div>
    </header>
    <div class="post-body" itemprop="articleBody">
    <h1 id="ipsec协议簇安全框架">IPSEC协议簇安全框架</h1>
<h2 id="aipsec简介">a.IPSec简介</h2>
<p><strong>IPSec（Internet Protocol Security）</strong>：是一组基于网络层的，应用密码学的安全<a href="https://so.csdn.net/so/search?q=%E9%80%9A%E4%BF%A1%E5%8D%8F%E8%AE%AE&amp;spm=1001.2101.3001.7020">通信协议</a>族。IPSec不是具体指哪个协议，而是一个<strong>开放的协议族</strong>。</p>
<p><strong>IPSec协议的设计目标</strong>：是在IPV4和IPV6环境中为网络层流量提供灵活的安全服务。</p>
<p><strong>IPSec VPN</strong>：是基于IPSec协议族构建的在IP层实现的安全虚拟专用网。通过在数据包中插入一个预定义头部的方式，来保障OSI上层协议数据的安全，主要用于保护TCP、UDP、ICMP和隧道的IP数据包。</p>
<h2 id="bipsec协议族">b.IPSec协议族</h2>
<p><img src="http://shanks.link/img/ipsec32a51248/20190620082419590.png" alt="在这里插入图片描述">
<strong>IPSec VPN体系结构</strong>主要由<strong>AH</strong>、<strong>ESP</strong>和<strong>IKE协议套件</strong>组成。
IPSec通过ESP来保障IP数据传输过程的<strong>机密性</strong>，使用AH/ESP提供数据<strong>完整性</strong>、<strong>数据源验证</strong>和<strong>抗报文重放功能</strong>。
ESP和AH定义了协议和载荷头的格式及所提供的服务，但却没有定义实现以上能力所需具体转码方式，<strong>转码方式</strong>包括对数据转换方式，如算法、密钥长度等。
为简化IPSec的使用和管理，IPSec还可以通过<strong>IKE</strong>进行<strong>自动协商交换密钥</strong>、<strong>建立和维护安全联盟的服务</strong>。具体如下：</p>
<ul>
<li>
<p>IKE协议：IKE协议用于自动协商AH和ESP所使用的密码算法。
IKE定义了安全参数如何协商,以及共享密钥如何建立,但它没有定义的是<strong>协商内容</strong>。这方面的定义是由&quot;<strong>解释域(doi)</strong>&ldquo;文档来进行。</p>
</li>
<li>
<p>AH协议：AH是报文头验证协议，主要提供的功能有数据源验证、数据完整性校验和防报文重放功能。然而，AH并不加密所保护的数据报。</p>
</li>
<li>
<p>ESP协议：ESP是封装安全载荷协议。它除提供AH协议的所有功能外（但其数据完整性校验不包括IP头），还可提供对IP报文的加密功能。</p>
<p><strong>IPSec协议族：</strong>
<img src="http://shanks.link/img/ipsec32a51248/20190620082849932.png" alt="在这里插入图片描述"></p>
</li>
<li>
<p>IPSec协议定义了<strong>两种通信保护机制</strong>：
<strong>封装安全载荷</strong>(ESP，Encapsulating Security Payload)：ESP机制为通信提供<strong>机密性</strong>和<strong>完整性</strong>；
<strong>鉴别头</strong>(AH，Authentication Header)：AH机制为通信提供<strong>完整性保护</strong>。
ESP机制和AH机制都能为通信提供抗<strong>重放(Anti-replay)攻击</strong>。</p>
</li>
<li>
<p>IPSec协议可以设置成在两种工作模式下运行：一种是<strong>隧道(tunnel)模式</strong>，另一种是<strong>传输(transport)模式</strong>。</p>
</li>
<li>
<p>IPSec协议使用<strong>IKE协议</strong>实现安全协议的自<strong>动安全参数协商</strong>。IKE协商的安全参数包括<strong>加密与鉴别算法</strong>、
<strong>加密与鉴别密钥</strong>、<strong>通信的保护模式(传输或隧道模式)</strong>、<strong>密钥的生存期</strong>等。IKE将这些安全参数构成的集合称为<strong>安全关联(SA，security Association)</strong>，还负责这些安全参数的刷新。</p>
</li>
<li>
<p>两个数据库：<strong>安全策略数据库SPD</strong>，<strong>安全关联数据库SAD</strong>。</p>
</li>
<li>
<p>DOI<strong>将所有的IPSec小组的文献捆绑在一起。它可以被认为是所有</strong>IPSec安全参数的主数据库。</p>
</li>
</ul>
<h1 id="ipsec工作模式">.IPSEC工作模式</h1>
<h2 id="传输模式transport-mode">传输模式(Transport mode)</h2>
<p>在传输模式下，IPSec协议处理模块会在IP报头和高层协议报头之间插入一个<strong>IPSec报头</strong>。
IP报头与原始IP分组中的IP报头是一致的，只是IP报文中的协议字段会被改成IPSec协议的协议号（50或者51) ，并重新计算IP报头校验和。传输模式保护数据包的有效载荷、高层协议，IPSec源端点不会修改IP报头中目的IP地址，原来的IP地址也会保持明文。
传输模式只为高层协议提供安全服务。</p>
<p><strong>主要应用场景</strong>：经常用于主机和主机之间端到端通信的数据保护。</p>
<p><strong>封装方式</strong>：不改变原有的IP包头，在原数据包头后面插入IPSec包头，将原来的数据封装成被保护的数据。
<img src="http://shanks.link/img/ipsec32a51248/20190620084637751.png" alt="在这里插入图片描述"></p>
<h2 id="隧道模式tunnel-mode">隧道模式(Tunnel mode)</h2>
<p>与传输模式不同，在隧道模式下，原始IP分组被封装成一个<strong>新的IP报文</strong>，在内部报头以及外部报头之间插入一个<strong>IPSec报头</strong>，原IP地址被当作有效载荷的一部分受到IPSec的保护。
通过对数据加密，还可以<strong>隐藏原数据包中的IP地址</strong>，这样更有利于保护端到端通信中数据的安全性。</p>
<p>封装方式：增加新的IP（外网IP）头，其后是ipsec包头，之后再将原来的整个数据包封装。
<img src="http://shanks.link/img/ipsec32a51248/20190620085137326.png" alt="在这里插入图片描述">
主要应用场景：经常用于私网与私网之间通过公网进行通信，建立安全VPN通道。
<img src="http://shanks.link/img/ipsec32a51248/20190620085056918.png" alt="在这里插入图片描述"></p>
<h1 id="ipsec通信协议">IPSEC通信协议</h1>
<ul>
<li>
<h2 id="ah协议">AH协议</h2>
</li>
<li>
<p>AH分配到的<strong>协议号是51</strong>。即使用AH协议进行安全保护的IPv4数据报文的IP头部中协议字段将是51，表明IP头之后是一个<strong>AH头</strong>。AH头比ESP头简单得多，因为它没有提供机密性。由于不需要填充和一个填充长度指示器，因此也不存在尾部字段。另外，也不需要一个初始化向量。</p>
</li>
<li>
<h3 id="ah提供的安全服务">AH提供的安全服务</h3>
<ul>
<li>无连接数据完整性：通过哈希函数产生的校验来保证。</li>
<li>数据源认证：通过在计算验证码时加入一个共享秘钥来实现。</li>
<li>抗重放服务：AH报头中的序列号可以防止重放攻击。</li>
</ul>
</li>
<li>
<h3 id="ah不提供任何保密性服务它不加密所保护的数据包">AH不提供任何保密性服务：它不加密所保护的数据包。</h3>
<p>不论是传输模式还是隧道模式下，AH提供对数据包的保护时，它保护的是整个IP数据包（易变的字段除外，如IP头中的TTL和TOS字段）。</p>
<p><strong>AH头：</strong>
<img src="http://shanks.link/img/ipsec32a51248/2019062009021352.png" alt="在这里插入图片描述">
<strong>AH在传输模式下封装</strong>：
<img src="http://shanks.link/img/ipsec32a51248/2019062009042565.png" alt="在这里插入图片描述">
<strong>AH在隧道模式下封装：</strong>
<img src="http://shanks.link/img/ipsec32a51248/20190620090522987.png" alt="在这里插入图片描述"></p>
</li>
</ul>
<h2 id="esp协议">ESP协议</h2>
<ul>
<li>
<p>ESP同样被当作一种IP协议对待，紧贴在<strong>ESP头</strong>前的IP头，以<strong>协议号50</strong>标志ESP头，ESP之前的IP头中的协议字段将是50，以表明IP头之后是一个ESP头，ESP不仅具备ESP头，还有一个包含有用信息的ESP尾。
在隧道模式中，ESP保护整个IP包，整个原始IP包将会以ESP载荷的方式加入新建的数据包，同时，系统根据隧道起点和终点等参数，建立一个隧道IP头，作为这个数据包的新IP头，ESP头夹在隧道IP头和原始IP包之间，并点缀ESP尾。
ESP提供加密服务，所以原始IP包和ESP尾以密文的形式出现。
ESP在验证过程中，只对ESP头部、原始数据包IP包头、原始数据包数据进行验证；只对原始的整个数据包进行加密，而不加密验证数据。</p>
</li>
<li>
<p>ESP提供的安全服务：</p>
<ul>
<li>无连接数据完整性。</li>
<li>数据源认证。</li>
<li>抗重放服务。</li>
<li>数据保密。</li>
<li>有限的数据流保护
保密服务通过使用密码算法加密IP数据包的相关部分来实现。
数据流保密由隧道模式下的保密服务提供。
ESP通常使用DES、3DES、AES等加密算法实现数据加密，使用MD5或SHA1来实现数据完整性认证。
<strong>ESP头：</strong>
<img src="http://shanks.link/img/ipsec32a51248/20190620091356497.png" alt="在这里插入图片描述">
<strong>ESP在传输模式下封装：</strong>
<img src="http://shanks.link/img/ipsec32a51248/20190620091854620.png" alt="在这里插入图片描述">
<img src="http://shanks.link/img/ipsec32a51248/20190620092426327.png" alt="在这里插入图片描述">
ESP通常使用<strong>DES、3DES、AES</strong>等加密算法实现数据加密，使用MD5或SHA1来实现数据完整性认证。
ESP同样被当作一种<strong>IP协议</strong>对待，紧贴在ESP头前的IP头，以协议号50标志ESP头，并且，ESP不仅具备ESP头，还有一个包含有用信息的ESP尾。
在<strong>隧道模式</strong>中，<strong>ESP保护整个IP包</strong>，整个原始IP包将会以ESP载荷的方式加入新建的数据包，同时，系统根据隧道起点和终点等参数，建立一个隧道IP头，作为这个数据包的新IP头，ESP头夹在隧道IP头和原始IP包之间，并点缀ESP尾。
ESP提供加密服务，所以原始IP包和ESP尾以密文的形式出现。
ESP在验证过程中，只对ESP头部、原始数据包IP包头、原始数据包数据进行验证；只对原始的整个数据包进行加密，而不加密验证数据。</li>
</ul>
</li>
<li>
<h2 id="ah和esp对比">AH和ESP对比</h2>
</li>
<li>
<p><img src="http://shanks.link/img/ipsec32a51248/20190620092721417.png" alt="在这里插入图片描述">
ESP在隧道模式不验证外部IP头，因此ESP在隧道模式下可以在NAT环境中运行。
ESP在传输模式下会验证外部IP头部，将导致校验失败。
AH因为提供数据来源确认（源IP地址一旦改变，AH校验失败)，所以无法穿越NAT。</p>
</li>
<li>
<h1 id="ipsec建立阶段">IPSEC建立阶段</h1>
</li>
<li>
<h2 id="ike协商阶段">IKE协商阶段</h2>
</li>
<li>
<p>安全联盟SA(Security Association)：是两个IPSec通信实体之间经协商建立起来的一种共同协定，它规定了通信双方使用哪种IPSec协议保护数据安全、应用的算法标识、加密和验证的密钥取值以及密钥的生存周期等等安全属性值。通过使用安全关联(SA) ， IPSec能够区分对不同的数据流提供的安全服务。</p>
</li>
<li>
<p>IPSec是在两个端点之间提供安全通信，端点被称为<strong>IPSec对等体</strong>。IPSec能够允许系统、网络的用户或管理员控制对等体间安全服务的<strong>粒度</strong>。通过SA（Security Association），IPSec能够对不同的数据流提供不同级别的安全保护。</p>
</li>
<li>
<p><strong>安全联盟</strong>是IPSec的基础，也是IPSec的本质。SA是通信对等体间对某些要素的约定，例如，使用哪种安全协议、协议的操作模式（传输模式和隧道模式）、加密算法（DES和3DES）、特定流中保护数据的共享密钥以及密钥的生存周期等。</p>
</li>
<li>
<p>安全联盟是<strong>单向</strong>的，在两个对等体之间的<strong>双向通信</strong>，<strong>最少需要两个安全联盟</strong>来分别对两个方向的数据流进行安全保护。入站数据流和出站数据流分别由入站SA和出站SA进行处理。同时，如果希望同时使用AH和ESP来保护对等体间的数据流，则分别需要两个SA，一个用于AH，另一个用于ESP。</p>
</li>
<li>
<p>安全联盟由一个<strong>三元组</strong>来唯一标识，这个三元组包括<strong>安全参数索引</strong>（SPI, Security Parameter Index）、<strong>目的IP地址</strong>、<strong>安全协议号（AH 或ESP）</strong>。SPI 是为唯一标识SA而生成的一个32比特的数值，它在IPSec头中传输。</p>
</li>
<li>
<p>IPSec设备会把SA的相关参数放入**SPD（Security Policy Database）**里面，SPD里面存放着“什么数据应该进行怎样的处理”这样的消息，在IPSec数据包出站和入站的时候会首先从SPD数据库中查找相关信息并做下一步处理。</p>
</li>
<li>
<h3 id="ike的产生背景">IKE的产生背景</h3>
</li>
<li>
<p>用IPSec保护一个IP包之前，必须<strong>先建立安全联盟（SA）</strong>。</p>
</li>
<li>
<p>IPSec的安全联盟可以通过<strong>手工配置</strong>的方式建立。但是当<strong>网络中节点较多</strong>时，<strong>手工配置将非常困难</strong>，而且难以保证安全性。这时就可以使用 <strong>IKE(Internet Key Exchange)</strong> 自动进行安全联盟建立与密钥交换的过程。<strong>Internet密钥交换（IKE）<strong>就用于</strong>动态建立SA</strong>，代表IPSec对SA进行协商。</p>
</li>
<li>
<h3 id="ike的用途">IKE的用途</h3>
</li>
<li>
<p>IKE为IPSec协商生成密钥，供AH/ESP加解密和验证使用。</p>
</li>
<li>
<p>在IPSec通信双方之间，动态地建立安全关联（SA：Security Association），对SA进行管理和维护。
<img src="http://shanks.link/img/ipsec32a51248/20190620095401865.png" alt="在这里插入图片描述"></p>
</li>
<li>
<h3 id="ike与ahesp之间关系">IKE与AH/ESP之间关系</h3>
</li>
<li>
<p>IKE是UDP之上的一个应用层协议，是IPSec的<strong>信令协议</strong>。IKE为IPSec协商生成密钥,供AH/ESP加解密和验证使用。AH协议和ESP协议有自己的协议号，分别是51和50。
<img src="http://shanks.link/img/ipsec32a51248/20190620095933748.png" alt="在这里插入图片描述"></p>
</li>
<li>
<h3 id="ike工作过程">IKE工作过程</h3>
</li>
<li>
<p>IKE经过<strong>两个阶段</strong>为IPSec进行密钥协商并建立安全联盟：
<strong>第一阶段交换</strong>：通信各方彼此间建立了一个已通过身份验证和安全保护的通道，此阶段的交换建立了一个<strong>ISAKMP安全联盟</strong>，即<strong>ISAKMP SA（也可称为IKE SA）</strong>。第一阶段交换有两种协商模式：
<strong>主模式协商</strong>，一般情况下，IKE的主模式适用于两设备的公网IP固定、且要实现设备之间点对点的环境。
<strong>野蛮模式协商</strong>，对于例如ADSL拨号用户，其获得的公网IP不是固定的，且可能存在NAT设备的情况下，采用野蛮模式做NAT穿越，同时，由于IP不是固定的，用name作为id-type，总部采用模板的方式接收分支的IPSEC接入。
<strong>第二阶段交换</strong>：用已经建立的安全联盟（IKE SA）为IPSec协商安全服务，即为IPSec协商具体的安全联盟，建立<strong>IPSec SA</strong>，产生真正可以用来加密数据流的密钥，IPSec SA用于最终的IP数据安全传送。</p>
</li>
<li>
<h3 id="ike阶段1">IKE阶段1</h3>
</li>
<li>
<p><strong>IKE阶段1协商过程：</strong>
<img src="http://shanks.link/img/ipsec32a51248/20190620101201487.png" alt="在这里插入图片描述">
<strong>IKE阶段1–主模式协商：</strong><img src="http://shanks.link/img/ipsec32a51248/2019062010133052.png" alt="在这里插入图片描述"></p>
<ul>
<li>第一次交换（消息1和2）：<strong>策略协商</strong>。
在第1个数据包的传输过程中，发送方发起一个包含cookie (记为：Ci ) 和SA负载（记为：SAi，携带协商IKE SA的各项参数（5元组），包括IKE的散列类型如MD5；加密算法如DES、3DES等；认证方法如预共享、数字签名、加密临时值等；DH组；SA存活期）的数据包用来协商参数。
接收方查看IKE策略消息，在本地寻找与发送方IP地址匹配的策略，找到后发回一条消息去响应。响应者发送一个cookie （记为：Cr）和SA负载（记为：SAr，已经挑选的安全参数）；如果没有可以挑选的参数，响应者会返回一个负载拒绝。</li>
<li>第二次交换（消息3和4）：<strong>Diffie-Hellman交换</strong>。
执行DH交换，发起者和接收者交换伪随机数，如nonce。nonce是计算共享秘密(用来生成加密密钥和认证密钥)所必需的。该技术的优势在于，它允许参与者通过无担保媒体创建秘密值。</li>
<li>第三次交换（消息5和6）：<strong>对等体验证</strong>。
<strong>ISAKMP/IKE阶段1</strong>主要任务就是<strong>认证</strong>，第三阶段即在安全的环境下进行认证，前面两个步骤四个数据包的传输都是为了第三阶段第5和第6个数据包交换的认证做铺垫。<strong>第1-2包交换为认证准备好策略</strong>（例如：认证策略、加密策略和散列函数等），<strong>第3-4包交换为保护5-6的安全算法提供密钥资源。</strong>
<img src="http://shanks.link/img/ipsec32a51248/20190620101728673.png" alt="在这里插入图片描述">
1.<strong>第1、2个包</strong>里重点在于ISAKMP策略的协商，这些策略直接提供对第二阶段的IPSEC SA策略协商的加密保护，这是为后面能在一个安全的环境下协商IPSEC SA策略打下基础。
2.<strong>在3、4个包</strong>里，重点在于通过DH算法产生和传递进行第一阶段认证的密钥材料，这些材料会让两端的VPN设备产生一对相同的密钥，这个密钥就是第一阶段相互间真实的认证密钥。
3.<strong>在5、6个包</strong>里，就用前面产生的认证密钥进行相互认证，当相互认证通过，那么为第二阶段协商IPSEC SA策略的安全通道立即打开，两端的VPN服务器会用第一阶段协商的安全策略对第二阶段协商的IPSEC SA策略进行安全加密和认证。</li>
</ul>
</li>
<li>
<p><strong>IKE阶段1–野蛮模式协商：</strong>
野蛮模式IKE交互过程:
野蛮模式同样包含三个步骤，仅通过三个包进行传输，野蛮模式标识为<strong>Aggressive</strong>。
野蛮模式下有三个交互包：
1.第一个交互包发起方建议SA，发起DH交换
2.第二个交互包接收方接受SA
3.第三个交互包发起方认证接受方
野蛮模式交互过程少，所以在传输过程中，其传输的数据比较多，并且前两个数据为明文传输，仅消息3为加密传输。
<img src="http://shanks.link/img/ipsec32a51248/20190620103924964.png" alt="在这里插入图片描述">
1.第一条消息：发起者发送5元组，DH公共值，辅助随机数nonce以及身份资料（IDi和IDr，在此处为设备上配置域名字符串或用户名字符串，也有可能是IP地址)。响应者可以选择接受或者拒绝该建议。Diffie-Hellman 公开值、需要的随机数据和身份信息也在第一条消息中传送。
2.第二条消息：如果响应者接受发起者的建议，则回应一个选定的5元组，DH公共值，辅助随机数nonce，身份材料以及一个“认证散列值”。
3.第三条消息：由发起者发送一个“认证散列值”，该消息被验证，让应答方能够确定其中的散列值是否与计算得到的散列值相同，进而确定消息是否有问题。实际上，这个消息认证发起者并且证明它是交换的参与者。这个消息使用前两个消息交换的密钥信息生成的密钥进行加密。
但是要注意: 包含身份信息的消息未被加密, 所以和主模式不同，<strong>野蛮模式不提供身份保护</strong>。</p>
</li>
<li>
<p><strong>IKE阶段1两种模式对比</strong>：
<img src="http://shanks.link/img/ipsec32a51248/20190620104424678.png" alt="在这里插入图片描述"></p>
</li>
<li>
<h3 id="ike阶段2">.IKE阶段2</h3>
</li>
<li>
<p><strong>IKE阶段2协商过程</strong>:
<img src="http://shanks.link/img/ipsec32a51248/20190620104746624.png" alt="在这里插入图片描述">
与第一阶段的过程类似，参与者交换建议，以确定在SA中采用哪些安全参数。
双方协商IPSec安全参数，称为变换集transform set，包括：加密算法、Hash算法、安全协议、封装模式、存活时间。
阶段2提案还包括安全协议-封装安全有效载荷（ESP）或认证头（AH)以及所选的加密和认证算法。</p>
</li>
<li>
<p><strong>标准IPSec第二阶段</strong>：
阶段2使用“快速模式”交换。快速模式有两个主要的功能：
1.协商安全参数来保护数据连接。
2.周期性的对数据连接更新密钥信息。
第二阶段的效果为协商出IPSec 单向SA，为保护IPsec数据流而创建。第二阶段整个协商过程受第一阶段ISAKMP/IKE SA保护。
<strong>快速模式</strong>交换通过三条消息建立IPsec SA。
这3个包主要用来协商用于加密用户数据的安全策略（只有认证和加密方法和对应算法）：
前两条消息协商IPsec SA的各项参数值，并生成IPsec使用的密钥；第二条消息还为响应方提供在场的证据；第三条消息为发起方提供在场的证据。
<strong>当第二阶段协商完毕之后，第一阶段的策略将暂时不会被使用</strong>，直到有新的VPN连接建立时或IPSEC SA加密密钥超时时，才会用第一阶段的策略重新生成并传递新的加密数据和认证的密钥。</p>
</li>
<li>
<h2 id="数据传输阶段">数据传输阶段</h2>
</li>
<li>
<h3 id="概述">.概述</h3>
</li>
<li>
<p>数据传输阶段是通过<strong>AH</strong>或者<strong>ESP通信协议</strong>进行数据的传输。
数据传输建立在<strong>网络层</strong>。</p>
</li>
<li>
<h3 id="vpn隧道黑洞">.VPN隧道黑洞</h3>
</li>
<li>
<p><strong>可能情况：</strong>
对端的VPN连接已经断开而我方还处在SA的有效生存期时间内，从而形成了VPN隧道的黑洞。
另外一端如果之前SA没有释放，异常重启的对端又来连接，是不会接受新的连接协商的。</p>
</li>
<li>
<p><strong>DPD解决VPN隧道黑洞：</strong>
DPD：<strong>死亡对等体检测（Dead Peer Detection）</strong>，检查对端的ISAKMP SA是否存在。当VPN隧道异常的时候，能检测到并重新发起协商，来维持VPN隧道。
DPD <strong>只对第一阶段生效</strong>，如果第一阶段本身已经超时断开，则不会再发DPD包。
<strong>DPD包</strong>并不是连续发送，而是采用<strong>空闲计时器机制</strong>。每接收到一个IPSec加密的包后就重置这个包对应IKE SA的空闲定时器；
如果空闲定时器计时开始到计时结束过程都没有接收到该SA对应的加密包，那么下一次有IP包要被这个SA加密发送或接收到加密包之前就需要使用DPD来检测对方是否存活。
<strong>DPD检测</strong>主要靠<strong>超时计时器</strong>，超时计时器用于判断是否再次发起请求，默认是发出5次请求（请求-&gt;超时-&gt;请求-&gt;超时-&gt;请求-&gt;超时）都没有收到任何DPD应答就会删除SA。</p>
</li>
<li>
<p><strong>检查对端的ISAKMP SA是否存在两种工作模式：</strong>
1.<strong>周期模式</strong>：每隔一段时间，向对端发送DPD包探测对等体是否仍存在，如果收到回复则证明正常。如果收不到回复，则会每隔2秒发送一次DPD，如果发送七次仍收不到回复，则自动清除本地对应的ISAKMP SA和IPSEC SA。
2.<strong>按需模式</strong>：这是默认模式，当通过IPSEC VPN发送出流量而又收不到回程的数据时，则发出DPD探测包，每隔2秒发送一次，七次都收不到回应则清除本地对应的ISAKMP SA和IPSEC SA。注意，如果IPSEC通道上如果跑的只有单向的UDP流量，则慎用这个模式，尽管这种情况极少。
DPD很实用，应该开启。至于选择哪个模式，则根据实际需要，周期模式可以相对快地找出问题peer，但较消耗带宽；按需模式，较节约带宽，但只有当发出加密包后收不到解密包才会去探测。</p>
</li>
<li></li>
<li>
<p>版权声明：本文为CSDN博主「NEUChords」的原创文章，遵循CC 4.0 BY-SA版权协议，转载请附上原文出处链接及本声明。</p>
</li>
<li>
<p>原文链接：<a href="https://link.zhihu.com/?target=https%3A//blog.csdn.net/NEUChords/article/details/92968314">IPSec介绍_NEUChords的博客-CSDN博客_ipsec</a></p>
</li>
<li></li>
</ul>

    </div>
    <footer class="post-footer">
     
 
<div class="post-tags">     
     
    <a href="http://shanks.link/tags/ipsec" rel="tag" title="ipsec">#ipsec#</a>
    
</div>



     <div class="post-nav">
    <div class="post-nav-next post-nav-item">
    
        <a href="http://shanks.link/blog/2023/03/23/openvpn-%E9%83%A8%E7%BD%B2/" rel="next" title="OpenVPN 部署">
        <i class="fa fa-chevron-left"></i> OpenVPN 部署
        </a>
    
    </div>

    <div class="post-nav-prev post-nav-item">
    
        <a href="http://shanks.link/blog/2023/03/16/%E5%AD%A6%E4%B9%A0%E8%AE%A1%E5%88%92/" rel="prev" title="学习计划">
        学习计划 <i class="fa fa-chevron-right"></i>
        </a>
    
    </div>
</div>
      
     
     
     





<script src="https://utteranc.es/client.js"
        repo="shankusu2017@gmail.com/"
        issue-term="pathname"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>
<noscript>Please enable JavaScript to view the <a href="https://github.com/utterance">comments powered by utterances.</a></noscript>

    </footer>
  </article>
</section>

          </div>
        </div>
        <div class="sidebar-toggle">
  <div class="sidebar-toggle-line-wrap">
    <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
    <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
    <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
  </div>
</div>
<aside id="sidebar" class="sidebar">
  <div class="sidebar-inner">

    <section class="site-overview sidebar-panel  sidebar-panel-active ">
      <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image"
        src="http://shanks.link/img/logo.jpg"
        alt="shankusu2017@gmail.com" />
    <p class="site-author-name" itemprop="name">shankusu2017@gmail.com</p>
    <p class="site-description motion-element" itemprop="description"> </p>
</div>
      <nav class="site-state motion-element">
    <div class="site-state-item site-state-posts">
      <a href="http://shanks.link/post/">
        <span class="site-state-item-count">565</span>
        <span class="site-state-item-name">日志</span>
      </a>
    </div>
    <div class="site-state-item site-state-categories">    
        <a href="http://shanks.link/categories/">      
         
        <span class="site-state-item-count">45</span>
        
        <span class="site-state-item-name">分类</span>
        
        </a>
    </div>

    <div class="site-state-item site-state-tags">
        <a href="http://shanks.link/tags/">
         
        <span class="site-state-item-count">50</span>
        
        <span class="site-state-item-name">标签</span>
        </a>
    </div>
</nav>
      
      
<div class="links-of-author motion-element">
    
        <span class="links-of-author-item">
        <a href="https://github.com/shankusu2017" target="_blank" title="GitHub">
            <i class="fa fa-fw fa-github"></i>
            GitHub
        </a>
        </span>
    
</div>


      

      <div class="links-of-blogroll motion-element inline">
<script type="text/javascript" src="//rf.revolvermaps.com/0/0/8.js?i=5b4f2ucxar6&amp;m=0&amp;s=220&amp;c=ff0000&amp;cr1=ffffff&amp;f=arial&amp;l=33&amp;bv=35" async="async"></script>
</div>

    </section>
    
  </div>
</aside>

      </div>
    </main>
   
    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  <span itemprop="copyrightYear">  &copy; 
  2009 - 2023</span>
</div>
<div>
  <a href="https://beian.miit.gov.cn/" rel="noopener" target="_blank">粤ICP备2021068940号-1</a>
  <a href="https://www.beian.gov.cn/portal/registerSystemInfo?recordcode=44011302003059" rel="noopener" target="_blank">粤公网安备44011302003059</a>
</div>


      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
      <span id="scrollpercent"><span>0</span>%</span>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>
<script type="text/javascript" src="http://shanks.link/js/vendor/jquery/index.js?v=2.1.3"></script>
<script type="text/javascript" src="http://shanks.link/js/vendor/fastclick/lib/fastclick.min.js?v=1.0.6"></script> 
<script type="text/javascript" src="http://shanks.link/js/vendor/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
<script type="text/javascript" src="http://shanks.link/js/vendor/velocity/velocity.min.js?v=1.2.1"></script>
<script type="text/javascript" src="http://shanks.link/js/vendor/velocity/velocity.ui.min.js?v=1.2.1"></script>
<script src="http://shanks.link/js/vendor/ua-parser-js/dist/ua-parser.min.js?v=0.7.9"></script>

<script src="http://shanks.link/js/vendor/fancybox/jquery.fancybox.pack.js?v=2.1.5"></script>

<script type="text/javascript" src="http://shanks.link/js/utils.js"></script>
<script type="text/javascript" src="http://shanks.link/js/motion.js"></script>
<script type="text/javascript" src="http://shanks.link/js/affix.js"></script>
<script type="text/javascript" src="http://shanks.link/js/schemes/pisces.js"></script>

<script type="text/javascript" src="http://shanks.link/js/scrollspy.js"></script>
<script type="text/javascript" src="http://shanks.link/js/post-details.js"></script>
<script type="text/javascript" src="http://shanks.link/js/toc.js"></script>

<script type="text/javascript" src="http://shanks.link/js/bootstrap.js"></script>

<script type="text/javascript" src="http://shanks.link/js/search.js"></script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX", "output/HTML-CSS"],
    tex2jax: {
      inlineMath: [ ['$','$'] ],
      displayMath: [ ['$$','$$'] ],
      processEscapes: true
    },
    "HTML-CSS": { fonts: ["TeX"] }
  });
</script>
<script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML' async></script>
</body>
</html>