<!DOCTYPE HTML>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" /> 
    <title>1小时学会P4-16编程基础 - Golang入门指南</title>
    <meta name="keywords" content="Golang,golang,go,git,Git,Lua,lua">
    
    <meta property="og:title" content="1小时学会P4-16编程基础">
    <meta property="og:site_name" content="Golang入门指南">
    <meta property="og:image" content="/img/author.jpg"> 
    <meta name="title" content="1小时学会P4-16编程基础 - Golang入门指南" />
    <meta name="description" content="愿星光伴你左右"> 
    <link rel="shortcut icon" href="http://shanks.link/img/favicon.ico" />
    <link rel="apple-touch-icon" href="http://shanks.link/img/apple-touch-icon.png" />
    <link rel="apple-touch-icon-precomposed" href="http://shanks.link/img/apple-touch-icon.png" />
    <link href="http://shanks.link/js/vendor/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />
    <link href="http://shanks.link/js/vendor/fancybox/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />
    <link href="http://shanks.link/css/main.css" rel="stylesheet" type="text/css" />
    <link href="http://shanks.link/css/syntax.css" rel="stylesheet" type="text/css" />
    <script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post"},
     fancybox: true, 
    motion: true
  };
</script>
</head>
<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">
<div class="container one-collumn sidebar-position-left page-home  ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"> <div class="site-meta  custom-logo ">

  <div class="custom-logo-site-title">
    <a href="http://shanks.link/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">Golang入门指南</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle"></p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
    <ul id="menu" class="menu">
      
      
        <li class="menu-item ">
          <a href="http://shanks.link/post/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />首页
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/todo/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />todo
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/thinking/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />思考
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/life/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />life
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/food/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />food
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/os/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />OS
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/lua/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />lua
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/redis/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />redis
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/go/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />Golang
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/c/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />C
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/tcpip/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />TCP/IP
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/ebpf/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />ebpf
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/p4/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />p4
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/openvpn/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />OpenVPN
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/ipsec/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />IPSec
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/l2tp/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />L2TP
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/dns/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />DNS
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/distributed/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />distributed
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/web/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />web
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/openwrt/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />OpenWRT
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/%E8%BF%90%E7%BB%B4/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />运维
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/git/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />Git
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/%E9%B8%9F%E5%93%A5%E7%9A%84%E7%A7%81%E6%88%BF%E8%8F%9C/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />鸟哥的私房菜
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/it/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />IT杂谈
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/finance/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />投资
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/about/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />About Me
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/links/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />友情链接
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/ftp/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />FTP
          </a>
        </li>
      
      <li class="menu-item menu-item-search">
        <a href="javascript:;" class="popup-trigger"> <i class="menu-item-icon fa fa-search fa-fw"></i> <br /> 搜索</a>
      </li>
    </ul>
    <div class="site-search">
      <div class="popup">
 <span class="search-icon fa fa-search"></span>
 <input type="text" id="local-search-input">
 <div id="local-search-result"></div>
 <span class="popup-btn-close">close</span>
</div>

    </div>
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
<section id="posts" class="posts-expand">
  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <header class="post-header">
      <h1 class="post-title" itemprop="name headline">
        <a class="post-title-link" href="http://shanks.link/blog/2023/08/25/1%E5%B0%8F%E6%97%B6%E5%AD%A6%E4%BC%9Ap4-16%E7%BC%96%E7%A8%8B%E5%9F%BA%E7%A1%80/" itemprop="url">
        1小时学会P4-16编程基础
        </a>
      </h1>
      <div class="post-meta">
      <span class="post-time">
<span class="post-meta-item-icon">
    <i class="fa fa-calendar-o"></i>
</span>
<span class="post-meta-item-text">时间：</span>
<time itemprop="dateCreated" datetime="2016-03-22T13:04:35+08:00" content="2023-08-25">
    2023-08-25
</time>
</span> 
      

  <span class="post-category" >
  &nbsp; | &nbsp;
  <span class="post-meta-item-icon">
    <i class="fa fa-folder-o"></i>
  </span>
  <span class="post-meta-item-text">分类：</span>
  
    <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
      <a href="http://shanks.link/categories/p4" itemprop="url" rel="index">
        <span itemprop="name">p4</span>
      </a>
      &nbsp; 
    </span>
  
</span>


       <span>
&nbsp; | &nbsp;
<span class="post-meta-item-icon">
    <i class="fa fa-eye"></i>
</span>
<span class="post-meta-item-text">阅读：</span>
<span class="leancloud-visitors-count">7674 字 ~16分钟</span>
</span>
      </div>
    </header>
    <div class="post-body" itemprop="articleBody">
    <p><a href="https://bbs.huaweicloud.com/community/usersnew/id_1556361681406159">荷包蛋好吃</a> 发表于 2021/07/29 19:23:24</p>
<h1 id="p4开源项目">P4开源项目</h1>
<p>P4项目源码可以在github上直接获取（https://github.com/p4lang）。</p>
<h2 id="项目关系">项目关系</h2>
<p><strong>项目关系</strong>如下：
<img src="http://shanks.link/img/p4/image_641.png" alt="image.png"></p>
<ul>
<li>高级语言层：高级抽象的P4语言编写程序</li>
<li>前端编译器：对高级语言进行与目标无关的语义分析并生产中间表示</li>
<li>中间表示层：高级语言中间表示，可转换成多种其他语言</li>
<li>后端编译器：将中间表示转换为目标平台机器码</li>
<li>目标对象层：受控制硬件/软件设备</li>
</ul>
<h2 id="项目功能">项目功能</h2>
<p>P4项目由很多个单独的模块组成，每个模块就是一个子项目，<strong>各子项目功能</strong>介绍如下：</p>
<ul>
<li><strong>p4-hlir:</strong> 前端编译器。将P4代码转换成高级中间表示。目前，高级中间表示的展示形式与Python对象的层次结构相同。作用是： <strong>使后端编译器不用关心语法分析和目标无关的语义检查</strong>。</li>
<li><strong>p4c-bm</strong>：后端编译器。可以将高级语言或高级中间表示转为JSON格式或PD格式的配置文件。</li>
<li><strong>behavivoral-model</strong>: 又称bmv2，P4软件交换机。使用C++语言编写。该模块主要实现三个目标，最重要的是simple_switch，即P4语言标准中抽象交换机模型。另外两个目标是simple_router, l2_switch</li>
<li><strong>p4-build</strong>: 需要手动生成的基础设施库，为执行P4程序，编译安装PD库。</li>
<li><strong>switch</strong>: switch示例，基本完成交换机的绝大部分功能。</li>
<li><strong>p4factory</strong>： 快速开始，内含6个可快速启动的项目，包括basic_routing, copy_to_cpu, l2_switch, sai_p4, simple_router, switch</li>
<li><strong>ntf (Network Test Framework)</strong>: 网络测试框架。内含用以执行bmv2应用的网络测试用例。该框架中集成了mininet和docker。</li>
<li><strong>ptf</strong>：Python测试框架，基于unittest框架实现，该框架中的大部分代码从floodlight项目中的OFTest框架移植而来。</li>
<li><strong>tutorials</strong>：示例教程。包括Basic Forwarding, Basic Tunneling, P4Runtime, Explicit Congestion Notification, Multi-Hop Route Inspection, Source Routing, Calculator, Load Balancing。</li>
<li><strong>scapy-vxlan</strong>: 扩展Vxlan和ERSPAN-like协议包头处理。</li>
</ul>
<h1 id="p4语言基础p4-16">P4语言基础（P4-16）</h1>
<h1 id="相关术语">相关术语</h1>
<ul>
<li>PISA（Protocol-Independent Switch Architecture）:协议无关交换机架构。</li>
<li>P4 Target：特定的硬件实现。</li>
<li>P4 Architecture：通过一组P4可编程、外部（externs）与固定组件，提供对P4 Target进行编程的接口。</li>
</ul>
<blockquote>
<p>P4语言与核心库由社区发展而来。外部(extern)库以及P4架构定义由设备上提供。</p></blockquote>
<h1 id="pisa">PISA</h1>
<p><img src="http://shanks.link/img/p4/image642.png" alt="image.png"></p>
<ul>
<li>Parser：根据程序员声明的数据报头，解析数据包，生产独立的数据包头与中间信息（MetaData）；</li>
<li>Match-Action Pipeline：根据解析的报头与元信息，匹配流表，对报头进行修改、添加、删除等操作；</li>
<li>Deparser：数据包重新被序列化。</li>
</ul>
<h1 id="p4架构">P4架构</h1>
<ul>
<li>V1Model：For 芯片。<a href="https://github.com/p4lang/p4c/blob/master/p4include/v1model.p4"> P4 v1.0 switch model实现源码</a>，公开属性总结连接。</li>
<li>SImpleSumeSwitch：For FPGA开发板。一个为NetFPGA SUME开发办定义的P4架构，simpe-sume-switch，<a href="https://github.com/NetFPGA/NetFPGA-SUME-public/wiki">NetFPGA Sume</a>;</li>
<li>PSA：For everithing。<a href="https://github.com/p4lang/p4c/blob/master/p4include/psa.p4">参考实现源码</a>，手册文档</li>
</ul>
<p><img src="http://shanks.link/img/p4/image643.png" alt="image.png"></p>
<blockquote>
<p>除了V1Model，目前还有Portable Switch Architecture和Tofino native等架构，目标是tofino native的架构比v1model有更多的功能，PSA的架构可以被更多的target （FPGA，ASIC，Software）所支持，提供从V1model到其他两个架构的translation。所以可以按照v1model的架构来写程序，之后compiler会帮助把v1model的程序转换成其他的架构的程序。</p></blockquote>
<h1 id="p4-16语言元素">P4-16语言元素</h1>
<ul>
<li>Parser：通过一系列状态（State）转换，提取报头字段，与一些元数据；</li>
<li>Control：Tables, Actions, control flow声明；</li>
<li>Expressions：基本的操作与运算符；</li>
<li>Data Type：BitStrings，header, Struct，array等数据类型。</li>
<li>Architecture Description：目标硬件提供的可编程的组件与接口；</li>
<li>Extern Libraries：目标硬件支持的特定组件。</li>
</ul>
<p><img src="http://shanks.link/img/p4/image644.png" alt="image.png"></p>
<h1 id="为一个目标硬件编写p4程序">为一个目标硬件编写P4程序</h1>
<p><img src="http://shanks.link/img/p4/image645.png" alt="image.png"></p>
<p>整个过程由几部分组成，如下：</p>
<ul>
<li>用户提供： P4程序与控制面；</li>
<li>厂家提供：P4架构模型与目标硬件；</li>
<li>运行时操作：控制流表，外部控制，数据包上报控制面等。</li>
</ul>
<h1 id="数据类型">数据类型</h1>
<h2 id="基础类型">基础类型</h2>
<ul>
<li><code>bit&lt;n&gt;</code>: n位的无符号整型（bitstring）；</li>
<li><code>bit</code>: 等同于<code>bit&lt;1&gt;</code>；</li>
<li><code>int&lt;n&gt;</code>：n（n &gt;=2）位的有符号整型；</li>
<li><code>varbit&lt;n&gt;</code>：最大为n位的变长bitstring。</li>
</ul>
<p>示例：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span>bit&lt;4&gt; version;
</span></span><span style="display:flex;"><span>bit&lt;4&gt; ihl;
</span></span><span style="display:flex;"><span>bit&lt;8&gt; diffserv;
</span></span><span style="display:flex;"><span>bit&lt;16&gt; totalLen;
</span></span></code></pre></div><h2 id="typedef-定义类型别名">typedef 定义类型别名</h2>
<p>设置类型别名，如：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span>typedef bit&lt;48&gt; macAddr_t;
</span></span><span style="display:flex;"><span>typedef bit&lt;32&gt; ip4Addr_t;
</span></span></code></pre></div><h2 id="header-类型">header 类型</h2>
<p>header类型为<strong>有序</strong>的程序集合，特点如下：</p>
<ul>
<li>可以包含<code>bit&lt;n&gt;、int&lt;n&gt;、varbit&lt;n&gt;</code>基础数据类型；</li>
<li>必须<strong>字节对齐</strong>；</li>
<li>可以是<strong>valid</strong>或<strong>invalid</strong>，并提供几种操作测试或设置有效位：<code>isValid()/setValid()/setInvalid()</code></li>
</ul>
<p>示例：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span>typedef bit&lt;48&gt; macAddr_t;
</span></span><span style="display:flex;"><span>typedef bit&lt;32&gt; ip4Addr_t;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>header ethernet_t {
</span></span><span style="display:flex;"><span>    macAddr_t dstAddr;
</span></span><span style="display:flex;"><span>    macAddr_t srcAddr;
</span></span><span style="display:flex;"><span>    bit&lt;16&gt; etherType;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>header ipv4_t {
</span></span><span style="display:flex;"><span>    bit&lt;4&gt; version;
</span></span><span style="display:flex;"><span>    bit&lt;4&gt; ihl;
</span></span><span style="display:flex;"><span>    bit&lt;8&gt; diffserv;
</span></span><span style="display:flex;"><span>    bit&lt;16&gt; totalLen;
</span></span><span style="display:flex;"><span>    bit&lt;16&gt; identification;
</span></span><span style="display:flex;"><span>    bit&lt;3&gt; flags;
</span></span><span style="display:flex;"><span>    bit&lt;13&gt; fragOffset;
</span></span><span style="display:flex;"><span>    bit&lt;8&gt; ttl;
</span></span><span style="display:flex;"><span>    bit&lt;8&gt; protocol;
</span></span><span style="display:flex;"><span>    bit&lt;16&gt; hdrChecksum;
</span></span><span style="display:flex;"><span>    ip4Addr_t srcAddr;
</span></span><span style="display:flex;"><span>    ip4Addr_t dstAddr;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="struct-类型">struct 类型</h2>
<p>struct类型为<strong>无序</strong>数据类型集合，且不需字节对齐。可用于<strong>元数据</strong>的组织。</p>
<p>示例：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#f00;font-style:italic">/* Architecture */</span>
</span></span><span style="display:flex;"><span>struct standard_metadata_t {
</span></span><span style="display:flex;"><span>    bit&lt;9&gt; ingress_port;
</span></span><span style="display:flex;"><span>    bit&lt;9&gt; egress_spec;
</span></span><span style="display:flex;"><span>    bit&lt;9&gt; egress_port;
</span></span><span style="display:flex;"><span>    bit&lt;32&gt; clone_spec;
</span></span><span style="display:flex;"><span>    bit&lt;32&gt; instance_type;
</span></span><span style="display:flex;"><span>    bit&lt;1&gt; drop;
</span></span><span style="display:flex;"><span>    bit&lt;16&gt; recirculate_port;
</span></span><span style="display:flex;"><span>    bit&lt;32&gt; packet_length;
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#f00;font-style:italic">/* User program */</span>
</span></span><span style="display:flex;"><span>struct metadata {
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h1 id="parser">parser</h1>
<p>类似于C语言的<strong>function</strong>声明关键字，<strong>可以有循环</strong>。通过一系列状态（state）执行与转换，提取报头字段与元数据。</p>
<p>示例如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#f00;font-style:italic">/* From core.p4 */</span>
</span></span><span style="display:flex;"><span>extern packet_in {
</span></span><span style="display:flex;"><span>    <span style="color:#00f">void</span> extract&lt;T&gt;(out T hdr);
</span></span><span style="display:flex;"><span>    <span style="color:#00f">void</span> extract&lt;T&gt;(out T variableSizeHeader, <span style="color:#00f">in</span> bit&lt;32&gt; variableFieldSizeInBits);
</span></span><span style="display:flex;"><span>    T lookahead&lt;T&gt;();
</span></span><span style="display:flex;"><span>    <span style="color:#00f">void</span> advance(<span style="color:#00f">in</span> bit&lt;32&gt; sizeInBits);
</span></span><span style="display:flex;"><span>    bit&lt;32&gt; length();
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f00;font-style:italic">/* Architecture */</span>
</span></span><span style="display:flex;"><span>struct standard_metadata_t {
</span></span><span style="display:flex;"><span>    bit&lt;9&gt; ingress_port;
</span></span><span style="display:flex;"><span>    bit&lt;9&gt; egress_spec;
</span></span><span style="display:flex;"><span>    bit&lt;9&gt; egress_port;
</span></span><span style="display:flex;"><span>    bit&lt;32&gt; clone_spec;
</span></span><span style="display:flex;"><span>    bit&lt;32&gt; instance_type;
</span></span><span style="display:flex;"><span>    bit&lt;1&gt; drop;
</span></span><span style="display:flex;"><span>    bit&lt;16&gt; recirculate_port;
</span></span><span style="display:flex;"><span>    bit&lt;32&gt; packet_length;
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#f00;font-style:italic">/* User program */</span>
</span></span><span style="display:flex;"><span>struct metadata_t {
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>struct headers_t {
</span></span><span style="display:flex;"><span>    ethernet_t ethernet;
</span></span><span style="display:flex;"><span>    ipv4_t ipv4;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>parser MyParser(packet_in packet,
</span></span><span style="display:flex;"><span>    out headers hdr,
</span></span><span style="display:flex;"><span>    inout metadata meta,
</span></span><span style="display:flex;"><span>    inout standard_metadata_t std_meta) {
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    state start {
</span></span><span style="display:flex;"><span>        packet.extract(hdr.ethernet);
</span></span><span style="display:flex;"><span>        transition accept;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="parser的输入与输出">parser的输入与输出</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span>parser MyParser(packet_in packet,
</span></span><span style="display:flex;"><span>    out headers hdr,
</span></span><span style="display:flex;"><span>    inout metadata meta,
</span></span><span style="display:flex;"><span>    inout standard_metadata_t std_meta) {...}
</span></span></code></pre></div><p><code>parser</code>的输入与输出模型如下：
<img src="http://shanks.link/img/p4/image646.png" alt="image.png"></p>
<ul>
<li>parser输入：
<ul>
<li><code>packet_in</code>类型数据包，是由目标设备提供的<code>extern</code>类型数据。</li>
<li><code>metadata</code>: 用户自定义元数据；</li>
<li><code>standard_metadata_t</code>：**设备产生提供的元数据。</li>
</ul>
</li>
<li>parser输出：
<ul>
<li><code>header</code>：用户定义的数据报头；</li>
<li><code>metadata</code>: 用户自定义元数据；</li>
<li><code>standard_metadata_t</code>：设备产生提供的元数据。</li>
</ul>
</li>
</ul>
<p>注意<code>extern packet_in</code>提供几个接口，说明如下：</p>
<ul>
<li><code>void extract&lt;T&gt;(out T hdr)</code>: 从数据报文指针开始位置，抽取<code>T</code>类型数据大小的报头，存储在<code>hdr</code>中**，并将<strong>数据报文指针前移</strong>。可能触发<code>PacketTooShort or StackOutOfBounds</code>错误，<code>T</code>类型的数据的大小必须为<strong>固定值</strong>。</li>
<li><code>void extract&lt;T&gt;(out T variableSizeHeader, in bit&lt;32&gt; variableFieldSizeInBits)</code>：读取数据报头到可变大小的报头变量<code>variableSizeHeader</code>中，<code>variableSizeHeader</code>必须包含一个及以上<code>varbit</code>字段。<strong>数据报指针前移</strong>。</li>
<li><code>T lookahead&lt;T&gt;()</code>：读取<code>T</code>类型数据大小的报头，但不<strong>前移数据报指针</strong>。</li>
<li><code>void advance(in bit&lt;32&gt; sizeInBits)</code>：前移数据报头指针。</li>
<li><code>bit&lt;32&gt; length()</code>：返回数据报的<strong>字节</strong>数。</li>
</ul>
<h2 id="parser的状态与转换">parser的状态与转换</h2>
<h3 id="状态">状态</h3>
<p><code>parser</code>有三种预设状态<code>state</code>，为：</p>
<ul>
<li><code>start</code>：进入<code>parser</code>功能块后的第一个状态，自动进入；</li>
<li><code>accept</code>：若进入<code>accept</code>状态，则表示数据报进入后续control流程；</li>
<li><code>reject</code>：数据包被抛弃。</li>
</ul>
<p>其他<code>states</code>，用户可以自行定义。每个<code>state</code>执行0次或以上，然后转换为其他<code>state</code>。（<strong>允许循环</strong>）</p>
<h3 id="转换">转换</h3>
<ol>
<li>使用<code>transition</code>关键字使<code>parser</code>在状态之间转换。</li>
</ol>
<p>示例：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span>parser MyParser(...) {
</span></span><span style="display:flex;"><span>    state start {
</span></span><span style="display:flex;"><span>        packet.extract(hdr.ethernet);
</span></span><span style="display:flex;"><span>        transition accept;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><ol>
<li>使用<code>transition select(data){...}</code>根据<code>data</code>的值转换到不同状态。
<code>select</code>声明类似C语言中的<code>switch...case</code>，但是其没有<code>fall-through</code>行为，不用<code>break</code>进行中断后续选择。</li>
</ol>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>state start {
</span></span><span style="display:flex;"><span>    transition parse_ethernet;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>state parse_ethernet {
</span></span><span style="display:flex;"><span>    packet.extract(hdr.ethernet);
</span></span><span style="display:flex;"><span>    transition select(hrd.ethernet.etherType) {
</span></span><span style="display:flex;"><span>        0x800: parse_ipv4;
</span></span><span style="display:flex;"><span>        default: accept;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>state parse_ipv4 {
</span></span><span style="display:flex;"><span>    packet.extract(hdr.ipv4);
</span></span><span style="display:flex;"><span>    transition accept;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="value_set">value_set</h2>
<p>只能用在parser 语句块中。</p>
<h2 id="emit">emit</h2>
<p>pkt.emit 不支持条件emit，mirror.emit支持单bit的条件emit</p>
<h2 id="header-stacks">header stacks</h2>
<p>头堆栈有两个属性 <code>next</code> 与 <code>last</code>，其可以在解析器中解析时使用。</p>
<p>举例如下，使用如下<code>mpls</code>定义表示10个MPLS头：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span>header Mpls_h {
</span></span><span style="display:flex;"><span>    bit&lt;20&gt; label;
</span></span><span style="display:flex;"><span>    bit&lt;3&gt; tc;
</span></span><span style="display:flex;"><span>    bit bos;
</span></span><span style="display:flex;"><span>    bit&lt;8&gt; ttl;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Mpls_h[10] mpls;
</span></span></code></pre></div><p><code>mpls.next</code> 表示 mpls 堆栈中的一个元素的值。初始时，<code>mpls.next</code> 指向堆栈的第一个元素，当成功调用<code>extract</code>方法后，<code>mpls.next</code>将自动向前偏移，指向下一个元素。
<code>mpls.last</code>指向 next 前面的那个元素（如果元素存在），即最近 extract 出来的那个元素。</p>
<p><strong>注意</strong>：通过 next 或 last 属性访问头堆栈中不存在的元素将引发 transition reject 状态转换，并设置错误到 error.StackOutOfBounds</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span>struct Pkthdr {
</span></span><span style="display:flex;"><span>    Ethernet_h ethernet;
</span></span><span style="display:flex;"><span>    Mpls_h[3] mpls;
</span></span><span style="display:flex;"><span>    <span style="color:#f00;font-style:italic">// other headers omitted
</span></span></span><span style="display:flex;"><span><span style="color:#f00;font-style:italic"></span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>parser P(packet_in b, out Pkthdr p) {
</span></span><span style="display:flex;"><span>    state start {
</span></span><span style="display:flex;"><span>        b.extract(p.ethernet);
</span></span><span style="display:flex;"><span>        transition select(p.ethernet.etherType) {
</span></span><span style="display:flex;"><span>            0x8847: parse_mpls;
</span></span><span style="display:flex;"><span>            0x0800: parse_ipv4;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    state parse_mpls {
</span></span><span style="display:flex;"><span>        b.extract(p.mpls.next);
</span></span><span style="display:flex;"><span>        transition select(p.mpls.last.bos) {
</span></span><span style="display:flex;"><span>            0: parse_mpls; <span style="color:#f00;font-style:italic">// This creates a loop
</span></span></span><span style="display:flex;"><span><span style="color:#f00;font-style:italic"></span>            1: parse_ipv4;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f00;font-style:italic">// other states omitted
</span></span></span><span style="display:flex;"><span><span style="color:#f00;font-style:italic"></span>}
</span></span></code></pre></div><h1 id="control">control</h1>
<p>对于固定硬件，SwitchIngress 控制流程的参数固定，如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span>control SwitchIngress(
</span></span><span style="display:flex;"><span>        inout header_t hdr,
</span></span><span style="display:flex;"><span>        inout metadata_t ig_md,
</span></span><span style="display:flex;"><span>        <span style="color:#00f">in</span> ingress_intrinsic_metadata_t ig_intr_md,
</span></span><span style="display:flex;"><span>        <span style="color:#00f">in</span> ingress_intrinsic_metadata_from_parser_t ig_prsr_md,
</span></span><span style="display:flex;"><span>        inout ingress_intrinsic_metadata_for_deparser_t ig_dprsr_md,
</span></span><span style="display:flex;"><span>        inout ingress_intrinsic_metadata_for_tm_t ig_tm_md) {
</span></span><span style="display:flex;"><span>        ...
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><ul>
<li>类似于C语言的<strong>function</strong>声明关键字，<strong>不能有循环</strong>。</li>
<li>if 语句中表达式<code>&lt;, &gt;</code>两侧只能有一个变量，<code>==</code>两侧可以都为变量，但判断条件产生的PHV不能超过 44 bits，否则报如下错误</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#00f">if</span> (eg_md.lkp.outer_dst_mac == eg_md.lkp.outer_src_mac) {
</span></span><span style="display:flex;"><span>/home/lihaifeng/test/casteni-gw/p4src/casteni_gw.p4(314): error: : condition too complex, limit of 4 bytes + 12  bits of PHV input exceeded
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>/home/lihaifeng/test/casteni-gw/p4src/casteni_gw.p4(314): [--Werror=legacy] error: condition too complex, one operand of &gt; must be constant
</span></span></code></pre></div><ul>
<li>在control中，可以申明变量、创建tables，以及实例化<code>externs</code>等。</li>
<li>在control中，通过<code>apply</code>声明功能；</li>
<li>代表可表达为DAG的所有类型的处理，包括：
<ul>
<li>Match-Action Pipelines;</li>
<li>Deparsers;</li>
<li>其他的数据报处理，如更新checksums。</li>
</ul>
</li>
<li>由用户与特定架构指定的接口，如headers和metadata。</li>
</ul>
<p>示例：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span>control MyIngress(inout headers hdr,
</span></span><span style="display:flex;"><span>    inout metadata meta,
</span></span><span style="display:flex;"><span>    inout standard_metadata_t std_meta) {
</span></span><span style="display:flex;"><span>    <span style="color:#f00;font-style:italic">/* Declarations region */</span>
</span></span><span style="display:flex;"><span>    bit&lt;48&gt; tmp;
</span></span><span style="display:flex;"><span>    apply {
</span></span><span style="display:flex;"><span>        <span style="color:#f00;font-style:italic">/* Control Flow */</span>
</span></span><span style="display:flex;"><span>        tmp = hdr.ethernet.dstAddr;
</span></span><span style="display:flex;"><span>        hdr.ethernet.dstAddr = hdr.ethernet.srcAddr;
</span></span><span style="display:flex;"><span>        hdr.ethernet.srcAddr = tmp;
</span></span><span style="display:flex;"><span>        std_meta.egress_spec = std_meta.ingress_port;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>上述程序的功能是：将源MAC与目的MAC对换，然后从输入口转发出去。</p>
<h2 id="action">action</h2>
<p>上小结的功能可以通过简单的<code>action</code>语句重新实现：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span>control MyIngress(inout headers hdr, 
</span></span><span style="display:flex;"><span>    inout metadata meta,
</span></span><span style="display:flex;"><span>    inout standard_metadata_t std_meta) {
</span></span><span style="display:flex;"><span>    action swap_mac(inout bit&lt;48&gt; src, 
</span></span><span style="display:flex;"><span>        inout bit&lt;48&gt; dst) {
</span></span><span style="display:flex;"><span>        bit&lt;48&gt; tmp =src;
</span></span><span style="display:flex;"><span>        src = dst;
</span></span><span style="display:flex;"><span>        dst = tmp;
</span></span><span style="display:flex;"><span>   }
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    apply {
</span></span><span style="display:flex;"><span>        swap_mac(hdr.ethernet.srcAddr,
</span></span><span style="display:flex;"><span>            hdr.ethernet.dstAddr);
</span></span><span style="display:flex;"><span>        std_meta.egress_spec = std_meta.ingress_port;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>action关键字的特点：</p>
<ul>
<li>类似C语言中的function</li>
<li><code>action</code>可以在<code>control</code>内声明，也可以在<code>control</code>外全局定义；</li>
<li>参数需要有类型与方向：有方向的参数来自数据面；没方向的参数来自控制面。有方向的参数的<code>action</code>可以直接调用。没有方向参数的<code>action</code>通常在table中被调用。</li>
<li>支持在<code>action</code>内部实例化变量；</li>
<li>支持标准的算术操作，如<code>-,+,*</code>(注意：无除与取模运算)，位运算<code>~, &amp;, |, ^, &gt;&gt;, &lt;&lt;</code>，比较运算<code>==, !=, &gt;, &gt;=, &lt;, &lt;=</code>。</li>
<li>支持非标准操作符：1）位切片，<code>[m:l]</code>; 2)自增运算，<code>++</code>。</li>
</ul>
<h2 id="table">table</h2>
<p><code>table</code>主要由<strong>key</strong>与<strong>actions</strong>两部分组成。
可选的，可以指定<code>table</code>其他属性，如:</p>
<ul>
<li><code>size</code>：表项大小</li>
<li><code>default_action = NoAction</code>：默认动作</li>
<li><code>const entries = {}</code>：</li>
</ul>
<p>示例：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span>table ipv4_lpm {
</span></span><span style="display:flex;"><span>    key = {
</span></span><span style="display:flex;"><span>        hdr.ipv4.srcAddr: ternary; 
</span></span><span style="display:flex;"><span>	    hdr.ipv4.dstAddr: ternary; 
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    actions = {
</span></span><span style="display:flex;"><span>        ipv4_forward;
</span></span><span style="display:flex;"><span>        drop;
</span></span><span style="display:flex;"><span>        NoAction;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    size = 1024;
</span></span><span style="display:flex;"><span>    default_action = NoAction();
</span></span><span style="display:flex;"><span>    <span style="color:#00f">const</span> enries = {
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>一个<code>table</code>的<strong>表项</strong>包含如下几部分：</p>
<ul>
<li>用于匹配的特定<code>key</code>；</li>
<li>当数据报匹配这个表项时，<strong>一个</strong><code>action</code>将被执行；</li>
<li>action data(可能为空)</li>
</ul>
<p><strong>match-action 处理流程</strong></p>
<p><img src="http://shanks.link/img/p4/image647.png" alt="image.png"></p>
<p>大致过程主要分为两部分：</p>
<ul>
<li>数据面P4程序：
<ul>
<li>定义<code>table</code>的格式，包括<code>key</code>字段、可能产生的所有<code>action</code>、<code>action data</code></li>
<li>根据header与metadata，执行表查找</li>
<li>根据匹配结果，执行相应的<code>action</code></li>
</ul>
</li>
<li>控制面
<ul>
<li>下发特定的流表项，下发流表的方法有：1）基于配置；2）基于自动发现；3）基于协议计算。</li>
</ul>
</li>
</ul>
<p><strong>标准的匹配种类</strong>有：exact，ternary, lpm, index, range, valid</p>
<h3 id="exact">exact</h3>
<p>精确匹配</p>
<h3 id="ternary">ternary</h3>
<p>基于三态内容寻址器的匹配，匹配表的每个表项都有一个掩码，将掩码和字段值进行逻辑与运算，再执行匹配。为了避免导致多条表项匹配成功，每条表项都需要设定一个优先级。对于每一个ternary字段，表项的值由两部分组成：value &amp;&amp;&amp; mask，先value后mask，顺序一定不能错！mask表示在这个字段上希望匹配哪些bits，1表示匹配，0表示忽略。若 <code>匹配字段 &amp; mask == value</code> 则匹配成功。例如：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#00f">const</span> entries = {
</span></span><span style="display:flex;"><span>    <span style="color:#f00;font-style:italic">// 该表项表示匹配那些ip src address前24位为10.0.1的数据包，而忽略了ip src 
</span></span></span><span style="display:flex;"><span><span style="color:#f00;font-style:italic"></span>    <span style="color:#f00;font-style:italic">// address的最后8位以及ip dst address
</span></span></span><span style="display:flex;"><span><span style="color:#f00;font-style:italic"></span>    (0x0a000100 &amp;&amp;&amp; 0xffffff00, 0x00000000 &amp;&amp;&amp; 0x00000000): your_action(0x66, 0x8888);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f00;font-style:italic">// 该表项表示匹配ip src address为10.0.2.x，且ip dst address为10.0.1.1的数据包
</span></span></span><span style="display:flex;"><span><span style="color:#f00;font-style:italic"></span>    <span style="color:#f00;font-style:italic">// 如果mask全为1，则可以省略mask而只写value
</span></span></span><span style="display:flex;"><span><span style="color:#f00;font-style:italic"></span>    (0x0a000200 &amp;&amp;&amp; 0xffffff00, 0x0a000101): your_action(0x11, 0x2222);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f00;font-style:italic">// 最后，由于是ternary匹配，一个数据包可能匹配多条表项，因而表项之间需要有优先级
</span></span></span><span style="display:flex;"><span><span style="color:#f00;font-style:italic"></span>    <span style="color:#f00;font-style:italic">// 以上述方式书写表项时，越早出现的表项优先级越高。
</span></span></span><span style="display:flex;"><span><span style="color:#f00;font-style:italic"></span>    <span style="color:#f00;font-style:italic">// 当使用控制器动态的加入表项时，应该显式指定插入表项的优先级以确保正确性。
</span></span></span><span style="display:flex;"><span><span style="color:#f00;font-style:italic"></span>}
</span></span></code></pre></div><p>当然，除了以const entries的形式写入表项，还可以通过P4 Controller 来写入。以下为如何构造一个新的表项（Python）</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>table_entry = p4info_helper.buildTableEntry(
</span></span><span style="display:flex;"><span>            table_name=<span style="color:#009c00">&#34;MyIngress.ipv4_ternary&#34;</span>,
</span></span><span style="display:flex;"><span>            match_fields={
</span></span><span style="display:flex;"><span>				<span style="color:#009c00">&#34;hdr.ipv4.srcAddr&#34;</span>: (0x0a000200, 0xffffff00), <span style="color:#f00;font-style:italic"># (value, mask)</span>
</span></span><span style="display:flex;"><span>				<span style="color:#009c00">&#34;hdr.ipv4.dstAddr&#34;</span>: (0x0b000100, 0xffffff00)
</span></span><span style="display:flex;"><span>			},
</span></span><span style="display:flex;"><span>            action_name=<span style="color:#009c00">&#34;MyIngress.your_action&#34;</span>,
</span></span><span style="display:flex;"><span>            action_params={
</span></span><span style="display:flex;"><span>				<span style="color:#009c00">&#34;param1&#34;</span>: 0x66,
</span></span><span style="display:flex;"><span>				<span style="color:#009c00">&#34;param2&#34;</span>: 0x1234
</span></span><span style="display:flex;"><span>			},
</span></span><span style="display:flex;"><span>            priority=1
</span></span><span style="display:flex;"><span>)
</span></span></code></pre></div><p>通过控制器写入表项时要注意一点，如果你不关心某个字段，应该直接在match_fields中直接不写该字段而不是将mask全设为0，这与const entries是不一样的。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>table_entry = p4info_helper.buildTableEntry(
</span></span><span style="display:flex;"><span>            table_name=<span style="color:#009c00">&#34;MyIngress.ipv4_ternary&#34;</span>,
</span></span><span style="display:flex;"><span>            match_fields={
</span></span><span style="display:flex;"><span>				<span style="color:#009c00">&#34;hdr.ipv4.srcAddr&#34;</span>: (0x0a000200, 0xffffff00)
</span></span><span style="display:flex;"><span>			},
</span></span><span style="display:flex;"><span>            action_name=<span style="color:#009c00">&#34;MyIngress.your_action&#34;</span>,
</span></span><span style="display:flex;"><span>            action_params={
</span></span><span style="display:flex;"><span>				<span style="color:#009c00">&#34;param1&#34;</span>: 0x66,
</span></span><span style="display:flex;"><span>				<span style="color:#009c00">&#34;param2&#34;</span>: 0x1234
</span></span><span style="display:flex;"><span>			},
</span></span><span style="display:flex;"><span>            priority=1
</span></span><span style="display:flex;"><span>)
</span></span></code></pre></div><h3 id="lpm">lpm</h3>
<p>lpm match: 最长前缀匹配，这是三重匹配的一种特殊情况，当多个表项匹配成功时，选择掩码最长的最为最高优先级进行匹配。</p>
<p>上述匹配方法定义在<code>core.p4</code>中：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#f00;font-style:italic">/* core.p4 */</span>
</span></span><span style="display:flex;"><span>match_kind {
</span></span><span style="display:flex;"><span>    exact,
</span></span><span style="display:flex;"><span>    ternary,
</span></span><span style="display:flex;"><span>    lpm
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><strong>v1model架构</strong>还支持<code>range与selector</code>匹配。</p>
<p>有些架构还支持<code>regexp与fuzzy</code>匹配。</p>
<h2 id="apply">apply</h2>
<p>在<code>apply</code>执行<code>action</code>，或将<code>table</code>应用。</p>
<p>示例：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span>control MyIngress(inout headers hdr,
</span></span><span style="display:flex;"><span>inout metadata meta,
</span></span><span style="display:flex;"><span>inout standard_metadata_t standard_metadata) {
</span></span><span style="display:flex;"><span>    table ipv4_lpm {
</span></span><span style="display:flex;"><span>        ...
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    action update() {
</span></span><span style="display:flex;"><span>        ...
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    apply {
</span></span><span style="display:flex;"><span>        ...
</span></span><span style="display:flex;"><span>        ipv4_lpm.apply();
</span></span><span style="display:flex;"><span>        update();
</span></span><span style="display:flex;"><span>        ...
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h1 id="deparser">deparser</h1>
<p><code>deparser</code> 将报头组装到数据报中，<strong>其不需要额外的新组建</strong>，使用<code>control</code>功能进行表示即可。</p>
<p>示例：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#f00;font-style:italic">/* From core.p4 */</span>
</span></span><span style="display:flex;"><span>extern packet_out {
</span></span><span style="display:flex;"><span>    <span style="color:#00f">void</span> emit&lt;T&gt;(<span style="color:#00f">in</span> T hdr);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f00;font-style:italic">/* User Program */</span>
</span></span><span style="display:flex;"><span>control DeparserImpl(packet_out packet,
</span></span><span style="display:flex;"><span>    <span style="color:#00f">in</span> headers hdr) {
</span></span><span style="display:flex;"><span>    apply {
</span></span><span style="display:flex;"><span>        ...
</span></span><span style="display:flex;"><span>        packet.emit(hdr.ethernet);
</span></span><span style="display:flex;"><span>        ...
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><code>deparser</code>的参数由两部分组成：</p>
<ul>
<li><code>packet_out</code>类型：其为定义在<code>core.p4</code>的<code>extern</code>类型。其<code>void emit&lt;T&gt;(in T hdr)</code>方法，将<code>hdr</code>组装到数据报中，并移动数据报指针。</li>
<li><code>hearders</code>: 用户定义的报头类型，方法为<code>in</code>。</li>
</ul>
<h1 id="表达式">表达式</h1>
<h2 id="集合运算">集合运算</h2>
<h3 id="通用集合">通用集合</h3>
<p>default 或者 <code>_</code> 表示通用集合，包含指定类型的所有可能。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span>select (hdr.ipv4.version) {
</span></span><span style="display:flex;"><span>    4: <span style="color:#00f">continue</span>;
</span></span><span style="display:flex;"><span>    _: reject;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="debug">debug</h2>
<h3 id="查看bmv-日志">查看bmv 日志</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span>/tmp/p4s.s1.log
</span></span><span style="display:flex;"><span>/tmp/p4s.s2.log
</span></span></code></pre></div><h3 id="使用debug流表">使用debug流表</h3>
<p>使用<code>table</code>读取<code>headers或metadata</code>信息。如：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span>control Myingress(...) {
</span></span><span style="display:flex;"><span>    table debug {
</span></span><span style="display:flex;"><span>        key = {
</span></span><span style="display:flex;"><span>            std_meta.egress_spec: exact;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        action = {}
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    apply {
</span></span><span style="display:flex;"><span>        debug.apply();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>打印结果如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span>•[15:16:48.145] [bmv2] [D]
</span></span><span style="display:flex;"><span>[thread 4090] [96.0] [cxt 0]
</span></span><span style="display:flex;"><span>Looking up key:
</span></span><span style="display:flex;"><span>* std_meta.egress_spec : 2
</span></span></code></pre></div><h1 id="常用技巧">常用技巧</h1>
<h2 id="分段ip识别">分段IP识别</h2>
<p>使用hdr.ipv4.frag_offset字段区分，如果为0，则解析，否则若数据报文分段，则不解析。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span>    state parse_ipv4_no_options {
</span></span><span style="display:flex;"><span>        ig_md.flags.ipv4_checksum_err = ipv4_checksum.verify();
</span></span><span style="display:flex;"><span>        transition select(hdr.ipv4.protocol, hdr.ipv4.frag_offset) {
</span></span><span style="display:flex;"><span>            (IP_PROTOCOLS_ICMP, 0) : parse_icmp;
</span></span><span style="display:flex;"><span>            (IP_PROTOCOLS_IGMP, 0) : parse_igmp;
</span></span><span style="display:flex;"><span>            (IP_PROTOCOLS_TCP, 0) : parse_tcp;
</span></span><span style="display:flex;"><span>            (IP_PROTOCOLS_UDP, 0) : parse_udp;
</span></span><span style="display:flex;"><span>            <span style="color:#f00;font-style:italic">// Do NOT parse the next header if IP packet is fragmented.
</span></span></span><span style="display:flex;"><span><span style="color:#f00;font-style:italic"></span>            <span style="color:#00f">default</span> : accept;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span></code></pre></div><h1 id="p4runtime">P4Runtime</h1>
<p>本节关注红框内的部分。</p>
<p><img src="http://shanks.link/img/p4/image648.png" alt="image.png"></p>
<h2 id="运行时控制方法比较">运行时控制方法比较</h2>
<ul>
<li>P4编译器自动生成的runtime APIs：依赖程序，很难在不重启控制面的情况下添加新的P4程序</li>
<li>BMv2 CLI：程序独立，但是目标依赖，控制面可移植性差</li>
<li>OpenFlow：目标独立，但依赖协议。openflow协议头与actions在协议规范中定义死了。</li>
<li>OCP Switch Abstraction Interface (SAI)：目标独立，但协议依赖。</li>
</ul>
<p>各运行时控制API优缺点总结如下：
<img src="http://shanks.link/img/p4/image649.png" alt="image.png"></p>
<p>可见，P4Runtime API可以做到目标与协议独立，那么，什么是P4Runtime？</p>
<ul>
<li>P4目标的运行控制框架，开源了API的服务端实现（https://github.com/p4lang/PI）</li>
<li>目前其草案v1.0已可以获得</li>
<li>基于Protocol buffers 的API：p4runtime proto, gRPC transport</li>
<li>P4程序独立：不用随着P4程序而改变</li>
<li>域可重配置：push 新P4程序时，无需重新编译目标交换机软件栈</li>
</ul>
<h2 id="protocol-buffers基础">Protocol Buffers基础</h2>
<p>Protocol Buffers，简称protobuf，是一种序列化数据结构的协议。</p>
<h2 id="grpc基础">gRPC基础</h2>
<p>gRPC是一个高性能、通用的开源 RPC 框架，其由 Google 主要面向移动应用开发并基于HTTP/2协议标准而设计，基于ProtoBuf(Protocol Buffers) 序列化协议开发，且支持众多开发语言。</p>
<h2 id="p4runtime-service">P4Runtime Service</h2>
<p>使本地或远程实体能够仲裁主控权，加载管道/程序，发送/接收数据包，以及读写转发表条目，计数器和其他P4实体。</p>
<h1 id="faqs">FAQs</h1>
<h2 id="werrortype-error-error-cast-cannot-unify-bit8-to-int16">[–Werror=type-error] error: cast: Cannot unify bit&lt;8&gt; to int&lt;16&gt;</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span>ig_md.ecmp_hash_int = (ecmp_hash_int_t) ig_md.ecmp_hash;
</span></span></code></pre></div><p><strong>解析</strong></p>
<p>Many arithmetic expressions that would be allowed in other languages are illegal in P4. To illustrate, consider the following declarations:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span>bit&lt;8&gt;  x;
</span></span><span style="display:flex;"><span>bit&lt;16&gt; y;
</span></span><span style="display:flex;"><span><span style="color:#00f">int</span>&lt;8&gt;  z;
</span></span></code></pre></div><p>The table below shows several expressions which are illegal because they do not obey the P4 typing rules. For each expression we provide several ways that the expression could be manually rewritten into a legal expression. Note that for some expression there are several legal alternatives, which may produce different results! The compiler cannot guess the user intent, so P4 requires the user to disambiguate.</p>
<p><img src="http://shanks.link/img/p4/image650.png" alt="image.png"></p>
<p><strong>解决办法：</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span>ig_md.ecmp_hash_int = (<span style="color:#00f">int</span>&lt;16&gt;)(bit&lt;16&gt;) ig_md.ecmp_hash;
</span></span></code></pre></div><h2 id="can-i-apply-a-table-multiple-time-in-my-p4-program">Can I apply a table multiple time in my P4 program?</h2>
<p>no (except via resubmit/recirculate)</p>
<h2 id="can-i-modify-table-entries-from-my-p4-program">Can I modify table entries from my P4 program?</h2>
<p>No(except for direct counters)</p>
<h2 id="what-happens-upon-reaching-the-reject-state-of-the-parser">What happens upon reaching the reject state of the parser?</h2>
<p>architecture dependent</p>
<h2 id="how-much-of-the-packet-can-i-parse">How much of the packet can I parse?</h2>
<p>architecture dependent</p>
<h2 id="一个流表可以配置多少个action多个action对性能是否有影响">一个流表可以配置多少个action，多个action对性能是否有影响？</h2>
<p>应该不会影响性能，一个流表为一个logic stage，多个stage连接为一个pipeline，stage越少，时延越低。
vlan id -&gt; vxlan id，写入metadata <strong>vpc级别</strong>
dst ip cidr -&gt; sg mac 作为 inner src mac <strong>vpc子网级别</strong>
dst ip -&gt; inner dst mac, outer dst ip，走系统路由，arp系统。 <strong>ip地址级别</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span>匹配 -&gt;
</span></span><span style="display:flex;"><span>转发
</span></span></code></pre></div><h2 id="怎么设计流表已节省流表项所占空间">怎么设计流表已节省流表项所占空间？</h2>
<p>下行</p>
<ul>
<li>标志位放哪？
vlan id -&gt; vxlan id，写入metadata <strong>vpc级别</strong>
dst ip cidr -&gt; sg mac 作为 inner src mac <strong>vpc子网级别</strong>
dst ip -&gt; inner dst mac, outer dst ip，走系统路由，arp系统 <strong>ip地址级别</strong></li>
</ul>
<p>上行</p>
<p>is_keeping 2
flow的包过来，若is_keeping为1或2，置is_keeping为2，将数据报转发给vRouter。vRouter收到包后，vlan转vxlan，发送到pod，途径ToR。</p>
<p>若发送探测消息，怎么构造识别？
在vlan包中加入特殊字段，回来的是vxlan id，且ip 可选字段中有特殊字段，则若is_keeping为2，则刷为1。再发一个探测包出去？
直接发探测包，一批一个？</p>
<p>全部下完后，再切
上次下的流表，is_keeping为0</p>
<p>怎么知道流表下完成，有个开关流表，下下去后，开始发送探测包，若is_keeping全为0，则将开关流表关闭。
若到了下轮下完表时间，还是没有切完成怎么办？那就先不切，下开关流表，关闭切流。下新流表后，从新开始切，不会乱序。</p>
<p>到了后，构造探测包，探测包有标志，是一个普通flow的vlan包。</p>
<p>1： 这次下的流表
下完后，</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span>st=&gt;start: 数据包进来
</span></span><span style="display:flex;"><span>not_probing=&gt;condition: probing_packet_filter,不是探测包？
</span></span><span style="display:flex;"><span>vlan2vxlan=&gt;condition: mapping_table,不能执行vlan与vxlan的转换？
</span></span><span style="display:flex;"><span>can_probe=&gt;condition: can_probe_table,是否可以发探测包？
</span></span><span style="display:flex;"><span>probing=&gt;operation: probing_table,发送探测包,
</span></span><span style="display:flex;"><span>若发送标志位为true，刷mapping_table,将发送标志位置为true。
</span></span><span style="display:flex;"><span>forward=&gt;operation: forward_table,将数据包转发到相应的计算节点
</span></span><span style="display:flex;"><span>ecmp_end=&gt;end: ecmp_table,使用ecmp算法将数据包转到相应vRouter
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>st-&gt;not_probing
</span></span><span style="display:flex;"><span>not_probing(yes)-&gt;vlan2vxlan(yes)-&gt;can_probe(yes)-&gt;probing-&gt;ecmp_end
</span></span><span style="display:flex;"><span>vlan2vxlan(no)-&gt;forward
</span></span><span style="display:flex;"><span>can_probe(no)-&gt;ecmp_end
</span></span><span style="display:flex;"><span>not_probing(no)-&gt;can_probe(yes)
</span></span></code></pre></div><h1 id="准备开发环境">准备开发环境</h1>
<p>从P4-developer-day或者腾讯云盘下载虚拟机镜像，通过virtualbox导入，生成虚拟机。</p>
<p>**更多内容关注微信公众号：nfvschool **</p>
<h1 id="参考">参考</h1>
<ul>
<li>P4语言基础与实战</li>
<li>P4语言编程详解</li>
<li>p4-16中对main的执行顺序是怎么样的？(V1Model, Tofino native, Portable Switch Architecture的讨论)</li>
<li>理论与实践2-快速上手</li>
<li>P4语言编程快速开始</li>
<li>P4 语言初识</li>
</ul>
<blockquote>
<p>本文通过chatgpt代理站（支持gpt4）：gptschools.cn整理</p></blockquote>
<p><strong>更多内容，请关注微信公众号： nfvschool</strong>
原文链接：www.nfvschool.cn</p>

    </div>
    <footer class="post-footer">
     
 
<div class="post-tags">     
     
    <a href="http://shanks.link/tags/p4" rel="tag" title="p4">#p4#</a>
    
</div>



     <div class="post-nav">
    <div class="post-nav-next post-nav-item">
    
        <a href="http://shanks.link/blog/2023/08/26/%E6%B4%9B%E5%B8%A6%E5%8F%A4%E9%95%87%E8%87%AA%E9%A9%BE%E6%B8%B8/" rel="next" title="洛带古镇自驾游">
        <i class="fa fa-chevron-left"></i> 洛带古镇自驾游
        </a>
    
    </div>

    <div class="post-nav-prev post-nav-item">
    
        <a href="http://shanks.link/blog/2023/08/25/bpf%E5%85%A5%E9%97%A8%E7%B3%BB%E5%88%97-11ebfp-%E5%92%8C-go-%E4%B9%8B%E5%88%9D%E6%8E%A2%E7%BC%96%E7%A8%8B/" rel="prev" title="【BPF入门系列-11】EBFP 和 GO 之初探编程">
        【BPF入门系列-11】EBFP 和 GO 之初探编程 <i class="fa fa-chevron-right"></i>
        </a>
    
    </div>
</div>
      
     
     
     





<script src="https://utteranc.es/client.js"
        repo="shankusu2017@gmail.com/"
        issue-term="pathname"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>
<noscript>Please enable JavaScript to view the <a href="https://github.com/utterance">comments powered by utterances.</a></noscript>

    </footer>
  </article>
</section>

          </div>
        </div>
        <div class="sidebar-toggle">
  <div class="sidebar-toggle-line-wrap">
    <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
    <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
    <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
  </div>
</div>
<aside id="sidebar" class="sidebar">
  <div class="sidebar-inner">

    <section class="site-overview sidebar-panel  sidebar-panel-active ">
      <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image"
        src="http://shanks.link/img/logo.jpg"
        alt="" />
    <p class="site-author-name" itemprop="name"></p>
    <p class="site-description motion-element" itemprop="description"> </p>
</div>
      <nav class="site-state motion-element">
    <div class="site-state-item site-state-posts">
        <a href="http://shanks.link/post/">
            <span class="site-state-item-name">日志</span>
        </a>
    </div>
    <div class="site-state-item site-state-categories">
        <a href="http://shanks.link/categories/">
            <span class="site-state-item-name">分类</span>
        </a>
    </div>

    <div class="site-state-item site-state-tags">
        <a href="http://shanks.link/tags/">
            <span class="site-state-item-name">标签</span>
        </a>
    </div>
</nav>

      
      
<div class="links-of-author motion-element">
    
        <span class="links-of-author-item">
        <a href="https://github.com/shankusu2017" target="_blank" title="GitHub">
            <i class="fa fa-fw fa-github"></i>
            GitHub
        </a>
        </span>
    
</div>


      

      <div class="links-of-blogroll motion-element inline">
<script type="text/javascript" src="//rf.revolvermaps.com/0/0/8.js?i=5b4f2ucxar6&amp;m=0&amp;s=220&amp;c=ff0000&amp;cr1=ffffff&amp;f=arial&amp;l=33&amp;bv=35" async="async"></script>
</div>

    </section>
    
  </div>
</aside>

      </div>
    </main>
   
    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  <span itemprop="copyrightYear">  &copy; 
  2009 - 2025</span>
</div>
<div>
  <a href="https://beian.miit.gov.cn/" rel="noopener" target="_blank">粤ICP备2021068940号-1</a>
  <a href="https://www.beian.gov.cn/portal/registerSystemInfo?recordcode=44011302003059" rel="noopener" target="_blank">粤公网安备44011302003059</a>
</div>


      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
      <span id="scrollpercent"><span>0</span>%</span>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>
<script type="text/javascript" src="http://shanks.link/js/vendor/jquery/index.js?v=2.1.3"></script>
<script type="text/javascript" src="http://shanks.link/js/vendor/fastclick/lib/fastclick.min.js?v=1.0.6"></script> 
<script type="text/javascript" src="http://shanks.link/js/vendor/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
<script type="text/javascript" src="http://shanks.link/js/vendor/velocity/velocity.min.js?v=1.2.1"></script>
<script type="text/javascript" src="http://shanks.link/js/vendor/velocity/velocity.ui.min.js?v=1.2.1"></script>
<script src="http://shanks.link/js/vendor/ua-parser-js/dist/ua-parser.min.js?v=0.7.9"></script>

<script src="http://shanks.link/js/vendor/fancybox/jquery.fancybox.pack.js?v=2.1.5"></script>

<script type="text/javascript" src="http://shanks.link/js/utils.js"></script>
<script type="text/javascript" src="http://shanks.link/js/motion.js"></script>
<script type="text/javascript" src="http://shanks.link/js/affix.js"></script>
<script type="text/javascript" src="http://shanks.link/js/schemes/pisces.js"></script>

<script type="text/javascript" src="http://shanks.link/js/scrollspy.js"></script>
<script type="text/javascript" src="http://shanks.link/js/post-details.js"></script>
<script type="text/javascript" src="http://shanks.link/js/toc.js"></script>

<script type="text/javascript" src="http://shanks.link/js/bootstrap.js"></script>

<script type="text/javascript" src="http://shanks.link/js/search.js"></script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX", "output/HTML-CSS"],
    tex2jax: {
      inlineMath: [ ['$','$'] ],
      displayMath: [ ['$$','$$'] ],
      processEscapes: true
    },
    "HTML-CSS": { fonts: ["TeX"] }
  });
</script>
<script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML' async></script>
</body>
</html>