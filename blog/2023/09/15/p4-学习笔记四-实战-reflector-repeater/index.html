<!DOCTYPE HTML>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" /> 
    <title>P4 学习笔记（四）- 实战 Reflector &amp; Repeater - Golang编程语言知识介绍</title>
    <meta name="keywords" content="git,Git,Lua,lua,Golang,go">
    
    <meta property="og:title" content="P4 学习笔记（四）- 实战 Reflector &amp; Repeater">
    <meta property="og:site_name" content="Golang编程语言知识介绍">
    <meta property="og:image" content="/img/author.jpg"> 
    <meta name="title" content="P4 学习笔记（四）- 实战 Reflector &amp; Repeater - Golang编程语言知识介绍" />
    <meta name="description" content="愿星光伴你左右"> 
    <link rel="shortcut icon" href="http://shanks.link/img/favicon.ico" />
    <link rel="apple-touch-icon" href="http://shanks.link/img/apple-touch-icon.png" />
    <link rel="apple-touch-icon-precomposed" href="http://shanks.link/img/apple-touch-icon.png" />
    <link href="http://shanks.link/js/vendor/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />
    <link href="http://shanks.link/js/vendor/fancybox/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />
    <link href="http://shanks.link/css/main.css" rel="stylesheet" type="text/css" />
    <link href="http://shanks.link/css/syntax.css" rel="stylesheet" type="text/css" />
    <script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post"},
     fancybox: true, 
    motion: true
  };
</script>
</head>
<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">
<div class="container one-collumn sidebar-position-left page-home  ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"> <div class="site-meta  custom-logo ">

  <div class="custom-logo-site-title">
    <a href="http://shanks.link/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">Golang编程语言知识介绍</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle"></p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
    <ul id="menu" class="menu">
      
      
        <li class="menu-item ">
          <a href="http://shanks.link/post/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />首页
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/thinking/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />随想录
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/%E7%94%9F%E6%B4%BB/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />生活
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/thinking/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />思考
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/os/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />OS
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/lua/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />lua
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/redis/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />redis
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/go/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />Golang
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/c/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />C
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/tcpip/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />TCP/IP
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/ebpf/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />ebpf
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/p4/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />p4
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/openvpn/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />OpenVPN
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/ipsec/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />IPSec
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/l2tp/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />L2TP
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/dns/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />DNS
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/web/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />web
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/openwrt/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />OpenWRT
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/%E8%BF%90%E7%BB%B4/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />运维
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/git/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />Git
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/%E9%B8%9F%E5%93%A5%E7%9A%84%E7%A7%81%E6%88%BF%E8%8F%9C/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />鸟哥的私房菜
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/it/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />IT杂谈
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/about/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />About Me
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/links/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />友情链接
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/ftp/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />FTP
          </a>
        </li>
      
      <li class="menu-item menu-item-search">
        <a href="javascript:;" class="popup-trigger"> <i class="menu-item-icon fa fa-search fa-fw"></i> <br /> 搜索</a>
      </li>
    </ul>
    <div class="site-search">
      <div class="popup">
 <span class="search-icon fa fa-search"></span>
 <input type="text" id="local-search-input">
 <div id="local-search-result"></div>
 <span class="popup-btn-close">close</span>
</div>

    </div>
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
<section id="posts" class="posts-expand">
  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <header class="post-header">
      <h1 class="post-title" itemprop="name headline">
        <a class="post-title-link" href="http://shanks.link/blog/2023/09/15/p4-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E5%9B%9B-%E5%AE%9E%E6%88%98-reflector-repeater/" itemprop="url">
        P4 学习笔记（四）- 实战 Reflector &amp; Repeater
        </a>
      </h1>
      <div class="post-meta">
      <span class="post-time">
<span class="post-meta-item-icon">
    <i class="fa fa-calendar-o"></i>
</span>
<span class="post-meta-item-text">时间：</span>
<time itemprop="dateCreated" datetime="2016-03-22T13:04:35+08:00" content="2023-09-15">
    2023-09-15
</time>
</span> 
      

  <span class="post-category" >
  &nbsp; | &nbsp;
  <span class="post-meta-item-icon">
    <i class="fa fa-folder-o"></i>
  </span>
  <span class="post-meta-item-text">分类：</span>
  
    <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
      <a href="http://shanks.link/categories/p4" itemprop="url" rel="index">
        <span itemprop="name">p4</span>
      </a>
      &nbsp; 
    </span>
  
</span>


       <span>
&nbsp; | &nbsp;
<span class="post-meta-item-icon">
    <i class="fa fa-eye"></i>
</span>
<span class="post-meta-item-text">阅读：</span>
<span class="leancloud-visitors-count">3648 字 ~8分钟</span>
</span>
      </div>
    </header>
    <div class="post-body" itemprop="articleBody">
    <p>为了能够更好的练习 P4 这门语言，这一篇文章我们一起配置一下环境，实战两个简单的练习项目。</p>
<h2 id="目录">目录</h2>
<ul>
<li>
<p><strong><a href="https://zhuanlan.zhihu.com/p/348919109/edit#env">环境配置</a></strong></p>
</li>
<li>
<p><strong><a href="https://zhuanlan.zhihu.com/p/348919109/edit#reflector">Packet Reflector</a></strong></p>
</li>
<li>
<ul>
<li><em><a href="https://zhuanlan.zhihu.com/p/348919109/edit#file">文件描述</a></em>
<ul>
<li><em><a href="https://zhuanlan.zhihu.com/p/348919109/edit#step">开发步骤</a></em></li>
<li><em><a href="https://zhuanlan.zhihu.com/p/348919109/edit#reflector-solution">解决方案</a></em></li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong><a href="https://zhuanlan.zhihu.com/p/348919109/edit#repeater">Packet Repeater</a></strong></p>
</li>
</ul>
<h2 id="环境配置">环境配置</h2>
<p>一个完整的 P4 开发环境里，我们需要编译 P4 的代码（用 p4c 编译[<a href="https://zhuanlan.zhihu.com/p/348919109#ref_1">1]</a>），把编译好的文件跑在软件交换机上（我们会用 bmv2[<a href="https://zhuanlan.zhihu.com/p/348919109#ref_2">2]</a>），在创建的虚拟网络拓扑结构中验证我们实现的逻辑是否是正确的。</p>
<p>所以我们需要的安装的工具依次有：</p>
<ul>
<li>编译器 <a href="https://link.zhihu.com/?target=https%3A//github.com/p4lang/p4c">p4c</a></li>
<li>软件交换机 <a href="https://link.zhihu.com/?target=https%3A//github.com/p4lang/behavioral-model">BEHAVIORAL MODEL (bmv2)</a></li>
<li>用于构建虚拟网络的 <a href="https://link.zhihu.com/?target=http%3A//mininet.org/">Mininet</a>[<a href="https://zhuanlan.zhihu.com/p/348919109#ref_3">3]</a></li>
<li>用来抓包的 <a href="https://link.zhihu.com/?target=https%3A//www.wireshark.org/">Wireshark</a></li>
<li>ETHz NSG 网络团队开发的用于高效开发的 <a href="https://link.zhihu.com/?target=https%3A//github.com/nsg-ethz/p4-utils">P4 utils</a>[<a href="https://zhuanlan.zhihu.com/p/348919109#ref_4">4]</a></li>
</ul>
<p>当然，安装这一堆文件还是会很痛苦的，所以 ETHz 的大佬们给大家提供了安装好所有需要的工具的虚拟机 ova 文件，可以在<a href="https://link.zhihu.com/?target=https%3A//drive.google.com/open%3Fid%3D1tubqk0PGIbX759tIzJGXqex08igFfzpD">这里</a>科学下载。下载好了就可以直接用 <a href="https://link.zhihu.com/?target=https%3A//www.virtualbox.org/wiki/Downloads">VirtualBox</a> 打开了！友情提醒，VirtualBox 记得安装 guest additions，这样会获得正确的分辨率，保护眼睛，从我做起。</p>
<p>环境配置好，我们就可以下载一下实战需要的源代码啦！我们用到的练习文件在这个 <a href="https://link.zhihu.com/?target=https%3A//github.com/nsg-ethz/p4-learning">P4-learning</a> 的 repository 里，在虚拟机里下载一份：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ git clone https://github.com/nsg-ethz/p4-learning.git
</code></pre></div><p>然后我们的练习就在其中的 <code>exercises</code> 文件夹里。</p>
<p>以下的练习都在虚拟机里实现的，如果大家决定自己安装所有的工具，请按照自己的配置进行调整。</p>
<h2 id="packet-reflector">Packet Reflector</h2>
<p>第一个练习很简单，我们在前一篇文章已经见过了它的代码实现，本质上其实就是把源地址和目标地址调换一下，再把 packet 从哪里来的就送回哪里去。但这个练习的主要目的，是为了让我们熟悉开发环境，包括如何建立一个虚拟的网络。</p>
<h3 id="文件描述">文件描述</h3>
<p>这个练习用到的文件有三个：</p>
<ul>
<li><code>p4app.json</code>：这个文件用来描述我们要建立的网络拓扑结构；</li>
<li><code>send_receive.py</code>：这段 python 脚本用于发送和接收 packets；</li>
<li><code>reflector.p4</code>：这个就是我们要完成的 P4 代码。</li>
</ul>
<p>首先我们看一下第一个 json 文件：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json">{
  &#34;program&#34;: <span style="color:#009c00">&#34;reflector.p4&#34;</span>,
  &#34;switch&#34;: <span style="color:#009c00">&#34;simple_switch&#34;</span>,
  &#34;compiler&#34;: <span style="color:#009c00">&#34;p4c&#34;</span>,
  &#34;options&#34;: <span style="color:#009c00">&#34;--target bmv2 --arch v1model --std p4-16&#34;</span>,
  &#34;switch_cli&#34;: <span style="color:#009c00">&#34;simple_switch_CLI&#34;</span>,
  &#34;cli&#34;: <span style="color:#00f">true</span>,
  &#34;pcap_dump&#34;: <span style="color:#00f">true</span>,
  &#34;enable_log&#34;: <span style="color:#00f">true</span>,
  ...
  &#34;topology&#34;: {
    &#34;assignment_strategy&#34;: <span style="color:#009c00">&#34;l2&#34;</span>,
    &#34;links&#34;: [[<span style="color:#009c00">&#34;h1&#34;</span>, <span style="color:#009c00">&#34;s1&#34;</span>]],
    &#34;hosts&#34;: {
      &#34;h1&#34;: {
      }
    },
    &#34;switches&#34;: {
      &#34;s1&#34;: {
      }
    }
  }
}
</code></pre></div><p>里面规定了使用 <code>p4c</code> 作为编译器，用 bmv2 的 v1model 作为目标架构，使用 P4 16 的语言标准等等，具体的用法可以参考 <a href="https://link.zhihu.com/?target=https%3A//github.com/nsg-ethz/p4-utils">p4 utils</a> 的官方文档。但其中拓扑结构的部分，也就是 <code>topology</code> 那一段，直接定义了我们的目标结构。</p>
<p>其中 <code>l2</code> 的 <code>assignment_strategy</code> 表示我们假设所有的交换机都在链路层（layer 2）工作，所有的 hosts 都会被放在同一个子网中。每个 host 的 ARP table 也会被自动填好它的所有邻居的 MAC 地址。除了 <code>l2</code>，还有 <code>mixed</code> 和 <code>l3</code> 两种选项。</p>
<p>使用 <code>mixed</code> 的时候，每个 host 只能和一个交换机相连，连接在同一个交换机上的 host 属于同一个 <code>/24</code> 子网中，这个交换机于是就作为了 host 的网络层网关（layer 3 gateway）。</p>
<p>使用 <code>l3</code> 的时候，每个交换机都在网络层（layer 3）工作，所以每个 interface 都属于一个独立的子网。至于具体的 IP 分配，可以参考 <a href="https://link.zhihu.com/?target=https%3A//github.com/nsg-ethz/p4-utils">p4 utils</a> 的官方文档。</p>
<p>第二个文件，<code>send_receive.py</code>，使用 <code>scapy</code> 这个库里的大部分函数，关于其中主要的步骤，在下面加了一些注释。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f00;font-style:italic">#!/usr/bin/env python</span>
<span style="color:#00f">import</span> sys
<span style="color:#00f">import</span> socket
<span style="color:#00f">import</span> random
<span style="color:#00f">import</span> time
<span style="color:#00f">from</span> threading <span style="color:#00f">import</span> Thread, Event
<span style="color:#00f">from</span> scapy.all <span style="color:#00f">import</span> *


<span style="color:#00f">class</span> <span style="color:#007575">Sniffer</span>(Thread):
    <span style="color:#009c00">&#39;&#39;&#39;
</span><span style="color:#009c00">    创建一个 Sniffer 的类，抓包
</span><span style="color:#009c00">    &#39;&#39;&#39;</span>
    <span style="color:#00f">def</span>  __init__(self, interface=<span style="color:#009c00">&#34;eth0&#34;</span>):
        
        super(Sniffer, self).__init__()

        self.interface = interface
        self.my_mac = get_if_hwaddr(interface)
        self.daemon = <span style="color:#00f">True</span>

        self.socket = <span style="color:#00f">None</span>
        self.stop_sniffer = Event() <span style="color:#f00;font-style:italic"># 创建一个停止抓包的 Event</span>

    <span style="color:#00f">def</span> <span style="color:#c34e00">isNotOutgoing</span>(self, pkt):
        <span style="color:#f00;font-style:italic"># 如果 packet 的源 MAC 地址不是</span>
        <span style="color:#00f">return</span> pkt[Ether].src != self.my_mac

    <span style="color:#00f">def</span> <span style="color:#c34e00">run</span>(self):
        <span style="color:#f00;font-style:italic"># 创建一个 Layer 2 的 socket，只保留 IP packet</span>
        self.socket = conf.L2listen(
            type=ETH_P_ALL,
            iface=self.interface,
            filter=<span style="color:#009c00">&#34;ip&#34;</span>
        )
        sniff(opened_socket=self.socket, prn=self.print_packet, lfilter=self.isNotOutgoing, stop_filter=self.should_stop_sniffer)

    <span style="color:#00f">def</span> <span style="color:#c34e00">join</span>(self, timeout=<span style="color:#00f">None</span>):
        <span style="color:#f00;font-style:italic"># 终止我们的 sniffer</span>
        self.stop_sniffer.set()
        super(Sniffer, self).join(timeout)

    <span style="color:#00f">def</span> <span style="color:#c34e00">should_stop_sniffer</span>(self, packet):
        <span style="color:#f00;font-style:italic"># 如果停止抓包的 Event 被设置了，就不再抓包</span>
        <span style="color:#00f">return</span> self.stop_sniffer.isSet()

    <span style="color:#00f">def</span> <span style="color:#c34e00">print_packet</span>(self, packet):
        print <span style="color:#009c00">&#34;[!] A packet was reflected from the switch: &#34;</span>
        <span style="color:#f00;font-style:italic">#packet.show()</span>
        ether_layer = packet.getlayer(Ether)
        print(<span style="color:#009c00">&#34;[!] Info: </span><span style="color:#009c00">{src}</span><span style="color:#009c00"> -&gt; </span><span style="color:#009c00">{dst}</span><span style="color:#009c00">\n</span><span style="color:#009c00">&#34;</span>.format(src=ether_layer.src, dst=ether_layer.dst))

<span style="color:#00f">def</span> <span style="color:#c34e00">get_if</span>():
    ifs=get_if_list()
    iface=<span style="color:#00f">None</span> <span style="color:#f00;font-style:italic"># &#34;h1-eth0&#34; 是我们的目标 interface，代表 host 1 上的 eth0</span>
    <span style="color:#00f">for</span> i in get_if_list():
        <span style="color:#00f">if</span> <span style="color:#009c00">&#34;eth0&#34;</span> in i:
            iface=i
            <span style="color:#00f">break</span>;
    <span style="color:#00f">if</span> not iface:
        print <span style="color:#009c00">&#34;Cannot find eth0 interface&#34;</span>
        exit(1)
    <span style="color:#00f">return</span> iface

<span style="color:#00f">def</span> <span style="color:#c34e00">send_packet</span>(iface, addr):
    <span style="color:#009c00">&#39;&#39;&#39;
</span><span style="color:#009c00">    构造一个 Ethernet + IP 的 packet
</span><span style="color:#009c00">    &#39;&#39;&#39;</span>
    raw_input(<span style="color:#009c00">&#34;Press the return key to send a packet:&#34;</span>)
    print <span style="color:#009c00">&#34;Sending on interface </span><span style="color:#009c00">%s</span><span style="color:#009c00"> to </span><span style="color:#009c00">%s</span><span style="color:#009c00">\n</span><span style="color:#009c00">&#34;</span> % (iface, str(addr))
    pkt =  Ether(src=get_if_hwaddr(iface), dst=<span style="color:#009c00">&#39;00:01:02:03:04:05&#39;</span>) <span style="color:#f00;font-style:italic"># 设置 Ethernet header</span>
    pkt = pkt /IP(dst=addr) <span style="color:#f00;font-style:italic"># 再加上 IP header</span>
    sendp(pkt, iface=iface, verbose=<span style="color:#00f">False</span>)

<span style="color:#00f">def</span> <span style="color:#c34e00">main</span>():

    <span style="color:#f00;font-style:italic"># 目标地址</span>
    addr = <span style="color:#009c00">&#34;10.0.0.2&#34;</span>
    addr = socket.gethostbyname(addr)
    iface = get_if() <span style="color:#f00;font-style:italic"># 获取当前的 interface</span>

    listener = Sniffer(iface)
    listener.start()
    time.sleep(0.1)

    <span style="color:#00f">try</span>:
        <span style="color:#00f">while</span> <span style="color:#00f">True</span>:
            <span style="color:#f00;font-style:italic"># 每半秒发送一个 packet</span>
            send_packet(iface, addr)
            time.sleep(0.5)

    <span style="color:#00f">except</span> KeyboardInterrupt:
        print(<span style="color:#009c00">&#34;[*] Stop sniffing&#34;</span>)
        listener.join(2.0)

        <span style="color:#00f">if</span> listener.isAlive():
            listener.socket.close()

<span style="color:#00f">if</span> __name__ == <span style="color:#009c00">&#39;__main__&#39;</span>:
    main()
</code></pre></div><p>第三个文件，<code>reflector.p4</code>，就是我们要修改的 P4 源码了。其中，所有的模块按照顺序，都排列在 main 函数里。这个练习里，我们要做的，是 Parser、Ingress、和 Deparser 部分。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#f00;font-style:italic">/*************************************************************************
</span><span style="color:#f00;font-style:italic">***********************  S W I T C H  *******************************
</span><span style="color:#f00;font-style:italic">*************************************************************************/</span>

V1Switch(
	MyParser(),           <span style="color:#f00;font-style:italic">// TODO
</span><span style="color:#f00;font-style:italic"></span>	MyVerifyChecksum(),
	MyIngress(),          <span style="color:#f00;font-style:italic">// TODO
</span><span style="color:#f00;font-style:italic"></span>	MyEgress(),
	MyComputeChecksum(),
	MyDeparser()          <span style="color:#f00;font-style:italic">// TODO
</span><span style="color:#f00;font-style:italic"></span>) main;
</code></pre></div><h3 id="开发步骤">开发步骤</h3>
<p>简单的看过了需要的文件之后，我们可以开始一步一步开始开发了。</p>
<p>第一步，把 <code>p4app.json</code> 里定义的网络拓扑跑起来，只需要在它所在的路径下跑：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ sudo p4run
</code></pre></div><p>这行命令会自动调用一个 python 脚本，解析 <code>p4app.json</code>，创建 mininet 的虚拟网络环境，编译 P4 代码，并安装在 bmv2 的软件交换机里。具体的流程感兴趣的话可以参考 <a href="https://link.zhihu.com/?target=https%3A//github.com/nsg-ethz/p4-utils">p4 utils</a> 的官方文档。</p>
<p>跑完之后，就有 mininet 的 CLI 了：</p>
<p><img src="http://shanks.link/img/p4/v2-2926f76d2e269510bf86ec7e409dd793_1440w.webp" alt="img"></p>
<p>Mininet CLI</p>
<p>比如我们可以看一下正在运行的网络拓扑，我们就知道有一个 host，一个 switch 分别记作 h1 和 s1，并且它们之间的 link 是联通的。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">mininet&gt; nodes
h1 s1
mininet&gt; links
h1-eth0&lt;-&gt;s1-eth1 (OK OK)
</code></pre></div><p>关于 mininet 的更多使用方法可以参考自带的 help：</p>
<p><img src="http://shanks.link/img/p4/v2-5c54bb3a22464c923187de27f605e311_1440w.webp" alt="img"></p>
<p>Mininet CLI Help</p>
<p>第二步，从 mininet 的 CLI 里，我们可以用 <code>xterm h1</code> 登陆 host h1，得到一个 shell 的界面。在这里，我们可以运行 <code>python send_receive.py</code> 从 h1 向 s1 发送 packet。但因为我们还没有改写 <code>reflector.p4</code> 这个文件，所以不会收到返回来的 packet：</p>
<p><img src="http://shanks.link/img/p4/v2-594475031721cbefa2ecafefd1080f3b_1440w.webp" alt="img"></p>
<p>接下来，我们看一下该怎么修改 <code>reflector.p4</code> 这个文件才能收到返回的 packet。</p>
<h3 id="解决方案">解决方案</h3>
<p>在第一个 TODO 的地方，我们要做的只是简单的解析 header：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#f00;font-style:italic">/* -*- P4_16 -*- */</span>
<span style="color:#f00;font-style:italic">#include</span> <span style="color:#f00;font-style:italic">&lt;core.p4&gt;</span><span style="color:#f00;font-style:italic">
</span><span style="color:#f00;font-style:italic">#include</span> <span style="color:#f00;font-style:italic">&lt;v1model.p4&gt;</span><span style="color:#f00;font-style:italic">
</span><span style="color:#f00;font-style:italic"></span>
<span style="color:#f00;font-style:italic">/*************************************************************************
</span><span style="color:#f00;font-style:italic">*********************** H E A D E R S  ***********************************
</span><span style="color:#f00;font-style:italic">*************************************************************************/</span>

<span style="color:#00f">typedef</span> bit&lt;48&gt; macAddr_t;
header ethernet_t {
    macAddr_t dstAddr;
    macAddr_t srcAddr;
    bit&lt;16&gt;   etherType;
}

<span style="color:#00f">struct</span> metadata {
    <span style="color:#f00;font-style:italic">/* empty */</span>
}

<span style="color:#00f">struct</span> headers {
    ethernet_t   ethernet;
}

<span style="color:#f00;font-style:italic">/*************************************************************************
</span><span style="color:#f00;font-style:italic">*********************** P A R S E R  ***********************************
</span><span style="color:#f00;font-style:italic">*************************************************************************/</span>

parser MyParser(packet_in packet,
                out headers hdr,
                inout metadata meta,
                inout standard_metadata_t standard_metadata) {

      state start{

          <span style="color:#f00;font-style:italic">/* TODO 1: parse ethernet header */</span>
          packet.extract(hdr.ethernet);  <span style="color:#f00;font-style:italic">// 使用 extract 就可以得到 ethernet header
</span><span style="color:#f00;font-style:italic"></span>          transition accept;
      }

}
</code></pre></div><p>第二个 TODO 的部分，也就是 Ingress，我们可以直接把交换地址的过程写在 apply 里：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#f00;font-style:italic">/*************************************************************************
</span><span style="color:#f00;font-style:italic">**************  I N G R E S S   P R O C E S S I N G   *******************
</span><span style="color:#f00;font-style:italic">*************************************************************************/</span>

control <span style="color:#c34e00">MyIngress</span>(inout headers hdr,
                  inout metadata meta,
                  inout standard_metadata_t standard_metadata) {

    apply {
       <span style="color:#f00;font-style:italic">/* TODO 2: swap mac addresses */</span>
       macAddr tmp = hdr.ethernet.dstAddr;
       hdr.ethernet.dstAddr = hdr.ethernet.srcAddr;
       hdr.ethernet.srcAddr = tmp;
       <span style="color:#f00;font-style:italic">/* TODO 3: set output port    */</span>
       standard_metadata.egress_spec = standard_metadata.ingress_port;
    }
}
</code></pre></div><p>也可以单独写一个 action 出来：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c">control <span style="color:#c34e00">MyIngress</span>(inout headers hdr,
                  inout metadata meta,
                  inout standard_metadata_t standard_metadata) {
    
    action swap_mac() {
      macAddr tmp = hdr.ethernet.dstAddr;
      hdr.ethernet.dstAddr = hdr.ethernet.srcAddr;
      hdr.ethernet.srcAddr = tmp;
    }

    apply {
       <span style="color:#f00;font-style:italic">/* TODO 2: swap mac addresses */</span>
       swap_mac();

       <span style="color:#f00;font-style:italic">/* TODO 3: set output port    */</span>
       standard_metadata.egress_spec = standard_metadata.ingress_port;
    }
}
</code></pre></div><p>第三个 TODO，类似上一篇讲 Deparser 的过程，不需要特殊的操作，只需要一个 <code>emit</code>：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#f00;font-style:italic">/*************************************************************************
</span><span style="color:#f00;font-style:italic">***********************  D E P A R S E R  *******************************
</span><span style="color:#f00;font-style:italic">*************************************************************************/</span>

control <span style="color:#c34e00">MyDeparser</span>(packet_out packet, in headers hdr) {
    apply {
        <span style="color:#f00;font-style:italic">/* TODO 4: deparse ethernet header */</span>
        packet.emit(hdr.ethernet);
	}
}
</code></pre></div><p>写完所有的 TODO 之后，我们就可以再次编译了。重新编译的时候，我们不需要关掉已经在运行的 mininet，只需要：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">mininet&gt; p4switch_reboot s1;
</code></pre></div><p>就可以直接加载新写的 P4 代码了，节约时间。</p>
<p>编译完成之后，我们再在 h1 上跑 <code>send_receive.py</code>，就能收到镜像回来的 packet 了：</p>
<p><img src="http://shanks.link/img/p4/v2-6fc0f5811ed9225e83dfa2ead0a272a6_1440w.webp" alt="img"></p>
<p>这个练习到这里就结束了。如果大家心满意足了，就可以在 CLI 里退出了，用 <code>quit</code> 或者 <code>exit</code> 或者 Ctrl-D。</p>
<h2 id="repeater">Repeater</h2>
<p>第二个练习，我们要实现的是一个简单的双端口交换机，能把 packet 在两个 hosts 之间进行传递。我们的网络拓扑结构如下图所示：</p>
<p><img src="http://shanks.link/img/p4/v2-6fc0f5811ed9225e83dfa2ead0a272a6_1440w.webp" alt="img"></p>
<p>Repeater Exercise: Topology</p>
<p>在配置文件 <code>p4app.json</code> 中，拓扑结构体现为：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json"><span style="color:#009c00">&#34;topology&#34;</span>: {
    &#34;assignment_strategy&#34;: <span style="color:#009c00">&#34;l2&#34;</span>,
    &#34;links&#34;: [
        [<span style="color:#009c00">&#34;h1&#34;</span>, <span style="color:#009c00">&#34;s1&#34;</span>],
        [<span style="color:#009c00">&#34;h2&#34;</span>, <span style="color:#009c00">&#34;s1&#34;</span>]
    ],
    &#34;hosts&#34;: {
        &#34;h1&#34;: {},
        &#34;h2&#34;: {}
    },
    &#34;switches&#34;: {
        &#34;s1&#34;: {}
    }
}
</code></pre></div><p>和上一个练习相比，这个结构多了一个 host h2，也多了一个 link。</p>
<p>我们的目标就是实现 h1 和 h2 之间能 ping 通。测试的时候在 mininet 的 cli 里直接用 <code>mininet&gt; h1 ping h2</code> 测试就好了。</p>
<p>为了实现这样一个 repeater，我们有两种解决方案，第一种解决方案，就是在 Ingress 的部分写一个静态的规则。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#f00;font-style:italic">// solution 1
</span><span style="color:#f00;font-style:italic"></span>control <span style="color:#c34e00">MyIngress</span>(inout headers hdr,
                  inout metadata meta,
                  inout standard_metadata_t standard_metadata) {

    apply {

        <span style="color:#f00;font-style:italic">// 如果入口是 1 号端口 =&gt; 从 2 号端口发出
</span><span style="color:#f00;font-style:italic"></span>        <span style="color:#00f">if</span> (standard_metadata.ingress_port == 1){
            standard_metadata.egress_spec = 2;
        }

        <span style="color:#f00;font-style:italic">// 如果入口是 2 号端口 =&gt; 从 1 号端口发出
</span><span style="color:#f00;font-style:italic"></span>        <span style="color:#00f">else</span> <span style="color:#00f">if</span> (standard_metadata.ingress_port == 2){
            standard_metadata.egress_spec = 1;
        }
    }
}
</code></pre></div><p>我们跑上 <code>sudo p4run</code> 之后，来到 mininet 的 CLI 之后，可以直接实验，ping 通就对了！</p>
<p><img src="http://shanks.link/img/p4/v2-866d691db579cb44de34aac97f2b6cd8_1440w.webp" alt="img"></p>
<p>Ping test</p>
<p>当然，除了 <code>ping</code>，我们还可以用 <code>iperf</code>，测一下 throughput：</p>
<p><img src="http://shanks.link/img/p4/v2-e57bc7e24af6e23a9294d91a9f5dba76_1440w.webp" alt="img"></p>
<p>Iperf test</p>
<p>练习里还提供了两段 python，一个是 <code>send.py</code>，一个是 <code>receive.py</code>，我们打开 h2 的终端，跑上 <code>python receive.py</code>，再打开一个 h1 的终端，跑上 <code>python send.py 10.0.0.2 &quot;[whatever message you want to send here]&quot;</code>，也可以验证：</p>
<p><img src="http://shanks.link/img/p4/v2-22ecdc25255283f4151e886c329db93f_1440w.webp" alt="img"></p>
<p>Python send-receive test</p>
<p>当然，除了第一种“静态”的解决方案，我们还有一个用<strong>表</strong>来解决的方法。</p>
<p>首先，我们在 <code>repeater.p4</code> 里的 Ingress 部分建一个表，就叫 repeater，只做最基本的 Match-Action：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c">control <span style="color:#c34e00">MyIngress</span>(inout headers hdr,
                  inout metadata meta,
                  inout standard_metadata_t standard_metadata) {

    <span style="color:#f00;font-style:italic">// 定义一个 action，确定出口端
</span><span style="color:#f00;font-style:italic"></span>    action forward(bit&lt;9&gt; egress_port){ <span style="color:#f00;font-style:italic">// 这里的参数是无方向的，因为是来查表得到的
</span><span style="color:#f00;font-style:italic"></span>        standard_metadata.egress_spec = egress_port;
    }

    table repeater {
        key = {
            standard_metadata.ingress_port: exact; <span style="color:#f00;font-style:italic">// 完全 match 才可以
</span><span style="color:#f00;font-style:italic"></span>        }
        actions = { <span style="color:#f00;font-style:italic">// 两种动作
</span><span style="color:#f00;font-style:italic"></span>            forward; <span style="color:#f00;font-style:italic">// 一定是之前已经声明的 action
</span><span style="color:#f00;font-style:italic"></span>            NoAction;
        }
        size = 2; <span style="color:#f00;font-style:italic">// 只需要两个端口的规则，所以表里只需要两个 entries
</span><span style="color:#f00;font-style:italic"></span>        default_action = NoAction;
    }

    apply {
        repeater.apply();
    }
}
</code></pre></div><p>有了这个代码，我们就相当于告诉了交换机，每次收到 packet 的时候，要去查表，再决定怎么转发。但到这里，我们的表还是空的。所以现在我们要在 repeater 的表里填上我们想要的规则。</p>
<p>第一步就是写一个简单的 txt 文件，比如叫 <code>s1-commands.txt</code>，里面写上：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">table_add repeater forward 1 =&gt; 2
table_add repeater forward 2 =&gt; 1
</code></pre></div><p>这两行就会在 repeater 这个表里，填好两行 Match-Action 的规则了。这两行的语法，就是在表里添加规则的语法：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">tabel_add &lt;table_name&gt; &lt;action_name&gt; &lt;match_fields&gt; =&gt; &lt;action_parameters&gt;
</code></pre></div><p>这里我们的 <code>table_name</code> 是 <code>repeater</code>，我们创建的 <code>action_name</code> 也就是那个“函数”就是 <code>forward</code>。更多关于这部分的语法可以参考<a href="https://link.zhihu.com/?target=https%3A//github.com/nsg-ethz/p4-learning/blob/master/documentation/control-plane.md">这个文档</a>。</p>
<p>写好了这个文件之后，只要最后在 <code>p4app.json</code> 的配置文件里，对我们的 switch把这个 txt 文件作为 <code>cli_input</code> 就好了：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json"><span style="color:#009c00">&#34;topology&#34;</span>: {
    &#34;assignment_strategy&#34;: <span style="color:#009c00">&#34;l2&#34;</span>,
    &#34;links&#34;: [
        [<span style="color:#009c00">&#34;h1&#34;</span>, <span style="color:#009c00">&#34;s1&#34;</span>],
        [<span style="color:#009c00">&#34;h2&#34;</span>, <span style="color:#009c00">&#34;s1&#34;</span>]
    ],
    &#34;hosts&#34;: {
        &#34;h1&#34;: {},
        &#34;h2&#34;: {}
    },
    &#34;switches&#34;: {
        &#34;s1&#34;: {
          &#34;cli_input&#34;: <span style="color:#009c00">&#34;s1-commands.txt&#34;</span>
        }
    }
}
</code></pre></div><p>这样，我们第二种方法也可以获得和第一种方法一样的效果。</p>
<h2 id="小结">小结</h2>
<p>这篇文章，我们正式开始了 P4 的实战部分，熟悉了实验需要的 virtualbox、p4utils、mininet 等环境和工具。前两个练习，相对简单，但帮助我们复习了 P4 的基础语法和架构，比如 Parser-&gt;Ingress-&gt;Egress-&gt;Deparser 的流水线、<code>standard_metadata</code> 包含的数据、 table 的定义和使用等等。</p>
<p>之后的文章会继续实战，上手更复杂一点的习题。</p>
<h2 id="参考">参考</h2>
<ol>
<li><a href="https://zhuanlan.zhihu.com/p/348919109#ref_1_0">^</a>P4 Reference Compiler <a href="https://github.com/p4lang/p4c">https://github.com/p4lang/p4c</a></li>
<li><a href="https://zhuanlan.zhihu.com/p/348919109#ref_2_0">^</a>Behavioral Model (bmv2) <a href="https://github.com/p4lang/behavioral-model">https://github.com/p4lang/behavioral-model</a></li>
<li><a href="https://zhuanlan.zhihu.com/p/348919109#ref_3_0">^</a>Mininet <a href="http://mininet.org/">http://mininet.org/</a></li>
<li><a href="https://zhuanlan.zhihu.com/p/348919109#ref_4_0">^</a>P4 Utils <a href="https://github.com/nsg-ethz/p4-utils">https://github.com/nsg-ethz/p4-utils</a></li>
</ol>
<ul>
<li><a href="https://zhuanlan.zhihu.com/p/348919109">相关内容转载自本链接</a></li>
</ul>

    </div>
    <footer class="post-footer">
     
 
<div class="post-tags">     
     
    <a href="http://shanks.link/tags/p4" rel="tag" title="p4">#p4#</a>
    
</div>



     <div class="post-nav">
    <div class="post-nav-next post-nav-item">
    
        <a href="http://shanks.link/blog/2023/09/15/p4-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E5%85%AD-%E5%AE%9E%E6%88%98%E7%BD%91%E7%BB%9C%E5%B1%82%E8%87%AA%E5%AE%9A%E4%B9%89%E6%8B%93%E6%89%91%E7%BB%93%E6%9E%84/" rel="next" title="P4 学习笔记（六）- 实战网络层，自定义拓扑结构">
        <i class="fa fa-chevron-left"></i> P4 学习笔记（六）- 实战网络层，自定义拓扑结构
        </a>
    
    </div>

    <div class="post-nav-prev post-nav-item">
    
        <a href="http://shanks.link/blog/2023/09/15/p4-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E4%B8%89-%E6%8E%A7%E5%88%B6%E9%80%BB%E8%BE%91%E4%B8%8E%E5%AE%8C%E6%95%B4%E7%9A%84%E5%B7%A5%E4%BD%9C%E6%B5%81/" rel="prev" title="P4 学习笔记（三）- 控制逻辑与完整的工作流">
        P4 学习笔记（三）- 控制逻辑与完整的工作流 <i class="fa fa-chevron-right"></i>
        </a>
    
    </div>
</div>
      
     
     
     





<script src="https://utteranc.es/client.js"
        repo="shankusu2017@gmail.com/"
        issue-term="pathname"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>
<noscript>Please enable JavaScript to view the <a href="https://github.com/utterance">comments powered by utterances.</a></noscript>

    </footer>
  </article>
</section>

          </div>
        </div>
        <div class="sidebar-toggle">
  <div class="sidebar-toggle-line-wrap">
    <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
    <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
    <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
  </div>
</div>
<aside id="sidebar" class="sidebar">
  <div class="sidebar-inner">

    <section class="site-overview sidebar-panel  sidebar-panel-active ">
      <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image"
        src="http://shanks.link/img/logo.jpg"
        alt="shankusu2017@gmail.com" />
    <p class="site-author-name" itemprop="name">shankusu2017@gmail.com</p>
    <p class="site-description motion-element" itemprop="description"> </p>
</div>
      <nav class="site-state motion-element">
    <div class="site-state-item site-state-posts">
        <a href="http://shanks.link/post/">
            <span class="site-state-item-name">日志</span>
        </a>
    </div>
    <div class="site-state-item site-state-categories">
        <a href="http://shanks.link/categories/">
            <span class="site-state-item-name">分类</span>
        </a>
    </div>

    <div class="site-state-item site-state-tags">
        <a href="http://shanks.link/tags/">
            <span class="site-state-item-name">标签</span>
        </a>
    </div>
</nav>

      
      
<div class="links-of-author motion-element">
    
        <span class="links-of-author-item">
        <a href="https://github.com/shankusu2017" target="_blank" title="GitHub">
            <i class="fa fa-fw fa-github"></i>
            GitHub
        </a>
        </span>
    
</div>


      

      <div class="links-of-blogroll motion-element inline">
<script type="text/javascript" src="//rf.revolvermaps.com/0/0/8.js?i=5b4f2ucxar6&amp;m=0&amp;s=220&amp;c=ff0000&amp;cr1=ffffff&amp;f=arial&amp;l=33&amp;bv=35" async="async"></script>
</div>

    </section>
    
  </div>
</aside>

      </div>
    </main>
   
    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  <span itemprop="copyrightYear">  &copy; 
  2009 - 2023</span>
</div>
<div>
  <a href="https://beian.miit.gov.cn/" rel="noopener" target="_blank">粤ICP备2021068940号-1</a>
  <a href="https://www.beian.gov.cn/portal/registerSystemInfo?recordcode=44011302003059" rel="noopener" target="_blank">粤公网安备44011302003059</a>
</div>


      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
      <span id="scrollpercent"><span>0</span>%</span>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>
<script type="text/javascript" src="http://shanks.link/js/vendor/jquery/index.js?v=2.1.3"></script>
<script type="text/javascript" src="http://shanks.link/js/vendor/fastclick/lib/fastclick.min.js?v=1.0.6"></script> 
<script type="text/javascript" src="http://shanks.link/js/vendor/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
<script type="text/javascript" src="http://shanks.link/js/vendor/velocity/velocity.min.js?v=1.2.1"></script>
<script type="text/javascript" src="http://shanks.link/js/vendor/velocity/velocity.ui.min.js?v=1.2.1"></script>
<script src="http://shanks.link/js/vendor/ua-parser-js/dist/ua-parser.min.js?v=0.7.9"></script>

<script src="http://shanks.link/js/vendor/fancybox/jquery.fancybox.pack.js?v=2.1.5"></script>

<script type="text/javascript" src="http://shanks.link/js/utils.js"></script>
<script type="text/javascript" src="http://shanks.link/js/motion.js"></script>
<script type="text/javascript" src="http://shanks.link/js/affix.js"></script>
<script type="text/javascript" src="http://shanks.link/js/schemes/pisces.js"></script>

<script type="text/javascript" src="http://shanks.link/js/scrollspy.js"></script>
<script type="text/javascript" src="http://shanks.link/js/post-details.js"></script>
<script type="text/javascript" src="http://shanks.link/js/toc.js"></script>

<script type="text/javascript" src="http://shanks.link/js/bootstrap.js"></script>

<script type="text/javascript" src="http://shanks.link/js/search.js"></script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX", "output/HTML-CSS"],
    tex2jax: {
      inlineMath: [ ['$','$'] ],
      displayMath: [ ['$$','$$'] ],
      processEscapes: true
    },
    "HTML-CSS": { fonts: ["TeX"] }
  });
</script>
<script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML' async></script>
</body>
</html>