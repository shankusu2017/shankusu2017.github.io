<!DOCTYPE HTML>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" /> 
    <title>P4 学习笔记（二）- 基础语法和 Parser - Golang入门指南</title>
    <meta name="keywords" content="Golang,golang,go,git,Git,Lua,lua">
    
    <meta property="og:title" content="P4 学习笔记（二）- 基础语法和 Parser">
    <meta property="og:site_name" content="Golang入门指南">
    <meta property="og:image" content="/img/author.jpg"> 
    <meta name="title" content="P4 学习笔记（二）- 基础语法和 Parser - Golang入门指南" />
    <meta name="description" content="愿星光伴你左右"> 
    <link rel="shortcut icon" href="http://shanks.link/img/favicon.ico" />
    <link rel="apple-touch-icon" href="http://shanks.link/img/apple-touch-icon.png" />
    <link rel="apple-touch-icon-precomposed" href="http://shanks.link/img/apple-touch-icon.png" />
    <link href="http://shanks.link/js/vendor/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />
    <link href="http://shanks.link/js/vendor/fancybox/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />
    <link href="http://shanks.link/css/main.css" rel="stylesheet" type="text/css" />
    <link href="http://shanks.link/css/syntax.css" rel="stylesheet" type="text/css" />
    <script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post"},
     fancybox: true, 
    motion: true
  };
</script>
</head>
<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">
<div class="container one-collumn sidebar-position-left page-home  ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"> <div class="site-meta  custom-logo ">

  <div class="custom-logo-site-title">
    <a href="http://shanks.link/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">Golang入门指南</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle"></p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
    <ul id="menu" class="menu">
      
      
        <li class="menu-item ">
          <a href="http://shanks.link/post/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />首页
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/todo/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />todo
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/thinking/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />思考
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/life/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />life
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/food/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />food
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/os/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />OS
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/lua/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />lua
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/redis/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />redis
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/go/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />Golang
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/c/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />C
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/tcpip/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />TCP/IP
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/ebpf/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />ebpf
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/p4/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />p4
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/openvpn/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />OpenVPN
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/ipsec/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />IPSec
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/l2tp/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />L2TP
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/dns/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />DNS
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/distributed/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />distributed
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/web/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />web
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/openwrt/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />OpenWRT
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/%E8%BF%90%E7%BB%B4/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />运维
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/git/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />Git
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/%E9%B8%9F%E5%93%A5%E7%9A%84%E7%A7%81%E6%88%BF%E8%8F%9C/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />鸟哥的私房菜
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/it/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />IT杂谈
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/finance/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />投资
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/about/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />About Me
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/links/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />友情链接
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/ftp/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />FTP
          </a>
        </li>
      
      <li class="menu-item menu-item-search">
        <a href="javascript:;" class="popup-trigger"> <i class="menu-item-icon fa fa-search fa-fw"></i> <br /> 搜索</a>
      </li>
    </ul>
    <div class="site-search">
      <div class="popup">
 <span class="search-icon fa fa-search"></span>
 <input type="text" id="local-search-input">
 <div id="local-search-result"></div>
 <span class="popup-btn-close">close</span>
</div>

    </div>
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
<section id="posts" class="posts-expand">
  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <header class="post-header">
      <h1 class="post-title" itemprop="name headline">
        <a class="post-title-link" href="http://shanks.link/blog/2023/09/15/p4-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E4%BA%8C-%E5%9F%BA%E7%A1%80%E8%AF%AD%E6%B3%95%E5%92%8C-parser/" itemprop="url">
        P4 学习笔记（二）- 基础语法和 Parser
        </a>
      </h1>
      <div class="post-meta">
      <span class="post-time">
<span class="post-meta-item-icon">
    <i class="fa fa-calendar-o"></i>
</span>
<span class="post-meta-item-text">时间：</span>
<time itemprop="dateCreated" datetime="2016-03-22T13:04:35+08:00" content="2023-09-15">
    2023-09-15
</time>
</span> 
      

  <span class="post-category" >
  &nbsp; | &nbsp;
  <span class="post-meta-item-icon">
    <i class="fa fa-folder-o"></i>
  </span>
  <span class="post-meta-item-text">分类：</span>
  
    <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
      <a href="http://shanks.link/categories/p4" itemprop="url" rel="index">
        <span itemprop="name">p4</span>
      </a>
      &nbsp; 
    </span>
  
</span>


       <span>
&nbsp; | &nbsp;
<span class="post-meta-item-icon">
    <i class="fa fa-eye"></i>
</span>
<span class="post-meta-item-text">阅读：</span>
<span class="leancloud-visitors-count">3393 字 ~7分钟</span>
</span>
      </div>
    </header>
    <div class="post-body" itemprop="articleBody">
    <ul>
<li>
<h2 id="oerview">Oerview</h2>
</li>
<li>
<p>这一篇文章，我们会从学习以下几个部分。</p>
</li>
<li>
<ul>
<li>P4 的基本数据类型
<ul>
<li>P4 的基本语法</li>
<li>Parser</li>
<li>小结</li>
</ul>
</li>
</ul>
</li>
<li>
<h2 id="p4-的基本数据类型">P4 的基本数据类型</h2>
</li>
<li>
<p>和很多静态的语言类似，P4 最基本的数据类型放在了下面，P4 不支持的数据类型有 float（浮点）和 string（字符串）。</p>
</li>
<li>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>  <span style="color:#00f">bool</span>        <span style="color:#f00;font-style:italic">// Boolean value
</span></span></span><span style="display:flex;"><span><span style="color:#f00;font-style:italic"></span>  bit&lt;W&gt;      <span style="color:#f00;font-style:italic">// Bit-string of width W
</span></span></span><span style="display:flex;"><span><span style="color:#f00;font-style:italic"></span>  <span style="color:#00f">int</span>&lt;W&gt;      <span style="color:#f00;font-style:italic">// Signed integer of width W
</span></span></span><span style="display:flex;"><span><span style="color:#f00;font-style:italic"></span>  varbit&lt;W&gt;   <span style="color:#f00;font-style:italic">// Bit-string of dynamic length &lt;= W
</span></span></span><span style="display:flex;"><span><span style="color:#f00;font-style:italic"></span>  match_kind  <span style="color:#f00;font-style:italic">// Describes ways to match table keys
</span></span></span><span style="display:flex;"><span><span style="color:#f00;font-style:italic"></span>  error       <span style="color:#f00;font-style:italic">// Used to signal errors
</span></span></span><span style="display:flex;"><span><span style="color:#f00;font-style:italic"></span>  <span style="color:#00f">void</span>        <span style="color:#f00;font-style:italic">// No values, used in few restricted circumstances
</span></span></span></code></pre></div></li>
<li>
<p>类似于 C 语言的 packed struct，P4 里也可以定义一个复杂的数据结构，称为 header，也就是对应我们 packet 的 header，比如一个最简单的 Ethernet header，可以定义成下面这样：</p>
</li>
<li>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>  header Ethernet_h {
</span></span><span style="display:flex;"><span>    bit&lt;48&gt; dstAddr;          <span style="color:#f00;font-style:italic">// Destination address
</span></span></span><span style="display:flex;"><span><span style="color:#f00;font-style:italic"></span>    bit&lt;48&gt; srcAddr;          <span style="color:#f00;font-style:italic">// Source address
</span></span></span><span style="display:flex;"><span><span style="color:#f00;font-style:italic"></span>    bit&lt;16&gt; etherType;        <span style="color:#f00;font-style:italic">// EtherType field
</span></span></span><span style="display:flex;"><span><span style="color:#f00;font-style:italic"></span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  Ethernet_h ethernetHeader;  <span style="color:#f00;font-style:italic">// Declaration
</span></span></span></code></pre></div></li>
<li>
<p>这个 P4 的 header 和 c 的 struct 有一个主要的区别，就是 header 还有一个隐藏的 field 叫做 validity。比如说我们收到了一个 packet，要把它的 Ethernet header 解析出来，就可以这么写：</p>
</li>
<li>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>  packet.<span style="color:#c34e00">extract</span>(ethernetHeader);
</span></span></code></pre></div></li>
<li>
<p>如果解析成功的话，validity 就会被自动设置为 true，等于自动帮我们确定 header 的格式是不是正确的。这一点，在这篇文章最后计算 checksum 的例子里会进一步解释。</p>
</li>
<li>
<p>当然，在有了 header 的基础上，我们还可以定义 header stack，比如对于 MPLS 来说我们可能有很多 label，就可以这样定义：</p>
</li>
<li>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>  header Mpls_h {
</span></span><span style="display:flex;"><span>    bit&lt;20&gt; label;
</span></span><span style="display:flex;"><span>    bit&lt;3&gt;  tc;
</span></span><span style="display:flex;"><span>    bit     bos;
</span></span><span style="display:flex;"><span>    bit&lt;8&gt;  ttl;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  Mpls_h[10] mols;    <span style="color:#f00;font-style:italic">// 一列 10 个 MPLS headers
</span></span></span></code></pre></div></li>
<li>
<p>同时也有 union 的格式，记作 header_union，比如 IP header 要么是 v4，要么是 v6，我们就可以这么定义：</p>
</li>
<li>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>  <span style="color:#f00;font-style:italic">// 只用其中的一种
</span></span></span><span style="display:flex;"><span><span style="color:#f00;font-style:italic"></span>  header_union IP_h {
</span></span><span style="display:flex;"><span>    IPv4_h v4;
</span></span><span style="display:flex;"><span>    IPv6_h v6;
</span></span><span style="display:flex;"><span>  } 
</span></span></code></pre></div></li>
<li>
<p>如果想要单纯的定义一个类似于 python 里的字典（dictionary）的数据结构的话，P4 提供了一个数据结构叫 struct。这里的命名会比较特别，为了防止混淆，还是要做一个区分：</p>
</li>
<li>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>  P4        |  对比
</span></span><span style="display:flex;"><span>  header    |  c 语言里的 packed <span style="color:#00f">struct</span>, 比如：<span style="color:#00f">struct</span> <span style="color:#c34e00">__attribute__</span>((__packed__)) mystruct {...};
</span></span><span style="display:flex;"><span>  <span style="color:#00f">struct</span>    |  python 里的 dictionary
</span></span></code></pre></div></li>
<li>
<p>P4 里面最常用的 struct 之一就是下面这个，用来改写每一个收到的 packet 要从哪一个 port 发出去：</p>
</li>
<li>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>  <span style="color:#f00;font-style:italic">// reference: https://github.com/p4lang/behavioral-model/blob/master/docs/simple_switch.md
</span></span></span><span style="display:flex;"><span><span style="color:#f00;font-style:italic"></span>  <span style="color:#00f">struct</span> <span style="color:#00f">standard_metadata_t</span> {
</span></span><span style="display:flex;"><span>    bit&lt;9&gt; ingress_port;   <span style="color:#f00;font-style:italic">// 收到 packet 的 port number，只读
</span></span></span><span style="display:flex;"><span><span style="color:#f00;font-style:italic"></span>    bit&lt;9&gt; egress_spec;    <span style="color:#f00;font-style:italic">// 准备发出 packet 的 port number，也可以设置成 drop
</span></span></span><span style="display:flex;"><span><span style="color:#f00;font-style:italic"></span>    bit&lt;9&gt; egress_port;    <span style="color:#f00;font-style:italic">// 准备发出 packet 的 port number, 只读
</span></span></span><span style="display:flex;"><span><span style="color:#f00;font-style:italic"></span>    ...
</span></span><span style="display:flex;"><span>  }
</span></span></code></pre></div></li>
<li>
<p>还有一些其他的数据类型，比如 tuple：</p>
</li>
<li>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>  tuple&lt;bit&lt;32&gt;, <span style="color:#00f">bool</span>&gt; x;
</span></span><span style="display:flex;"><span>  x = {10, false};
</span></span></code></pre></div></li>
<li>
<p>还有 enum（优先级从前到后由高到低）、typedef、extern、parser、control、package，之后有机会再在具体例子里面解释说明他们的用法（挖个坑…）。</p>
</li>
<li>
<h2 id="p4-的基本语法">P4 的基本语法</h2>
</li>
<li>
<p>P4 支持的操作类型如下：</p>
</li>
<li>
<ul>
<li>
<p>算术运算（arithmetic operations）：+, -, *</p>
<ul>
<li>
<p>逻辑运算（logical operations）：~, &amp;, |, ^, &raquo;, &laquo;</p>
</li>
<li>
<p>特殊运算（non-standard operations）：</p>
</li>
<li>
<ul>
<li>数列的切割（bit slicing）：[m;l]
<ul>
<li>比特的叠加（bit concatenation）：++</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>
<p>P4 不支持除法（division）和取余（modulo）运算，但是可以被近似（之后如果遇到了例子会说明，再挖个坑…）。</p>
</li>
<li>
<p>P4 对于变量（variables）和常量（constants）的声明和实例化和 c 语言基本一致，比如下面这个例子：</p>
</li>
<li>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>  <span style="color:#f00;font-style:italic">/* variable */</span>
</span></span><span style="display:flex;"><span>  bit&lt;8&gt; x = 123;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#00f">typedef</span> bit&lt;8&gt; MyType;
</span></span><span style="display:flex;"><span>  MyType x;
</span></span><span style="display:flex;"><span>  x = 123;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#f00;font-style:italic">/* constant */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#00f">const</span> bit&lt;8&gt; x = 123;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#00f">typedef</span> bit&lt;8&gt; MyType;
</span></span><span style="display:flex;"><span>  <span style="color:#00f">const</span> MyType x = 123;
</span></span></code></pre></div></li>
<li>
<p>这些变量只能用于暂时存储数据，不能用来记录状态，他们不是 stateful 的结构。比如一个 普通的 TCP 的 network flow，我们通常用它的 5-tuple（srcAddr, dstAddr, srcPort, distort, protocolNum）的 hash 计算它的 ID，然后就可以把这个 flow 的信息存起来，比如已经收到 SYN packet 了，或者已经三次握手结束了，用来跟踪这个 flow 的”状态“。</p>
</li>
<li>
<p>如果想要进行类似的 stateful 的操作，需要用到 tables 或者 extern objects，这两个数据结构我们之后再说（继续挖坑…）。</p>
</li>
<li>
<p>P4 的逻辑方面就很简单了，只有 if-else 和 switch 语句，且不能在解析（parser）的过程使用，只能在逻辑控制的部分使用，稍后我们会说到。基本的样子如下：</p>
</li>
<li>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>  <span style="color:#00f">if</span> (x == 123) {...} <span style="color:#00f">else</span> {...}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#00f">switch</span> (t.<span style="color:#c34e00">apply</span>().action_run) {
</span></span><span style="display:flex;"><span>    action1: {...}
</span></span><span style="display:flex;"><span>    action2: {...}
</span></span><span style="display:flex;"><span>  }
</span></span></code></pre></div></li>
<li>
<p>最后要说的就是 P4 支持两个等级的终止命令，一个是 return，一个是 exit，和 python 一样，return 就终止当前运行的部分，exit 则终止所有运行的模块。</p>
</li>
<li>
<h2 id="parser">Parser</h2>
</li>
<li>
<p>看了这么多语法，是时候结合 P4 具体的实现方式举个例子了。借着这个例子，我们来顺便说一下 P4 的 workflow 中第一部分—— Parser。</p>
</li>
<li>
<p><img src="http://shanks.link/img/p4/v2-1a1357c0619a11b0c2bbb6bde3b9df76_1440w.webp" alt="img"></p>
</li>
<li>
<p>P4 的工作流</p>
</li>
<li>
<p>Parser 的角色很重要，但也很简单，就是把一个网络包 headers 里面的信息都解析出来。就像下面这幅图中，一个 packet 可能有很多层 header 包含了不同的信息，Layer-2 的 MAC 地址信息、Layer-3 的 IP 地址信息、Layer-4 的 Port 信息等等。Parser 的任务，就是把这些信息都解析出来，存储为 P4 能理解的数据结构，比如我们之前讲的 struct 和 header。 而 P4 的实现方式，就是靠<strong>状态机</strong>。</p>
</li>
<li>
<p><img src="http://shanks.link/img/p4/v2-ed6950c233500144c6bbc81f69b3792e_1440w.webp" alt="img"></p>
</li>
<li>
<p>我们看下面一段关于 Source Routing (SR，注意这个 SR 不是 Segment Routing[<a href="https://zhuanlan.zhihu.com/p/346936899#ref_1">1]</a> 的 SR，虽然大同小异) header 解析部分的代码。SR 一个简单的例子就是，我们想要把一个 packet 从下面这一幅图中的蓝色的路径从左边发到右边，为了做到这一点，我们在 packet 的头部加四个 header，到了第一个 switch 的时候我们把最上面那个 header 拿下来，并且走里面写好的 port 1，从 port 1 到达第二个 switch 的时候，我们再把现在最上面那个 header （也就是图里第二个 header）拿下来，然后从里面写的 port 1 出发，到第三个 switch，以此类推，到了最后一个 switch 的时候，packet 只剩下最后一个 header 了，我们再给拿下来，然后从 header 里写好的 port 2 转发到我们的目的地，这个时候，packet 就不剩 header 了。</p>
</li>
<li>
<p><img src="http://shanks.link/img/p4/v2-932d9d0ee4fe90903feb4cd32626b46e_1440w.webp" alt="img"></p>
</li>
<li>
<p>实现解析这样的 header 的代码，就像下面这样写：</p>
</li>
<li>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>  <span style="color:#f00;font-style:italic">// source routing 的 header 结构
</span></span></span><span style="display:flex;"><span><span style="color:#f00;font-style:italic"></span>  header <span style="color:#00f">srcRoute_t</span> {
</span></span><span style="display:flex;"><span>    bit&lt;1&gt;  bos;
</span></span><span style="display:flex;"><span>    bit&lt;15&gt; port;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#f00;font-style:italic">// 定义所有 header 的结构
</span></span></span><span style="display:flex;"><span><span style="color:#f00;font-style:italic"></span>  <span style="color:#00f">struct</span> headers {
</span></span><span style="display:flex;"><span>    <span style="color:#00f">ethernet_t</span>           ethernet;  
</span></span><span style="display:flex;"><span>    <span style="color:#00f">srcRoute_t</span>[MAX_HOPS] srcRoutes;
</span></span><span style="display:flex;"><span>    <span style="color:#00f">ipv4_t</span>               ipv4;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  parser <span style="color:#c34e00">MyParser</span>(...) {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    state start {
</span></span><span style="display:flex;"><span>      transition parse_ethernet;  <span style="color:#f00;font-style:italic">// 0: 直接跳转到 parse_ethernet
</span></span></span><span style="display:flex;"><span><span style="color:#f00;font-style:italic"></span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    state parse_ethernet {
</span></span><span style="display:flex;"><span>      packet.<span style="color:#c34e00">extract</span>(hdr.ethernet);
</span></span><span style="display:flex;"><span>      transition <span style="color:#c34e00">select</span>(hdr.ethernet.etherType) {  <span style="color:#f00;font-style:italic">// 1: 下一个跳转的分支取决于 EtherType 的值
</span></span></span><span style="display:flex;"><span><span style="color:#f00;font-style:italic"></span>        TYPE_SRCROUTING: parse_srcRouting;
</span></span><span style="display:flex;"><span>        0x800: parse_ipv4;
</span></span><span style="display:flex;"><span>        <span style="color:#00f">default</span>: accept;
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    state parse_srcRouting {
</span></span><span style="display:flex;"><span>      packet.<span style="color:#c34e00">extract</span>(hdr.srcRoutes.next);
</span></span><span style="display:flex;"><span>      transition <span style="color:#c34e00">select</span>(hdr.srcRoutes.last.bos) {
</span></span><span style="display:flex;"><span>        1: parse_ipv4;              <span style="color:#f00;font-style:italic">// 如果是最后一个 source routing 的 header，去解析 ipv4
</span></span></span><span style="display:flex;"><span><span style="color:#f00;font-style:italic"></span>        <span style="color:#00f">default</span>: parse_srcRouting;  <span style="color:#f00;font-style:italic">// 否则继续解析 source routing 的下一个 header
</span></span></span><span style="display:flex;"><span><span style="color:#f00;font-style:italic"></span>      }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    state parse_ipv4 {
</span></span><span style="display:flex;"><span>      packet.<span style="color:#c34e00">extract</span>(hdr.ipv4);
</span></span><span style="display:flex;"><span>      transition <span style="color:#c34e00">select</span>(hdr.ipv4.protocol) {
</span></span><span style="display:flex;"><span>        6: parse_tcp;
</span></span><span style="display:flex;"><span>        17: parse_udp;
</span></span><span style="display:flex;"><span>        <span style="color:#00f">default</span>: accept;
</span></span><span style="display:flex;"><span>      } 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    state parse_tcp {
</span></span><span style="display:flex;"><span>      packet.<span style="color:#c34e00">extract</span>(hdr.tcp);
</span></span><span style="display:flex;"><span>      transition: accept;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    state parse_udp {
</span></span><span style="display:flex;"><span>      packet.<span style="color:#c34e00">extract</span>(hdr.udp);
</span></span><span style="display:flex;"><span>      transition accept;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  }
</span></span></code></pre></div></li>
<li>
<p>这部分代码相对来说应该比较容易理解，实现的其实就是一个下面这个状态机：</p>
</li>
<li>
<p><img src="http://shanks.link/img/p4/v2-2c2b3c9a7057fbc06c414f4e6b2c7e61_1440w.webp" alt="img"></p>
</li>
<li>
<p>从 start 这个 state 开始，第一步先去解析 Ethernet 的 header（即 parse_ethernet）。如果 EtherType 对应的值是 0x800（也就是 IPv4 对应的值），那么我们就知道这个 packet 是个 IP packet，下一步跳转到解析 IPv4 的状态（即 parse_ipv4），否则就直接接受这个 packet。对于 IP packet，相似的，如果 header 里面的 protocol 对应是 TCP，就继续跳转到解析 TCP 的状态（即 parse*_*tcp），当然 UDP 也一样。如果 EtherType 对应的是 source routing 的值（我们定义一个 TYPE_SRCROUTING）的话，那就先跳转到解析 source routing 的状态（即 parse_srcRouting），这个状态里，可能会停留在原地不动，直到我们解析了最后一个 source routing 的 header，然后再跳转到 IPv4 的状态。一个简单的 Parser 实例如下：</p>
</li>
<li>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>  header IPv4_no_options_h {
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>    bit&lt;32&gt; srcAddr;           <span style="color:#f00;font-style:italic">// 固定长度
</span></span></span><span style="display:flex;"><span><span style="color:#f00;font-style:italic"></span>    bit&lt;32&gt; dstAddr;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  header IPv4_options_h {
</span></span><span style="display:flex;"><span>    varbit&lt;320&gt; options;       <span style="color:#f00;font-style:italic">// 可变长度
</span></span></span><span style="display:flex;"><span><span style="color:#f00;font-style:italic"></span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  ...
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  parser <span style="color:#c34e00">MyParser</span>(...) {
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>    state parse_ipv4 {
</span></span><span style="display:flex;"><span>      packet.<span style="color:#c34e00">extract</span>(headers.ipv4);
</span></span><span style="display:flex;"><span>      transition <span style="color:#c34e00">select</span> (headers.ipv4.ihl) {  
</span></span><span style="display:flex;"><span>        5: dispatch_on_protocol;     <span style="color:#f00;font-style:italic">// 如果 ihl==5，那么没有 options，直接按照对应的 protocol 解析
</span></span></span><span style="display:flex;"><span><span style="color:#f00;font-style:italic"></span>        <span style="color:#00f">default</span>: parse_ipv4_options; <span style="color:#f00;font-style:italic">// 否则解析 options
</span></span></span><span style="display:flex;"><span><span style="color:#f00;font-style:italic"></span>      }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    state parse_ipv4_options {
</span></span><span style="display:flex;"><span>      packet.<span style="color:#c34e00">extract</span>(headers.ipv4options, (headers.ipv4.ihl - 5) &lt;&lt; 2); <span style="color:#f00;font-style:italic">// ihl 决定了 options 的长度
</span></span></span><span style="display:flex;"><span><span style="color:#f00;font-style:italic"></span>      transition dispatch_on_protocol;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span></code></pre></div></li>
<li>
<p>另外值得一提的是，这个 Parser 的部分是 P4 里唯一一个可能的循环操作，别的地方 P4 都没有支持循环的操作。一个需要循环的例子就是 TCP options 的解析，比如下面这一段代码实现：</p>
</li>
<li>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>  parser <span style="color:#c34e00">Tcp_option_parser</span>(packet_in b,
</span></span><span style="display:flex;"><span>                           in bit&lt;4&gt; tcp_hdr_data_offset,
</span></span><span style="display:flex;"><span>                           out Tcp_option_stack vec,
</span></span><span style="display:flex;"><span>                           out Tcp_option_padding_h padding)
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>      bit&lt;7&gt; tcp_hdr_bytes_left;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      state start {
</span></span><span style="display:flex;"><span>          <span style="color:#f00;font-style:italic">// RFC 793 - the Data Offset field is the length of the TCP
</span></span></span><span style="display:flex;"><span><span style="color:#f00;font-style:italic"></span>          <span style="color:#f00;font-style:italic">// header in units of 32-bit words.  It must be at least 5 for
</span></span></span><span style="display:flex;"><span><span style="color:#f00;font-style:italic"></span>          <span style="color:#f00;font-style:italic">// the minimum length TCP header, and since it is 4 bits in
</span></span></span><span style="display:flex;"><span><span style="color:#f00;font-style:italic"></span>          <span style="color:#f00;font-style:italic">// size, can be at most 15, for a maximum TCP header length of
</span></span></span><span style="display:flex;"><span><span style="color:#f00;font-style:italic"></span>          <span style="color:#f00;font-style:italic">// 15*4 = 60 bytes.
</span></span></span><span style="display:flex;"><span><span style="color:#f00;font-style:italic"></span>          <span style="color:#c34e00">verify</span>(tcp_hdr_data_offset &gt;= 5, error.TcpDataOffsetTooSmall);
</span></span><span style="display:flex;"><span>          tcp_hdr_bytes_left = 4 * (bit&lt;7&gt;) (tcp_hdr_data_offset - 5);
</span></span><span style="display:flex;"><span>          <span style="color:#f00;font-style:italic">// always true here: 0 &lt;= tcp_hdr_bytes_left &lt;= 40
</span></span></span><span style="display:flex;"><span><span style="color:#f00;font-style:italic"></span>          transition next_option;
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      state next_option {
</span></span><span style="display:flex;"><span>          transition <span style="color:#c34e00">select</span>(tcp_hdr_bytes_left) {
</span></span><span style="display:flex;"><span>              0 : accept;  <span style="color:#f00;font-style:italic">// no TCP header bytes left
</span></span></span><span style="display:flex;"><span><span style="color:#f00;font-style:italic"></span>              <span style="color:#00f">default</span> : next_option_part2;
</span></span><span style="display:flex;"><span>          }
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      state next_option_part2 {
</span></span><span style="display:flex;"><span>          <span style="color:#f00;font-style:italic">// precondition: tcp_hdr_bytes_left &gt;= 1
</span></span></span><span style="display:flex;"><span><span style="color:#f00;font-style:italic"></span>          transition <span style="color:#c34e00">select</span>(b.lookahead&lt;bit&lt;8&gt;&gt;()) {
</span></span><span style="display:flex;"><span>              0: parse_tcp_option_end;
</span></span><span style="display:flex;"><span>              1: parse_tcp_option_nop;
</span></span><span style="display:flex;"><span>              2: parse_tcp_option_ss;
</span></span><span style="display:flex;"><span>              3: parse_tcp_option_s;
</span></span><span style="display:flex;"><span>              5: parse_tcp_option_sack;
</span></span><span style="display:flex;"><span>          }
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      state parse_tcp_option_end {
</span></span><span style="display:flex;"><span>          b.<span style="color:#c34e00">extract</span>(vec.next.end);
</span></span><span style="display:flex;"><span>          <span style="color:#f00;font-style:italic">// TBD: This code is an example demonstrating why it would be
</span></span></span><span style="display:flex;"><span><span style="color:#f00;font-style:italic"></span>          <span style="color:#f00;font-style:italic">// useful to have sizeof(vec.next.end) instead of having to
</span></span></span><span style="display:flex;"><span><span style="color:#f00;font-style:italic"></span>          <span style="color:#f00;font-style:italic">// put in a hard-coded length for each TCP option.
</span></span></span><span style="display:flex;"><span><span style="color:#f00;font-style:italic"></span>          tcp_hdr_bytes_left = tcp_hdr_bytes_left - 1;
</span></span><span style="display:flex;"><span>          transition consume_remaining_tcp_hdr_and_accept;
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      state consume_remaining_tcp_hdr_and_accept {
</span></span><span style="display:flex;"><span>          <span style="color:#f00;font-style:italic">// A more picky sub-parser implementation would verify that
</span></span></span><span style="display:flex;"><span><span style="color:#f00;font-style:italic"></span>          <span style="color:#f00;font-style:italic">// all of the remaining bytes are 0, as specified in RFC 793,
</span></span></span><span style="display:flex;"><span><span style="color:#f00;font-style:italic"></span>          <span style="color:#f00;font-style:italic">// setting an error and rejecting if not.  This one skips past
</span></span></span><span style="display:flex;"><span><span style="color:#f00;font-style:italic"></span>          <span style="color:#f00;font-style:italic">// the rest of the TCP header without checking this.
</span></span></span><span style="display:flex;"><span><span style="color:#f00;font-style:italic"></span>
</span></span><span style="display:flex;"><span>          <span style="color:#f00;font-style:italic">// tcp_hdr_bytes_left might be as large as 40, so multiplying
</span></span></span><span style="display:flex;"><span><span style="color:#f00;font-style:italic"></span>          <span style="color:#f00;font-style:italic">// it by 8 it may be up to 320, which requires 9 bits to avoid
</span></span></span><span style="display:flex;"><span><span style="color:#f00;font-style:italic"></span>          <span style="color:#f00;font-style:italic">// losing any information.
</span></span></span><span style="display:flex;"><span><span style="color:#f00;font-style:italic"></span>          b.<span style="color:#c34e00">extract</span>(padding, (bit&lt;32&gt;) (8 * (bit&lt;9&gt;) tcp_hdr_bytes_left));
</span></span><span style="display:flex;"><span>          transition accept;
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      state parse_tcp_option_nop {
</span></span><span style="display:flex;"><span>          b.<span style="color:#c34e00">extract</span>(vec.next.nop);
</span></span><span style="display:flex;"><span>          tcp_hdr_bytes_left = tcp_hdr_bytes_left - 1;
</span></span><span style="display:flex;"><span>          transition next_option;
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      state parse_tcp_option_ss {
</span></span><span style="display:flex;"><span>          <span style="color:#c34e00">verify</span>(tcp_hdr_bytes_left &gt;= 5, error.TcpOptionTooLongForHeader);
</span></span><span style="display:flex;"><span>          tcp_hdr_bytes_left = tcp_hdr_bytes_left - 5;
</span></span><span style="display:flex;"><span>          b.<span style="color:#c34e00">extract</span>(vec.next.ss);
</span></span><span style="display:flex;"><span>          transition next_option;
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      state parse_tcp_option_s {
</span></span><span style="display:flex;"><span>          <span style="color:#c34e00">verify</span>(tcp_hdr_bytes_left &gt;= 4, error.TcpOptionTooLongForHeader);
</span></span><span style="display:flex;"><span>          tcp_hdr_bytes_left = tcp_hdr_bytes_left - 4;
</span></span><span style="display:flex;"><span>          b.<span style="color:#c34e00">extract</span>(vec.next.s);
</span></span><span style="display:flex;"><span>          transition next_option;
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      state parse_tcp_option_sack {
</span></span><span style="display:flex;"><span>          bit&lt;8&gt; n_sack_bytes = b.lookahead&lt;Tcp_option_sack_top&gt;().length;
</span></span><span style="display:flex;"><span>          <span style="color:#f00;font-style:italic">// I do not have global knowledge of all TCP SACK
</span></span></span><span style="display:flex;"><span><span style="color:#f00;font-style:italic"></span>          <span style="color:#f00;font-style:italic">// implementations, but from reading the RFC, it appears that
</span></span></span><span style="display:flex;"><span><span style="color:#f00;font-style:italic"></span>          <span style="color:#f00;font-style:italic">// the only SACK option lengths that are legal are 2+8*n for
</span></span></span><span style="display:flex;"><span><span style="color:#f00;font-style:italic"></span>          <span style="color:#f00;font-style:italic">// n=1, 2, 3, or 4, so set an error if anything else is seen.
</span></span></span><span style="display:flex;"><span><span style="color:#f00;font-style:italic"></span>          <span style="color:#c34e00">verify</span>(n_sack_bytes == 10 || n_sack_bytes == 18 ||
</span></span><span style="display:flex;"><span>                 n_sack_bytes == 26 || n_sack_bytes == 34,
</span></span><span style="display:flex;"><span>                 error.TcpBadSackOptionLength);
</span></span><span style="display:flex;"><span>          <span style="color:#c34e00">verify</span>(tcp_hdr_bytes_left &gt;= (bit&lt;7&gt;) n_sack_bytes,
</span></span><span style="display:flex;"><span>                 error.TcpOptionTooLongForHeader);
</span></span><span style="display:flex;"><span>          tcp_hdr_bytes_left = tcp_hdr_bytes_left - (bit&lt;7&gt;) n_sack_bytes;
</span></span><span style="display:flex;"><span>          b.<span style="color:#c34e00">extract</span>(vec.next.sack, (bit&lt;32&gt;) (8 * n_sack_bytes - 16));
</span></span><span style="display:flex;"><span>          transition next_option;
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>  }
</span></span></code></pre></div></li>
<li>
<p>如果上面这两个例子看懂了的话，加一个我们自己设计的 protocol 进去就很容易了，好像可以作为一个思考题（手动狗头）？</p>
</li>
<li>
<p>Parser 的部分还有很多更高端的操作，比如 verify、lookahead、sub-parser，有机会看到的话我们再一起学习[<a href="https://zhuanlan.zhihu.com/p/346936899#ref_2">2]</a>。</p>
</li>
<li>
<h2 id="小结">小结</h2>
</li>
<li>
<p>这篇文章简单的梳理了一遍 P4 基本的语法知识，包括基本数据类型和运算操作。</p>
</li>
<li>
<p>下一篇会结合更多例子来介绍 P4 workflow 里面剩下的部分，也就是 Match-Action Pipeline 和 Deparser 的过程。</p>
</li>
<li></li>
<li>
<h2 id="参考">参考</h2>
</li>
<li>
<ol>
<li><a href="https://zhuanlan.zhihu.com/p/346936899#ref_1_0">^</a>Segment Routing <a href="https://www.segment-routing.net/ietf/">https://www.segment-routing.net/ietf/</a></li>
<li><a href="https://zhuanlan.zhihu.com/p/346936899#ref_2_0">^</a>P4-16 Spec <a href="https://p4.org/p4-spec/docs/P4-16-v1.0.0-spec.html">https://p4.org/p4-spec/docs/P4-16-v1.0.0-spec.html</a></li>
</ol>
</li>
<li>
<ul>
<li><a href="https://zhuanlan.zhihu.com/p/346936899">相关内容转载自本链接</a></li>
</ul>
</li>
</ul>

    </div>
    <footer class="post-footer">
     
 
<div class="post-tags">     
     
    <a href="http://shanks.link/tags/p4" rel="tag" title="p4">#p4#</a>
    
</div>



     <div class="post-nav">
    <div class="post-nav-next post-nav-item">
    
        <a href="http://shanks.link/blog/2023/09/15/p4-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E4%B8%89-%E6%8E%A7%E5%88%B6%E9%80%BB%E8%BE%91%E4%B8%8E%E5%AE%8C%E6%95%B4%E7%9A%84%E5%B7%A5%E4%BD%9C%E6%B5%81/" rel="next" title="P4 学习笔记（三）- 控制逻辑与完整的工作流">
        <i class="fa fa-chevron-left"></i> P4 学习笔记（三）- 控制逻辑与完整的工作流
        </a>
    
    </div>

    <div class="post-nav-prev post-nav-item">
    
        <a href="http://shanks.link/blog/2023/09/15/p4-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E4%B8%80-%E5%AF%BC%E8%AE%BA/" rel="prev" title="P4 学习笔记（一）- 导论">
        P4 学习笔记（一）- 导论 <i class="fa fa-chevron-right"></i>
        </a>
    
    </div>
</div>
      
     
     
     





<script src="https://utteranc.es/client.js"
        repo="shankusu2017@gmail.com/"
        issue-term="pathname"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>
<noscript>Please enable JavaScript to view the <a href="https://github.com/utterance">comments powered by utterances.</a></noscript>

    </footer>
  </article>
</section>

          </div>
        </div>
        <div class="sidebar-toggle">
  <div class="sidebar-toggle-line-wrap">
    <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
    <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
    <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
  </div>
</div>
<aside id="sidebar" class="sidebar">
  <div class="sidebar-inner">

    <section class="site-overview sidebar-panel  sidebar-panel-active ">
      <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image"
        src="http://shanks.link/img/logo.jpg"
        alt="" />
    <p class="site-author-name" itemprop="name"></p>
    <p class="site-description motion-element" itemprop="description"> </p>
</div>
      <nav class="site-state motion-element">
    <div class="site-state-item site-state-posts">
        <a href="http://shanks.link/post/">
            <span class="site-state-item-name">日志</span>
        </a>
    </div>
    <div class="site-state-item site-state-categories">
        <a href="http://shanks.link/categories/">
            <span class="site-state-item-name">分类</span>
        </a>
    </div>

    <div class="site-state-item site-state-tags">
        <a href="http://shanks.link/tags/">
            <span class="site-state-item-name">标签</span>
        </a>
    </div>
</nav>

      
      
<div class="links-of-author motion-element">
    
        <span class="links-of-author-item">
        <a href="https://github.com/shankusu2017" target="_blank" title="GitHub">
            <i class="fa fa-fw fa-github"></i>
            GitHub
        </a>
        </span>
    
</div>


      

      <div class="links-of-blogroll motion-element inline">
<script type="text/javascript" src="//rf.revolvermaps.com/0/0/8.js?i=5b4f2ucxar6&amp;m=0&amp;s=220&amp;c=ff0000&amp;cr1=ffffff&amp;f=arial&amp;l=33&amp;bv=35" async="async"></script>
</div>

    </section>
    
  </div>
</aside>

      </div>
    </main>
   
    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  <span itemprop="copyrightYear">  &copy; 
  2009 - 2025</span>
</div>
<div>
  <a href="https://beian.miit.gov.cn/" rel="noopener" target="_blank">粤ICP备2021068940号-1</a>
  <a href="https://www.beian.gov.cn/portal/registerSystemInfo?recordcode=44011302003059" rel="noopener" target="_blank">粤公网安备44011302003059</a>
</div>


      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
      <span id="scrollpercent"><span>0</span>%</span>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>
<script type="text/javascript" src="http://shanks.link/js/vendor/jquery/index.js?v=2.1.3"></script>
<script type="text/javascript" src="http://shanks.link/js/vendor/fastclick/lib/fastclick.min.js?v=1.0.6"></script> 
<script type="text/javascript" src="http://shanks.link/js/vendor/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
<script type="text/javascript" src="http://shanks.link/js/vendor/velocity/velocity.min.js?v=1.2.1"></script>
<script type="text/javascript" src="http://shanks.link/js/vendor/velocity/velocity.ui.min.js?v=1.2.1"></script>
<script src="http://shanks.link/js/vendor/ua-parser-js/dist/ua-parser.min.js?v=0.7.9"></script>

<script src="http://shanks.link/js/vendor/fancybox/jquery.fancybox.pack.js?v=2.1.5"></script>

<script type="text/javascript" src="http://shanks.link/js/utils.js"></script>
<script type="text/javascript" src="http://shanks.link/js/motion.js"></script>
<script type="text/javascript" src="http://shanks.link/js/affix.js"></script>
<script type="text/javascript" src="http://shanks.link/js/schemes/pisces.js"></script>

<script type="text/javascript" src="http://shanks.link/js/scrollspy.js"></script>
<script type="text/javascript" src="http://shanks.link/js/post-details.js"></script>
<script type="text/javascript" src="http://shanks.link/js/toc.js"></script>

<script type="text/javascript" src="http://shanks.link/js/bootstrap.js"></script>

<script type="text/javascript" src="http://shanks.link/js/search.js"></script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX", "output/HTML-CSS"],
    tex2jax: {
      inlineMath: [ ['$','$'] ],
      displayMath: [ ['$$','$$'] ],
      processEscapes: true
    },
    "HTML-CSS": { fonts: ["TeX"] }
  });
</script>
<script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML' async></script>
</body>
</html>