<!DOCTYPE HTML>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" /> 
    <title>返璞归真实现OpenVPN第二阶段协商 - Golang编程语言知识介绍</title>
    <meta name="keywords" content="git,Git,Lua,lua,Golang,go">
    
    <meta property="og:title" content="返璞归真实现OpenVPN第二阶段协商">
    <meta property="og:site_name" content="Golang编程语言知识介绍">
    <meta property="og:image" content="/img/author.jpg"> 
    <meta name="title" content="返璞归真实现OpenVPN第二阶段协商 - Golang编程语言知识介绍" />
    <meta name="description" content="愿星光伴你左右"> 
    <link rel="shortcut icon" href="http://shanks.link/img/favicon.ico" />
    <link rel="apple-touch-icon" href="http://shanks.link/img/apple-touch-icon.png" />
    <link rel="apple-touch-icon-precomposed" href="http://shanks.link/img/apple-touch-icon.png" />
    <link href="http://shanks.link/js/vendor/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />
    <link href="http://shanks.link/js/vendor/fancybox/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />
    <link href="http://shanks.link/css/main.css" rel="stylesheet" type="text/css" />
    <link href="http://shanks.link/css/syntax.css" rel="stylesheet" type="text/css" />
    <script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post"},
     fancybox: true, 
    motion: true
  };
</script>
</head>
<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">
<div class="container one-collumn sidebar-position-left page-home  ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"> <div class="site-meta  custom-logo ">

  <div class="custom-logo-site-title">
    <a href="http://shanks.link/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">Golang编程语言知识介绍</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle"></p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
    <ul id="menu" class="menu">
      
      
        <li class="menu-item ">
          <a href="http://shanks.link/post/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />首页
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/thinking/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />随想录
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/%E7%94%9F%E6%B4%BB/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />生活
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/os/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />OS
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/lua/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />lua
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/redis/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />redis
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/go/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />Golang
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/c/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />C
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/openvpn/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />OpenVPN
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/web/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />web
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/openwrt/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />OpenWRT
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/%E8%BF%90%E7%BB%B4/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />运维
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/git/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />Git
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/%E9%B8%9F%E5%93%A5%E7%9A%84%E7%A7%81%E6%88%BF%E8%8F%9C/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />鸟哥的私房菜
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/it/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />IT杂谈
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/about/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />About Me
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/links/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />友情链接
          </a>
        </li>
      
      <li class="menu-item menu-item-search">
        <a href="javascript:;" class="popup-trigger"> <i class="menu-item-icon fa fa-search fa-fw"></i> <br /> 搜索</a>
      </li>
    </ul>
    <div class="site-search">
      <div class="popup">
 <span class="search-icon fa fa-search"></span>
 <input type="text" id="local-search-input">
 <div id="local-search-result"></div>
 <span class="popup-btn-close">close</span>
</div>

    </div>
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
<section id="posts" class="posts-expand">
  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <header class="post-header">
      <h1 class="post-title" itemprop="name headline">
        <a class="post-title-link" href="http://shanks.link/blog/2022/07/12/%E8%BF%94%E7%92%9E%E5%BD%92%E7%9C%9F%E5%AE%9E%E7%8E%B0openvpn%E7%AC%AC%E4%BA%8C%E9%98%B6%E6%AE%B5%E5%8D%8F%E5%95%86/" itemprop="url">
        返璞归真实现OpenVPN第二阶段协商
        </a>
      </h1>
      <div class="post-meta">
      <span class="post-time">
<span class="post-meta-item-icon">
    <i class="fa fa-calendar-o"></i>
</span>
<span class="post-meta-item-text">时间：</span>
<time itemprop="dateCreated" datetime="2016-03-22T13:04:35+08:00" content="2022-07-12">
    2022-07-12
</time>
</span> 
      

  <span class="post-category" >
  &nbsp; | &nbsp;
  <span class="post-meta-item-icon">
    <i class="fa fa-folder-o"></i>
  </span>
  <span class="post-meta-item-text">分类：</span>
  
    <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
      <a href="http://shanks.link/categories/openvpn" itemprop="url" rel="index">
        <span itemprop="name">openvpn</span>
      </a>
      &nbsp; 
    </span>
  
</span>


       <span>
&nbsp; | &nbsp;
<span class="post-meta-item-icon">
    <i class="fa fa-eye"></i>
</span>
<span class="post-meta-item-text">阅读：</span>
<span class="leancloud-visitors-count">5571 字 ~12分钟</span>
</span>
      </div>
    </header>
    <div class="post-body" itemprop="articleBody">
    <h1 id="背景介绍">背景介绍</h1>
<p>听着《梦中的额吉》，《天堂》&hellip;女儿在睡觉&hellip;外面细雨&hellip;中秋小长假，完成自己的OpenVPN patch 编码中充满了快乐！前提是你知道自己在做什么！ OpenVPN不给力，虽然它给出了N多的Renegotiate选项，然则其实现却不尽人意。难道设计者以为我们众人就这么好忽悠吗？</p>
<p>OpenVPN实现重新密钥协商是极其重量级的，需要做以下几件事：</p>
<p><strong>1.断开当前的SSL连接；</strong></p>
<p><strong>2.重新开始一次SSL连接，建立一次SSL session；</strong></p>
<p><strong>3.在重新生成的SSL加密信道上重新开始OpenVPN的密钥协商；</strong></p>
<p>​		记住，不能单纯的理解这3个事件，是因为如果从底层看，底层的UDP连接(不考虑TCP的情况)并没有断开，需要理解的是，SSL协商和数据通道复用一个信道。这个过程之所以说是重量级的是因为1和2并不总是必要的，要知道SSL的目的有两点，第一是相互认证，确保客户端连接的是自己要连接的服务器，确保客户端有权接入VPN；第二是在协商出的SSL加密信道上协商OpenVPN的对称密钥。如果我们只是要保护VPN通信的内容，那么大可不必重复认证，也就是没有必要重新进行SSL握手。要知道，如果SSL加密信道可以被攻破，那么后续的通信将是不再安全的，幸运的是，SSL协议本身的完备性保证了SSL最终协商出的信道是安全的，否则SSL协议也不会这么流行，因此除非SSL本身的规范要求，在OpenVPN中，如果仅仅为了保证数据的机密性，SSL重协商是没有必要的。</p>
<p>​		这只是其一。任何伟大的事情，都有无数的先行者，或者说它本身就需要借鉴前辈的成果。我们可以考虑IKE，ISAKMP的规范，它明确规定了两个阶段的协商，为了效率，一般情况下，通信双方只需要进行第二阶段的重新协商，在IKE的规范中，第一阶段的协商所完成的工作和SSL握手完成的工作很类似(也许正好说反了，&hellip;我女儿长得和我很像，而不是我长得和我女儿很像！)。对称密钥由于密钥长度不够，算法相对简单，被暴破的可能性很大，因此应该不断重新协商对称密钥。在使用SSL协议的情况下有两种方式重新协商出对称密钥，第一种方式就是重新进行SSL握手，使用SSL最终协商出的那个对称密钥，第二就是在直接在SSL加密信道上协商新的对称密钥，这就使对称密钥的结果和SSL协议分离了，无疑这是一种效率更高且配置更灵活的方式，也许这也是对IKE/ISAKMP的一种呼应吧。</p>
<p>​		然而很可惜，OpenVPN并没有使用这种优雅的方式，每当OpenVPN需要重新协商，都要从新建SSL session开始！key_state_soft_reset这个函数并没有做到其名称所描述的那样soft，而实则是一种very hard的恶毒方式，因此需要改变这种方式！我对OpenVPN的已经关注超过两年了，由于工作需要，加之自己的兴趣，着手对之做个外科手术，手术很成功，以数据为证，效率有很大的提升。在学习的过程中，Internet对我帮助很大，Internet本身就是共享的，因此将patch献出，也希望共勉者完善之。本patch也以委托的方式提交到了OpenVPN的maillist，希望能在下个版本中见到它的身影，如果有朋友觉得有改进的地方，那就大胆的改进它，然后提交&hellip;这对于每一个开发人员都是一笔财富！</p>
<h1 id="尝试修改">尝试修改</h1>
<p>前文《让OpenVPN实现IKE似的两阶段密钥协商》，代码已然完成，然则不便公开，同时代码丑陋之极，无颜！总的来讲，那只是一次初期的预研，逻辑如下：</p>
<h2 id="在s_active之后定义新的状态码">在S_ACTIVE之后定义新的状态码；</h2>
<h2 id="当需要进行第二阶段协商的时候像client-push一个字符串将本地状态设置一个中间状态">当需要进行第二阶段协商的时候，像client push一个字符串，将本地状态设置一个中间状态；</h2>
<h2 id="client端收到server端push下来的对应字符串之后将本地状态设置为一个新定义的预协商状态并且写入新的key协商消息同时reply一个字符串">client端收到server端push下来的对应字符串之后，将本地状态设置为一个新定义的预协商状态，并且写入新的key协商消息，同时reply一个字符串；</h2>
<h2 id="server端收到client端reply的字符串之后将本地状态设置为预协商的状态读取key协商消息">server端收到client端reply的字符串之后，将本地状态设置为预协商的状态，读取key协商消息；</h2>
<h2 id="双方开始在以前的ssl加密信道上重新协商新的对称密钥">双方开始在以前的SSL加密信道上重新协商新的对称密钥；</h2>
<h2 id="最终二者到达一个新的s_active状态">最终，二者到达一个新的S_ACTIVE状态；</h2>
<h2 id="协商完成">协商完成。</h2>
<p>​		这个手术开始非常让我自豪，因为它有效的降低了传输延迟，然而经过后续的仔细测试，发现它引起了大量的丢包，使用ping进行的简单的测试就会发现丢包，因为echo reply的序号会有断续&hellip;这个结果极大的打击了我。</p>
<p>​		但是，我的选择只能是继续尝试其他的方法，否则我的努力将是前功尽弃&hellip;(腾格尔的《天堂》，从时间4:45开始的一段音乐很不错[哦&hellip;Belala&hellip;]，我很喜欢)。我的push/pull/reply的想法并没有错啊，server端总是需要一种方式通知client需要重新协商了，这本身很合理，然而哪里错了？后来看代码，发现就算是硬协商，也就是重新开始SSL握手，标准的OpenVPN也是这么做的，所不同的是，标准的OpenVPN并没有使用push，而是发送了一个很特别的P_CONTROL_SOFT_RESET_V1消息，然后再在client端的tls_pre_decrypt函数中对其进行特殊的处理，从而进行正常的伪造的“SOFT”reset。</p>
<p>既然如果，我又何必出力不讨好，直接使用标准的实现不就可以了吗！</p>
<p>还好OpenVPN协议的定义很灵活，其op码为5位，最大可以有31个，现在才使用了8个，我扩展一个是很简单的事情啊。想到这里，再也忍不住了，先吸一根烟再说！(《梦中的额吉》在1:54时间开始一段音乐很不错，引发了更多的想法)</p>
<h1 id="确定如何修改">确定如何修改</h1>
<p>当初的尝试之所以出现了丢包，那是因为我忽略了OpenVPN对session和key的管理。在OpenVPN中，为了实现在重新协商以及clilent断开中不丢包，业务数据传输不受影响的正常进行，OpenVPN设计了3个session和2个key state，在client断开重连时，server管理session，以至于正常连接成为可能，在重新协商密钥时，server端管理key state，从而平滑过渡到新的密钥。</p>
<p>因此，如果不吃透OpenVPN复杂的协议处理，实现第二阶段的协商是没戏的。我的做法是，先动手再说，先修改掉代码再慢慢测试排错，我觉得程序员就应该这样，毕竟我们不是研究院的专家有那么多的时间和经费。具体实现见第4节。</p>
<p>实现了之后，测试，效果良好，先给出数据，先看一个ping的结果，测试中为了比较重新协商SSL和仅仅重新协商对称密钥，我使用了常数4秒，测试原生OpenVPN时，使用reneg-sec 4参数，而测试我修改过的OpenVPN时，使用reneg-second参数，首先看一下没有修改的原生的OpenVPN的ping结果：</p>
<p><img src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2018/12/14/167ac3b8beb2785a~tplv-t2oaga2asx-zoom-in-crop-mark:3024:0:0:0.awebp" alt="img"></p>
<p>可以看出，每隔4秒左右，就会出现一次时延非常大的抖动，再看看我做过手术的OpenVPN的结果：</p>
<p><img src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2018/12/14/167ac3b982f960d3~tplv-t2oaga2asx-zoom-in-crop-mark:3024:0:0:0.awebp" alt="img"></p>
<p>可以看到，抖动虽然还有，但是平缓了很多。仅仅通过ping还不足以看出个究竟，那么我们看看tcp传输的丢包重传统计值：</p>
<p><img src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2018/12/14/167ac3ba2947da30~tplv-t2oaga2asx-zoom-in-crop-mark:3024:0:0:0.awebp" alt="img"></p>
<p>​		结果几乎是肯定的，当然TCP协议是复杂的，不能单纯从丢包或者重传来判断，正好比，有一条比较超豪华的高速公路，其事故率并不比国道少的原因一样(不得不说的插曲：TCP重传可能是由于其拥塞避免阀值设置得过高所导致，或者由于其拥塞控制算法过于自私所导致，然而可悲的是，很多人都认为重传越多，网络状况越差！这样的人不在少数，还总是用什么业务逻辑之类词汇将真理打发)</p>
<h1 id="最终的补丁">最终的补丁</h1>
<p>​		起初我想直接提交这个补丁，但是由于Unix邮箱环境坏了，web邮箱提交patch有存在编码问题，因此采用了委托的方式，希望社区的家伙能帮我这个忙，至于作者是谁是无所谓的，Internet上的作者大多是虚拟的，像dog250之类的，呵呵~~。</p>
<p>最终的补丁其实很简单，之所以称为返璞归真，是因为OpenVPN本身做的就很好，其协议的操作码预留了5位的空间，而它仅仅用了不到8个，这就是值得欣慰的事情，这意味着我们只需要增加一个操作码就能实现额外的功能，对于第二阶段协商来讲，用这个方法实现再好不过了，补丁如下，如果有谁索要常规编码的补丁，请发邮件(不要为补丁所迷惑，后面有解释)：</p>
<p>TO <a href="https://link.juejin.cn/?target=http%3A%2F%2Feveryone.As">everyone.As</a> we know,IKE takes only phase II to consult the final KEY IF WE DO NOT CARE ABOUT THE RESULT ABOUT RE-AUTJENTICATION in the special condition.This idea is very true especially if we use SSL protocol because of the secure test in very bitter surrounding. The SSL protocol can ensure the security of the whole vitrual line after the entire handshack.  OpenVPN use the protocol of itself not only SSL.Its channel is build on its protocol of itself.Thus if somebody crack the SSL key, (S)HE must take sometime that may be long to crack the OpenVPN channel key. AS THE RESULT,WE CAN ONLY TO Renegotiate ITS CHANNEL KEY NOT THE WHOLE SSL SESSION.  Unfortunately,as we show,OpenVPN takes a pool way to renegotiate the new key, not only the channel key but also the SSL record protocol key.  This patch rework the whole thing.Its only take the phase II to renegotiate the channel key.  *****************************************************************************</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c">diff -uNr openvpn-2.2.1/options.c openvpn-2.2.1_my/options.c
--- openvpn-2.2.1/options.c    2011-09-09 16:25:49.000000000 +0800
+++ openvpn-2.2.1_my/options.c    2011-09-09 17:12:03.000000000 +0800
@@ -668,6 +668,7 @@
   <span style="color:#009c00">&#34;--show-pkcs11-ids provider [cert_private] : Show PKCS#11 available ids.</span><span style="color:#009c00">\n</span><span style="color:#009c00">&#34;</span>
   <span style="color:#009c00">&#34;                                            --verb option can be added *BEFORE* this.</span><span style="color:#009c00">\n</span><span style="color:#009c00">&#34;</span>
 <span style="color:#f00;font-style:italic">#endif                </span><span style="color:#f00;font-style:italic">/* ENABLE_PKCS11 */</span><span style="color:#f00;font-style:italic">
</span><span style="color:#f00;font-style:italic"></span>+    <span style="color:#009c00">&#34;--reneg-second     sec     :xxx&#34;</span>
  ;
 
 <span style="color:#f00;font-style:italic">#endif </span><span style="color:#f00;font-style:italic">/* !ENABLE_SMALL */</span><span style="color:#f00;font-style:italic">
</span><span style="color:#f00;font-style:italic"></span>@@ -3544,6 +3545,7 @@
   <span style="color:#00f">int</span> msglevel_fc = msglevel_forward_compatible (options, msglevel);
 
   ASSERT (MAX_PARMS &gt;= 5);
+    reneg_sec_time = 0;
   <span style="color:#00f">if</span> (!file)
     {
       file = <span style="color:#009c00">&#34;[CMD-LINE]&#34;</span>;
@@ -5781,6 +5783,10 @@
       VERIFY_PERMISSION (OPT_P_GENERAL);
       options-&gt;crl_file = p[1];
     }
+    <span style="color:#00f">else</span> <span style="color:#00f">if</span> (streq (p[0], <span style="color:#009c00">&#34;reneg-second&#34;</span>) &amp;&amp; p[1]) {
+         reneg_sec_time = atoi(p[1]);
+    }
+
   <span style="color:#00f">else</span> <span style="color:#00f">if</span> (streq (p[0], <span style="color:#009c00">&#34;tls-verify&#34;</span>) &amp;&amp; p[1])
     {
       VERIFY_PERMISSION (OPT_P_SCRIPT);
diff -uNr openvpn-2.2.1/ssl.c openvpn-2.2.1_my/ssl.c
--- openvpn-2.2.1/ssl.c    2011-09-09 16:25:49.000000000 +0800
+++ openvpn-2.2.1_my/ssl.c    2011-09-09 17:16:28.000000000 +0800
@@ -2329,6 +2329,7 @@
    * to/from memory BIOs.
    */
   CLEAR (*ks);
+  session-&gt;ks_size = KS_SIZE;
 
   ks-&gt;ssl = SSL_new (session-&gt;opt-&gt;ssl_ctx);
   <span style="color:#00f">if</span> (!ks-&gt;ssl)
@@ -2469,6 +2470,7 @@
   dmsg (D_TLS_DEBUG, <span style="color:#009c00">&#34;TLS: tls_session_init: entry&#34;</span>);
 
   CLEAR (*session);
+  multi-&gt;tm_size = TM_SIZE;
 
   <span style="color:#f00;font-style:italic">/* Set options data to point to parent&#39;s option structure */</span>
   session-&gt;opt = &amp;multi-&gt;opt;
@@ -2520,7 +2522,7 @@
   <span style="color:#00f">if</span> (session-&gt;tls_auth.packet_id)
     packet_id_free (session-&gt;tls_auth.packet_id);
 
-  <span style="color:#00f">for</span> (i = 0; i &lt; KS_SIZE; ++i)
+  <span style="color:#00f">for</span> (i = 0; i &lt; session-&gt;ks_size; ++i)
     key_state_free (&amp;session-&gt;key[i], false);
 
   <span style="color:#00f">if</span> (session-&gt;common_name)
@@ -2725,8 +2727,8 @@
 
   cert_hash_free (multi-&gt;locked_cert_hash_set);
 
-  <span style="color:#00f">for</span> (i = 0; i &lt; TM_SIZE; ++i)
-    tls_session_free (&amp;multi-&gt;session[i], false);
+  <span style="color:#00f">for</span> (i = 0; i &lt; multi-&gt;tm_size; ++i)
+      tls_session_free (&amp;multi-&gt;session[i], false);
 
   <span style="color:#00f">if</span> (clear)
     CLEAR (*multi);
@@ -3256,6 +3258,26 @@
   ks-&gt;remote_addr = ks_lame-&gt;remote_addr;
 }
 
+<span style="color:#00f">void</span>
+key_state_soft_reset2(<span style="color:#00f">struct</span> tls_session *session, <span style="color:#00f">struct</span> tls_multi *multi)
+{
+  update_time ();
+  ks-&gt;must_die = now + session-&gt;opt-&gt;transition_window; <span style="color:#f00;font-style:italic">/* remaining lifetime of old key */</span>
+  *ks_lame = *ks;
+  session-&gt;ks_size = 1;
+  multi-&gt;tm_size = 1;
+
+  session-&gt;initial_opcode = P_CONTROL_SOFT_RESET_SECOND;
+  ks-&gt;initial_opcode = session-&gt;initial_opcode;
+  ks-&gt;key_id = session-&gt;key_id;
+  ++session-&gt;key_id;
+  session-&gt;key_id &amp;= P_KEY_ID_MASK;
+  <span style="color:#00f">if</span> (!session-&gt;key_id)
+      session-&gt;key_id = 1;
+  ks-&gt;state = S_K;
+  ks-&gt;session_id_remote = ks_lame-&gt;session_id_remote;
+  ks-&gt;remote_addr = ks_lame-&gt;remote_addr;
+}
 <span style="color:#f00;font-style:italic">/*
</span><span style="color:#f00;font-style:italic">  * Read/write strings from/to a struct buffer with a u16 length prefix.
</span><span style="color:#f00;font-style:italic">  */</span>
@@ -4039,6 +4061,16 @@
        ks-&gt;n_packets, session-&gt;opt-&gt;renegotiate_packets);
       key_state_soft_reset (session);
     }
+    
+    <span style="color:#00f">if</span> (((ks-&gt;state == S_ACTIVE) || (ks-&gt;state == S_NORMAL_OP)) &amp;&amp;
+          reneg_sec_time &amp;&amp;
+          (now &gt;= ks-&gt;reneg_base + reneg_sec_time) &amp;&amp;    
+           session-&gt;opt-&gt;server) {
+        ks-&gt;reneg_base = now;
+        key_state_soft_reset2 (session, multi);
+        
+    }
+        
 
   <span style="color:#f00;font-style:italic">/* Kill lame duck key transition_window seconds after primary key negotiation */</span>
   <span style="color:#00f">if</span> (lame_duck_must_die (session, wakeup)) {
@@ -4069,7 +4101,7 @@
       <span style="color:#00f">if</span> (true)
     {
       <span style="color:#f00;font-style:italic">/* Initial handshake */</span>
-      <span style="color:#00f">if</span> (ks-&gt;state == S_INITIAL)
+      <span style="color:#00f">if</span> (ks-&gt;state == S_INITIAL || ks-&gt;state == S_K)
         {
           buf = reliable_get_buf_output_sequenced (ks-&gt;send_reliable);
           <span style="color:#00f">if</span> (buf)
@@ -4082,6 +4114,8 @@
           INCR_GENERATED;
           
           ks-&gt;state = S_PRE_START;
+            <span style="color:#00f">if</span> (ks-&gt;state == S_K)
+                ks-&gt;state = S_START;
           state_change = true;
           dmsg (D_TLS_DEBUG, <span style="color:#009c00">&#34;TLS: Initial Handshake, sid=%s&#34;</span>,
                session_id_print (&amp;session-&gt;session_id, &amp;gc));
@@ -4118,7 +4152,7 @@
         }
 
       <span style="color:#f00;font-style:italic">/* Wait for Initial Handshake ACK */</span>
-      <span style="color:#00f">if</span> (ks-&gt;state == S_PRE_START &amp;&amp; FULL_SYNC)
+      <span style="color:#00f">if</span> ((ks-&gt;state == S_PRE_START || ks-&gt;state == S_K) &amp;&amp; FULL_SYNC)
         {
           ks-&gt;state = S_START;
           state_change = true;
@@ -4131,7 +4165,9 @@
         {
           <span style="color:#00f">if</span> (FULL_SYNC)
         {
+
           ks-&gt;established = now;
+          ks-&gt;reneg_base = now;
           dmsg (D_TLS_DEBUG_MED, <span style="color:#009c00">&#34;STATE S_ACTIVE&#34;</span>);
           <span style="color:#00f">if</span> (check_debug_level (D_HANDSHAKE))
             print_details (ks-&gt;ssl, <span style="color:#009c00">&#34;Control Channel:&#34;</span>);
@@ -4366,6 +4402,9 @@
     <span style="color:#00f">if</span> (ks-&gt;established &amp;&amp; session-&gt;opt-&gt;renegotiate_seconds)
       compute_earliest_wakeup (wakeup,
         ks-&gt;established + session-&gt;opt-&gt;renegotiate_seconds - now);
+    <span style="color:#00f">if</span> (ks-&gt;reneg_base &amp;&amp; reneg_sec_time)
+      compute_earliest_wakeup (wakeup,
+        ks-&gt;reneg_base + reneg_sec_time - now);
 
     <span style="color:#f00;font-style:italic">/* prevent event-loop spinning by setting minimum wakeup of 1 second */</span>
     <span style="color:#00f">if</span> (*wakeup &lt;= 0)
@@ -4894,13 +4933,25 @@
           dmsg (D_TLS_DEBUG,
                <span style="color:#009c00">&#34;TLS: received P_CONTROL_SOFT_RESET_V1 s=%d sid=%s&#34;</span>,
                i, session_id_print (&amp;sid, &amp;gc));
+        } <span style="color:#00f">else</span>
+          <span style="color:#00f">if</span> (op == P_CONTROL_SOFT_RESET_SECOND
+          &amp;&amp; DECRYPT_KEY_ENABLED (multi, ks))
+        {
+          <span style="color:#00f">if</span> (!read_control_auth (buf, &amp;session-&gt;tls_auth, from)) {
+            <span style="color:#00f">goto</span> error;
+            }
+          key_state_soft_reset2 (session, multi);
+
+          dmsg (D_TLS_DEBUG,
+               <span style="color:#009c00">&#34;TLS: received P_CONTROL_SOFT_RESET_V1 s=%d sid=%s&#34;</span>,
+               i, session_id_print (&amp;sid, &amp;gc));
         }
           <span style="color:#00f">else</span>
         {
           <span style="color:#f00;font-style:italic">/*
</span><span style="color:#f00;font-style:italic">            * Remote responding to our key renegotiation request?
</span><span style="color:#f00;font-style:italic">            */</span>
-          <span style="color:#00f">if</span> (op == P_CONTROL_SOFT_RESET_V1)
+          <span style="color:#00f">if</span> (op == P_CONTROL_SOFT_RESET_V1 || op == P_CONTROL_SOFT_RESET_SECOND)
             do_burst = true;
 
           <span style="color:#00f">if</span> (!read_control_auth (buf, &amp;session-&gt;tls_auth, from))
diff -uNr openvpn-2.2.1/ssl.h openvpn-2.2.1_my/ssl.h
--- openvpn-2.2.1/ssl.h    2011-09-09 16:25:49.000000000 +0800
+++ openvpn-2.2.1_my/ssl.h    2011-09-09 17:19:26.000000000 +0800
@@ -210,6 +210,7 @@
 <span style="color:#f00;font-style:italic">#define P_CONTROL_SOFT_RESET_V1        3     </span><span style="color:#f00;font-style:italic">/* new key, graceful transition from old to new key */</span><span style="color:#f00;font-style:italic">
</span><span style="color:#f00;font-style:italic"></span> <span style="color:#f00;font-style:italic">#define P_CONTROL_V1                   4     </span><span style="color:#f00;font-style:italic">/* control channel packet (usually TLS ciphertext) */</span><span style="color:#f00;font-style:italic">
</span><span style="color:#f00;font-style:italic"></span> <span style="color:#f00;font-style:italic">#define P_ACK_V1                       5     </span><span style="color:#f00;font-style:italic">/* acknowledgement for packets received */</span><span style="color:#f00;font-style:italic">
</span><span style="color:#f00;font-style:italic"></span>+#define P_CONTROL_SOFT_RESET_SECOND      9     <span style="color:#f00;font-style:italic">/* new key, graceful transition from old to new key */</span>
 <span style="color:#f00;font-style:italic">#define P_DATA_V1                      6     </span><span style="color:#f00;font-style:italic">/* data channel packet */</span><span style="color:#f00;font-style:italic">
</span><span style="color:#f00;font-style:italic"></span> 
 <span style="color:#f00;font-style:italic">/* indicates key_method &gt;= 2 */</span>
@@ -218,18 +219,25 @@
 
 <span style="color:#f00;font-style:italic">/* define the range of legal opcodes */</span>
 <span style="color:#f00;font-style:italic">#define P_FIRST_OPCODE                 1
</span><span style="color:#f00;font-style:italic"></span>-#define P_LAST_OPCODE                  8
+#define P_LAST_OPCODE                  10
 
 <span style="color:#f00;font-style:italic">/* key negotiation states */</span>
 <span style="color:#f00;font-style:italic">#define S_ERROR          -1
</span><span style="color:#f00;font-style:italic"></span> <span style="color:#f00;font-style:italic">#define S_UNDEF           0
</span><span style="color:#f00;font-style:italic"></span> <span style="color:#f00;font-style:italic">#define S_INITIAL         1    </span><span style="color:#f00;font-style:italic">/* tls_init() was called */</span><span style="color:#f00;font-style:italic">
</span><span style="color:#f00;font-style:italic"></span> <span style="color:#f00;font-style:italic">#define S_PRE_START       2    </span><span style="color:#f00;font-style:italic">/* waiting for initial reset &amp; acknowledgement */</span><span style="color:#f00;font-style:italic">
</span><span style="color:#f00;font-style:italic"></span>-#define S_START           3    <span style="color:#f00;font-style:italic">/* ready to exchange keys */</span>
-#define S_SENT_KEY        4    <span style="color:#f00;font-style:italic">/* client does S_SENT_KEY -&gt; S_GOT_KEY */</span>
-#define S_GOT_KEY         5    <span style="color:#f00;font-style:italic">/* server does S_GOT_KEY -&gt; S_SENT_KEY */</span>
-#define S_ACTIVE          6    <span style="color:#f00;font-style:italic">/* ready to exchange data channel packets */</span>
-#define S_NORMAL_OP       7    <span style="color:#f00;font-style:italic">/* normal operations */</span>
+
+#define S_K                 3    <span style="color:#f00;font-style:italic">/* ready to exchange keys */</span>
+#define S_START           4    <span style="color:#f00;font-style:italic">/* ready to exchange keys */</span>
+#define S_SENT_KEY        5    <span style="color:#f00;font-style:italic">/* client does S_SENT_KEY -&gt; S_GOT_KEY */</span>
+#define S_GOT_KEY         6    <span style="color:#f00;font-style:italic">/* server does S_GOT_KEY -&gt; S_SENT_KEY */</span>
+
+<span style="color:#00f">unsigned</span> <span style="color:#00f">int</span> reneg_sec_time;
+<span style="color:#00f">unsigned</span> <span style="color:#00f">int</span> reneg_base;
+
+#define S_ACTIVE          7    <span style="color:#f00;font-style:italic">/* ready to exchange data channel packets */</span>
+#define S_NORMAL_OP       8    <span style="color:#f00;font-style:italic">/* normal operations */</span>
+
 
 <span style="color:#f00;font-style:italic">/*
</span><span style="color:#f00;font-style:italic">  * Are we ready to receive data channel packets?
</span><span style="color:#f00;font-style:italic">@@ -358,6 +366,7 @@
</span><span style="color:#f00;font-style:italic">   BIO *ct_out;            /* read ciphertext from here */</span>
 
   time_t established;        <span style="color:#f00;font-style:italic">/* when our state went S_ACTIVE */</span>
+  time_t reneg_base;
   time_t must_negotiate;    <span style="color:#f00;font-style:italic">/* key negotiation times out if not finished before this time */</span>
   time_t must_die;        <span style="color:#f00;font-style:italic">/* this object is destroyed at this time */</span>
 
@@ -540,6 +549,7 @@
   <span style="color:#00f">int</span> verify_maxlevel;
 
   <span style="color:#00f">char</span> *common_name;
+    <span style="color:#00f">int</span> ks_size;
 
   <span style="color:#00f">struct</span> cert_hash_set *cert_hash_set;
 
@@ -637,6 +647,7 @@
    * Our session objects.
    */
   <span style="color:#00f">struct</span> tls_session session[TM_SIZE];
+    <span style="color:#00f">int</span> tm_size;
 };
 
 <span style="color:#f00;font-style:italic">/*
</span><span style="color:#f00;font-style:italic">@@ -843,6 +854,7 @@
</span><span style="color:#f00;font-style:italic"> 
</span><span style="color:#f00;font-style:italic"> /*#define EXTRACT_X509_FIELD_TEST*/</span>
 <span style="color:#00f">void</span> <span style="color:#c34e00">extract_x509_field_test</span> (<span style="color:#00f">void</span>);
+<span style="color:#00f">void</span> key_state_soft_reset2 (<span style="color:#00f">struct</span> tls_session *session, <span style="color:#00f">struct</span> tls_multi *multi);
 
 <span style="color:#f00;font-style:italic">#endif </span><span style="color:#f00;font-style:italic">/* USE_CRYPTO &amp;&amp; USE_SSL */</span><span style="color:#f00;font-style:italic">
</span><span style="color:#f00;font-style:italic"></span>
</code></pre></div><h1 id="补丁的解释">补丁的解释</h1>
<p>该补丁很简单，主要做了四方面的事情：</p>
<h2 id="增加了一个帮助信息">增加了一个帮助信息</h2>
<p>增加了一个reneg-second n，其中n指的是第二阶段重新协商的间隔。</p>
<h2 id="增加了一个新的状态s_k">增加了一个新的状态S_k</h2>
<p>如果需要进行第二阶段的密钥协商，那么将本地session状态设置为S_K，其实这个状态等同于S_PRE_START，并且将其命令码设置为P_CONTROL_SOFT_RESET_SECOND，然后由server端发起协商请求，而由client收到P_CONTROL_SOFT_RESET_SECOND操作码时执行协商，如果client拒不执行，那么must-die机制将其断开。</p>
<h2 id="增加了一个新的操作码p_control_soft_reset_second">增加了一个新的操作码P_CONTROL_SOFT_RESET_SECOND</h2>
<p>client端收到这个操作码时，执行第二阶段协商，如果它不执行，server会在一定时间之后将其断开</p>
<h2 id="对free操作进行了修改">对FREE操作进行了修改</h2>
<p>我们知道，在修改后，多个key state可能公用一个SSL session，在原生的OpenVPN中，SSL session和key state是一对一的，只要重新协商，必然要重新初始化ks state，为了简单，TM_SIZE个session也将退化为一个，因此在这种情况下断开client的时候-PING(并不是icmp的ping)超时或者出现错误或者client主动断开或者server退出等，在FREE相关数据结构的时候，如果不谨慎操作就会出现段错误或者double free，因此在FREE的时候，用tm_size和ks_size代替了TM_SIZE和KS_SIZE，其中tm_size和ks_size分别加到了tls_multi和tls_session结构体中。</p>
<h2 id="命名问题">命名问题</h2>
<p>本patch的命名极不规范，像reset2之类的&hellip;</p>
<h1 id="总结">总结</h1>
<p>经过修改，OpenVPN再也不会因为重新协商密钥而重新推送策略，导致传输抖动&hellip;了，经过测试，它还真的很不错。这个修改起初仅仅有个想法，只因为看了IKE的标准，但是随后进行的修改并不顺利，那是因为我使用了push/pull机制在控制通道里进行协商通知，然而由于OpenVPN的session以及key管理机制太过复杂，因此必然需要修改大量的代码，那么为何不仿造OpenVPN的现有协议在其本身的协商机制中做个扩展呢？通过看代码，OpenVPN本身的握手协商过程使用的状态机也是在控制通道传输数据进行通知的，只需要增加一个通知消息即可，很简单，这就是返璞归真，然而前提是你必须对OpenVPN原有的机制很熟悉。</p>

    </div>
    <footer class="post-footer">
     
 
<div class="post-tags">     
     
    <a href="http://shanks.link/tags/openvpn" rel="tag" title="openvpn">#openvpn#</a>
    
</div>



     <div class="post-nav">
    <div class="post-nav-next post-nav-item">
    
        <a href="http://shanks.link/blog/2022/07/13/changed-timezone-ubuntu/" rel="next" title="Changed Timezone Ubuntu">
        <i class="fa fa-chevron-left"></i> Changed Timezone Ubuntu
        </a>
    
    </div>

    <div class="post-nav-prev post-nav-item">
    
        <a href="http://shanks.link/blog/2022/07/12/openvp%E6%80%A7%E8%83%BD-%E5%BD%93tap%E9%81%87%E5%88%B0bonding/" rel="prev" title="OpenVP性能 当tap遇到bonding">
        OpenVP性能 当tap遇到bonding <i class="fa fa-chevron-right"></i>
        </a>
    
    </div>
</div>
      
     
     
     





<script src="https://utteranc.es/client.js"
        repo="shankusu2017@gmail.com/"
        issue-term="pathname"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>
<noscript>Please enable JavaScript to view the <a href="https://github.com/utterance">comments powered by utterances.</a></noscript>

    </footer>
  </article>
</section>

          </div>
        </div>
        <div class="sidebar-toggle">
  <div class="sidebar-toggle-line-wrap">
    <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
    <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
    <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
  </div>
</div>
<aside id="sidebar" class="sidebar">
  <div class="sidebar-inner">

    <section class="site-overview sidebar-panel  sidebar-panel-active ">
      <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image"
        src="http://shanks.link/img/logo.jpg"
        alt="shankusu2017@gmail.com" />
    <p class="site-author-name" itemprop="name">shankusu2017@gmail.com</p>
    <p class="site-description motion-element" itemprop="description"> </p>
</div>
      <nav class="site-state motion-element">
    <div class="site-state-item site-state-posts">
      <a href="http://shanks.link/post/">
        <span class="site-state-item-count">503</span>
        <span class="site-state-item-name">日志</span>
      </a>
    </div>
    <div class="site-state-item site-state-categories">    
        <a href="http://shanks.link/categories/">      
         
        <span class="site-state-item-count">34</span>
        
        <span class="site-state-item-name">分类</span>
        
        </a>
    </div>

    <div class="site-state-item site-state-tags">
        <a href="http://shanks.link/tags/">
         
        <span class="site-state-item-count">39</span>
        
        <span class="site-state-item-name">标签</span>
        </a>
    </div>
</nav>
      
      
<div class="links-of-author motion-element">
    
        <span class="links-of-author-item">
        <a href="https://github.com/shankusu2017" target="_blank" title="GitHub">
            <i class="fa fa-fw fa-github"></i>
            GitHub
        </a>
        </span>
    
</div>


      

      <div class="links-of-blogroll motion-element inline">
<script type="text/javascript" src="//rf.revolvermaps.com/0/0/8.js?i=5b4f2ucxar6&amp;m=0&amp;s=220&amp;c=ff0000&amp;cr1=ffffff&amp;f=arial&amp;l=33&amp;bv=35" async="async"></script>
</div>

    </section>
    
  </div>
</aside>

      </div>
    </main>
   
    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  <span itemprop="copyrightYear">  &copy; 
  2009 - 2023</span>
</div>
<div>
  <a href="https://beian.miit.gov.cn/" rel="noopener" target="_blank">粤ICP备2021068940号-1</a>
  <a href="https://www.beian.gov.cn/portal/registerSystemInfo?recordcode=44011302003059" rel="noopener" target="_blank">粤公网安备44011302003059</a>
</div>


      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
      <span id="scrollpercent"><span>0</span>%</span>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>
<script type="text/javascript" src="http://shanks.link/js/vendor/jquery/index.js?v=2.1.3"></script>
<script type="text/javascript" src="http://shanks.link/js/vendor/fastclick/lib/fastclick.min.js?v=1.0.6"></script> 
<script type="text/javascript" src="http://shanks.link/js/vendor/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
<script type="text/javascript" src="http://shanks.link/js/vendor/velocity/velocity.min.js?v=1.2.1"></script>
<script type="text/javascript" src="http://shanks.link/js/vendor/velocity/velocity.ui.min.js?v=1.2.1"></script>
<script src="http://shanks.link/js/vendor/ua-parser-js/dist/ua-parser.min.js?v=0.7.9"></script>

<script src="http://shanks.link/js/vendor/fancybox/jquery.fancybox.pack.js?v=2.1.5"></script>

<script type="text/javascript" src="http://shanks.link/js/utils.js"></script>
<script type="text/javascript" src="http://shanks.link/js/motion.js"></script>
<script type="text/javascript" src="http://shanks.link/js/affix.js"></script>
<script type="text/javascript" src="http://shanks.link/js/schemes/pisces.js"></script>

<script type="text/javascript" src="http://shanks.link/js/scrollspy.js"></script>
<script type="text/javascript" src="http://shanks.link/js/post-details.js"></script>
<script type="text/javascript" src="http://shanks.link/js/toc.js"></script>

<script type="text/javascript" src="http://shanks.link/js/bootstrap.js"></script>

<script type="text/javascript" src="http://shanks.link/js/search.js"></script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX", "output/HTML-CSS"],
    tex2jax: {
      inlineMath: [ ['$','$'] ],
      displayMath: [ ['$$','$$'] ],
      processEscapes: true
    },
    "HTML-CSS": { fonts: ["TeX"] }
  });
</script>
<script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML' async></script>
</body>
</html>