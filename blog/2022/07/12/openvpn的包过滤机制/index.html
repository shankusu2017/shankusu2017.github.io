<!DOCTYPE HTML>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" /> 
    <title>OpenVPN的包过滤机制 - 愿星光伴你左右</title>
    <meta name="keywords" content="git,Git,Lua,lua,Golang,go">
    
    <meta property="og:title" content="OpenVPN的包过滤机制">
    <meta property="og:site_name" content="愿星光伴你左右">
    <meta property="og:image" content="/img/author.jpg"> 
    <meta name="title" content="OpenVPN的包过滤机制 - 愿星光伴你左右" />
    <meta name="description" content="愿星光伴你左右"> 
    <link rel="shortcut icon" href="http://shanks.link/img/favicon.ico" />
    <link rel="apple-touch-icon" href="http://shanks.link/img/apple-touch-icon.png" />
    <link rel="apple-touch-icon-precomposed" href="http://shanks.link/img/apple-touch-icon.png" />
    <link href="http://shanks.link/js/vendor/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />
    <link href="http://shanks.link/js/vendor/fancybox/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />
    <link href="http://shanks.link/css/main.css" rel="stylesheet" type="text/css" />
    <link href="http://shanks.link/css/syntax.css" rel="stylesheet" type="text/css" />
    <script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post"},
     fancybox: true, 
    motion: true
  };
</script>
</head>
<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">
<div class="container one-collumn sidebar-position-left page-home  ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"> <div class="site-meta  custom-logo ">

  <div class="custom-logo-site-title">
    <a href="http://shanks.link/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">愿星光伴你左右</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle"></p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
    <ul id="menu" class="menu">
      
      
        <li class="menu-item ">
          <a href="http://shanks.link/post/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />首页
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/thinking/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />随想录
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/prose/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />散文
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/%E7%94%9F%E6%B4%BB/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />生活
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/os/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />OS
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/lua/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />lua
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/redis/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />redis
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/go/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />Golang
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/openvpn/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />OpenVPN
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/%E8%BF%90%E7%BB%B4/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />运维
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/git/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />Git
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/it/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />IT杂谈
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/about/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />About Me
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/links/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />友情链接
          </a>
        </li>
      
      <li class="menu-item menu-item-search">
        <a href="javascript:;" class="popup-trigger"> <i class="menu-item-icon fa fa-search fa-fw"></i> <br /> 搜索</a>
      </li>
    </ul>
    <div class="site-search">
      <div class="popup">
 <span class="search-icon fa fa-search"></span>
 <input type="text" id="local-search-input">
 <div id="local-search-result"></div>
 <span class="popup-btn-close">close</span>
</div>

    </div>
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
<section id="posts" class="posts-expand">
  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <header class="post-header">
      <h1 class="post-title" itemprop="name headline">
        <a class="post-title-link" href="http://shanks.link/blog/2022/07/12/openvpn%E7%9A%84%E5%8C%85%E8%BF%87%E6%BB%A4%E6%9C%BA%E5%88%B6/" itemprop="url">
        OpenVPN的包过滤机制
        </a>
      </h1>
      <div class="post-meta">
      <span class="post-time">
<span class="post-meta-item-icon">
    <i class="fa fa-calendar-o"></i>
</span>
<span class="post-meta-item-text">时间：</span>
<time itemprop="dateCreated" datetime="2016-03-22T13:04:35+08:00" content="2022-07-12">
    2022-07-12
</time>
</span> 
      

  <span class="post-category" >
  &nbsp; | &nbsp;
  <span class="post-meta-item-icon">
    <i class="fa fa-folder-o"></i>
  </span>
  <span class="post-meta-item-text">分类：</span>
  
    <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
      <a href="http://shanks.link/categories/openvpn" itemprop="url" rel="index">
        <span itemprop="name">openvpn</span>
      </a>
      &nbsp; 
    </span>
  
</span>


       <span>
&nbsp; | &nbsp;
<span class="post-meta-item-icon">
    <i class="fa fa-eye"></i>
</span>
<span class="post-meta-item-text">阅读：</span>
<span class="leancloud-visitors-count">4720 字 ~10分钟</span>
</span>
      </div>
    </header>
    <div class="post-body" itemprop="articleBody">
    <p>OpenVPN是和网络结合的非常紧密的一款VPN，事实上，每一个VPN框架都和IP网络结合的很紧密，因此在此首先劝一下那些想搞VPN的朋友们，一定要先彻底精通TCP/IP网络协议栈，特别是IP路由，防火墙原理之后再去啃OpenVPN或者其它的VPN，否则会事倍功半的，仅仅看懂源代码和灵活配置，灵活运用，灵活定制之间的差距和很远，精通VPN远远不是会写C代码会使用哈希表就能应付得了的。</p>
<p>OpenVPN中内置了包过滤机制。这个机制一般由ENABLE_PF这个宏括起来。一般而言，很少有人去用这个功能，更别提去修改定制了，这是因为，对于可以将数据包打入虚拟网卡从而进入系统网络协议栈的VPN框架，很多的过滤功能都可以用操作系统的包过滤来完成，对于Linux而言，首选的就是iptables了。本文简要介绍OpenVPN的内部包过滤机制以及简单的定制。</p>
<h1 id="openvpn包过滤的设计">OpenVPN包过滤的设计</h1>
<p>作为一个用户态的VPN框架，OpenVPN支持多种配置模式，它要么是一台虚拟的交换机，要么是一台虚拟的路由器。既然OpenVPN可以虚拟出这样的设备来，那么这些设备的功能OpenVPN要能简要模拟。对于路由功能，OpenVPN支持了内部路由，而对于包过滤功能，OpenVPN支持了内部packet filter。</p>
<h1 id="运行起来以及原理">运行起来以及原理</h1>
<p>要使用OpenVPN的包过滤，其实还真的不是那么简单，首先你要了解包过滤配置文件的格式。</p>
<h2 id="包过滤配置文件格式">包过滤配置文件格式</h2>
<p>OpenVPN的包过滤策略由配置文件或者buffer来指定，本文只介绍配置文件的基于IP子网的过滤方式(不考虑基于证书CN项的过滤)。格式如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>[SUBNETS DROP<span style="color:#f92672">|</span>ACCEPT]
</span></span><span style="display:flex;"><span><span style="color:#f92672">+|-</span>IP地址<span style="color:#f92672">/</span><span style="color:#960050;background-color:#1e0010">掩码位</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">…</span>
</span></span><span style="display:flex;"><span>[END]
</span></span></code></pre></div><p>其中[SUBNETS …]指示了段的开始，而[END]指示了其结束。SUBNETS后面跟上默认的策略，ACCEPT或者DROP，以下就是正文，正文的开头必须由+号或者-号标示，后面跟上标准的IP地址/掩码的格式，+号表示可以通过，-号表示不可以通过，就这么简单。具体可以看一下OpenVPN源码目录下的management/management-notes.txt文件中的相关介绍，令我不解的是，为何将统一的包过滤功能置于management这个管理接口相关的目录下。</p>
<h2 id="配置tmp目录定义plugin">配置tmp目录/定义plugin</h2>
<p>以上2.1节说的配置文件需要放置在一个特定的临时目录下，说它临时是因为里面的文件是OpenVPN自己动态创建的，等OpenVPN退出之后，里面的文件会被删除。这么说来上述2.1节中的文件也是OpenVPN动态创建的了？是的，正是这样。OpenVPN动态创建了这个文件，然后你可以编辑这个文件，添加进去一些策略规则，OpenVPN定时监控这个文件是否被修改，若被修改则重新根据文件内容加载包过滤策略规则。至于说这些在OpenVPN中是怎么实现的，看代码就好了，很简单的</p>
<p>因此，你只需要配置&ndash;tmp-dir dir即可，其中dir是你的临时目录路径。另外一件需要做的事就是编写一个plugin，有了它就可以在plugin中建立包过滤配置文件和外部程序的关联从而动态为包过滤配置文件添加策略规则了，否则的话，你手工修改这个包过滤配置文件也可以，当然这只能达到实验的目的，现实中使用时都是基于plugin来做的。我们可以看看下面的代码：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">pf_init_context</span> (<span style="color:#66d9ef">struct</span> context <span style="color:#f92672">*</span>c) {
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">struct</span> gc_arena gc <span style="color:#f92672">=</span> gc_new ();
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (plugin_defined (c<span style="color:#f92672">-&gt;</span>plugins, OPENVPN_PLUGIN_ENABLE_PF)) {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//创建临时文件
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>              <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>pf_file <span style="color:#f92672">=</span> create_temp_file (c<span style="color:#f92672">-&gt;</span>options.tmp_dir, <span style="color:#e6db74">&#34;pf&#34;</span>, <span style="color:#f92672">&amp;</span>gc);
</span></span><span style="display:flex;"><span>              <span style="color:#66d9ef">if</span>( pf_file ) {
</span></span><span style="display:flex;"><span>                    setenv_str (c<span style="color:#f92672">-&gt;</span>c2.es, <span style="color:#e6db74">&#34;pf_file&#34;</span>, pf_file);
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> (plugin_call (c<span style="color:#f92672">-&gt;</span>plugins, OPENVPN_PLUGIN_ENABLE_PF,
</span></span><span style="display:flex;"><span>NULL, NULL, c<span style="color:#f92672">-&gt;</span>c2.es) <span style="color:#f92672">==</span> OPENVPN_PLUGIN_FUNC_SUCCESS) {
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">//初始化定时器，此后定时监控文件变化
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                        event_timeout_init (<span style="color:#f92672">&amp;</span>c<span style="color:#f92672">-&gt;</span>c2.pf.reload, <span style="color:#ae81ff">1</span>, now);
</span></span><span style="display:flex;"><span>                        c<span style="color:#f92672">-&gt;</span>c2.pf.filename <span style="color:#f92672">=</span> string_alloc (pf_file, NULL);
</span></span><span style="display:flex;"><span>                        c<span style="color:#f92672">-&gt;</span>c2.pf.enabled <span style="color:#f92672">=</span> true;
</span></span><span style="display:flex;"><span>                  }
</span></span><span style="display:flex;"><span>    <span style="color:#960050;background-color:#1e0010">…</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>因此，我们需要写一个plugin，侦听OPENVPN_PLUGIN_ENABLE_PF事件，然后在其func函数中创建包过滤配置文件和外部程序的关联，本文只是实验，因此什么都没有做，全部手工修改添加策略规则。</p>
<h2 id="理解在哪里执行包过滤">理解在哪里执行包过滤</h2>
<p>一般而言，我们使用server模式，因此肯定是multi.c里面执行了，而且是在multi.c中的 multi_process_incoming_link函数中执行：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (c<span style="color:#f92672">-&gt;</span>c2.to_tun.len <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">!</span>pf_addr_test (c, <span style="color:#f92672">&amp;</span>edest, <span style="color:#e6db74">&#34;tap_dest_addr&#34;</span>)) {
</span></span><span style="display:flex;"><span>                          msg (D_PF_DROPPED, <span style="color:#e6db74">&#34;PF: client -&gt; addr[%s] packet dropped by TAP packet filter&#34;</span>,
</span></span><span style="display:flex;"><span>                               mroute_addr_print_ex (<span style="color:#f92672">&amp;</span>edest, MAPF_SHOW_ARP, <span style="color:#f92672">&amp;</span>gc));
</span></span><span style="display:flex;"><span>                          c<span style="color:#f92672">-&gt;</span>c2.to_tun.len <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>主要由pf_addr_test来执行基于IP子网的包过滤。其实现在pf.c文件中。注意，哪怕是TAP模式的VPN，在开启包过滤宏的情况下，也要解析出载荷的目标IP地址用于包过滤。</p>
<p>pf_addr_test的实现非常之简单，就是一下的循环：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">while</span> (se) {             
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> ((addr <span style="color:#f92672">&amp;</span> se<span style="color:#f92672">-&gt;</span>rule.netmask) <span style="color:#f92672">==</span> se<span style="color:#f92672">-&gt;</span>rule.network) {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// exclude由+号或者-号决定
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">return</span> <span style="color:#f92672">!</span>se<span style="color:#f92672">-&gt;</span>rule.exclude;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>          se <span style="color:#f92672">=</span> se<span style="color:#f92672">-&gt;</span>next;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">…</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">//由[…]里面的ACCEPT或者DROP决定
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">return</span> pfs<span style="color:#f92672">-&gt;</span>sns.default_allow;
</span></span></code></pre></div><p>一切就是这么简单！</p>
<h2 id="具体效果">具体效果</h2>
<p>理解了原理，看效果就简单了，配置了tmp-dir为/var/vpn/tmp，然后以172.16.0.0/16为虚拟子网启动OpenVPN服务器，在/var/vpn/tmp下面有个文件: openvpn_pf_3758e76a5d04078a35c900e32aa25d08.tmp 注意，乱七八糟的名字是故意这么生成的，使用了随机数的原理。我手工编辑了这个文件加入：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>[SUBNETS DROP]
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span><span style="color:#ae81ff">172.16.0.0</span><span style="color:#f92672">/</span><span style="color:#ae81ff">16</span>
</span></span><span style="display:flex;"><span>[END]
</span></span></code></pre></div><p>之后只有访问这个虚拟子网内的主机才可以，其它的全部丢弃。…</p>
<h2 id="定制细粒度的包过滤">定制细粒度的包过滤</h2>
<p>OpenVPN原生实现的包过滤只是粗粒度的基于IP子网的过滤，但是我们知道，任何操作系统的哪怕最原始的防火墙都是根据起码第四层的协议数据进行过滤，比如TCP或者UDP的端口，比如禁止ICMP等等，要怎样才能实现这样呢？事实上当我们理解了OpenVPN的包过滤原理之后，实现这个一点难度都没有。关键是在实现之前要先定义好接口，这个也不难，只是在+a.b.c.d/e之后再加上协议和端口信息即可，我的垃圾实现是：+a.b.c.d/e:协议号|目的端口号，紧接着在解析包过滤配置文件的时候增加对协议和端口的解析，并且在ipv4_subnet结构体中增加协议和端口的字段。最后在pf_addr_test中这么实现：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span> <span style="color:#66d9ef">if</span> (pfs <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">!</span>pfs<span style="color:#f92672">-&gt;</span>kill) {
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">const</span> in_addr_t addr <span style="color:#f92672">=</span> in_addr_t_from_mroute_addr (dest);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#66d9ef">struct</span> pf_subnet <span style="color:#f92672">*</span>se <span style="color:#f92672">=</span> pfs<span style="color:#f92672">-&gt;</span>sns.list;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#66d9ef">struct</span> openvpn_iphdr <span style="color:#f92672">*</span>pip;
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">int</span> ipoff <span style="color:#f92672">=</span> (tunnel_type <span style="color:#f92672">==</span> DEV_TYPE_TAP)<span style="color:#f92672">?</span><span style="color:#66d9ef">sizeof</span>(<span style="color:#66d9ef">struct</span> openvpn_ethhdr)<span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//不考虑变长的IP协议头
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#66d9ef">int</span> tloff <span style="color:#f92672">=</span> ipoff <span style="color:#f92672">+</span> <span style="color:#66d9ef">sizeof</span>(<span style="color:#66d9ef">struct</span> openvpn_iphdr);
</span></span><span style="display:flex;"><span>            verify_align_4 (buf);
</span></span><span style="display:flex;"><span>            pip <span style="color:#f92672">=</span> (<span style="color:#66d9ef">struct</span> openvpn_iphdr <span style="color:#f92672">*</span>)(BPTR (buf)<span style="color:#f92672">+</span>ipoff);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">uint8_t</span> proto <span style="color:#f92672">=</span> pip<span style="color:#f92672">-&gt;</span>protocol;
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">uint16_t</span> dport;
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (proto <span style="color:#f92672">==</span> OPENVPN_IPPROTO_TCP) {
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">struct</span> openvpn_tcphdr <span style="color:#f92672">*</span>ptcp <span style="color:#f92672">=</span> (<span style="color:#66d9ef">struct</span> openvpn_tcphdr<span style="color:#f92672">*</span>)(BPTR(buf)<span style="color:#f92672">+</span>tloff);
</span></span><span style="display:flex;"><span><span style="color:#75715e">//对于TCP的后续数据，直接通过，因为没有syn的通过，就不会有后续的数据
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>(ptcp<span style="color:#f92672">-&gt;</span>flags <span style="color:#f92672">&amp;</span> OPENVPN_TCPH_SYN_MASK))
</span></span><span style="display:flex;"><span>                                <span style="color:#66d9ef">return</span> true;
</span></span><span style="display:flex;"><span>                    dport <span style="color:#f92672">=</span> ntohs(ptcp<span style="color:#f92672">-&gt;</span>dest);
</span></span><span style="display:flex;"><span>} <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (proto <span style="color:#f92672">==</span> OPENVPN_IPPROTO_UDP) {
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">…</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">while</span> (se) {
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (((addr <span style="color:#f92672">&amp;</span> se<span style="color:#f92672">-&gt;</span>rule.netmask) <span style="color:#f92672">==</span> se<span style="color:#f92672">-&gt;</span>rule.network) <span style="color:#f92672">&amp;&amp;</span>
</span></span><span style="display:flex;"><span>se<span style="color:#f92672">-&gt;</span>rule.proto <span style="color:#f92672">==</span> proto <span style="color:#f92672">&amp;&amp;</span> se<span style="color:#f92672">-&gt;</span>rule.dport <span style="color:#f92672">==</span> dport) {
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">…</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">…</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">return</span> pfs<span style="color:#f92672">-&gt;</span>sns.default_allow;
</span></span></code></pre></div><p>这样就可以实现和iptables一样的策略规则了，虽然还不支持其它的match，而且配置文件显得很是奇怪，然而这已经足够了。</p>
<p>OpenVPN的包过滤机制对性能是有些影响，使本来性能就不是很好的OpenVPN更是雪上加霜，然而功能的实现总是要付出些性能代价的，就连Cisco如此凶猛的家伙都是这样。</p>
<h2 id="基于用户的包过滤">基于用户的包过滤</h2>
<p>所谓的internal packet filter和internal route是一样的，就是工作在OpenVPN内部的一个过滤机制，它的主要作用在于限制client-to-client之间的通信，因为client-to-client之间的通信完全是在内部被路由的，外部的系统路由在这里起不到作用的。client-to-client之间的通信过滤完全是OpenVPN内部进行的。</p>
<p>关于OpenVPN内部包过滤机制的文档真的特别少，少之又少，好不容易才在网上找了一篇，加上我自己的这篇，基本够操作了。因此我把那篇文章（《OpenVPN’s built-in packet filter》）大致意思总结了一下： OpenVPN提供了一种内部的包过滤机制来限制client-to-client之间的通信。总的来讲，每一个client都会有一个过滤规则集，限制该client允许或者不允许访问的其它用户以及IP网段。那篇文章给出一个场景，一共四个人，分别是john，nick，bob，max，这四个人接入在同一个使能client-to-client的OpenVPN服务器上，然而需求是他们之间的互相访问是被严格控制的。下面的表格显示了他们之间相互访问的规则，yes代表可以访问，no代表不可以访问：</p>
<p><img src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2018/12/14/167abf7420c1e25b~tplv-t2oaga2asx-zoom-in-crop-mark:3024:0:0:0.awebp" alt="img"></p>
<p>根据前面个小节的分析，看懂下面的配置文件应该不成问题，只是将IP网段换成了client证书的CN项，注意为了避免混乱，请在启动OpenVPN服务器时不要使用duplicate-cn选项。下面是各个用户的配置文件，看完配置文件后，我们再看看这些配置文件中的规则是怎么样配置到各个用户的：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">$</span> cat <span style="color:#f92672">/</span>etc<span style="color:#f92672">/</span>openvpn<span style="color:#f92672">/</span>john.pf 
</span></span><span style="display:flex;"><span>[CLIENTS DROP] 
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>nick 
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>bob 
</span></span><span style="display:flex;"><span>[SUBNETS ACCEPT] 
</span></span><span style="display:flex;"><span>[END] 
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">$</span> cat <span style="color:#f92672">/</span>etc<span style="color:#f92672">/</span>openvpn<span style="color:#f92672">/</span>nick.pf 
</span></span><span style="display:flex;"><span>[CLIENTS DROP] 
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>john 
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>max 
</span></span><span style="display:flex;"><span>[SUBNETS ACCEPT] 
</span></span><span style="display:flex;"><span>[END] 
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">$</span> cat <span style="color:#f92672">/</span>etc<span style="color:#f92672">/</span>openvpn<span style="color:#f92672">/</span>bob.pf 
</span></span><span style="display:flex;"><span>[CLIENTS DROP] 
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>john 
</span></span><span style="display:flex;"><span>[SUBNETS ACCEPT] 
</span></span><span style="display:flex;"><span>[END] 
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">$</span> cat <span style="color:#f92672">/</span>etc<span style="color:#f92672">/</span>openvpn<span style="color:#f92672">/</span>max.pf 
</span></span><span style="display:flex;"><span>[CLIENTS DROP] 
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>nick 
</span></span><span style="display:flex;"><span>[SUBNETS ACCEPT] 
</span></span><span style="display:flex;"><span>[END]
</span></span></code></pre></div><p>那么这些配置文件如何和具体用户关联呢？实际上在每个用户接入到VPN服务器的时候都会调用pf_init_context函数，该函数和pf相关的大体如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">void</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">pf_init_context</span> (<span style="color:#66d9ef">struct</span> context <span style="color:#f92672">*</span>c)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">struct</span> gc_arena gc <span style="color:#f92672">=</span> gc_new ();
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (plugin_defined (c<span style="color:#f92672">-&gt;</span>plugins, OPENVPN_PLUGIN_ENABLE_PF)) {
</span></span><span style="display:flex;"><span>              <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>pf_file <span style="color:#f92672">=</span> create_temp_file <span style="color:#960050;background-color:#1e0010">…</span>
</span></span><span style="display:flex;"><span>              <span style="color:#66d9ef">if</span>( pf_file ) {
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">//将临时文件名称设置成环境变量很关键
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                    setenv_str (c<span style="color:#f92672">-&gt;</span>c2.es, <span style="color:#e6db74">&#34;pf_file&#34;</span>, pf_file);
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">if</span> (plugin_call (c<span style="color:#f92672">-&gt;</span>plugins, <span style="color:#960050;background-color:#1e0010">…</span>) {
</span></span><span style="display:flex;"><span>                            <span style="color:#960050;background-color:#1e0010">…</span>            
</span></span><span style="display:flex;"><span>} <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>                            <span style="color:#75715e">//disable packet filter
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>           }
</span></span><span style="display:flex;"><span>         }
</span></span><span style="display:flex;"><span>    <span style="color:#960050;background-color:#1e0010">…</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>这样，每一个用户就都有了一个值为pf临时文件名的环境变量，当调用client-connect脚本或者plugin的时候，这个环境变量就大大的有用了，请看下面的client-connect脚本：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">#!/bin/sh  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"># /etc/openvpn/client-connect.sh: sample client-connect script using pf rule files  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"># rules template file
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>template<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;/etc/openvpn/${common_name}.pf&#34;</span>  
</span></span><span style="display:flex;"><span><span style="color:#75715e"># create the file OpenVPN wants with the rules for this client
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">if</span> [ <span style="color:#f92672">-</span>f <span style="color:#e6db74">&#34;$template&#34;</span> ] <span style="color:#f92672">&amp;&amp;</span> [ <span style="color:#f92672">!</span> <span style="color:#f92672">-</span>z <span style="color:#e6db74">&#34;$pf_file&#34;</span> ]; then   
</span></span><span style="display:flex;"><span>    cp <span style="color:#f92672">--</span> <span style="color:#e6db74">&#34;$template&#34;</span> <span style="color:#e6db74">&#34;$pf_file&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">else</span>   
</span></span><span style="display:flex;"><span>    <span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#66d9ef">if</span> anything is not as expected, fail   
</span></span><span style="display:flex;"><span>    exit <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>fi
</span></span></code></pre></div><p>这个脚本就是为这些环境变量指示的pf策略规则集文件填值的，填什么值呢？填上述的配置文件啊。到此为止，功能就实现了。</p>
<p>那么那个plugin仅仅是为了传输那个配置文件么？其实不应该是那样的啊，以下是我昨晚写的一个plugin，那时我还没有看到这篇<a href="https://link.juejin.cn/?target=http%3A%2F%2Fbackreference.org%2F2010%2F06%2F18%2Fopenvpns-built-in-packet-filter%2F">《OpenVPN’s built-in packet filter》</a>：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">struct</span> plugin_context {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">char</span> name[<span style="color:#ae81ff">1</span>];
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>OPENVPN_EXPORT openvpn_plugin_handle_t
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">openvpn_plugin_open_v1</span> (<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span> <span style="color:#f92672">*</span>type_mask, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>argv[], <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>envp[])
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">struct</span> plugin_context <span style="color:#f92672">*</span>context;
</span></span><span style="display:flex;"><span>            context <span style="color:#f92672">=</span> (<span style="color:#66d9ef">struct</span> plugin_context <span style="color:#f92672">*</span>) calloc (<span style="color:#ae81ff">1</span>, <span style="color:#66d9ef">sizeof</span> (<span style="color:#66d9ef">struct</span> plugin_context));
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">*</span>type_mask <span style="color:#f92672">=</span>OPENVPN_PLUGIN_MASK(OPENVPN_PLUGIN_ENABLE_PF);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> (openvpn_plugin_handle_t) context;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>OPENVPN_EXPORT <span style="color:#66d9ef">int</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">openvpn_plugin_func_v1</span> (openvpn_plugin_handle_t handle, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">int</span> type, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>argv[], <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>envp[])
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">struct</span> plugin_context <span style="color:#f92672">*</span>context <span style="color:#f92672">=</span> (<span style="color:#66d9ef">struct</span> plugin_context <span style="color:#f92672">*</span>) handle;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">return</span> OPENVPN_PLUGIN_FUNC_SUCCESS;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>OPENVPN_EXPORT <span style="color:#66d9ef">void</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">openvpn_plugin_close_v1</span> (openvpn_plugin_handle_t handle)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">struct</span> plugin_context <span style="color:#f92672">*</span>context <span style="color:#f92672">=</span> (<span style="color:#66d9ef">struct</span> plugin_context <span style="color:#f92672">*</span>) handle;
</span></span><span style="display:flex;"><span>      free (context);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>虽然什么也没有做，然而这是必须的。实际上应该在这个plugin里面做更多事的，比如通知外部程序，比如设置和外部程序的联动等等。而且我也知道，如果不返回FUNC_SUCCESS，那么将禁用该用户的packet filter，很显然在plugin中应该判断是否针对这个用户进行filter，然而调用plugin的时候，此用户的instance刚刚建立，证书还没有提交呢，什么信息都没有，这就导致没什么事情可做。今天看了这篇文章后，那哥们也写了一个plugin，如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">/* dummy context, as we need no state */</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">struct</span> plugin_context {   
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> dummy;
</span></span><span style="display:flex;"><span>};  
</span></span><span style="display:flex;"><span><span style="color:#75715e">/* Initialization function */</span>
</span></span><span style="display:flex;"><span>OPENVPN_EXPORT openvpn_plugin_handle_t <span style="color:#a6e22e">openvpn_plugin_open_v1</span> (    <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span> <span style="color:#f92672">*</span>type_mask,
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>argv[],
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>envp[])
</span></span><span style="display:flex;"><span>{   
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">struct</span> plugin_context <span style="color:#f92672">*</span>context;   
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/* Allocate our context */</span>   
</span></span><span style="display:flex;"><span>    context <span style="color:#f92672">=</span> (<span style="color:#66d9ef">struct</span> plugin_context <span style="color:#f92672">*</span>)
</span></span><span style="display:flex;"><span>            calloc (<span style="color:#ae81ff">1</span>, <span style="color:#66d9ef">sizeof</span> (<span style="color:#66d9ef">struct</span> plugin_context));    <span style="color:#75715e">/* Which callbacks to intercept. */</span>   
</span></span><span style="display:flex;"><span><span style="color:#f92672">*</span>type_mask <span style="color:#f92672">=</span> OPENVPN_PLUGIN_MASK (OPENVPN_PLUGIN_ENABLE_PF);    <span style="color:#66d9ef">return</span> (openvpn_plugin_handle_t) context;
</span></span><span style="display:flex;"><span>}  
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#75715e">/* Worker function */</span>
</span></span><span style="display:flex;"><span>OPENVPN_EXPORT <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">openvpn_plugin_func_v2</span> (
</span></span><span style="display:flex;"><span>        openvpn_plugin_handle_t handle,             
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">int</span> type,             
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>argv[],             
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>envp[],             
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>per_client_context,             
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">struct</span> openvpn_plugin_string_list <span style="color:#f92672">**</span>return_list) {    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (type <span style="color:#f92672">==</span> OPENVPN_PLUGIN_ENABLE_PF) {     
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> OPENVPN_PLUGIN_FUNC_SUCCESS;   
</span></span><span style="display:flex;"><span>    } <span style="color:#66d9ef">else</span> {     <span style="color:#75715e">/* should not happen! */</span>     
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> OPENVPN_PLUGIN_FUNC_ERROR;   
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}  
</span></span><span style="display:flex;"><span><span style="color:#75715e">/* Cleanup function */</span>
</span></span><span style="display:flex;"><span>OPENVPN_EXPORT <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">openvpn_plugin_close_v1</span> (
</span></span><span style="display:flex;"><span>        openvpn_plugin_handle_t handle)
</span></span><span style="display:flex;"><span>{   
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">struct</span> plugin_context <span style="color:#f92672">*</span>context <span style="color:#f92672">=</span> (<span style="color:#66d9ef">struct</span> plugin_context <span style="color:#f92672">*</span>) handle;   
</span></span><span style="display:flex;"><span>    free (context);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>除了代码比我的更规范，多了注释之外，没有什么不同的。而且作者说：The fact that the worker function is invoked at client connection and then is re-invoked periodically makes it possible to dynamically change or disable the filtering policy for a client (OpenVPN will re-read the rule file if it changes); in our example we just return success always.</p>
<p>我没有看出OpenVPN在对这个plugin re-invoked periodically了。实际上真的应该周期调用它的，正如作者所说。</p>
<p>看了这篇《OpenVPN’s built-in packet filter》我发现自己遇到了知音，行文的风格我们太像了，我也自恋一把，跟人家套套近乎…不管怎么说，OpenVPN的packet filter机制是基于每用户，这种灵活性真的太有用了，只是是不是在client-connect这个HOOK点创建这个pf临时文件更好些呢？此时可以得到用户的所有信息，可以在plugin中决定是否对这个用户开启pf，而且还可直接将针对用户的规则集填入到那个pf临时文件中。我实在想不通OpenVPN的开发者为何用现有的方式来实现这么有用的机制…</p>
<h1 id="总结">总结</h1>
<p>总的来讲，OpenVPN的包过滤机制实现的很是恰到好处，使得OpenVPN作为一个用户态的VPN框架能够和系统的路由以及包过滤独立开来。然而美中不足的是，它的配置有些奇怪，甚至有些复杂。</p>
<p><a href="https://juejin.cn/post/6844903737551503374">以上内容转载自笑叶林的blog</a></p>

    </div>
    <footer class="post-footer">
     
 
<div class="post-tags">     
     
    <a href="http://shanks.link/tags/openvpn" rel="tag" title="openvpn">#openvpn#</a>
    
</div>



     <div class="post-nav">
    <div class="post-nav-next post-nav-item">
    
        <a href="http://shanks.link/blog/2022/07/12/openvpn%E9%AB%98%E7%BA%A7%E8%B7%AF%E7%94%B1%E6%8A%80%E6%9C%AF-%E8%99%9A%E6%8B%9F%E4%BA%A4%E6%8D%A2%E6%9C%BA%E5%92%8C%E5%86%85%E9%83%A8%E8%B7%AF%E7%94%B1%E7%BC%93%E5%AD%98/" rel="next" title="OpenVPN高级路由技术 虚拟交换机和内部路由缓存">
        <i class="fa fa-chevron-left"></i> OpenVPN高级路由技术 虚拟交换机和内部路由缓存
        </a>
    
    </div>

    <div class="post-nav-prev post-nav-item">
    
        <a href="http://shanks.link/blog/2022/07/12/openvpn%E9%AB%98%E7%BA%A7%E8%B7%AF%E7%94%B1%E6%8A%80%E6%9C%AF-%E5%8F%8D%E5%90%91%E6%8E%A8%E9%80%81%E4%BF%A1%E6%81%AF/" rel="prev" title="OpenVPN高级路由技术 反向推送信息">
        OpenVPN高级路由技术 反向推送信息 <i class="fa fa-chevron-right"></i>
        </a>
    
    </div>
</div>
      
     
     
     





<script src="https://utteranc.es/client.js"
        repo="shankusu2017@gmail.com/"
        issue-term="pathname"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>
<noscript>Please enable JavaScript to view the <a href="https://github.com/utterance">comments powered by utterances.</a></noscript>

    </footer>
  </article>
</section>

          </div>
        </div>
        <div class="sidebar-toggle">
  <div class="sidebar-toggle-line-wrap">
    <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
    <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
    <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
  </div>
</div>
<aside id="sidebar" class="sidebar">
  <div class="sidebar-inner">

    <section class="site-overview sidebar-panel  sidebar-panel-active ">
      <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image"
        src="http://shanks.link/img/logo.jpg"
        alt="shankusu2017@gmail.com" />
    <p class="site-author-name" itemprop="name">shankusu2017@gmail.com</p>
    <p class="site-description motion-element" itemprop="description"> </p>
</div>
      <nav class="site-state motion-element">
    <div class="site-state-item site-state-posts">
      <a href="http://shanks.link/post/">
        <span class="site-state-item-count">473</span>
        <span class="site-state-item-name">日志</span>
      </a>
    </div>
    <div class="site-state-item site-state-categories">    
        <a href="http://shanks.link/categories/">      
         
        <span class="site-state-item-count">29</span>
        
        <span class="site-state-item-name">分类</span>
        
        </a>
    </div>

    <div class="site-state-item site-state-tags">
        <a href="http://shanks.link/tags/">
         
        <span class="site-state-item-count">34</span>
        
        <span class="site-state-item-name">标签</span>
        </a>
    </div>
</nav>
      
      
<div class="links-of-author motion-element">
    
        <span class="links-of-author-item">
        <a href="https://github.com/shankusu2017" target="_blank" title="GitHub">
            <i class="fa fa-fw fa-github"></i>
            GitHub
        </a>
        </span>
    
</div>


      

      <div class="links-of-blogroll motion-element inline">
<script type="text/javascript" src="//rf.revolvermaps.com/0/0/8.js?i=5b4f2ucxar6&amp;m=0&amp;s=220&amp;c=ff0000&amp;cr1=ffffff&amp;f=arial&amp;l=33&amp;bv=35" async="async"></script>
</div>

    </section>
    
  </div>
</aside>

      </div>
    </main>
   
    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  <span itemprop="copyrightYear">  &copy; 
  2009 - 2022</span>
  <span class="with-love"><i class="fa fa-heart"></i></span>
  <span class="author" itemprop="copyrightHolder">愿星光伴你左右</span>
</div>
<div class="powered-by">
  Powered by - <a class="theme-link" href="http://gohugo.io" target="_blank" title="hugo" >Hugo v0.101.0</a>
</div>
<div class="theme-info">
  Theme by - <a class="theme-link" href="https://github.com/xtfly/hugo-theme-next" target="_blank"> NexT
  </a>
</div>


      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
      <span id="scrollpercent"><span>0</span>%</span>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>
<script type="text/javascript" src="http://shanks.link/js/vendor/jquery/index.js?v=2.1.3"></script>
<script type="text/javascript" src="http://shanks.link/js/vendor/fastclick/lib/fastclick.min.js?v=1.0.6"></script> 
<script type="text/javascript" src="http://shanks.link/js/vendor/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
<script type="text/javascript" src="http://shanks.link/js/vendor/velocity/velocity.min.js?v=1.2.1"></script>
<script type="text/javascript" src="http://shanks.link/js/vendor/velocity/velocity.ui.min.js?v=1.2.1"></script>
<script src="http://shanks.link/js/vendor/ua-parser-js/dist/ua-parser.min.js?v=0.7.9"></script>

<script src="http://shanks.link/js/vendor/fancybox/jquery.fancybox.pack.js?v=2.1.5"></script>

<script type="text/javascript" src="http://shanks.link/js/utils.js"></script>
<script type="text/javascript" src="http://shanks.link/js/motion.js"></script>
<script type="text/javascript" src="http://shanks.link/js/affix.js"></script>
<script type="text/javascript" src="http://shanks.link/js/schemes/pisces.js"></script>

<script type="text/javascript" src="http://shanks.link/js/scrollspy.js"></script>
<script type="text/javascript" src="http://shanks.link/js/post-details.js"></script>
<script type="text/javascript" src="http://shanks.link/js/toc.js"></script>

<script type="text/javascript" src="http://shanks.link/js/bootstrap.js"></script>

<script type="text/javascript" src="http://shanks.link/js/search.js"></script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX", "output/HTML-CSS"],
    tex2jax: {
      inlineMath: [ ['$','$'] ],
      displayMath: [ ['$$','$$'] ],
      processEscapes: true
    },
    "HTML-CSS": { fonts: ["TeX"] }
  });
</script>
<script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML' async></script>
</body>
</html>