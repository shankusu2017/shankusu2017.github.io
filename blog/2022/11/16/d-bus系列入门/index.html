<!DOCTYPE HTML>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" /> 
    <title>D-Bus系列入门 - Golang编程语言知识介绍</title>
    <meta name="keywords" content="git,Git,Lua,lua,Golang,go">
    
    <meta property="og:title" content="D-Bus系列入门">
    <meta property="og:site_name" content="Golang编程语言知识介绍">
    <meta property="og:image" content="/img/author.jpg"> 
    <meta name="title" content="D-Bus系列入门 - Golang编程语言知识介绍" />
    <meta name="description" content="愿星光伴你左右"> 
    <link rel="shortcut icon" href="http://shanks.link/img/favicon.ico" />
    <link rel="apple-touch-icon" href="http://shanks.link/img/apple-touch-icon.png" />
    <link rel="apple-touch-icon-precomposed" href="http://shanks.link/img/apple-touch-icon.png" />
    <link href="http://shanks.link/js/vendor/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />
    <link href="http://shanks.link/js/vendor/fancybox/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />
    <link href="http://shanks.link/css/main.css" rel="stylesheet" type="text/css" />
    <link href="http://shanks.link/css/syntax.css" rel="stylesheet" type="text/css" />
    <script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post"},
     fancybox: true, 
    motion: true
  };
</script>
</head>
<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">
<div class="container one-collumn sidebar-position-left page-home  ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"> <div class="site-meta  custom-logo ">

  <div class="custom-logo-site-title">
    <a href="http://shanks.link/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">Golang编程语言知识介绍</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle"></p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
    <ul id="menu" class="menu">
      
      
        <li class="menu-item ">
          <a href="http://shanks.link/post/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />首页
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/thinking/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />随想录
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/life/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />life
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/todo/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />todo
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/thinking/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />思考
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/os/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />OS
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/lua/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />lua
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/redis/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />redis
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/go/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />Golang
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/c/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />C
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/tcpip/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />TCP/IP
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/ebpf/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />ebpf
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/p4/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />p4
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/openvpn/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />OpenVPN
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/ipsec/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />IPSec
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/l2tp/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />L2TP
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/dns/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />DNS
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/distributed/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />distributed
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/web/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />web
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/openwrt/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />OpenWRT
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/%E8%BF%90%E7%BB%B4/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />运维
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/git/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />Git
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/%E9%B8%9F%E5%93%A5%E7%9A%84%E7%A7%81%E6%88%BF%E8%8F%9C/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />鸟哥的私房菜
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/it/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />IT杂谈
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/about/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />About Me
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/links/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />友情链接
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/ftp/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />FTP
          </a>
        </li>
      
      <li class="menu-item menu-item-search">
        <a href="javascript:;" class="popup-trigger"> <i class="menu-item-icon fa fa-search fa-fw"></i> <br /> 搜索</a>
      </li>
    </ul>
    <div class="site-search">
      <div class="popup">
 <span class="search-icon fa fa-search"></span>
 <input type="text" id="local-search-input">
 <div id="local-search-result"></div>
 <span class="popup-btn-close">close</span>
</div>

    </div>
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
<section id="posts" class="posts-expand">
  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <header class="post-header">
      <h1 class="post-title" itemprop="name headline">
        <a class="post-title-link" href="http://shanks.link/blog/2022/11/16/d-bus%E7%B3%BB%E5%88%97%E5%85%A5%E9%97%A8/" itemprop="url">
        D-Bus系列入门
        </a>
      </h1>
      <div class="post-meta">
      <span class="post-time">
<span class="post-meta-item-icon">
    <i class="fa fa-calendar-o"></i>
</span>
<span class="post-meta-item-text">时间：</span>
<time itemprop="dateCreated" datetime="2016-03-22T13:04:35+08:00" content="2022-11-16">
    2022-11-16
</time>
</span> 
      

  <span class="post-category" >
  &nbsp; | &nbsp;
  <span class="post-meta-item-icon">
    <i class="fa fa-folder-o"></i>
  </span>
  <span class="post-meta-item-text">分类：</span>
  
    <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
      <a href="http://shanks.link/categories/openwrt" itemprop="url" rel="index">
        <span itemprop="name">OpenWrt</span>
      </a>
      &nbsp; 
    </span>
  
</span>


       <span>
&nbsp; | &nbsp;
<span class="post-meta-item-icon">
    <i class="fa fa-eye"></i>
</span>
<span class="post-meta-item-text">阅读：</span>
<span class="leancloud-visitors-count">9246 字 ~19分钟</span>
</span>
      </div>
    </header>
    <div class="post-body" itemprop="articleBody">
    <h2 id="背景知识">背景知识</h2>
<p>有很多IPC（interprocess communication ） ，用于不同的解决方案：CORBA 是用于面向对象编程中复杂的 IPC 的一个强大的解决方案。 DCOP 是一个较轻量级的 IPC 框架，功能较少，但是可以很好地集成到 K 桌面环境中。SOAP 和 XML-RPC 设计用于 Web 服务，因而使用 HTTP 作为其传输协议。 D-BUS 设计用于桌面应用程序和 OS 通信。D-Bus(其中D原先是代表桌面“Desktop” 的意思)，即：用于桌面操作系统的通信总线。 现在逐渐被引入到嵌入式系统中，不过名字还是保留原先的叫法而已。</p>
<p>典型的桌面都会有多个应用程序在运行，而且，它们经常需要彼此进行通信。DCOP 是一个用于 KDE 的解决方案，但是它依赖于 Qt，所以不能用于其他桌面环境之中。 类似的，Bonobo 是一个用于 GNOME 的解决方案，但是非常笨重，因为它是基于 CORBA 的。它还依赖于 GObject，所以也不能用于 GNOME 之外。 D-BUS 的目标是将 DCOP 和 Bonobo 替换为简单的 IPC，并集成这两种桌面环境。 由于尽可能地减少了 D-BUS 所需的依赖，所以其他可能会使用 D-BUS 的应用程序不用担心引入过多依赖。 相对于其它的IPC, D-Bus丢掉了一些不必要的、复杂的东西，也正是因为这个原因，D-Bus比较快、简单。 D-Bus不和低层的IPC直接竞争，比如sockets, shared memory or message queues.这些低层点的IPC有它们自己的特点，和D-Bus并不冲突。</p>
<h2 id="什么是d-bus">什么是D-Bus</h2>
<p>D-Bus是一个为应用程序间通信的消息总线系统, 用于进程之间的通信。它是个3层架构的IPC 系统，包括：</p>
<blockquote>
<ol>
<li>函数库libdbus ，用于两个应用程序互相联系和交互消息。</li>
<li>一个基于libdbus构造的消息总线守护进程，可同时与多个应用程序相连，并能把来自一个应用程序的消息路由到0或者多个其他程序。</li>
<li>基于特定应用程序框架的封装库或捆绑（wrapper libraries or bindings ）。例如，libdbus-glib和libdbus-qt，还有绑定在其他语言，例如Python的。大多数开发者都是使用这些封装库的API，因为它们简化了D-Bus编程细节。libdbus被有意设计成为更高层次绑定的底层后端（low-level backend ）。大部分libdbus的 API仅仅是为了用来实现绑定。</li>
</ol>
</blockquote>
<p>在D-Bus中，“bus”是核心的概念，它是一个通道：不同的程序可以通过这个通道做些操作，比如方法调用、发送信号和监听特定的信号。</p>
<p>D-Bus是低延迟而且低开销的，设计得小而高效，以便最小化传送的往返时间。另外，协议是二进制的，而不是文本的，这样就排除了费时的序列化过程。 从开发者的角度来看，D-BUS 是易于使用的。有线协议容易理解，客户机程序库以直观的方式对其进行包装。D-Bus的主要目的是提供如下的一些更高层的功能：</p>
<blockquote>
<ol>
<li>结构化的名字空间</li>
<li>独立于架构的数据格式</li>
<li>支持消息中的大部分通用数据元素</li>
<li>带有异常处理的通用远程调用接口</li>
<li>支持广播类型的通信</li>
</ol>
</blockquote>
<p>Bus daemon是一个特殊的进程：这个进程可以从一个进程传递消息给另外一个进程。 当然了，如果有很多applications链接到这个通道上，这个daemon进程就会把消息转发给这些链接的所有程序。 在最底层，D-Bus只支持点对点的通信，一般使用本地套接字（AF_UNIX）在应用和bus daemon之间通信。 D-Bus的点对点是经过bus daemon抽象过的，由bus daemon来完成寻址和发送消息，因此每个应用不必要关心要把消息发给哪个进程。 D-Bus发送消息通常包含如下步骤（正常情况下）：</p>
<blockquote>
<ol>
<li>创建和发送消息 给后台bus daemon进程，这个过程中会有两个上下文的切换</li>
<li>后台bus daemon进程会处理该消息，并转发给目标进程，这也会引起上下文的切换</li>
<li>目标程序接收到消息，然后根据消息的种类，做不同的响应：要么给个确认、要么应答、还有就是忽略它。最后一种情况对于“通知”类型的消息而言，前两种都会引起进一步的上 下文切换。</li>
</ol>
</blockquote>
<p>在一台机器上总线守护有多个实例(instance)。这些总线之间都是相互独立的。</p>
<ul>
<li>
<p><em>一个持久的系统总线（system bus）</em></p>
<p>它在引导时就会启动。这个总线由操作系统和后台进程使用，安全性非常好，以使得任意的应用程序不能欺骗系统事件。 它是桌面会话和操作系统的通信，这里操作系统一般而言包括内核和系统守护进程。 这种通道的最常用的方面就是发送系统消息，比如：插入一个新的存储设备；有新的网络连接；等等。</p>
</li>
<li>
<p><em>还将有很多会话总线（session buses）</em></p>
<p>这些总线当用户登录后启动，属于那个用户私有。它是用户的应用程序用来通信的一个会话总线。 同一个桌面会话中两个桌面应用程序的通信，可使得桌面会话作为整体集成在一起以解决进程生命周期的相关问题。 这在GNOME和KDE桌面中大量使用。</p>
</li>
</ul>
<p>综上原因，如果你准备在不同的进程之间传递大量的 数据，D-Bus可能不是最有效的方法，最有效的方法是使用共享内存，但是对共享内存的管理也是相当复杂的。</p>
<h2 id="d-bus编程经常涉及的一些概念">D-Bus编程经常涉及的一些概念</h2>
<ul>
<li>
<p><em>地址</em></p>
<p>连接建立有server和client，对于bus daemon，应用就是client，daemon是server。 一个D-Bus的地址是指server用于监听，client用于连接的地方，例如unix:path=/tmp/abcedf标识server将在路径/tmp/abcedf的UNIX domain socket监听。 地址可以是指定的TCP/IP socket或者其他在或者将在D-Bus协议中定义的传输方式。 如果使用bus daemon，libdbus将通过读取环境变量自动获取session bus damon的地址，通过检查一个指定的UNIX domain socket路径获取system bus的地址。如果使用D-bus，但不是daemon，需要定义那个应用是server，那个是client，并定义一套机制是他们认可server的地址，这不是通常的做法。</p>
</li>
<li>
<p><em>Bus Names总线名字</em></p>
<p>当一个应用连接到bus daemon，daemon立即会分配一个名字给这个连接，称为unique connection name， 这个唯一标识的名字以冒号：开头，例如:34-907，这个名字在daemon的整个生命周期是唯一的。 但是这种名字总是临时分配，无法确定的，也难以记忆，因此应用可以要求有另外一个名字well-known name 来对应这个唯一标识，就像我们使用域名来对应IP地址一样。 例如可以使用com.mycompany来映射:34-907。应用程序可能会要求拥有额外的周知名字（well-known name）。 例如，你可以写一个规范来定义一个名字叫做 com.mycompany.TextEditor。 应用程序就可以发送消息到这个总线名字，对象，和接口以执行方法调用。 当一个应用结束或者崩溃是，OS kernel会关闭它的总线连接。总线发送notification消息告诉其他应用，这个应用的名字已经失去他的owner。 当检测到这类notification时，应用可以知道其他应用的生命周期。这种方式也可用于只有一个实例的应用，即不开启同样的两个应用的情况。</p>
</li>
<li>
<p><em>原生对象和对象路径</em></p>
<p>所有使用D-BUS的应用程序都包含一些对象, 当经由一个D-BUS连接受到一条消息时，该消息是被发往一个对象而不是整个应用程序。 在开发中程序框架定义着这样的对象，例如JAVA，GObject，QObject等等，在D-Bus中成为native object。 对于底层的D-Bus协议，即libdbus API，并不理会这些native object，它们使用的是一个叫做object path的概念。 通过object path，高层编程可以为对象实例进行命名，并允许远程应用引用它们。 这些名字看起来像是文件系统路径，易读的路径名是受鼓励的做法，但也允许使用诸如“/com/mycompany/c5yo817y0c1y1c5b”等，只要它可以为你的应用程序所用。 Namespacing的对象路径以开发者所有的域名开始（如 /org/kde）以避免系统不同代码模块互相干扰。 简单地说：一个应用创建对象实例进行D-Bus的通信，这些对象实例都有一个名字，命名方式类似于路径， 例如/com/mycompany，这个名字在全局（session或者system）是唯一的，用于消息的路由。</p>
</li>
<li>
<p><em>Proxies代理</em></p>
<p>代理对象用来表示其他远程的remote object。 当我们触发了proxy对象的method时，将会在D-Bus上发送一个method_call的消息，并等待答复，根据答复返回。使用非常方便，就像调用一个本地的对象。</p>
</li>
<li>
<p><em>接口Interface</em></p>
<p>每一个对象支持一个或者多个接口，接口是一组方法和信号，接口定义一个对象实体的类型。 D-Bus对接口的命名方式，类似org.freedesktop.Introspectable。开发人员通常将使用编程语言类的的名字作为接口名字。</p>
</li>
<li>
<p><em>方法和信号Methods and Signals</em></p>
<p>每一个对象有两类成员：方法和信号。方法就是JAVA中同样概念，方法是一段函数代码，带有输入和输出。信号是广播给所有兴趣的其他实体，信号可以带有数据payload。 在 D-BUS 中有四种类型的消息：方法调用（method calls）、方法返回（method returns）、信号（signals）和错误（errors）。 要执行D-BUS对象的方法，您需要向对象发送一个方法调用消息。 它将完成一些处理（就是执行了对象中的Method，Method是可以带有输入参数的。）并返回，返回消息或者错误消息。 信号的不同之处在于它们不返回任何内容：既没有“信号返回”消息，也没有任何类型的错误消息。</p>
</li>
</ul>
<p>通过上面的描述，我们可以获得下面的视图:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">Address –&gt; [Bus Name] –&gt; Path –&gt; Interface –&gt; Method
</code></pre></div><p>bus name不是必要的，它只在daemon的情况下用于路由，点对点的直接连接是不需要的。 简单地说 ：Address是D-Bus中server用来监听client的地址，当一个client连接上D-Bus，通常是Daemo的方式，这个client就有了一个Bus Name。 其他应用可以根据消息中所带的Bus Name，来判断和哪个应用相关。 消息在总线中传递的时候，传递到应用中，再根据object path，送至应用中具体的对象实例中，也就是是应用中根据Interface创建的对象。 这些Interface有method和singal两种，用来发送、接收、响应消息。</p>
<p>这些概念对初学者可能会有些混淆，但是通过后面学习一个小程序，就很清楚，这是后面一个例子的示意图，回过头来看看之前写的这篇文章，这个示意图或许会更清楚。</p>
<p><img src="https://thebigdoc.readthedocs.io/en/latest/_images/dbus-example.png" alt="../_images/dbus-example.png"></p>
<h2 id="d-bus消息类型">D-Bus消息类型</h2>
<p>消息通过D-Bus在进程间传递。有四类消息： a. Method call消息：将触发对象的一个method #. Method return消息：触发的方法返回的结果 #. Error消息：触发的方法返回一个异常 #. Signal消息：通知，可以看作为事件消息。</p>
<p>一个消息有消息头header，里面有field，有一个消息体body，里面有参数arguments。消息头包含消息体的路由信息，消息体就是净荷payload。头字段可能包括发送者的bus名，目的地的bus名，方法或者signal名等等，其中一个头字段是用于描述body中的参数的类型，例如“i”标识32位整数，”ii”表示净荷为2个32为整数。</p>
<h3 id="发送method-call消息的场景">发送Method call消息的场景</h3>
<p>一个method call消息从进程A到进程B，B将应答一个method return消息或者error消息。 在每个call消息带有一个序列号，应答消息也包含同样的号码，使之可以对应起来。 他们的处理过程如下：</p>
<blockquote>
<ol>
<li>如果提供proxy，通过触发本地一个对象的方法从而触发另一个进程的远端对象的方法。应用调用proxy的一个方法，proxy构造一个method call消息发送到远端进程。</li>
<li>对于底层的API，不使用proxy，应用需要自己构造method call消息。</li>
<li>一个method call消息包含：远端进程的bus name，方法名字，方法的参数，远端进程中object path，可选的接口名字。</li>
<li>method call消息发送到bus daemon</li>
<li>bus daemon查看目的地的bus name。如果一个进程对应这个名字，bus daemon将method call消息发送到该进程中。如果没有发现匹配，bus daemon创建一个error消息作为应答返回。</li>
<li>进程接收后将method call消息分拆。对于简单的底层API情况，将立即执行方法，并发送一个method reply消息给bus daemon。对于高层的API，将检查对象path，interface和method，触发一个native object的方法，并将返回值封装在一个method reply消息中。</li>
<li>bus daemon收到method reply消息，将其转发到原来的进程中</li>
<li>进程查看method reply消息，获取返回值。这个响应也可以标识一个error的残生。当使用高级的捆绑，method reply消息将转换为proxy方法的返回值或者一个exception。</li>
</ol>
</blockquote>
<p>Bus daemon保证message的顺序，不会乱序。例如我们发送两个method call消息到同一个接受方，他们将按顺序接受。接收方并不要求一定按顺序回复。消息有一个序列号了匹配收发消息。</p>
<h3 id="发送signal的场景">发送Signal的场景</h3>
<p>signal是个广播的消息，不需要响应，接收方向daemon注册匹配的条件，包括发送方和信号名，bus守护只将信号发送给希望接受的进程。</p>
<p>处理流程如下：</p>
<blockquote>
<ol>
<li>一个signal消息发送到bus daemon。</li>
<li>signal消息包含发布该信号的interface名字，signal的名字，进程的bus名字，以及参数。</li>
<li>任何进程都可以注册的匹配条件（match rules)表明它所感兴趣的signal。总线有个注册match rules列表。</li>
<li>bus daemon检查那些进程对该信号有兴趣，将信号消息发送到这些进程中。</li>
<li>收到信号的进程决定如何处理。如果使用高层的捆绑，一个porxy对象将会释放一个native的信号。如果使用底层的API，进程需要检查信号的发送方和信号的名字决定如何进行处理。</li>
</ol>
</blockquote>
<p>Introspection 　　D-Bus对象可能支持一个接口org.freedesktop.DBus.Introspectable。该接口有一个方法Introspect，不带参数，将返回一个XML string。这个XML字符串描述接口，方法，信号。</p>
<h2 id="简单的例子">简单的例子</h2>
<h3 id="d-bus类型和gtype的映射">D-Bus类型和GType的映射</h3>
<p>在D-Bus编程中，基础类型和GType的映射表格如下。在后面的程序小例子中我们会看到具体如何对应。</p>
<p><img src="https://thebigdoc.readthedocs.io/en/latest/_images/dbus-map-gtype.png" alt="../_images/dbus-map-gtype.png"></p>
<p>在D-Bus编程中，container类型和GType的映射表格如下：</p>
<p><img src="https://thebigdoc.readthedocs.io/en/latest/_images/dbus-container-gtype.png" alt="../_images/dbus-container-gtype.png"></p>
<p>在下面的例子中，使用了dbus-1 dbus-glib-1 glib-2.0。Makefile的如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-makefile" data-lang="makefile">CC=gcc

CFLAGS += <span style="color:#009c00">`</span>pkg-config --cflags dbus-glib-1 glib-2.0<span style="color:#009c00">`</span>
LIBS += <span style="color:#009c00">`</span>pkg-config --libs dbus-glib-1 glib-2.0<span style="color:#009c00">`</span>

<span style="color:#c34e00">all</span>: sync_sample async_sample signal_send signal_recv method_service method_call

<span style="color:#c34e00">async_sample</span>: async_sample.c
	<span style="color:#00f">$(</span>CC<span style="color:#00f">)</span> -Wall -g <span style="color:#00f">$(</span>CFLAGS<span style="color:#00f">)</span> $&lt; <span style="color:#00f">$(</span>LIBS<span style="color:#00f">)</span> -o $@

<span style="color:#c34e00">sync_sample</span>: sync_sample.c
	<span style="color:#00f">$(</span>CC<span style="color:#00f">)</span> -Wall -g <span style="color:#00f">$(</span>CFLAGS<span style="color:#00f">)</span> $&lt; <span style="color:#00f">$(</span>LIBS<span style="color:#00f">)</span> -o $@

<span style="color:#c34e00">signal_send</span>: signal_send.c
	<span style="color:#00f">$(</span>CC<span style="color:#00f">)</span> -Wall -g <span style="color:#00f">$(</span>CFLAGS<span style="color:#00f">)</span> $&lt; <span style="color:#00f">$(</span>LIBS<span style="color:#00f">)</span> -o $@

<span style="color:#c34e00">signal_recv</span>: signal_recv.c
	<span style="color:#00f">$(</span>CC<span style="color:#00f">)</span> -Wall -g <span style="color:#00f">$(</span>CFLAGS<span style="color:#00f">)</span> $&lt; <span style="color:#00f">$(</span>LIBS<span style="color:#00f">)</span> -o $@

<span style="color:#c34e00">method_service</span>: method_service.c
	<span style="color:#00f">$(</span>CC<span style="color:#00f">)</span> -Wall -g <span style="color:#00f">$(</span>CFLAGS<span style="color:#00f">)</span> $&lt; <span style="color:#00f">$(</span>LIBS<span style="color:#00f">)</span> -o $@

<span style="color:#c34e00">method_call</span>:method_call.c
	<span style="color:#00f">$(</span>CC<span style="color:#00f">)</span> -Wall -g <span style="color:#00f">$(</span>CFLAGS<span style="color:#00f">)</span> $&lt; <span style="color:#00f">$(</span>LIBS<span style="color:#00f">)</span> -o $@

<span style="color:#c34e00">clean</span>:
	rm -f sync_sample async_sample signal_send signal_recv method_service method_call
</code></pre></div><h3 id="同步的例子">同步的例子</h3>
<p>同步即程序发出method call消息，等待method_return消息。下面是一个小例子，如果我们用dbus-send命令，可以使用：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">dbus-send --session --print-reply --type=method_call --dest=org.freedesktop.Notifications / org.freedesktop.DBus.Introspectable.Introspect
</code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#f00;font-style:italic">#include</span> <span style="color:#f00;font-style:italic">&lt;stdio.h&gt;</span><span style="color:#f00;font-style:italic">
</span><span style="color:#f00;font-style:italic">#include</span> <span style="color:#f00;font-style:italic">&lt;stdlib.h&gt;</span><span style="color:#f00;font-style:italic">
</span><span style="color:#f00;font-style:italic">#include</span> <span style="color:#f00;font-style:italic">&lt;dbus/dbus-glib.h&gt;</span><span style="color:#f00;font-style:italic">
</span><span style="color:#f00;font-style:italic"></span>
<span style="color:#00f">int</span> <span style="color:#c34e00">main</span>(<span style="color:#00f">int</span> argc, <span style="color:#00f">char</span> **argv)
{
    GError *error;
    DBusGConnection *conn;
    DBusGProxy *proxy;
    <span style="color:#00f">char</span> *str;

    <span style="color:#f00;font-style:italic">/* gtype init */</span>
    error = NULL;
    <span style="color:#f00;font-style:italic">/* connect session bus with dbus_g_get, or DBUS_BUS_SYSTEM connect system bus */</span>
    conn = dbus_g_bus_get(DBUS_BUS_SESSION, &amp;error);
    <span style="color:#00f">if</span> (conn == NULL) {
        g_printerr(<span style="color:#009c00">&#34;Failed to open connection to bus:%s</span><span style="color:#009c00">\n</span><span style="color:#009c00">&#34;</span>, error-&gt;message);
        g_error_free(error);
        exit(1);
    }

    <span style="color:#f00;font-style:italic">/* create a proxy object for  */</span>
    proxy = dbus_g_proxy_new_for_name(conn,
            <span style="color:#009c00">&#34;org.freedesktop.Notifications&#34;</span>, <span style="color:#f00;font-style:italic">/* service */</span>
            <span style="color:#009c00">&#34;/&#34;</span>, <span style="color:#f00;font-style:italic">/* path */</span>
            <span style="color:#009c00">&#34;org.freedesktop.DBus.Introspectable&#34;</span><span style="color:#f00;font-style:italic">/* interface */</span>
            );
    error = NULL;
    <span style="color:#00f">if</span> (!dbus_g_proxy_call(proxy, <span style="color:#009c00">&#34;Introspect&#34;</span>, &amp;error, G_TYPE_INVALID, G_TYPE_STRING, &amp;str, G_TYPE_INVALID)) {
        <span style="color:#00f">if</span> (error-&gt;domain == DBUS_GERROR &amp;&amp; error-&gt;code == DBUS_GERROR_REMOTE_EXCEPTION) {
            g_printerr(<span style="color:#009c00">&#34;Caught remote method exception:%s-%s</span><span style="color:#009c00">\n</span><span style="color:#009c00">&#34;</span>, dbus_g_error_get_name(error), error-&gt;message);
        } <span style="color:#00f">else</span> {
            g_printerr(<span style="color:#009c00">&#34;Error:%s</span><span style="color:#009c00">\n</span><span style="color:#009c00">&#34;</span>, error-&gt;message);
        }
        g_error_free(error);
        exit(1);
    }

    g_print(<span style="color:#009c00">&#34;Message Method return from bus:</span><span style="color:#009c00">\n</span><span style="color:#009c00">%s</span><span style="color:#009c00">\n</span><span style="color:#009c00">&#34;</span>, str);
    g_free(str);
    g_object_unref(proxy);
    exit(1);

    <span style="color:#00f">return</span> 0;
}
</code></pre></div><h3 id="异步的例子">异步的例子</h3>
<p>异步中，程序将不等返回消息，继续执行，等有返回消息的时候，触发一个回调函数 。下面是同样的操作，但是用异步的方式来实现：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#f00;font-style:italic">#include</span> <span style="color:#f00;font-style:italic">&lt;stdio.h&gt;</span><span style="color:#f00;font-style:italic">
</span><span style="color:#f00;font-style:italic">#include</span> <span style="color:#f00;font-style:italic">&lt;stdlib.h&gt;</span><span style="color:#f00;font-style:italic">
</span><span style="color:#f00;font-style:italic">#include</span> <span style="color:#f00;font-style:italic">&lt;dbus/dbus-glib.h&gt;</span><span style="color:#f00;font-style:italic">
</span><span style="color:#f00;font-style:italic"></span>
<span style="color:#00f">static</span> <span style="color:#00f">void</span> <span style="color:#c34e00">callback_func</span>(DBusGProxy *proxy, DBusGProxyCall *call_id, <span style="color:#00f">void</span> *user_data)
{
    GError *err = NULL;
    gchar *str = NULL;
    GMainLoop *main_loop = user_data;

    <span style="color:#f00;font-style:italic">/* 结束一条消息的收发，处理收到的消息 */</span>
    dbus_g_proxy_end_call(proxy, call_id, &amp;err, G_TYPE_STRING, &amp;str, G_TYPE_INVALID);
    <span style="color:#00f">if</span> (err != NULL) {
        g_print(<span style="color:#009c00">&#34;Error in method call:%s</span><span style="color:#009c00">\n</span><span style="color:#009c00">&#34;</span>, err-&gt;message);
        g_error_free(err);
    } <span style="color:#00f">else</span> {
        g_print(<span style="color:#009c00">&#34;Success, message:</span><span style="color:#009c00">\n</span><span style="color:#009c00">%s</span><span style="color:#009c00">\n</span><span style="color:#009c00">&#34;</span>, str);
    }

    g_main_loop_quit(main_loop);
}

<span style="color:#00f">int</span> <span style="color:#c34e00">main</span>(<span style="color:#00f">int</span> argc, <span style="color:#00f">char</span> **argv)
{
    GError *error;
    DBusGConnection *conn;
    DBusGProxy *proxy;
    GMainLoop *main_loop;

    error = NULL;
    main_loop = g_main_loop_new(NULL, FALSE);
    <span style="color:#f00;font-style:italic">/* connect session bus with dbus_g_get, or DBUS_BUS_SYSTEM connect system bus */</span>
    conn = dbus_g_bus_get(DBUS_BUS_SESSION, &amp;error);
    <span style="color:#00f">if</span> (conn == NULL) {
        g_printerr(<span style="color:#009c00">&#34;Failed to open connection to bus:%s</span><span style="color:#009c00">\n</span><span style="color:#009c00">&#34;</span>, error-&gt;message);
        g_error_free(error);
        exit(1);
    }

    <span style="color:#f00;font-style:italic">/* create a proxy object for  */</span>
    proxy = dbus_g_proxy_new_for_name(conn,
            <span style="color:#009c00">&#34;org.freedesktop.Notifications&#34;</span>, <span style="color:#f00;font-style:italic">/* service */</span>
            <span style="color:#009c00">&#34;/&#34;</span>, <span style="color:#f00;font-style:italic">/* path */</span>
            <span style="color:#009c00">&#34;org.freedesktop.DBus.Introspectable&#34;</span><span style="color:#f00;font-style:italic">/* interface */</span>
            );
    error = NULL;
    dbus_g_proxy_begin_call(proxy, <span style="color:#009c00">&#34;Introspect&#34;</span>, callback_func, main_loop, NULL, G_TYPE_INVALID);
    g_main_loop_run(main_loop);

    <span style="color:#00f">return</span> 0;
}
</code></pre></div><h2 id="signal的收发的例子">Signal的收发的例子</h2>
<p>现在从底层，即libdbus学习如何发送signal，以及如何监听signal。signal在D-Bus的Daemon中广播，为了提高效率，只发送给向daemon注册要求该singal的对象。 程序，第一步需要将应用和D-Bus后台建立连接，也就是和System D-Bus daemon或者Session D-Bus daemon建立连接。 一旦建立，daemon会给这条连接分配一个名字，这个名字在system或者session的生命周期是唯一的， 即unique connection name，为了方便记忆，可以为这条连接分配一个便于记忆的well-known name。 对于信号方式，分配这个名字不是必须的（在method_call中是需要的，我们在下一次学习中谈到），因为在信号的监听中秩序给出Interface的名字和信号名称。 在下面的例子中，可以将相关的代码屏蔽掉，不影响运行，但是通常我们都这样处理，尤其在复杂的程序中。</p>
<p>在我们的例子中，定义这个BUS name为test.singal.source。当然一个好的名字，为了避免于其他应用重复，应当使用com.mycompany.myfunction之类的名字。 而interface的名字，一般前面和connection的BUS name一致。</p>
<h3 id="发送方程序">发送方程序</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#f00;font-style:italic">#include</span> <span style="color:#f00;font-style:italic">&lt;stdio.h&gt;</span><span style="color:#f00;font-style:italic">
</span><span style="color:#f00;font-style:italic">#include</span> <span style="color:#f00;font-style:italic">&lt;stdlib.h&gt;</span><span style="color:#f00;font-style:italic">
</span><span style="color:#f00;font-style:italic">#include</span> <span style="color:#f00;font-style:italic">&lt;string.h&gt;</span><span style="color:#f00;font-style:italic">
</span><span style="color:#f00;font-style:italic">#include</span> <span style="color:#f00;font-style:italic">&lt;dbus/dbus-glib.h&gt;</span><span style="color:#f00;font-style:italic">
</span><span style="color:#f00;font-style:italic">#include</span> <span style="color:#f00;font-style:italic">&lt;dbus/dbus.h&gt;</span><span style="color:#f00;font-style:italic">
</span><span style="color:#f00;font-style:italic">#include</span> <span style="color:#f00;font-style:italic">&lt;unistd.h&gt;</span><span style="color:#f00;font-style:italic">
</span><span style="color:#f00;font-style:italic"></span>
<span style="color:#00f">int</span> <span style="color:#c34e00">send_a_signal</span>( <span style="color:#00f">char</span> * sigvalue)
{
    DBusError err;
    DBusConnection * connection;
    DBusMessage * msg;
    DBusMessageIter arg;
    dbus_uint32_t  serial = 0;
    <span style="color:#00f">int</span> ret;

    <span style="color:#f00;font-style:italic">//步骤1:建立与D-Bus后台的连接
</span><span style="color:#f00;font-style:italic"></span>    <span style="color:#f00;font-style:italic">/* initialise the erroes */</span>
    dbus_error_init(&amp;err);
    <span style="color:#f00;font-style:italic">/* Connect to Bus*/</span>
    connection = dbus_bus_get(DBUS_BUS_SESSION , &amp;err );
    <span style="color:#00f">if</span>(dbus_error_is_set(&amp;err)) {
        fprintf(stderr,<span style="color:#009c00">&#34;Connection Err : %s</span><span style="color:#009c00">\n</span><span style="color:#009c00">&#34;</span>,err.message);
        dbus_error_free(&amp;err);
    }
    <span style="color:#00f">if</span>(connection == NULL) {
        <span style="color:#00f">return</span> -1;
    }

    <span style="color:#f00;font-style:italic">//步骤2:给连接名分配一个well-known的名字作为Bus name，这个步骤不是必须的，可以用if 0来注释着一段代码，我们可以用这个名字来检查，是否已经开启了这个应用的另外的进程。
</span><span style="color:#f00;font-style:italic"></span><span style="color:#f00;font-style:italic">#if 1
</span><span style="color:#f00;font-style:italic"></span>    ret = dbus_bus_request_name(connection,<span style="color:#009c00">&#34;test.singal.source&#34;</span>,DBUS_NAME_FLAG_REPLACE_EXISTING,&amp;err);
    <span style="color:#00f">if</span>(dbus_error_is_set(&amp;err)) {
        fprintf(stderr,<span style="color:#009c00">&#34;Name Err : %s</span><span style="color:#009c00">\n</span><span style="color:#009c00">&#34;</span>,err.message);
        dbus_error_free(&amp;err);
    }
    <span style="color:#00f">if</span>(ret != DBUS_REQUEST_NAME_REPLY_PRIMARY_OWNER)
        <span style="color:#00f">return</span> -1;
<span style="color:#f00;font-style:italic">#endif
</span><span style="color:#f00;font-style:italic"></span>
    <span style="color:#f00;font-style:italic">//步骤3:发送一个信号
</span><span style="color:#f00;font-style:italic"></span>    <span style="color:#f00;font-style:italic">//根据图，我们给出这个信号的路径（即可以指向对象），接口，以及信号名，创建一个Message
</span><span style="color:#f00;font-style:italic"></span>    <span style="color:#00f">if</span>((msg = dbus_message_new_signal (<span style="color:#009c00">&#34;/test/signal/Object&#34;</span>,<span style="color:#009c00">&#34;test.signal.Type&#34;</span>,<span style="color:#009c00">&#34;Test&#34;</span>)) == NULL) {
        fprintf(stderr,<span style="color:#009c00">&#34;Message NULL</span><span style="color:#009c00">\n</span><span style="color:#009c00">&#34;</span>);
        <span style="color:#00f">return</span> -1;
    }
    <span style="color:#f00;font-style:italic">//给这个信号（messge）具体的内容
</span><span style="color:#f00;font-style:italic"></span>    dbus_message_iter_init_append (msg,&amp;arg);
    <span style="color:#00f">if</span>(!dbus_message_iter_append_basic (&amp;arg,DBUS_TYPE_STRING,&amp;sigvalue)) {
        fprintf(stderr,<span style="color:#009c00">&#34;Out Of Memory!</span><span style="color:#009c00">\n</span><span style="color:#009c00">&#34;</span>);
        <span style="color:#00f">return</span> -1;
    }

    <span style="color:#f00;font-style:italic">//步骤4: 将信号从连接中发送
</span><span style="color:#f00;font-style:italic"></span>    <span style="color:#00f">if</span>( !dbus_connection_send(connection,msg,&amp;serial)) {
        fprintf(stderr,<span style="color:#009c00">&#34;Out of Memory!</span><span style="color:#009c00">\n</span><span style="color:#009c00">&#34;</span>);
        <span style="color:#00f">return</span> -1;
    }
    dbus_connection_flush (connection);
    printf(<span style="color:#009c00">&#34;Signal Send</span><span style="color:#009c00">\n</span><span style="color:#009c00">&#34;</span>);

    <span style="color:#f00;font-style:italic">//步骤5: 释放相关的分配的内存。
</span><span style="color:#f00;font-style:italic"></span>    dbus_message_unref(msg);
    <span style="color:#00f">return</span> 0;
}


<span style="color:#00f">int</span> <span style="color:#c34e00">main</span>( <span style="color:#00f">int</span> argc , <span style="color:#00f">char</span> ** argv)
{
    send_a_signal(<span style="color:#009c00">&#34;Hello,world!&#34;</span>);
    <span style="color:#00f">return</span> 0;
}
</code></pre></div><h3 id="接收该信号的的例子">接收该信号的的例子</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#f00;font-style:italic">#include</span> <span style="color:#f00;font-style:italic">&lt;stdio.h&gt;</span><span style="color:#f00;font-style:italic">
</span><span style="color:#f00;font-style:italic">#include</span> <span style="color:#f00;font-style:italic">&lt;stdlib.h&gt;</span><span style="color:#f00;font-style:italic">
</span><span style="color:#f00;font-style:italic">#include</span> <span style="color:#f00;font-style:italic">&lt;string.h&gt;</span><span style="color:#f00;font-style:italic">
</span><span style="color:#f00;font-style:italic">#include</span> <span style="color:#f00;font-style:italic">&lt;dbus/dbus-glib.h&gt;</span><span style="color:#f00;font-style:italic">
</span><span style="color:#f00;font-style:italic">#include</span> <span style="color:#f00;font-style:italic">&lt;dbus/dbus.h&gt;</span><span style="color:#f00;font-style:italic">
</span><span style="color:#f00;font-style:italic">#include</span> <span style="color:#f00;font-style:italic">&lt;unistd.h&gt;</span><span style="color:#f00;font-style:italic">
</span><span style="color:#f00;font-style:italic"></span>
<span style="color:#00f">void</span> <span style="color:#c34e00">listen_signal</span>()
{
    DBusMessage * msg;
    DBusMessageIter arg;
    DBusConnection * connection;
    DBusError err;
    <span style="color:#00f">int</span> ret;
    <span style="color:#00f">char</span> * sigvalue;

    <span style="color:#f00;font-style:italic">//步骤1:建立与D-Bus后台的连接
</span><span style="color:#f00;font-style:italic"></span>    dbus_error_init(&amp;err);
    connection = dbus_bus_get(DBUS_BUS_SESSION, &amp;err);
    <span style="color:#00f">if</span>(dbus_error_is_set(&amp;err)) {
        fprintf(stderr,<span style="color:#009c00">&#34;Connection Error %s</span><span style="color:#009c00">\n</span><span style="color:#009c00">&#34;</span>,err.message);
        dbus_error_free(&amp;err);
    }
    <span style="color:#00f">if</span>(connection == NULL) {
        <span style="color:#00f">return</span>;
    }

    <span style="color:#f00;font-style:italic">//步骤2:给连接名分配一个可记忆名字test.singal.dest作为Bus name，这个步骤不是必须的,但推荐这样处理
</span><span style="color:#f00;font-style:italic"></span>    ret = dbus_bus_request_name(connection,<span style="color:#009c00">&#34;test.singal.dest&#34;</span>,DBUS_NAME_FLAG_REPLACE_EXISTING,&amp;err);
    <span style="color:#00f">if</span>(dbus_error_is_set(&amp;err)) {
        fprintf(stderr,<span style="color:#009c00">&#34;Name Error %s</span><span style="color:#009c00">\n</span><span style="color:#009c00">&#34;</span>,err.message);
        dbus_error_free(&amp;err);
    }
    <span style="color:#00f">if</span>(ret != DBUS_REQUEST_NAME_REPLY_PRIMARY_OWNER) {
        <span style="color:#00f">return</span>;
    }

    <span style="color:#f00;font-style:italic">//步骤3:通知D-Bus daemon，希望监听来行接口test.signal.Type的信号
</span><span style="color:#f00;font-style:italic"></span>    dbus_bus_add_match(connection,<span style="color:#009c00">&#34;type=&#39;signal&#39;,interface=&#39;test.signal.Type&#39;&#34;</span>,&amp;err);
    <span style="color:#f00;font-style:italic">//实际需要发送东西给daemon来通知希望监听的内容，所以需要flush
</span><span style="color:#f00;font-style:italic"></span>    dbus_connection_flush(connection);
    <span style="color:#00f">if</span>(dbus_error_is_set(&amp;err)) {
        fprintf(stderr,<span style="color:#009c00">&#34;Match Error %s</span><span style="color:#009c00">\n</span><span style="color:#009c00">&#34;</span>,err.message);
        dbus_error_free(&amp;err);
    }

    <span style="color:#f00;font-style:italic">//步骤4:在循环中监听，每隔开1秒，就去试图自己的连接中获取这个信号。这里给出的是从连接中获取任何消息的方式，所以获取后去检查一下这个消息是否我们期望的信号，并获取内容。我们也可以通过这个方式来获取method call消息。
</span><span style="color:#f00;font-style:italic"></span>    <span style="color:#00f">while</span>(1) {
        dbus_connection_read_write(connection,0);
        msg = dbus_connection_pop_message (connection);
        <span style="color:#00f">if</span>(msg == NULL){
            sleep(1);
            <span style="color:#00f">continue</span>;
        }

        <span style="color:#00f">if</span>(dbus_message_is_signal(msg,<span style="color:#009c00">&#34;test.signal.Type&#34;</span>,<span style="color:#009c00">&#34;Test&#34;</span>) ){
            <span style="color:#00f">if</span>(!dbus_message_iter_init(msg,&amp;arg)) {
                fprintf(stderr,<span style="color:#009c00">&#34;Message Has no Param&#34;</span>);
            } <span style="color:#00f">else</span> <span style="color:#00f">if</span>(dbus_message_iter_get_arg_type(&amp;arg) != DBUS_TYPE_STRING) {
                g_printerr(<span style="color:#009c00">&#34;Param is not string&#34;</span>);
            } <span style="color:#00f">else</span> {
                dbus_message_iter_get_basic(&amp;arg,&amp;sigvalue);
                printf(<span style="color:#009c00">&#34;Got Singal with value : %s</span><span style="color:#009c00">\n</span><span style="color:#009c00">&#34;</span>,sigvalue);
            }
        }
        dbus_message_unref(msg);
    }<span style="color:#f00;font-style:italic">//End of while
</span><span style="color:#f00;font-style:italic"></span>
    <span style="color:#00f">return</span> ;
}

<span style="color:#00f">int</span> <span style="color:#c34e00">main</span>( <span style="color:#00f">int</span> argc , <span style="color:#00f">char</span> ** argv){
    listen_signal();
    <span style="color:#00f">return</span> 0;
}
</code></pre></div><h2 id="method的收发小例子">Method的收发小例子</h2>
<p>现在我们从底层，即libdbus学习如何发送Method以及如何等待应答，在之前的代码中，我们给出了同步方式的代码 ，这是更为高层的处理方式，建议使用。 监听method和监听signal的方式非常相似。在给出例子之前，我希望和上次学习一样给出一个示意图，更好地了解D-Bus的各个概念。</p>
<p><img src="https://thebigdoc.readthedocs.io/en/latest/_images/method_example.png" alt="../_images/method_example.png"></p>
<p>在下面的例子中，我们将学习如何在消息中加入多个参数的情况。</p>
<h3 id="方法监听的例子">方法监听的例子</h3>
<p>Method的监听和signal的监听的处理时一样，但是信号是不需要答复，而Method需要。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#f00;font-style:italic">#include</span> <span style="color:#f00;font-style:italic">&lt;stdio.h&gt;</span><span style="color:#f00;font-style:italic">
</span><span style="color:#f00;font-style:italic">#include</span> <span style="color:#f00;font-style:italic">&lt;stdlib.h&gt;</span><span style="color:#f00;font-style:italic">
</span><span style="color:#f00;font-style:italic">#include</span> <span style="color:#f00;font-style:italic">&lt;string.h&gt;</span><span style="color:#f00;font-style:italic">
</span><span style="color:#f00;font-style:italic">#include</span> <span style="color:#f00;font-style:italic">&lt;dbus/dbus-glib.h&gt;</span><span style="color:#f00;font-style:italic">
</span><span style="color:#f00;font-style:italic">#include</span> <span style="color:#f00;font-style:italic">&lt;dbus/dbus.h&gt;</span><span style="color:#f00;font-style:italic">
</span><span style="color:#f00;font-style:italic">#include</span> <span style="color:#f00;font-style:italic">&lt;unistd.h&gt;</span><span style="color:#f00;font-style:italic">
</span><span style="color:#f00;font-style:italic"></span>
<span style="color:#f00;font-style:italic">/*读取消息的参数，并且返回两个参数，一个是bool值stat，一个是整数level*/</span>
<span style="color:#00f">void</span> <span style="color:#c34e00">reply_to_method_call</span>(DBusMessage * msg, DBusConnection * conn)
{
    DBusMessage * reply;
    DBusMessageIter arg;
    <span style="color:#00f">char</span> * param = NULL;
    dbus_bool_t stat = TRUE;
    dbus_uint32_t level = 2010;
    dbus_uint32_t serial = 0;

    <span style="color:#f00;font-style:italic">//从msg中读取参数，这个在上一次学习中学过
</span><span style="color:#f00;font-style:italic"></span>    <span style="color:#00f">if</span>(!dbus_message_iter_init(msg,&amp;arg)) {
        printf(<span style="color:#009c00">&#34;Message has no args/n&#34;</span>);
    } <span style="color:#00f">else</span> <span style="color:#00f">if</span>(dbus_message_iter_get_arg_type(&amp;arg) != DBUS_TYPE_STRING) {
        printf(<span style="color:#009c00">&#34;Arg is not string!/n&#34;</span>);
    } <span style="color:#00f">else</span> {
        dbus_message_iter_get_basic(&amp;arg,&amp; param);
    }
    <span style="color:#00f">if</span>(param == NULL) <span style="color:#00f">return</span>;

    <span style="color:#f00;font-style:italic">//创建返回消息reply
</span><span style="color:#f00;font-style:italic"></span>    reply = dbus_message_new_method_return(msg);
    <span style="color:#f00;font-style:italic">//在返回消息中填入两个参数，和信号加入参数的方式是一样的。这次我们将加入两个参数。
</span><span style="color:#f00;font-style:italic"></span>    dbus_message_iter_init_append(reply,&amp;arg);
    <span style="color:#00f">if</span>(!dbus_message_iter_append_basic(&amp;arg,DBUS_TYPE_BOOLEAN,&amp;stat)) {
        printf(<span style="color:#009c00">&#34;Out of Memory!/n&#34;</span>);
        exit(1);
    }
    <span style="color:#00f">if</span>(!dbus_message_iter_append_basic(&amp;arg,DBUS_TYPE_UINT32,&amp;level)) {
        printf(<span style="color:#009c00">&#34;Out of Memory!/n&#34;</span>);
        exit(1);
    }
    <span style="color:#f00;font-style:italic">//发送返回消息
</span><span style="color:#f00;font-style:italic"></span>    <span style="color:#00f">if</span>( !dbus_connection_send(conn, reply, &amp;serial)){
        printf(<span style="color:#009c00">&#34;Out of Memory/n&#34;</span>);
        exit(1);
    }
    dbus_connection_flush (conn);
    dbus_message_unref (reply);
}

<span style="color:#f00;font-style:italic">/* 监听D-Bus消息，我们在上次的例子中进行修改 */</span>
<span style="color:#00f">void</span> <span style="color:#c34e00">listen_dbus</span>()
{
    DBusMessage * msg;
    DBusMessageIter arg;
    DBusConnection * connection;
    DBusError err;
    <span style="color:#00f">int</span> ret;
    <span style="color:#00f">char</span> * sigvalue;

    dbus_error_init(&amp;err);
    <span style="color:#f00;font-style:italic">//创建于session D-Bus的连接
</span><span style="color:#f00;font-style:italic"></span>    connection = dbus_bus_get(DBUS_BUS_SESSION, &amp;err);
    <span style="color:#00f">if</span>(dbus_error_is_set(&amp;err)){
        fprintf(stderr,<span style="color:#009c00">&#34;Connection Error %s/n&#34;</span>,err.message);
        dbus_error_free(&amp;err);
    }
    <span style="color:#00f">if</span>(connection == NULL) {
        <span style="color:#00f">return</span>;
    }
    <span style="color:#f00;font-style:italic">//设置一个BUS name：test.wei.dest
</span><span style="color:#f00;font-style:italic"></span>    ret = dbus_bus_request_name(connection,<span style="color:#009c00">&#34;test.wei.dest&#34;</span>,DBUS_NAME_FLAG_REPLACE_EXISTING,&amp;err);
    <span style="color:#00f">if</span>(dbus_error_is_set(&amp;err)) {
        fprintf(stderr,<span style="color:#009c00">&#34;Name Error %s/n&#34;</span>,err.message);
        dbus_error_free(&amp;err);
    }
    <span style="color:#00f">if</span>(ret != DBUS_REQUEST_NAME_REPLY_PRIMARY_OWNER) {
        <span style="color:#00f">return</span>;
    }

    <span style="color:#f00;font-style:italic">//要求监听某个singal：来自接口test.signal.Type的信号
</span><span style="color:#f00;font-style:italic"></span>    dbus_bus_add_match(connection,<span style="color:#009c00">&#34;type=&#39;signal&#39;,interface=&#39;test.signal.Type&#39;&#34;</span>,&amp;err);
    dbus_connection_flush(connection);
    <span style="color:#00f">if</span>(dbus_error_is_set(&amp;err)){
        fprintf(stderr,<span style="color:#009c00">&#34;Match Error %s/n&#34;</span>,err.message);
        dbus_error_free(&amp;err);
    }

    <span style="color:#00f">while</span>(TRUE){
        dbus_connection_read_write (connection,0);
        msg = dbus_connection_pop_message (connection);

        <span style="color:#00f">if</span>(msg == NULL){
            sleep(1);
            <span style="color:#00f">continue</span>;
        }

        <span style="color:#00f">if</span>(dbus_message_is_signal(msg,<span style="color:#009c00">&#34;test.signal.Type&#34;</span>,<span style="color:#009c00">&#34;Test&#34;</span>)){
            <span style="color:#00f">if</span>(!dbus_message_iter_init(msg,&amp;arg)) {
                fprintf(stderr,<span style="color:#009c00">&#34;Message Has no Param&#34;</span>);
            } <span style="color:#00f">else</span> <span style="color:#00f">if</span>(dbus_message_iter_get_arg_type(&amp;arg) != DBUS_TYPE_STRING) {
                g_printerr(<span style="color:#009c00">&#34;Param is not string&#34;</span>);
            } <span style="color:#00f">else</span> {
                dbus_message_iter_get_basic(&amp;arg,&amp;sigvalue);
                printf(<span style="color:#009c00">&#34;Got Singal with value : %s</span><span style="color:#009c00">\n</span><span style="color:#009c00">&#34;</span>,sigvalue);
            }
        }<span style="color:#00f">else</span> <span style="color:#00f">if</span>(dbus_message_is_method_call(msg,<span style="color:#009c00">&#34;test.method.Type&#34;</span>,<span style="color:#009c00">&#34;Method&#34;</span>)){
            <span style="color:#f00;font-style:italic">//我们这里面先比较了接口名字和方法名字，实际上应当现比较路径
</span><span style="color:#f00;font-style:italic"></span>            <span style="color:#00f">if</span>(strcmp(dbus_message_get_path (msg),<span style="color:#009c00">&#34;/test/method/Object&#34;</span>) == 0) {
                reply_to_method_call(msg, connection);
            }
        }
        dbus_message_unref(msg);
    }
}

<span style="color:#00f">int</span> <span style="color:#c34e00">main</span>( <span style="color:#00f">int</span> argc , <span style="color:#00f">char</span> ** argv)
{
    listen_dbus();
    <span style="color:#00f">return</span> 0;
}
</code></pre></div><h3 id="4172-方法调用的例子">4.1.7.2. 方法调用的例子</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#f00;font-style:italic">#include</span> <span style="color:#f00;font-style:italic">&lt;stdio.h&gt;</span><span style="color:#f00;font-style:italic">
</span><span style="color:#f00;font-style:italic">#include</span> <span style="color:#f00;font-style:italic">&lt;stdlib.h&gt;</span><span style="color:#f00;font-style:italic">
</span><span style="color:#f00;font-style:italic">#include</span> <span style="color:#f00;font-style:italic">&lt;string.h&gt;</span><span style="color:#f00;font-style:italic">
</span><span style="color:#f00;font-style:italic">#include</span> <span style="color:#f00;font-style:italic">&lt;dbus/dbus-glib.h&gt;</span><span style="color:#f00;font-style:italic">
</span><span style="color:#f00;font-style:italic">#include</span> <span style="color:#f00;font-style:italic">&lt;dbus/dbus.h&gt;</span><span style="color:#f00;font-style:italic">
</span><span style="color:#f00;font-style:italic">#include</span> <span style="color:#f00;font-style:italic">&lt;unistd.h&gt;</span><span style="color:#f00;font-style:italic">
</span><span style="color:#f00;font-style:italic"></span>
<span style="color:#f00;font-style:italic">//建立与session D-Bus daemo的连接，并设定连接的名字，相关的代码已经多次使用过了
</span><span style="color:#f00;font-style:italic"></span>DBusConnection *  <span style="color:#c34e00">connect_dbus</span>()
{
    DBusError err;
    DBusConnection * connection;
    <span style="color:#00f">int</span> ret;

    <span style="color:#f00;font-style:italic">//Step 1: connecting session bus
</span><span style="color:#f00;font-style:italic"></span>    <span style="color:#f00;font-style:italic">/* initialise the erroes */</span>
    dbus_error_init(&amp;err);
    <span style="color:#f00;font-style:italic">/* Connect to Bus*/</span>
    connection = dbus_bus_get(DBUS_BUS_SESSION, &amp;err);
    <span style="color:#00f">if</span>(dbus_error_is_set(&amp;err)){
        fprintf(stderr,<span style="color:#009c00">&#34;Connection Err : %s</span><span style="color:#009c00">\n</span><span style="color:#009c00">&#34;</span>,err.message);
        dbus_error_free(&amp;err);
    }
    <span style="color:#00f">if</span>(connection == NULL) {
        <span style="color:#00f">return</span> NULL;
    }

    <span style="color:#f00;font-style:italic">//step 2: 设置BUS name，也即连接的名字。
</span><span style="color:#f00;font-style:italic"></span>    ret = dbus_bus_request_name(connection,<span style="color:#009c00">&#34;test.wei.source&#34;</span>,DBUS_NAME_FLAG_REPLACE_EXISTING,&amp;err);
    <span style="color:#00f">if</span>(dbus_error_is_set(&amp;err)) {
        fprintf(stderr,<span style="color:#009c00">&#34;Name Err : %s</span><span style="color:#009c00">\n</span><span style="color:#009c00">&#34;</span>,err.message);
        dbus_error_free(&amp;err);
    }

    <span style="color:#00f">if</span>(ret != DBUS_REQUEST_NAME_REPLY_PRIMARY_OWNER) {
        <span style="color:#00f">return</span> NULL;
    }

    <span style="color:#00f">return</span> connection;
}

<span style="color:#00f">void</span> <span style="color:#c34e00">send_a_method_call</span>(DBusConnection * connection,<span style="color:#00f">char</span> * param)
{
    DBusError err;
    DBusMessage * msg;
    DBusMessageIter    arg;
    DBusPendingCall * pending;
    dbus_bool_t * stat;
    dbus_uint32_t * level;

    dbus_error_init(&amp;err);

    <span style="color:#f00;font-style:italic">//针对目的地地址，请参考图，创建一个method call消息。 Constructs a new message to invoke a method on a remote object.
</span><span style="color:#f00;font-style:italic"></span>    msg = dbus_message_new_method_call (<span style="color:#009c00">&#34;test.wei.dest&#34;</span>,<span style="color:#009c00">&#34;/test/method/Object&#34;</span>,<span style="color:#009c00">&#34;test.method.Type&#34;</span>,<span style="color:#009c00">&#34;Method&#34;</span>);
    <span style="color:#00f">if</span>(msg == NULL) {
        g_printerr(<span style="color:#009c00">&#34;Message NULL&#34;</span>);
        <span style="color:#00f">return</span>;
    }

    <span style="color:#f00;font-style:italic">//为消息添加参数。Append arguments
</span><span style="color:#f00;font-style:italic"></span>    dbus_message_iter_init_append(msg, &amp;arg);
    <span style="color:#00f">if</span>(!dbus_message_iter_append_basic (&amp;arg, DBUS_TYPE_STRING,&amp;param)) {
        g_printerr(<span style="color:#009c00">&#34;Out of Memory!&#34;</span>);
        exit(1);
    }

    <span style="color:#f00;font-style:italic">//发送消息并获得reply的handle 。Queues a message to send, as with dbus_connection_send() , but also returns a DBusPendingCall used to receive a reply to the message.
</span><span style="color:#f00;font-style:italic"></span>    <span style="color:#00f">if</span>(!dbus_connection_send_with_reply(connection, msg,&amp;pending, -1)){
        g_printerr(<span style="color:#009c00">&#34;Out of Memory!&#34;</span>);
        exit(1);
    }

    <span style="color:#00f">if</span>(pending == NULL) {
        g_printerr(<span style="color:#009c00">&#34;Pending Call NULL: connection is disconnected &#34;</span>);
        dbus_message_unref(msg);
        <span style="color:#00f">return</span>;
    }

    dbus_connection_flush(connection);
    dbus_message_unref(msg);

    <span style="color:#f00;font-style:italic">//waiting a reply，在发送的时候，已经获取了method reply的handle，类型为DBusPendingCall。
</span><span style="color:#f00;font-style:italic"></span>    <span style="color:#f00;font-style:italic">// block until we recieve a reply， Block until the pending call is completed.
</span><span style="color:#f00;font-style:italic"></span>    dbus_pending_call_block (pending);
    <span style="color:#f00;font-style:italic">// get the reply message，Gets the reply, or returns NULL if none has been received yet.
</span><span style="color:#f00;font-style:italic"></span>    msg = dbus_pending_call_steal_reply (pending);
    <span style="color:#00f">if</span> (msg == NULL) {
        fprintf(stderr, <span style="color:#009c00">&#34;Reply Null</span><span style="color:#009c00">\n</span><span style="color:#009c00">&#34;</span>);
         exit(1);
    }
     <span style="color:#f00;font-style:italic">// free the pending message handle
</span><span style="color:#f00;font-style:italic"></span>     dbus_pending_call_unref(pending);
    <span style="color:#f00;font-style:italic">// read the parameters
</span><span style="color:#f00;font-style:italic"></span>    <span style="color:#00f">if</span> (!dbus_message_iter_init(msg, &amp;arg)) {
        fprintf(stderr, <span style="color:#009c00">&#34;Message has no arguments!</span><span style="color:#009c00">\n</span><span style="color:#009c00">&#34;</span>);
    } <span style="color:#00f">else</span> <span style="color:#00f">if</span> ( dbus_message_iter_get_arg_type (&amp;arg) != DBUS_TYPE_BOOLEAN) {
        fprintf(stderr, <span style="color:#009c00">&#34;Argument is not boolean!</span><span style="color:#009c00">\n</span><span style="color:#009c00">&#34;</span>);
    } <span style="color:#00f">else</span> {
        dbus_message_iter_get_basic (&amp;arg, &amp;stat);
    }

    <span style="color:#00f">if</span> (!dbus_message_iter_next(&amp;arg)) {
        fprintf(stderr, <span style="color:#009c00">&#34;Message has too few arguments!</span><span style="color:#009c00">\n</span><span style="color:#009c00">&#34;</span>);
    } <span style="color:#00f">else</span> <span style="color:#00f">if</span> ( dbus_message_iter_get_arg_type (&amp;arg) != DBUS_TYPE_UINT32 ) {
        fprintf(stderr, <span style="color:#009c00">&#34;Argument is not int!</span><span style="color:#009c00">\n</span><span style="color:#009c00">&#34;</span>);
    } <span style="color:#00f">else</span> {
        dbus_message_iter_get_basic (&amp;arg, &amp;level);
    }

    printf(<span style="color:#009c00">&#34;Got Reply: %d, %d</span><span style="color:#009c00">\n</span><span style="color:#009c00">&#34;</span>, (<span style="color:#00f">int</span>)stat, (<span style="color:#00f">int</span>)level);
    dbus_message_unref(msg);
}

<span style="color:#00f">int</span> <span style="color:#c34e00">main</span>( <span style="color:#00f">int</span> argc , <span style="color:#00f">char</span> ** argv)
{
    DBusConnection * connection;

    connection = connect_dbus();
    <span style="color:#00f">if</span>(connection == NULL) {
        <span style="color:#00f">return</span> -1;
    }

    send_a_method_call(connection,<span style="color:#009c00">&#34;Hello, D-Bus&#34;</span>);
    <span style="color:#00f">return</span> 0;
}
</code></pre></div><h2 id="418-使用xml定义d-bus接口">4.1.8. 使用xml定义D-Bus接口</h2>
<p>在D-Bus中，可以将D-Bus接口定义用XML格式表述处理，并利用工具，自动生成头文件，给出工整的调用方式。</p>
<p>下面是一个XML的例子。</p>
<h3 id="客户端">客户端</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml"><span style="color:#f00;font-style:italic">&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34; ?&gt;</span>

&lt;node name=<span style="color:#009c00">&#34;/com/wei/MyObject&#34;</span>&gt;
    &lt;interface name=<span style="color:#009c00">&#34;com.wei.MyObject.Sample&#34;</span>&gt;
        &lt;method name=<span style="color:#009c00">&#34;Test&#34;</span>&gt;
            &lt;annotation name=<span style="color:#009c00">&#34;org.freedesktop.DBus.GLib.CSymbol&#34;</span> value=<span style="color:#009c00">&#34;wei_response&#34;</span> /&gt; 
            &lt;arg type=<span style="color:#009c00">&#34;u&#34;</span> name=<span style="color:#009c00">&#34;x&#34;</span> direction=<span style="color:#009c00">&#34;in&#34;</span> /&gt;
            &lt;arg type=<span style="color:#009c00">&#34;d&#34;</span> name=<span style="color:#009c00">&#34;d_ret&#34;</span> direction=<span style="color:#009c00">&#34;out&#34;</span> /&gt;
        &lt;/method&gt;
    &lt;/interface&gt;
&lt;/node&gt;
</code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">dbus-binding-tool --mode=glib-client --prefix=com_wei wei.xml &gt; wei_client.h
</code></pre></div><h3 id="服务端">服务端</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml"><span style="color:#f00;font-style:italic">&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34; ?&gt;</span>
&lt;node name=<span style="color:#009c00">&#34;/com/wei/MyObject&#34;</span>&gt;
    &lt;interface name=<span style="color:#009c00">&#34;com.wei.MyObject.Sample&#34;</span>&gt;
        &lt;method name=<span style="color:#009c00">&#34;Test&#34;</span>&gt;
            &lt;arg name=<span style="color:#009c00">&#34;x&#34;</span> type=<span style="color:#009c00">&#34;u&#34;</span> direction=<span style="color:#009c00">&#34;in&#34;</span> /&gt;
            &lt;arg name=<span style="color:#009c00">&#34;d_ret&#34;</span> type=<span style="color:#009c00">&#34;d&#34;</span> direction=<span style="color:#009c00">&#34;out&#34;</span> /&gt;
        &lt;/method&gt;
    &lt;/interface&gt;
&lt;/node&gt;
</code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">dbus-binding-tool --mode=glib-server --prefix=com_wei wei.xml &gt; wei_server.h
</code></pre></div><h2 id="其他参考资料">其他参考资料</h2>
<ol>
<li><a href="https://thebigdoc.readthedocs.io/en/latest/dbus/_static/doc/qtdbus.pdf">Nokia D-Bus page</a></li>
<li><a href="http://developer.nokia.com/community/wiki/QtDbus_quick_tutorial">Nokia D-Bus page</a></li>
<li><a href="https://thebigdoc.readthedocs.io/en/latest/dbus/_static/doc/qt-dbus-example.pdf">KDE Base D-Bus example</a></li>
<li><a href="http://techbase.kde.org/Development/Tutorials/D-Bus/CustomTypes?setlang=zh-cn#Generate_Adaptor_and_Interface_classes">KDE Base D-Bus example</a></li>
<li><a href="https://thebigdoc.readthedocs.io/en/latest/dbus/_static/doc/qt-dbus-telepathy.pdf">telepathy D-Bus page</a></li>
<li><a href="http://telepathy.freedesktop.org/doc/book/sect.basics.dbus.html">telepathy D-Bus page</a></li>
</ol>
<p><a href="https://thebigdoc.readthedocs.io/en/latest/dbus/system-dbus.html">Next </a><a href="https://thebigdoc.readthedocs.io/en/latest/dbus/index.html"> Previous</a></p>
<hr>
<p><a href="https://thebigdoc.readthedocs.io/en/latest/dbus/dbus.html">以上内容转载自本链接，若有侵权，请联系站长</a></p>

    </div>
    <footer class="post-footer">
     
 
<div class="post-tags">     
     
    <a href="http://shanks.link/tags/openwrt" rel="tag" title="OpenWrt">#OpenWrt#</a>
    
</div>



     <div class="post-nav">
    <div class="post-nav-next post-nav-item">
    
        <a href="http://shanks.link/blog/2022/11/22/%E5%B8%B8%E8%A7%81%E7%9A%84%E7%BD%91%E7%BB%9C%E8%AE%BE%E5%A4%87%E9%9B%86%E7%BA%BF%E5%99%A8-hub%E7%BD%91%E6%A1%A5%E4%BA%A4%E6%8D%A2%E6%9C%BA-switch%E8%B7%AF%E7%94%B1%E5%99%A8-router%E7%BD%91%E5%85%B3-gateway/" rel="next" title="常见的网络设备：集线器 hub、网桥、交换机 switch、路由器 router、网关 gateway">
        <i class="fa fa-chevron-left"></i> 常见的网络设备：集线器 hub、网桥、交换机 switch、路由器 router、网关 gateway
        </a>
    
    </div>

    <div class="post-nav-prev post-nav-item">
    
        <a href="http://shanks.link/blog/2022/11/12/%E5%9F%BA%E7%A1%80%E5%AD%A6%E4%B9%A0%E4%B9%8B-%E7%AC%AC%E5%8D%81%E4%BA%8C%E7%AB%A0-shell-scripts/" rel="prev" title="基础学习之 第十二章 Shell Scripts">
        基础学习之 第十二章 Shell Scripts <i class="fa fa-chevron-right"></i>
        </a>
    
    </div>
</div>
      
     
     
     





<script src="https://utteranc.es/client.js"
        repo="shankusu2017@gmail.com/"
        issue-term="pathname"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>
<noscript>Please enable JavaScript to view the <a href="https://github.com/utterance">comments powered by utterances.</a></noscript>

    </footer>
  </article>
</section>

          </div>
        </div>
        <div class="sidebar-toggle">
  <div class="sidebar-toggle-line-wrap">
    <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
    <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
    <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
  </div>
</div>
<aside id="sidebar" class="sidebar">
  <div class="sidebar-inner">

    <section class="site-overview sidebar-panel  sidebar-panel-active ">
      <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image"
        src="http://shanks.link/img/logo.jpg"
        alt="shankusu2017@gmail.com" />
    <p class="site-author-name" itemprop="name">shankusu2017@gmail.com</p>
    <p class="site-description motion-element" itemprop="description"> </p>
</div>
      <nav class="site-state motion-element">
    <div class="site-state-item site-state-posts">
        <a href="http://shanks.link/post/">
            <span class="site-state-item-name">日志</span>
        </a>
    </div>
    <div class="site-state-item site-state-categories">
        <a href="http://shanks.link/categories/">
            <span class="site-state-item-name">分类</span>
        </a>
    </div>

    <div class="site-state-item site-state-tags">
        <a href="http://shanks.link/tags/">
            <span class="site-state-item-name">标签</span>
        </a>
    </div>
</nav>

      
      
<div class="links-of-author motion-element">
    
        <span class="links-of-author-item">
        <a href="https://github.com/shankusu2017" target="_blank" title="GitHub">
            <i class="fa fa-fw fa-github"></i>
            GitHub
        </a>
        </span>
    
</div>


      

      <div class="links-of-blogroll motion-element inline">
<script type="text/javascript" src="//rf.revolvermaps.com/0/0/8.js?i=5b4f2ucxar6&amp;m=0&amp;s=220&amp;c=ff0000&amp;cr1=ffffff&amp;f=arial&amp;l=33&amp;bv=35" async="async"></script>
</div>

    </section>
    
  </div>
</aside>

      </div>
    </main>
   
    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  <span itemprop="copyrightYear">  &copy; 
  2009 - 2024</span>
</div>
<div>
  <a href="https://beian.miit.gov.cn/" rel="noopener" target="_blank">粤ICP备2021068940号-1</a>
  <a href="https://www.beian.gov.cn/portal/registerSystemInfo?recordcode=44011302003059" rel="noopener" target="_blank">粤公网安备44011302003059</a>
</div>


      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
      <span id="scrollpercent"><span>0</span>%</span>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>
<script type="text/javascript" src="http://shanks.link/js/vendor/jquery/index.js?v=2.1.3"></script>
<script type="text/javascript" src="http://shanks.link/js/vendor/fastclick/lib/fastclick.min.js?v=1.0.6"></script> 
<script type="text/javascript" src="http://shanks.link/js/vendor/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
<script type="text/javascript" src="http://shanks.link/js/vendor/velocity/velocity.min.js?v=1.2.1"></script>
<script type="text/javascript" src="http://shanks.link/js/vendor/velocity/velocity.ui.min.js?v=1.2.1"></script>
<script src="http://shanks.link/js/vendor/ua-parser-js/dist/ua-parser.min.js?v=0.7.9"></script>

<script src="http://shanks.link/js/vendor/fancybox/jquery.fancybox.pack.js?v=2.1.5"></script>

<script type="text/javascript" src="http://shanks.link/js/utils.js"></script>
<script type="text/javascript" src="http://shanks.link/js/motion.js"></script>
<script type="text/javascript" src="http://shanks.link/js/affix.js"></script>
<script type="text/javascript" src="http://shanks.link/js/schemes/pisces.js"></script>

<script type="text/javascript" src="http://shanks.link/js/scrollspy.js"></script>
<script type="text/javascript" src="http://shanks.link/js/post-details.js"></script>
<script type="text/javascript" src="http://shanks.link/js/toc.js"></script>

<script type="text/javascript" src="http://shanks.link/js/bootstrap.js"></script>

<script type="text/javascript" src="http://shanks.link/js/search.js"></script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX", "output/HTML-CSS"],
    tex2jax: {
      inlineMath: [ ['$','$'] ],
      displayMath: [ ['$$','$$'] ],
      processEscapes: true
    },
    "HTML-CSS": { fonts: ["TeX"] }
  });
</script>
<script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML' async></script>
</body>
</html>