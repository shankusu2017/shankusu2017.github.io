<!DOCTYPE HTML>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" /> 
    <title>OpenWrt netifd学习笔记 - Golang入门指南</title>
    <meta name="keywords" content="Golang,golang,go,git,Git,Lua,lua">
    
    <meta property="og:title" content="OpenWrt netifd学习笔记">
    <meta property="og:site_name" content="Golang入门指南">
    <meta property="og:image" content="/img/author.jpg"> 
    <meta name="title" content="OpenWrt netifd学习笔记 - Golang入门指南" />
    <meta name="description" content="愿星光伴你左右"> 
    <link rel="shortcut icon" href="http://shanks.link/img/favicon.ico" />
    <link rel="apple-touch-icon" href="http://shanks.link/img/apple-touch-icon.png" />
    <link rel="apple-touch-icon-precomposed" href="http://shanks.link/img/apple-touch-icon.png" />
    <link href="http://shanks.link/js/vendor/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />
    <link href="http://shanks.link/js/vendor/fancybox/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />
    <link href="http://shanks.link/css/main.css" rel="stylesheet" type="text/css" />
    <link href="http://shanks.link/css/syntax.css" rel="stylesheet" type="text/css" />
    <script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post"},
     fancybox: true, 
    motion: true
  };
</script>
</head>
<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">
<div class="container one-collumn sidebar-position-left page-home  ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"> <div class="site-meta  custom-logo ">

  <div class="custom-logo-site-title">
    <a href="http://shanks.link/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">Golang入门指南</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle"></p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
    <ul id="menu" class="menu">
      
      
        <li class="menu-item ">
          <a href="http://shanks.link/post/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />首页
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/todo/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />todo
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/thinking/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />思考
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/life/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />life
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/food/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />food
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/os/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />OS
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/lua/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />lua
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/redis/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />redis
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/go/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />Golang
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/c/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />C
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/tcpip/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />TCP/IP
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/ebpf/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />ebpf
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/p4/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />p4
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/openvpn/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />OpenVPN
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/ipsec/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />IPSec
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/l2tp/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />L2TP
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/dns/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />DNS
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/distributed/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />distributed
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/web/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />web
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/openwrt/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />OpenWRT
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/%E8%BF%90%E7%BB%B4/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />运维
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/git/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />Git
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/%E9%B8%9F%E5%93%A5%E7%9A%84%E7%A7%81%E6%88%BF%E8%8F%9C/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />鸟哥的私房菜
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/it/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />IT杂谈
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/finance/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />投资
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/about/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />About Me
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/links/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />友情链接
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/ftp/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />FTP
          </a>
        </li>
      
      <li class="menu-item menu-item-search">
        <a href="javascript:;" class="popup-trigger"> <i class="menu-item-icon fa fa-search fa-fw"></i> <br /> 搜索</a>
      </li>
    </ul>
    <div class="site-search">
      <div class="popup">
 <span class="search-icon fa fa-search"></span>
 <input type="text" id="local-search-input">
 <div id="local-search-result"></div>
 <span class="popup-btn-close">close</span>
</div>

    </div>
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
<section id="posts" class="posts-expand">
  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <header class="post-header">
      <h1 class="post-title" itemprop="name headline">
        <a class="post-title-link" href="http://shanks.link/blog/2022/10/20/openwrt-netifd%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" itemprop="url">
        OpenWrt netifd学习笔记
        </a>
      </h1>
      <div class="post-meta">
      <span class="post-time">
<span class="post-meta-item-icon">
    <i class="fa fa-calendar-o"></i>
</span>
<span class="post-meta-item-text">时间：</span>
<time itemprop="dateCreated" datetime="2016-03-22T13:04:35+08:00" content="2022-10-20">
    2022-10-20
</time>
</span> 
      

  <span class="post-category" >
  &nbsp; | &nbsp;
  <span class="post-meta-item-icon">
    <i class="fa fa-folder-o"></i>
  </span>
  <span class="post-meta-item-text">分类：</span>
  
    <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
      <a href="http://shanks.link/categories/openwrt" itemprop="url" rel="index">
        <span itemprop="name">OpenWrt</span>
      </a>
      &nbsp; 
    </span>
  
</span>


       <span>
&nbsp; | &nbsp;
<span class="post-meta-item-icon">
    <i class="fa fa-eye"></i>
</span>
<span class="post-meta-item-text">阅读：</span>
<span class="leancloud-visitors-count">4737 字 ~10分钟</span>
</span>
      </div>
    </header>
    <div class="post-body" itemprop="articleBody">
    <h1 id="netifd简介">Netifd简介</h1>
<p>Netifd是<a href="https://so.csdn.net/so/search?q=OpenWrt&amp;spm=1001.2101.3001.7020">OpenWrt</a>中用于进行网络配置的守护进程，基本上所有网络接口设置以及内核的netlink事件都可以由netifd来处理完成。
在启动netifd之前用户需要将所需的配置写入uci配置文件/etc/config/network中，以告知netifd如何设置这些网络接口，如IP地址、上网类型等。如果在netifd运行过程中需要修改配置，则只需更新并保存/etc/config/network，执行/etc/init.d/network reload，netifd便可根据配置文件差异快速地完成网络接口的更新。</p>
<h1 id="netifd基本框架">Netifd基本框架</h1>
<p>我们配置一个网络接口通常都要完成下面三类工作：
\1. MAC地址、设备MTU、协商速率等L2属性，这些都是直接操作实际网络设备的。
\2. IP地址、路由（包括应用层的DNS）等L3属性。
\3. 设置特定接入方式，如静态IP、DHCP、PPPoE等。设置完成后可能需要更新L3的属性。
我们可以通过上述思路来理解netifd的设计：
<img src="http://shanks.link/img/openwrt/20170711172621294.png" alt="Netifd设计框架">
拿我们最常用的路由器来讲，作为路由器的使用者我们只关心要配置interface层的哪个接口（LAN口、WAN口？），以及配置成怎样的上网方式。使用netifd配置网络，也是以interface为中心：创建一个interface并指明其依赖的实际网络设备（device），及其绑定的上网方式（proto handler），就完成了一个网络接口的配置并可使其开始工作。当网络状态发生变化时，这三者之间也能相互通知（事件通知或引用计数)以完成自身状态的转换。
例如，在/etc/config/network中对WAN口的配置如下 ：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>config interface &#39;wan&#39;
</span></span><span style="display:flex;"><span>    option ifname &#39;eth0&#39;
</span></span><span style="display:flex;"><span>    option proto &#39;static&#39;
</span></span><span style="display:flex;"><span>    option mtu &#39;1500&#39;
</span></span><span style="display:flex;"><span>    option auto &#39;1&#39;
</span></span><span style="display:flex;"><span>    option netmask &#39;255.255.255.0&#39;
</span></span><span style="display:flex;"><span>    option ipaddr &#39;192.168.1.100&#39;   
</span></span><span style="display:flex;"><span>    option gateway &#39;192.168.1.1&#39;
</span></span><span style="display:flex;"><span>    option dns &#39;8.8.8.8&#39;123456789
</span></span></code></pre></div><p>Netifd通过读取上述配置，来创建出一个名为”WAN”的interface实例并将其中与interface相关的配置项应用到这个新创建的实例中。同时，如果其指定依赖的设备（ifname）不存在，就通过配置中与device相关的配置项创建一个新的device，并确定二者的依赖（引用）关系。由于proto handler中每一种proto的工作方式是确定的，不依赖于任何配置，因此在netifd启动时就会初始化好所有的proto handler，因而要求配置中的proto一项必须是在netifd中已存在的proto handler的名字。
也可以单独用一个uci section来保存device的配置信息，让netifd先把device创建好。</p>
<h1 id="设备层device">设备层（Device）</h1>
<p>Device是指链路层的设备，在netifd中就特指链路层的网络设备。Netifd中每个设备都用一个struct device结构的实例来表示，例如典型的物理设备、bridge（一个网桥设备实际是对应一个struct bridge_state实例，但和通用设备相关的属性仍放在其dev成员中）、VLAN设备等。
创建好一个设备后，如果要引用这个设备，就要注册一个device_user，像上面说的，device的user一般是interface，但也有device之间相互引用的情况，例如bridge member和bridge的关系。向device注册和注销device_user的函数为device_add_user(user, dev)和device_remove_user(user)。</p>
<h2 id="device-user">Device user</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-gdscript3" data-lang="gdscript3"><span style="display:flex;"><span>/*
</span></span><span style="display:flex;"><span> * device dependency with callbacks
</span></span><span style="display:flex;"><span>*/
</span></span><span style="display:flex;"><span>struct device_user {
</span></span><span style="display:flex;"><span>    struct list_head list;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    bool claimed;
</span></span><span style="display:flex;"><span>    bool hotplug;
</span></span><span style="display:flex;"><span>    bool alias;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    struct device *dev;
</span></span><span style="display:flex;"><span>    void (*cb)(struct device_user *, <span style="color:#00f">enum</span> device_event);
</span></span><span style="display:flex;"><span>};12345678910111213
</span></span></code></pre></div><p>各个成员的含义：
<strong>list</strong>：该user引用的deivce的user链表节点。
<strong>claimed</strong>：相当于引用计数，由于一个user实例只能作为某一个device的user，因此设为BOOL类型。一个user在绑定了device后，还要通过device_claim才算真正使用了device。这样就允许引用和生效可以不同时进行，例如要等热插拔设备存在时才能启动interface。与claim相反的操作为device_release()。
<strong>hotplug</strong>：标识bridge下动态添加的、以及调ubus call network.interface add_device的设备。
<strong>alias</strong>：用来标记将该user加到device的users链表还是aliases链表。
<strong>dev</strong>：该user引用的device对象指针。
<strong>cb()</strong>：当device状态发生变化时，会调用该cb()函数以事件的形式来通知所有的users。目前支持的事件类型可参考netifd的DESIGN。</p>
<p>设备struct device中也维护了一个引用计数来控制设备的up/down状态，每次device_claim(user)成功后，引用计数+1，每次device_release(user)成功后，引用计数-1。当引用计数从0变1，即有一个user使用了该device时，device就会被UP起来，而当引用计数从1变0，即最后一个user离开时，device就会立即被DOWN掉。</p>
<h1 id="接口层interface">接口层（interface）</h1>
<p>由于device属于L2层的概念，如果用户对一个网络设备配置属于L3或更高层协议的属性，则要直接对interface进行操作，进而间接作用于device。因此一个interface必须绑定到一个device上，通过struct interface的main_dev成员指定。
Interface配置完成后，是否可以UP或DOWN由available和autostart两个成员来决定：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>struct interface {
</span></span><span style="display:flex;"><span>    … …
</span></span><span style="display:flex;"><span>    bool available;
</span></span><span style="display:flex;"><span>    bool autostart;
</span></span><span style="display:flex;"><span>    bool config_autostart; /* uci配置中的&#34;autostart&#34;，默认为true。仅用于uci有关的操作 */
</span></span><span style="display:flex;"><span>    … …
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>12345678
</span></span></code></pre></div><p><strong>available</strong>：interface是否是可用的(已准备好可以up了)，通过interface_set_available()来设置。
<strong>autostart</strong>：interface在配置完成后，是否自动执行up操作，默认和config_autostart值相同。但如果用户手动up了interface(如通过ubus来up)，则autostart强制变为true。如果用户手动down了interface(如通过ubus来down)，则autostart强制变为false。</p>
<p>而一个interface的具体配置内容都放在struct interface_ip_settings的结构中，由于一个interface可能有多个IP/Route/DNS条目，因此将这些信息又封装了一层，而不是直接放到struct interface中。</p>
<h2 id="interface-user">Interface user</h2>
<p>不常用。Alias设备会产生一个interface user，用于指明自己的parent。Alias自身作为user的信息保存在struct interface的parent_iface成员中，而其parent则用struct interface的parent_ifname来指定。</p>
<h1 id="netifd的uci配置">Netifd的uci配置</h1>
<p>只要熟悉uci那些API，对netifd启动和reload时读取配置这部分内容就很容易理解了。Netfid使用名为network的配置文件。</p>
<h1 id="proto-shell">Proto shell</h1>
<h2 id="proto-handler的注册">Proto handler的注册</h2>
<p>通过构造函数，在netifd启动的时候便注册了一系列的proto handler（注册到一个全局的AVL树中）。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>proto_shell_init() -&gt; proto_shell_add_script() -&gt; proto_shell_add_handler() -&gt; add_proto_handler();
</span></span><span style="display:flex;"><span>static_proto_init() -&gt; add_proto_handler();12
</span></span></code></pre></div><p>注册的过程为：在/lib/netifd/proto目录下对每个.sh文件执行***./xxx.sh ” dump***，然后分析执行结果。例如对于dhcp.sh：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>root@openwrt:/lib/netifd/proto# ./dhcp.sh &#39;&#39; dump
</span></span><span style="display:flex;"><span>{ &#34;name&#34;: &#34;dhcp&#34;, &#34;config&#34;: [ [ &#34;ipaddr&#34;, 3 ], [ &#34;netmask&#34;, 3 ], [ &#34;hostname&#34;, 3 ], [ &#34;clientid&#34;, 3 ]
</span></span><span style="display:flex;"><span>, [ &#34;vendorid&#34;, 3 ], [ &#34;enable_broadcast&#34;, 7 ], [ &#34;reqopts&#34;, 3 ] ], &#34;no-device&#34;: false, &#34;available&#34;: 
</span></span><span style="display:flex;"><span>false }
</span></span><span style="display:flex;"><span>12345
</span></span></code></pre></div><p>而最终该脚本的proto handler保存在一个struct proto_handler结构的实体中，并添加到全局的handler树中，供后续查找和引用。上述的dhcp.sh注册的结果为：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>struct proto_shell_handler *handler;
</span></span><span style="display:flex;"><span>handler-&gt;script_name = &#34;./dhcp.sh&#34;;
</span></span><span style="display:flex;"><span>handler-&gt;proto.name = &#34;dhcp&#34;;
</span></span><span style="display:flex;"><span>handler-&gt;proto.config_params = &amp;handler-&gt;config;
</span></span><span style="display:flex;"><span>handler-&gt;proto.attach = proto_shell_attach;
</span></span><span style="display:flex;"><span>handler-&gt;proto.flags |= ...; //由no-device和available决定，ppp使用，static和dhcp不关注
</span></span><span style="display:flex;"><span>handler-&gt;proto.avl.key = handler-&gt;proto.name; //插到handler树中的key
</span></span><span style="display:flex;"><span>handler-&gt;config.n_params = 7; //下面config param的数目
</span></span><span style="display:flex;"><span>handler-&gt;config_buf = &#34;ipaddr\0netmask\0hostname ...&#34;
</span></span><span style="display:flex;"><span>handler-&gt;config.params[0].name = &#34;ipaddr&#34;;
</span></span><span style="display:flex;"><span>handler-&gt;config.params[0].type = 3; //BLOBMSG_TYPE_STRING
</span></span><span style="display:flex;"><span>handler-&gt;config.params[1].name = &#34;netmask&#34;;
</span></span><span style="display:flex;"><span>handler-&gt;config.params[1].type = 3;
</span></span><span style="display:flex;"><span>... ...
</span></span><span style="display:flex;"><span>123456789101112131415
</span></span></code></pre></div><p>其中handler-&gt;proto.config_params中的配置列表，就是为了使proto生效，而需要在uci中配置的项。
而对于static的proto handler内容就比较简单，直接在netifd代码中定义的：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>static struct proto_handler static_proto = {
</span></span><span style="display:flex;"><span>    .name = &#34;static&#34;,
</span></span><span style="display:flex;"><span>    .flags = PROTO_FLAG_IMMEDIATE,
</span></span><span style="display:flex;"><span>    .config_params = &amp;proto_ip_attr,
</span></span><span style="display:flex;"><span>    .attach = static_attach,
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>1234567
</span></span></code></pre></div><p>值得注意的是，static proto携带了PROTO_FLAG_IMMEDIATE标记。</p>
<h2 id="proto与interface的绑定">Proto与interface的绑定</h2>
<p>interface的config中具有名为”proto”的属性，在interface_init()函数中读取uci配置获取proto的名字（如”static”、”dhcp”、”pptp”），然后查找已注册的对应名字的proto handler，并赋值给interface的proto_handler数据成员，这样就使一个interface绑定到了一个特定的proto handler上。这是在初始化一个interface的时候完成的。</p>
<h2 id="proto与interface的交互">Proto与interface的交互</h2>
<p>由于proto是更上层的概念，因此是与interface无关的，而一个interface总会关联到一种proto。例如，WAN口总会要设置一种上网方式（static/dhcp/pppoe等），因此在interface进行配置的过程中，通过调用其proto_handler的attach()方法，为自己分配一个struct interface_proto_state结构并赋值给interface的proto数据成员。这个过程是在proto_init_interface()函数中完成的。也就是说，interface通过其proto成员与proto层交互来通知proto自身状态的变化。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-gdscript3" data-lang="gdscript3"><span style="display:flex;"><span>struct interface_proto_state {
</span></span><span style="display:flex;"><span>    <span style="color:#00f">const</span> struct proto_handler *handler; //其对应的proto handler
</span></span><span style="display:flex;"><span>    struct interface_t *iface; //其attach的interface
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    /* 由proto的user来赋值，对于interface，被统一赋值为了interface_proto_cb */
</span></span><span style="display:flex;"><span>    void (*proto_event)(struct interface_proto_state *, <span style="color:#00f">enum</span> interface_proto_event ev);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    /* 由特定proto handler来赋值。 */
</span></span><span style="display:flex;"><span>    int (*notify)(struct interface_proto_state *, struct blob_attr *data);
</span></span><span style="display:flex;"><span>    int (*cb)(struct interface_proto_state *, <span style="color:#00f">enum</span> interface_proto_cmd cmd, bool force);
</span></span><span style="display:flex;"><span>    void (*free)(struct interface_proto_state *);
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>12345678910111213
</span></span></code></pre></div><p>这个结构中的几个方法：
<strong>cb</strong>: 在interface向proto发送某个事件event时，proto的处理函数。目前proto接受的事件有两个：PROTO_CMD_SETUP和PROTO_CMD_TEARDOWN。
<strong>proto_event</strong>: 在proto处理event完成后，如果需要告知interface处理已完成，就调用该方法。Interface会根据这个回复的消息做这个event的收尾工作。
<strong>notify</strong>: 如果proto需要主动改变interface的状态，则调用该方法。可以在/lib/netifd/netifd-proto.sh中去了解不同”action”的值的含义以及如何通过ubus通知到netifd的，netifd收到notify的消息后，由proto_shell_notify()进行处理。
<strong>free</strong>: 释放自己的struct interface_proto_state指针。</p>
<p>Interface通过interface_proto_event()函数向proto层发送事件来告知其自身状态的变化，即这个函数是interface层通向proto层的入口，在interface的状态变为IFS_SETUP或IFS_TEARDOWN的时候都会通过该函数通知到proto，发送的事件对应为PROTO_CMD_SETUP和PROTO_CMD_TEARDOWN。</p>
<h1 id="参考资料">参考资料</h1>
<p>[1] <a href="https://wiki.openwrt.org/doc/techref/netifd">https://wiki.openwrt.org/doc/techref/netifd</a> OpenWrt Wiki - netifd Technical Reference
[2] <a href="http://git.openwrt.org/?p=project/netifd.git;a=blob;f=DESIGN">http://git.openwrt.org/?p=project/netifd.git;a=blob;f=DESIGN</a> netifd DESIGN
[3] <a href="http://git.openwrt.org/?p=project/netifd.git;a=summary">http://git.openwrt.org/?p=project/netifd.git;a=summary</a> netifd project</p>
<p><a href="https://blog.csdn.net/jasonchen_gbd/article/details/74990247">以上内容转载自此URL，若有侵权请联系站长</a></p>

    </div>
    <footer class="post-footer">
     
 
<div class="post-tags">     
     
    <a href="http://shanks.link/tags/openwrt" rel="tag" title="OpenWrt">#OpenWrt#</a>
    
</div>



     <div class="post-nav">
    <div class="post-nav-next post-nav-item">
    
        <a href="http://shanks.link/blog/2022/10/20/openwrt-luci-%E5%85%A5%E9%97%A8%E4%B8%80/" rel="next" title="Openwrt LuCI 入门（一）">
        <i class="fa fa-chevron-left"></i> Openwrt LuCI 入门（一）
        </a>
    
    </div>

    <div class="post-nav-prev post-nav-item">
    
        <a href="http://shanks.link/blog/2022/10/20/openwrt-ubus%E5%AE%9E%E7%8E%B0%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1%E4%B8%BE%E4%BE%8B/" rel="prev" title="Openwrt ubus实现进程间通信举例">
        Openwrt ubus实现进程间通信举例 <i class="fa fa-chevron-right"></i>
        </a>
    
    </div>
</div>
      
     
     
     





<script src="https://utteranc.es/client.js"
        repo="shankusu2017@gmail.com/"
        issue-term="pathname"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>
<noscript>Please enable JavaScript to view the <a href="https://github.com/utterance">comments powered by utterances.</a></noscript>

    </footer>
  </article>
</section>

          </div>
        </div>
        <div class="sidebar-toggle">
  <div class="sidebar-toggle-line-wrap">
    <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
    <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
    <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
  </div>
</div>
<aside id="sidebar" class="sidebar">
  <div class="sidebar-inner">

    <section class="site-overview sidebar-panel  sidebar-panel-active ">
      <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image"
        src="http://shanks.link/img/logo.jpg"
        alt="" />
    <p class="site-author-name" itemprop="name"></p>
    <p class="site-description motion-element" itemprop="description"> </p>
</div>
      <nav class="site-state motion-element">
    <div class="site-state-item site-state-posts">
        <a href="http://shanks.link/post/">
            <span class="site-state-item-name">日志</span>
        </a>
    </div>
    <div class="site-state-item site-state-categories">
        <a href="http://shanks.link/categories/">
            <span class="site-state-item-name">分类</span>
        </a>
    </div>

    <div class="site-state-item site-state-tags">
        <a href="http://shanks.link/tags/">
            <span class="site-state-item-name">标签</span>
        </a>
    </div>
</nav>

      
      
<div class="links-of-author motion-element">
    
        <span class="links-of-author-item">
        <a href="https://github.com/shankusu2017" target="_blank" title="GitHub">
            <i class="fa fa-fw fa-github"></i>
            GitHub
        </a>
        </span>
    
</div>


      

      <div class="links-of-blogroll motion-element inline">
<script type="text/javascript" src="//rf.revolvermaps.com/0/0/8.js?i=5b4f2ucxar6&amp;m=0&amp;s=220&amp;c=ff0000&amp;cr1=ffffff&amp;f=arial&amp;l=33&amp;bv=35" async="async"></script>
</div>

    </section>
    
  </div>
</aside>

      </div>
    </main>
   
    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  <span itemprop="copyrightYear">  &copy; 
  2009 - 2025</span>
</div>
<div>
  <a href="https://beian.miit.gov.cn/" rel="noopener" target="_blank">粤ICP备2021068940号-1</a>
  <a href="https://www.beian.gov.cn/portal/registerSystemInfo?recordcode=44011302003059" rel="noopener" target="_blank">粤公网安备44011302003059</a>
</div>


      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
      <span id="scrollpercent"><span>0</span>%</span>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>
<script type="text/javascript" src="http://shanks.link/js/vendor/jquery/index.js?v=2.1.3"></script>
<script type="text/javascript" src="http://shanks.link/js/vendor/fastclick/lib/fastclick.min.js?v=1.0.6"></script> 
<script type="text/javascript" src="http://shanks.link/js/vendor/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
<script type="text/javascript" src="http://shanks.link/js/vendor/velocity/velocity.min.js?v=1.2.1"></script>
<script type="text/javascript" src="http://shanks.link/js/vendor/velocity/velocity.ui.min.js?v=1.2.1"></script>
<script src="http://shanks.link/js/vendor/ua-parser-js/dist/ua-parser.min.js?v=0.7.9"></script>

<script src="http://shanks.link/js/vendor/fancybox/jquery.fancybox.pack.js?v=2.1.5"></script>

<script type="text/javascript" src="http://shanks.link/js/utils.js"></script>
<script type="text/javascript" src="http://shanks.link/js/motion.js"></script>
<script type="text/javascript" src="http://shanks.link/js/affix.js"></script>
<script type="text/javascript" src="http://shanks.link/js/schemes/pisces.js"></script>

<script type="text/javascript" src="http://shanks.link/js/scrollspy.js"></script>
<script type="text/javascript" src="http://shanks.link/js/post-details.js"></script>
<script type="text/javascript" src="http://shanks.link/js/toc.js"></script>

<script type="text/javascript" src="http://shanks.link/js/bootstrap.js"></script>

<script type="text/javascript" src="http://shanks.link/js/search.js"></script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX", "output/HTML-CSS"],
    tex2jax: {
      inlineMath: [ ['$','$'] ],
      displayMath: [ ['$$','$$'] ],
      processEscapes: true
    },
    "HTML-CSS": { fonts: ["TeX"] }
  });
</script>
<script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML' async></script>
</body>
</html>