<!DOCTYPE HTML>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" /> 
    <title>OpenWRT 编译百科全书 - 愿星光伴你左右</title>
    <meta name="keywords" content="git,Git,Lua,lua,Golang,go">
    
    <meta property="og:title" content="OpenWRT 编译百科全书">
    <meta property="og:site_name" content="愿星光伴你左右">
    <meta property="og:image" content="/img/author.jpg"> 
    <meta name="title" content="OpenWRT 编译百科全书 - 愿星光伴你左右" />
    <meta name="description" content="愿星光伴你左右"> 
    <link rel="shortcut icon" href="http://shanks.link/img/favicon.ico" />
    <link rel="apple-touch-icon" href="http://shanks.link/img/apple-touch-icon.png" />
    <link rel="apple-touch-icon-precomposed" href="http://shanks.link/img/apple-touch-icon.png" />
    <link href="http://shanks.link/js/vendor/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />
    <link href="http://shanks.link/js/vendor/fancybox/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />
    <link href="http://shanks.link/css/main.css" rel="stylesheet" type="text/css" />
    <link href="http://shanks.link/css/syntax.css" rel="stylesheet" type="text/css" />
    <script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post"},
     fancybox: true, 
    motion: true
  };
</script>
</head>
<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">
<div class="container one-collumn sidebar-position-left page-home  ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"> <div class="site-meta  custom-logo ">

  <div class="custom-logo-site-title">
    <a href="http://shanks.link/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">愿星光伴你左右</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle"></p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
    <ul id="menu" class="menu">
      
      
        <li class="menu-item ">
          <a href="http://shanks.link/post/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />首页
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/thinking/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />随想录
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/%E7%94%9F%E6%B4%BB/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />生活
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/os/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />OS
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/lua/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />lua
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/redis/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />redis
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/go/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />Golang
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/c/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />C
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/openvpn/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />OpenVPN
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/web/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />web
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/openwrt/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />OpenWRT
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/%E8%BF%90%E7%BB%B4/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />运维
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/git/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />Git
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/%E9%B8%9F%E5%93%A5%E7%9A%84%E7%A7%81%E6%88%BF%E8%8F%9C/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />鸟哥的私房菜
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/it/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />IT杂谈
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/about/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />About Me
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/links/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />友情链接
          </a>
        </li>
      
      <li class="menu-item menu-item-search">
        <a href="javascript:;" class="popup-trigger"> <i class="menu-item-icon fa fa-search fa-fw"></i> <br /> 搜索</a>
      </li>
    </ul>
    <div class="site-search">
      <div class="popup">
 <span class="search-icon fa fa-search"></span>
 <input type="text" id="local-search-input">
 <div id="local-search-result"></div>
 <span class="popup-btn-close">close</span>
</div>

    </div>
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
<section id="posts" class="posts-expand">
  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <header class="post-header">
      <h1 class="post-title" itemprop="name headline">
        <a class="post-title-link" href="http://shanks.link/blog/2022/10/17/openwrt-%E7%BC%96%E8%AF%91%E7%99%BE%E7%A7%91%E5%85%A8%E4%B9%A6/" itemprop="url">
        OpenWRT 编译百科全书
        </a>
      </h1>
      <div class="post-meta">
      <span class="post-time">
<span class="post-meta-item-icon">
    <i class="fa fa-calendar-o"></i>
</span>
<span class="post-meta-item-text">时间：</span>
<time itemprop="dateCreated" datetime="2016-03-22T13:04:35+08:00" content="2022-10-17">
    2022-10-17
</time>
</span> 
      

  <span class="post-category" >
  &nbsp; | &nbsp;
  <span class="post-meta-item-icon">
    <i class="fa fa-folder-o"></i>
  </span>
  <span class="post-meta-item-text">分类：</span>
  
    <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
      <a href="http://shanks.link/categories/openwrt" itemprop="url" rel="index">
        <span itemprop="name">OpenWrt</span>
      </a>
      &nbsp; 
    </span>
  
</span>


       <span>
&nbsp; | &nbsp;
<span class="post-meta-item-icon">
    <i class="fa fa-eye"></i>
</span>
<span class="post-meta-item-text">阅读：</span>
<span class="leancloud-visitors-count">9563 字 ~20分钟</span>
</span>
      </div>
    </header>
    <div class="post-body" itemprop="articleBody">
    <h2 id="配置編譯環境">配置編譯環境</h2>
<p>必須使用<strong>非root用戶</strong></p>
<h3 id="安裝依賴包">安裝依賴包</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>// Ubuntu 14.04 必選
</span></span><span style="display:flex;"><span># apt-get install asciidoc bash bc binutils bzip2 fastjar flex git-core g++ build-essential util-linux gawk libgtk2.0-dev intltool jikespg zlib1g-dev genisoimage libncurses5-dev libssl-dev patch perl-modules python2.7-dev rsync ruby sdcc unzip wget gettext xsltproc libboost1.55-dev libboost1.55-tools-dev libxml-parser-perl libusb-dev bin86 bcc bzr ecj sharutils openjdk-7-jdk zip gcc-multilib quilt
</span></span><span style="display:flex;"><span>// Ubuntu 14.04 可選
</span></span><span style="display:flex;"><span># apt-get install subversion mercurial cvs
</span></span><span style="display:flex;"><span>// ArchLinux 必選
</span></span><span style="display:flex;"><span># pacman -S base-devel
</span></span><span style="display:flex;"><span># pacman -S [--needed] asciidoc b43-fwcutter bash bc bin86 boost binutils bzip2 cdrkit fastjar flex gawk gettext git gtk2 intltool jdk7-openjdk libusb libxslt ncurses openssl patch perl python2 rsync ruby sdcc sharutils unzip util-linux wget zlib gcc make perl-extutils-makemaker findutils libstdc++5 lib32-libstdc++5
</span></span><span style="display:flex;"><span>// libstdc++  可能需要版本6,待測
</span></span><span style="display:flex;"><span>// 根據wiki，ArchLinux部分必選包在AUR裡面
</span></span><span style="display:flex;"><span>$ yaourt -S bcc jikes
</span></span><span style="display:flex;"><span>// ArchLinux 可選
</span></span><span style="display:flex;"><span># pacman -S subversion
</span></span></code></pre></div><h3 id="首次配置需要檢出源代碼這裡用subversion檢出開發trunk分支">首次配置需要檢出源代碼，這裡用subversion檢出開發trunk分支</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>$ svn co svn://svn.openwrt.org/openwrt/trunk/
</span></span></code></pre></div><p>這時，就會出現名為<code>trunk</code>的文件夾，這就是將來我們的工作目錄。 如果已經有了以前的版本庫，需要按照下面的命令更新</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>// 必須進入工作目錄才能更新
</span></span><span style="display:flex;"><span>$ cd trunk/
</span></span><span style="display:flex;"><span>$ svn update
</span></span></code></pre></div><h3 id="更新和安裝feeds需要vpn">更新和安裝feeds（需要VPN）</h3>
<p>在下載之前可以通過查看<code>feeds.conf.default</code>文件，來檢查哪些文件需要包含在環境中。更新只需要重複命令即可</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>$ cd trunk/
</span></span><span style="display:flex;"><span>$ ./scripts/feeds update -a
</span></span><span style="display:flex;"><span>$ ./scripts/feeds install -a
</span></span></code></pre></div><h3 id="配置編譯信息">配置編譯信息</h3>
<p>必須先選擇好目標（target）類型才能執行 <code>make defconfig</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>$ make defconfig
</span></span><span style="display:flex;"><span>$ make prereq
</span></span><span style="display:flex;"><span>$ make menuconfig
</span></span></code></pre></div><p>其中斜線（/）可以進行搜索。 剛開始可以考慮選擇編譯SDK用於開發，編譯ImageGenerator（a.k.a ImageBuilder）簡單打包自己需要的Package和配置文件進入固件中，也可以同時打包好工具鏈（ToolChain）方便以後使用，這樣的話時間會稍微長一些。</p>
<h2 id="開始編譯">開始編譯</h2>
<p>一般情況，進行全部編譯時使用一個簡單的命令，因為編譯過程會下載很多文件，目前許多項目的repo都遷移到GitHub上了，一般情況下不必使用VPN，但是如果網絡條件很差，可以考慮使用一個靠譜的VPN服務提供商。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>$ make V=99
</span></span></code></pre></div><p>編譯一個單獨的軟件包（例如cups軟件包）</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>$ make package/cups/compile V=99
</span></span></code></pre></div><p>如果特殊原因需要分析編譯報錯信息：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>$ make V=99 2&gt;&amp;1 |tee build.log |grep -i error
</span></span></code></pre></div><p>則將編譯的所有輸出信息保存在<code>build.log</code>中，將error信息打印在屏幕上。</p>
<p>還發現一個記錄log的好辦法，打開<code>make menuconfig</code>裡面的Advanced configuration options (for developers)，接著開啟Enable log files during build process，這樣在使用<code>make V=99</code>的時候自動會生成logs文件夾，裡面詳細記錄了各個階段的日誌文件，相比上述輸出日誌的形式，這種更加全面，實際使用過程發現好像反應稍微慢了點，不過沒有錯誤才是最好的，不是麼？</p>
<h3 id="編譯結束">編譯結束</h3>
<p>編譯結束後，所有的文件都會放在編譯根目錄下的 bin/yourtarget/ ，例如 /bin/ar71xx</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>$ ls bin/*
</span></span></code></pre></div><p>編譯之後的文件主要有以下幾類：</p>
<ol>
<li>bin/.trx 文件: 路由器固件。如果沒有另外一種也不必驚慌。關於.bin和.trx的區別，一種說法是，第一次刷路由器的時候，需要用.bin文件，如果需要再升級，則不能再使用 .bin文件，而需要用 .trx文件。原因是 .bin是將路由器的相關配置信息和 .trx封裝在一起而生成的封包，也就是說是包含路由器版本信息的 .trx 在第一次刷固件的時候，我們需要提供這樣的信息，而在後續升級時則不再需要，用 .trx文件即可。</li>
<li>packages文件夾: 裡麵包含了我們在配置文件裡設定的所有編譯好的軟件包。</li>
<li>（可選）OpenWrt-SDK.**.tar.bz2: 這個也就是我們定製編譯好的OpenWRT SDK環境。我們將用這個來進行OpenWrt軟件包的開發。我的 TP-Link WR841N v7 編譯的SDK文件名是<code>OpenWrt-SDK-ar71xx-for-linux-x86_64-gcc-4.8-linaro_uClibc-0.9.33.2.tar.bz2</code></li>
<li>（可選）OpenWrt-ImageBuilder-**.tar.bz2: 這個可以簡單打包自己需要的Package和配置文件進入固件中。我的文件名為<code>OpenWrt-ImageBuilder-ar71xx_generic-for-linux-x86_64.tar.bz2</code></li>
<li>（可選）OpenWrt-Toolchain-**.tar.bz2: 這個是交叉編譯工具鏈。我的是<code>OpenWrt-Toolchain-ar71xx-for-mips_34kc-gcc-4.8-linaro_uClibc-0.9.33.2.tar.bz2</code></li>
<li>md5sums 文件: 這個文件記錄了所有我們編譯好的文件的MD5值，來保證文件的完整性。</li>
</ol>
<p>編譯完成後，一定要將<strong>編譯好的bin目錄進行備份</strong></p>
<h2 id="清理以及再編譯">清理以及再編譯</h2>
<p>建議現在清理編譯產生的文件，以免下次編譯時造成衝突，也就是每次編譯完成之後把需要的東西複製到別處，然後立即清理（因為要生成的文件如果存在的話，可能不會被替換），執行<code>make clean</code></p>
<p>注意：在執行clean命令，確保已經將編譯好的Image進行了備份。清理工作會清除bin目錄。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>$ make clean
</span></span></code></pre></div><p>除了清除生成的目錄，還想清除交叉編譯工具（以及工具鏈目錄）</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>$ make dirclean
</span></span></code></pre></div><p>清除所有相關的東西，包括下載的軟件包，配置文件，feed內容等（不建議使用）</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>$ make distclean
</span></span></code></pre></div><p>對於更新feeds後出現的錯誤：ERROR:please fix package/feeds/packages/mc/Makefile 等類似的問題，需要執行這條語句進行系統的清理</p>
<p>對於清理組件，比如軟件包的清理</p>
<p>比如清理 linux</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>$ make target/linux/clean
</span></span></code></pre></div><p>清理 base-files 軟件包</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>$ make package/base-files/clean
</span></span></code></pre></div><p>清理 Luci</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>$ make package/luci/clean
</span></span></code></pre></div><h2 id="和官方倉庫保持同步">和官方倉庫保持同步</h2>
<p>很多時候，我們在自己的某個Repository裡面進行修改或者開發操作，所以要保證我們的代碼與官方的代碼保持同步。</p>
<p>官方倉庫的地址是 <code>git://git.openwrt.org/openwrt.git</code> 或者 <code>http://git.openwrt.org/openwrt.git</code>。其他在GitHub上的倉庫貌似都是鏡像，比如<a href="https://github.com/openwrt-es/openwrt">openwrt-es</a>以及<a href="https://github.com/openwrt-mirror/openwrt">openwrt-mirror</a>。</p>
<p>如果還沒進行過多少修改的代碼，可以直接fork給出的repo，然後可以方便的使用github本身看我們的分支和官方的代碼有多少的超前和滯後提交，可以作為一個提醒。</p>
<p>接下來，我們建立一個遠程倉庫名為<code>upstream</code>：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>$ git remote -v   // 首先列出遠程倉庫，一般只有一個origin
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ git remote add upstream http://git.openwrt.org/openwrt.git
</span></span></code></pre></div><p>這樣就建立好了，我們可以接著列出遠程倉庫看一下.如果需要變更或者刪除遠程倉庫的話，請參考git remote的manpage.</p>
<p>有的人喜歡使用<code>git pull</code>，但是官方推薦的是使用fetch然後merge，這樣有什麼區別還有衝突都一目瞭然.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>$ git fetch upstream    // 從官方拉下來最新代碼
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ git checkout master   // 切換到主分支，或者是切換到你需要merge到的分支
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ git merge upstream/master // 自動merge進上面切換到的分支中，可以自動或者手動解決衝突
</span></span></code></pre></div><p>這樣，我們就能時刻和官方保持一致了.</p>
<h2 id="openwrt-編譯-doc-文件">OpenWRT 編譯 doc 文件</h2>
<p>在 OpenWrt 的 trunk 分支中有一個文件夾名為 <code>doc</code>，在這個文件夾中包含一部分文檔可供參考，是用 LaTeX 寫的，我們需要編譯之後才能閱讀的更順暢，編譯之後默認生成 .pdf 和 .htm 文件。</p>
<p>在 Ubuntu 我們可以使用 apt-get 從網絡上直接下載包來安裝。</p>
<p>我們用到的三個比較重要的命令有 <code>apt-cache search</code> 、<code>apt-cache show</code> 和 <code>sudo apt-get install</code></p>
<p>首先使用</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>$ apt-cache search latex
</span></span></code></pre></div><p>我們可以看到許多包被列出。選擇安裝<code>texlive-latex-base</code>, 它的描述是：Tex Live: Basic LaTex packages</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>sudo apt-get install texlive-latex-base
</span></span></code></pre></div><p>這樣就安裝好Latex了，可以直接使用。 但編譯中文時，由於沒有安裝CJK中文環境，會提示找不到CJK包。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>$ apt-cache search cjk
</span></span></code></pre></div><p>選擇安裝<code>latex-cjk-all</code>, 它的描述是：Installs all LaTex CJK packages.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>sudo apt-get install latex-cjk-all
</span></span></code></pre></div><p>這樣就可以使用中文環境了。</p>
<p>有些.sty文件可能沒有安裝，例如：lastpage.sty. 這個時候不要到網絡上去詢問是因為什麼， Latex的輸出錯誤信息已經很明顯了。 使用下面的命令來查找相應的包。 <strong>注意不要加.sty文件後綴</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>$ apt-cache search lastpage
</span></span></code></pre></div><p>可以看到需要下面的包，以及對這個包的描述：texlive-latex-extra - TeX Live: LaTeX supplementary packages 選擇安裝即可：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>sudo apt-get install texlive-latex-extra
</span></span></code></pre></div><p>完成上面的這三步，就可以基本滿足平時的應用需求了。如果以後需要使用新的包，可以使用上面的方法來查找相應的安裝包，並選擇安裝即可。</p>
<h2 id="增加設備支持">增加設備支持</h2>
<h5 id="前提">前提</h5>
<p>如果是專業搞過嵌入式開發的，懂得架構以及其他必要知識的可以忽略這個前提，接下來就是我要說的了，找一款和你想要添加的設備<strong>很相近</strong>且官方已經有了支持的型號，至少要是相同的平臺，比如ar71xx.這部分基本上圍繞這個前提來展開。</p>
<h5 id="所需">所需</h5>
<p>完整 OpenWrt 開發環境. 包括編輯器, 配置好的 <code>quilt</code> 工具.</p>
<p>假設之前已經編譯過 bin, 有<strong>完整的 .config 和 toolchain</strong>.</p>
<p>目前看到的很多教程教人直接修改現有的 patch 文件或者是 tmp/ 文件夾下的文件，更甚者胡亂猜測，這樣會導致一些問題。</p>
<p>比如源碼更新的時候，許多 Patch 文件的偏移（offset）會發生變更，主要體現在 linux 內核版本升級的時候，這樣直接修改現成的 Patch 就會增添許多煩惱，其實官方有一個很好的東東，那就是這個 quilt，它是用來管理代碼樹中的 patch 的嵌入式內核開發利器!</p>
<h5 id="增加-device-specific-支持文件">增加 Device-Specific 支持文件</h5>
<p>這個部分的文件是單獨的，與其他的文件比如各種 Patch 沒有較大的關聯，在重新編譯之前只需要<code>make clean</code>就行。</p>
<p>我們以添加 TP-Link TL-WR2041N v1 版本為例子進行說明：</p>
<p>新手剛開始添加支持的時候最好在取出最新的 trunk 代碼之後立即進行，防止其他文件幹擾，如果之前做過類似的操作或者懂得目錄結構、知道文件是做什麼用的，可以忽略這個建議。</p>
<p><strong>刪除 tmp/ 目錄</strong>，這個是大坑，因為這個文件夾內的內容全是生成的，沒必要進行更改。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>$ rm -rvf tmp/
</span></span></code></pre></div><p>首先，如同前文所述，確定好相近的型號，方便添加支持。我這個型號的板子與國外的 WDR3500 相似，與國內的 TP-Link TL-WR941N v6 相同，我是通過 WDR3500 進行添加的。</p>
<p>搜索以下相關的文件，以確定需要修改什麼文件，之後照貓畫虎。</p>
<p>運行 <code>grep wdr3500 trunk/* -r -l</code> 得到的結果如下，我已經做好了分類：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>// 這部分是Device-Specific的
</span></span><span style="display:flex;"><span>trunk/target/linux/ar71xx/base-files/etc/diag.sh
</span></span><span style="display:flex;"><span>trunk/target/linux/ar71xx/base-files/etc/uci-defaults/01_leds
</span></span><span style="display:flex;"><span>trunk/target/linux/ar71xx/base-files/etc/uci-defaults/02_network
</span></span><span style="display:flex;"><span>trunk/target/linux/ar71xx/base-files/lib/upgrade/platform.sh
</span></span><span style="display:flex;"><span>trunk/target/linux/ar71xx/base-files/lib/ar71xx.sh
</span></span><span style="display:flex;"><span>trunk/target/linux/ar71xx/files/arch/mips/ath79/mach-tl-wdr3500.c
</span></span><span style="display:flex;"><span>// 這部分是製作鏡像的相關文件
</span></span><span style="display:flex;"><span>trunk/target/linux/ar71xx/image/Makefile
</span></span><span style="display:flex;"><span>trunk/target/linux/ar71xx/generic/profiles/tp-link.mk
</span></span><span style="display:flex;"><span>trunk/tools/firmware-utils/src/mktplinkfw.c
</span></span><span style="display:flex;"><span>// 這部分是內核支持相關的文件
</span></span><span style="display:flex;"><span>trunk/target/linux/ar71xx/config-3.10
</span></span><span style="display:flex;"><span>trunk/target/linux/ar71xx/patches-3.10/610-MIPS-ath79-openwrt-machines.patch
</span></span></code></pre></div><p>得到的文件就是基本的支持文件了，我們一個一個說。</p>
<h5 id="diagsh">diag.sh</h5>
<p>這個文件是 openwrt 初始化時閃爍的燈的配置，一般的路由啟動的時候只閃爍 System 燈或者電源燈，基本沒有修改的價值，仿照修改即可。</p>
<p>比如2041n v1：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>    tl-wdr3500 | <span style="color:#009c00">\
</span></span></span><span style="display:flex;"><span><span style="color:#009c00"></span>    tl-wr2041n-v1 | <span style="color:#009c00">\
</span></span></span><span style="display:flex;"><span><span style="color:#009c00"></span>    ........
</span></span><span style="display:flex;"><span>    tl-wr941nd)
</span></span><span style="display:flex;"><span>        status_led=<span style="color:#009c00">&#34;tp-link:green:system&#34;</span>
</span></span></code></pre></div><p>添加到該位置就行。</p>
<h5 id="uci-defaults01_leds">uci-defaults/01_leds</h5>
<p>這個文件是定義 led 的信息的，簡單的比如 <code>ucidef_set_led_netdev</code> 多用於定義 WAN 口，修改最後的 eth0 為你對應的設備名稱； <code>ucidef_set_led_wlan</code> 多用於定義 WLAN 口，最後的 <code>phyxtpt</code> 目前見到的只有 x=0 和1兩種情況，這個和設備初始出來的phy物理設備相關； <code>ucidef_set_led_switch</code> 用來定義交換機的配置，最後的 0x00 部分是端口掩碼，一般的順序如下。</p>
<p>至於更詳細的定義過程，需要參考 <code>packages/base-files/files/lib/functions</code> 目錄的 <code>uci-defaults.sh</code> 腳本。（目前新加的文件 <code>uci-defaults-new.sh</code> 文件，看樣子是通過 JSON 傳值的，應該是應用於新的設備或者新的架構的）</p>
<p>比如2041n v1：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>tl-wr2041n-v1)
</span></span><span style="display:flex;"><span>    ucidef_set_led_netdev <span style="color:#009c00">&#34;wan&#34;</span> <span style="color:#009c00">&#34;WAN&#34;</span> <span style="color:#009c00">&#34;tp-link:green:wan&#34;</span> <span style="color:#009c00">&#34;eth0&#34;</span>
</span></span><span style="display:flex;"><span>    ucidef_set_led_switch <span style="color:#009c00">&#34;lan1&#34;</span> <span style="color:#009c00">&#34;LAN1&#34;</span> <span style="color:#009c00">&#34;tp-link:green:lan1&#34;</span> <span style="color:#009c00">&#34;switch0&#34;</span> <span style="color:#009c00">&#34;0x02&#34;</span>
</span></span><span style="display:flex;"><span>    ucidef_set_led_switch <span style="color:#009c00">&#34;lan2&#34;</span> <span style="color:#009c00">&#34;LAN2&#34;</span> <span style="color:#009c00">&#34;tp-link:green:lan2&#34;</span> <span style="color:#009c00">&#34;switch0&#34;</span> <span style="color:#009c00">&#34;0x04&#34;</span>
</span></span><span style="display:flex;"><span>    ucidef_set_led_switch <span style="color:#009c00">&#34;lan3&#34;</span> <span style="color:#009c00">&#34;LAN3&#34;</span> <span style="color:#009c00">&#34;tp-link:green:lan3&#34;</span> <span style="color:#009c00">&#34;switch0&#34;</span> <span style="color:#009c00">&#34;0x08&#34;</span>
</span></span><span style="display:flex;"><span>    ucidef_set_led_switch <span style="color:#009c00">&#34;lan4&#34;</span> <span style="color:#009c00">&#34;LAN4&#34;</span> <span style="color:#009c00">&#34;tp-link:green:lan4&#34;</span> <span style="color:#009c00">&#34;switch0&#34;</span> <span style="color:#009c00">&#34;0x10&#34;</span>
</span></span><span style="display:flex;"><span>    ucidef_set_led_netdev <span style="color:#009c00">&#34;wlan&#34;</span> <span style="color:#009c00">&#34;WLAN&#34;</span> <span style="color:#009c00">&#34;tp-link:green:wlan&#34;</span> <span style="color:#009c00">&#34;wlan0&#34;</span>
</span></span><span style="display:flex;"><span>    ucidef_set_led_wlan <span style="color:#009c00">&#34;wlan&#34;</span> <span style="color:#009c00">&#34;WLAN&#34;</span> <span style="color:#009c00">&#34;tp-link:green:wlan&#34;</span> <span style="color:#009c00">&#34;phy1tpt&#34;</span>
</span></span><span style="display:flex;"><span>    ;;
</span></span></code></pre></div><h5 id="uci-defaults02_network">uci-defaults/02_network</h5>
<p>該文件定義初始化網絡信息，主要是交換機和 vlan，<del>不過我遇到怪異的事情是，<code>ucidef_set_interfaces_lan_wan</code> 緊跟著的第一個參數是定義 wan 的，第二個是定義 lan 的，比如下面的 eth0 是 wan 而 eth1 是 lan 。</del>（貌似是在設備 mach 文件中定義的問題，看了一下網絡初始化的腳本 <code>uci-defaults.sh</code> 中的定義，應該第一個參數是 lan ,第二個是 wan） 比如 wr2041n v1：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>tl-wr2041n-v1)
</span></span><span style="display:flex;"><span>    ucidef_set_interfaces_lan_wan <span style="color:#009c00">&#34;eth0&#34;</span> <span style="color:#009c00">&#34;eth1&#34;</span>
</span></span><span style="display:flex;"><span>    ucidef_add_switch <span style="color:#009c00">&#34;switch0&#34;</span> <span style="color:#009c00">&#34;1&#34;</span> <span style="color:#009c00">&#34;1&#34;</span>
</span></span><span style="display:flex;"><span>    ucidef_add_switch_vlan <span style="color:#009c00">&#34;switch0&#34;</span> <span style="color:#009c00">&#34;1&#34;</span> <span style="color:#009c00">&#34;0 1 2 3 4&#34;</span>
</span></span><span style="display:flex;"><span>    ;;
</span></span></code></pre></div><h5 id="libupgradeplatformsh">lib/upgrade/platform.sh</h5>
<p>該文件是定義系統更新時驗證的，基本上不用怎麼更改。</p>
<p>比如 2041n v1：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>    tl-wdr3500 | <span style="color:#009c00">\
</span></span></span><span style="display:flex;"><span><span style="color:#009c00"></span>    tl-wr2041n-v1 | <span style="color:#009c00">\
</span></span></span></code></pre></div><p>添加到了wdr3500的下方。</p>
<h5 id="libar71xxsh">lib/ar71xx.sh</h5>
<p>第一個是硬件 magic number，可以用 WinHex 打開固件文件，查看對應的偏移即可找到，model 定義的是顯示的設備名稱，下面的 <code>*&quot;TL-WR2041N v1&quot;</code> 要對應設備支持的 mach C語言設備文件中定義好的名稱；同樣的， name 定義的是內部傳遞的值，最好與上面添加的行一致。簡單來說，涉及到型號名稱的最好都保持一致。</p>
<p>比如 2041n v1：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>        <span style="color:#009c00">&#34;204100&#34;</span>*)
</span></span><span style="display:flex;"><span>        model=<span style="color:#009c00">&#34;TP-Link TL-WR2041N&#34;</span>
</span></span><span style="display:flex;"><span>        ;;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    *<span style="color:#009c00">&#34;TL-WR2041N v1&#34;</span>)
</span></span><span style="display:flex;"><span>        name=<span style="color:#009c00">&#34;tl-wr2041n-v1&#34;</span>
</span></span><span style="display:flex;"><span>        ;;
</span></span></code></pre></div><h5 id="filesarchmipsath79mach-tl-wdr3500c">files/arch/mips/ath79/mach-tl-wdr3500.c</h5>
<p>這個就是很重要的設備支持 C語言文件了，開頭的前綴 mach 最好保留，mach後的名稱需要與以後添加的linux patch支持名稱保持一致。</p>
<p>一般用於定義 led、flash 以及 PHY4 等等涉及到的端口信息，有的mach文件還涉及到 ART 的偏移量（offset），ART是存儲無線數據的分區，如果設置不當會導致路由沒有無線。</p>
<p>為了最快的添加路由支持，可以採用sed, awk工具批量改名的方法，寫出一個設備支持文件來，當然也可以使用 vim, emacs批量完成。</p>
<p>比如 2041n v1： 新建文件 target/linux/ar71xx/files/arch/mips/ath79/mach-tl-wr2041n-v1.c，詳情請<a href="https://github.com/wongsyrone/openwrt-1/blob/master/target/linux/ar71xx/files/arch/mips/ath79/mach-tl-wr2041n-v1.c">戳這裡</a></p>
<p>值得注意的是： <code>MIPS_MACHINE(ATH79_MACH_TL_WR2041N_V1, &quot;TL-WR2041N-v1&quot;, &quot;TP-LINK TL-WR2041N v1&quot;, wr2041n_setup);</code> 第一部分要與 <code>config-3.10</code> 文件中添加的內容以及後面添加的linux kernel patch中的內容一致；<code>&quot;TL-WR2041N-v1&quot;</code> 是定義的設備名稱，最好與 image 的 Makefile一致；&ldquo;TP-LINK TL-WR2041N v1&rdquo; 與前面涉及到的 <code>lib/ar71xx.sh</code> 文件相關；最後的 <code>wr2041n_setup</code> 是設備初始化的主函數名稱。</p>
<h4 id="鏡像生成的相關文件">鏡像生成的相關文件</h4>
<h5 id="trunktargetlinuxar71xximagemakefile">trunk/target/linux/ar71xx/image/Makefile</h5>
<p>該文件主要修改如下兩行，剩下的內容需要仔細學習 Makefile的寫法才能看懂。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>$(eval $(call MultiProfile,TLWR2041,TLWR2041NV1))
</span></span></code></pre></div><p>該行定義多Profile，一般是一個型號生成多個硬件版本支持的定義</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>$(eval $(call SingleProfile,TPLINK-LZMA,64kraw,TLWR2041NV1,tl-wr2041n-v1,TL-WR2041N-v1,ttyS0,115200,0x20410001,1,4Mlzma))
</span></span></code></pre></div><p>該行是單獨設備的支持信息，第一個參數是使用什麼生成辦法，2041n v1是使用 <code>TPLINK-LZMA</code> 方法，前面有對應的說明，從裡面也可以看到我們需要修改 bin/mktplinkfw 文件的源代碼，該源代碼在 <code>trunk/tools/firmware-utils/src/mktplinkfw.c</code> 中 接下來可以根據對 TPLINK-LZMA 的定義看到依次傳進去的參數，TLWR2041NV1 是 Profile 名稱，tl-wr2041n-v1 是生成的鏡像名稱，也（可能）是傳進去的設備型號，TL-WR2041N-v1 最好對應前面 mach 文件 MIPS_MACHINE 函數的信息，主要是在內核日誌和系統日誌中體現設備型號，後面的是默認 tty 信息以及 baudrate 波特率，接下來的 magic number是設備的硬件ID，1 是版本，一般不用變，4Mlzma是生成固件的layout信息，該值和硬件ID都在 mktplinkfw.c 中定義。</p>
<h5 id="trunktargetlinuxar71xxgenericprofilestp-linkmk">trunk/target/linux/ar71xx/generic/profiles/tp-link.mk</h5>
<p>該文件定義 Profile 信息，主要定義 NAME，會顯示在 <code>make menuconfig</code> 之後的設備選項裡； PACKAGES 定義默認編譯安裝的包，一般是網卡驅動以及其他必備的包，如 usb支持。</p>
<p>比如 2041n v1：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-mk" data-lang="mk"><span style="display:flex;"><span>define Profile/TLWR2041
</span></span><span style="display:flex;"><span>    NAME:=TP-LINK TL-WR2041N
</span></span><span style="display:flex;"><span>    PACKAGES:=
</span></span><span style="display:flex;"><span>endef
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>define Profile/TLWR2041/Description
</span></span><span style="display:flex;"><span>    Package set optimized for the TP-LINK TL-WR2041N.
</span></span><span style="display:flex;"><span>endef
</span></span><span style="display:flex;"><span><span style="color:#00f">$(</span>eval <span style="color:#00f">$(</span>call Profile,TLWR2041<span style="color:#00f">))</span>
</span></span></code></pre></div><h5 id="trunktoolsfirmware-utilssrcmktplinkfwc">trunk/tools/firmware-utils/src/mktplinkfw.c</h5>
<p>該文件是生成固件文件的工具，裡麵包含 TP-LINK 固件 bin 文件的結構和 md5 hash 驗證算法，比如定義硬件 magic number，flash layout， 以及其他信息。</p>
<p>比如 2041n v1：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#f00;font-style:italic">#define HWID_TL_WR2041N_V1    0x20410001   </span><span style="color:#f00;font-style:italic">//定義硬件ID
</span></span></span><span style="display:flex;"><span><span style="color:#f00;font-style:italic"></span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>        .id        = <span style="color:#009c00">&#34;TL-WR2041Nv1&#34;</span>,
</span></span><span style="display:flex;"><span>        .hw_id        = HWID_TL_WR2041N_V1,
</span></span><span style="display:flex;"><span>        .hw_rev        = 1,
</span></span><span style="display:flex;"><span>        .layout_id    = <span style="color:#009c00">&#34;4Mlzma&#34;</span>,
</span></span><span style="display:flex;"><span>},
</span></span></code></pre></div><p>定義使用的信息。</p>
<h5 id="config-310">config-3.10</h5>
<p>添加內核支持的 config 信息，與其他的保持一致就好。</p>
<p>比如 2041n v1：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>CONFIG_ATH79_MACH_TL_WR2041N_V1=y
</span></span></code></pre></div><p>CONFIG_ 後面的內容和上面 mach 硬件支持文件中定義的保持一致。</p>
<h5 id="patches-310610-mips-ath79-openwrt-machinespatch">patches-3.10/610-MIPS-ath79-openwrt-machines.patch</h5>
<p>這個是內核支持的patch文件，需要使用 quilt 創建以及以後維護，前一陣子trunk將大部分分散的補丁都移動到這個patch中了，如果要將patch提交到官方儘量放在這裡，自己用的話不要幹擾其他patch的應用就可以了。我這裡將補丁編號為920，一般來說是最後一個應用的patch了。</p>
<h4 id="管理補丁文件">管理補丁文件</h4>
<p>請通過軟件包管理器安裝 quilt，當然一般如同上文配置好編譯環境就已經安裝好了 quilt。</p>
<p>然後寫入以下配置文件到 <code>~/.quiltrc</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>cat &gt; ~/.quiltrc &lt;&lt;EOF
</span></span><span style="display:flex;"><span>QUILT_DIFF_ARGS=&#34;--no-timestamps --no-index -pab --color=auto&#34;
</span></span><span style="display:flex;"><span>QUILT_REFRESH_ARGS=&#34;--no-timestamps --no-index -pab&#34;
</span></span><span style="display:flex;"><span>QUILT_PATCH_OPTS=&#34;--unified&#34;
</span></span><span style="display:flex;"><span>QUILT_DIFF_OPTS=&#34;-p&#34;
</span></span><span style="display:flex;"><span>EDITOR=&#34;nano&#34;
</span></span><span style="display:flex;"><span>EOF
</span></span></code></pre></div><p>接著進行一下 <code>export EDITOR</code> ，當然這個 <code>EDITOR</code> 的變量不要和現有的變量衝突，可以自己任意更改，只要應用到上面的 <code>.quiltrc</code> 文件中就好了。如果怕麻煩可以寫到 <code>～/.bashrc</code> 文件中，以後就比較方便，不用每次進行 export。</p>
<p>常用的quilt命令如下，會一一說明。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>new        新建空白patch
</span></span><span style="display:flex;"><span>add        添加要修改的文件到patch中
</span></span><span style="display:flex;"><span>remove        刪除patch
</span></span><span style="display:flex;"><span>top        查看當前patch位置，相當於一個指針
</span></span><span style="display:flex;"><span>next        未知
</span></span><span style="display:flex;"><span>rename        重命名patch
</span></span><span style="display:flex;"><span>unapplied    查看未成功應用的patch
</span></span><span style="display:flex;"><span>applied        查看已經成功應用的patch
</span></span><span style="display:flex;"><span>graph        未知
</span></span><span style="display:flex;"><span>patches        未知
</span></span><span style="display:flex;"><span>upgrade        未知
</span></span><span style="display:flex;"><span>delete        刪除patch
</span></span><span style="display:flex;"><span>grep        應該類似於 grep 命令
</span></span><span style="display:flex;"><span>pop        去往上一個patch，如果附加patch名稱則按照patch序列一直應用到特定的patch位置
</span></span><span style="display:flex;"><span>series        查看patch列表，一般這個順序就是patch應用的順序，可以用來進行 pop 和 push 定位
</span></span><span style="display:flex;"><span>diff        查看區別
</span></span><span style="display:flex;"><span>previous    未知
</span></span><span style="display:flex;"><span>edit        編輯當前patch中的文件
</span></span><span style="display:flex;"><span>push        去往最新的patch，會一直應用到最後一個可以成功應用的patch
</span></span><span style="display:flex;"><span>files        查看patch中包含的修改文件
</span></span><span style="display:flex;"><span>refresh        刷新patch，相當於保存patch到 patches 文件夾，還沒有應用到buildroot處
</span></span></code></pre></div><h4 id="幾種管理操作">幾種管理操作</h4>
<h5 id="增加一個新的patch">增加一個新的Patch</h5>
<p>為一個現有的軟件包添加一個新的 Patch 需要首先準備代碼樹：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>$ make package/example/{clean,prepare} V=s QUILT=1
</span></span></code></pre></div><p>如果是 host-side 的軟件包需要進行下面的代碼樹準備操作：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>$ make package/example/host/{clean,prepare} V=s QUILT=1
</span></span></code></pre></div><p>這個步驟將解壓源碼包的 tarball 並且按照預先排好的 quilt patch 順序進行準備工作（簡單的講，按照補丁文件前面的序號給 tarball 依次打好補丁），接下來會輸出詳細的打補丁情況，如果有未成功的會有 Hunk fail 字樣；補丁應用成功的話也有兩種情況，第一，行號偏移正常，這也就是我們期望的，第二，雖然應用成功了，但是存在代碼行號偏移，出現的字樣是 offset ，並且會提示補丁具體應用到了哪行，我們可以針對打補丁時給出的提示修改補丁文件的行號，也可以通過 quilt 修改.</p>
<p>接下來切換到代碼目錄中，值得注意的是，如果在 Makefile 中存在多個編譯選項（build variants），需要切換到對應的代碼目錄中.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>$ cd build_dir/target-*/BUILD_VARIANT/example-*
</span></span></code></pre></div><p>接下來應用全部的已存在的補丁文件：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>$ quilt push -a
</span></span></code></pre></div><p>通過 <code>quilt new</code> 命令創建一個全新空白的補丁文件：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>$ quilt new 010-main_code_fix.patch
</span></span></code></pre></div><p>命名的時候需要注意的是，補丁文件的名字必須以數字開頭，一般是三位，並且補足前面的零，數字之後緊跟一個短橫線（-），接下來簡單描述這個補丁文件是做什麼用的，以便以後好查找；選定數字的時候，數字必須大於現有的最後一個 patch 的數字前綴，這個要求的原因可以通過 <code>quilt series</code> 來驗證，排序的順序就是補丁應用的順序，而排序是通過前面的數字決定的；對補丁文件的描述要言簡意賅，儘量用地道的英文術語.</p>
<p>創建好空白的補丁文件之後，必須要有修改的代碼文件與之相關聯，我們通過 <code>quilt add</code> 來進行這個操作，一旦添加好了文件，就像往常一樣進行修改就可以了. 可以通過 <code>quilt edit</code> 命令來同時完成上面的關聯文件操作以及修改操作，這個修改過程調用的文本編輯器是前面在 <code>.quiltrc</code> 文件裡面定義好的 <code>EDITOR</code> 變量，注意export.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>$ quilt edit src/main.c  // 通過quilt的edit命令編輯代碼文件
</span></span></code></pre></div><p>這樣上面的代碼文件就被加到這個新建的 patch 中了，這樣一直重複操作，直到所有需要添加到該 patch 中的文件都修改完.</p>
<p>所有的修改操作都進行完之後，可以通過 <code>quilt diff</code> 命令查看修改的內容.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>$ quilt diff          // 很類似 git diff 不是嗎
</span></span></code></pre></div><p>如果發現修改都處於預期，就可以把修改寫入到剛才新建的patch文件中了，注意<strong>這時候的patch還在 build_dir 裡面</strong>.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>$ quilt refresh
</span></span></code></pre></div><p>接下來切換到 buildroot 的頂層目錄.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>$ cd ../../../      // 這個目錄比修改 kernel 補丁時低了一層
</span></span></code></pre></div><p>接下來，我們將剛才新建的 patch 移動到 buildroot ，這樣我們就可以將這個補丁進行提交等其他操作了.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>$ make package/example/update V=s
</span></span></code></pre></div><p>這樣，我們的補丁添加工作就完成了，不放心的話可以通過下面的命令進行驗證:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>$ make package/example/{clean,compile} package/index V=s
</span></span></code></pre></div><p>如果發現問題，需要重新進行編輯，下面介紹怎麼編輯補丁文件.</p>
<h5 id="編輯一個現有的patch">編輯一個現有的patch</h5>
<p>還是需要首先準備代碼樹:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>$ make package/example/{clean,prepare} V=s QUILT=1
</span></span></code></pre></div><p>接下來切換到代碼目錄中.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>$ cd build_dir/target-*/example-*
</span></span></code></pre></div><p>列出現有的所有patch文件：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>$ quilt series
</span></span></code></pre></div><p>前往需要編輯的patch文件，當然前提是這個push到的patch需要應用成功，否則需要push到提前一個patch或者push的時候加上 <code>-f</code> 參數強制運行，然後直接<code>quilt edit</code>即可，當然這個是後話.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>$ quilt push 010-main_code_fix.patch
</span></span></code></pre></div><p>當輸入的patch文件名合法的話，<code>quilt push</code> 命令會只應用patch 系列（patch series）到給出的文件名，所以提前用 <code>quilt series</code> 命令看好文件名再操作，然後用 <code>quilt top</code> 命令看自己當前處於哪個patch中確保萬無一失，如果不幸超過了所要去的補丁位置，可以通過 <code>quilt pop</code> 命令移除已經應用的補丁按照列表反向前進.</p>
<p>接下來通過 <code>quilt edit</code> 命令編輯每個需要編輯的文件.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>$ quilt edit src/main.c    // 熟悉的命令
</span></span></code></pre></div><p>接下來檢查編輯的文件是否被包含在patch中了：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>$ quilt files
</span></span></code></pre></div><p>檢查更改信息：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>$ quilt diff
</span></span></code></pre></div><p>如果發現修改都處於預期，就可以把修改寫入patch文件中了，注意<strong>這時候的patch還在 build_dir 裡面</strong>.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>$ quilt refresh
</span></span></code></pre></div><p>切換到buildroot的頂層目錄中.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>$ cd ../../../
</span></span></code></pre></div><p>接下來，我們將剛才更新好的patch移動到buildroot中:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>$ make package/example/update V=s
</span></span></code></pre></div><p>這樣，我們的補丁修改工作就完成了，不放心的話可以通過下面的命令進行驗證:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>$ make package/example/{clean,compile} package/index V=s
</span></span></code></pre></div><h5 id="新增或修改內核補丁">新增或修改內核補丁</h5>
<p>新增和修改內核補丁和操作安裝包的補丁差不太多，只有 make 的 target 和操作代碼目錄是不同的.</p>
<p>特別需要注意的是，對於內核補丁，存在一個附加的子目錄，一個是 generic/ 目錄，這個裡麵包含對所有目標架構的補丁文件；另一個是 platform/ 目錄，這裡麵包含特定架構的補丁文件，一般是在 <code>make menuconfig</code> 中配置好的架構，也可以在 <code>.config</code> 文件中找到.</p>
<p>準備內核代碼樹:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>$ make target/linux/{clean,prepare} V=s QUILT=1
</span></span></code></pre></div><p>對穩定版AA（Attitude Adjustment）來說，內核代碼樹在這裡:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>$ cd build_dir/linux-*/linux-3.*
</span></span></code></pre></div><p>對主幹分支，現在是BB（Barrier Breaker），代碼樹在這裡：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>$ cd build_dir/target-*/linux-*/linux-3.*
</span></span></code></pre></div><p>我們將剛才操作好的patch移動到buildroot中通過下面的命令：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>$ make target/linux/update package/index V=s
</span></span></code></pre></div><p>注意：Patch文件的前綴必須正確，指明是 generic 還是 platform，如果前綴不正確，可能應用操作會出問題.</p>
<p>不放心的話可以通過下面的命令進行驗證，首先去頂層目錄，一般是 target/ 所在的目錄：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>$ cd ../../../../
</span></span></code></pre></div><p>然後再次準備代碼樹，查看更改是否已經應用了：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>$ make target/linux/{clean,prepare} V=s QUILT=1
</span></span></code></pre></div><p>最後要說的是，放置patch的位置很重要，它決定補丁的應用情況.</p>
<h5 id="增加或編輯工具鏈-patch這部分一般不會涉及">增加或編輯工具鏈 Patch（這部分一般不會涉及）</h5>
<p>以 gcc 為例:</p>
<p>編譯過toolchain或者是看toolchain目錄的主Makefile可以發現gcc有三個編譯階段：initial, minimal和final，如果要修改gcc的patch，需要使用minimal那個階段。</p>
<p>準備工具鏈代碼樹:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>$ make toolchain/gcc/minimal/{clean,prepare} V=99 QUILT=1
</span></span></code></pre></div><p>代碼樹路徑取決於選擇的庫以及 gcc :</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>$ cd build_dir/toolchain-mips_r2_gcc-4.3.3+cs_uClibc-0.9.30.1/gcc-linaro-&lt;version&gt;
</span></span></code></pre></div><p>通過如下命令更新Patch:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>$ make toolchain/gcc/minimal/update V=99
</span></span></code></pre></div><p>對於其餘的binutils, gdb, glibc之類的由於沒有細分階段，所以直接按照軟件包那樣的格式套用就行了。</p>
<p>比如 <code>make toolchain/(gdb|glibc|binutils)/{clean,prepare} V=99 QUILT=1</code>, <code>make toolchain/(gdb|glibc|binutils)/update V=99</code></p>
<h5 id="刷新patch">刷新Patch</h5>
<p>當軟件包更新或者內核更新時，現有的patch文件可能不會完全應用或者存在其他提示。想要重新構建Patch列表中的全部patch可以使用make目標：refresh.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>$ make package/example/refresh V=s    // 軟件包
</span></span><span style="display:flex;"><span>$ make target/linux/refresh V=s       // 內核
</span></span></code></pre></div><h5 id="不清理代碼樹重複修改補丁">不清理代碼樹重複修改補丁</h5>
<p>當需要引入新功能做更改時，經常需要多次修改補丁。為了加速，可以在編輯操作（edit）之間保留做完準備操作的代碼樹.</p>
<ol>
<li>剛開始如上文所述準備好代碼樹;</li>
<li>切換到準備好的代碼目錄;</li>
<li>前往需要修改的patch位置;</li>
<li>修改文件並保存對patch文件的更改;</li>
<li>通過 <code>quilt push -a</code> 命令完全應用剩下的補丁文件;</li>
<li>切換到頂層目錄運行 <code>make package/example/{compile,install}</code> ，如果是內核的補丁，使用 <code>make target/linux/{compile,install}</code> 命令;</li>
<li>測試二進制文件。如果再次需要進行更改，從第二步重複操作；</li>
<li>最後使用 <code>make package/example/update</code> 命令 ，如果是內核補丁，使用 <code>make target/linux/update</code> 命令將patch文件應用到buildroot中。</li>
</ol>
<h5 id="準備-linux-內核-patch">準備 linux 內核 patch</h5>
<p>到這裡基本就完成了 OpenWrt 的設備支持代碼. 為了支持我們的設備, Linux 代碼樹的部分文件也需要做改動, OpenWrt 採用了 patch 的方式實現.</p>
<p>回退到源代碼的根目錄 <code>~/trunk</code> .</p>
<p>清理並準備 patch 樹:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>$ make target/linux/{clean,prepare} V=s QUILT=1
</span></span></code></pre></div><p>進入內核代碼目錄:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>$ cd build_dir/target-*/linux-ar71xx_generic/linux-3.x/
</span></span></code></pre></div><p>這裡就是內核代碼樹了, 裡面的代碼是已經打過所有 patch 的, 可以用 <code>quilt push</code> 檢查看是不是這樣:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>$ quilt push
</span></span></code></pre></div><blockquote>
<p>File series fully applied, ends at patch platform/xxx-xxxxxxxxxxxxxx.patch.</p>
</blockquote>
<p>這條輸出也告訴我們, 當前最頂的 patch 是 platform/xxx</p>
<p>為我的 WL-WR2041N v1 新建個 patch:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>$ quilt new platform/920-MIPS-ath79-add-TL-WR2041N-v1-support.patch
</span></span></code></pre></div><p>選擇的數字需要大於剛才的那個 xxx , 然後 quilt 會自動把這個 patch 設置為當前 patch, 所有的改動都針對這個 patch.</p>
<p>注意修改文件之前一定要看自己位於哪個patch下，否則修改都會更新到那個patch.</p>
<p>然後就是增加代碼了</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>$ quilt edit arch/mips/ath79/Kconfig
</span></span><span style="display:flex;"><span>$ quilt edit arch/mips/ath79/Makefile
</span></span><span style="display:flex;"><span>$ quilt edit arch/mips/ath79/machtypes.h
</span></span></code></pre></div><p>至於怎麼改, 參考這些文件裡其他硬件的配置</p>
<p>比如 2041n v1:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-patch" data-lang="patch"><span style="display:flex;"><span>--- a/arch/mips/ath79/Kconfig
</span></span><span style="display:flex;"><span>+++ b/arch/mips/ath79/Kconfig
</span></span><span style="display:flex;"><span>@@ -900,6 +900,16 @@ config ATH79_MACH_TL_WR1043ND_V2
</span></span><span style="display:flex;"><span>     select ATH79_DEV_USB
</span></span><span style="display:flex;"><span>     select ATH79_DEV_WMAC
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>+config ATH79_MACH_TL_WR2041N_V1
</span></span><span style="display:flex;"><span>+    bool &#34;TP-LINK TL-WR2041N v1 board support&#34;
</span></span><span style="display:flex;"><span>+    select SOC_AR934X
</span></span><span style="display:flex;"><span>+    select ATH79_DEV_AP9X_PCI if PCI
</span></span><span style="display:flex;"><span>+    select ATH79_DEV_ETH
</span></span><span style="display:flex;"><span>+    select ATH79_DEV_GPIO_BUTTONS
</span></span><span style="display:flex;"><span>+    select ATH79_DEV_LEDS_GPIO
</span></span><span style="display:flex;"><span>+    select ATH79_DEV_M25P80
</span></span><span style="display:flex;"><span>+     select ATH79_DEV_WMAC
</span></span><span style="display:flex;"><span>+
</span></span><span style="display:flex;"><span> config ATH79_MACH_TL_WR2543N
</span></span><span style="display:flex;"><span>     bool &#34;TP-LINK TL-WR2543N/ND support&#34;
</span></span><span style="display:flex;"><span>     select SOC_AR724X
</span></span><span style="display:flex;"><span>--- a/arch/mips/ath79/Makefile
</span></span><span style="display:flex;"><span>+++ b/arch/mips/ath79/Makefile
</span></span><span style="display:flex;"><span>@@ -116,6 +116,7 @@ obj-$(CONFIG_ATH79_MACH_TL_WR841N_V9)    +=
</span></span><span style="display:flex;"><span> obj-$(CONFIG_ATH79_MACH_TL_WR941ND)    += mach-tl-wr941nd.o
</span></span><span style="display:flex;"><span> obj-$(CONFIG_ATH79_MACH_TL_WR1041N_V2)    += mach-tl-wr1041n-v2.o
</span></span><span style="display:flex;"><span> obj-$(CONFIG_ATH79_MACH_TL_WR1043ND)    += mach-tl-wr1043nd.o
</span></span><span style="display:flex;"><span>+obj-$(CONFIG_ATH79_MACH_TL_WR2041N_V1)    += mach-tl-wr2041n-v1.o
</span></span><span style="display:flex;"><span> obj-$(CONFIG_ATH79_MACH_TL_WR1043ND_V2)    += mach-tl-wr1043nd-v2.o
</span></span><span style="display:flex;"><span> obj-$(CONFIG_ATH79_MACH_TL_WR2543N)    += mach-tl-wr2543n.o
</span></span><span style="display:flex;"><span> obj-$(CONFIG_ATH79_MACH_TL_WR703N)    += mach-tl-wr703n.o
</span></span><span style="display:flex;"><span>--- a/arch/mips/ath79/machtypes.h
</span></span><span style="display:flex;"><span>+++ b/arch/mips/ath79/machtypes.h
</span></span><span style="display:flex;"><span>@@ -134,6 +134,7 @@ enum ath79_mach_type {
</span></span><span style="display:flex;"><span>     ATH79_MACH_TL_WR1041N_V2,    /* TP-LINK TL-WR1041N v2 */
</span></span><span style="display:flex;"><span>     ATH79_MACH_TL_WR1043ND,        /* TP-LINK TL-WR1043ND */
</span></span><span style="display:flex;"><span>     ATH79_MACH_TL_WR1043ND_V2,    /* TP-LINK TL-WR1043ND v2 */
</span></span><span style="display:flex;"><span>+    ATH79_MACH_TL_WR2041N_V1,       /* TP-LINK TL-WR2041N v1 */
</span></span><span style="display:flex;"><span>     ATH79_MACH_TL_WR2543N,        /* TP-LINK TL-WR2543N/ND */
</span></span><span style="display:flex;"><span>     ATH79_MACH_TL_WR703N,        /* TP-LINK TL-WR703N */
</span></span><span style="display:flex;"><span>     ATH79_MACH_TL_WR710N,        /* TP-LINK TL-WR710N */
</span></span></code></pre></div><p>僅作為參考。</p>
<p>然後驗證下修改的內容:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>$ quilt diff # 查看 diff
</span></span><span style="display:flex;"><span>$ quilt refresh # 保存所有 diff 到 patch 文件
</span></span></code></pre></div><p>這個時候我們的 patch 文件還在 build_dir 裡, 大概位置是 <code>patches/platform/</code> 下. 需要同步到 OpenWrt 代碼樹.</p>
<p>退回到頂層工作目錄, 執行:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>$ make target/linux/update V=s
</span></span></code></pre></div><p>同步完成後, patch 文件會出現在 <code>target/linux/ar71xx/patches-3.x/</code> 下.</p>
<p>以後代碼更新後需要編輯 patch 時，遵從上面的 quilt 對 patch 的管理操作。</p>
<h5 id="開始編譯-1">開始編譯</h5>
<p>再次記得, <strong>刪除 tmp 目錄</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>$ rm -rvf tmp/
</span></span><span style="display:flex;"><span>$ make menuconfig
</span></span></code></pre></div><h4 id="幾個問題解決的案例">幾個問題解決的案例</h4>
<h2 id="过往经验">过往经验</h2>
<ul>
<li><a href="http://grail.cba.csuohio.edu/~somos/xxd-1.10.tar.gz">http://grail.cba.csuohio.edu/~somos/xxd-1.10.tar.gz</a> 包下载可能失败，将 http改为https试试</li>
<li>报错 tplink_archer-c9-v1 和 tplink_archer-c5-v2 两个型号空间不够，若无需此型号的image 则可在 openwrt/target/linux/bcm53xx/image/Makefile文件中关于这两个型号的行用#注释掉</li>
</ul>
<h2 id="參考鏈接">參考鏈接</h2>
<blockquote>
<p><a href="http://wiki.openwrt.org/doc/devel/add.new.device">http://wiki.openwrt.org/doc/devel/add.new.device</a></p>
<p><a href="http://wiki.openwrt.org/doc/devel/hw.hacking.first.steps">http://wiki.openwrt.org/doc/devel/hw.hacking.first.steps</a></p>
<p><a href="http://wiki.openwrt.org/doc/devel/patches">http://wiki.openwrt.org/doc/devel/patches</a></p>
<p><a href="http://andelf.diandian.com/post/2013-05-22/40050677370">http://andelf.diandian.com/post/2013-05-22/40050677370</a></p>
<p><a href="http://tilt.lib.tsinghua.edu.cn/node/841">http://tilt.lib.tsinghua.edu.cn/node/841</a></p>
<p><a href="http://www.openwrt.org.cn/bbs/forum.php?mod=viewthread&amp;tid=211">http://www.openwrt.org.cn/bbs/forum.php?mod=viewthread&amp;tid=211</a></p>
<p><a href="http://www.tuicool.com/kans/481707042">http://www.tuicool.com/kans/481707042</a></p>
<p><a href="http://www.openwrt.org.cn/bbs/forum.php?mod=viewthread&amp;tid=60&amp;extra=page%3D1">http://www.openwrt.org.cn/bbs/forum.php?mod=viewthread&amp;tid=60&amp;extra=page%3D1</a></p>
</blockquote>
<p><a href="https://jasonblog.github.io/note/python/index.html">
</a></p>
<p><a href="https://jasonblog.github.io/note/openwrt/281.html">以上内容转载自互联网，若有侵权请联系站长</a></p>

    </div>
    <footer class="post-footer">
     
 
<div class="post-tags">     
     
    <a href="http://shanks.link/tags/openwrt" rel="tag" title="OpenWrt">#OpenWrt#</a>
    
</div>



     <div class="post-nav">
    <div class="post-nav-next post-nav-item">
    
        <a href="http://shanks.link/blog/2022/10/18/printf%E5%87%BD%E6%95%B0%E8%BE%93%E5%87%BA%E6%8C%87%E5%AE%9A%E9%95%BF%E5%BA%A6/" rel="next" title="printf函数输出指定长度">
        <i class="fa fa-chevron-left"></i> printf函数输出指定长度
        </a>
    
    </div>

    <div class="post-nav-prev post-nav-item">
    
        <a href="http://shanks.link/blog/2022/10/17/%E8%87%AA%E5%AE%9A%E4%B9%89printf%E5%87%BD%E6%95%B0/" rel="prev" title="自定义printf函数">
        自定义printf函数 <i class="fa fa-chevron-right"></i>
        </a>
    
    </div>
</div>
      
     
     
     





<script src="https://utteranc.es/client.js"
        repo="shankusu2017@gmail.com/"
        issue-term="pathname"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>
<noscript>Please enable JavaScript to view the <a href="https://github.com/utterance">comments powered by utterances.</a></noscript>

    </footer>
  </article>
</section>

          </div>
        </div>
        <div class="sidebar-toggle">
  <div class="sidebar-toggle-line-wrap">
    <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
    <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
    <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
  </div>
</div>
<aside id="sidebar" class="sidebar">
  <div class="sidebar-inner">

    <section class="site-overview sidebar-panel  sidebar-panel-active ">
      <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image"
        src="http://shanks.link/img/logo.jpg"
        alt="shankusu2017@gmail.com" />
    <p class="site-author-name" itemprop="name">shankusu2017@gmail.com</p>
    <p class="site-description motion-element" itemprop="description"> </p>
</div>
      <nav class="site-state motion-element">
    <div class="site-state-item site-state-posts">
      <a href="http://shanks.link/post/">
        <span class="site-state-item-count">500</span>
        <span class="site-state-item-name">日志</span>
      </a>
    </div>
    <div class="site-state-item site-state-categories">    
        <a href="http://shanks.link/categories/">      
         
        <span class="site-state-item-count">34</span>
        
        <span class="site-state-item-name">分类</span>
        
        </a>
    </div>

    <div class="site-state-item site-state-tags">
        <a href="http://shanks.link/tags/">
         
        <span class="site-state-item-count">39</span>
        
        <span class="site-state-item-name">标签</span>
        </a>
    </div>
</nav>
      
      
<div class="links-of-author motion-element">
    
        <span class="links-of-author-item">
        <a href="https://github.com/shankusu2017" target="_blank" title="GitHub">
            <i class="fa fa-fw fa-github"></i>
            GitHub
        </a>
        </span>
    
</div>


      

      <div class="links-of-blogroll motion-element inline">
<script type="text/javascript" src="//rf.revolvermaps.com/0/0/8.js?i=5b4f2ucxar6&amp;m=0&amp;s=220&amp;c=ff0000&amp;cr1=ffffff&amp;f=arial&amp;l=33&amp;bv=35" async="async"></script>
</div>

    </section>
    
  </div>
</aside>

      </div>
    </main>
   
    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  <span itemprop="copyrightYear">  &copy; 
  2009 - 2022</span>
  <span class="with-love"><i class="fa fa-heart"></i></span>
  <span class="author" itemprop="copyrightHolder">愿星光伴你左右</span>
</div>
<div class="powered-by">
  Powered by - <a class="theme-link" href="http://gohugo.io" target="_blank" title="hugo" >Hugo v0.101.0</a>
</div>
<div class="theme-info">
  Theme by - <a class="theme-link" href="https://github.com/xtfly/hugo-theme-next" target="_blank"> NexT
  </a>
</div>


      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
      <span id="scrollpercent"><span>0</span>%</span>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>
<script type="text/javascript" src="http://shanks.link/js/vendor/jquery/index.js?v=2.1.3"></script>
<script type="text/javascript" src="http://shanks.link/js/vendor/fastclick/lib/fastclick.min.js?v=1.0.6"></script> 
<script type="text/javascript" src="http://shanks.link/js/vendor/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
<script type="text/javascript" src="http://shanks.link/js/vendor/velocity/velocity.min.js?v=1.2.1"></script>
<script type="text/javascript" src="http://shanks.link/js/vendor/velocity/velocity.ui.min.js?v=1.2.1"></script>
<script src="http://shanks.link/js/vendor/ua-parser-js/dist/ua-parser.min.js?v=0.7.9"></script>

<script src="http://shanks.link/js/vendor/fancybox/jquery.fancybox.pack.js?v=2.1.5"></script>

<script type="text/javascript" src="http://shanks.link/js/utils.js"></script>
<script type="text/javascript" src="http://shanks.link/js/motion.js"></script>
<script type="text/javascript" src="http://shanks.link/js/affix.js"></script>
<script type="text/javascript" src="http://shanks.link/js/schemes/pisces.js"></script>

<script type="text/javascript" src="http://shanks.link/js/scrollspy.js"></script>
<script type="text/javascript" src="http://shanks.link/js/post-details.js"></script>
<script type="text/javascript" src="http://shanks.link/js/toc.js"></script>

<script type="text/javascript" src="http://shanks.link/js/bootstrap.js"></script>

<script type="text/javascript" src="http://shanks.link/js/search.js"></script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX", "output/HTML-CSS"],
    tex2jax: {
      inlineMath: [ ['$','$'] ],
      displayMath: [ ['$$','$$'] ],
      processEscapes: true
    },
    "HTML-CSS": { fonts: ["TeX"] }
  });
</script>
<script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML' async></script>
</body>
</html>