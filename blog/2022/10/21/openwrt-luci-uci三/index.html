<!DOCTYPE HTML>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" /> 
    <title>Openwrt LuCI UCI（三） - Golang入门指南</title>
    <meta name="keywords" content="Golang,golang,go,git,Git,Lua,lua">
    
    <meta property="og:title" content="Openwrt LuCI UCI（三）">
    <meta property="og:site_name" content="Golang入门指南">
    <meta property="og:image" content="/img/author.jpg"> 
    <meta name="title" content="Openwrt LuCI UCI（三） - Golang入门指南" />
    <meta name="description" content="愿星光伴你左右"> 
    <link rel="shortcut icon" href="http://shanks.link/img/favicon.ico" />
    <link rel="apple-touch-icon" href="http://shanks.link/img/apple-touch-icon.png" />
    <link rel="apple-touch-icon-precomposed" href="http://shanks.link/img/apple-touch-icon.png" />
    <link href="http://shanks.link/js/vendor/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />
    <link href="http://shanks.link/js/vendor/fancybox/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />
    <link href="http://shanks.link/css/main.css" rel="stylesheet" type="text/css" />
    <link href="http://shanks.link/css/syntax.css" rel="stylesheet" type="text/css" />
    <script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post"},
     fancybox: true, 
    motion: true
  };
</script>
</head>
<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">
<div class="container one-collumn sidebar-position-left page-home  ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"> <div class="site-meta  custom-logo ">

  <div class="custom-logo-site-title">
    <a href="http://shanks.link/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">Golang入门指南</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle"></p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
    <ul id="menu" class="menu">
      
      
        <li class="menu-item ">
          <a href="http://shanks.link/post/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />首页
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/todo/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />todo
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/thinking/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />思考
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/life/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />life
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/food/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />food
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/os/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />OS
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/lua/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />lua
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/redis/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />redis
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/go/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />Golang
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/c/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />C
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/tcpip/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />TCP/IP
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/ebpf/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />ebpf
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/p4/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />p4
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/openvpn/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />OpenVPN
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/ipsec/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />IPSec
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/l2tp/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />L2TP
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/dns/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />DNS
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/distributed/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />distributed
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/web/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />web
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/openwrt/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />OpenWRT
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/%E8%BF%90%E7%BB%B4/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />运维
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/git/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />Git
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/%E9%B8%9F%E5%93%A5%E7%9A%84%E7%A7%81%E6%88%BF%E8%8F%9C/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />鸟哥的私房菜
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/it/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />IT杂谈
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/finance/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />投资
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/about/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />About Me
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/links/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />友情链接
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/ftp/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />FTP
          </a>
        </li>
      
      <li class="menu-item menu-item-search">
        <a href="javascript:;" class="popup-trigger"> <i class="menu-item-icon fa fa-search fa-fw"></i> <br /> 搜索</a>
      </li>
    </ul>
    <div class="site-search">
      <div class="popup">
 <span class="search-icon fa fa-search"></span>
 <input type="text" id="local-search-input">
 <div id="local-search-result"></div>
 <span class="popup-btn-close">close</span>
</div>

    </div>
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
<section id="posts" class="posts-expand">
  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <header class="post-header">
      <h1 class="post-title" itemprop="name headline">
        <a class="post-title-link" href="http://shanks.link/blog/2022/10/21/openwrt-luci-uci%E4%B8%89/" itemprop="url">
        Openwrt LuCI UCI（三）
        </a>
      </h1>
      <div class="post-meta">
      <span class="post-time">
<span class="post-meta-item-icon">
    <i class="fa fa-calendar-o"></i>
</span>
<span class="post-meta-item-text">时间：</span>
<time itemprop="dateCreated" datetime="2016-03-22T13:04:35+08:00" content="2022-10-21">
    2022-10-21
</time>
</span> 
      

  <span class="post-category" >
  &nbsp; | &nbsp;
  <span class="post-meta-item-icon">
    <i class="fa fa-folder-o"></i>
  </span>
  <span class="post-meta-item-text">分类：</span>
  
    <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
      <a href="http://shanks.link/categories/openwrt" itemprop="url" rel="index">
        <span itemprop="name">OpenWrt</span>
      </a>
      &nbsp; 
    </span>
  
</span>


       <span>
&nbsp; | &nbsp;
<span class="post-meta-item-icon">
    <i class="fa fa-eye"></i>
</span>
<span class="post-meta-item-text">阅读：</span>
<span class="leancloud-visitors-count">4277 字 ~9分钟</span>
</span>
      </div>
    </header>
    <div class="post-body" itemprop="articleBody">
    <h3 id="uci简介">UCI简介</h3>
<ul>
<li>UCI是Unified Configuration Interface的缩写，翻译成中文就是统一配置接口，用途就是为OpenWrt提供一个集中控制的接口。</li>
<li>配置接口启动流程：</li>
</ul>
<blockquote>
<ul>
<li>① 启动脚本 /etc/init.d/xxx；</li>
<li>② 启动脚本通过UCI分析库从 /etc/config/xxx 获得启动参数；</li>
<li>③ 启动脚本完成正常启动。</li>
</ul></blockquote>
<p><img src="http://shanks.link/img/openwrt/20200111121815937.png" alt="在这里插入图片描述"></p>
<h4 id="uci的文件">UCI的文件</h4>
<ul>
<li>UCI的配置文件全部存储在 <code>/etc/config</code> 目录下
<img src="http://shanks.link/img/openwrt/20200109101745461.png" alt="在这里插入图片描述"></li>
<li>常见UCI配置文件</li>
</ul>
<table>
  <thead>
      <tr>
          <th>文件</th>
          <th>作用</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>dhcp</td>
          <td>面向LAN口提供的IP地址分配服务配置</td>
      </tr>
      <tr>
          <td>dropbear</td>
          <td>SSH服务配置</td>
      </tr>
      <tr>
          <td>firewall</td>
          <td>路由转发，端口转发，防火墙规则</td>
      </tr>
      <tr>
          <td>network</td>
          <td>自身网络接口配置</td>
      </tr>
      <tr>
          <td>system</td>
          <td>时间服务器时区配置</td>
      </tr>
      <tr>
          <td>wireless</td>
          <td>无线网络配置</td>
      </tr>
      <tr>
          <td>uhttpd</td>
          <td>Web服务器选项配置</td>
      </tr>
      <tr>
          <td>luci</td>
          <td>基本的LuCI配置</td>
      </tr>
  </tbody>
</table>
<ul>
<li>每个文件都涉及到系统配置的一部分。可以用<strong>VI编辑器</strong>或用<strong>UCI命令行</strong>修改配置文件。也可以通过各种<strong>编程API</strong>(如shell、lua、C)来修改，这也是Web接口例如LuCI修改UCI文件的方式。</li>
<li><code>注：在通过上述方法改变一个UCI配置文件后，受影响的服务或可执行程序必须由init.d进行重启，这样更新UCI配置才生效。</code></li>
</ul>
<h4 id="uci文件语法">UCI文件语法</h4>
<ul>
<li>语法：</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-handlebars" data-lang="handlebars"><span style="display:flex;"><span>config 	&#39;section_type&#39;		&#39;section&#39;
</span></span><span style="display:flex;"><span>		option		&#39;key&#39;			&#39;value&#39;
</span></span><span style="display:flex;"><span>		list		&#39;list_key&#39;		&#39;list_value&#39;
</span></span><span style="display:flex;"><span>123
</span></span></code></pre></div><blockquote>
<p>config节点：以关键字 config 开始的一行用来代表当前节点</p>
<ul>
<li>section_type: 节点类型 &mdash;&mdash;&mdash;&mdash;-对应section中的title 参数</li>
<li>section: 节点名称 &mdash;&mdash;&mdash;&mdash;&mdash;在UCI中自定义，可以在cbi中用anonymous=true 隐匿</li>
</ul>
<blockquote>
<ul>
<li>UCI允许只有节点类型的匿名节点存在</li>
<li>节点名字建议使用单引号包含</li>
<li>节点可以包含多个option或list</li>
<li>节点遇到文件结束或遇到下一个节点代表完成</li>
</ul></blockquote>
<p>option选项：表示节点中的一个元素</p>
<ul>
<li>key：键 //对应option中的name 参数</li>
<li>value：值</li>
</ul>
<blockquote>
<ul>
<li>选项value建议使用单引号包含</li>
<li>相同的选项key存在于同一个节点，只有一个生效</li>
</ul></blockquote>
<p>list 列表项：表示列表形式的一组参数</p>
<ul>
<li>list_key: 列表键</li>
<li>list_value：列表值</li>
</ul>
<blockquote>
<ul>
<li>列表key的名字如果相同，则相同键的值将会被当作数组传递给相应软件</li>
</ul></blockquote></blockquote>
<ul>
<li>示例：参考上一节 <a href="https://blog.csdn.net/qq_28812525/article/details/103881723">Openwrt：LuCI之CBI（二）</a></li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-handlebars" data-lang="handlebars"><span style="display:flex;"><span>config typedsection1_title &#39;typedsection1&#39;
</span></span><span style="display:flex;"><span>        option Value_option_name &#39;Value&#39;
</span></span><span style="display:flex;"><span>        option TextValue_option_name &#39;TextValue&#39;
</span></span><span style="display:flex;"><span>        option DummyValue_option_name &#39;DummyValue&#39;
</span></span><span style="display:flex;"><span>        option Listvalue_option_name &#39;1&#39;
</span></span><span style="display:flex;"><span>        list DynamicList_option_name &#39;DynamicList&#39;
</span></span><span style="display:flex;"><span>        list DynamicList_option_name &#39;123123&#39;
</span></span><span style="display:flex;"><span>        option Flag_option_name &#39;1&#39;
</span></span><span style="display:flex;"><span>        option MultiValue_option_name &#39;0 1 2 3&#39;
</span></span><span style="display:flex;"><span>        list StaticList_option_name &#39;0&#39;
</span></span><span style="display:flex;"><span>        list StaticList_option_name &#39;1&#39;
</span></span><span style="display:flex;"><span>        list StaticList_option_name &#39;2&#39;
</span></span><span style="display:flex;"><span>        list StaticList_option_name &#39;3&#39;
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>config typedsection2_title &#39;typedsection2&#39;
</span></span><span style="display:flex;"><span>		option tab1_option1 &#39;1&#39;
</span></span><span style="display:flex;"><span>		option tab2_option2	&#39;2&#39;
</span></span></code></pre></div><h3 id="二uci配置修改">二、UCI配置修改</h3>
<h4 id="uci命令">UCI命令</h4>
<h5 id="uci命令语法格式">UCI命令语法格式</h5>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-handlebars" data-lang="handlebars"><span style="display:flex;"><span>uci  [&lt;option&gt;]	 &lt;command&gt;  [&lt;arguments&gt;]
</span></span></code></pre></div><blockquote>
<p>规则</p>
<ul>
<li>UCI读取总是先读取内存中的缓存，然后再读取文件中的。</li>
<li>进行过增加、修改、删除操作后要执行生效指令 <code>commit</code>，否则所做修改只留存在缓存中。</li>
<li>当使用UCI命令工具写入配置文件，配置文件都是整个重写并且不需要确认命令。这意味着在文件中任何多余的注释行和空行均会被删除。</li>
</ul></blockquote>
<ul>
<li>option:</li>
</ul>
<table>
  <thead>
      <tr>
          <th>选项</th>
          <th>含义</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>-c <path></td>
          <td>设置配置文件的搜索路径（默认值：/etc/config）</td>
      </tr>
      <tr>
          <td>-d <str></td>
          <td>在 uci 显示中为列表值设置分隔符</td>
      </tr>
      <tr>
          <td>-f <file></td>
          <td>使用<file>作为输入来替代标准 stdin</td>
      </tr>
      <tr>
          <td>-m</td>
          <td>导入时，将数据合并到现有包中</td>
      </tr>
      <tr>
          <td>-n</td>
          <td>导出时，命名未命名的节（默认）</td>
      </tr>
      <tr>
          <td>-N</td>
          <td>不命名未命名的节</td>
      </tr>
      <tr>
          <td>-p <path></td>
          <td>为配置更改文件添加一个搜索路径</td>
      </tr>
      <tr>
          <td>-P <path></td>
          <td>为配置更改文件添加一个搜索路径，并将其用作默认</td>
      </tr>
      <tr>
          <td>-q</td>
          <td>静音模式（不打印错误消息）</td>
      </tr>
      <tr>
          <td>-s</td>
          <td>强制strict 模式（停止解析器错误，默认）</td>
      </tr>
      <tr>
          <td>-S</td>
          <td>禁用strict 模式</td>
      </tr>
      <tr>
          <td>-x</td>
          <td>不在&quot;显示&quot;中使用扩展语法</td>
      </tr>
  </tbody>
</table>
<ul>
<li>command:</li>
</ul>
<table>
  <thead>
      <tr>
          <th>命令</th>
          <th>含义</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>add</td>
          <td>增加指定配置文件的类型为section-type 的匿名区段。</td>
      </tr>
      <tr>
          <td>add_list</td>
          <td>对已存在的list选项增加字符串。</td>
      </tr>
      <tr>
          <td>commit</td>
          <td>对给定的配置文件写入修改，如果没有指定参数则将所有的配置文件写入文件系统。</td>
      </tr>
      <tr>
          <td>export</td>
          <td>导出一个机器可读格式的配置。它是作为操作配置文件的shell脚本而在内部使用，导出配置内容时会在前面加“package”和文件名。</td>
      </tr>
      <tr>
          <td>import</td>
          <td>以UCI语法导入配置文件。</td>
      </tr>
      <tr>
          <td>changes</td>
          <td>列出配置文件分阶段修改的内容，即未使用“uci commit”提交的修改。如果没有指定配置文件，则指所有的配置文件的修改部分。</td>
      </tr>
      <tr>
          <td>show</td>
          <td>显示指定的选项、配置节或配置文件。以精简的方式输出，即key=value的方式输出。</td>
      </tr>
      <tr>
          <td>get</td>
          <td>获取指令区域选项的值。</td>
      </tr>
      <tr>
          <td>set</td>
          <td>设置指定配置节选项的值，或者是增加一个配置节，类型设置为指定的值。</td>
      </tr>
      <tr>
          <td>delete</td>
          <td>删除指定的配置或选项。</td>
      </tr>
      <tr>
          <td>rename</td>
          <td>对指定的选项或配置节重命名为指定的名字。</td>
      </tr>
      <tr>
          <td>revert</td>
          <td>恢复指定的选项，配置节点或配置文件。</td>
      </tr>
  </tbody>
</table>
<h5 id="常见uci命令操作">常见UCI命令操作</h5>
<ul>
<li>UCI 文件示例：
<img src="http://shanks.link/img/openwrt/20200109152704694.png" alt="在这里插入图片描述"></li>
</ul>
<h6 id="读取类操作">读取类操作</h6>
<ul>
<li>显示指定文件配置
<code>uci show &lt;config&gt;</code> 注：省略<config>则显示全部文件配置
<img src="http://shanks.link/img/openwrt/20200109152351291.png" alt="在这里插入图片描述"></li>
<li>取得节点类型
<code>uci get &lt;config&gt;.&lt;section&gt;</code>
<img src="http://shanks.link/img/openwrt/20200109152142627.png" alt="在这里插入图片描述"></li>
<li>取得一个值
<code>uci get &lt;config&gt;.&lt;section&gt;.&lt;option&gt;</code>
<img src="http://shanks.link/img/openwrt/20200109152841919.png" alt="在这里插入图片描述"></li>
<li>显示指定节点名字配置
<code>uci show &lt;config&gt;.&lt;section&gt;</code>
<img src="http://shanks.link/img/openwrt/20200109153800477.png" alt="在这里插入图片描述"></li>
<li>显示指定节点名字选项配置
<code>uci show &lt;config&gt;.&lt;section&gt;.&lt;option&gt;</code>
<img src="http://shanks.link/img/openwrt/20200109153822383.png" alt="在这里插入图片描述"></li>
<li>显示尚未生效的修改记录
<code>uci changes &lt;config&gt;</code></li>
<li>匿名节点显示（如果所显示内容有匿名节点，使用-X参数可以显示出匿名节点的ID）
<code>uci show -X &lt;config&gt;.&lt;section&gt;.&lt;option&gt;</code></li>
</ul>
<h6 id="写入类操作">写入类操作</h6>
<ul>
<li>在文件中增加一个匿名节点
<code>uci add &lt;config&gt; &lt;section-type&gt;</code></li>
<li>在文件中增加一个节点或修改一个节点的类型（节点存在则修改，不存在则增加）
<code>uci set &lt;config&gt;.&lt;section&gt;=&lt;section-type&gt;</code></li>
<li>在节点中增加一个选项和值或修改一个选项的值（同上）
<code>uci set &lt;config&gt;.&lt;section&gt;.&lt;option&gt;=&lt;value&gt;</code></li>
<li>在列表中增加一个选项和值
<code>uci add_list &lt;config&gt;.&lt;section&gt;.&lt;option&gt;=&lt;value&gt;</code></li>
<li>删除指定名字的节点
<code>uci delete &lt;config&gt;.&lt;section&gt;</code></li>
<li>删除指定选项
<code>uci delete &lt;config&gt;.&lt;section&gt;.&lt;option&gt;</code></li>
<li>删除列表
<code>uci delete &lt;config&gt;.&lt;section&gt;.&lt;list&gt;</code></li>
<li>删除列表中的一个值
<code>uci delete &lt;config&gt;.&lt;section&gt;.&lt;option&gt;=&lt;string&gt;</code></li>
<li>生效修改（任何写入类的语法，最终都要执行生效修改，否则所做修改只在缓存中！！！不会保存在文件中！！！）
<code>uci commit &lt;config&gt;</code></li>
</ul>
<h4 id="uci-api">UCI API</h4>
<h5 id="环境安装">环境安装</h5>
<ul>
<li>UCI不仅提供命令接口供脚本开发者开发，而且提供了C语言调用接口。下面将在<strong>普通桌面操作系统Ubuntu</strong>（非板子上）下来说明API的使用。准备UCI编程接口的使用环境</li>
</ul>
<h6 id="cmake-安装">Cmake 安装</h6>
<ul>
<li>Cmake是跨平台的产生Makefile的命令行工具，它应用于在脚本文件中配置工程。Libubox和UCI均使用Cmake命令来产生目标平台的构建系统命令。因此首先安装Cmake。</li>
<li><code>sudo apt-get install cmake</code></li>
</ul>
<h6 id="libubox库-安装">Libubox库 安装</h6>
<ul>
<li>Libubox是<a href="https://so.csdn.net/so/search?q=Openwrt&amp;spm=1001.2101.3001.7020">Openwrt</a>的一个必备的基础库，包含大小端转换、链表、MD5等实用工具基础库，采用Cmake来编译。UCI软件依赖Libubox。</li>
<li>安装Libubox：安装包获取&mdash;-在编译完后的<code>openwrt源码/dl/</code> 目录下或执行命令<code>got clone https://github.com/yubo/libubox.git</code>，并执行下面命令</li>
</ul>
<blockquote>
<ul>
<li><code>tar -xzf libubox-2015-11-08-10429bccd0dc5d204635e110a7a8fae7b80d16cb.tar.gz</code></li>
<li><code>cd libubox-2015-11-08</code></li>
<li><code>cmake -D BUILD_LUA:BOOL=OFF -D BUILD_EXAMPLES:BOLL=OFF .</code></li>
<li><code>make</code></li>
<li><code>sudo make install</code></li>
</ul></blockquote>
<ul>
<li>头文件默认安装在 <code>/usr/local/include/libubox/</code> 目录下，动态链接库libubox.so和libubox.a安装在 <code>/usr/local/lib/</code> 目录下</li>
</ul>
<h6 id="uci库-安装">UCI库 安装</h6>
<ul>
<li>完成Libubox安装就可以编译安装UCI，同样的<code>openwrt源码/dl/</code> 目录下或执行命令<code>git clone https://github.com/jkjuopperi/uci.git</code>，执行下面命令</li>
</ul>
<blockquote>
<ul>
<li><code>tar -xzf uci-2015-08-27.1.tar.gz</code></li>
<li><code>cd uci-2015-08-27.1</code></li>
<li><code>cmake -D BUILD_LUA:BOOL=OFF .</code></li>
<li><code>make</code></li>
<li><code>sudo make install</code></li>
<li><code>sduo ldconfig</code></li>
</ul></blockquote>
<ul>
<li>UCI库的头文件安装在 <code>/usr/local/include/</code> 目录下，动态链接库安装在 <code>/usr/local/lib/libuci.so</code>，可执行程序为 <code>/usr/local/bin/uci</code>。</li>
<li>运行<code>ldconfig</code>命令是因为系统还不知道动态链接库已经安装，运行该命令会告诉系统重新加载动态链接库，这样UCI动态链接库就可以使用了。编译时使用<code>gcc test.c -o test -luci</code>来链接UCI库。</li>
</ul>
<h5 id="api-接口">API 接口</h5>
<ul>
<li>API 接口详情都在 <code>/usr/local/include/uci.h</code> 头文件中</li>
</ul>
<h5 id="api相关结构体">API相关结构体：</h5>
<ul>
<li>uci_context：uci上下文结构，贯彻查询、更改配置文件全过程</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#00f">struct</span> uci_context {
</span></span><span style="display:flex;"><span>	<span style="color:#f00;font-style:italic">/* list of config packages */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00f">struct</span> uci_list root;
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	<span style="color:#f00;font-style:italic">/* parser context, use for error handling only */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00f">struct</span> uci_parse_context *pctx;
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	<span style="color:#f00;font-style:italic">/* backend for import and export */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00f">struct</span> uci_backend *backend;
</span></span><span style="display:flex;"><span>	<span style="color:#00f">struct</span> uci_list backends;
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	<span style="color:#f00;font-style:italic">/* uci runtime flags */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00f">enum</span> uci_flags flags;
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	<span style="color:#00f">char</span> *confdir;
</span></span><span style="display:flex;"><span>	<span style="color:#00f">char</span> *savedir;
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	<span style="color:#f00;font-style:italic">/* search path for delta files */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00f">struct</span> uci_list delta_path;
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	<span style="color:#f00;font-style:italic">/* private: */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00f">int</span> err;
</span></span><span style="display:flex;"><span>	<span style="color:#00f">const</span> <span style="color:#00f">char</span> *func;
</span></span><span style="display:flex;"><span>	jmp_buf trap;
</span></span><span style="display:flex;"><span>	<span style="color:#00f">bool</span> internal, nested;
</span></span><span style="display:flex;"><span>	<span style="color:#00f">char</span> *buf;
</span></span><span style="display:flex;"><span>	<span style="color:#00f">int</span> bufsz;
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></div><ul>
<li>uci_package:对应一个配置文件</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#00f">struct</span> uci_package {
</span></span><span style="display:flex;"><span>	<span style="color:#00f">struct</span> uci_element e;
</span></span><span style="display:flex;"><span>	<span style="color:#00f">struct</span> uci_list sections;
</span></span><span style="display:flex;"><span>	<span style="color:#00f">struct</span> uci_context *ctx;
</span></span><span style="display:flex;"><span>	<span style="color:#00f">bool</span> has_delta;
</span></span><span style="display:flex;"><span>	<span style="color:#00f">char</span> *path;
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	<span style="color:#f00;font-style:italic">/* private: */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00f">struct</span> uci_backend *backend;
</span></span><span style="display:flex;"><span>	<span style="color:#00f">void</span> *priv;
</span></span><span style="display:flex;"><span>	<span style="color:#00f">int</span> n_section;
</span></span><span style="display:flex;"><span>	<span style="color:#00f">struct</span> uci_list delta;
</span></span><span style="display:flex;"><span>	<span style="color:#00f">struct</span> uci_list saved_delta;
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></div><ul>
<li>uci_section:对应配置文件中的节</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#00f">struct</span> uci_section {
</span></span><span style="display:flex;"><span>	<span style="color:#00f">struct</span> uci_element e;
</span></span><span style="display:flex;"><span>	<span style="color:#00f">struct</span> uci_list options;
</span></span><span style="display:flex;"><span>	<span style="color:#00f">struct</span> uci_package *package;
</span></span><span style="display:flex;"><span>	<span style="color:#00f">bool</span> anonymous;
</span></span><span style="display:flex;"><span>	<span style="color:#00f">char</span> *type;
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></div><ul>
<li>uci_option:对应配置文件节中的option和list</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#00f">struct</span> uci_option {
</span></span><span style="display:flex;"><span>	<span style="color:#00f">struct</span> uci_element e;
</span></span><span style="display:flex;"><span>	<span style="color:#00f">struct</span> uci_section *section;
</span></span><span style="display:flex;"><span>	<span style="color:#00f">enum</span> uci_option_type type;
</span></span><span style="display:flex;"><span>	<span style="color:#00f">union</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#00f">struct</span> uci_list list;
</span></span><span style="display:flex;"><span>		<span style="color:#00f">char</span> *string;
</span></span><span style="display:flex;"><span>	} v;
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></div><ul>
<li>uci_ptr:元素位置指针结构，用以查询并保存对应的位置元素</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#00f">struct</span> uci_ptr {
</span></span><span style="display:flex;"><span>	<span style="color:#00f">enum</span> uci_type target;
</span></span><span style="display:flex;"><span>	<span style="color:#00f">enum</span> {
</span></span><span style="display:flex;"><span>		UCI_LOOKUP_DONE =     (1 &lt;&lt; 0),
</span></span><span style="display:flex;"><span>		UCI_LOOKUP_COMPLETE = (1 &lt;&lt; 1),
</span></span><span style="display:flex;"><span>		UCI_LOOKUP_EXTENDED = (1 &lt;&lt; 2),
</span></span><span style="display:flex;"><span>	} flags;
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	<span style="color:#00f">struct</span> uci_package *p;
</span></span><span style="display:flex;"><span>	<span style="color:#00f">struct</span> uci_section *s;
</span></span><span style="display:flex;"><span>	<span style="color:#00f">struct</span> uci_option *o;
</span></span><span style="display:flex;"><span>	<span style="color:#00f">struct</span> uci_element *last;
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	<span style="color:#00f">const</span> <span style="color:#00f">char</span> *package;
</span></span><span style="display:flex;"><span>	<span style="color:#00f">const</span> <span style="color:#00f">char</span> *section;
</span></span><span style="display:flex;"><span>	<span style="color:#00f">const</span> <span style="color:#00f">char</span> *option;
</span></span><span style="display:flex;"><span>	<span style="color:#00f">const</span> <span style="color:#00f">char</span> *value;
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></div><h5 id="全部api函数功能">全部API函数功能：</h5>
<ul>
<li>动态分配一块内存用于struct uci_context结构</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#00f">extern</span> <span style="color:#00f">struct</span> uci_context * <span style="color:#c34e00">uci_alloc_context</span>(<span style="color:#00f">void</span>);
</span></span></code></pre></div><ul>
<li>释放struct uci_context结构内存，以及为其成员申请的所有内存</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#00f">extern</span> <span style="color:#00f">void</span> <span style="color:#c34e00">uci_free_context</span>(structuci_context *ctx);
</span></span></code></pre></div><ul>
<li>打印最后一条出错信息，如果在打印出错信息前想打印其他信息，则传入str即可</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#00f">extern</span> <span style="color:#00f">void</span> <span style="color:#c34e00">uci_perror</span>(<span style="color:#00f">struct</span> uci_context*ctx, <span style="color:#00f">const</span> <span style="color:#00f">char</span> *str);
</span></span></code></pre></div><ul>
<li>获取最后一个uci错误的错误字符串</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#00f">extern</span> <span style="color:#00f">void</span> <span style="color:#c34e00">uci_get_errorstr</span>(structuci_context *ctx, <span style="color:#00f">char</span> **dest, <span style="color:#00f">const</span> <span style="color:#00f">char</span> *str);
</span></span></code></pre></div><ul>
<li>从文件流中导入uci的配置数据</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#00f">extern</span> <span style="color:#00f">int</span> <span style="color:#c34e00">uci_import</span>(<span style="color:#00f">struct</span> uci_context * ctx, FILE * stream, <span style="color:#00f">const</span> <span style="color:#00f">char</span>  *name, <span style="color:#00f">struct</span> uci_package  **package, boolsingle);
</span></span></code></pre></div><ul>
<li>导出uci的配置文件数据到文件流stream</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#00f">extern</span> <span style="color:#00f">int</span> <span style="color:#c34e00">uci_export</span>(<span style="color:#00f">struct</span> uci_context*ctx, FILE *stream, <span style="color:#00f">struct</span> uci_package *package, <span style="color:#00f">bool</span> header);
</span></span></code></pre></div><ul>
<li>解析一个uci配置文件并把它存到ctx中</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#00f">extern</span> <span style="color:#00f">int</span> <span style="color:#c34e00">uci_load</span>(<span style="color:#00f">struct</span> uci_context*ctx, <span style="color:#00f">const</span> <span style="color:#00f">char</span> *name, <span style="color:#00f">struct</span> uci_package **package);
</span></span></code></pre></div><ul>
<li>从ctx中卸载一个配置文件包</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#00f">extern</span> <span style="color:#00f">int</span> <span style="color:#c34e00">uci_unload</span>(<span style="color:#00f">struct</span> uci_context*ctx, <span style="color:#00f">struct</span> uci_package *p);
</span></span></code></pre></div><ul>
<li>分离一个uci类型的字符串查找对应的元素</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#00f">extern</span> <span style="color:#00f">int</span> <span style="color:#c34e00">uci_lookup_ptr</span>(structuci_context *ctx, <span style="color:#00f">struct</span> uci_ptr *ptr, <span style="color:#00f">char</span> *str, <span style="color:#00f">bool</span> extended);
</span></span></code></pre></div><ul>
<li>添加一个匿名节点</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#00f">extern</span> <span style="color:#00f">int</span> <span style="color:#c34e00">uci_add_section</span>(structuci_context *ctx, <span style="color:#00f">struct</span> uci_package *p, <span style="color:#00f">const</span> <span style="color:#00f">char</span> *type, <span style="color:#00f">struct</span> uci_section**res);
</span></span></code></pre></div><ul>
<li>设置一个元素值，必要的话新建这个元素</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#00f">extern</span> <span style="color:#00f">int</span> <span style="color:#c34e00">uci_set</span>(<span style="color:#00f">struct</span> uci_context *ctx,<span style="color:#00f">struct</span> uci_ptr *ptr);
</span></span></code></pre></div><ul>
<li>附加一个字符串到一个元素列表</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#00f">extern</span> <span style="color:#00f">int</span> <span style="color:#c34e00">uci_add_list</span>(<span style="color:#00f">struct</span> uci_context*ctx, <span style="color:#00f">struct</span> uci_ptr *ptr);
</span></span></code></pre></div><ul>
<li>从一个元素列表中删除一个元素</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#00f">extern</span> <span style="color:#00f">int</span> <span style="color:#c34e00">uci_del_list</span>(<span style="color:#00f">struct</span> uci_context*ctx, <span style="color:#00f">struct</span> uci_ptr *ptr);
</span></span></code></pre></div><ul>
<li>改变一个节的（顺序）位置</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#00f">extern</span> <span style="color:#00f">int</span> <span style="color:#c34e00">uci_reorder_section</span>(structuci_context *ctx, <span style="color:#00f">struct</span> uci_section *s, <span style="color:#00f">int</span> pos);
</span></span></code></pre></div><ul>
<li>重命名一个元素</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#00f">extern</span> <span style="color:#00f">int</span> <span style="color:#c34e00">uci_rename</span>(<span style="color:#00f">struct</span> uci_context*ctx, <span style="color:#00f">struct</span> uci_ptr *ptr);
</span></span></code></pre></div><ul>
<li>删除一个节或选项</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#00f">extern</span> <span style="color:#00f">int</span> <span style="color:#c34e00">uci_delete</span>(<span style="color:#00f">struct</span> uci_context*ctx, <span style="color:#00f">struct</span> uci_ptr *ptr);
</span></span></code></pre></div><ul>
<li>为一个package保存改变的delta</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#00f">extern</span> <span style="color:#00f">int</span> <span style="color:#c34e00">uci_save</span>(<span style="color:#00f">struct</span> uci_context*ctx, <span style="color:#00f">struct</span> uci_package *p);
</span></span></code></pre></div><ul>
<li>提交改动到一个package</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#00f">extern</span> <span style="color:#00f">int</span> <span style="color:#c34e00">uci_commit</span>(<span style="color:#00f">struct</span> uci_context*ctx, <span style="color:#00f">struct</span> uci_package **p, <span style="color:#00f">bool</span> overwrite);
</span></span></code></pre></div><ul>
<li>列出可用的uci配置文件</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#00f">extern</span> <span style="color:#00f">int</span> <span style="color:#c34e00">uci_list_configs</span>(structuci_context *ctx, <span style="color:#00f">char</span> ***list);
</span></span></code></pre></div><ul>
<li>覆盖默认的delta保存的目录</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#00f">extern</span> <span style="color:#00f">int</span> <span style="color:#c34e00">uci_set_savedir</span>(structuci_context *ctx, <span style="color:#00f">const</span> <span style="color:#00f">char</span> *dir);
</span></span></code></pre></div><ul>
<li>覆盖默认的配置文件存储目录</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#00f">extern</span> <span style="color:#00f">int</span> <span style="color:#c34e00">uci_set_confdir</span>(structuci_context *ctx, <span style="color:#00f">const</span> <span style="color:#00f">char</span> *dir);
</span></span></code></pre></div><ul>
<li>为detal文件添加一个目录到搜索路径</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#00f">extern</span> <span style="color:#00f">int</span> <span style="color:#c34e00">uci_add_delta_path</span>(structuci_context *ctx, <span style="color:#00f">const</span> <span style="color:#00f">char</span> *dir);
</span></span></code></pre></div><ul>
<li>恢复一个配置项的所有变更</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#00f">extern</span> <span style="color:#00f">int</span> <span style="color:#c34e00">uci_revert</span>(<span style="color:#00f">struct</span> uci_context*ctx, <span style="color:#00f">struct</span> uci_ptr *ptr);
</span></span></code></pre></div><ul>
<li>解析一个shell风格的参数</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#00f">extern</span> <span style="color:#00f">int</span> <span style="color:#c34e00">uci_parse_argument</span>(structuci_context *ctx, FILE *stream, <span style="color:#00f">char</span> **str, <span style="color:#00f">char</span> **result);
</span></span></code></pre></div><ul>
<li>更改默认后端</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#00f">extern</span> <span style="color:#00f">int</span> <span style="color:#c34e00">uci_set_backend</span>(structuci_context *ctx, <span style="color:#00f">const</span> <span style="color:#00f">char</span> *name);
</span></span></code></pre></div><ul>
<li>验证uci options中的一个字符串值</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#00f">extern</span> <span style="color:#00f">bool</span> <span style="color:#c34e00">uci_validate_text</span>(<span style="color:#00f">const</span> <span style="color:#00f">char</span>*str);
</span></span></code></pre></div><ul>
<li>解析一个uci字符串到uci_prt结构中</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#00f">int</span> <span style="color:#c34e00">uci_parse_ptr</span>(<span style="color:#00f">struct</span> uci_context *ctx,<span style="color:#00f">struct</span> uci_ptr *ptr, <span style="color:#00f">char</span> *str);
</span></span></code></pre></div><ul>
<li>查找子元素</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#00f">int</span> <span style="color:#c34e00">uci_lookup_next</span>(<span style="color:#00f">struct</span> uci_context*ctx, <span style="color:#00f">struct</span> uci_element **e, <span style="color:#00f">struct</span> uci_list *list, <span style="color:#00f">const</span> <span style="color:#00f">char</span> *name);
</span></span></code></pre></div><ul>
<li>查找一组选项</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#00f">void</span> <span style="color:#c34e00">uci_parse_section</span>(<span style="color:#00f">struct</span> uci_section*s, <span style="color:#00f">const</span> <span style="color:#00f">struct</span> uci_parse_option *opts, <span style="color:#00f">int</span> n_opts, <span style="color:#00f">struct</span> uci_option **tb);
</span></span></code></pre></div><ul>
<li>在选项列表上构建一个散列</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#00f">uint32_t</span> <span style="color:#c34e00">uci_hash_options</span>(<span style="color:#00f">struct</span> uci_option**tb, <span style="color:#00f">int</span> n_opts);
</span></span></code></pre></div><ul>
<li>分配一个通用的uci_element，保留缓冲区和属性</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#f00;font-style:italic">#define uci_alloc_element(ctx, type, name,datasize) \
</span></span></span><span style="display:flex;"><span><span style="color:#f00;font-style:italic">              uci_to_## type (uci_alloc_generic(ctx, uci_type_ ## type, name, sizeof(struct uci_ ##type) + datasize)) 
</span></span></span><span style="display:flex;"><span><span style="color:#f00;font-style:italic">#define uci_dataptr(ptr) \
</span></span></span><span style="display:flex;"><span><span style="color:#f00;font-style:italic">              (((char*) ptr) + sizeof(*ptr))
</span></span></span></code></pre></div><ul>
<li>查找package</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#00f">static</span> <span style="color:#00f">inline</span> <span style="color:#00f">struct</span> uci_package *
</span></span><span style="display:flex;"><span><span style="color:#c34e00">uci_lookup_package</span> (<span style="color:#00f">struct</span> uci_context *ctx,<span style="color:#00f">const</span> <span style="color:#00f">char</span> *name)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>              structuci_element *e = NULL;
</span></span><span style="display:flex;"><span>              <span style="color:#00f">if</span>(<span style="color:#c34e00">uci_lookup_next</span>(ctx, &amp;e, &amp;ctx-&gt;root, name) == 0)
</span></span><span style="display:flex;"><span>                            <span style="color:#00f">return</span> <span style="color:#c34e00">uci_to_package</span>(e);
</span></span><span style="display:flex;"><span>              <span style="color:#00f">else</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#00f">return</span> NULL;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><ul>
<li>查找section</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#00f">static</span> <span style="color:#00f">inline</span> <span style="color:#00f">struct</span> uci_section *
</span></span><span style="display:flex;"><span><span style="color:#c34e00">uci_lookup_section</span>(<span style="color:#00f">struct</span> uci_context *ctx,<span style="color:#00f">struct</span> uci_package *p, <span style="color:#00f">const</span> <span style="color:#00f">char</span> *name)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>              structuci_element *e = NULL;
</span></span><span style="display:flex;"><span>              <span style="color:#00f">if</span>(<span style="color:#c34e00">uci_lookup_next</span>(ctx, &amp;e, &amp;p-&gt;sections, name) == 0)
</span></span><span style="display:flex;"><span>                            <span style="color:#c34e00">returnuci_to_section</span>(e);
</span></span><span style="display:flex;"><span>              <span style="color:#00f">else</span>
</span></span><span style="display:flex;"><span>                            returnNULL;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><ul>
<li>查找option</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#00f">static</span> <span style="color:#00f">inline</span> <span style="color:#00f">struct</span> uci_option *
</span></span><span style="display:flex;"><span><span style="color:#c34e00">uci_lookup_option</span>(<span style="color:#00f">struct</span> uci_context *ctx,<span style="color:#00f">struct</span> uci_section *s, <span style="color:#00f">const</span> <span style="color:#00f">char</span> *name)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>              structuci_element *e = NULL;
</span></span><span style="display:flex;"><span>              <span style="color:#00f">if</span>(<span style="color:#c34e00">uci_lookup_next</span>(ctx, &amp;e, &amp;s-&gt;options, name) == 0)
</span></span><span style="display:flex;"><span>                            <span style="color:#c34e00">returnuci_to_option</span>(e);
</span></span><span style="display:flex;"><span>              <span style="color:#00f">else</span>
</span></span><span style="display:flex;"><span>                            returnNULL;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#00f">static</span> <span style="color:#00f">inline</span> <span style="color:#00f">const</span> <span style="color:#00f">char</span> *
</span></span><span style="display:flex;"><span><span style="color:#c34e00">uci_lookup_option_string</span>(<span style="color:#00f">struct</span> uci_context*ctx, <span style="color:#00f">struct</span> uci_section *s, <span style="color:#00f">const</span> <span style="color:#00f">char</span> *name)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>              structuci_option *o;
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>              o= <span style="color:#c34e00">uci_lookup_option</span>(ctx, s, name);
</span></span><span style="display:flex;"><span>              <span style="color:#00f">if</span>(!o || o-&gt;type != UCI_TYPE_STRING)
</span></span><span style="display:flex;"><span>                            returnNULL;
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>              returno-&gt;v.string;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h5 id="操作实例在板子上实现">操作实例（在板子上实现）：</h5>
<p>（1）UCI 配置文件内容
<img src="http://shanks.link/img/openwrt/20200110152934791.png" alt="在这里插入图片描述">
（2)UCI配置文件简单读取：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#f00;font-style:italic">#include</span> <span style="color:#f00;font-style:italic">&lt;stdio.h&gt;</span><span style="color:#f00;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#f00;font-style:italic">#include</span> <span style="color:#f00;font-style:italic">&lt;string.h&gt;</span><span style="color:#f00;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#f00;font-style:italic">#include</span> <span style="color:#f00;font-style:italic">&lt;stdlib.h&gt;</span><span style="color:#f00;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#f00;font-style:italic">#include</span> <span style="color:#f00;font-style:italic">&#34;uci.h&#34;</span><span style="color:#f00;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#f00;font-style:italic"></span><span style="color:#00f">int</span> <span style="color:#c34e00">main</span>() 
</span></span><span style="display:flex;"><span>{ 
</span></span><span style="display:flex;"><span>    <span style="color:#00f">struct</span> uci_context *c;
</span></span><span style="display:flex;"><span>    <span style="color:#00f">struct</span> uci_ptr p;
</span></span><span style="display:flex;"><span>    <span style="color:#00f">char</span> *a = <span style="color:#c34e00">strdup</span>(<span style="color:#009c00">&#34;test_file.typedsection1.MultiValue_option_name&#34;</span>); 
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>    c = <span style="color:#c34e00">uci_alloc_context</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#00f">if</span> (UCI_OK != <span style="color:#c34e00">uci_lookup_ptr</span>(c, &amp;p, a, true)) {
</span></span><span style="display:flex;"><span>        <span style="color:#c34e00">uci_perror</span>(c, <span style="color:#009c00">&#34;no found!</span><span style="color:#009c00">\n</span><span style="color:#009c00">&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#00f">return</span> -1;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>    <span style="color:#c34e00">printf</span>(<span style="color:#009c00">&#34;%s</span><span style="color:#009c00">\n</span><span style="color:#009c00">&#34;</span>, p.o-&gt;v.string);
</span></span><span style="display:flex;"><span>    <span style="color:#c34e00">uci_free_context</span>(c);
</span></span><span style="display:flex;"><span>    <span style="color:#c34e00">free</span>(a);
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>    <span style="color:#00f">return</span>(0);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><ul>
<li>在顶层Makefile中添加如下：
<img src="http://shanks.link/img/openwrt/20200110160250953.png" alt="在这里插入图片描述"></li>
<li>在src/Makefile中添加编译链接uci库 <code>-luci</code>
<img src="http://shanks.link/img/openwrt/20200110160536144.png" alt="在这里插入图片描述"></li>
<li>然后像平常编译安装IPK包程序一样，得到IPK包，然后将IPK安装到开发板中 <code>opkg install xxx.ipk</code></li>
</ul>
<blockquote>
<p>如何生成IPK，详情见 Openwrt：IPK软件包</p></blockquote>
<ul>
<li>执行结果如下：
<img src="http://shanks.link/img/openwrt/20200110153230377.png" alt="在这里插入图片描述">
（2)UCI配置文件简单设置：</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#f00;font-style:italic">#include</span> <span style="color:#f00;font-style:italic">&lt;stdio.h&gt;</span><span style="color:#f00;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#f00;font-style:italic">#include</span> <span style="color:#f00;font-style:italic">&lt;string.h&gt;</span><span style="color:#f00;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#f00;font-style:italic">#include</span> <span style="color:#f00;font-style:italic">&lt;stdlib.h&gt;</span><span style="color:#f00;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#f00;font-style:italic">#include</span> <span style="color:#f00;font-style:italic">&#34;uci.h&#34;</span><span style="color:#f00;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#f00;font-style:italic"></span><span style="color:#00f">int</span> <span style="color:#c34e00">main</span>() 
</span></span><span style="display:flex;"><span>{ 
</span></span><span style="display:flex;"><span>    <span style="color:#00f">struct</span> uci_context *ctx;
</span></span><span style="display:flex;"><span>    <span style="color:#00f">struct</span> uci_ptr ptr;
</span></span><span style="display:flex;"><span>    <span style="color:#00f">char</span> *a = <span style="color:#c34e00">strdup</span>(<span style="color:#009c00">&#34;test_file.typedsection1.Value_option_name=hello world&#34;</span>); 
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>    ctx = <span style="color:#c34e00">uci_alloc_context</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#00f">if</span>(UCI_OK != <span style="color:#c34e00">uci_lookup_ptr</span>(ctx, &amp;ptr, a, true)) {
</span></span><span style="display:flex;"><span>        <span style="color:#c34e00">uci_perror</span>(ctx, <span style="color:#009c00">&#34;no found!</span><span style="color:#009c00">\n</span><span style="color:#009c00">&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#00f">return</span> -1;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#c34e00">uci_set</span>(ctx, &amp;ptr);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#c34e00">uci_save</span>(ctx, ptr.p);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#c34e00">uci_commit</span>(ctx, &amp;ptr.p, false);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#c34e00">uci_free_context</span>(ctx);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#c34e00">free</span>(a);
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>    <span style="color:#00f">return</span>(0);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><ul>
<li>执行结果
<img src="http://shanks.link/img/openwrt/20200110172451192.png" alt="在这里插入图片描述"></li>
<li>网页显示结果
<img src="https://img-blog.csdnimg.cn/20200110172515516.png" alt="在这里插入图片描述"></li>
</ul>
<h3 id="结尾">结尾</h3>
<h4 id="参考博文">参考博文</h4>
<ul>
<li><a href="https://www.cnblogs.com/tfanalysis/p/3688080.html">https://www.cnblogs.com/tfanalysis/p/3688080.html</a></li>
<li><a href="https://blog.csdn.net/u012819339/article/details/50752157">https://blog.csdn.net/u012819339/article/details/50752157</a></li>
<li><a href="https://blog.csdn.net/jf_xu/article/details/72629302">https://blog.csdn.net/jf_xu/article/details/72629302</a></li>
</ul>
<p><a href="https://blog.csdn.net/qq_28812525/article/details/103902872">以上内容转账自此链接，若有侵权请联系站长</a></p>

    </div>
    <footer class="post-footer">
     
 
<div class="post-tags">     
     
    <a href="http://shanks.link/tags/openwrt" rel="tag" title="OpenWrt">#OpenWrt#</a>
    
</div>



     <div class="post-nav">
    <div class="post-nav-next post-nav-item">
    
        <a href="http://shanks.link/blog/2022/10/21/openwrt-%E7%BC%96%E8%AF%91x86%E9%95%9C%E5%83%8F/" rel="next" title="Openwrt 编译x86镜像">
        <i class="fa fa-chevron-left"></i> Openwrt 编译x86镜像
        </a>
    
    </div>

    <div class="post-nav-prev post-nav-item">
    
        <a href="http://shanks.link/blog/2022/10/21/openwrt-luci-cbi%E4%BA%8C/" rel="prev" title="Openwrt LuCI CBI（二）">
        Openwrt LuCI CBI（二） <i class="fa fa-chevron-right"></i>
        </a>
    
    </div>
</div>
      
     
     
     





<script src="https://utteranc.es/client.js"
        repo="shankusu2017@gmail.com/"
        issue-term="pathname"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>
<noscript>Please enable JavaScript to view the <a href="https://github.com/utterance">comments powered by utterances.</a></noscript>

    </footer>
  </article>
</section>

          </div>
        </div>
        <div class="sidebar-toggle">
  <div class="sidebar-toggle-line-wrap">
    <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
    <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
    <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
  </div>
</div>
<aside id="sidebar" class="sidebar">
  <div class="sidebar-inner">

    <section class="site-overview sidebar-panel  sidebar-panel-active ">
      <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image"
        src="http://shanks.link/img/logo.jpg"
        alt="" />
    <p class="site-author-name" itemprop="name"></p>
    <p class="site-description motion-element" itemprop="description"> </p>
</div>
      <nav class="site-state motion-element">
    <div class="site-state-item site-state-posts">
        <a href="http://shanks.link/post/">
            <span class="site-state-item-name">日志</span>
        </a>
    </div>
    <div class="site-state-item site-state-categories">
        <a href="http://shanks.link/categories/">
            <span class="site-state-item-name">分类</span>
        </a>
    </div>

    <div class="site-state-item site-state-tags">
        <a href="http://shanks.link/tags/">
            <span class="site-state-item-name">标签</span>
        </a>
    </div>
</nav>

      
      
<div class="links-of-author motion-element">
    
        <span class="links-of-author-item">
        <a href="https://github.com/shankusu2017" target="_blank" title="GitHub">
            <i class="fa fa-fw fa-github"></i>
            GitHub
        </a>
        </span>
    
</div>


      

      <div class="links-of-blogroll motion-element inline">
<script type="text/javascript" src="//rf.revolvermaps.com/0/0/8.js?i=5b4f2ucxar6&amp;m=0&amp;s=220&amp;c=ff0000&amp;cr1=ffffff&amp;f=arial&amp;l=33&amp;bv=35" async="async"></script>
</div>

    </section>
    
  </div>
</aside>

      </div>
    </main>
   
    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  <span itemprop="copyrightYear">  &copy; 
  2009 - 2025</span>
</div>
<div>
  <a href="https://beian.miit.gov.cn/" rel="noopener" target="_blank">粤ICP备2021068940号-1</a>
  <a href="https://www.beian.gov.cn/portal/registerSystemInfo?recordcode=44011302003059" rel="noopener" target="_blank">粤公网安备44011302003059</a>
</div>


      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
      <span id="scrollpercent"><span>0</span>%</span>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>
<script type="text/javascript" src="http://shanks.link/js/vendor/jquery/index.js?v=2.1.3"></script>
<script type="text/javascript" src="http://shanks.link/js/vendor/fastclick/lib/fastclick.min.js?v=1.0.6"></script> 
<script type="text/javascript" src="http://shanks.link/js/vendor/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
<script type="text/javascript" src="http://shanks.link/js/vendor/velocity/velocity.min.js?v=1.2.1"></script>
<script type="text/javascript" src="http://shanks.link/js/vendor/velocity/velocity.ui.min.js?v=1.2.1"></script>
<script src="http://shanks.link/js/vendor/ua-parser-js/dist/ua-parser.min.js?v=0.7.9"></script>

<script src="http://shanks.link/js/vendor/fancybox/jquery.fancybox.pack.js?v=2.1.5"></script>

<script type="text/javascript" src="http://shanks.link/js/utils.js"></script>
<script type="text/javascript" src="http://shanks.link/js/motion.js"></script>
<script type="text/javascript" src="http://shanks.link/js/affix.js"></script>
<script type="text/javascript" src="http://shanks.link/js/schemes/pisces.js"></script>

<script type="text/javascript" src="http://shanks.link/js/scrollspy.js"></script>
<script type="text/javascript" src="http://shanks.link/js/post-details.js"></script>
<script type="text/javascript" src="http://shanks.link/js/toc.js"></script>

<script type="text/javascript" src="http://shanks.link/js/bootstrap.js"></script>

<script type="text/javascript" src="http://shanks.link/js/search.js"></script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX", "output/HTML-CSS"],
    tex2jax: {
      inlineMath: [ ['$','$'] ],
      displayMath: [ ['$$','$$'] ],
      processEscapes: true
    },
    "HTML-CSS": { fonts: ["TeX"] }
  });
</script>
<script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML' async></script>
</body>
</html>