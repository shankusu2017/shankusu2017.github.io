<!DOCTYPE HTML>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" /> 
    <title>Wasm介绍之1：二进制格式 - 愿星光伴你左右</title>
    <meta name="keywords" content="Lua,lua,Golang,go">
    
    <meta property="og:title" content="Wasm介绍之1：二进制格式">
    <meta property="og:site_name" content="愿星光伴你左右">
    <meta property="og:image" content="/img/author.jpg"> 
    <meta name="title" content="Wasm介绍之1：二进制格式 - 愿星光伴你左右" />
    <meta name="description" content="愿星光伴你左右"> 
    <link rel="shortcut icon" href="http://shanks.link/img/favicon.ico" />
    <link rel="apple-touch-icon" href="http://shanks.link/img/apple-touch-icon.png" />
    <link rel="apple-touch-icon-precomposed" href="http://shanks.link/img/apple-touch-icon.png" />
    <link href="http://shanks.link/js/vendor/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />
    <link href="http://shanks.link/js/vendor/fancybox/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />
    <link href="http://shanks.link/css/main.css" rel="stylesheet" type="text/css" />
    <link href="http://shanks.link/css/syntax.css" rel="stylesheet" type="text/css" />
    <script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post"},
     fancybox: true, 
    motion: true
  };
</script>
</head>
<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">
<div class="container one-collumn sidebar-position-left page-home  ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"> <div class="site-meta  custom-logo ">

  <div class="custom-logo-site-title">
    <a href="http://shanks.link/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">愿星光伴你左右</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle"></p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
    <ul id="menu" class="menu">
      
      
        <li class="menu-item ">
          <a href="http://shanks.link/post/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />首页
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/lua/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />lua
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/go/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />Golang
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/thinking/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />随想录
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/prose/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />散文
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/%E7%94%9F%E6%B4%BB/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />生活
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/os/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />OS
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/redis/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />redis
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/about/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />About Me
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/links/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />友情链接
          </a>
        </li>
      
      <li class="menu-item menu-item-search">
        <a href="javascript:;" class="popup-trigger"> <i class="menu-item-icon fa fa-search fa-fw"></i> <br /> 搜索</a>
      </li>
    </ul>
    <div class="site-search">
      <div class="popup">
 <span class="search-icon fa fa-search"></span>
 <input type="text" id="local-search-input">
 <div id="local-search-result"></div>
 <span class="popup-btn-close">close</span>
</div>

    </div>
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
<section id="posts" class="posts-expand">
  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <header class="post-header">
      <h1 class="post-title" itemprop="name headline">
        <a class="post-title-link" href="http://shanks.link/blog/2021/10/29/wasm%E4%BB%8B%E7%BB%8D%E4%B9%8B1%E4%BA%8C%E8%BF%9B%E5%88%B6%E6%A0%BC%E5%BC%8F/" itemprop="url">
        Wasm介绍之1：二进制格式
        </a>
      </h1>
      <div class="post-meta">
      <span class="post-time">
<span class="post-meta-item-icon">
    <i class="fa fa-calendar-o"></i>
</span>
<span class="post-meta-item-text">时间：</span>
<time itemprop="dateCreated" datetime="2016-03-22T13:04:35+08:00" content="2021-10-29">
    2021-10-29
</time>
</span> 
      

  <span class="post-category" >
  &nbsp; | &nbsp;
  <span class="post-meta-item-icon">
    <i class="fa fa-folder-o"></i>
  </span>
  <span class="post-meta-item-text">分类：</span>
  
    <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
      <a href="http://shanks.link/categories/wasm" itemprop="url" rel="index">
        <span itemprop="name">wasm</span>
      </a>
      &nbsp; 
    </span>
  
</span>


       <span>
&nbsp; | &nbsp;
<span class="post-meta-item-icon">
    <i class="fa fa-eye"></i>
</span>
<span class="post-meta-item-text">阅读：</span>
<span class="leancloud-visitors-count">5320 字 ~11分钟</span>
</span>
      </div>
    </header>
    <div class="post-body" itemprop="articleBody">
    <p><a href="https://juejin.cn/post/6844904062148689933">原文链接</a></p>
<p>关于<a href="https%3A%2F%2Fwebassembly.org%2F">WebAssembly</a>（下文简称Wasm）的介绍已经有很多了，本文不打算再多啰嗦。本文介绍的重点是Wasm<a href="https://link.juejin.cn/?target=https%3A%2F%2Flinks.jianshu.com%2Fgo%3Fto%3Dhttps%3A%2F%2Fwebassembly.github.io%2Fspec%2Fcore%2Fbinary%2Findex.html">二进制格式</a>，我们会把一个最简单的<a href="https://link.juejin.cn/?target=https%3A%2F%2Flinks.jianshu.com%2Fgo%3Fto%3Dhttps%3A%2F%2Fwww.rust-lang.org%2F">Rust</a>程序（没错，就是<code>Hello，World！</code>程序）编译成Wasm二进制格式，然后以Go伪代码结合<code>xxd</code>命令的形式来剖析Wasm二进制格式 。下面是这个Rust程序的完整代码（如果不了解如何将Rust编译成Wasm，请看<a href="https%3A%2F%2Fdev.to%2Fdandyvica%2Fwasm-in-rust-without-nodejs-2e0c">这篇文章</a>）：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-rust" data-lang="rust"><span style="color:#75715e">#![no_std]</span>
<span style="color:#75715e">#![no_main]</span>

<span style="color:#66d9ef">extern</span> <span style="color:#e6db74">&#34;C&#34;</span> {
    <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">print_str</span>(ptr: <span style="color:#f92672">*</span><span style="color:#66d9ef">const</span> <span style="color:#66d9ef">u8</span>, len: <span style="color:#66d9ef">usize</span>);
}

<span style="color:#75715e">#[panic_handler]</span>
<span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">panic</span>(_info: <span style="color:#66d9ef">&amp;</span><span style="color:#a6e22e">core</span>::panic::PanicInfo) -&gt; <span style="color:#f92672">!</span> {
    <span style="color:#66d9ef">loop</span> {}
}

<span style="color:#75715e">#[no_mangle]</span>
<span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">extern</span> <span style="color:#e6db74">&#34;C&#34;</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">main</span>() {
    <span style="color:#66d9ef">unsafe</span> {
        <span style="color:#66d9ef">let</span> s <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Hello, World!\n&#34;</span>;
        print_str(s.as_ptr(), s.len());
    }
}

</code></pre></div><h2 id="module">Module</h2>
<p>Wasm的顶层结构是<strong>模块</strong>（Module），每一个Wasm二进制文件对应一个模块。模块以4字节<a href="https://link.juejin.cn/?target=https%3A%2F%2Flinks.jianshu.com%2Fgo%3Fto%3Dhttps%3A%2F%2Fen.wikipedia.org%2Fwiki%2FMagic_number_%28programming%29">魔数</a>开始，接着是4字节版本号，其余是模块的数据。具体的模块数据被分门别类的放在不同的<strong>段</strong>（Section）中，每个段都由唯一的段ID来标识。除了<strong>自定义段</strong>（后文会介绍）以外，其他所有的段都最多只能出现一次，且必须按照段ID递增的顺序出现。下面的<strong>伪代码</strong>（采用Go语言语法，下同）给出了模块的整体结构：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Module</span> <span style="color:#66d9ef">struct</span> {
  <span style="color:#a6e22e">Magic</span>    <span style="color:#66d9ef">uint32</span> <span style="color:#75715e">// `\0asm`
</span><span style="color:#75715e"></span>  <span style="color:#a6e22e">Version</span>  <span style="color:#66d9ef">uint32</span> <span style="color:#75715e">// 0x00000001
</span><span style="color:#75715e"></span>  <span style="color:#a6e22e">Sections</span> []<span style="color:#a6e22e">Section</span>
}

</code></pre></div><p>用<code>xxd</code>命令观察hw.wasm文件可以发现，Wasm二进制格式的魔数是<code>\0asm</code>，当前的版本号是1（整数按照<a href="https://link.juejin.cn/?target=https%3A%2F%2Flinks.jianshu.com%2Fgo%3Fto%3Dhttps%3A%2F%2Fen.wikipedia.org%2Fwiki%2FEndianness%23Little-endian">小端在前</a>的方式存储）：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">$ xxd -u -g 1 target/wasm32-unknown-unknown/release/hw.wasm
00000000: 00 61 73 6D 01 00 00 00 01 0F 03 60 02 7F 7F 00  .asm.......`....
          ^^ ^^ ^^ ^^ ^^ ^^ ^^ ^^
00000010: 60 02 7F 7F 01 7F 60 00 00 02 11 01 03 65 6E 76  `.....`......env
00000020: 09 70 72 69 6E 74 5F 73 74 72 00 00 03 05 04 01  .print_str......
...
</code></pre></div><h2 id="section">Section</h2>
<p>Wasm规范一共定义了12种段，ID从0到11，见下面的Go常量定义：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">const</span> (
    <span style="color:#a6e22e">SecCustomID</span> = <span style="color:#ae81ff">0</span>
    <span style="color:#a6e22e">SecTypeID</span>   = <span style="color:#ae81ff">1</span>
    <span style="color:#a6e22e">SecImportID</span> = <span style="color:#ae81ff">2</span>
    <span style="color:#a6e22e">SecFuncID</span>   = <span style="color:#ae81ff">3</span>
    <span style="color:#a6e22e">SecTableID</span>  = <span style="color:#ae81ff">4</span>
    <span style="color:#a6e22e">SecMemID</span>    = <span style="color:#ae81ff">5</span>
    <span style="color:#a6e22e">SecGlobalID</span> = <span style="color:#ae81ff">6</span>
    <span style="color:#a6e22e">SecExportID</span> = <span style="color:#ae81ff">7</span>
    <span style="color:#a6e22e">SecStartID</span>  = <span style="color:#ae81ff">8</span>
    <span style="color:#a6e22e">SecElemID</span>   = <span style="color:#ae81ff">9</span>
    <span style="color:#a6e22e">SecCodeID</span>   = <span style="color:#ae81ff">10</span>
    <span style="color:#a6e22e">SecDataID</span>   = <span style="color:#ae81ff">11</span>
)
</code></pre></div><p>在Wasm二进制文件里，每个段都以段ID开始。除了自定义段，其它段的结构都已经定义好了。由于自定义段的内容可能是未知的，所以段ID后面存储了段的实际内容的字节数，这样Wasm实现就可以跳过不认识的自定义段。为了让Wasm二进制文件更加紧凑，整数是按<a href="https%3A%2F%2Fen.wikipedia.org%2Fwiki%2FLEB128">LEB128</a>格式编码后存储的。下面的伪代码给出了段的抽象结构（<code>varU32</code>类型表示LEB128编码的32位无符号整数）：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">type Section struct {
  ID   byte
  Size varU32 // uint32
  Cont []byte
}

复制代码
</code></pre></div><h2 id="type-section">Type Section</h2>
<p>在Wasm二进制文件里，函数的信息分布在三个段里（先忽略导入的外部函数以及调试信息）。类型（Type）段用来存放函数的类型信息（或者<a href="https://link.juejin.cn/?target=https%3A%2F%2Flinks.jianshu.com%2Fgo%3Fto%3Dhttps%3A%2F%2Fen.wikipedia.org%2Fwiki%2FType_signature">签名</a>），代码（Code）段存放函数的局部变量信息和字节码，函数（Function）段将代码段和类型段关联起来。由于需要存储多个函数类型，所以需要把函数类型的数量先存下来，这是Wasm二进制格式存储<a href="https%3A%2F%2Fwebassembly.github.io%2Fspec%2Fcore%2Fbinary%2Fconventions.html%23binary-vec">Vector</a>数据的标准做法。为了简单起见，我们在后面的伪代码中省略数量，直接用Go的slice类型表示vec。类型段的ID是1，结构由下面的伪代码给出：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">type TypeSec struct {
  ID    byte       // 0x01
  Size  varU32     // uint32
  Types []FuncType // vec
}
</code></pre></div><p>函数类型由<code>0x60</code>开头，然后是参数类型和返回值类型。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">type FuncType struct {
  Tag     byte // 0x60
  Params  []ValType
  Results []ValType
}

// 0x7F: i32, 0x7E: i64, 0x7D: f32, 0x7C: f64
type ValType = byte
</code></pre></div><p>用<code>xxd</code>命令观察hw.wasm文件可知，出现的第一个段的确是类型段，内容是15（<code>0x0F</code>）个字节，包含3个函数类型：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">$ xxd -u -g 1 target/wasm32-unknown-unknown/release/hw.wasm
00000000: 00 61 73 6D 01 00 00 00 01 0F 03 60 02 7F 7F 00  .asm.......`....
                                  ^^ ^^ ^^
00000010: 60 02 7F 7F 01 7F 60 00 00 02 11 01 03 65 6E 76  `.....`......env
00000020: 09 70 72 69 6E 74 5F 73 74 72 00 00 03 05 04 01  .print_str......
...
</code></pre></div><p>再来观察第一个函数类型，可以看到的确由<code>0x60</code>开头，参数有两个，都是<code>i32</code>类型（<code>0x7F</code>），没有返回值：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">$ xxd -u -g 1 target/wasm32-unknown-unknown/release/hw.wasm
00000000: 00 61 73 6D 01 00 00 00 01 0F 03 60 02 7F 7F 00  .asm.......`....
                                           ^^ ^^ ^^ ^^ ^^
00000010: 60 02 7F 7F 01 7F 60 00 00 02 11 01 03 65 6E 76  `.....`......env
00000020: 09 70 72 69 6E 74 5F 73 74 72 00 00 03 05 04 01  .print_str......
...
</code></pre></div><h2 id="import-section">Import Section</h2>
<p>导入段存储导入信息，段ID是2。导入信息又包括导入模块名、导入名和导入描述。Wasm支持四种类型的导入：函数、表、内存和全局变量。为了区分具体是哪种导入，导入描述需要以一字节的tag开头，具体的描述信息因tag而异。下面的伪代码描述了导入段的整体结构：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">type ImportSec struct {
  ID      byte // 0x02
  Size    varU32
  Imports []Import
}

type Import struct {
  Module  string
  Name    string
  DescTag byte // func: 0, table: 1, mem: 2, global: 3
  Desc    ...
}
</code></pre></div><p>对于函数导入，Desc描述的是函数的类型信息在类型段里的索引。其他导入类型本文不做详细介绍，请读者参考<a href="https%3A%2F%2Fwebassembly.github.io%2Fspec%2Fcore%2Fbinary%2Fmodules.html%23binary-importsec">Wasm规范</a>。用<code>xxd</code>命令观察hw.wasm文件可知，导入段跟在类型段后面，内容是17（<code>0x11</code>）个字节，仅有1条导入信息：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">$ xxd -u -g 1 target/wasm32-unknown-unknown/release/hw.wasm
00000000: 00 61 73 6D 01 00 00 00 01 0F 03 60 02 7F 7F 00  .asm.......`....
00000010: 60 02 7F 7F 01 7F 60 00 00 02 11 01 03 65 6E 76  `.....`......env
                                     ^^ ^^ ^^
00000020: 09 70 72 69 6E 74 5F 73 74 72 00 00 03 05 04 01  .print_str......
...
</code></pre></div><p>在唯一的一条导入信息中，模块名是<code>env</code>（这是由Rust编译器默认生成的），导入名是<code>print_str</code>：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">$ xxd -u -g 1 target/wasm32-unknown-unknown/release/hw.wasm
00000000: 00 61 73 6D 01 00 00 00 01 0F 03 60 02 7F 7F 00  .asm.......`....
00000010: 60 02 7F 7F 01 7F 60 00 00 02 11 01 03 65 6E 76  `.....`......env
                                              ^^ ^^ ^^ ^^              ^^^^
00000020: 09 70 72 69 6E 74 5F 73 74 72 00 00 03 05 04 01  .print_str......
          ^^ ^^ ^^ ^^ ^^ ^^ ^^ ^^ ^^ ^^                    ^^^^^^^^^^
...
</code></pre></div><p>不难发现，在Wasm二进制文件里，字符串也是按照vector方式（长度+内容）存储的，内容是UTF-8编码后的字节数组。继续观察可以看到，tag是<code>0x00</code>，表示这是一条函数导入，函数的类型信息存储在类型段的第0号位置：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">$ xxd -u -g 1 target/wasm32-unknown-unknown/release/hw.wasm
00000000: 00 61 73 6D 01 00 00 00 01 0F 03 60 02 7F 7F 00  .asm.......`....
00000010: 60 02 7F 7F 01 7F 60 00 00 02 11 01 03 65 6E 76  `.....`......env
00000020: 09 70 72 69 6E 74 5F 73 74 72 00 00 03 05 04 01  .print_str......
                                        ^^ ^^
...
</code></pre></div><h2 id="function-section">Function Section</h2>
<p>函数段相对来说比较简单，按顺序存储了每一个内部函数的签名在类型段中的索引。比如说某个模块有5个内部函数，那么查两次表就可以找到该函数的签名：<code>TypeSec.Types[FuncSec.Types[n]]</code>。函数段的ID是3，整体结构由下面的伪代码给出：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">FuncSec</span> <span style="color:#66d9ef">struct</span> {
  <span style="color:#a6e22e">ID</span>    <span style="color:#66d9ef">byte</span> <span style="color:#75715e">// 0x03
</span><span style="color:#75715e"></span>  <span style="color:#a6e22e">Size</span>  <span style="color:#a6e22e">varU32</span>
  <span style="color:#a6e22e">Types</span> []<span style="color:#a6e22e">TypeIdx</span> <span style="color:#75715e">// []varU32
</span><span style="color:#75715e"></span>}
</code></pre></div><p>用<code>xxd</code>命令观察hw.wasm文件可知，函数段跟在导入段后面，内容是5个字节，包含4个函数类型索引（1、1、2、1）：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">$ xxd -u -g 1 target/wasm32-unknown-unknown/release/hw.wasm
00000000: 00 61 73 6D 01 00 00 00 01 0F 03 60 02 7F 7F 00  .asm.......`....
00000010: 60 02 7F 7F 01 7F 60 00 00 02 11 01 03 65 6E 76  `.....`......env
00000020: 09 70 72 69 6E 74 5F 73 74 72 00 00 03 05 04 01  .print_str......
                                              ^^ ^^ ^^ ^^
00000030: 01 02 01 04 05 01 70 01 01 01 05 03 01 00 11 06  ......p.........
          ^^ ^^ ^^
...
</code></pre></div><h2 id="tableelement-section">Table&amp;Element Section</h2>
<p><a href="https://link.juejin.cn/?target=https%3A%2F%2Flinks.jianshu.com%2Fgo%3Fto%3Dhttps%3A%2F%2Fwebassembly.github.io%2Fspec%2Fcore%2Fbinary%2Fmodules.html%23table-section">表段</a>（ID是4）和<a href="https://link.juejin.cn/?target=https%3A%2F%2Flinks.jianshu.com%2Fgo%3Fto%3Dhttps%3A%2F%2Fwebassembly.github.io%2Fspec%2Fcore%2Fbinary%2Fmodules.html%23element-section">元素段</a>（ID是9）与<a href="https://link.juejin.cn/?target=https%3A%2F%2Flinks.jianshu.com%2Fgo%3Fto%3Dhttps%3A%2F%2Fwebassembly.github.io%2Fspec%2Fcore%2Fexec%2Finstructions.html%23exec-call-indirect">间接函数调用指令</a>有关，本文不做介绍，请读者参考Wasm规范。</p>
<h2 id="memory-section">Memory Section</h2>
<p>内存段的ID是5，存放内存信息。内存信息给出该模块运行所需内存页数（一页是64K）的下限（必须指定）和上限（可选）。虽然内存段是支持多个内存的，但是Wasm1.0规范规定内存不能超过一个，这个限制可能会在后续版本中放开。下面的伪代码描述了内存段的整体结构：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">MemSec</span> <span style="color:#66d9ef">struct</span> {
  <span style="color:#a6e22e">ID</span>    <span style="color:#66d9ef">byte</span> <span style="color:#75715e">// 0x05
</span><span style="color:#75715e"></span>  <span style="color:#a6e22e">Size</span>  <span style="color:#a6e22e">varU32</span>
  <span style="color:#a6e22e">Mems</span>  []<span style="color:#a6e22e">Limits</span>
}

<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Limits</span> <span style="color:#66d9ef">struct</span> {
  <span style="color:#a6e22e">HasMax</span> <span style="color:#66d9ef">byte</span> <span style="color:#75715e">// 0: min, 1: min+max
</span><span style="color:#75715e"></span>  <span style="color:#a6e22e">Min</span>    <span style="color:#a6e22e">varU32</span>
  <span style="color:#a6e22e">Max</span>    <span style="color:#a6e22e">varU32</span>
}
</code></pre></div><p>用<code>xxd</code>命令观察hw.wasm文件可知，内存段的内容是3个字节，包含1份内存信息。这份内存信息以0开头，所以仅指定了页数下限（<code>0x11</code>，也就是17），没有指定页数上限：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">$ xxd -u -g 1 target/wasm32-unknown-unknown/release/hw.wasm
00000000: 00 61 73 6D 01 00 00 00 01 0F 03 60 02 7F 7F 00  .asm.......`....
00000010: 60 02 7F 7F 01 7F 60 00 00 02 11 01 03 65 6E 76  `.....`......env
00000020: 09 70 72 69 6E 74 5F 73 74 72 00 00 03 05 04 01  .print_str......
00000030: 01 02 01 04 05 01 70 01 01 01 05 03 01 00 11 06  ......p.........
                                        ^^ ^^ ^^ ^^ ^^
...
</code></pre></div><h2 id="globlal-section">Globlal Section</h2>
<p>全局变量段存储内部（非导入）的全局变量信息，段ID是6。全局变量信息包括变量的类型、是否只读以及用于初始化该全局变量的字节码。下面的伪代码描述了全局变量段的整体结构：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">GlobalSec</span> <span style="color:#66d9ef">struct</span> {
  <span style="color:#a6e22e">ID</span>      <span style="color:#66d9ef">byte</span> <span style="color:#75715e">// 0x06
</span><span style="color:#75715e"></span>  <span style="color:#a6e22e">Size</span>    <span style="color:#a6e22e">varU32</span>
  <span style="color:#a6e22e">Globals</span> []<span style="color:#a6e22e">Global</span>
}

<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Global</span> <span style="color:#66d9ef">struct</span> {
  <span style="color:#a6e22e">Type</span>  <span style="color:#a6e22e">ValType</span>
  <span style="color:#a6e22e">Mut</span>   <span style="color:#66d9ef">byte</span> <span style="color:#75715e">// const: 0, var: 1
</span><span style="color:#75715e"></span>  <span style="color:#a6e22e">Expr</span>  []<span style="color:#a6e22e">Instruction</span>
}
</code></pre></div><p>用<code>xxd</code>命令观察hw.wasm文件可知，全局变量段跟在内存段后面，内容是25（<code>0x19</code>）个字节，包含3个全局变量：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">...
00000030: 01 02 01 04 05 01 70 01 01 01 05 03 01 00 11 06  ......p.........
                                                       ^^
00000040: 19 03 7F 01 41 80 80 C0 00 0B 7F 00 41 8E 80 C0  ....A.......A...
          ^^ ^^
00000050: 00 0B 7F 00 41 8E 80 C0 00 0B 07 2C 04 06 6D 65  ....A......,..me
...
</code></pre></div><p>其中第1个全局变量的类型是<code>i32</code>（<code>0x7F</code>），可变（<code>0x01</code>），初始化字节码一共6个字节（本文不介绍指令编码，请读者参考<a href="https://link.juejin.cn/?target=https%3A%2F%2Flinks.jianshu.com%2Fgo%3Fto%3Dhttps%3A%2F%2Fwebassembly.github.io%2Fspec%2Fcore%2Fbinary%2Finstructions.html%23expressions">Wasm规范</a>）：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">...</span>
<span style="color:#ae81ff">00000030</span>: <span style="color:#ae81ff">01</span> <span style="color:#ae81ff">02</span> <span style="color:#ae81ff">01</span> <span style="color:#ae81ff">04</span> <span style="color:#ae81ff">05</span> <span style="color:#ae81ff">01</span> <span style="color:#ae81ff">70</span> <span style="color:#ae81ff">01</span> <span style="color:#ae81ff">01</span> <span style="color:#ae81ff">01</span> <span style="color:#ae81ff">05</span> <span style="color:#ae81ff">03</span> <span style="color:#ae81ff">01</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">11</span> <span style="color:#ae81ff">06</span>  <span style="color:#f92672">......</span><span style="color:#a6e22e">p</span><span style="color:#f92672">.........</span>
<span style="color:#ae81ff">00000040</span>: <span style="color:#ae81ff">19</span> <span style="color:#ae81ff">03</span> <span style="color:#ae81ff">7</span><span style="color:#a6e22e">F</span> <span style="color:#ae81ff">01</span> <span style="color:#ae81ff">41</span> <span style="color:#ae81ff">80</span> <span style="color:#ae81ff">80</span> <span style="color:#a6e22e">C0</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">0</span><span style="color:#a6e22e">B</span> <span style="color:#ae81ff">7</span><span style="color:#a6e22e">F</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">41</span> <span style="color:#ae81ff">8</span><span style="color:#a6e22e">E</span> <span style="color:#ae81ff">80</span> <span style="color:#a6e22e">C0</span>  <span style="color:#f92672">...</span>.<span style="color:#a6e22e">A</span><span style="color:#f92672">......</span>.<span style="color:#a6e22e">A</span><span style="color:#f92672">...</span>
                ^^ ^^ <span style="color:#960050;background-color:#1e0010">~~</span> <span style="color:#960050;background-color:#1e0010">~~</span> <span style="color:#960050;background-color:#1e0010">~~</span> <span style="color:#960050;background-color:#1e0010">~~</span> <span style="color:#960050;background-color:#1e0010">~~</span> <span style="color:#960050;background-color:#1e0010">~~</span>
<span style="color:#ae81ff">00000050</span>: <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">0</span><span style="color:#a6e22e">B</span> <span style="color:#ae81ff">7</span><span style="color:#a6e22e">F</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">41</span> <span style="color:#ae81ff">8</span><span style="color:#a6e22e">E</span> <span style="color:#ae81ff">80</span> <span style="color:#a6e22e">C0</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">0</span><span style="color:#a6e22e">B</span> <span style="color:#ae81ff">07</span> <span style="color:#ae81ff">2</span><span style="color:#a6e22e">C</span> <span style="color:#ae81ff">04</span> <span style="color:#ae81ff">06</span> <span style="color:#ae81ff">6</span><span style="color:#a6e22e">D</span> <span style="color:#ae81ff">65</span>  <span style="color:#f92672">...</span>.<span style="color:#a6e22e">A</span><span style="color:#f92672">......</span>,..<span style="color:#a6e22e">me</span>
<span style="color:#f92672">...</span>
</code></pre></div><h2 id="export-section">Export Section</h2>
<p>和导入段相对应的是导出段，ID是7。和导入信息一样，导出信息也分为4种：函数、表、内存和全局变量。不过导出信息要稍微简单一些，不包含模块 名，且无论导出的是什么，都只需给出相应的索引即可。下面的伪代码描述了导出段的整体结构：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">ExportSec</span> <span style="color:#66d9ef">struct</span> {
  <span style="color:#a6e22e">ID</span>      <span style="color:#66d9ef">byte</span> <span style="color:#75715e">// 0x07
</span><span style="color:#75715e"></span>  <span style="color:#a6e22e">Size</span>    <span style="color:#a6e22e">varU32</span>
  <span style="color:#a6e22e">Exports</span> []<span style="color:#a6e22e">Export</span>
}

<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Export</span> <span style="color:#66d9ef">struct</span> {
  <span style="color:#a6e22e">Name</span>  <span style="color:#66d9ef">string</span>
  <span style="color:#a6e22e">Tag</span>   <span style="color:#66d9ef">byte</span> <span style="color:#75715e">// func: 0, table: 1, mem: 2, global: 3
</span><span style="color:#75715e"></span>  <span style="color:#a6e22e">Idx</span>   <span style="color:#a6e22e">varU32</span>
}
</code></pre></div><p>用<code>xxd</code>命令观察hw.wasm文件可知，导出段跟在全局变量段后面，内容是44（<code>0x2C</code>）个字节，包含4个全局变量：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">...
00000030: 01 02 01 04 05 01 70 01 01 01 05 03 01 00 11 06  ......p.........
00000040: 19 03 7F 01 41 80 80 C0 00 0B 7F 00 41 8E 80 C0  ....A.......A...
00000050: 00 0B 7F 00 41 8E 80 C0 00 0B 07 2C 04 06 6D 65  ....A......,..me
                                        ^^ ^^ ^^
...
</code></pre></div><p>其中第4个导出的名字是<code>main</code>，类型是函数（<code>0x00</code>），索引是3（导入的函数和内部函数一起构成了函数索引空间）：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">...
00000050: 00 0B 7F 00 41 8E 80 C0 00 0B 07 2C 04 06 6D 65  ....A......,..me
00000060: 6D 6F 72 79 02 00 0A 5F 5F 64 61 74 61 5F 65 6E  mory...__data_en
00000070: 64 03 01 0B 5F 5F 68 65 61 70 5F 62 61 73 65 03  d...__heap_base.
00000080: 02 04 6D 61 69 6E 00 03 0A DD 01 04 5D 01 08 7F  ..main......]...
             ^^ ^^ ^^ ^^ ^^ ^^ ^^                           ^^^^^
...
</code></pre></div><h2 id="start-section">Start Section</h2>
<p>和其他段不同，起始段只包含一个起始函数索引。指定的函数相当于C/C++/Java等语言里的<code>main</code>函数，当Wasm实现将模块实例化后，需要执行这个 函数。起始段的ID是8，结构可以用下面的伪代码描述：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">StartSec</span> <span style="color:#66d9ef">struct</span> {
  <span style="color:#a6e22e">ID</span>      <span style="color:#66d9ef">byte</span> <span style="color:#75715e">// 0x08
</span><span style="color:#75715e"></span>  <span style="color:#a6e22e">Size</span>    <span style="color:#a6e22e">varU32</span>
  <span style="color:#a6e22e">FuncIdx</span> <span style="color:#a6e22e">varU32</span>
}
</code></pre></div><p>由于Rust编译器没有给模块生成起始段，所以也就没办法用hw.wasm文件进行观察了。</p>
<h2 id="code-section">Code Section</h2>
<p>如前所述，内部函数的局部变量信息和字节码存放在代码段中，段ID是10。为了便于并行处理（比如验证、分析、AOT编译等），代码段中的每一项都自带了字节数。这样就可以先把每一个内部函数的局部变量信息和字节码数据提取出来，然后同时处理多个函数。下面的伪代码描述了代码段的整体结构：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">CodeSec</span> <span style="color:#66d9ef">struct</span> {
  <span style="color:#a6e22e">ID</span>    <span style="color:#66d9ef">byte</span> <span style="color:#75715e">// 0x0A
</span><span style="color:#75715e"></span>  <span style="color:#a6e22e">Size</span>  <span style="color:#a6e22e">varU32</span>
  <span style="color:#a6e22e">Codes</span> []<span style="color:#a6e22e">Code</span>
}

<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Code</span> <span style="color:#66d9ef">struct</span> {
  <span style="color:#a6e22e">Size</span>   <span style="color:#a6e22e">varU32</span>
    <span style="color:#a6e22e">Locals</span> []<span style="color:#a6e22e">Locals</span>
    <span style="color:#a6e22e">Expr</span>   []<span style="color:#a6e22e">Instruction</span>
}
<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Locals</span> <span style="color:#66d9ef">struct</span> {
    <span style="color:#a6e22e">N</span>    <span style="color:#66d9ef">uint32</span>
    <span style="color:#a6e22e">Type</span> <span style="color:#a6e22e">ValType</span>
}
</code></pre></div><p>用<code>xxd</code>命令观察hw.wasm文件可知，代码段跟在导出段后面，内容是221（<code>0xDD</code>、<code>0x01</code>）个字节，包含4个内部函数：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">...</span>
<span style="color:#ae81ff">000000</span><span style="color:#ae81ff">80</span>: <span style="color:#ae81ff">02</span> <span style="color:#ae81ff">04</span> <span style="color:#ae81ff">6</span><span style="color:#a6e22e">D</span> <span style="color:#ae81ff">61</span> <span style="color:#ae81ff">69</span> <span style="color:#ae81ff">6</span><span style="color:#a6e22e">E</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">03</span> <span style="color:#ae81ff">0</span><span style="color:#a6e22e">A</span> <span style="color:#a6e22e">DD</span> <span style="color:#ae81ff">01</span> <span style="color:#ae81ff">04</span> <span style="color:#ae81ff">5</span><span style="color:#a6e22e">D</span> <span style="color:#ae81ff">01</span> <span style="color:#ae81ff">08</span> <span style="color:#ae81ff">7</span><span style="color:#a6e22e">F</span>  ..<span style="color:#a6e22e">main</span><span style="color:#f92672">......</span>]<span style="color:#f92672">...</span>
                                  ^^ ^^ ^^ ^^
<span style="color:#ae81ff">000000</span><span style="color:#ae81ff">90</span>: <span style="color:#ae81ff">23</span> <span style="color:#ae81ff">80</span> <span style="color:#ae81ff">80</span> <span style="color:#ae81ff">80</span> <span style="color:#ae81ff">80</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">21</span> <span style="color:#ae81ff">02</span> <span style="color:#ae81ff">41</span> <span style="color:#ae81ff">10</span> <span style="color:#ae81ff">21</span> <span style="color:#ae81ff">03</span> <span style="color:#ae81ff">20</span> <span style="color:#ae81ff">02</span> <span style="color:#ae81ff">20</span> <span style="color:#ae81ff">03</span>  <span style="color:#960050;background-color:#1e0010">#</span><span style="color:#f92672">...</span>..!.<span style="color:#a6e22e">A</span>.!. . .
<span style="color:#ae81ff">000000</span><span style="color:#a6e22e">a0</span>: <span style="color:#ae81ff">6</span><span style="color:#a6e22e">B</span> <span style="color:#ae81ff">21</span> <span style="color:#ae81ff">04</span> <span style="color:#ae81ff">20</span> <span style="color:#ae81ff">04</span> <span style="color:#ae81ff">24</span> <span style="color:#ae81ff">80</span> <span style="color:#ae81ff">80</span> <span style="color:#ae81ff">80</span> <span style="color:#ae81ff">80</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">20</span> <span style="color:#ae81ff">04</span> <span style="color:#ae81ff">20</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">36</span>  <span style="color:#a6e22e">k</span>!. .<span style="color:#960050;background-color:#1e0010">$</span><span style="color:#f92672">...</span>.. . <span style="color:#ae81ff">.6</span>
<span style="color:#ae81ff">000000</span><span style="color:#a6e22e">b0</span>: <span style="color:#ae81ff">02</span> <span style="color:#ae81ff">08</span> <span style="color:#ae81ff">20</span> <span style="color:#ae81ff">04</span> <span style="color:#ae81ff">20</span> <span style="color:#ae81ff">01</span> <span style="color:#ae81ff">36</span> <span style="color:#ae81ff">02</span> <span style="color:#ae81ff">0</span><span style="color:#a6e22e">C</span> <span style="color:#ae81ff">20</span> <span style="color:#ae81ff">04</span> <span style="color:#ae81ff">28</span> <span style="color:#ae81ff">02</span> <span style="color:#ae81ff">08</span> <span style="color:#ae81ff">21</span> <span style="color:#ae81ff">05</span>  .. . <span style="color:#ae81ff">.6</span>.. .(..!.
<span style="color:#ae81ff">000000</span><span style="color:#a6e22e">c0</span>: <span style="color:#ae81ff">20</span> <span style="color:#ae81ff">04</span> <span style="color:#ae81ff">28</span> <span style="color:#ae81ff">02</span> <span style="color:#ae81ff">0</span><span style="color:#a6e22e">C</span> <span style="color:#ae81ff">21</span> <span style="color:#ae81ff">06</span> <span style="color:#ae81ff">20</span> <span style="color:#ae81ff">05</span> <span style="color:#ae81ff">20</span> <span style="color:#ae81ff">06</span> <span style="color:#ae81ff">10</span> <span style="color:#ae81ff">84</span> <span style="color:#ae81ff">80</span> <span style="color:#ae81ff">80</span> <span style="color:#ae81ff">80</span>   .(..!. . <span style="color:#f92672">......</span>
<span style="color:#f92672">...</span>
</code></pre></div><p>第一个内部函数有93个字节的数据（<code>0x5D</code>）。有一个局部变量信息，表示该函数需要8个<code>i32</code>（<code>0x7F</code>）类型的参数。其余90个字节是该函数的字节码（本文不介绍指令编码，请读者参考<a href="https://link.juejin.cn/?target=https%3A%2F%2Flinks.jianshu.com%2Fgo%3Fto%3Dhttps%3A%2F%2Fwebassembly.github.io%2Fspec%2Fcore%2Fbinary%2Finstructions.html%23expressions">Wasm规范</a>）：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">...
00000080: 02 04 6D 61 69 6E 00 03 0A DD 01 04 5D 01 08 7F  ..main......]...
                                              ^^ ^^ ^^ ^^
00000090: 23 80 80 80 80 00 21 02 41 10 21 03 20 02 20 03  #.....!.A.!. . .
000000a0: 6B 21 04 20 04 24 80 80 80 80 00 20 04 20 00 36  k!. .$..... . .6
000000b0: 02 08 20 04 20 01 36 02 0C 20 04 28 02 08 21 05  .. . .6.. .(..!.
000000c0: 20 04 28 02 0C 21 06 20 05 20 06 10 84 80 80 80   .(..!. . ......
000000d0: 00 21 07 41 10 21 08 20 04 20 08 6A 21 09 20 09  .!.A.!. . .j!. .
000000e0: 24 80 80 80 80 00 20 07 0F 0B 05 00 20 00 0F 0B  $..... ..... ...
...                                  ^^
</code></pre></div><h2 id="data-section">Data Section</h2>
<p>数据段存放内存初始化信息，ID是11。每条内存初始化信息包括内存索引（目前只可能是0）、起始位置（字节码，且必须是是<a href="https://link.juejin.cn/?target=https%3A%2F%2Flinks.jianshu.com%2Fgo%3Fto%3Dhttps%3A%2F%2Fwebassembly.github.io%2Fspec%2Fcore%2Fvalid%2Finstructions.html%23constant-expressions">常量表达式</a>）、初始数据。下面的伪代码描述了数据段的整体结构：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">DataSec</span> <span style="color:#66d9ef">struct</span> {
  <span style="color:#a6e22e">ID</span>    <span style="color:#66d9ef">byte</span> <span style="color:#75715e">// 0x0B
</span><span style="color:#75715e"></span>  <span style="color:#a6e22e">Size</span>  <span style="color:#a6e22e">varU32</span>
  <span style="color:#a6e22e">Datas</span> []<span style="color:#a6e22e">Data</span>
}

<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Data</span> <span style="color:#66d9ef">struct</span> {
  <span style="color:#a6e22e">MemIdx</span> <span style="color:#a6e22e">varU32</span> <span style="color:#75715e">// 0
</span><span style="color:#75715e"></span>  <span style="color:#a6e22e">Offset</span> []<span style="color:#a6e22e">Instruction</span>
  <span style="color:#a6e22e">Init</span>   []<span style="color:#66d9ef">byte</span>
}
</code></pre></div><p>用<code>xxd</code>命令观察hw.wasm文件可知，数据段跟在代码段后面，内容是23（<code>0x17</code>）个字节，包含1份内存初始化信息：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">...
00000160: 02 0C 21 05 20 05 0F 0B 0B 17 01 00 41 80 80 C0  ..!. .......A...
                                  ^^ ^^ ^^
00000170: 00 0B 0E 48 65 6C 6C 6F 2C 20 57 6F 72 6C 64 21  ...Hello, World!
00000180: 0A 00 DE 01 04 6E 61 6D 65 01 D6 01 05 00 09 70  .....name......p
...
</code></pre></div><p>这份内存初始化信息的内存索引是0，内存起始位置由一条<a href="https://link.juejin.cn/?target=https%3A%2F%2Flinks.jianshu.com%2Fgo%3Fto%3Dhttps%3A%2F%2Fwebassembly.github.io%2Fspec%2Fcore%2Fbinary%2Finstructions.html%23numeric-instructions">i32.const</a>指令（操作码是<code>0x41</code>，<a href="https://link.juejin.cn/?target=https%3A%2F%2Flinks.jianshu.com%2Fgo%3Fto%3Dhttps%3A%2F%2Fwebassembly.github.io%2Fspec%2Fcore%2Fsyntax%2Finstructions.html%23instructions">参数</a>是<code>0x100000</code>）给出。由指该令可以算出，内存起始位置在第17页的最开始（<code>0x100000 / (64 * 1024)</code>）：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">...
00000160: 02 0C 21 05 20 05 0F 0B 0B 17 01 00 41 80 80 C0  ..!. .......A...
                                           ^^ ^^ ^^ ^^ ^^
00000170: 00 0B 0E 48 65 6C 6C 6F 2C 20 57 6F 72 6C 64 21  ...Hello, World!
          ^^
00000180: 0A 00 DE 01 04 6E 61 6D 65 01 D6 01 05 00 09 70  .....name......p
...
</code></pre></div><p>初始化数据是14（<code>0x0E</code>）个字节，内容就是Rust代码中的字符串字面量<code>Hello, World!\n</code>：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">...
00000160: 02 0C 21 05 20 05 0F 0B 0B 17 01 00 41 80 80 C0  ..!. .......A...
00000170: 00 0B 0E 48 65 6C 6C 6F 2C 20 57 6F 72 6C 64 21  ...Hello, World!
                ^^ ^^ ^^ ^^ ^^ ^^ ^^ ^^ ^^ ^^ ^^ ^^ ^^ ^^    ^^^^^^^^^^^^^^
00000180: 0A 00 DE 01 04 6E 61 6D 65 01 D6 01 05 00 09 70  .....name......p
          ^^                                               ^
...
</code></pre></div><h2 id="custom-section">Custom Section</h2>
<p>自定义段可以存放调试信息、第三方扩展信息等等，这些信息不是Wasm执行所必须的，可以完全忽略。另外，与其他段不同（必须严格按顺序出现，且最多只能出现一次），自定义段可以自由出现在其他段前后，且可以连续出现多次。自定义段的内容以字符串开始，这样就进一步区分自定义段。下面的伪代码描述了自定义段的抽象结构：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">CustomSec</span> <span style="color:#66d9ef">struct</span> {
  <span style="color:#a6e22e">ID</span>    <span style="color:#66d9ef">byte</span> <span style="color:#75715e">// 0
</span><span style="color:#75715e"></span>  <span style="color:#a6e22e">Size</span>  <span style="color:#a6e22e">varU32</span>
  <span style="color:#a6e22e">Name</span>  <span style="color:#66d9ef">string</span>
  <span style="color:#a6e22e">Cont</span>  <span style="color:#f92672">...</span>
}
</code></pre></div><p>Wasm规范只定义了一种自定义段，name是字符串<code>name</code>。本文不介绍name段的具体格式，请读者参考<a href="https://link.juejin.cn/?target=https%3A%2F%2Flinks.jianshu.com%2Fgo%3Fto%3Dhttp%3A%2F%2Fdwebassembly.github.io%2Fspec%2Fcore%2Fappendix%2Fcustom.html%23name-section">Wasm规范</a>。用<code>xxd</code>命令观察hw.wasm文件可知，在数据段后面跟了一个自定义段，内容是222（<code>0xDE</code>、<code>0x01</code>）个字节，它的name正好就是<code>name</code>（<code>0x6E</code>、<code>0x61</code>、<code>0x6D</code>、<code>0x65</code>）：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">...
00000180: 0A 00 DE 01 04 6E 61 6D 65 01 D6 01 05 00 09 70  .....name......p
             ^^ ^^ ^^ ^^ ^^ ^^ ^^ ^^
00000190: 72 69 6E 74 5F 73 74 72 01 3B 5F 5A 4E 34 63 6F  rint_str.;_ZN4co
000001a0: 72 65 33 73 74 72 32 31 5F 24 4C 54 24 69 6D 70  re3str21_$LT$imp
000001b0: 6C 24 75 32 30 24 73 74 72 24 47 54 24 33 6C 65  l$u20$str$GT$3le
000001c0: 6E 31 37 68 63 65 63 35 39 61 61 36 36 64 36 34  n17hcec59aa66d64
000001d0: 32 30 63 62 45 02 3E 5F 5A 4E 34 63 6F 72 65 33  20cbE.&gt;_ZN4core3
000001e0: 73 74 72 32 31 5F 24 4C 54 24 69 6D 70 6C 24 75  str21_$LT$impl$u
000001f0: 32 30 24 73 74 72 24 47 54 24 36 61 73 5F 70 74  20$str$GT$6as_pt
00000200: 72 31 37 68 31 30 64 38 36 64 62 35 37 30 32 38  r17h10d86db57028
00000210: 32 33 30 64 45 03 04 6D 61 69 6E 04 45 5F 5A 4E  230dE..main.E_ZN
00000220: 34 63 6F 72 65 35 73 6C 69 63 65 32 39 5F 24 4C  4core5slice29_$L
00000230: 54 24 69 6D 70 6C 24 75 32 30 24 24 75 35 62 24  T$impl$u20$u5b$
00000240: 54 24 75 35 64 24 24 47 54 24 33 6C 65 6E 31 37  T$u5d$GT$3len17
00000250: 68 64 36 36 37 30 30 66 65 31 35 30 61 66 38 62  hd66700fe150af8b
00000260: 63 45 
</code></pre></div>
    </div>
    <footer class="post-footer">
     
 
<div class="post-tags">     
     
    <a href="http://shanks.link/tags/wasm" rel="tag" title="wasm">#wasm#</a>
    
</div>



     <div class="post-nav">
    <div class="post-nav-next post-nav-item">
    
        <a href="http://shanks.link/blog/2021/10/29/wasm%E4%BB%8B%E7%BB%8D%E4%B9%8B2%E6%8C%87%E4%BB%A4%E9%9B%86%E5%92%8C%E6%A0%88/" rel="next" title="Wasm介绍之2：指令集和栈">
        <i class="fa fa-chevron-left"></i> Wasm介绍之2：指令集和栈
        </a>
    
    </div>

    <div class="post-nav-prev post-nav-item">
    
        <a href="http://shanks.link/blog/2021/10/28/ffi/" rel="prev" title="FFI">
        FFI <i class="fa fa-chevron-right"></i>
        </a>
    
    </div>
</div>
      
     
     
     





<script src="https://utteranc.es/client.js"
        repo="shankusu2017@gmail.com/"
        issue-term="pathname"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>
<noscript>Please enable JavaScript to view the <a href="https://github.com/utterance">comments powered by utterances.</a></noscript>

    </footer>
  </article>
</section>

          </div>
        </div>
        <div class="sidebar-toggle">
  <div class="sidebar-toggle-line-wrap">
    <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
    <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
    <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
  </div>
</div>
<aside id="sidebar" class="sidebar">
  <div class="sidebar-inner">

    <section class="site-overview sidebar-panel  sidebar-panel-active ">
      <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image"
        src="http://shanks.link/img/logo.jpg"
        alt="shankusu2017@gmail.com" />
    <p class="site-author-name" itemprop="name">shankusu2017@gmail.com</p>
    <p class="site-description motion-element" itemprop="description"> </p>
</div>
      <nav class="site-state motion-element">
    <div class="site-state-item site-state-posts">
      <a href="http://shanks.link/post/">
        <span class="site-state-item-count">407</span>
        <span class="site-state-item-name">日志</span>
      </a>
    </div>
    <div class="site-state-item site-state-categories">    
        <a href="http://shanks.link/categories/">      
         
        <span class="site-state-item-count">23</span>
        
        <span class="site-state-item-name">分类</span>
        
        </a>
    </div>

    <div class="site-state-item site-state-tags">
        <a href="http://shanks.link/tags/">
         
        <span class="site-state-item-count">29</span>
        
        <span class="site-state-item-name">标签</span>
        </a>
    </div>
</nav>
      
      
<div class="links-of-author motion-element">
    
        <span class="links-of-author-item">
        <a href="https://github.com/shankusu2017" target="_blank" title="GitHub">
            <i class="fa fa-fw fa-github"></i>
            GitHub
        </a>
        </span>
    
</div>


      

      <div class="links-of-blogroll motion-element inline">
<script type="text/javascript" src="//rf.revolvermaps.com/0/0/8.js?i=5b4f2ucxar6&amp;m=0&amp;s=220&amp;c=ff0000&amp;cr1=ffffff&amp;f=arial&amp;l=33&amp;bv=35" async="async"></script>
</div>

    </section>
    
  </div>
</aside>

      </div>
    </main>
   
    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  <span itemprop="copyrightYear">  &copy; 
  2009 - 2022</span>
  <span class="with-love"><i class="fa fa-heart"></i></span>
  <span class="author" itemprop="copyrightHolder">愿星光伴你左右</span>
</div>
<div class="powered-by">
  Powered by - <a class="theme-link" href="http://gohugo.io" target="_blank" title="hugo" >Hugo v0.92.1</a>
</div>
<div class="theme-info">
  Theme by - <a class="theme-link" href="https://github.com/xtfly/hugo-theme-next" target="_blank"> NexT
  </a>
</div>


      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
      <span id="scrollpercent"><span>0</span>%</span>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>
<script type="text/javascript" src="http://shanks.link/js/vendor/jquery/index.js?v=2.1.3"></script>
<script type="text/javascript" src="http://shanks.link/js/vendor/fastclick/lib/fastclick.min.js?v=1.0.6"></script> 
<script type="text/javascript" src="http://shanks.link/js/vendor/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
<script type="text/javascript" src="http://shanks.link/js/vendor/velocity/velocity.min.js?v=1.2.1"></script>
<script type="text/javascript" src="http://shanks.link/js/vendor/velocity/velocity.ui.min.js?v=1.2.1"></script>
<script src="http://shanks.link/js/vendor/ua-parser-js/dist/ua-parser.min.js?v=0.7.9"></script>

<script src="http://shanks.link/js/vendor/fancybox/jquery.fancybox.pack.js?v=2.1.5"></script>

<script type="text/javascript" src="http://shanks.link/js/utils.js"></script>
<script type="text/javascript" src="http://shanks.link/js/motion.js"></script>
<script type="text/javascript" src="http://shanks.link/js/affix.js"></script>
<script type="text/javascript" src="http://shanks.link/js/schemes/pisces.js"></script>

<script type="text/javascript" src="http://shanks.link/js/scrollspy.js"></script>
<script type="text/javascript" src="http://shanks.link/js/post-details.js"></script>
<script type="text/javascript" src="http://shanks.link/js/toc.js"></script>

<script type="text/javascript" src="http://shanks.link/js/bootstrap.js"></script>

<script type="text/javascript" src="http://shanks.link/js/search.js"></script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX", "output/HTML-CSS"],
    tex2jax: {
      inlineMath: [ ['$','$'] ],
      displayMath: [ ['$$','$$'] ],
      processEscapes: true
    },
    "HTML-CSS": { fonts: ["TeX"] }
  });
</script>
<script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML' async></script>
</body>
</html>