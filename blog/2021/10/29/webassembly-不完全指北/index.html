<!DOCTYPE HTML>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" /> 
    <title>WebAssembly 不完全指北 - Golang编程语言知识介绍</title>
    <meta name="keywords" content="git,Git,Lua,lua,Golang,go">
    
    <meta property="og:title" content="WebAssembly 不完全指北">
    <meta property="og:site_name" content="Golang编程语言知识介绍">
    <meta property="og:image" content="/img/author.jpg"> 
    <meta name="title" content="WebAssembly 不完全指北 - Golang编程语言知识介绍" />
    <meta name="description" content="愿星光伴你左右"> 
    <link rel="shortcut icon" href="http://shanks.link/img/favicon.ico" />
    <link rel="apple-touch-icon" href="http://shanks.link/img/apple-touch-icon.png" />
    <link rel="apple-touch-icon-precomposed" href="http://shanks.link/img/apple-touch-icon.png" />
    <link href="http://shanks.link/js/vendor/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />
    <link href="http://shanks.link/js/vendor/fancybox/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />
    <link href="http://shanks.link/css/main.css" rel="stylesheet" type="text/css" />
    <link href="http://shanks.link/css/syntax.css" rel="stylesheet" type="text/css" />
    <script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post"},
     fancybox: true, 
    motion: true
  };
</script>
</head>
<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">
<div class="container one-collumn sidebar-position-left page-home  ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"> <div class="site-meta  custom-logo ">

  <div class="custom-logo-site-title">
    <a href="http://shanks.link/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">Golang编程语言知识介绍</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle"></p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
    <ul id="menu" class="menu">
      
      
        <li class="menu-item ">
          <a href="http://shanks.link/post/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />首页
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/thinking/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />随想录
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/%E7%94%9F%E6%B4%BB/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />生活
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/os/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />OS
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/lua/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />lua
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/redis/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />redis
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/go/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />Golang
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/c/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />C
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/tcpip/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />TCP/IP
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/ebpf/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />ebpf
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/p4/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />p4
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/openvpn/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />OpenVPN
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/ipsec/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />IPSec
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/l2tp/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />L2TP
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/dns/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />DNS
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/web/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />web
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/openwrt/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />OpenWRT
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/%E8%BF%90%E7%BB%B4/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />运维
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/git/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />Git
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/%E9%B8%9F%E5%93%A5%E7%9A%84%E7%A7%81%E6%88%BF%E8%8F%9C/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />鸟哥的私房菜
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/it/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />IT杂谈
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/about/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />About Me
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/links/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />友情链接
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/ftp/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />FTP
          </a>
        </li>
      
      <li class="menu-item menu-item-search">
        <a href="javascript:;" class="popup-trigger"> <i class="menu-item-icon fa fa-search fa-fw"></i> <br /> 搜索</a>
      </li>
    </ul>
    <div class="site-search">
      <div class="popup">
 <span class="search-icon fa fa-search"></span>
 <input type="text" id="local-search-input">
 <div id="local-search-result"></div>
 <span class="popup-btn-close">close</span>
</div>

    </div>
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
<section id="posts" class="posts-expand">
  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <header class="post-header">
      <h1 class="post-title" itemprop="name headline">
        <a class="post-title-link" href="http://shanks.link/blog/2021/10/29/webassembly-%E4%B8%8D%E5%AE%8C%E5%85%A8%E6%8C%87%E5%8C%97/" itemprop="url">
        WebAssembly 不完全指北
        </a>
      </h1>
      <div class="post-meta">
      <span class="post-time">
<span class="post-meta-item-icon">
    <i class="fa fa-calendar-o"></i>
</span>
<span class="post-meta-item-text">时间：</span>
<time itemprop="dateCreated" datetime="2016-03-22T13:04:35+08:00" content="2021-10-29">
    2021-10-29
</time>
</span> 
      

  <span class="post-category" >
  &nbsp; | &nbsp;
  <span class="post-meta-item-icon">
    <i class="fa fa-folder-o"></i>
  </span>
  <span class="post-meta-item-text">分类：</span>
  
    <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
      <a href="http://shanks.link/categories/wasm" itemprop="url" rel="index">
        <span itemprop="name">wasm</span>
      </a>
      &nbsp; 
    </span>
  
</span>


       <span>
&nbsp; | &nbsp;
<span class="post-meta-item-icon">
    <i class="fa fa-eye"></i>
</span>
<span class="post-meta-item-text">阅读：</span>
<span class="leancloud-visitors-count">3931 字 ~8分钟</span>
</span>
      </div>
    </header>
    <div class="post-body" itemprop="articleBody">
    <p><a href="https://juejin.cn/post/6844903895110533133">原文链接</a></p>
<h2 id="背景从-javascript-说起">背景：从 JavaScript 说起</h2>
<blockquote>
<p>JavaScript 占据着统治地位，不管是公开还是私有的项目、任何组织、世界任何地区，JavaScript 都是第一。 -GitHub 2018 年度报告</p>
</blockquote>
<p><img src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2019/7/23/16c1cbdedf8c36c4~tplv-t2oaga2asx-watermark.awebp" alt="img"></p>
<p>随着JavaScript的快速发展，目前它已然成为最流行的编程语言之一，这背后正是 Web 的发展所推动的。但是随着JavaScript被广泛的应用，它也暴露了很多问题：</p>
<ul>
<li>语法太灵活导致开发大型 Web 项目困难；</li>
<li>性能不能满足一些场景的需要；</li>
</ul>
<p>这两大问题成为JavaScript头顶上的达摩克利斯之剑，危及着JavaScript更广泛的应用。</p>
<p><img src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2019/7/23/16c1cbdf20f6b609~tplv-t2oaga2asx-watermark.awebp" alt="img"></p>
<p>Brendan Eich 做梦也没想到，自己花了十天仓促设计出来的 JavaScript，一经推出就被广泛接受，获得了全世界范围内大量的用户使用。前人挖坑，后人来填。既然JavaScript已经成为了Web编程的事实标准，那么这两个亟待解决的问题势必将要被解决。</p>
<h2 id="msgooglemozilla的探索">MS、Google、Mozilla的探索</h2>
<h3 id="mstypescript">MS：TypeScript</h3>
<p>第一个问题被著名开源软件大厂MicroSoft解决。</p>
<p><img src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2019/7/23/16c1cbdee9b36b87~tplv-t2oaga2asx-watermark.awebp" alt="img"></p>
<p>MicroSoft集结了C#的首席架构师以及Delphi和Turbo Pascal的创始人Anders Hejlsberg等明星阵容，打造了TypeScript。</p>
<p>TypeScript它是JavaScript的一个严格超集，并添加了可选的静态类型和使用看起来像基于类的面向对象编程语法操作 Prototype。所以TypeScript可以这样理解：</p>
<p><img src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2019/7/23/16c1cbdeec6b7d0b~tplv-t2oaga2asx-watermark.awebp" alt="img"></p>
<p>MicroSoft利用TypeScript这把锋利的武器打造了VSCode等史诗级项目，于是乎，第一把达摩克利斯之剑&quot;语法太灵活导致开发大型 Web 项目困难&quot;似乎已经被解决。</p>
<p>但是，由于TypeScript最终仍然是被编译成JavaScript在浏览器中执行，所以困扰着JavaScript开发者的性能问题，仍然没有被解决。</p>
<h3 id="googlev8">Google：V8</h3>
<p>早在2008年，Google就推出了自家的JavaScript引擎V8，试图使用JIT技术提升JavaScript的执行速度，并且它真的做到了。</p>
<p><img src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2019/7/23/16c1cbdee9c80769~tplv-t2oaga2asx-watermark.awebp" alt="img"></p>
<p>由于JIT技术的引入，V8使得Web性能得到了数十倍的增长！</p>
<p><img src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2019/7/23/16c1cbdee9038aab~tplv-t2oaga2asx-watermark.awebp" alt="img"></p>
<p>上图展示了Chrome的v8与IE的Chakra benchmark结果。具体的地址<a href="https://link.juejin.cn/?target=https%3A%2F%2Fsqreen.github.io%2Fnode_engine_bench%2F%3Fq%3DeyJ0ZXN0cyI6WyIuL3Rlc3RzL2FjY2Vzcy1ub24tZXhpc3RlbnQtYXJndW1lbnRzLWluZGV4LmpzIl0sInZlcnNpb25zIjpbIjYuMTAuMV92OCIsIjcuMTAuMF92OCIsIjcuMTAuMF92OF90dXJib19pZ25pdGlvbiIsIjguMC4wX3Y4IiwiOC4wLjBfdjhfdHVyYm9faWduaXRpb24iLCI4LjAuMC1uaWdodGx5MjAxNzA0MTUyNjVmYzBiZWRjX2NoYWtyYSIsIjguMC4wLW5pZ2h0bHkyMDE3MDUwNWZlNDRmNTQ5NDlfY2hha3JhIl19">点我</a></p>
<p>既然性能得到了如此大的提升，那么JavaScript广为诟病的性能问题得到了解决吗？为啥Web性能还是被挑战？</p>
<h4 id="单线程---阻塞">单线程 -&gt; 阻塞</h4>
<p>Web应用中，性能瓶颈大部分的原因已经不在JavaScript，而在于DOM。浏览器中通常会把DOM和JavaScript独立实现。下图展示了不同浏览器DOM和JavaScript的实现情况：</p>
<p><img src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2019/7/23/16c1cbdf15cb3475~tplv-t2oaga2asx-watermark.awebp" alt="img"></p>
<p>由于Dom渲染和JavaScript引擎是相对独立的，这两个模块相互访问的时候，都是通过接口访问。由于JavaScript单线程的特性，这种访问只能是单工的。</p>
<p><img src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2019/7/23/16c1cbdf1c1edc98~tplv-t2oaga2asx-watermark.awebp" alt="img"></p>
<p>可以把DOM和JavaScript各自想象为一个岛屿，他们之间用桥梁连接，JavaScript每次访问DOM，都要经过这座桥，并交纳过桥费，访问的次数越多，费用就越高，因此，推荐的做法是尽可能减少过桥的次数，一直待在JavaScript岛上。为了达到这个目的，可以使用Virtual Dom，Web Worker来实现。这里就不再赘述。</p>
<h4 id="jit-vs-aot在重型计算面前仍然力不从心">JIT VS AOT，在重型计算面前仍然力不从心</h4>
<p>刚才谈到，V8引擎首次将JIT技术引入JavaScript当中，大幅提升了执行速度。那么首先我们需要理解什么是JIT，以及AOT。</p>
<blockquote>
<p>AOT: Ahead-of-Time compilation</p>
</blockquote>
<p>必须是强类型语言，编译在执行之前，编译直接生成CPU能够执行的二进制文件，执行时CPU不需要做任何编译操作，直接执行，性能最佳。</p>
<blockquote>
<p>JIT: Just-in-Time compilation</p>
</blockquote>
<p>没有编译环节。执行时根据上下文生成二进制汇编代码，灌入CPU执行。JIT执行时，可以根据代码编译进行优化，代码运行时，不需要每次都翻译成二进制汇编代码，V8就是这样优化JavaScript性能的。</p>
<p><img src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2019/7/23/16c1cbdf58d69070~tplv-t2oaga2asx-watermark.awebp" alt="img"></p>
<p>由于JavaScript的动态语言类型已无法改变，所以只能采用JIT的形式对性能进行优化。</p>
<p>为了进一步JIT优化效率，继而提升JavaScript性能，浏览器鼻祖Mozilla推出了asm.js。</p>
<h3 id="mozillaasmjs">Mozilla：asm.js</h3>
<p>和TypeScript比较相似的是，asm.js同样也是强类型的JavaScript，但是他的语法则是JavaScript的子集，是为了JIT性能优化而专门打造的。</p>
<p>一段典型的asm.js代码如下：</p>
<p><img src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2019/7/23/16c1cbdf382b38af~tplv-t2oaga2asx-watermark.awebp" alt="img"></p>
<p>可以看到，asm.js使用了按位或0的操作，来声明x为整形。从而确保JIT在执行过程中尽快生成相应的二进制代码，不用再去根据上下文判断变量类型。</p>
<p>Mozilla给出了asm.js的benchmark：</p>
<p><img src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2019/7/23/16c1cbdf670a3b85~tplv-t2oaga2asx-watermark.awebp" alt="img"></p>
<h3 id="asmjs-to-webassembly">asm.js To WebAssembly</h3>
<p>自从Mozilla提出了asm.js，Google、MicroSoft、Apple都觉得asm.js的思路不错，于是联合起来，一同共建WebAssembly生态。</p>
<p><img src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2019/7/23/16c1cbdf722a4bfe~tplv-t2oaga2asx-watermark.awebp" alt="WeWork Helper20190721065439.png"></p>
<p>同asm.js不同的是，WebAssembly是一份字节码标准，以字节码的形式依赖虚拟机在浏览器中运行。</p>
<p><img src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2019/7/23/16c1cbdf85d0ffc8~tplv-t2oaga2asx-watermark.awebp" alt="img"></p>
<p>可以依赖Emscripten等编译器将C++/Golang/Rust/Kotlin等强类型语言编译成为WebAssembly字节码（.wasm文件）。所以WebAssembly并不是Assembly（汇编），它只是看起来像汇编而已。一份典型的.wasm文件如下所示：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">00000000: 0061 736d 0100 0000 0108 0260 017f 0060  .asm.......`...`
00000010: 0000 0215 0203 656e 7603 6d65 6d02 0001  ......env.mem...
00000020: 026a 7303 6c6f 6700 0003 0201 0107 0b01  .js.log.........
00000030: 0765 7861 6d70 6c65 0001 0a23 0121 0041  .example...#.!.A
00000040: 0042 c8ca b1e3 f68d c8ab ef00 3703 0041  .B..........7..A
00000050: 0841 f2d8 918b 0236 0200 4100 1000 0b    .A.....6..A....
复制代码
</code></pre></div><h2 id="实战">实战</h2>
<h3 id="环境搭建编译emscripten">环境搭建:编译Emscripten</h3>
<p>本次使用官方推荐的CPP语言编译成为WebAssembly文件，并在浏览器中执行。首先需要搭建Emscripten环境。Emscripten被用于将CPP文件转换成为WASM字节码文件。</p>
<p>常规的搭建流程十分繁琐：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">1、确保安装CMake、Xcode、Python 2.7.x 
2、git clone https://github.com/juj/emsdk.git
3、./emsdk install --build=Release sdk-incoming-64bit binaryen-master-64bit

等待约1个小时……，切换版本需要重新编译。

复制代码
</code></pre></div><p>不过，早有好心人为我们准备了捷径：<strong>使用Docker镜像</strong>，快速开启你的WebAssembly之路吧。只需要以下几步：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">1、安装Docker
2、docker pull trzeci/emscripten:latest
3、alias emcc=&#39;docker run –rm -v $(pwd):/src -u emscripten trzeci/emscripten emcc’

切换版本只需要pull相应的tag
复制代码
</code></pre></div><h3 id="编译cpp的md5函数至wasm">编译CPP的MD5函数至WASM</h3>
<p>首先需要找到一份计算MD5的CPP代码：</p>
<blockquote>
<p><a href="mailto:git@github.com">git@github.com</a>:codenoid/md5-cpp.git</p>
</blockquote>
<p><img src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2019/7/23/16c1cbdfa0f684ff~tplv-t2oaga2asx-watermark.awebp" alt="img"></p>
<p>使用emscripten.h中的EMSCRIPTEN_KEEPALIVE宏，确保emcc编译器在编译时，不会因为该函数没有被调用而优化掉这个函数。</p>
<p>这里uint8_t* 被隐式类型转换为char*</p>
<p>使用emcc编译CPP文件至WASM文件：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">emcc -O3 -s WASM=1 -s EXTRA_EXPORTED_RUNTIME_METHODS=&#39;[&#34;cwrap&#34;]’ md5.c
复制代码
</code></pre></div><ul>
<li>-O3: 优化级别，O3是最高优化级别</li>
<li>-s WASM=1：生成wasm代码，而不是asm.js代码</li>
<li>-s EXTRA_EXPORTED_RUNTIME_METHODS=‘[“cwrap”]‘：在JavaScript中使用cwrap函数引用导出函数</li>
</ul>
<p>最后会生成a.out.js和a.out.wasm两个文件。分别是WASM和JavaScript交互的胶水文件以及WebAssembly字节码文件。</p>
<p><img src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2019/7/23/16c1cbe043464415~tplv-t2oaga2asx-watermark.awebp" alt="img"></p>
<p>计算md5并输出结果：</p>
<p><img src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2019/7/23/16c1cbdfb47daa61~tplv-t2oaga2asx-watermark.awebp" alt="img"></p>
<p>这里有两点需要注意：</p>
<ul>
<li>a.out.js会自动fetch wasm文件，由于获取wasm文件也存在跨域的情况，可以使用http-server本地起一个sever。</li>
<li>CPP的变量类型以及JavaScript的变量类型需要进行转换，转换由胶水代码自动执行，具体的转换规则如下：</li>
</ul>
<p><img src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2019/7/23/16c1cbdfc7382c5f~tplv-t2oaga2asx-watermark.awebp" alt="img"></p>
<h3 id="benchmark">benchmark</h3>
<p>既然WebAssembly主打性能提升，那么benchmark就必不可少啦，针对&quot;ivweb&quot;短字符加密100000次，benchmark的结果如下：</p>
<p><img src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2019/7/23/16c1cbdfff7abd80~tplv-t2oaga2asx-watermark.awebp" alt="img"></p>
<p>可以看到WebAssembly相较于纯JavaScript，计算性能大约提升了39%，这与普遍的100%+的性能提升有着较大差距。这是为什么呢？</p>
<p>我又对2M的长文本进行benchmark对比，结果如下：</p>
<p><img src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2019/7/23/16c1cbdfee490b16~tplv-t2oaga2asx-watermark.awebp" alt="img"></p>
<p>这一次的提升就比较大了。是什么造成了如此大的差距呢？我猜测有两点原因：</p>
<ol>
<li>对&quot;ivweb&quot;短字符加密100000次时，JIT优化介入后，不需要每次都去编译，JavasScript性能得到了极大提升。</li>
<li>对&quot;ivweb&quot;短字符加密100000次时，胶水代码执行次数较多，拖慢了性能。</li>
</ol>
<p>针对与以上两点猜测，又做了一组benchmark，加密“ivweb”5000000次</p>
<p><img src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2019/7/23/16c1cbe00872307d~tplv-t2oaga2asx-watermark.awebp" alt="img"></p>
<p>可以看到WebAssembly与纯粹的JavaScript性能差距以及不大了，验证了我的猜想。</p>
<p>本次benchmark代码我已经上传到GitHub仓库中：</p>
<p><a href="mailto:git@github.com">git@github.com</a>:PeacefulLion/wasm-benchmark.git</p>
<h3 id="启示">启示</h3>
<p>鉴于V8的强大性能，90%的应用场景下你不需要WebAssembly.</p>
<p><strong>启示：如何提高JS代码性能？</strong></p>
<ol>
<li>声明变量时提供默认类型，加快JIT介入</li>
<li>不要轻易改变变量的类型</li>
<li>Node.js像JAVA一样也存在JIT预热？</li>
</ol>
<h2 id="总结与展望">总结与展望</h2>
<p>现在的WebAssembly还并不完美。但是线程的支持，异常处理，垃圾收集，尾调用优化等，都已经加入WebAssembly的计划列表中了。</p>
<p>将来，WebAssembly能够被用于：</p>
<ul>
<li>扩展浏览器端视音频处理能力（H.265）</li>
<li>基于WebAssembly的高性能Web应用(加密、游戏、挖矿？)</li>
</ul>
<p>目前Webpack4已经支持import wasm文件的形式调用wasm文件。</p>
<p><img src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2019/7/23/16c1cbe014a2df79~tplv-t2oaga2asx-watermark.awebp" alt="img"></p>
<p>未来，WebAssembly 将可能直接通过 HTML 标签进行引用，比如：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">&lt;script src=&#34;./wa.wasm&#34;&gt;&lt;/script&gt;；
复制代码
</code></pre></div><p>或者可以通过 JavaScript ES6 模块的方式引用，比如：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">import xxx from &#39;./wa.wasm&#39;;；
复制代码
</code></pre></div>
    </div>
    <footer class="post-footer">
     
 
<div class="post-tags">     
     
    <a href="http://shanks.link/tags/wasm" rel="tag" title="wasm">#wasm#</a>
    
</div>



     <div class="post-nav">
    <div class="post-nav-next post-nav-item">
    
        <a href="http://shanks.link/blog/2021/11/09/linux%E5%8A%A8%E6%80%81%E5%BA%93so%E8%B0%83%E7%94%A8%E5%A4%96%E9%83%A8so%E8%BF%90%E8%A1%8C%E6%97%B6%E5%87%BA%E7%8E%B0undefined-symbol/" rel="next" title="linux动态库so调用外部so，运行时出现undefined symbol">
        <i class="fa fa-chevron-left"></i> linux动态库so调用外部so，运行时出现undefined symbol
        </a>
    
    </div>

    <div class="post-nav-prev post-nav-item">
    
        <a href="http://shanks.link/blog/2021/10/29/wasm%E4%BB%8B%E7%BB%8D%E4%B9%8B7%E6%96%87%E6%9C%AC%E6%A0%BC%E5%BC%8F/" rel="prev" title="Wasm介绍之7：文本格式">
        Wasm介绍之7：文本格式 <i class="fa fa-chevron-right"></i>
        </a>
    
    </div>
</div>
      
     
     
     





<script src="https://utteranc.es/client.js"
        repo="shankusu2017@gmail.com/"
        issue-term="pathname"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>
<noscript>Please enable JavaScript to view the <a href="https://github.com/utterance">comments powered by utterances.</a></noscript>

    </footer>
  </article>
</section>

          </div>
        </div>
        <div class="sidebar-toggle">
  <div class="sidebar-toggle-line-wrap">
    <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
    <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
    <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
  </div>
</div>
<aside id="sidebar" class="sidebar">
  <div class="sidebar-inner">

    <section class="site-overview sidebar-panel  sidebar-panel-active ">
      <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image"
        src="http://shanks.link/img/logo.jpg"
        alt="shankusu2017@gmail.com" />
    <p class="site-author-name" itemprop="name">shankusu2017@gmail.com</p>
    <p class="site-description motion-element" itemprop="description"> </p>
</div>
      <nav class="site-state motion-element">
    <div class="site-state-item site-state-posts">
        <a href="http://shanks.link/post/">
            <span class="site-state-item-name">日志</span>
        </a>
    </div>
    <div class="site-state-item site-state-categories">
        <a href="http://shanks.link/categories/">
            <span class="site-state-item-name">分类</span>
        </a>
    </div>

    <div class="site-state-item site-state-tags">
        <a href="http://shanks.link/tags/">
            <span class="site-state-item-name">标签</span>
        </a>
    </div>
</nav>

      
      
<div class="links-of-author motion-element">
    
        <span class="links-of-author-item">
        <a href="https://github.com/shankusu2017" target="_blank" title="GitHub">
            <i class="fa fa-fw fa-github"></i>
            GitHub
        </a>
        </span>
    
</div>


      

      <div class="links-of-blogroll motion-element inline">
<script type="text/javascript" src="//rf.revolvermaps.com/0/0/8.js?i=5b4f2ucxar6&amp;m=0&amp;s=220&amp;c=ff0000&amp;cr1=ffffff&amp;f=arial&amp;l=33&amp;bv=35" async="async"></script>
</div>

    </section>
    
  </div>
</aside>

      </div>
    </main>
   
    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  <span itemprop="copyrightYear">  &copy; 
  2009 - 2023</span>
</div>
<div>
  <a href="https://beian.miit.gov.cn/" rel="noopener" target="_blank">粤ICP备2021068940号-1</a>
  <a href="https://www.beian.gov.cn/portal/registerSystemInfo?recordcode=44011302003059" rel="noopener" target="_blank">粤公网安备44011302003059</a>
</div>


      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
      <span id="scrollpercent"><span>0</span>%</span>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>
<script type="text/javascript" src="http://shanks.link/js/vendor/jquery/index.js?v=2.1.3"></script>
<script type="text/javascript" src="http://shanks.link/js/vendor/fastclick/lib/fastclick.min.js?v=1.0.6"></script> 
<script type="text/javascript" src="http://shanks.link/js/vendor/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
<script type="text/javascript" src="http://shanks.link/js/vendor/velocity/velocity.min.js?v=1.2.1"></script>
<script type="text/javascript" src="http://shanks.link/js/vendor/velocity/velocity.ui.min.js?v=1.2.1"></script>
<script src="http://shanks.link/js/vendor/ua-parser-js/dist/ua-parser.min.js?v=0.7.9"></script>

<script src="http://shanks.link/js/vendor/fancybox/jquery.fancybox.pack.js?v=2.1.5"></script>

<script type="text/javascript" src="http://shanks.link/js/utils.js"></script>
<script type="text/javascript" src="http://shanks.link/js/motion.js"></script>
<script type="text/javascript" src="http://shanks.link/js/affix.js"></script>
<script type="text/javascript" src="http://shanks.link/js/schemes/pisces.js"></script>

<script type="text/javascript" src="http://shanks.link/js/scrollspy.js"></script>
<script type="text/javascript" src="http://shanks.link/js/post-details.js"></script>
<script type="text/javascript" src="http://shanks.link/js/toc.js"></script>

<script type="text/javascript" src="http://shanks.link/js/bootstrap.js"></script>

<script type="text/javascript" src="http://shanks.link/js/search.js"></script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX", "output/HTML-CSS"],
    tex2jax: {
      inlineMath: [ ['$','$'] ],
      displayMath: [ ['$$','$$'] ],
      processEscapes: true
    },
    "HTML-CSS": { fonts: ["TeX"] }
  });
</script>
<script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML' async></script>
</body>
</html>