<!DOCTYPE HTML>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" /> 
    <title>gdb 提示 coredump 文件 truncated 问题排查 - 愿星光伴你左右</title>
    <meta name="keywords" content="git,Git,Lua,lua,Golang,go">
    
    <meta property="og:title" content="gdb 提示 coredump 文件 truncated 问题排查">
    <meta property="og:site_name" content="愿星光伴你左右">
    <meta property="og:image" content="/img/author.jpg"> 
    <meta name="title" content="gdb 提示 coredump 文件 truncated 问题排查 - 愿星光伴你左右" />
    <meta name="description" content="愿星光伴你左右"> 
    <link rel="shortcut icon" href="http://shanks.link/img/favicon.ico" />
    <link rel="apple-touch-icon" href="http://shanks.link/img/apple-touch-icon.png" />
    <link rel="apple-touch-icon-precomposed" href="http://shanks.link/img/apple-touch-icon.png" />
    <link href="http://shanks.link/js/vendor/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />
    <link href="http://shanks.link/js/vendor/fancybox/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />
    <link href="http://shanks.link/css/main.css" rel="stylesheet" type="text/css" />
    <link href="http://shanks.link/css/syntax.css" rel="stylesheet" type="text/css" />
    <script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post"},
     fancybox: true, 
    motion: true
  };
</script>
</head>
<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">
<div class="container one-collumn sidebar-position-left page-home  ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"> <div class="site-meta  custom-logo ">

  <div class="custom-logo-site-title">
    <a href="http://shanks.link/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">愿星光伴你左右</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle"></p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
    <ul id="menu" class="menu">
      
      
        <li class="menu-item ">
          <a href="http://shanks.link/post/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />首页
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/thinking/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />随想录
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/prose/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />散文
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/%E7%94%9F%E6%B4%BB/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />生活
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/os/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />OS
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/lua/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />lua
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/redis/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />redis
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/go/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />Golang
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/c/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />C
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/openvpn/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />OpenVPN
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/web/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />web
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/openwrt/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />OpenWRT
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/%E8%BF%90%E7%BB%B4/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />运维
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/git/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />Git
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/it/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />IT杂谈
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/about/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />About Me
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/links/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />友情链接
          </a>
        </li>
      
      <li class="menu-item menu-item-search">
        <a href="javascript:;" class="popup-trigger"> <i class="menu-item-icon fa fa-search fa-fw"></i> <br /> 搜索</a>
      </li>
    </ul>
    <div class="site-search">
      <div class="popup">
 <span class="search-icon fa fa-search"></span>
 <input type="text" id="local-search-input">
 <div id="local-search-result"></div>
 <span class="popup-btn-close">close</span>
</div>

    </div>
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
<section id="posts" class="posts-expand">
  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <header class="post-header">
      <h1 class="post-title" itemprop="name headline">
        <a class="post-title-link" href="http://shanks.link/blog/2021/07/27/gdb-%E6%8F%90%E7%A4%BA-coredump-%E6%96%87%E4%BB%B6-truncated-%E9%97%AE%E9%A2%98%E6%8E%92%E6%9F%A5/" itemprop="url">
        gdb 提示 coredump 文件 truncated 问题排查
        </a>
      </h1>
      <div class="post-meta">
      <span class="post-time">
<span class="post-meta-item-icon">
    <i class="fa fa-calendar-o"></i>
</span>
<span class="post-meta-item-text">时间：</span>
<time itemprop="dateCreated" datetime="2016-03-22T13:04:35+08:00" content="2021-07-27">
    2021-07-27
</time>
</span> 
      

  <span class="post-category" >
  &nbsp; | &nbsp;
  <span class="post-meta-item-icon">
    <i class="fa fa-folder-o"></i>
  </span>
  <span class="post-meta-item-text">分类：</span>
  
    <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
      <a href="http://shanks.link/categories/go" itemprop="url" rel="index">
        <span itemprop="name">go</span>
      </a>
      &nbsp; 
    </span>
  
</span>


       <span>
&nbsp; | &nbsp;
<span class="post-meta-item-icon">
    <i class="fa fa-eye"></i>
</span>
<span class="post-meta-item-text">阅读：</span>
<span class="leancloud-visitors-count">5039 字 ~11分钟</span>
</span>
      </div>
    </header>
    <div class="post-body" itemprop="articleBody">
    <h1 id="gdb-提示-coredump-文件-truncated-问题排查">gdb 提示 coredump 文件 truncated 问题排查</h1>
<blockquote>
<p>本文选自“字节跳动基础架构实践”系列文章。</p>
<p>“字节跳动基础架构实践”系列文章是由字节跳动基础架构部门各技术团队及专家倾力打造的技术干货内容，和大家分享团队在基础架构发展和演进过程中的实践经验与教训，与各位技术同学一起交流成长。</p>
<p>coredump 我们日常开发中经常会遇到，能够帮助我们辅助定位问题，但如果 coredump 出现 truncate 会给排查问题带来不便。本文以线上问题为例，借助这个Case我们深入了解一下这类问题的排查思路，以及如何使用一些调试工具、阅读内核源代码，更清晰地了解coredump的处理过程。希望能为大家在排查这类问题的时候，提供一个清晰的脉络。</p>
</blockquote>
<h1 id="问题背景">问题背景</h1>
<p>在 c/cpp 类的程序开发中进程遇到 coredump，偶尔会遇到 coredump truncate 问题，影响 core 后的问题排查。coredump truncate 大部分是由于 core limits 和剩余磁盘空间引发的。这种比较好排查和解决。今天我们要分析的一种特殊的 case。</p>
<p>借助这个 Case 我们深入了解一下这类问题的排查思路，使用一些调试工具和阅读内核源代码能更清晰的了解 coredump 的处理过程。能够在排查这类问题的时候有个清晰的脉络。</p>
<p>业务同学反馈在容器内的服务出 core 后 gdb 调试报错。业务的服务运行在 K8S+Docker 的环境下，服务在容器内最终由 system 托管。在部分机器上的 coredump 文件在 gdb 的时候出现如下警告，导致排查问题受影响。报错信息如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>BFD: Warning: /tmp/coredump.1582242674.3907019.dp-b9870a84ea
</span></span><span style="display:flex;"><span>-867bccccdd-5hb7h is truncated: expected core file size &gt;= 
</span></span><span style="display:flex;"><span>89036038144, found: 31395205120.
</span></span></code></pre></div><p>导致的结果是 gdb 无法继续调试。我们登录机器后排查不是磁盘空间和 core ulimit 的问题。需要进一步排查。</p>
<h1 id="名词约定">名词约定</h1>
<p><strong>GDB</strong>：UNIX 及 UNIX-like 下的二进制调试工具。</p>
<p><strong>Coredump：</strong> 核心转储，是操作系统在进程收到某些信号而终止运行时，将此时进程地址空间的内容以及有关进程状态的其他信息写出的一个磁盘文件。这种信息往往用于调试。</p>
<p><strong>ELF：</strong> 可执行与可链接格式（Executable and Linkable Format），用于可执行文件、目标文件、共享库和核心转储的标准文件格式。x86 架构上的类 Unix 操作系统的二进制文件格式标准。</p>
<p><strong>BFD：</strong> 二进制文件描述库(Binary File Descriptor library)是 GNU 项目用于解决不同格式的目标文件的可移植性的主要机制。</p>
<p><strong>VMA：</strong> 虚拟内存区域（Virtual Memory Area），VMA 是用户进程里的一段 virtual address space 区块，内核使用 VMA 来跟踪进程的内存映射。</p>
<h1 id="排查过程">排查过程</h1>
<h2 id="用户态排查">用户态排查</h2>
<p>开始怀疑是自研的 coredump handler 程序有问题。于是还原系统原本的 coredump。<img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9tbWJpei5xcGljLmNuL21tYml6X3BuZy81RWN3WWhsbFFPak5hNThaQWpkZmNpYUY4aWEzejFnSEtLa1RhM0ZOR0s3Y0V4aWNnd2R0RWliNG1zZmc1ZWJJNXdSY3VGWW0zejd0a2ZBU3ROTTJPZW96RXcvNjQw?x-oss-process=image/format,png" alt="img"></p>
<p>手动触发一次 Coredump。结果问题依然存在。现在排除 coredump handler 的问题。说明问题可能发生在 kernel 层或 gdb 的问题。</p>
<p>需要确定是 gdb 问题还是 kernel 吐 core 的问题。先从 gdb 开始查起，下载 gdb 的源代码找到报错的位置（为了方便阅读，源代码的缩进进行了调整）。</p>
<p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9tbWJpei5xcGljLmNuL21tYml6X3BuZy81RWN3WWhsbFFPak5hNThaQWpkZmNpYUY4aWEzejFnSEtLUVRiUjVSMHVSV2liZUd5OE9sU0JEVFhUZzR3Ym1WWklIVU02aElnRUxNTFpYeDdpYmljeVVPTjd3LzY0MA?x-oss-process=image/format,png" alt="img"></p>
<p>目前看不是 gdb 的问题。coredump 文件写入不完整。coredump 的写入是由内核完成的。需要从内核侧排查。</p>
<p>在排查之前观察这个 coredump 的程序使用的内存使用非常大，几十 G 规模。怀疑是否和其过大有关，于是做一个实验。写一个 50G 内存的程序模拟，并对其 coredump。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#f00;font-style:italic">#include</span> <span style="color:#f00;font-style:italic">&lt;unistd.h&gt;</span><span style="color:#f00;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#f00;font-style:italic">#include</span> <span style="color:#f00;font-style:italic">&lt;stdlib.h&gt;</span><span style="color:#f00;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#f00;font-style:italic">#include</span> <span style="color:#f00;font-style:italic">&lt;string.h&gt;</span><span style="color:#f00;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#f00;font-style:italic"></span> 
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#00f">int</span> <span style="color:#c34e00">main</span>(<span style="color:#00f">void</span>){
</span></span><span style="display:flex;"><span>        <span style="color:#00f">for</span>( <span style="color:#00f">int</span> i=0; i&lt;1024; i++ ){
</span></span><span style="display:flex;"><span>                <span style="color:#00f">void</span>* test = malloc(1024*1024*50); <span style="color:#f00;font-style:italic">// 50MB
</span></span></span><span style="display:flex;"><span><span style="color:#f00;font-style:italic"></span>                memset(test, 0, 1);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        sleep(3600);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>经过测试正常吐 core。gdb 正常，暂时排除 core 大体积问题。</p>
<p>所以初步判断是 kernel 在吐的 core 文件自身的问题。需要在进一步跟进。</p>
<p>查看内核代码发现一处可疑点:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#f00;font-style:italic">/*
</span></span></span><span style="display:flex;"><span><span style="color:#f00;font-style:italic"> * Ensures that file size is big enough to contain the current file
</span></span></span><span style="display:flex;"><span><span style="color:#f00;font-style:italic"> * postion. This prevents gdb from complaining about a truncated file
</span></span></span><span style="display:flex;"><span><span style="color:#f00;font-style:italic"> * if the last &#34;write&#34; to the file was dump_skip.
</span></span></span><span style="display:flex;"><span><span style="color:#f00;font-style:italic"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#00f">void</span> <span style="color:#c34e00">dump_truncate</span>(<span style="color:#00f">struct</span> coredump_params *cprm)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#00f">struct</span> file *file = cprm-&gt;file;
</span></span><span style="display:flex;"><span>    loff_t offset;
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>    <span style="color:#00f">if</span> (file-&gt;f_op-&gt;llseek &amp;&amp; file-&gt;f_op-&gt;llseek != no_llseek) {
</span></span><span style="display:flex;"><span>        offset = file-&gt;f_op-&gt;llseek(file, 0, SEEK_CUR);
</span></span><span style="display:flex;"><span>        <span style="color:#00f">if</span> (i_size_read(file-&gt;f_mapping-&gt;host) &lt; offset)
</span></span><span style="display:flex;"><span>            do_truncate(file-&gt;f_path.dentry, offset, 0, file);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>这段代码的注释引起了我们的注意。</p>
<p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9tbWJpei5xcGljLmNuL21tYml6X3BuZy81RWN3WWhsbFFPak5hNThaQWpkZmNpYUY4aWEzejFnSEtLUHN4M002UWNVV2ZKWU8zU1dMSTJMY3VVSG0zaGRDcEZtZWlja05yZ2paRm5oOEZpYmliUUlzZlFBLzY0MA?x-oss-process=image/format,png" alt="img"></p>
<p>现在怀疑在出现这个 case 的时候没有执行到这个 dump_truncate 函数。于是尝试把 dump_truncate 移到第二个位置处。重新编译内核尝试。重新打了测试内核测试后问题依然存在。于是继续看代码。</p>
<p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9tbWJpei5xcGljLmNuL21tYml6X3BuZy81RWN3WWhsbFFPak5hNThaQWpkZmNpYUY4aWEzejFnSEtLU2h2aWEzNXZycWdabzg4Zm9FbThQaWNXUzk2dGdLbTNsOXpTcDU0Yk1MQWliREVjbDZqNGZ5OVh3LzY0MA?x-oss-process=image/format,png" alt="img"></p>
<p>这段代码引起了注意。怀疑某个时刻执行 get_dump_page 的时候返回了 NULL。然后走到了 dump_skip 函数，dump_skip 返回 0，导致 goto end_coredump。于是 stap 抓下。</p>
<p>不出所料，dump_skip 返回 0 后 coredump 停止。也就是说第二阶段只 dump 了一部分 vma 就停止了。导致 coredump 写入不完整。</p>
<h1 id="vma-部分-dump-分析">VMA 部分 dump 分析</h1>
<p>再看下 dump_skip 函数。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#00f">int</span> <span style="color:#c34e00">dump_skip</span>(<span style="color:#00f">struct</span> coredump_params *cprm, size_t nr)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#00f">static</span> <span style="color:#00f">char</span> zeroes[PAGE_SIZE];
</span></span><span style="display:flex;"><span>    <span style="color:#00f">struct</span> file *file = cprm-&gt;file;
</span></span><span style="display:flex;"><span>    <span style="color:#00f">if</span> (file-&gt;f_op-&gt;llseek &amp;&amp; file-&gt;f_op-&gt;llseek != no_llseek) {
</span></span><span style="display:flex;"><span>        <span style="color:#00f">if</span> (dump_interrupted() ||
</span></span><span style="display:flex;"><span>            file-&gt;f_op-&gt;llseek(file, nr, SEEK_CUR) &lt; 0)
</span></span><span style="display:flex;"><span>            <span style="color:#00f">return</span> 0;
</span></span><span style="display:flex;"><span>        cprm-&gt;pos += nr;
</span></span><span style="display:flex;"><span>        <span style="color:#00f">return</span> 1;
</span></span><span style="display:flex;"><span>    } <span style="color:#00f">else</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#00f">while</span> (nr &gt; PAGE_SIZE) {
</span></span><span style="display:flex;"><span>            <span style="color:#00f">if</span> (!dump_emit(cprm, zeroes, PAGE_SIZE))
</span></span><span style="display:flex;"><span>                <span style="color:#00f">return</span> 0;
</span></span><span style="display:flex;"><span>            nr -= PAGE_SIZE;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#00f">return</span> dump_emit(cprm, zeroes, nr);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>因为 coredump 是 pipe 的，所以是没有 llseek 操作的，因此会走到 else 分支里。也就是 dump_emit 返回 0 导致的。于是 stap 抓下 dump_emit 函数 。</p>
<p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9tbWJpei5xcGljLmNuL21tYml6X3BuZy81RWN3WWhsbFFPak5hNThaQWpkZmNpYUY4aWEzejFnSEtLSDRpY0NHSHZ0THV0Y0p4RVBOMXVhSUxsRmVpY283N1V6WjRBV2N4WWJBZnhISGliWllmSE9ZVDRRLzY0MA?x-oss-process=image/format,png" alt="img"></p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>function func:string(task:<span style="color:#00f">long</span>)
</span></span><span style="display:flex;"><span>%{
</span></span><span style="display:flex;"><span>    snprintf(STAP_RETVALUE, MAXSTRINGLEN, <span style="color:#009c00">&#34;%s&#34;</span>, signal_pending(current) ? <span style="color:#009c00">&#34;true&#34;</span> : <span style="color:#009c00">&#34;false&#34;</span>);
</span></span><span style="display:flex;"><span>%}
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>probe kernel.function(<span style="color:#009c00">&#34;dump_emit&#34;</span>).<span style="color:#00f">return</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    printf(<span style="color:#009c00">&#34;return: %d, cprm-&gt;limit:%d, cprm-&gt;written: %d, signal: %s</span><span style="color:#009c00">\n</span><span style="color:#009c00">&#34;</span>, $<span style="color:#00f">return</span>, @entry($cprm-&gt;limit), @entry($cprm-&gt;written), func($<span style="color:#00f">return</span>));
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>结果如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#00f">return</span>: 1, cprm-&gt;limit:-1, cprm-&gt;written: 0, signal: false
</span></span><span style="display:flex;"><span><span style="color:#00f">return</span>: 1, cprm-&gt;limit:-1, cprm-&gt;written: 64, signal: false
</span></span><span style="display:flex;"><span><span style="color:#00f">return</span>: 1, cprm-&gt;limit:-1, cprm-&gt;written: 120, signal: false
</span></span><span style="display:flex;"><span>... 省略9221238行 ...
</span></span><span style="display:flex;"><span><span style="color:#00f">return</span>: 1, cprm-&gt;limit:-1, cprm-&gt;written: 37623402496, signal: false
</span></span><span style="display:flex;"><span><span style="color:#00f">return</span>: 1, cprm-&gt;limit:-1, cprm-&gt;written: 37623406592, signal: false
</span></span><span style="display:flex;"><span><span style="color:#00f">return</span>: 1, cprm-&gt;limit:-1, cprm-&gt;written: 37623410688, signal: false
</span></span><span style="display:flex;"><span><span style="color:#00f">return</span>: 0, cprm-&gt;limit:-1, cprm-&gt;written: 37623414784, signal: true
</span></span></code></pre></div><p>不出意外和怀疑的一致，dump_emit 返回 0 了，此时写入到 core 文件的有 37623414784 字节。主要因为 dump_interrupted 检测条件为真。(cprm-&gt;limit = -1 不会进入 if 逻辑，kernrel_wirte 写 pipe 也没有出错)。</p>
<p>下面我们看 dump_interrupted 函数。为了方便阅读，整理出相关的函数。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>static bool dump_interrupted(void){
</span></span><span style="display:flex;"><span>    /*
</span></span><span style="display:flex;"><span>     * SIGKILL or freezing() interrupt the coredumping. Perhaps we
</span></span><span style="display:flex;"><span>     * can do try_to_freeze() and check __fatal_signal_pending(),
</span></span><span style="display:flex;"><span>     * but then we need to teach dump_write() to restart and clear
</span></span><span style="display:flex;"><span>     * TIF_SIGPENDING.
</span></span><span style="display:flex;"><span>     */
</span></span><span style="display:flex;"><span>    return signal_pending(current);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>static inline int signal_pending(struct task_struct *p){
</span></span><span style="display:flex;"><span>    return unlikely(test_tsk_thread_flag(p,TIF_SIGPENDING));
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>static inline int test_tsk_thread_flag(struct task_struct *tsk, int flag){
</span></span><span style="display:flex;"><span>    return test_ti_thread_flag(task_thread_info(tsk), flag);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>static inline int test_ti_thread_flag(struct thread_info *ti, int flag){
</span></span><span style="display:flex;"><span>    return test_bit(flag, (unsigned long *)&amp;ti-&gt;flags);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>/**
</span></span><span style="display:flex;"><span> * test_bit - Determine whether a bit is set
</span></span><span style="display:flex;"><span> * @nr: bit number to test
</span></span><span style="display:flex;"><span> * @addr: Address to start counting from
</span></span><span style="display:flex;"><span> */
</span></span><span style="display:flex;"><span>static inline int test_bit(int nr, const volatile unsigned long *addr){
</span></span><span style="display:flex;"><span>    return 1UL &amp; (addr[BIT_WORD(nr)] &gt;&gt; (nr &amp; (BITS_PER_LONG-1)));
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>相关的宏：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>#ifdef CONFIG_64BIT#define BITS_PER_LONG 64#<span style="color:#00f">else</span>#define BITS_PER_LONG 32#endif <span style="color:#f00;font-style:italic">/* CONFIG_64BIT */</span>#define TIF_SIGPENDING      2   <span style="color:#f00;font-style:italic">/* signal pending */</span> 平台相关。以X64架构为例。
</span></span></code></pre></div><p>有上面的代码就很清楚 dump_interrupted 函数就是检测 task 的 thread_info-&gt;flags 是否 TIF_SIGPENDING 置位。</p>
<p>目前怀疑还是和用户的内存 vma 有关。但什么场景会触发 TIF_SIGPENDING 置位是个问题。dump_interrupted 函数的注释中已经说明了，一个是接收到了 KILL 信号，一个是 freezing()。freezing()一般和 cgroup 有关，一般是 docker 在使用。KILL 有可能是 systemd 发出的。于是做了 2 个实验：</p>
<h4 id="实验一">实验一：</h4>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>systemd启动实例，bash裸起服务，不接流量。
</span></span><span style="display:flex;"><span>测试结果gdb正常...
</span></span><span style="display:flex;"><span>然后再用systemd起来，不接流量。测试结果也是正常的。
</span></span><span style="display:flex;"><span>这就奇怪了。但是不能排除systemd。
</span></span><span style="display:flex;"><span>回想接流量和不接流量的区别是coredump的压缩后的体积大小不同，不接流
</span></span><span style="display:flex;"><span>量vma大都是空，空洞比较多，因此coredump非常快，有流量vma不是空
</span></span><span style="display:flex;"><span>的，coredump比较慢。因此怀疑和coredump时间有关系，超过某个时间就
</span></span><span style="display:flex;"><span>有TIF_SIGPENDING被置位。
</span></span></code></pre></div><h4 id="实验二">实验二：</h4>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>是产生一个50G的内存。代码如最上方。
</span></span><span style="display:flex;"><span>在容器内依然使用systemd启动一个测试程序
</span></span><span style="display:flex;"><span>（直接在问题容器内替换这个bin。然后systemctl重启服务）
</span></span><span style="display:flex;"><span>然后发送SEGV信号。stap抓一下。
</span></span><span style="display:flex;"><span>coredump很漫长。等待结果
</span></span><span style="display:flex;"><span>结果很意外。core正常，gdb也正常。
</span></span></code></pre></div><p>这个 TIF_SIGPENDING 信号源是个问题。</p>
<p>还有个排查方向就是 get_dump_page 为啥会返回 NULL。所以现在有 2 个排查方向：</p>
<ol>
<li>需要确定 TIF_SIGPENDING 信号源。</li>
<li>get_dump_page 返回 NULL 的原因。</li>
</ol>
<h1 id="get_dump_page-返回-null-分析">get_dump_page 返回 NULL 分析</h1>
<p>首先看 get_dump_page 这个返回 NULL 的 case：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>* Returns NULL on any kind of failure - a hole must then be inserted into
</span></span><span style="display:flex;"><span> * the corefile, to preserve alignment with its headers; and also returns
</span></span><span style="display:flex;"><span> * NULL wherever the ZERO_PAGE, or an anonymous pte_none, has been found -
</span></span><span style="display:flex;"><span> * allowing a hole to be left in the corefile to save diskspace.
</span></span></code></pre></div><p>看注释返回 NULL，一个是 page 是 ZERO_PAGE，一个是 pte_none 问题。</p>
<p>首先看 ZREO 问题，于是构造一个 ZERO_PAGE 的程序来测试：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>#include &lt;stdio.h&gt;
</span></span><span style="display:flex;"><span>#include &lt;unistd.h&gt;
</span></span><span style="display:flex;"><span>#include &lt;sys/mman.h&gt;
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>const int BUFFER_SIZE = 4096 * 1000;
</span></span><span style="display:flex;"><span>int main(void){
</span></span><span style="display:flex;"><span>    int i = 0;
</span></span><span style="display:flex;"><span>    unsigned char* buffer;
</span></span><span style="display:flex;"><span>    for( int n=0; n&lt;10240; n++ ){
</span></span><span style="display:flex;"><span>        buffer = mmap(NULL, BUFFER_SIZE, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS, -1, 0);
</span></span><span style="display:flex;"><span>        for (i = 0; i &lt; BUFFER_SIZE - 3 * 4096; i += 4096){
</span></span><span style="display:flex;"><span>            buffer[i] = 0;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    // zero page
</span></span><span style="display:flex;"><span>    for (i=0; i &lt; BUFFER_SIZE - 4096; i += 4096) {
</span></span><span style="display:flex;"><span>        char dirty = buffer[i];
</span></span><span style="display:flex;"><span>        printf(&#34;%c&#34;, dirty);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    printf(&#34;ok...\n&#34;);
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>    sleep(3600);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>测试结果是 coredump 正常，同时 trace 一下 get_dump_page 的返回值。结果和预想的有些不同，返回了很多个 NULL。说明和 get_dump_page 函数的因素不大。</p>
<p>于是转向到 TIF_SIGPENDING 信号发生源。</p>
<h1 id="tif_sigpending-信号来源分析">TIF_SIGPENDING 信号来源分析</h1>
<p>bpftrace 抓一下看看：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#f00;font-style:italic">#!/usr/bin/env bpftrace
</span></span></span><span style="display:flex;"><span><span style="color:#f00;font-style:italic">#include</span> <span style="color:#f00;font-style:italic">&lt;linux/sched.h&gt;</span><span style="color:#f00;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#f00;font-style:italic"></span> 
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>kprobe:__send_signal
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>        $t = (<span style="color:#00f">struct</span> task_struct *)arg2;
</span></span><span style="display:flex;"><span>        <span style="color:#00f">if</span> ($t-&gt;pid == $1) {
</span></span><span style="display:flex;"><span>                printf(<span style="color:#009c00">&#34;comm:%s(pid: %d) send sig: %d to %s</span><span style="color:#009c00">\n</span><span style="color:#009c00">&#34;</span>, comm, pid, arg0, $t-&gt;comm);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>结果如下：</p>
<p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9tbWJpei5xcGljLmNuL21tYml6X3BuZy81RWN3WWhsbFFPak5hNThaQWpkZmNpYUY4aWEzejFnSEtLc0xwOUlGUlVPRUxid2R2R0NyemI4eGJpYUd2M2RNeHBrOFFWQVd5bjY1TWZraWFxVXZOOXh5VVEvNjQw?x-oss-process=image/format,png" alt="img"></p>
<p>结果比较有趣。kill 和 systemd 打断了 coredump 进程。信号 2(SIGINT)和信号 9(SIGKILL)都足以打断进程。现在问题变为 kill 和 systemd 为什么会发送这 2 个信号。一个怀疑是超时。coredump 进程为 not running 太久会不会触发 systemd 什么机制呢。</p>
<p>于是查看了 systemd service 的 doc 发现这样一段话：</p>
<blockquote>
<p>TimeoutAbortSec=
This option configures the time to wait for the service to terminate when it was aborted due to a watchdog timeout (see WatchdogSec=). If the service has a short TimeoutStopSec= this option can be used to give the system more time to write a core dump of the service. Upon expiration the service will be forcibly terminated by SIGKILL (see KillMode= in systemd.kill(5)). The core file will be truncated in this case. Use TimeoutAbortSec= to set a sensible timeout for the core dumping per service that is large enough to write all expected data while also being short enough to handle the service failure in due time.</p>
<p>Takes a unit-less value in seconds, or a time span value such as &ldquo;5min 20s&rdquo;. Pass an empty value to skip the dedicated watchdog abort timeout handling and fall back TimeoutStopSec=. Pass &ldquo;infinity&rdquo; to disable the timeout logic. Defaults to DefaultTimeoutAbortSec= from the manager configuration file (see systemd-system.conf(5)).</p>
<p>If a service of Type=notify handles SIGABRT itself (instead of relying on the kernel to write a core dump) it can send &ldquo;EXTEND_TIMEOUT_USEC=…&rdquo; to extended the abort time beyond TimeoutAbortSec=. The first receipt of this message must occur before TimeoutAbortSec= is exceeded, and once the abort time has exended beyond TimeoutAbortSec=, the service manager will allow the service to continue to abort, provided the service repeats &ldquo;EXTEND_TIMEOUT_USEC=…&rdquo; within the interval specified, or terminates itself (see sd_notify(3)).</p>
</blockquote>
<p>标红的字引起了注意，于是调大一下(TimeoutAbortSec=&ldquo;10min&rdquo;) 再试。无效&hellip;</p>
<p>无效后就很奇怪，难道 system 都不是信号的发起者，是信号的&quot;传递者&quot;? 现在有 2 个怀疑，一个是 systemd 是信号的发起者，一个是 systemd 不是信号的发起者，是信号的“传递者”。于是这次同时抓业务进程和 systemd 进程看看。结果如下：</p>
<p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9tbWJpei5xcGljLmNuL21tYml6X3BuZy81RWN3WWhsbFFPaWFNUlNSaWFCM1lVNTB1aGxGQTlTbExNc01iTTFGcGtCallqVUowMlpRU01PeVpQdk1QeUJoUmhLT0g5VzVCcmtBdTkzdmV1NlZJbTJnLzY0MA?x-oss-process=image/format,png" alt="img"></p>
<p>其中 3533840 是容器的 init 进程 systemd。3533916 是业务进程。和预想的一样，systemd 并不是信号的第一个发起者。systemd 是接收到 runc 的信号 15（SIGTERM）而停止的，停止前会对子进程发起 kill 行为。也就是最后的 systemd send sig。</p>
<p>有个疑问就来了，之前用程序 1 测试了 system+docker 的场景，没有复现，回想一下 coredump 的过程应该是这样的，程序 1 没有对每个 page 都写，只写了一个 malloc 之后的第一个 page 的第一个一个字节。coredump 在遍历每个 vma 的时候耗时要比都写了 page 要快很多（因为没有那么多空洞，VMA 不会那么零碎）。coredump 体积虽然大，但时间短，因此没有触发这个问题，对于排查这个问题带来一定的曲折。</p>
<p>于是排查方向转到 kill 命令和 runc 经过排查发现 K8S 的一个 lifecycle 中的 prestop 脚本有 kill 行为。把这个脚本停到后再次抓一下：</p>
<p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9tbWJpei5xcGljLmNuL21tYml6X3BuZy81RWN3WWhsbFFPak5hNThaQWpkZmNpYUY4aWEzejFnSEtLbmljTkJNZnd2SlB5d2dCV1pRUlJVajdpYm50YWRtYnlKa1FMR3Byck9KYjJWMWVpY082S1ZMMmlhUS82NDA?x-oss-process=image/format,png" alt="img"></p>
<p>这次没有 kill 行为，但是 systemd 还是被 runc 杀死了，发送了 2 个信号，一个是 SIGTERM，一个是 SIGKILL 现在解释通了 kill 信号的来源，这也就解释了 kill 的信号来源。其实 kill 和 systemd 的信号根源间接或直接都是 runc。runc 的销毁指令来自 k8s。</p>
<p>于是根据 K8S 的日志继续排查。经过排查发现最终的触发逻辑是来自字节内部实现的 Load 驱逐。该机制当容器的 Load 过高时则会把这个实例驱逐掉，避免影响其他实例。因为 coredump 的时候 CPU 会长期陷入到内核态，导致 load 升高。所以 I 引发了 Pod 驱逐。</p>
<p>coredump 期间实例的负载很高，导致 k8s 的组件 kubelet 的触发了 load 高驱逐实例的行为。删除 pod。停止 systemd。杀死正在 coredump 的进程，最终导致 coredump 第二阶段写 vma 数据未完成。</p>
<h2 id="验证问题">验证问题</h2>
<p>在做一个简单的验证，停止 K8S 组件 kubelet，然后对服务发起 core。最后 gdb。验证正常，gdb 正常读取数据。至此这个问题就排查完毕了。最后修改内部实现 cgroup 级的 Load（和整机 load 近似的采集数据的方案）采集功能，过滤 D 状态的进程（coredump 进程在用户态表现为 D 状态）后，这个问题彻底解决。</p>
<h1 id="总结">总结</h1>
<p>本次 coredump 文件 truncate 是因为 coredump 的进程被杀死（SIGKILL 信号）导致 VMA 没有写入完全（只写入了一部分）导致，。解决这个问题通过阅读内核源代码加以使用 bpftrace、systemtap 工具追踪 coredump 的过程。打印出关心的数据，借助源代码最终分析出问题的原因。同时我们对内核的 coredump 过程有了一定的了解。</p>
<p>最后，欢迎加入字节跳动基础架构团队，一起探讨、解决问题，一起变强！</p>
<p><strong>附：coredump 文件简单分析</strong></p>
<p>在排查这个问题期间也阅读了内核处理 coredump 的相关源代码，简单总结一下:</p>
<p>coredump 文件其实是一个精简版的 ELF 文件。coredump 过程并不复杂。coredump 的过程分为 2 个阶段，一个阶段是写 program header（第一个 program header 是 Note Program Header）,每个 program header 包含了 VMA 的大小和在文件的偏移量。gdb 也是依此来确定每个 VMA 的位置的。另一个阶段是写 vma 的数据，遍历进程的所有 vma。然后写入文件。一个 coredump 文件的结构可以简单的用如下图的结构表示。</p>
<p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9tbWJpei5xcGljLmNuL21tYml6X3BuZy81RWN3WWhsbFFPak5hNThaQWpkZmNpYUY4aWEzejFnSEtLcTRsbXQydmxhRTdxa0FrSUwwVHZkUUZNa2p6ZWxUSWNEaWFYUkJudGlhU3dacmRTU0xtdlN5aWNRLzY0MA?x-oss-process=image/format,png" alt="img"></p>
<h1 id="参考文献">参考文献</h1>
<ol>
<li>Binary_File_Descriptor_library (<a href="https://en.wikipedia.org/wiki/Binary_File_Descriptor_library">https://en.wikipedia.org/wiki/Binary_File_Descriptor_library</a>)</li>
<li>systemd.service — Service unit configuration (<a href="https://www.freedesktop.org/software/systemd/man/systemd.service.html">https://www.freedesktop.org/software/systemd/man/systemd.service.html</a>)</li>
<li>Kubernets Pod Lifecycle (<a href="https://kubernetes.io/docs/concepts/workloads/pods/pod-lifecycle/">https://kubernetes.io/docs/concepts/workloads/pods/pod-lifecycle/</a>)</li>
</ol>
<h1 id="更多分享">更多分享</h1>
<p><a href="http://mp.weixin.qq.com/s?__biz=MzI1MzYzMjE0MQ%3D%3D&amp;chksm=e9d0c395dea74a8349d806c8c5c0cc9dc9b1220adc7531c4a2db6d3a99f2358ad0bbda49c62b&amp;idx=1&amp;mid=2247485559&amp;scene=21&amp;sn=def1a04c3aee1321a238392278476974#wechat_redirect">字节跳动在 RocksDB 存储引擎上的改进实践</a></p>
<p><a href="http://mp.weixin.qq.com/s?__biz=MzI1MzYzMjE0MQ%3D%3D&amp;chksm=e9d0c385dea74a937e8200e98eecdfab608081e5e5e23232a905383d0d58d19625ae0717e453&amp;idx=1&amp;mid=2247485543&amp;scene=21&amp;sn=caf885f6d76659e7ad8ef5b006ce31f6#wechat_redirect">深入理解 Linux 内核&ndash;jemalloc 引起的 TLB shootdown 及优化</a></p>
<p><a href="http://mp.weixin.qq.com/s?__biz=MzI1MzYzMjE0MQ%3D%3D&amp;chksm=e9d0c3a2dea74ab4c3451e20e62e1cb05251b058ae9a81c6b0ca9f94a6874f7da451c6066607&amp;idx=1&amp;mid=2247485504&amp;scene=21&amp;sn=1768d4561b3d787bf6175d124e1a200d#wechat_redirect">字节跳动自研万亿级图数据库 &amp; 图计算实践</a></p>
<hr>
<h1 id="字节跳动基础架构团队">字节跳动基础架构团队</h1>
<p>字节跳动基础架构团队是支撑字节跳动旗下包括抖音、今日头条、西瓜视频、火山小视频在内的多款亿级规模用户产品平稳运行的重要团队，为字节跳动及旗下业务的快速稳定发展提供了保证和推动力。</p>
<p>公司内，基础架构团队主要负责字节跳动私有云建设，管理数以万计服务器规模的集群，负责数万台计算/存储混合部署和在线/离线混合部署，支持若干 EB 海量数据的稳定存储。</p>
<p>文化上，团队积极拥抱开源和创新的软硬件架构。我们长期招聘基础架构方向的同学，具体可参见  job.bytedance.com （文末“阅读原文”），感兴趣可以联系邮箱 <a href="mailto:guoxinyu.0372@bytedance.com">guoxinyu.0372@bytedance.com</a> 。</p>
<p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9tbWJpei5xcGljLmNuL21tYml6X3BuZy81RWN3WWhsbFFPak5hNThaQWpkZmNpYUY4aWEzejFnSEtLd3U4OVJwSGliYjJGamNNUXdkdUFMbVVqbzkxUkVvSUxTNVJXaWFScjlxNjZCeXpadkdmOXI1Y1EvNjQw?x-oss-process=image/format,png" alt="img"></p>

    </div>
    <footer class="post-footer">
     
 
<div class="post-tags">     
     
    <a href="http://shanks.link/tags/go" rel="tag" title="go">#go#</a>
    
</div>



     <div class="post-nav">
    <div class="post-nav-next post-nav-item">
    
        <a href="http://shanks.link/blog/2021/07/28/%E8%A6%81%E4%B8%8D%E6%96%AD%E7%9A%84%E6%8F%90%E9%AB%98%E6%80%9D%E7%BB%B4%E7%9A%84%E5%B1%82%E6%AC%A1/" rel="next" title="要不断的提高思维的层次">
        <i class="fa fa-chevron-left"></i> 要不断的提高思维的层次
        </a>
    
    </div>

    <div class="post-nav-prev post-nav-item">
    
        <a href="http://shanks.link/blog/2021/07/27/go%E7%9A%84%E4%B8%80%E6%AC%A1%E6%95%85%E9%9A%9C%E6%8E%92%E9%99%A4/" rel="prev" title="go的一次故障排除">
        go的一次故障排除 <i class="fa fa-chevron-right"></i>
        </a>
    
    </div>
</div>
      
     
     
     





<script src="https://utteranc.es/client.js"
        repo="shankusu2017@gmail.com/"
        issue-term="pathname"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>
<noscript>Please enable JavaScript to view the <a href="https://github.com/utterance">comments powered by utterances.</a></noscript>

    </footer>
  </article>
</section>

          </div>
        </div>
        <div class="sidebar-toggle">
  <div class="sidebar-toggle-line-wrap">
    <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
    <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
    <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
  </div>
</div>
<aside id="sidebar" class="sidebar">
  <div class="sidebar-inner">

    <section class="site-overview sidebar-panel  sidebar-panel-active ">
      <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image"
        src="http://shanks.link/img/logo.jpg"
        alt="shankusu2017@gmail.com" />
    <p class="site-author-name" itemprop="name">shankusu2017@gmail.com</p>
    <p class="site-description motion-element" itemprop="description"> </p>
</div>
      <nav class="site-state motion-element">
    <div class="site-state-item site-state-posts">
      <a href="http://shanks.link/post/">
        <span class="site-state-item-count">515</span>
        <span class="site-state-item-name">日志</span>
      </a>
    </div>
    <div class="site-state-item site-state-categories">    
        <a href="http://shanks.link/categories/">      
         
        <span class="site-state-item-count">32</span>
        
        <span class="site-state-item-name">分类</span>
        
        </a>
    </div>

    <div class="site-state-item site-state-tags">
        <a href="http://shanks.link/tags/">
         
        <span class="site-state-item-count">37</span>
        
        <span class="site-state-item-name">标签</span>
        </a>
    </div>
</nav>
      
      
<div class="links-of-author motion-element">
    
        <span class="links-of-author-item">
        <a href="https://github.com/shankusu2017" target="_blank" title="GitHub">
            <i class="fa fa-fw fa-github"></i>
            GitHub
        </a>
        </span>
    
</div>


      

      <div class="links-of-blogroll motion-element inline">
<script type="text/javascript" src="//rf.revolvermaps.com/0/0/8.js?i=5b4f2ucxar6&amp;m=0&amp;s=220&amp;c=ff0000&amp;cr1=ffffff&amp;f=arial&amp;l=33&amp;bv=35" async="async"></script>
</div>

    </section>
    
  </div>
</aside>

      </div>
    </main>
   
    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  <span itemprop="copyrightYear">  &copy; 
  2009 - 2022</span>
  <span class="with-love"><i class="fa fa-heart"></i></span>
  <span class="author" itemprop="copyrightHolder">愿星光伴你左右</span>
</div>
<div class="powered-by">
  Powered by - <a class="theme-link" href="http://gohugo.io" target="_blank" title="hugo" >Hugo v0.101.0</a>
</div>
<div class="theme-info">
  Theme by - <a class="theme-link" href="https://github.com/xtfly/hugo-theme-next" target="_blank"> NexT
  </a>
</div>


      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
      <span id="scrollpercent"><span>0</span>%</span>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>
<script type="text/javascript" src="http://shanks.link/js/vendor/jquery/index.js?v=2.1.3"></script>
<script type="text/javascript" src="http://shanks.link/js/vendor/fastclick/lib/fastclick.min.js?v=1.0.6"></script> 
<script type="text/javascript" src="http://shanks.link/js/vendor/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
<script type="text/javascript" src="http://shanks.link/js/vendor/velocity/velocity.min.js?v=1.2.1"></script>
<script type="text/javascript" src="http://shanks.link/js/vendor/velocity/velocity.ui.min.js?v=1.2.1"></script>
<script src="http://shanks.link/js/vendor/ua-parser-js/dist/ua-parser.min.js?v=0.7.9"></script>

<script src="http://shanks.link/js/vendor/fancybox/jquery.fancybox.pack.js?v=2.1.5"></script>

<script type="text/javascript" src="http://shanks.link/js/utils.js"></script>
<script type="text/javascript" src="http://shanks.link/js/motion.js"></script>
<script type="text/javascript" src="http://shanks.link/js/affix.js"></script>
<script type="text/javascript" src="http://shanks.link/js/schemes/pisces.js"></script>

<script type="text/javascript" src="http://shanks.link/js/scrollspy.js"></script>
<script type="text/javascript" src="http://shanks.link/js/post-details.js"></script>
<script type="text/javascript" src="http://shanks.link/js/toc.js"></script>

<script type="text/javascript" src="http://shanks.link/js/bootstrap.js"></script>

<script type="text/javascript" src="http://shanks.link/js/search.js"></script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX", "output/HTML-CSS"],
    tex2jax: {
      inlineMath: [ ['$','$'] ],
      displayMath: [ ['$$','$$'] ],
      processEscapes: true
    },
    "HTML-CSS": { fonts: ["TeX"] }
  });
</script>
<script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML' async></script>
</body>
</html>