<!DOCTYPE HTML>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" /> 
    <title>lua源码注释-lvm.c - 愿星光伴你左右</title>
    <meta name="keywords" content="git,Git,Lua,lua,Golang,go">
    
    <meta property="og:title" content="lua源码注释-lvm.c">
    <meta property="og:site_name" content="愿星光伴你左右">
    <meta property="og:image" content="/img/author.jpg"> 
    <meta name="title" content="lua源码注释-lvm.c - 愿星光伴你左右" />
    <meta name="description" content="愿星光伴你左右"> 
    <link rel="shortcut icon" href="http://shanks.link/img/favicon.ico" />
    <link rel="apple-touch-icon" href="http://shanks.link/img/apple-touch-icon.png" />
    <link rel="apple-touch-icon-precomposed" href="http://shanks.link/img/apple-touch-icon.png" />
    <link href="http://shanks.link/js/vendor/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />
    <link href="http://shanks.link/js/vendor/fancybox/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />
    <link href="http://shanks.link/css/main.css" rel="stylesheet" type="text/css" />
    <link href="http://shanks.link/css/syntax.css" rel="stylesheet" type="text/css" />
    <script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post"},
     fancybox: true, 
    motion: true
  };
</script>
</head>
<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">
<div class="container one-collumn sidebar-position-left page-home  ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"> <div class="site-meta  custom-logo ">

  <div class="custom-logo-site-title">
    <a href="http://shanks.link/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">愿星光伴你左右</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle"></p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
    <ul id="menu" class="menu">
      
      
        <li class="menu-item ">
          <a href="http://shanks.link/post/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />首页
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/thinking/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />随想录
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/prose/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />散文
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/%E7%94%9F%E6%B4%BB/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />生活
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/os/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />OS
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/lua/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />lua
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/redis/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />redis
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/go/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />Golang
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/openvpn/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />OpenVPN
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/%E8%BF%90%E7%BB%B4/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />运维
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/git/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />Git
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/it/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />IT杂谈
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/about/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />About Me
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/links/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />友情链接
          </a>
        </li>
      
      <li class="menu-item menu-item-search">
        <a href="javascript:;" class="popup-trigger"> <i class="menu-item-icon fa fa-search fa-fw"></i> <br /> 搜索</a>
      </li>
    </ul>
    <div class="site-search">
      <div class="popup">
 <span class="search-icon fa fa-search"></span>
 <input type="text" id="local-search-input">
 <div id="local-search-result"></div>
 <span class="popup-btn-close">close</span>
</div>

    </div>
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
<section id="posts" class="posts-expand">
  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <header class="post-header">
      <h1 class="post-title" itemprop="name headline">
        <a class="post-title-link" href="http://shanks.link/blog/2021/05/23/lua%E6%BA%90%E7%A0%81%E6%B3%A8%E9%87%8A-lvm.c/" itemprop="url">
        lua源码注释-lvm.c
        </a>
      </h1>
      <div class="post-meta">
      <span class="post-time">
<span class="post-meta-item-icon">
    <i class="fa fa-calendar-o"></i>
</span>
<span class="post-meta-item-text">时间：</span>
<time itemprop="dateCreated" datetime="2016-03-22T13:04:35+08:00" content="2021-05-23">
    2021-05-23
</time>
</span> 
      

  <span class="post-category" >
  &nbsp; | &nbsp;
  <span class="post-meta-item-icon">
    <i class="fa fa-folder-o"></i>
  </span>
  <span class="post-meta-item-text">分类：</span>
  
    <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
      <a href="http://shanks.link/categories/lua" itemprop="url" rel="index">
        <span itemprop="name">lua</span>
      </a>
      &nbsp; 
    </span>
  
</span>


       <span>
&nbsp; | &nbsp;
<span class="post-meta-item-icon">
    <i class="fa fa-eye"></i>
</span>
<span class="post-meta-item-text">阅读：</span>
<span class="leancloud-visitors-count">6104 字 ~13分钟</span>
</span>
      </div>
    </header>
    <div class="post-body" itemprop="articleBody">
    <p><a href="https://github.com/shankusu2017/lua">github链接</a> lua515子域</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">/*
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">** $Id: lvm.c,v 2.63.1.5 2011/08/17 20:43:11 roberto Exp $
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">** Lua virtual machine
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">** See Copyright Notice in lua.h
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">*/</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdio.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdlib.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;string.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#define lvm_c
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define LUA_CORE
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&#34;lua.h&#34;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&#34;ldebug.h&#34;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&#34;ldo.h&#34;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&#34;lfunc.h&#34;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&#34;lgc.h&#34;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&#34;lobject.h&#34;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&#34;lopcodes.h&#34;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&#34;lstate.h&#34;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&#34;lstring.h&#34;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&#34;ltable.h&#34;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&#34;ltm.h&#34;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&#34;lvm.h&#34;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/* limit for table tag-method chains (to avoid loops) */</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#define MAXTAGLOOP	100
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/* number,string--&gt;number */</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">const</span> TValue <span style="color:#f92672">*</span><span style="color:#a6e22e">luaV_tonumber</span> (<span style="color:#66d9ef">const</span> TValue <span style="color:#f92672">*</span>obj, TValue <span style="color:#f92672">*</span>n) {
</span></span><span style="display:flex;"><span>  lua_Number num;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (ttisnumber(obj)) <span style="color:#66d9ef">return</span> obj;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (ttisstring(obj) <span style="color:#f92672">&amp;&amp;</span> luaO_str2d(svalue(obj), <span style="color:#f92672">&amp;</span>num)) {
</span></span><span style="display:flex;"><span>    setnvalue(n, num);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> n;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> NULL;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/* number-&gt;string */</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">luaV_tostring</span> (lua_State <span style="color:#f92672">*</span>L, StkId obj) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>ttisnumber(obj))
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">char</span> s[LUAI_MAXNUMBER2STR];
</span></span><span style="display:flex;"><span>    lua_Number n <span style="color:#f92672">=</span> nvalue(obj);
</span></span><span style="display:flex;"><span>    lua_number2str(s, n);
</span></span><span style="display:flex;"><span>    setsvalue2s(L, obj, luaS_new(L, s));
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/* 判断调试MASK是否设置，以及相关条件是否已满足，满足则进入钩子函数 */</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">traceexec</span> (lua_State <span style="color:#f92672">*</span>L, <span style="color:#66d9ef">const</span> Instruction <span style="color:#f92672">*</span>pc) {
</span></span><span style="display:flex;"><span>  lu_byte mask <span style="color:#f92672">=</span> L<span style="color:#f92672">-&gt;</span>hookmask;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> Instruction <span style="color:#f92672">*</span>oldpc <span style="color:#f92672">=</span> L<span style="color:#f92672">-&gt;</span>savedpc;
</span></span><span style="display:flex;"><span>  L<span style="color:#f92672">-&gt;</span>savedpc <span style="color:#f92672">=</span> pc;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> ((mask <span style="color:#f92672">&amp;</span> LUA_MASKCOUNT) <span style="color:#f92672">&amp;&amp;</span> L<span style="color:#f92672">-&gt;</span>hookcount <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) {	<span style="color:#75715e">/* 执行了指定数量的pc，调用指定的钩子函数 */</span>
</span></span><span style="display:flex;"><span>    resethookcount(L);
</span></span><span style="display:flex;"><span>    luaD_callhook(L, LUA_HOOKCOUNT, <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (mask <span style="color:#f92672">&amp;</span> LUA_MASKLINE) {	<span style="color:#75715e">/* LUA_MASKLINE不是说执行到了某一行，具体的意思看下面的代码 */</span>
</span></span><span style="display:flex;"><span>    Proto <span style="color:#f92672">*</span>p <span style="color:#f92672">=</span> ci_func(L<span style="color:#f92672">-&gt;</span>ci)<span style="color:#f92672">-&gt;</span>l.p;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> npc <span style="color:#f92672">=</span> pcRel(pc, p);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> newline <span style="color:#f92672">=</span> getline(p, npc);
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/* call linehook when enter a new function, when jump back (loop),
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">       or when enter a new line */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (npc <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">||</span> pc <span style="color:#f92672">&lt;=</span> oldpc <span style="color:#f92672">||</span> newline <span style="color:#f92672">!=</span> getline(p, pcRel(oldpc, p)))
</span></span><span style="display:flex;"><span>      luaD_callhook(L, LUA_HOOKLINE, newline);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/* 调用元方法，将结果返回给res */</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">callTMres</span> (lua_State <span style="color:#f92672">*</span>L, StkId res, <span style="color:#66d9ef">const</span> TValue <span style="color:#f92672">*</span>f,
</span></span><span style="display:flex;"><span>                        <span style="color:#66d9ef">const</span> TValue <span style="color:#f92672">*</span>p1, <span style="color:#66d9ef">const</span> TValue <span style="color:#f92672">*</span>p2) {
</span></span><span style="display:flex;"><span>  ptrdiff_t result <span style="color:#f92672">=</span> savestack(L, res);
</span></span><span style="display:flex;"><span>  setobj2s(L, L<span style="color:#f92672">-&gt;</span>top, f);  <span style="color:#75715e">/* push function */</span>
</span></span><span style="display:flex;"><span>  setobj2s(L, L<span style="color:#f92672">-&gt;</span>top<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>, p1);  <span style="color:#75715e">/* 1st argument */</span>
</span></span><span style="display:flex;"><span>  setobj2s(L, L<span style="color:#f92672">-&gt;</span>top<span style="color:#f92672">+</span><span style="color:#ae81ff">2</span>, p2);  <span style="color:#75715e">/* 2nd argument */</span>
</span></span><span style="display:flex;"><span>  luaD_checkstack(L, <span style="color:#ae81ff">3</span>);
</span></span><span style="display:flex;"><span>  L<span style="color:#f92672">-&gt;</span>top <span style="color:#f92672">+=</span> <span style="color:#ae81ff">3</span>;
</span></span><span style="display:flex;"><span>  luaD_call(L, L<span style="color:#f92672">-&gt;</span>top <span style="color:#f92672">-</span> <span style="color:#ae81ff">3</span>, <span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>  res <span style="color:#f92672">=</span> restorestack(L, result);
</span></span><span style="display:flex;"><span>  L<span style="color:#f92672">-&gt;</span>top<span style="color:#f92672">--</span>;
</span></span><span style="display:flex;"><span>  setobjs2s(L, res, L<span style="color:#f92672">-&gt;</span>top);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">callTM</span> (lua_State <span style="color:#f92672">*</span>L, <span style="color:#66d9ef">const</span> TValue <span style="color:#f92672">*</span>f, <span style="color:#66d9ef">const</span> TValue <span style="color:#f92672">*</span>p1,
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">const</span> TValue <span style="color:#f92672">*</span>p2, <span style="color:#66d9ef">const</span> TValue <span style="color:#f92672">*</span>p3) {
</span></span><span style="display:flex;"><span>  setobj2s(L, L<span style="color:#f92672">-&gt;</span>top, f);  <span style="color:#75715e">/* push function */</span>
</span></span><span style="display:flex;"><span>  setobj2s(L, L<span style="color:#f92672">-&gt;</span>top<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>, p1);  <span style="color:#75715e">/* 1st argument */</span>
</span></span><span style="display:flex;"><span>  setobj2s(L, L<span style="color:#f92672">-&gt;</span>top<span style="color:#f92672">+</span><span style="color:#ae81ff">2</span>, p2);  <span style="color:#75715e">/* 2nd argument */</span>
</span></span><span style="display:flex;"><span>  setobj2s(L, L<span style="color:#f92672">-&gt;</span>top<span style="color:#f92672">+</span><span style="color:#ae81ff">3</span>, p3);  <span style="color:#75715e">/* 3th argument */</span>
</span></span><span style="display:flex;"><span>  luaD_checkstack(L, <span style="color:#ae81ff">4</span>);
</span></span><span style="display:flex;"><span>  L<span style="color:#f92672">-&gt;</span>top <span style="color:#f92672">+=</span> <span style="color:#ae81ff">4</span>;
</span></span><span style="display:flex;"><span>  luaD_call(L, L<span style="color:#f92672">-&gt;</span>top <span style="color:#f92672">-</span> <span style="color:#ae81ff">4</span>, <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">luaV_gettable</span> (lua_State <span style="color:#f92672">*</span>L, <span style="color:#66d9ef">const</span> TValue <span style="color:#f92672">*</span>t, TValue <span style="color:#f92672">*</span>key, StkId val) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> loop;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">for</span> (loop <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; loop <span style="color:#f92672">&lt;</span> MAXTAGLOOP; loop<span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> TValue <span style="color:#f92672">*</span>tm;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (ttistable(t)) {  <span style="color:#75715e">/* `t&#39; is a table? */</span>
</span></span><span style="display:flex;"><span>      Table <span style="color:#f92672">*</span>h <span style="color:#f92672">=</span> hvalue(t);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">const</span> TValue <span style="color:#f92672">*</span>res <span style="color:#f92672">=</span> luaH_get(h, key); <span style="color:#75715e">/* do a primitive get */</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>ttisnil(res) <span style="color:#f92672">||</span>  <span style="color:#75715e">/* result is no nil? */</span>
</span></span><span style="display:flex;"><span>          (tm <span style="color:#f92672">=</span> fasttm(L, h<span style="color:#f92672">-&gt;</span>metatable, TM_INDEX)) <span style="color:#f92672">==</span> NULL) { <span style="color:#75715e">/* or no TM? */</span>
</span></span><span style="display:flex;"><span>        setobj2s(L, val, res);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">/* else will try the tag method */</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (ttisnil(tm <span style="color:#f92672">=</span> luaT_gettmbyobj(L, t, TM_INDEX)))
</span></span><span style="display:flex;"><span>      luaG_typeerror(L, t, <span style="color:#e6db74">&#34;index&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (ttisfunction(tm)) {
</span></span><span style="display:flex;"><span>      callTMres(L, val, tm, t, key);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    t <span style="color:#f92672">=</span> tm;  <span style="color:#75715e">/* else repeat with `tm&#39; */</span> 
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  luaG_runerror(L, <span style="color:#e6db74">&#34;loop in gettable&#34;</span>);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">luaV_settable</span> (lua_State <span style="color:#f92672">*</span>L, <span style="color:#66d9ef">const</span> TValue <span style="color:#f92672">*</span>t, TValue <span style="color:#f92672">*</span>key, StkId val) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> loop;
</span></span><span style="display:flex;"><span>  TValue temp;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">for</span> (loop <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; loop <span style="color:#f92672">&lt;</span> MAXTAGLOOP; loop<span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> TValue <span style="color:#f92672">*</span>tm;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (ttistable(t)) {  <span style="color:#75715e">/* `t&#39; is a table? */</span>
</span></span><span style="display:flex;"><span>      Table <span style="color:#f92672">*</span>h <span style="color:#f92672">=</span> hvalue(t);
</span></span><span style="display:flex;"><span>      TValue <span style="color:#f92672">*</span>oldval <span style="color:#f92672">=</span> luaH_set(L, h, key); <span style="color:#75715e">/* do a primitive set */</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>ttisnil(oldval) <span style="color:#f92672">||</span>  <span style="color:#75715e">/* result is no nil? */</span>
</span></span><span style="display:flex;"><span>          (tm <span style="color:#f92672">=</span> fasttm(L, h<span style="color:#f92672">-&gt;</span>metatable, TM_NEWINDEX)) <span style="color:#f92672">==</span> NULL) { <span style="color:#75715e">/* or no TM? */</span>
</span></span><span style="display:flex;"><span>        setobj2t(L, oldval, val);
</span></span><span style="display:flex;"><span>        h<span style="color:#f92672">-&gt;</span>flags <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;	<span style="color:#75715e">/* 更新flags:假设所有的tm都存在 */</span>
</span></span><span style="display:flex;"><span>        luaC_barriert(L, h, val);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">/* else will try the tag method */</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (ttisnil(tm <span style="color:#f92672">=</span> luaT_gettmbyobj(L, t, TM_NEWINDEX)))
</span></span><span style="display:flex;"><span>      luaG_typeerror(L, t, <span style="color:#e6db74">&#34;index&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (ttisfunction(tm)) {
</span></span><span style="display:flex;"><span>      callTM(L, tm, t, key, val);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/* else repeat with `tm&#39; */</span>
</span></span><span style="display:flex;"><span>    setobj(L, <span style="color:#f92672">&amp;</span>temp, tm);  <span style="color:#75715e">/* avoid pointing inside table (may rehash) */</span>
</span></span><span style="display:flex;"><span>    t <span style="color:#f92672">=</span> <span style="color:#f92672">&amp;</span>temp;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  luaG_runerror(L, <span style="color:#e6db74">&#34;loop in settable&#34;</span>);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/* 同上callTM，针对tblA+tblB这种两个操作数的，尝试调用特定元方法 */</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">call_binTM</span> (lua_State <span style="color:#f92672">*</span>L, <span style="color:#66d9ef">const</span> TValue <span style="color:#f92672">*</span>p1, <span style="color:#66d9ef">const</span> TValue <span style="color:#f92672">*</span>p2,
</span></span><span style="display:flex;"><span>                       StkId res, TMS event) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> TValue <span style="color:#f92672">*</span>tm <span style="color:#f92672">=</span> luaT_gettmbyobj(L, p1, event);  <span style="color:#75715e">/* try first operand */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (ttisnil(tm))
</span></span><span style="display:flex;"><span>    tm <span style="color:#f92672">=</span> luaT_gettmbyobj(L, p2, event);  <span style="color:#75715e">/* try second operand */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (ttisnil(tm)) <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  callTMres(L, res, tm, p1, p2);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/* only for userdata */</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">const</span> TValue <span style="color:#f92672">*</span><span style="color:#a6e22e">get_compTM</span> (lua_State <span style="color:#f92672">*</span>L, Table <span style="color:#f92672">*</span>mt1, Table <span style="color:#f92672">*</span>mt2,
</span></span><span style="display:flex;"><span>                                  TMS event) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> TValue <span style="color:#f92672">*</span>tm1 <span style="color:#f92672">=</span> fasttm(L, mt1, event);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> TValue <span style="color:#f92672">*</span>tm2;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (tm1 <span style="color:#f92672">==</span> NULL) <span style="color:#66d9ef">return</span> NULL;  <span style="color:#75715e">/* no metamethod */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (mt1 <span style="color:#f92672">==</span> mt2) <span style="color:#66d9ef">return</span> tm1;  <span style="color:#75715e">/* same metatables =&gt; same metamethods */</span>
</span></span><span style="display:flex;"><span>  tm2 <span style="color:#f92672">=</span> fasttm(L, mt2, event);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (tm2 <span style="color:#f92672">==</span> NULL) <span style="color:#66d9ef">return</span> NULL;  <span style="color:#75715e">/* no metamethod */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (luaO_rawequalObj(tm1, tm2))  <span style="color:#75715e">/* same metamethods? */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> tm1;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> NULL;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/* 元方法：比较操作 */</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">call_orderTM</span> (lua_State <span style="color:#f92672">*</span>L, <span style="color:#66d9ef">const</span> TValue <span style="color:#f92672">*</span>p1, <span style="color:#66d9ef">const</span> TValue <span style="color:#f92672">*</span>p2,
</span></span><span style="display:flex;"><span>                         TMS event) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> TValue <span style="color:#f92672">*</span>tm1 <span style="color:#f92672">=</span> luaT_gettmbyobj(L, p1, event);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> TValue <span style="color:#f92672">*</span>tm2;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (ttisnil(tm1)) <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;  <span style="color:#75715e">/* no metamethod? */</span>
</span></span><span style="display:flex;"><span>  tm2 <span style="color:#f92672">=</span> luaT_gettmbyobj(L, p2, event);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>luaO_rawequalObj(tm1, tm2))  <span style="color:#75715e">/* different metamethods? */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>  callTMres(L, L<span style="color:#f92672">-&gt;</span>top, tm1, p1, p2);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#f92672">!</span>l_isfalse(L<span style="color:#f92672">-&gt;</span>top);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">l_strcmp</span> (<span style="color:#66d9ef">const</span> TString <span style="color:#f92672">*</span>ls, <span style="color:#66d9ef">const</span> TString <span style="color:#f92672">*</span>rs) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>l <span style="color:#f92672">=</span> getstr(ls);
</span></span><span style="display:flex;"><span>  size_t ll <span style="color:#f92672">=</span> ls<span style="color:#f92672">-&gt;</span>tsv.len;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>r <span style="color:#f92672">=</span> getstr(rs);
</span></span><span style="display:flex;"><span>  size_t lr <span style="color:#f92672">=</span> rs<span style="color:#f92672">-&gt;</span>tsv.len;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">for</span> (;;) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> temp <span style="color:#f92672">=</span> strcoll(l, r);	<span style="color:#75715e">/* 依环境变量 LC_COLLATE 所指定的文字排列次序来比较 s1 和 s2 字符串 */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (temp <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>) <span style="color:#66d9ef">return</span> temp;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span> {  <span style="color:#75715e">/* strings are equal up to a `\0&#39; */</span>
</span></span><span style="display:flex;"><span>      size_t len <span style="color:#f92672">=</span> strlen(l);  <span style="color:#75715e">/* index of first `\0&#39; in both strings */</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> (len <span style="color:#f92672">==</span> lr)  <span style="color:#75715e">/* r is finished? */</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> (len <span style="color:#f92672">==</span> ll) <span style="color:#f92672">?</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">:</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (len <span style="color:#f92672">==</span> ll)  <span style="color:#75715e">/* l is finished? */</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;  <span style="color:#75715e">/* l is smaller than r (because r is not finished) */</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">/* both strings longer than `len&#39;; go on comparing (after the `\0&#39;) */</span>
</span></span><span style="display:flex;"><span>      len<span style="color:#f92672">++</span>;
</span></span><span style="display:flex;"><span>      l <span style="color:#f92672">+=</span> len; ll <span style="color:#f92672">-=</span> len; r <span style="color:#f92672">+=</span> len; lr <span style="color:#f92672">-=</span> len;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/* 比较指令 */</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">luaV_lessthan</span> (lua_State <span style="color:#f92672">*</span>L, <span style="color:#66d9ef">const</span> TValue <span style="color:#f92672">*</span>l, <span style="color:#66d9ef">const</span> TValue <span style="color:#f92672">*</span>r) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> res;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (ttype(l) <span style="color:#f92672">!=</span> ttype(r))
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> luaG_ordererror(L, l, r);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (ttisnumber(l))
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> luai_numlt(nvalue(l), nvalue(r));
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (ttisstring(l))
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> l_strcmp(rawtsvalue(l), rawtsvalue(r)) <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> ((res <span style="color:#f92672">=</span> call_orderTM(L, l, r, TM_LT)) <span style="color:#f92672">!=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> res;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> luaG_ordererror(L, l, r);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">lessequal</span> (lua_State <span style="color:#f92672">*</span>L, <span style="color:#66d9ef">const</span> TValue <span style="color:#f92672">*</span>l, <span style="color:#66d9ef">const</span> TValue <span style="color:#f92672">*</span>r) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> res;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (ttype(l) <span style="color:#f92672">!=</span> ttype(r))
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> luaG_ordererror(L, l, r);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (ttisnumber(l))
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> luai_numle(nvalue(l), nvalue(r));
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (ttisstring(l))
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> l_strcmp(rawtsvalue(l), rawtsvalue(r)) <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> ((res <span style="color:#f92672">=</span> call_orderTM(L, l, r, TM_LE)) <span style="color:#f92672">!=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>)  <span style="color:#75715e">/* first try `le&#39; */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> res;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> ((res <span style="color:#f92672">=</span> call_orderTM(L, r, l, TM_LT)) <span style="color:#f92672">!=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>)  <span style="color:#75715e">/* else try `lt&#39; */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#f92672">!</span>res;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> luaG_ordererror(L, l, r);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">luaV_equalval</span> (lua_State <span style="color:#f92672">*</span>L, <span style="color:#66d9ef">const</span> TValue <span style="color:#f92672">*</span>t1, <span style="color:#66d9ef">const</span> TValue <span style="color:#f92672">*</span>t2) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> TValue <span style="color:#f92672">*</span>tm;
</span></span><span style="display:flex;"><span>  lua_assert(ttype(t1) <span style="color:#f92672">==</span> ttype(t2));
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">switch</span> (ttype(t1)) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> LUA_TNIL: <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> LUA_TNUMBER: <span style="color:#66d9ef">return</span> luai_numeq(nvalue(t1), nvalue(t2));
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> LUA_TBOOLEAN: <span style="color:#66d9ef">return</span> bvalue(t1) <span style="color:#f92672">==</span> bvalue(t2);  <span style="color:#75715e">/* true must be 1 !! */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> LUA_TLIGHTUSERDATA: <span style="color:#66d9ef">return</span> pvalue(t1) <span style="color:#f92672">==</span> pvalue(t2);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> LUA_TUSERDATA: {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> (uvalue(t1) <span style="color:#f92672">==</span> uvalue(t2)) <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>      tm <span style="color:#f92672">=</span> get_compTM(L, uvalue(t1)<span style="color:#f92672">-&gt;</span>metatable, uvalue(t2)<span style="color:#f92672">-&gt;</span>metatable,
</span></span><span style="display:flex;"><span>                         TM_EQ);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">break</span>;  <span style="color:#75715e">/* will try TM */</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> LUA_TTABLE: {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> (hvalue(t1) <span style="color:#f92672">==</span> hvalue(t2)) <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>      tm <span style="color:#f92672">=</span> get_compTM(L, hvalue(t1)<span style="color:#f92672">-&gt;</span>metatable, hvalue(t2)<span style="color:#f92672">-&gt;</span>metatable, TM_EQ);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">break</span>;  <span style="color:#75715e">/* will try TM */</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">default</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">return</span> gcvalue(t1) <span style="color:#f92672">==</span> gcvalue(t2);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (tm <span style="color:#f92672">==</span> NULL) <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;  <span style="color:#75715e">/* no TM? */</span>
</span></span><span style="display:flex;"><span>  callTMres(L, L<span style="color:#f92672">-&gt;</span>top, tm, t1, t2);  <span style="color:#75715e">/* call TM */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#f92672">!</span>l_isfalse(L<span style="color:#f92672">-&gt;</span>top);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/* 从last开始，一共链接total个slot          */</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">luaV_concat</span> (lua_State <span style="color:#f92672">*</span>L, <span style="color:#66d9ef">int</span> total, <span style="color:#66d9ef">int</span> last) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">do</span> {
</span></span><span style="display:flex;"><span>    StkId top <span style="color:#f92672">=</span> L<span style="color:#f92672">-&gt;</span>base <span style="color:#f92672">+</span> last <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> n <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>;  <span style="color:#75715e">/* number of elements handled in this pass (at least 2) */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>(ttisstring(top<span style="color:#f92672">-</span><span style="color:#ae81ff">2</span>) <span style="color:#f92672">||</span> ttisnumber(top<span style="color:#f92672">-</span><span style="color:#ae81ff">2</span>)) <span style="color:#f92672">||</span> <span style="color:#f92672">!</span>tostring(L, top<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>)) {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>call_binTM(L, top<span style="color:#f92672">-</span><span style="color:#ae81ff">2</span>, top<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>, top<span style="color:#f92672">-</span><span style="color:#ae81ff">2</span>, TM_CONCAT))
</span></span><span style="display:flex;"><span>        luaG_concaterror(L, top<span style="color:#f92672">-</span><span style="color:#ae81ff">2</span>, top<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>    } <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (tsvalue(top<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>)<span style="color:#f92672">-&gt;</span>len <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>)  <span style="color:#75715e">/* second op is empty? */</span>
</span></span><span style="display:flex;"><span>      (<span style="color:#66d9ef">void</span>)tostring(L, top <span style="color:#f92672">-</span> <span style="color:#ae81ff">2</span>);  <span style="color:#75715e">/* result is first op (as string) */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">/* at least two string values; get as many as possible */</span>
</span></span><span style="display:flex;"><span>      size_t tl <span style="color:#f92672">=</span> tsvalue(top<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>)<span style="color:#f92672">-&gt;</span>len;
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>buffer;
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">int</span> i;
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">/* collect total length */</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">for</span> (n <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>; n <span style="color:#f92672">&lt;</span> total <span style="color:#f92672">&amp;&amp;</span> tostring(L, top<span style="color:#f92672">-</span>n<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>); n<span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>        size_t l <span style="color:#f92672">=</span> tsvalue(top<span style="color:#f92672">-</span>n<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>)<span style="color:#f92672">-&gt;</span>len;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (l <span style="color:#f92672">&gt;=</span> MAX_SIZET <span style="color:#f92672">-</span> tl) luaG_runerror(L, <span style="color:#e6db74">&#34;string length overflow&#34;</span>);
</span></span><span style="display:flex;"><span>        tl <span style="color:#f92672">+=</span> l;
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      buffer <span style="color:#f92672">=</span> luaZ_openspace(L, <span style="color:#f92672">&amp;</span>G(L)<span style="color:#f92672">-&gt;</span>buff, tl);
</span></span><span style="display:flex;"><span>      tl <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">for</span> (i<span style="color:#f92672">=</span>n; i<span style="color:#f92672">&gt;</span><span style="color:#ae81ff">0</span>; i<span style="color:#f92672">--</span>) {  <span style="color:#75715e">/* concat all strings */</span>
</span></span><span style="display:flex;"><span>        size_t l <span style="color:#f92672">=</span> tsvalue(top<span style="color:#f92672">-</span>i)<span style="color:#f92672">-&gt;</span>len;
</span></span><span style="display:flex;"><span>        memcpy(buffer<span style="color:#f92672">+</span>tl, svalue(top<span style="color:#f92672">-</span>i), l);
</span></span><span style="display:flex;"><span>        tl <span style="color:#f92672">+=</span> l;
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      setsvalue2s(L, top<span style="color:#f92672">-</span>n, luaS_newlstr(L, buffer, tl));
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    total <span style="color:#f92672">-=</span> n<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;  <span style="color:#75715e">/* got `n&#39; strings to create 1 new */</span>
</span></span><span style="display:flex;"><span>    last <span style="color:#f92672">-=</span> n<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>  } <span style="color:#66d9ef">while</span> (total <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">1</span>);  <span style="color:#75715e">/* repeat until only 1 result left */</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">Arith</span> (lua_State <span style="color:#f92672">*</span>L, StkId ra, <span style="color:#66d9ef">const</span> TValue <span style="color:#f92672">*</span>rb,
</span></span><span style="display:flex;"><span>                   <span style="color:#66d9ef">const</span> TValue <span style="color:#f92672">*</span>rc, TMS op) {
</span></span><span style="display:flex;"><span>  TValue tempb, tempc;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> TValue <span style="color:#f92672">*</span>b, <span style="color:#f92672">*</span>c;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> ((b <span style="color:#f92672">=</span> luaV_tonumber(rb, <span style="color:#f92672">&amp;</span>tempb)) <span style="color:#f92672">!=</span> NULL <span style="color:#f92672">&amp;&amp;</span>
</span></span><span style="display:flex;"><span>      (c <span style="color:#f92672">=</span> luaV_tonumber(rc, <span style="color:#f92672">&amp;</span>tempc)) <span style="color:#f92672">!=</span> NULL) {
</span></span><span style="display:flex;"><span>    lua_Number nb <span style="color:#f92672">=</span> nvalue(b), nc <span style="color:#f92672">=</span> nvalue(c);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">switch</span> (op) {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">case</span> TM_ADD: setnvalue(ra, luai_numadd(nb, nc)); <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">case</span> TM_SUB: setnvalue(ra, luai_numsub(nb, nc)); <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">case</span> TM_MUL: setnvalue(ra, luai_nummul(nb, nc)); <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">case</span> TM_DIV: setnvalue(ra, luai_numdiv(nb, nc)); <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">case</span> TM_MOD: setnvalue(ra, luai_nummod(nb, nc)); <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">case</span> TM_POW: setnvalue(ra, luai_numpow(nb, nc)); <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">case</span> TM_UNM: setnvalue(ra, luai_numunm(nb)); <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">default</span><span style="color:#f92672">:</span> lua_assert(<span style="color:#ae81ff">0</span>); <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>call_binTM(L, rb, rc, ra, op))
</span></span><span style="display:flex;"><span>    luaG_aritherror(L, rb, rc);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/*
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">** some macros for common tasks in `luaV_execute&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">*/</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#define runtime_check(L, c)	{ if (!(c)) break; }
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/* 提取指令中A,B,C的值 */</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#define RA(i)	(base+GETARG_A(i))
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#75715e">/* to be used after possible stack reallocation */</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#define RB(i)	check_exp(getBMode(GET_OPCODE(i)) == OpArgR, base+GETARG_B(i))
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define RC(i)	check_exp(getCMode(GET_OPCODE(i)) == OpArgR, base+GETARG_C(i))
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define RKB(i)	check_exp(getBMode(GET_OPCODE(i)) == OpArgK, \
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	ISK(GETARG_B(i)) ? k+INDEXK(GETARG_B(i)) : base+GETARG_B(i))
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define RKC(i)	check_exp(getCMode(GET_OPCODE(i)) == OpArgK, \
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	ISK(GETARG_C(i)) ? k+INDEXK(GETARG_C(i)) : base+GETARG_C(i))
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define KBx(i)	check_exp(getBMode(GET_OPCODE(i)) == OpArgK, k+GETARG_Bx(i))
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#define dojump(L,pc,i)	{(pc) += (i); luai_threadyield(L);}
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/* x可能触发新的frame，这里保存和恢复“部分现场”配合下面的execute一起看 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">** pc:为何要存档呢？这是一个局部变量，且是相对frame有效，若切换execute则pc作为上一个execute的局部变量保存起来了，
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">**    所以为啥要保存这个变量呢？
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">** base: {x}可能修改stack,造成base记录的本frame的base失效，故而这里要刷新base
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">*/</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#define Protect(x)	{ L-&gt;savedpc = pc; {x;}; base = L-&gt;base; }
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/* 这个宏有意思哈 */</span> 
</span></span><span style="display:flex;"><span><span style="color:#75715e">#define arith_op(op,tm) { \
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">        TValue *rb = RKB(i); \
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">        TValue *rc = RKC(i); \
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">        if (ttisnumber(rb) &amp;&amp; ttisnumber(rc)) { \
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">          lua_Number nb = nvalue(rb), nc = nvalue(rc); \
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">          setnvalue(ra, op(nb, nc)); \
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">        } \
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">        else \
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">          Protect(Arith(L, ra, rb, rc, tm)); \
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">      }
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/* 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">** KEYCODE
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">** nexeccalls:Lua连续调用的层次
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">** eg: c(0)-&gt;Lua(1)-&gt;Lua(2)-&gt;c()-&gt;Lua(1)-&gt;Lua(2)-&gt;Lua(3)-&gt;c(0)-&gt;Lua(1)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">** 某次Lua调用结束，--nexeccalls，如果nexeccalls==0，表示当前lua调用链结束了，需要跳出luaV_execute函数
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">** 大于0表示本Lua调用结束后，上一层必然还是Lua函数，需要进入reentry点
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">*/</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">luaV_execute</span> (lua_State <span style="color:#f92672">*</span>L, <span style="color:#66d9ef">int</span> nexeccalls) {
</span></span><span style="display:flex;"><span>  LClosure <span style="color:#f92672">*</span>cl;
</span></span><span style="display:flex;"><span>  StkId base;
</span></span><span style="display:flex;"><span>  TValue <span style="color:#f92672">*</span>k;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> Instruction <span style="color:#f92672">*</span>pc;
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span> reentry:  <span style="color:#75715e">/* entry point for new (callInfo,frame) */</span>
</span></span><span style="display:flex;"><span>  lua_assert(isLua(L<span style="color:#f92672">-&gt;</span>ci));	<span style="color:#75715e">/* C函数frame的执行不在这里，亲! */</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">/* KEYCODE vm执行的关键参数:base,top,pc,savedpc, closure,k, L-&gt;ci,
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">  ** 后续因为call和return等切换调用栈时，必须正确处理上述参数
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">  ** 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">  ** !!!!!!!! L-&gt;top没有在这里更新，这点要有印象，resason:类似funA(funB())一个函数(frame)运行完毕时的某些状态eg:L-&gt;top
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">  ** 对上下文的frame可能有影响，所以这里没有更新L-&gt;top，而是让有关业务(return,call...)自行处理
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">  */</span>
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  pc <span style="color:#f92672">=</span> L<span style="color:#f92672">-&gt;</span>savedpc;
</span></span><span style="display:flex;"><span>  cl <span style="color:#f92672">=</span> <span style="color:#f92672">&amp;</span>clvalue(L<span style="color:#f92672">-&gt;</span>ci<span style="color:#f92672">-&gt;</span>func)<span style="color:#f92672">-&gt;</span>l;
</span></span><span style="display:flex;"><span>  base <span style="color:#f92672">=</span> L<span style="color:#f92672">-&gt;</span>base;
</span></span><span style="display:flex;"><span>  k <span style="color:#f92672">=</span> cl<span style="color:#f92672">-&gt;</span>p<span style="color:#f92672">-&gt;</span>k;	<span style="color:#75715e">/* locvars 仅在编译阶段/调试库中有效，虚拟机运行阶段无效(已编码到pc中) */</span>
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">/* main loop of interpreter */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">for</span> (;;) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> Instruction i <span style="color:#f92672">=</span> <span style="color:#f92672">*</span>pc<span style="color:#f92672">++</span>;	<span style="color:#75715e">/* 等效：*(pc++) */</span>
</span></span><span style="display:flex;"><span>    StkId ra;
</span></span><span style="display:flex;"><span>   <span style="color:#75715e">/* 运行钩子逻辑 */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> ((L<span style="color:#f92672">-&gt;</span>hookmask <span style="color:#f92672">&amp;</span> (LUA_MASKLINE <span style="color:#f92672">|</span> LUA_MASKCOUNT)) <span style="color:#f92672">&amp;&amp;</span>
</span></span><span style="display:flex;"><span>        (<span style="color:#f92672">--</span>L<span style="color:#f92672">-&gt;</span>hookcount <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">||</span> L<span style="color:#f92672">-&gt;</span>hookmask <span style="color:#f92672">&amp;</span> LUA_MASKLINE)) {
</span></span><span style="display:flex;"><span>      traceexec(L, pc);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> (L<span style="color:#f92672">-&gt;</span>status <span style="color:#f92672">==</span> LUA_YIELD) {  <span style="color:#75715e">/* did hook yield? */</span>
</span></span><span style="display:flex;"><span>        L<span style="color:#f92672">-&gt;</span>savedpc <span style="color:#f92672">=</span> pc <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      base <span style="color:#f92672">=</span> L<span style="color:#f92672">-&gt;</span>base;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/* warning!! several(某些) calls may realloc the stack and invalidate `ra&#39; */</span>
</span></span><span style="display:flex;"><span>    ra <span style="color:#f92672">=</span> RA(i);
</span></span><span style="display:flex;"><span>    lua_assert(base <span style="color:#f92672">==</span> L<span style="color:#f92672">-&gt;</span>base <span style="color:#f92672">&amp;&amp;</span> L<span style="color:#f92672">-&gt;</span>base <span style="color:#f92672">==</span> L<span style="color:#f92672">-&gt;</span>ci<span style="color:#f92672">-&gt;</span>base);
</span></span><span style="display:flex;"><span>    lua_assert(base <span style="color:#f92672">&lt;=</span> L<span style="color:#f92672">-&gt;</span>top <span style="color:#f92672">&amp;&amp;</span> L<span style="color:#f92672">-&gt;</span>top <span style="color:#f92672">&lt;=</span> L<span style="color:#f92672">-&gt;</span>stack <span style="color:#f92672">+</span> L<span style="color:#f92672">-&gt;</span>stacksize);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">/* luaG_checkopenop的用途对照上面L-&gt;top的注释看就明白了 */</span>
</span></span><span style="display:flex;"><span>    lua_assert(L<span style="color:#f92672">-&gt;</span>top <span style="color:#f92672">==</span> L<span style="color:#f92672">-&gt;</span>ci<span style="color:#f92672">-&gt;</span>top <span style="color:#f92672">||</span> luaG_checkopenop(i));
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">switch</span> (GET_OPCODE(i)) {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">case</span> OP_MOVE: {
</span></span><span style="display:flex;"><span>        setobjs2s(L, ra, RB(i));
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">continue</span>;
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">case</span> OP_LOADK: {
</span></span><span style="display:flex;"><span>        setobj2s(L, ra, KBx(i));
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">continue</span>;
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">case</span> OP_LOADBOOL: {
</span></span><span style="display:flex;"><span>        setbvalue(ra, GETARG_B(i));
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (GETARG_C(i)) pc<span style="color:#f92672">++</span>;  <span style="color:#75715e">/* skip next instruction (if C) */</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">continue</span>;
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">case</span> OP_LOADNIL: {
</span></span><span style="display:flex;"><span>        TValue <span style="color:#f92672">*</span>rb <span style="color:#f92672">=</span> RB(i);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">do</span> {
</span></span><span style="display:flex;"><span>          setnilvalue(rb<span style="color:#f92672">--</span>);
</span></span><span style="display:flex;"><span>        } <span style="color:#66d9ef">while</span> (rb <span style="color:#f92672">&gt;=</span> ra);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">continue</span>;
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">case</span> OP_GETUPVAL: {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">int</span> b <span style="color:#f92672">=</span> GETARG_B(i);
</span></span><span style="display:flex;"><span>        setobj2s(L, ra, cl<span style="color:#f92672">-&gt;</span>upvals[b]<span style="color:#f92672">-&gt;</span>v);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">continue</span>;
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">case</span> OP_GETGLOBAL: {
</span></span><span style="display:flex;"><span>        TValue g;
</span></span><span style="display:flex;"><span>        TValue <span style="color:#f92672">*</span>rb <span style="color:#f92672">=</span> KBx(i);
</span></span><span style="display:flex;"><span>        sethvalue(L, <span style="color:#f92672">&amp;</span>g, cl<span style="color:#f92672">-&gt;</span>env);
</span></span><span style="display:flex;"><span>        lua_assert(ttisstring(rb));	<span style="color:#75715e">/* 全局变量名类型必须是TString */</span>
</span></span><span style="display:flex;"><span>        Protect(luaV_gettable(L, <span style="color:#f92672">&amp;</span>g, rb, ra));
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">continue</span>;
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">case</span> OP_GETTABLE: {
</span></span><span style="display:flex;"><span>        Protect(luaV_gettable(L, RB(i), RKC(i), ra));
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">continue</span>;
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">case</span> OP_SETGLOBAL: {
</span></span><span style="display:flex;"><span>        TValue g;
</span></span><span style="display:flex;"><span>        sethvalue(L, <span style="color:#f92672">&amp;</span>g, cl<span style="color:#f92672">-&gt;</span>env);
</span></span><span style="display:flex;"><span>        lua_assert(ttisstring(KBx(i)));
</span></span><span style="display:flex;"><span>        Protect(luaV_settable(L, <span style="color:#f92672">&amp;</span>g, KBx(i), ra));
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">continue</span>;
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">case</span> OP_SETUPVAL: {
</span></span><span style="display:flex;"><span>        UpVal <span style="color:#f92672">*</span>uv <span style="color:#f92672">=</span> cl<span style="color:#f92672">-&gt;</span>upvals[GETARG_B(i)];
</span></span><span style="display:flex;"><span>        setobj(L, uv<span style="color:#f92672">-&gt;</span>v, ra);
</span></span><span style="display:flex;"><span>        luaC_barrier(L, uv, ra);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">continue</span>;
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">case</span> OP_SETTABLE: {
</span></span><span style="display:flex;"><span>        Protect(luaV_settable(L, ra, RKB(i), RKC(i)));
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">continue</span>;
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">case</span> OP_NEWTABLE: {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">int</span> b <span style="color:#f92672">=</span> GETARG_B(i);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">int</span> c <span style="color:#f92672">=</span> GETARG_C(i);
</span></span><span style="display:flex;"><span>        sethvalue(L, ra, luaH_new(L, luaO_fb2int(b), luaO_fb2int(c)));
</span></span><span style="display:flex;"><span>        Protect(luaC_checkGC(L));
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">continue</span>;
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">case</span> OP_SELF: {
</span></span><span style="display:flex;"><span>        StkId rb <span style="color:#f92672">=</span> RB(i);	<span style="color:#75715e">/* 拿到self.sub中的self指代的表 */</span>
</span></span><span style="display:flex;"><span>        setobjs2s(L, ra<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>, rb);	<span style="color:#75715e">/* 将上述表self存起来 */</span>
</span></span><span style="display:flex;"><span>        Protect(luaV_gettable(L, rb, RKC(i), ra)); <span style="color:#75715e">/* 计算self.sub的值 */</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">continue</span>;
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">case</span> OP_ADD: {
</span></span><span style="display:flex;"><span>        arith_op(luai_numadd, TM_ADD);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">continue</span>;
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">case</span> OP_SUB: {
</span></span><span style="display:flex;"><span>        arith_op(luai_numsub, TM_SUB);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">continue</span>;
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">case</span> OP_MUL: {
</span></span><span style="display:flex;"><span>        arith_op(luai_nummul, TM_MUL);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">continue</span>;
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">case</span> OP_DIV: {
</span></span><span style="display:flex;"><span>        arith_op(luai_numdiv, TM_DIV);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">continue</span>;
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">case</span> OP_MOD: {
</span></span><span style="display:flex;"><span>        arith_op(luai_nummod, TM_MOD);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">continue</span>;
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">case</span> OP_POW: {
</span></span><span style="display:flex;"><span>        arith_op(luai_numpow, TM_POW);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">continue</span>;
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">case</span> OP_UNM: {
</span></span><span style="display:flex;"><span>        TValue <span style="color:#f92672">*</span>rb <span style="color:#f92672">=</span> RB(i);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (ttisnumber(rb)) {
</span></span><span style="display:flex;"><span>          lua_Number nb <span style="color:#f92672">=</span> nvalue(rb);
</span></span><span style="display:flex;"><span>          setnvalue(ra, luai_numunm(nb));
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>          Protect(Arith(L, ra, rb, rb, TM_UNM));
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">continue</span>;
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">case</span> OP_NOT: {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">int</span> res <span style="color:#f92672">=</span> l_isfalse(RB(i));  <span style="color:#75715e">/* next assignment may change this value */</span>
</span></span><span style="display:flex;"><span>        setbvalue(ra, res);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">continue</span>;
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">case</span> OP_LEN: {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">const</span> TValue <span style="color:#f92672">*</span>rb <span style="color:#f92672">=</span> RB(i);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">switch</span> (ttype(rb)) {
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">case</span> LUA_TTABLE: {
</span></span><span style="display:flex;"><span>            setnvalue(ra, cast_num(luaH_getn(hvalue(rb))));
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>          }
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">case</span> LUA_TSTRING: {
</span></span><span style="display:flex;"><span>            setnvalue(ra, cast_num(tsvalue(rb)<span style="color:#f92672">-&gt;</span>len));
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>          }
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">default</span><span style="color:#f92672">:</span> {  <span style="color:#75715e">/* try metamethod */</span>
</span></span><span style="display:flex;"><span>            Protect(
</span></span><span style="display:flex;"><span>              <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>call_binTM(L, rb, luaO_nilobject, ra, TM_LEN))
</span></span><span style="display:flex;"><span>                luaG_typeerror(L, rb, <span style="color:#e6db74">&#34;get length of&#34;</span>);
</span></span><span style="display:flex;"><span>            )
</span></span><span style="display:flex;"><span>          }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">continue</span>;
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">case</span> OP_CONCAT: {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">int</span> b <span style="color:#f92672">=</span> GETARG_B(i);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">int</span> c <span style="color:#f92672">=</span> GETARG_C(i);
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">/* */</span>
</span></span><span style="display:flex;"><span>        Protect(luaV_concat(L, c<span style="color:#f92672">-</span>b<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>, c); luaC_checkGC(L));
</span></span><span style="display:flex;"><span>        setobjs2s(L, RA(i), base<span style="color:#f92672">+</span>b);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">continue</span>;
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">case</span> OP_JMP: {
</span></span><span style="display:flex;"><span>        dojump(L, pc, GETARG_sBx(i));
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">continue</span>;
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>	  	<span style="color:#75715e">/* KEYCODE 重点，难点，代表性的指令 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	  	** if ((RK(B) == RK(C)) ~= A) then pc++
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	  	** OP_EQ后面紧跟着是跳转指令，这里猜测，跳转的值Bx应该短1，因为后面又进行了pc++
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	  	*/</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">case</span> OP_EQ: {
</span></span><span style="display:flex;"><span>        TValue <span style="color:#f92672">*</span>rb <span style="color:#f92672">=</span> RKB(i);
</span></span><span style="display:flex;"><span>        TValue <span style="color:#f92672">*</span>rc <span style="color:#f92672">=</span> RKC(i);
</span></span><span style="display:flex;"><span>        Protect(
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">if</span> (equalobj(L, rb, rc) <span style="color:#f92672">==</span> GETARG_A(i))
</span></span><span style="display:flex;"><span>            dojump(L, pc, GETARG_sBx(<span style="color:#f92672">*</span>pc));
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>        pc<span style="color:#f92672">++</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">continue</span>;
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">case</span> OP_LT: {
</span></span><span style="display:flex;"><span>        Protect(
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">if</span> (luaV_lessthan(L, RKB(i), RKC(i)) <span style="color:#f92672">==</span> GETARG_A(i))
</span></span><span style="display:flex;"><span>            dojump(L, pc, GETARG_sBx(<span style="color:#f92672">*</span>pc));
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>        pc<span style="color:#f92672">++</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">continue</span>;
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">case</span> OP_LE: {	
</span></span><span style="display:flex;"><span>        Protect(
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">if</span> (lessequal(L, RKB(i), RKC(i)) <span style="color:#f92672">==</span> GETARG_A(i))
</span></span><span style="display:flex;"><span>            dojump(L, pc, GETARG_sBx(<span style="color:#f92672">*</span>pc));
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>        pc<span style="color:#f92672">++</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">continue</span>;
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">case</span> OP_TEST: {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (l_isfalse(ra) <span style="color:#f92672">!=</span> GETARG_C(i))
</span></span><span style="display:flex;"><span>          dojump(L, pc, GETARG_sBx(<span style="color:#f92672">*</span>pc));
</span></span><span style="display:flex;"><span>        pc<span style="color:#f92672">++</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">continue</span>;
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">case</span> OP_TESTSET: {
</span></span><span style="display:flex;"><span>        TValue <span style="color:#f92672">*</span>rb <span style="color:#f92672">=</span> RB(i);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (l_isfalse(rb) <span style="color:#f92672">!=</span> GETARG_C(i)) {
</span></span><span style="display:flex;"><span>          setobjs2s(L, ra, rb);
</span></span><span style="display:flex;"><span>          dojump(L, pc, GETARG_sBx(<span style="color:#f92672">*</span>pc));
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        pc<span style="color:#f92672">++</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">continue</span>;
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">case</span> OP_CALL: {	<span style="color:#75715e">/* R(A), ... ,R(A+C-2) := R(A)(R(A+1), ... ,R(A+B-1)) */</span>
</span></span><span style="display:flex;"><span>	    <span style="color:#66d9ef">int</span> b <span style="color:#f92672">=</span> GETARG_B(i);			<span style="color:#75715e">/* 传入参数个数，          B:0：...  1：0个，2：1个，3：2个依次类推 */</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">int</span> nresults <span style="color:#f92672">=</span> GETARG_C(i) <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>;	<span style="color:#75715e">/* 期待的返回值个数 C:0(...), 1:(期待返回0个)，2:(期待返回1个) */</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/* 注解99: 当传入的参数数量明确时，设置L-&gt;top告知被调用函数确切的传入参数数量,
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">        ** 不明确时，OP_VARARG(fun(...))/	RETURN.B(funA(funB())等指令中已确定了top的位置，这里不能也不用再更改设置(否则L-&gt;top!=实际传入的参数位置)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">        ** 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">        ** L-&gt;top都是指向了最后一个参数的&#34;位置&#34;,也是告知被调用函数，我已经准备好了你要的参数且top指针已指到相应的位置了
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">        */</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (b <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>) 
</span></span><span style="display:flex;"><span>			L<span style="color:#f92672">-&gt;</span>top <span style="color:#f92672">=</span> ra<span style="color:#f92672">+</span>b;  <span style="color:#75715e">/* else previous instruction set top */</span>
</span></span><span style="display:flex;"><span>		
</span></span><span style="display:flex;"><span>        L<span style="color:#f92672">-&gt;</span>savedpc <span style="color:#f92672">=</span> pc;	<span style="color:#75715e">/* 记下原本接下来要执行的下一条指令，等待new&#39;frame运行结束后，继续运行本frame */</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">switch</span> (luaD_precall(L, ra, nresults)) {
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">case</span> PCRLUA: {
</span></span><span style="display:flex;"><span>            nexeccalls<span style="color:#f92672">++</span>;
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">/* 若子函数(frame)是Lua，这里continue才真正开始执行子函数(frame)的opcode */</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">goto</span> reentry;  <span style="color:#75715e">/* restart luaV_execute over new Lua function */</span>
</span></span><span style="display:flex;"><span>          }
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">case</span> PCRC: {
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">/* it was a C function (`precall&#39; called it); adjust results */</span>
</span></span><span style="display:flex;"><span>		  
</span></span><span style="display:flex;"><span>		    <span style="color:#75715e">/* 注解100: C调用结束时luaD_poscall已经将所有的返回值填充到RA开头的addr上,L-&gt;top指向最后一个返回值
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">		    ** 期待返回值个数确定时eg:local a,b = fun()，luaD_poscall函数自动赋值了a,b，L-&gt;top已经完成了使命
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">		    **     故而这里将其复原。
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">		    ** 期待返回个数不确定时eg:local t = {fun()}或funA(funB())，这种情况下L-&gt;top指向的最后一个返回值地址，
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">		    **     将被下一条指令setlist(B=0)或callA(B=0)用于计算传入参数的个数，所以不能复原(下一条指令要用到)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">		    */</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (nresults <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>				L<span style="color:#f92672">-&gt;</span>top <span style="color:#f92672">=</span> L<span style="color:#f92672">-&gt;</span>ci<span style="color:#f92672">-&gt;</span>top;
</span></span><span style="display:flex;"><span>			
</span></span><span style="display:flex;"><span>            base <span style="color:#f92672">=</span> L<span style="color:#f92672">-&gt;</span>base;	<span style="color:#75715e">/* 调用过程中stack可能变化而移动，故而重新获取最新的(L-&gt;ci-&gt;base==L-&gt;base)的base，下同 */</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">/* 子函数(frame)为c,luaD_precall的返回意味着子函数(frame)已运行完毕，相关参数也调整完毕
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">			** 这里接着运行母函数(frame)的紧跟着OP_CALL后面的下一条指令 */</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">continue</span>;	
</span></span><span style="display:flex;"><span>          }
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">default</span><span style="color:#f92672">:</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span>;  <span style="color:#75715e">/* yield,交出lua的执行权 */</span>
</span></span><span style="display:flex;"><span>          }
</span></span><span style="display:flex;"><span>        } 
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">case</span> OP_TAILCALL: {
</span></span><span style="display:flex;"><span>	  	<span style="color:#75715e">/* A B C return R(A)(R(A+1), ... ,R(A+B-1)) */</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">int</span> b <span style="color:#f92672">=</span> GETARG_B(i);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (b <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>			L<span style="color:#f92672">-&gt;</span>top <span style="color:#f92672">=</span> ra<span style="color:#f92672">+</span>b;  <span style="color:#75715e">/* else previous instruction set top */</span>
</span></span><span style="display:flex;"><span>        } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>        	<span style="color:#75715e">/* return fun(...) 前面的OP_VARARG指令设置好了L-&gt;top */</span> 
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        L<span style="color:#f92672">-&gt;</span>savedpc <span style="color:#f92672">=</span> pc;
</span></span><span style="display:flex;"><span>        lua_assert(GETARG_C(i) <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">==</span> LUA_MULTRET);	<span style="color:#75715e">/* 尾调用的定义中：必须返回其调用返回的所有值，所以这里C必须为0 */</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">switch</span> (luaD_precall(L, ra, LUA_MULTRET)) {
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">case</span> PCRLUA: {	<span style="color:#75715e">/* 画图，代码不难，看懂它们 */</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">/* tail call: put new frame in place of previous one */</span>
</span></span><span style="display:flex;"><span>            CallInfo <span style="color:#f92672">*</span>ci <span style="color:#f92672">=</span> L<span style="color:#f92672">-&gt;</span>ci <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>;  <span style="color:#75715e">/* previous frame */</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">int</span> aux;
</span></span><span style="display:flex;"><span>            StkId func <span style="color:#f92672">=</span> ci<span style="color:#f92672">-&gt;</span>func;
</span></span><span style="display:flex;"><span>            StkId pfunc <span style="color:#f92672">=</span> (ci<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>)<span style="color:#f92672">-&gt;</span>func;  <span style="color:#75715e">/* previous function index */</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (L<span style="color:#f92672">-&gt;</span>openupval) luaF_close(L, ci<span style="color:#f92672">-&gt;</span>base);
</span></span><span style="display:flex;"><span>            L<span style="color:#f92672">-&gt;</span>base <span style="color:#f92672">=</span> ci<span style="color:#f92672">-&gt;</span>base <span style="color:#f92672">=</span> ci<span style="color:#f92672">-&gt;</span>func <span style="color:#f92672">+</span> ((ci<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>)<span style="color:#f92672">-&gt;</span>base <span style="color:#f92672">-</span> pfunc);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">/* ！！！！移动后func指向的地址不变，但值改变了（由母函数变成了被尾调用的子函数) */</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">for</span> (aux <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; pfunc<span style="color:#f92672">+</span>aux <span style="color:#f92672">&lt;</span> L<span style="color:#f92672">-&gt;</span>top; aux<span style="color:#f92672">++</span>)  <span style="color:#75715e">/* move frame down */</span>
</span></span><span style="display:flex;"><span>              setobjs2s(L, func<span style="color:#f92672">+</span>aux, pfunc<span style="color:#f92672">+</span>aux);
</span></span><span style="display:flex;"><span>			
</span></span><span style="display:flex;"><span>            ci<span style="color:#f92672">-&gt;</span>top <span style="color:#f92672">=</span> L<span style="color:#f92672">-&gt;</span>top <span style="color:#f92672">=</span> func<span style="color:#f92672">+</span>aux;  <span style="color:#75715e">/* correct top */</span>
</span></span><span style="display:flex;"><span>            lua_assert(L<span style="color:#f92672">-&gt;</span>top <span style="color:#f92672">==</span> L<span style="color:#f92672">-&gt;</span>base <span style="color:#f92672">+</span> clvalue(func)<span style="color:#f92672">-&gt;</span>l.p<span style="color:#f92672">-&gt;</span>maxstacksize);
</span></span><span style="display:flex;"><span>            ci<span style="color:#f92672">-&gt;</span>savedpc <span style="color:#f92672">=</span> L<span style="color:#f92672">-&gt;</span>savedpc;	<span style="color:#75715e">/* 这里也要更新 */</span>
</span></span><span style="display:flex;"><span>            ci<span style="color:#f92672">-&gt;</span>tailcalls<span style="color:#f92672">++</span>;  <span style="color:#75715e">/* one more call lost */</span>
</span></span><span style="display:flex;"><span>            L<span style="color:#f92672">-&gt;</span>ci<span style="color:#f92672">--</span>;  <span style="color:#75715e">/* remove new frame */</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">goto</span> reentry;
</span></span><span style="display:flex;"><span>          }
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">case</span> PCRC: {  <span style="color:#75715e">/* it was a C function (`precall&#39; called it) */</span>
</span></span><span style="display:flex;"><span>            base <span style="color:#f92672">=</span> L<span style="color:#f92672">-&gt;</span>base;	<span style="color:#75715e">/* restore base */</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">continue</span>;
</span></span><span style="display:flex;"><span>          }
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">default</span><span style="color:#f92672">:</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span>;  <span style="color:#75715e">/* yield */</span>
</span></span><span style="display:flex;"><span>          }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">case</span> OP_RETURN: {
</span></span><span style="display:flex;"><span>	  	<span style="color:#75715e">/* return R(A), ... ,R(A+B-2) */</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">int</span> b <span style="color:#f92672">=</span> GETARG_B(i);	<span style="color:#75715e">/* 0：返回所有值，1：返回0个值，2：返回1个值 ... */</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (b <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>) <span style="color:#75715e">/* b==0其它的指令argvar等已处理好top,eg:(return ...)或者return(a, fun()) */</span>
</span></span><span style="display:flex;"><span>			L<span style="color:#f92672">-&gt;</span>top <span style="color:#f92672">=</span> ra<span style="color:#f92672">+</span>b<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;	<span style="color:#75715e">/* 以便确定返回值的确切个数 */</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (L<span style="color:#f92672">-&gt;</span>openupval) luaF_close(L, base);
</span></span><span style="display:flex;"><span>        L<span style="color:#f92672">-&gt;</span>savedpc <span style="color:#f92672">=</span> pc;
</span></span><span style="display:flex;"><span>        b <span style="color:#f92672">=</span> luaD_poscall(L, ra);	<span style="color:#75715e">/* 将子函数的返回值移到指定地方，并适配母函数的result要求 */</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">/* lua调用结束，返回值已经按照移动到指定的位置(本fun的addr)，且L-&gt;top指向了最后一个返回值的位置(可以用来计算返回值的个数)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">		   这里直接return，将CPU交换到母C函数 */</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (<span style="color:#f92672">--</span>nexeccalls <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>)  <span style="color:#75715e">/* was previous function running `here&#39;? Lua层面的调用结束了，结束lua的execute的执行，返回到C */</span>
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">return</span>;  <span style="color:#75715e">/* no: return */</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span> {  <span style="color:#75715e">/* yes: continue its execution */</span>
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">if</span> (b) <span style="color:#75715e">/* 同上注解100，请往上翻阅 */</span>
</span></span><span style="display:flex;"><span>		  	L<span style="color:#f92672">-&gt;</span>top <span style="color:#f92672">=</span> L<span style="color:#f92672">-&gt;</span>ci<span style="color:#f92672">-&gt;</span>top;	<span style="color:#75715e">/*  */</span>
</span></span><span style="display:flex;"><span>          lua_assert(isLua(L<span style="color:#f92672">-&gt;</span>ci)); <span style="color:#75715e">/* return后，lua连续调用链还没结束，那么上一层必然是个lua函数 */</span>
</span></span><span style="display:flex;"><span>          lua_assert(GET_OPCODE(<span style="color:#f92672">*</span>((L<span style="color:#f92672">-&gt;</span>ci)<span style="color:#f92672">-&gt;</span>savedpc <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>)) <span style="color:#f92672">==</span> OP_CALL);	<span style="color:#75715e">/* 上一个指令必然是call */</span>
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">goto</span> reentry;	<span style="color:#75715e">/* 切回到母lua的execute的frame */</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">case</span> OP_FORLOOP: {	<span style="color:#75715e">/* 先看 OP_FORPREP 指令 */</span>
</span></span><span style="display:flex;"><span>        lua_Number step <span style="color:#f92672">=</span> nvalue(ra<span style="color:#f92672">+</span><span style="color:#ae81ff">2</span>);
</span></span><span style="display:flex;"><span>        lua_Number idx <span style="color:#f92672">=</span> luai_numadd(nvalue(ra), step); <span style="color:#75715e">/* increment index */</span>
</span></span><span style="display:flex;"><span>        lua_Number limit <span style="color:#f92672">=</span> nvalue(ra<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (luai_numlt(<span style="color:#ae81ff">0</span>, step) <span style="color:#f92672">?</span> luai_numle(idx, limit)
</span></span><span style="display:flex;"><span>                                <span style="color:#f92672">:</span> luai_numle(limit, idx)) {
</span></span><span style="display:flex;"><span>          dojump(L, pc, GETARG_sBx(i));  <span style="color:#75715e">/* jump back */</span>
</span></span><span style="display:flex;"><span>          setnvalue(ra, idx);  <span style="color:#75715e">/* update internal index... */</span>
</span></span><span style="display:flex;"><span>          setnvalue(ra<span style="color:#f92672">+</span><span style="color:#ae81ff">3</span>, idx);  <span style="color:#75715e">/* ...and external index 这个idx才是暴露给for循环里面的i(for i = 0; 10; 1) */</span> 
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">continue</span>;
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">case</span> OP_FORPREP: {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">const</span> TValue <span style="color:#f92672">*</span>init <span style="color:#f92672">=</span> ra;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">const</span> TValue <span style="color:#f92672">*</span>plimit <span style="color:#f92672">=</span> ra<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">const</span> TValue <span style="color:#f92672">*</span>pstep <span style="color:#f92672">=</span> ra<span style="color:#f92672">+</span><span style="color:#ae81ff">2</span>;
</span></span><span style="display:flex;"><span>        L<span style="color:#f92672">-&gt;</span>savedpc <span style="color:#f92672">=</span> pc;  <span style="color:#75715e">/* next steps may throw errors */</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>tonumber(init, ra))
</span></span><span style="display:flex;"><span>          luaG_runerror(L, LUA_QL(<span style="color:#e6db74">&#34;for&#34;</span>) <span style="color:#e6db74">&#34; initial value must be a number&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>tonumber(plimit, ra<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>))
</span></span><span style="display:flex;"><span>          luaG_runerror(L, LUA_QL(<span style="color:#e6db74">&#34;for&#34;</span>) <span style="color:#e6db74">&#34; limit must be a number&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>tonumber(pstep, ra<span style="color:#f92672">+</span><span style="color:#ae81ff">2</span>))
</span></span><span style="display:flex;"><span>          luaG_runerror(L, LUA_QL(<span style="color:#e6db74">&#34;for&#34;</span>) <span style="color:#e6db74">&#34; step must be a number&#34;</span>);
</span></span><span style="display:flex;"><span>        setnvalue(ra, luai_numsub(nvalue(ra), nvalue(pstep)));	<span style="color:#75715e">/* 这里提前-=step */</span>
</span></span><span style="display:flex;"><span>        dojump(L, pc, GETARG_sBx(i));	<span style="color:#75715e">/* 跳到cond判断那里 */</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">continue</span>;
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">case</span> OP_TFORLOOP: {
</span></span><span style="display:flex;"><span>	  	<span style="color:#75715e">/* 编译模块保证了ra+3是个有意义的参数 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	  	** next函数会吃掉传入的参数，所以这里CP了一份
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	    */</span>
</span></span><span style="display:flex;"><span>	    <span style="color:#75715e">/* 结合 http://shankusu.me/lua/ANo-FrillsIntroductiontoLua51VMInstructions/ 文档来看，更容易理解 */</span>
</span></span><span style="display:flex;"><span>        StkId cb <span style="color:#f92672">=</span> ra <span style="color:#f92672">+</span> <span style="color:#ae81ff">3</span>;  <span style="color:#75715e">/* call base */</span>
</span></span><span style="display:flex;"><span>        setobjs2s(L, cb<span style="color:#f92672">+</span><span style="color:#ae81ff">2</span>, ra<span style="color:#f92672">+</span><span style="color:#ae81ff">2</span>);
</span></span><span style="display:flex;"><span>        setobjs2s(L, cb<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>, ra<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>        setobjs2s(L, cb, ra);
</span></span><span style="display:flex;"><span>        L<span style="color:#f92672">-&gt;</span>top <span style="color:#f92672">=</span> cb<span style="color:#f92672">+</span><span style="color:#ae81ff">3</span>;  <span style="color:#75715e">/* func. + 2 args (state and index) */</span>
</span></span><span style="display:flex;"><span>        Protect(luaD_call(L, cb, GETARG_C(i)));
</span></span><span style="display:flex;"><span>        L<span style="color:#f92672">-&gt;</span>top <span style="color:#f92672">=</span> L<span style="color:#f92672">-&gt;</span>ci<span style="color:#f92672">-&gt;</span>top;
</span></span><span style="display:flex;"><span>        cb <span style="color:#f92672">=</span> RA(i) <span style="color:#f92672">+</span> <span style="color:#ae81ff">3</span>;  <span style="color:#75715e">/* previous call may change the stack */</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>ttisnil(cb)) {  <span style="color:#75715e">/* continue loop? */</span>
</span></span><span style="display:flex;"><span>          setobjs2s(L, cb<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>, cb);  <span style="color:#75715e">/* save control variable */</span>
</span></span><span style="display:flex;"><span>          dojump(L, pc, GETARG_sBx(<span style="color:#f92672">*</span>pc));  <span style="color:#75715e">/* jump back */</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        pc<span style="color:#f92672">++</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">continue</span>;
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">case</span> OP_SETLIST: {	<span style="color:#75715e">/* local t = {...} 本指令之前可能会有一条vararg或local t2={fun(...)}产生的OP_CALL，所以结合vararg来理解本block的代码 */</span>
</span></span><span style="display:flex;"><span>	  	<span style="color:#75715e">/* A B C	R(A)[(C-1)*FPF+i] := R(A+i), 1 &lt;= i &lt;= B */</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">int</span> n <span style="color:#f92672">=</span> GETARG_B(i);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">int</span> c <span style="color:#f92672">=</span> GETARG_C(i);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">int</span> last;
</span></span><span style="display:flex;"><span>        Table <span style="color:#f92672">*</span>h;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (n <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) {	
</span></span><span style="display:flex;"><span>          n <span style="color:#f92672">=</span> cast_int(L<span style="color:#f92672">-&gt;</span>top <span style="color:#f92672">-</span> ra) <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>;	<span style="color:#75715e">/* 计算确切的参数个数 */</span>
</span></span><span style="display:flex;"><span>          L<span style="color:#f92672">-&gt;</span>top <span style="color:#f92672">=</span> L<span style="color:#f92672">-&gt;</span>ci<span style="color:#f92672">-&gt;</span>top;	<span style="color:#75715e">/* OP_VARARG指令L-&gt;top已经指向了{...}不定参数的最后一个slot的位置以便求n,这里将其复原 */</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (c <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) c <span style="color:#f92672">=</span> cast_int(<span style="color:#f92672">*</span>pc<span style="color:#f92672">++</span>);	<span style="color:#75715e">/* 这行代码最好有个印象 */</span>
</span></span><span style="display:flex;"><span>        runtime_check(L, ttistable(ra));	<span style="color:#75715e">/* 编译模块出错了 */</span>
</span></span><span style="display:flex;"><span>        h <span style="color:#f92672">=</span> hvalue(ra);
</span></span><span style="display:flex;"><span>        last <span style="color:#f92672">=</span> ((c<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>)<span style="color:#f92672">*</span>LFIELDS_PER_FLUSH) <span style="color:#f92672">+</span> n;	<span style="color:#75715e">/* 计算当前能确定的数组下标的最大值 */</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (last <span style="color:#f92672">&gt;</span> h<span style="color:#f92672">-&gt;</span>sizearray)  <span style="color:#75715e">/* needs more space?  数组区域大小不够，需扩展*/</span>
</span></span><span style="display:flex;"><span>          luaH_resizearray(L, h, last);  <span style="color:#75715e">/* pre-alloc it at once */</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> (; n <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>; n<span style="color:#f92672">--</span>) {
</span></span><span style="display:flex;"><span>          TValue <span style="color:#f92672">*</span>val <span style="color:#f92672">=</span> ra<span style="color:#f92672">+</span>n;
</span></span><span style="display:flex;"><span>          setobj2t(L, luaH_setnum(L, h, last<span style="color:#f92672">--</span>), val);
</span></span><span style="display:flex;"><span>          luaC_barriert(L, h, val);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">continue</span>;
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">case</span> OP_CLOSE: {
</span></span><span style="display:flex;"><span>	  	<span style="color:#75715e">/* close all variables in the stack up to (&gt;=) R(A) 编译模块如何确定参数A？*/</span>
</span></span><span style="display:flex;"><span>        luaF_close(L, ra);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">continue</span>;
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">case</span> OP_CLOSURE: {
</span></span><span style="display:flex;"><span>	  	<span style="color:#75715e">/* A Bx	R(A) := closure(KPROTO[Bx], R(A), ... ,R(A+n)) */</span>
</span></span><span style="display:flex;"><span>        Proto <span style="color:#f92672">*</span>p;
</span></span><span style="display:flex;"><span>        Closure <span style="color:#f92672">*</span>ncl;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">int</span> nup, j;
</span></span><span style="display:flex;"><span>        p <span style="color:#f92672">=</span> cl<span style="color:#f92672">-&gt;</span>p<span style="color:#f92672">-&gt;</span>p[GETARG_Bx(i)];	<span style="color:#75715e">/* 找到对应的proto */</span>
</span></span><span style="display:flex;"><span>        nup <span style="color:#f92672">=</span> p<span style="color:#f92672">-&gt;</span>nups;
</span></span><span style="display:flex;"><span>        ncl <span style="color:#f92672">=</span> luaF_newLclosure(L, nup, cl<span style="color:#f92672">-&gt;</span>env);
</span></span><span style="display:flex;"><span>        ncl<span style="color:#f92672">-&gt;</span>l.p <span style="color:#f92672">=</span> p;
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">/* 下面的block尚未完全看懂 */</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> (j<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>; j<span style="color:#f92672">&lt;</span>nup; j<span style="color:#f92672">++</span>, pc<span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">if</span> (GET_OPCODE(<span style="color:#f92672">*</span>pc) <span style="color:#f92672">==</span> OP_GETUPVAL)
</span></span><span style="display:flex;"><span>            ncl<span style="color:#f92672">-&gt;</span>l.upvals[j] <span style="color:#f92672">=</span> cl<span style="color:#f92672">-&gt;</span>upvals[GETARG_B(<span style="color:#f92672">*</span>pc)];
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>            lua_assert(GET_OPCODE(<span style="color:#f92672">*</span>pc) <span style="color:#f92672">==</span> OP_MOVE);
</span></span><span style="display:flex;"><span>            ncl<span style="color:#f92672">-&gt;</span>l.upvals[j] <span style="color:#f92672">=</span> luaF_findupval(L, base <span style="color:#f92672">+</span> GETARG_B(<span style="color:#f92672">*</span>pc));
</span></span><span style="display:flex;"><span>          }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        setclvalue(L, ra, ncl);
</span></span><span style="display:flex;"><span>        Protect(luaC_checkGC(L));
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">continue</span>;
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">case</span> OP_VARARG: {
</span></span><span style="display:flex;"><span>	  	<span style="color:#75715e">/* A B	R(A), R(A+1), ..., R(A+B-1) = vararg */</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">int</span> b <span style="color:#f92672">=</span> GETARG_B(i) <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">int</span> j;
</span></span><span style="display:flex;"><span>        CallInfo <span style="color:#f92672">*</span>ci <span style="color:#f92672">=</span> L<span style="color:#f92672">-&gt;</span>ci;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">int</span> n <span style="color:#f92672">=</span> cast_int(ci<span style="color:#f92672">-&gt;</span>base <span style="color:#f92672">-</span> ci<span style="color:#f92672">-&gt;</span>func) <span style="color:#f92672">-</span> cl<span style="color:#f92672">-&gt;</span>p<span style="color:#f92672">-&gt;</span>numparams <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>;	<span style="color:#75715e">/* 本次函数调用传入的不定参数的个数eg: funA(a,b, ...) funA */</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (b <span style="color:#f92672">==</span> LUA_MULTRET) {
</span></span><span style="display:flex;"><span>          Protect(luaD_checkstack(L, n));
</span></span><span style="display:flex;"><span>          ra <span style="color:#f92672">=</span> RA(i);  <span style="color:#75715e">/* previous call may change the stack */</span>
</span></span><span style="display:flex;"><span>          b <span style="color:#f92672">=</span> n;	<span style="color:#75715e">/* 出现在 local tbl = {...} 或者 funA(...) 需要拷贝所有的不定参数的地方 */</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		  <span style="color:#75715e">/* 为可能即将到来的C/lua函数调用做准备，(L-&gt;top-func可知即将发生的函数调用实际上有多少个传入参数) 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">		  ** 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">		  ** local tbl={...} OP_SETLIST指令也用到了L-&gt;top，故而可以推断出，这里L-&gt;top标记了实际上...携带的参数个数
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">		  ** 以便其它指令能准确的执行(主要是获取..参数个数)，这里将实际传入的参数个数通过L-&gt;top计算好，避免其它指令再去计算一遍
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">		  ** 其它指令用完L-&gt;top后需将其复原
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">		  */</span>
</span></span><span style="display:flex;"><span>          L<span style="color:#f92672">-&gt;</span>top <span style="color:#f92672">=</span> ra <span style="color:#f92672">+</span> n; 
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">/* 将不定参数赋值给指定的对象？？？
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">		** local a, b = ...
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">		** 不定参数数量不足则补nil
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">		*/</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> (j <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; j <span style="color:#f92672">&lt;</span> b; j<span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">if</span> (j <span style="color:#f92672">&lt;</span> n) {	<span style="color:#75715e">/* 本函数的不定参数的个数还能满足ra+j代表的dst寄存器 */</span>
</span></span><span style="display:flex;"><span>            setobjs2s(L, ra <span style="color:#f92672">+</span> j, ci<span style="color:#f92672">-&gt;</span>base <span style="color:#f92672">-</span> n <span style="color:#f92672">+</span> j);
</span></span><span style="display:flex;"><span>          }
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>            setnilvalue(ra <span style="color:#f92672">+</span> j);	<span style="color:#75715e">/* local a, b = ... 本函数实际上只收到了一个不定参数，那么不足的部分(b)就要补nil值了 */</span>
</span></span><span style="display:flex;"><span>          }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">continue</span>;
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div>
    </div>
    <footer class="post-footer">
     
 
<div class="post-tags">     
     
    <a href="http://shanks.link/tags/lua" rel="tag" title="lua">#lua#</a>
    
</div>



     <div class="post-nav">
    <div class="post-nav-next post-nav-item">
    
        <a href="http://shanks.link/links/" rel="next" title="友连">
        <i class="fa fa-chevron-left"></i> 友连
        </a>
    
    </div>

    <div class="post-nav-prev post-nav-item">
    
        <a href="http://shanks.link/blog/2021/05/20/lua%E6%BA%90%E7%A0%81%E6%B3%A8%E9%87%8A-ltable.c/" rel="prev" title="lua源码注释-ltable.c">
        lua源码注释-ltable.c <i class="fa fa-chevron-right"></i>
        </a>
    
    </div>
</div>
      
     
     
     





<script src="https://utteranc.es/client.js"
        repo="shankusu2017@gmail.com/"
        issue-term="pathname"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>
<noscript>Please enable JavaScript to view the <a href="https://github.com/utterance">comments powered by utterances.</a></noscript>

    </footer>
  </article>
</section>

          </div>
        </div>
        <div class="sidebar-toggle">
  <div class="sidebar-toggle-line-wrap">
    <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
    <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
    <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
  </div>
</div>
<aside id="sidebar" class="sidebar">
  <div class="sidebar-inner">

    <section class="site-overview sidebar-panel  sidebar-panel-active ">
      <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image"
        src="http://shanks.link/img/logo.jpg"
        alt="shankusu2017@gmail.com" />
    <p class="site-author-name" itemprop="name">shankusu2017@gmail.com</p>
    <p class="site-description motion-element" itemprop="description"> </p>
</div>
      <nav class="site-state motion-element">
    <div class="site-state-item site-state-posts">
      <a href="http://shanks.link/post/">
        <span class="site-state-item-count">472</span>
        <span class="site-state-item-name">日志</span>
      </a>
    </div>
    <div class="site-state-item site-state-categories">    
        <a href="http://shanks.link/categories/">      
         
        <span class="site-state-item-count">29</span>
        
        <span class="site-state-item-name">分类</span>
        
        </a>
    </div>

    <div class="site-state-item site-state-tags">
        <a href="http://shanks.link/tags/">
         
        <span class="site-state-item-count">34</span>
        
        <span class="site-state-item-name">标签</span>
        </a>
    </div>
</nav>
      
      
<div class="links-of-author motion-element">
    
        <span class="links-of-author-item">
        <a href="https://github.com/shankusu2017" target="_blank" title="GitHub">
            <i class="fa fa-fw fa-github"></i>
            GitHub
        </a>
        </span>
    
</div>


      

      <div class="links-of-blogroll motion-element inline">
<script type="text/javascript" src="//rf.revolvermaps.com/0/0/8.js?i=5b4f2ucxar6&amp;m=0&amp;s=220&amp;c=ff0000&amp;cr1=ffffff&amp;f=arial&amp;l=33&amp;bv=35" async="async"></script>
</div>

    </section>
    
  </div>
</aside>

      </div>
    </main>
   
    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  <span itemprop="copyrightYear">  &copy; 
  2009 - 2022</span>
  <span class="with-love"><i class="fa fa-heart"></i></span>
  <span class="author" itemprop="copyrightHolder">愿星光伴你左右</span>
</div>
<div class="powered-by">
  Powered by - <a class="theme-link" href="http://gohugo.io" target="_blank" title="hugo" >Hugo v0.101.0</a>
</div>
<div class="theme-info">
  Theme by - <a class="theme-link" href="https://github.com/xtfly/hugo-theme-next" target="_blank"> NexT
  </a>
</div>


      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
      <span id="scrollpercent"><span>0</span>%</span>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>
<script type="text/javascript" src="http://shanks.link/js/vendor/jquery/index.js?v=2.1.3"></script>
<script type="text/javascript" src="http://shanks.link/js/vendor/fastclick/lib/fastclick.min.js?v=1.0.6"></script> 
<script type="text/javascript" src="http://shanks.link/js/vendor/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
<script type="text/javascript" src="http://shanks.link/js/vendor/velocity/velocity.min.js?v=1.2.1"></script>
<script type="text/javascript" src="http://shanks.link/js/vendor/velocity/velocity.ui.min.js?v=1.2.1"></script>
<script src="http://shanks.link/js/vendor/ua-parser-js/dist/ua-parser.min.js?v=0.7.9"></script>

<script src="http://shanks.link/js/vendor/fancybox/jquery.fancybox.pack.js?v=2.1.5"></script>

<script type="text/javascript" src="http://shanks.link/js/utils.js"></script>
<script type="text/javascript" src="http://shanks.link/js/motion.js"></script>
<script type="text/javascript" src="http://shanks.link/js/affix.js"></script>
<script type="text/javascript" src="http://shanks.link/js/schemes/pisces.js"></script>

<script type="text/javascript" src="http://shanks.link/js/scrollspy.js"></script>
<script type="text/javascript" src="http://shanks.link/js/post-details.js"></script>
<script type="text/javascript" src="http://shanks.link/js/toc.js"></script>

<script type="text/javascript" src="http://shanks.link/js/bootstrap.js"></script>

<script type="text/javascript" src="http://shanks.link/js/search.js"></script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX", "output/HTML-CSS"],
    tex2jax: {
      inlineMath: [ ['$','$'] ],
      displayMath: [ ['$$','$$'] ],
      processEscapes: true
    },
    "HTML-CSS": { fonts: ["TeX"] }
  });
</script>
<script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML' async></script>
</body>
</html>