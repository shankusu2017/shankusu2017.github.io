<!DOCTYPE HTML>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" /> 
    <title>Go的string与[]byte转换原理 - 愿星光伴你左右</title>
    <meta name="keywords" content="Lua,lua,Golang,go">
    
    <meta property="og:title" content="Go的string与[]byte转换原理">
    <meta property="og:site_name" content="愿星光伴你左右">
    <meta property="og:image" content="/img/author.jpg"> 
    <meta name="title" content="Go的string与[]byte转换原理 - 愿星光伴你左右" />
    <meta name="description" content="愿星光伴你左右"> 
    <link rel="shortcut icon" href="http://shanks.link/img/favicon.ico" />
    <link rel="apple-touch-icon" href="http://shanks.link/img/apple-touch-icon.png" />
    <link rel="apple-touch-icon-precomposed" href="http://shanks.link/img/apple-touch-icon.png" />
    <link href="http://shanks.link/js/vendor/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />
    <link href="http://shanks.link/js/vendor/fancybox/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />
    <link href="http://shanks.link/css/main.css" rel="stylesheet" type="text/css" />
    <link href="http://shanks.link/css/syntax.css" rel="stylesheet" type="text/css" />
    <script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post"},
     fancybox: true, 
    motion: true
  };
</script>
</head>
<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">
<div class="container one-collumn sidebar-position-left page-home  ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"> <div class="site-meta  custom-logo ">

  <div class="custom-logo-site-title">
    <a href="http://shanks.link/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">愿星光伴你左右</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle"></p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
    <ul id="menu" class="menu">
      
      
        <li class="menu-item ">
          <a href="http://shanks.link/post/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />首页
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/lua/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />lua
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/go/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />Golang
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/thinking/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />随想录
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/prose/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />散文
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/%E7%94%9F%E6%B4%BB/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />生活
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/os/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />OS
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/redis/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />redis
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/about/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />About Me
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/links/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />友情链接
          </a>
        </li>
      
      <li class="menu-item menu-item-search">
        <a href="javascript:;" class="popup-trigger"> <i class="menu-item-icon fa fa-search fa-fw"></i> <br /> 搜索</a>
      </li>
    </ul>
    <div class="site-search">
      <div class="popup">
 <span class="search-icon fa fa-search"></span>
 <input type="text" id="local-search-input">
 <div id="local-search-result"></div>
 <span class="popup-btn-close">close</span>
</div>

    </div>
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
<section id="posts" class="posts-expand">
  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <header class="post-header">
      <h1 class="post-title" itemprop="name headline">
        <a class="post-title-link" href="http://shanks.link/blog/2021/04/27/go%E7%9A%84string%E4%B8%8Ebyte%E8%BD%AC%E6%8D%A2%E5%8E%9F%E7%90%86/" itemprop="url">
        Go的string与[]byte转换原理
        </a>
      </h1>
      <div class="post-meta">
      <span class="post-time">
<span class="post-meta-item-icon">
    <i class="fa fa-calendar-o"></i>
</span>
<span class="post-meta-item-text">时间：</span>
<time itemprop="dateCreated" datetime="2016-03-22T13:04:35+08:00" content="2021-04-27">
    2021-04-27
</time>
</span> 
      

  <span class="post-category" >
  &nbsp; | &nbsp;
  <span class="post-meta-item-icon">
    <i class="fa fa-folder-o"></i>
  </span>
  <span class="post-meta-item-text">分类：</span>
  
    <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
      <a href="http://shanks.link/categories/go" itemprop="url" rel="index">
        <span itemprop="name">go</span>
      </a>
      &nbsp; 
    </span>
  
</span>


       <span>
&nbsp; | &nbsp;
<span class="post-meta-item-icon">
    <i class="fa fa-eye"></i>
</span>
<span class="post-meta-item-text">阅读：</span>
<span class="leancloud-visitors-count">4338 字 ~9分钟</span>
</span>
      </div>
    </header>
    <div class="post-body" itemprop="articleBody">
    <p>string类型和[]byte类型是我们编程时最常使用到的数据结构。本文将探讨两者之间的转换方式，通过分析它们之间的内在联系来拨开迷雾。</p>
<p><strong>两种转换方式</strong></p>
<ul>
<li><strong>标准转换</strong></li>
</ul>
<p>go中string与[]byte的互换，相信每一位gopher都能立刻想到以下的转换方式，我们将之称为标准转换。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">// string to []byte
s1 := &#34;hello&#34;
b := []byte(s1)

// []byte to string
s2 := string(b)
</code></pre></div><ul>
<li><strong>强转换</strong></li>
</ul>
<p>通过unsafe和reflect包，可以实现另外一种转换方式，我们将之称为强转换（也常常被人称作黑魔法）。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback"> func String2Bytes(s string) []byte {
     sh := (*reflect.StringHeader)(unsafe.Pointer(&amp;s))
     bh := reflect.SliceHeader{
         Data: sh.Data,
         Len:  sh.Len,
         Cap:  sh.Len,
     }
     return *(*[]byte)(unsafe.Pointer(&amp;bh))
 }

func Bytes2String(b []byte) string {
    return *(*string)(unsafe.Pointer(&amp;b))
}
</code></pre></div><ul>
<li>
<h4 id="性能对比"><strong>性能对比</strong></h4>
</li>
</ul>
<p>既然有两种转换方式，那么我们有必要对它们做性能对比。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback"> 1// 测试强转换功能
 2func TestBytes2String(t *testing.T) {
 3    x := []byte(&#34;Hello Gopher!&#34;)
 4    y := Bytes2String(x)
 5    z := string(x)
 6
 7    if y != z {
 8        t.Fail()
 9    }
10}
11
12// 测试强转换功能
13func TestString2Bytes(t *testing.T) {
14    x := &#34;Hello Gopher!&#34;
15    y := String2Bytes(x)
16    z := []byte(x)
17
18    if !bytes.Equal(y, z) {
19        t.Fail()
20    }
21}
22
23// 测试标准转换string()性能
24func Benchmark_NormalBytes2String(b *testing.B) {
25    x := []byte(&#34;Hello Gopher! Hello Gopher! Hello Gopher!&#34;)
26    for i := 0; i &lt; b.N; i++ {
27        _ = string(x)
28    }
29}
30
31// 测试强转换[]byte到string性能
32func Benchmark_Byte2String(b *testing.B) {
33    x := []byte(&#34;Hello Gopher! Hello Gopher! Hello Gopher!&#34;)
34    for i := 0; i &lt; b.N; i++ {
35        _ = Bytes2String(x)
36    }
37}
38
39// 测试标准转换[]byte性能
40func Benchmark_NormalString2Bytes(b *testing.B) {
41    x := &#34;Hello Gopher! Hello Gopher! Hello Gopher!&#34;
42    for i := 0; i &lt; b.N; i++ {
43        _ = []byte(x)
44    }
45}
46
47// 测试强转换string到[]byte性能
48func Benchmark_String2Bytes(b *testing.B) {
49    x := &#34;Hello Gopher! Hello Gopher! Hello Gopher!&#34;
50    for i := 0; i &lt; b.N; i++ {
51        _ = String2Bytes(x)
52    }
53}
</code></pre></div><p>测试结果如下</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback"> 1$ go test -bench=&#34;.&#34; -benchmem
 2goos: darwin
 3goarch: amd64
 4pkg: workspace/example/stringBytes
 5Benchmark_NormalBytes2String-8          38363413                27.9 ns/op            48 B/op          1 allocs/op
 6Benchmark_Byte2String-8                 1000000000               0.265 ns/op           0 B/op          0 allocs/op
 7Benchmark_NormalString2Bytes-8          32577080                34.8 ns/op            48 B/op          1 allocs/op
 8Benchmark_String2Bytes-8                1000000000               0.532 ns/op           0 B/op          0 allocs/op
 9PASS
10ok      workspace/example/stringBytes   3.170s
</code></pre></div><p>注意，<code>-benchmem</code>可以提供每次操作分配内存的次数，以及每次操作分配的字节数。</p>
<p>当x的数据均为&quot;Hello Gopher!&ldquo;时，测试结果如下</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback"> 1$ go test -bench=&#34;.&#34; -benchmem
 2goos: darwin
 3goarch: amd64
 4pkg: workspace/example/stringBytes
 5Benchmark_NormalBytes2String-8          245907674                4.86 ns/op            0 B/op          0 allocs/op
 6Benchmark_Byte2String-8                 1000000000               0.266 ns/op           0 B/op          0 allocs/op
 7Benchmark_NormalString2Bytes-8          202329386                5.92 ns/op            0 B/op          0 allocs/op
 8Benchmark_String2Bytes-8                1000000000               0.532 ns/op           0 B/op          0 allocs/op
 9PASS
10ok      workspace/example/stringBytes   4.383s
</code></pre></div><p><strong>强转换方式的性能会明显优于标准转换。</strong></p>
<p>**
**</p>
<p>读者可以思考以下问题</p>
<p>1.为什么强转换性能会比标准转换好？</p>
<p>2.为什么在上述测试中，当x的数据较大时，标准转换方式会有一次分配内存的操作，从而导致其性能更差，而强转换方式却不受影响？</p>
<p>3.既然强转换方式性能这么好，为什么go语言提供给我们使用的是标准转换方式？</p>
<p><strong>原理分析</strong></p>
<p>要回答以上三个问题，首先要明白是string和[]byte在go中到底是什么。</p>
<ul>
<li>
<h4 id="byte">[]byte</h4>
</li>
</ul>
<p>在go中，byte是uint8的别名，在go标准库builtin中有如下说明：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">1// byte is an alias for uint8 and is equivalent to uint8 in all ways. It is
2// used, by convention, to distinguish byte values from 8-bit unsigned
3// integer values.
4type byte = uint8
</code></pre></div><p>在go的源码中<code>src/runtime/slice.go</code>，slice的定义如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">1type slice struct {
2    array unsafe.Pointer
3    len   int
4    cap   int
5}
</code></pre></div><p>array是底层数组的指针，len表示长度，cap表示容量。对于[]byte来说，array指向的就是byte数组。</p>
<p><img src="http://shanks.link/img/Go%E4%B9%8Bstring%E4%B8%8Ebyte%E8%BD%AC%E6%8D%A2%E7%9A%84%E5%8E%9F%E7%90%86/1.png" alt="img"></p>
<ul>
<li>
<h4 id="string">string</h4>
</li>
</ul>
<p>关于string类型，在go标准库builtin中有如下说明：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">// string is the set of all strings of 8-bit bytes, conventionally but not
// necessarily representing UTF-8-encoded text. A string may be empty, but
// not nil. Values of string type are immutable.
type string string
</code></pre></div><p>翻译过来就是：string是8位字节的集合，通常但不一定代表UTF-8编码的文本。string可以为空，但是不能为nil。<strong>string的值是不能改变的</strong>。</p>
<p>在go的源码中<code>src/runtime/string.go</code>，string的定义如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">1type stringStruct struct {
2    str unsafe.Pointer
3    len int
4}
</code></pre></div><p>stringStruct代表的就是一个string对象，str指针指向的是某个数组的首地址，len代表的数组长度。那么这个数组是什么呢？我们可以在实例化stringStruct对象时找到答案。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">1//go:nosplit
2func gostringnocopy(str *byte) string {
3    ss := stringStruct{str: unsafe.Pointer(str), len: findnull(str)}
4    s := *(*string)(unsafe.Pointer(&amp;ss))
5    return s
6}
</code></pre></div><p>可以看到，入参str指针就是指向byte的指针，那么我们可以确定string的底层数据结构就是byte数组。</p>
<p><img src="http://shanks.link/img/Go%E4%B9%8Bstring%E4%B8%8Ebyte%E8%BD%AC%E6%8D%A2%E7%9A%84%E5%8E%9F%E7%90%86/2.png" alt="img"></p>
<p>综上，string与[]byte在底层结构上是非常的相近（后者的底层表达仅多了一个cap属性，因此它们在内存布局上是可对齐的），这也就是为何builtin中内置函数copy会有一种特殊情况<code>copy(dst []byte, src string) int</code>的原因了。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">1// The copy built-in function copies elements from a source slice into a
2// destination slice. (As a special case, it also will copy bytes from a
3// string to a slice of bytes.) The source and destination may overlap. Copy
4// returns the number of elements copied, which will be the minimum of
5// len(src) and len(dst).
6func copy(dst, src []Type) int
7
</code></pre></div><ul>
<li>
<h4 id="区别">区别</h4>
</li>
</ul>
<p>对于[]byte与string而言，两者之间最大的区别就是string的值不能改变。这该如何理解呢？下面通过两个例子来说明。</p>
<p>对于[]byte来说，以下操作是可行的：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">1b := []byte(&#34;Hello Gopher!&#34;)
2b [1] = &#39;T&#39;
</code></pre></div><p>string，修改操作是被禁止的：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">1s := &#34;Hello Gopher!&#34;
2s[1] = &#39;T&#39;
</code></pre></div><p>而string能支持这样的操作：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">1s := &#34;Hello Gopher!&#34;
2s = &#34;Tello Gopher!&#34;
</code></pre></div><p>字符串的值不能被更改，但可以被替换。string在底层都是结构体<code>stringStruct{str: str_point, len: str_len}</code>，string结构体的str指针指向的是一个字符常量的地址， 这个地址里面的内容是不可以被改变的，因为它是只读的，但是这个指针可以指向不同的地址。</p>
<p>那么，以下操作的含义是不同的：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">1s := &#34;S1&#34; // 分配存储&#34;S1&#34;的内存空间，s结构体里的str指针指向这块内存
2s = &#34;S2&#34;  // 分配存储&#34;S2&#34;的内存空间，s结构体里的str指针转为指向这块内存
3
4b := []byte{1} // 分配存储&#39;1&#39;数组的内存空间，b结构体的array指针指向这个数组。
5b = []byte{2}  // 将array的内容改为&#39;2&#39;
</code></pre></div><p>图解如下</p>
<p><img src="http://shanks.link/img/Go%E4%B9%8Bstring%E4%B8%8Ebyte%E8%BD%AC%E6%8D%A2%E7%9A%84%E5%8E%9F%E7%90%86/3.png" alt="img"></p>
<p>因为string的指针指向的内容是不可以更改的，所以每更改一次字符串，就得重新分配一次内存，之前分配的空间还需要gc回收，这是导致string相较于[]byte操作低效的根本原因。</p>
<ul>
<li>
<h4 id="标准转换的实现细节">标准转换的实现细节</h4>
</li>
</ul>
<p>[]byte(string)的实现（源码在<code>src/runtime/string.go</code>中）</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback"> 1// The constant is known to the compiler.
 2// There is no fundamental theory behind this number.
 3const tmpStringBufSize = 32
 4
 5type tmpBuf [tmpStringBufSize]byte
 6
 7func stringtoslicebyte(buf *tmpBuf, s string) []byte {
 8    var b []byte
 9    if buf != nil &amp;&amp; len(s) &lt;= len(buf) {
10        *buf = tmpBuf{}
11        b = buf[:len(s)]
12    } else {
13        b = rawbyteslice(len(s))
14    }
15    copy(b, s)
16    return b
17}
18
19// rawbyteslice allocates a new byte slice. The byte slice is not zeroed.
20func rawbyteslice(size int) (b []byte) {
21    cap := roundupsize(uintptr(size))
22    p := mallocgc(cap, nil, false)
23    if cap != uintptr(size) {
24        memclrNoHeapPointers(add(p, uintptr(size)), cap-uintptr(size))
25    }
26
27    *(*slice)(unsafe.Pointer(&amp;b)) = slice{p, size, int(cap)}
28    return
29}
</code></pre></div><p>这里有两种情况：s的长度是否大于32。当大于32时，go需要调用mallocgc分配一块新的内存（大小由s决定），这也就回答了上文中的问题2：当x的数据较大时，标准转换方式会有一次分配内存的操作。</p>
<p>最后通过copy函数实现string到[]byte的拷贝，具体实现在<code>src/runtime/slice.go</code>中的<code>slicestringcopy</code>方法。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback"> 1func slicestringcopy(to []byte, fm string) int {
 2    if len(fm) == 0 || len(to) == 0 {
 3        return 0
 4    }
 5
 6  // copy的长度取决与string和[]byte的长度最小值
 7    n := len(fm)
 8    if len(to) &lt; n {
 9        n = len(to)
10    }
11
12  // 如果开启了竞态检测 -race
13    if raceenabled {
14        callerpc := getcallerpc()
15        pc := funcPC(slicestringcopy)
16        racewriterangepc(unsafe.Pointer(&amp;to[0]), uintptr(n), callerpc, pc)
17    }
18  // 如果开启了memory sanitizer -msan
19    if msanenabled {
20        msanwrite(unsafe.Pointer(&amp;to[0]), uintptr(n))
21    }
22
23  // 该方法将string的底层数组从头部复制n个到[]byte对应的底层数组中去（这里就是copy实现的核心方法，在汇编层面实现 源文件为memmove_*.s）
24    memmove(unsafe.Pointer(&amp;to[0]), stringStructOf(&amp;fm).str, uintptr(n))
25    return n
26}
</code></pre></div><p>copy实现过程图解如下</p>
<p><img src="http://shanks.link/img/Go%E4%B9%8Bstring%E4%B8%8Ebyte%E8%BD%AC%E6%8D%A2%E7%9A%84%E5%8E%9F%E7%90%86/4.png" alt="img"></p>
<p>string([]byte)的实现（源码也在<code>src/runtime/string.go</code>中）</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback"> 1// Buf is a fixed-size buffer for the result,
 2// it is not nil if the result does not escape.
 3func slicebytetostring(buf *tmpBuf, b []byte) (str string) {
 4    l := len(b)
 5    if l == 0 {
 6        // Turns out to be a relatively common case.
 7        // Consider that you want to parse out data between parens in &#34;foo()bar&#34;,
 8        // you find the indices and convert the subslice to string.
 9        return &#34;&#34;
10    }
11  // 如果开启了竞态检测 -race
12    if raceenabled {
13        racereadrangepc(unsafe.Pointer(&amp;b[0]),
14            uintptr(l),
15            getcallerpc(),
16            funcPC(slicebytetostring))
17    }
18  // 如果开启了memory sanitizer -msan
19    if msanenabled {
20        msanread(unsafe.Pointer(&amp;b[0]), uintptr(l))
21    }
22    if l == 1 {
23        stringStructOf(&amp;str).str = unsafe.Pointer(&amp;staticbytes[b[0]])
24        stringStructOf(&amp;str).len = 1
25        return
26    }
27
28    var p unsafe.Pointer
29    if buf != nil &amp;&amp; len(b) &lt;= len(buf) {
30        p = unsafe.Pointer(buf)
31    } else {
32        p = mallocgc(uintptr(len(b)), nil, false)
33    }
34    stringStructOf(&amp;str).str = p
35    stringStructOf(&amp;str).len = len(b)
36  // 拷贝字节数组至字符串
37    memmove(p, (*(*slice)(unsafe.Pointer(&amp;b))).array, uintptr(len(b)))
38    return
39}
40
41// 实例stringStruct对象
42func stringStructOf(sp *string) *stringStruct {
43    return (*stringStruct)(unsafe.Pointer(sp))
44}
</code></pre></div><p>可见，当数组长度超过32时，同样需要调用mallocgc分配一块新内存。最后通过memmove完成拷贝。</p>
<ul>
<li>
<h4 id="强转换的实现细节">强转换的实现细节</h4>
</li>
</ul>
<p>\1. 万能的unsafe.Pointer指针</p>
<p>在go中，任何类型的指针<em>T都可以转换为unsafe.Pointer类型的指针，它可以存储任何变量的地址。同时，unsafe.Pointer类型的指针也可以转换回普通指针，而且可以不必和之前的类型</em>T相同。另外，unsafe.Pointer类型还可以转换为uintptr类型，该类型保存了指针所指向地址的数值，从而可以使我们对地址进行数值计算。以上就是强转换方式的实现依据。</p>
<p>而string和slice在reflect包中，对应的结构体是reflect.StringHeader和reflect.SliceHeader，它们是string和slice的运行时表达。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback"> 1type StringHeader struct {
 2    Data uintptr
 3    Len  int
 4}
 5
 6type SliceHeader struct {
 7    Data uintptr
 8    Len  int
 9    Cap  int
10}
</code></pre></div><p>\2. 内存布局</p>
<p>从string和slice的运行时表达可以看出，除了SilceHeader多了一个int类型的Cap字段，Date和Len字段是一致的。所以，它们的内存布局是可对齐的，这说明我们就可以直接通过unsafe.Pointer进行转换。</p>
<p>[]byte转string图解</p>
<p><img src="http://shanks.link/img/Go%E4%B9%8Bstring%E4%B8%8Ebyte%E8%BD%AC%E6%8D%A2%E7%9A%84%E5%8E%9F%E7%90%86/5.png" alt="img"></p>
<p>string转[]byte图解</p>
<p><img src="http://shanks.link/img/Go%E4%B9%8Bstring%E4%B8%8Ebyte%E8%BD%AC%E6%8D%A2%E7%9A%84%E5%8E%9F%E7%90%86/6.png" alt="img"></p>
<h4 id="heading"></h4>
<ul>
<li>
<h4 id="qa">Q&amp;A</h4>
</li>
</ul>
<p>Q1.为什么强转换性能会比标准转换好？</p>
<p>对于标准转换，无论是从[]byte转string还是string转[]byte都会涉及底层数组的拷贝。而强转换是直接替换指针的指向，从而使得string和[]byte指向同一个底层数组。这样，当然后者的性能会更好。</p>
<p>Q2.为什么在上述测试中，当x的数据较大时，标准转换方式会有一次分配内存的操作，从而导致其性能更差，而强转换方式却不受影响？</p>
<p>标准转换时，当数据长度大于32个字节时，需要通过mallocgc申请新的内存，之后再进行数据拷贝工作。而强转换只是更改指针指向。所以，当转换数据较大时，两者性能差距会愈加明显。</p>
<p>Q3.既然强转换方式性能这么好，为什么go语言提供给我们使用的是标准转换方式？</p>
<p>首先，我们需要知道Go是一门类型安全的语言，而安全的代价就是性能的妥协。但是，性能的对比是相对的，这点性能的妥协对于现在的机器而言微乎其微。另外强转换的方式，会给我们的程序带来极大的安全隐患。</p>
<p>如下示例</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">1a := &#34;hello&#34;
2b := String2Bytes(a)
3b[0] = &#39;H&#39;
</code></pre></div><p>a是string类型，前面我们讲到它的值是不可修改的。通过强转换将a的底层数组赋给b，而b是一个[]byte类型，它的值是可以修改的，所以这时对底层数组的值进行修改，将会造成严重的错误（通过defer+recover也不能捕获）。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">1unexpected fault address 0x10b6139
2fatal error: fault
3[signal SIGBUS: bus error code=0x2 addr=0x10b6139 pc=0x1088f2c]
</code></pre></div><p>Q4. 为什么string要设计为不可修改？</p>
<p>我认为有必要思考一下该问题。string不可修改，意味它是只读属性，这样的好处就是：在并发场景下，我们可以在不加锁的控制下，多次使用同一字符串，在保证高效共享的情况下而不用担心安全问题。</p>
<ul>
<li>
<h4 id="取舍场景">取舍场景</h4>
</li>
</ul>
<ol>
<li>在你不确定安全隐患的条件下，尽量采用标准方式进行数据转换。</li>
<li>当程序对运行性能有高要求，同时满足对数据仅仅只有读操作的条件，且存在频繁转换（例如消息转发场景），可以使用强转换。</li>
</ol>
<p><a href="https://mp.weixin.qq.com/s/Im35yGULstsM8H5-QziEZw">以上内容转载自机器铃砍菜刀</a></p>

    </div>
    <footer class="post-footer">
     
 
<div class="post-tags">     
     
    <a href="http://shanks.link/tags/go" rel="tag" title="go">#go#</a>
    
</div>



     <div class="post-nav">
    <div class="post-nav-next post-nav-item">
    
        <a href="http://shanks.link/blog/2021/04/28/cpu%E7%BC%93%E5%AD%98%E4%BD%93%E7%B3%BB%E5%AF%B9%E7%A8%8B%E5%BA%8F%E7%9A%84%E5%BD%B1%E5%93%8D/" rel="next" title="CPU缓存体系对程序的影响">
        <i class="fa fa-chevron-left"></i> CPU缓存体系对程序的影响
        </a>
    
    </div>

    <div class="post-nav-prev post-nav-item">
    
        <a href="http://shanks.link/blog/2021/04/27/go%E5%B7%A5%E5%85%B7%E4%B9%8Bvet%E9%9D%99%E6%80%81%E8%AF%8A%E6%96%AD%E5%99%A8/" rel="prev" title="Go工具之vet静态诊断器">
        Go工具之vet静态诊断器 <i class="fa fa-chevron-right"></i>
        </a>
    
    </div>
</div>
      
     
     
     





<script src="https://utteranc.es/client.js"
        repo="shankusu2017@gmail.com/"
        issue-term="pathname"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>
<noscript>Please enable JavaScript to view the <a href="https://github.com/utterance">comments powered by utterances.</a></noscript>

    </footer>
  </article>
</section>

          </div>
        </div>
        <div class="sidebar-toggle">
  <div class="sidebar-toggle-line-wrap">
    <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
    <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
    <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
  </div>
</div>
<aside id="sidebar" class="sidebar">
  <div class="sidebar-inner">

    <section class="site-overview sidebar-panel  sidebar-panel-active ">
      <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image"
        src="http://shanks.link/img/logo.jpg"
        alt="shankusu2017@gmail.com" />
    <p class="site-author-name" itemprop="name">shankusu2017@gmail.com</p>
    <p class="site-description motion-element" itemprop="description"> </p>
</div>
      <nav class="site-state motion-element">
    <div class="site-state-item site-state-posts">
      <a href="http://shanks.link/post/">
        <span class="site-state-item-count">387</span>
        <span class="site-state-item-name">日志</span>
      </a>
    </div>
    <div class="site-state-item site-state-categories">    
        <a href="http://shanks.link/categories/">      
         
        <span class="site-state-item-count">19</span>
        
        <span class="site-state-item-name">分类</span>
        
        </a>
    </div>

    <div class="site-state-item site-state-tags">
        <a href="http://shanks.link/tags/">
         
        <span class="site-state-item-count">26</span>
        
        <span class="site-state-item-name">标签</span>
        </a>
    </div>
</nav>
      
      
<div class="links-of-author motion-element">
    
        <span class="links-of-author-item">
        <a href="https://github.com/shankusu2017" target="_blank" title="GitHub">
            <i class="fa fa-fw fa-github"></i>
            GitHub
        </a>
        </span>
    
</div>


      

      <div class="links-of-blogroll motion-element inline">
<script type="text/javascript" src="//rf.revolvermaps.com/0/0/8.js?i=5b4f2ucxar6&amp;m=0&amp;s=220&amp;c=ff0000&amp;cr1=ffffff&amp;f=arial&amp;l=33&amp;bv=35" async="async"></script>
</div>

    </section>
    
  </div>
</aside>

      </div>
    </main>
   
    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  <span itemprop="copyrightYear">  &copy; 
  2009 - 2022</span>
  <span class="with-love"><i class="fa fa-heart"></i></span>
  <span class="author" itemprop="copyrightHolder">愿星光伴你左右</span>
</div>
<div class="powered-by">
  Powered by - <a class="theme-link" href="http://gohugo.io" target="_blank" title="hugo" >Hugo v0.92.1</a>
</div>
<div class="theme-info">
  Theme by - <a class="theme-link" href="https://github.com/xtfly/hugo-theme-next" target="_blank"> NexT
  </a>
</div>


      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
      <span id="scrollpercent"><span>0</span>%</span>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>
<script type="text/javascript" src="http://shanks.link/js/vendor/jquery/index.js?v=2.1.3"></script>
<script type="text/javascript" src="http://shanks.link/js/vendor/fastclick/lib/fastclick.min.js?v=1.0.6"></script> 
<script type="text/javascript" src="http://shanks.link/js/vendor/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
<script type="text/javascript" src="http://shanks.link/js/vendor/velocity/velocity.min.js?v=1.2.1"></script>
<script type="text/javascript" src="http://shanks.link/js/vendor/velocity/velocity.ui.min.js?v=1.2.1"></script>
<script src="http://shanks.link/js/vendor/ua-parser-js/dist/ua-parser.min.js?v=0.7.9"></script>

<script src="http://shanks.link/js/vendor/fancybox/jquery.fancybox.pack.js?v=2.1.5"></script>

<script type="text/javascript" src="http://shanks.link/js/utils.js"></script>
<script type="text/javascript" src="http://shanks.link/js/motion.js"></script>
<script type="text/javascript" src="http://shanks.link/js/affix.js"></script>
<script type="text/javascript" src="http://shanks.link/js/schemes/pisces.js"></script>

<script type="text/javascript" src="http://shanks.link/js/scrollspy.js"></script>
<script type="text/javascript" src="http://shanks.link/js/post-details.js"></script>
<script type="text/javascript" src="http://shanks.link/js/toc.js"></script>

<script type="text/javascript" src="http://shanks.link/js/bootstrap.js"></script>

<script type="text/javascript" src="http://shanks.link/js/search.js"></script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX", "output/HTML-CSS"],
    tex2jax: {
      inlineMath: [ ['$','$'] ],
      displayMath: [ ['$$','$$'] ],
      processEscapes: true
    },
    "HTML-CSS": { fonts: ["TeX"] }
  });
</script>
<script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML' async></script>
</body>
</html>