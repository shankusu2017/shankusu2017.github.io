<!DOCTYPE HTML>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" /> 
    <title>Go工具之vet静态诊断器 - Golang编程语言知识介绍</title>
    <meta name="keywords" content="git,Git,Lua,lua,Golang,go">
    
    <meta property="og:title" content="Go工具之vet静态诊断器">
    <meta property="og:site_name" content="Golang编程语言知识介绍">
    <meta property="og:image" content="/img/author.jpg"> 
    <meta name="title" content="Go工具之vet静态诊断器 - Golang编程语言知识介绍" />
    <meta name="description" content="愿星光伴你左右"> 
    <link rel="shortcut icon" href="http://shanks.link/img/favicon.ico" />
    <link rel="apple-touch-icon" href="http://shanks.link/img/apple-touch-icon.png" />
    <link rel="apple-touch-icon-precomposed" href="http://shanks.link/img/apple-touch-icon.png" />
    <link href="http://shanks.link/js/vendor/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />
    <link href="http://shanks.link/js/vendor/fancybox/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />
    <link href="http://shanks.link/css/main.css" rel="stylesheet" type="text/css" />
    <link href="http://shanks.link/css/syntax.css" rel="stylesheet" type="text/css" />
    <script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post"},
     fancybox: true, 
    motion: true
  };
</script>
</head>
<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">
<div class="container one-collumn sidebar-position-left page-home  ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"> <div class="site-meta  custom-logo ">

  <div class="custom-logo-site-title">
    <a href="http://shanks.link/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">Golang编程语言知识介绍</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle"></p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
    <ul id="menu" class="menu">
      
      
        <li class="menu-item ">
          <a href="http://shanks.link/post/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />首页
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/thinking/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />随想录
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/%E7%94%9F%E6%B4%BB/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />生活
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/os/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />OS
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/lua/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />lua
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/redis/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />redis
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/go/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />Golang
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/c/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />C
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/openvpn/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />OpenVPN
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/ipsec/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />IPSec
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/web/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />web
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/openwrt/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />OpenWRT
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/%E8%BF%90%E7%BB%B4/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />运维
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/git/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />Git
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/%E9%B8%9F%E5%93%A5%E7%9A%84%E7%A7%81%E6%88%BF%E8%8F%9C/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />鸟哥的私房菜
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/it/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />IT杂谈
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/about/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />About Me
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/links/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />友情链接
          </a>
        </li>
      
      <li class="menu-item menu-item-search">
        <a href="javascript:;" class="popup-trigger"> <i class="menu-item-icon fa fa-search fa-fw"></i> <br /> 搜索</a>
      </li>
    </ul>
    <div class="site-search">
      <div class="popup">
 <span class="search-icon fa fa-search"></span>
 <input type="text" id="local-search-input">
 <div id="local-search-result"></div>
 <span class="popup-btn-close">close</span>
</div>

    </div>
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
<section id="posts" class="posts-expand">
  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <header class="post-header">
      <h1 class="post-title" itemprop="name headline">
        <a class="post-title-link" href="http://shanks.link/blog/2021/04/27/go%E5%B7%A5%E5%85%B7%E4%B9%8Bvet%E9%9D%99%E6%80%81%E8%AF%8A%E6%96%AD%E5%99%A8/" itemprop="url">
        Go工具之vet静态诊断器
        </a>
      </h1>
      <div class="post-meta">
      <span class="post-time">
<span class="post-meta-item-icon">
    <i class="fa fa-calendar-o"></i>
</span>
<span class="post-meta-item-text">时间：</span>
<time itemprop="dateCreated" datetime="2016-03-22T13:04:35+08:00" content="2021-04-27">
    2021-04-27
</time>
</span> 
      

  <span class="post-category" >
  &nbsp; | &nbsp;
  <span class="post-meta-item-icon">
    <i class="fa fa-folder-o"></i>
  </span>
  <span class="post-meta-item-text">分类：</span>
  
    <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
      <a href="http://shanks.link/categories/go" itemprop="url" rel="index">
        <span itemprop="name">go</span>
      </a>
      &nbsp; 
    </span>
  
</span>


       <span>
&nbsp; | &nbsp;
<span class="post-meta-item-icon">
    <i class="fa fa-eye"></i>
</span>
<span class="post-meta-item-text">阅读：</span>
<span class="leancloud-visitors-count">2056 字 ~5分钟</span>
</span>
      </div>
    </header>
    <div class="post-body" itemprop="articleBody">
    <h2 id="go工具之vet静态诊断器">Go工具之vet——静态诊断器</h2>
<p>go的vet工具是go代码静态诊断器，可以用以检查go项目中可通过编译但仍可能存在错误的代码，例如无法访问的代码、错误的锁使用、不必要的赋值、布尔运算错误等。</p>
<p><strong>使用示例</strong></p>
<p>vet是go工具套件的其中之一，它是和go编译器一起发布的，因此当我们安装好go之后，就已经带有vet工具。</p>
<p>vet调用方式非常简单，参数1的位置可以指定目录、源码文件或包（packages）。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">go vet &lt;directory|files|packages&gt;
</code></pre></div><p>例如当前目录定义了main.go文件，在fmt.Printf()中使用了错误的格式符%d，而编译器并不会检查到该错误（这里笔者觉得有点奇怪，go既然是强类型语言，编译阶段为何要允许通过？），这会导致程序运行时的输出和预期不符。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go">1<span style="color:#00f">package</span> main
2
3import <span style="color:#009c00">&#34;fmt&#34;</span>
4
5<span style="color:#00f">func</span> <span style="color:#c34e00">main</span>() {
6    s := <span style="color:#009c00">&#34;this is a string&#34;</span>
7    fmt.<span style="color:#c34e00">Printf</span>(<span style="color:#009c00">&#34;inappropriate formate %d\n&#34;</span>, s)
8}
</code></pre></div><p>使用vet命令进行静态检查，会报告此错误。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">1$ go vet main.go 
2# command-line-arguments
3./main.go:7:2: Printf format %d has arg s of wrong type string
</code></pre></div><p><strong>诊断器与flag</strong></p>
<p>vet的代码分析是由多个子诊断器组成的，目前包含22个（基于go 1.14.1，在最新版1.15 Release Notes中发现vet增加了一些内容，新增对string(int)转换的诊断和对interface-interface类型断言的诊断），这些诊断器单元代表着vet的检测范围。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback"> 1asmdecl      report mismatches between assembly files and Go declarations
 2assign       check for useless assignments
 3atomic       check for common mistakes using the sync/atomic package
 4bools        check for common mistakes involving boolean operators
 5buildtag     check that +build tags are well-formed and correctly located
 6cgocall      detect some violations of the cgo pointer passing rules
 7composites   check for unkeyed composite literals
 8copylocks    check for locks erroneously passed by value
 9errorsas     report passing non-pointer or non-error values to errors.As
10httpresponse check for mistakes using HTTP responses
11loopclosure  check references to loop variables from within nested functions
12lostcancel   check cancel func returned by context.WithCancel is called
13nilfunc      check for useless comparisons between functions and nil
14printf       check consistency of Printf format strings and arguments
15shift        check for shifts that equal or exceed the width of the integer
16stdmethods   check signature of methods of well-known interfaces
17structtag    check that struct field tags conform to reflect.StructTag.Get
18tests        check for common mistaken usages of tests and examples
19unmarshal    report passing non-pointer or non-interface values to unmarshal
20unreachable  check for unreachable code
21unsafeptr    check for invalid conversions of uintptr to unsafe.Pointer
22unusedresult check for unused results of calls to some functions
</code></pre></div><p>例如上文示例中的格式化符的错误，就是检查子诊断器printf中报出的错误。对于特定的诊断器，如果想了解更多细节，可通过命令go tool vet help <!-- raw HTML omitted --> 查看，例如</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">go tool vet help printf   
</code></pre></div><p>使用vet时，<strong>其默认是打开了所有的诊断器</strong>。如果想禁用某个诊断器analyzer，则可以加上-<!-- raw HTML omitted -->=false，代表不检查analyzer包含的内容。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">1go vet -printf=false main.go
</code></pre></div><p>相应的，如果只想使用某个特定的analyzer，那么可加上-<!-- raw HTML omitted -->=true，代表只检查analyzer所包含的内容。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">1go vet -printf=true main.go
</code></pre></div><p>vet命令除了可以设置诊断器之外，还提供了很多flag，这里就不详细列出。可通过go tool vet help命令查看完整内容。</p>
<p>这里介绍两个相对有用的flag</p>
<ul>
<li><strong>-c=N</strong></li>
</ul>
<p>设置此flag可以输出错误代码行的上下相邻N行源代码。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">$ go vet -c=2 main.go
# command-line-arguments
./main.go:7:2: Printf format %d has arg s of wrong type string
5       func main() {
6               s := &#34;this is a string&#34;
7               fmt.Printf(&#34;inappropriate formate %d\n&#34;, s)
8       }
9       
</code></pre></div><ul>
<li><strong>-json</strong></li>
</ul>
<p>设置此flag可以将错误报告以json形式输出。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback"> $ go vet -json main.go
# command-line-arguments
{
        &#34;command-line-arguments&#34;: {
                &#34;printf&#34;: [
                        {
                                &#34;posn&#34;: &#34;/Users/slp/go/src/example/vet/main.go:7:2&#34;,
                                &#34;message&#34;: &#34;Printf format %d has arg s of wrong type string&#34;
                        }
                ]
        }
}    
</code></pre></div><p>通过查看vet的源码（位于$GOROOT/src/cmd/vet/main.go），可以发现其诊断器全是通过引入库golang.org/x/tools/go/analysis中的内容，这是Go官方所维护的库。详细代码可以在github地址：<em><a href="https://github.com/golang/tools/tree/master/go/analysis">https://github.com/golang/tools/tree/master/go/analysis</a></em>中获取。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#00f">package</span> main

<span style="color:#00f">import</span> (
    <span style="color:#009c00">&#34;cmd/internal/objabi&#34;</span>

    <span style="color:#009c00">&#34;golang.org/x/tools/go/analysis/unitchecker&#34;</span>

    <span style="color:#009c00">&#34;golang.org/x/tools/go/analysis/passes/asmdecl&#34;</span>
    <span style="color:#009c00">&#34;golang.org/x/tools/go/analysis/passes/assign&#34;</span>
    <span style="color:#009c00">&#34;golang.org/x/tools/go/analysis/passes/atomic&#34;</span>
    ...
)

<span style="color:#00f">func</span> <span style="color:#c34e00">main</span>() {
    objabi.<span style="color:#c34e00">AddVersionFlag</span>()

    unitchecker.<span style="color:#c34e00">Main</span>(
        asmdecl.Analyzer,
        assign.Analyzer,
        atomic.Analyzer,
        ...
    )
}
</code></pre></div><p><strong>常见错误示例与vet诊断</strong></p>
<p>**
**</p>
<ul>
<li><strong>printf错误</strong></li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#00f">package</span> main

<span style="color:#00f">import</span> <span style="color:#009c00">&#34;fmt&#34;</span>

<span style="color:#00f">func</span> <span style="color:#c34e00">main</span>() {
    s := <span style="color:#009c00">&#34;this is a string&#34;</span>
    fmt.<span style="color:#c34e00">Printf</span>(<span style="color:#009c00">&#34;inappropriate formate %s\n&#34;</span>, &amp;s)
}

$ <span style="color:#00f">go</span> vet main.<span style="color:#00f">go</span>
# command-line-arguments
./main.<span style="color:#00f">go</span>:7:2: Printf format %s has arg &amp;s of wrong <span style="color:#00f">type</span> *<span style="color:#00f">string</span>
</code></pre></div><ul>
<li><strong>布尔错误</strong></li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#00f">package</span> main

<span style="color:#00f">import</span> <span style="color:#009c00">&#34;fmt&#34;</span>

<span style="color:#00f">func</span> <span style="color:#c34e00">main</span>() {
    i := 1

    fmt.<span style="color:#c34e00">Println</span>(i != 0 || i != 1)
    fmt.<span style="color:#c34e00">Println</span>(i == 1 &amp;&amp; i == 0)
    fmt.<span style="color:#c34e00">Println</span>(i == 1 &amp;&amp; i == 1)
}

$ <span style="color:#00f">go</span> vet main.<span style="color:#00f">go</span>
# command-line-arguments
./main.<span style="color:#00f">go</span>:8:14: suspect or: i != 0 || i != 1
./main.<span style="color:#00f">go</span>:9:14: suspect and: i == 1 &amp;&amp; i == 0
./main.<span style="color:#00f">go</span>:10:14: redundant and: i == 1 &amp;&amp; i == 1
</code></pre></div><ul>
<li><strong>range与go协程引起的错误</strong></li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#00f">package</span> main

<span style="color:#00f">import</span> (
    <span style="color:#009c00">&#34;fmt&#34;</span>
    <span style="color:#009c00">&#34;time&#34;</span>
)

<span style="color:#00f">func</span> <span style="color:#c34e00">main</span>() {
    arr := []<span style="color:#00f">int</span>{1,2,3}
    <span style="color:#00f">for</span> _, i := <span style="color:#00f">range</span> arr{
        <span style="color:#00f">go</span> <span style="color:#00f">func</span>() {
            fmt.<span style="color:#c34e00">Println</span>(i)
        }()
    }
    time.<span style="color:#c34e00">Sleep</span>(time.Second)
}

 $ <span style="color:#00f">go</span> run main.<span style="color:#00f">go</span>
3
3
3

 $ <span style="color:#00f">go</span> vet main.<span style="color:#00f">go</span>
# command-line-arguments
./main.<span style="color:#00f">go</span>:12:16: loop variable i captured by <span style="color:#00f">func</span> literal
</code></pre></div><p>这个错误小菜刀在《<a href="http://mp.weixin.qq.com/s?__biz=MzIwNTA4MDAwMQ==&amp;mid=2247484225&amp;idx=1&amp;sn=6d71dfaf7fd4c4f249447a798cf03701&amp;chksm=973717efa0409ef932a5452be719f341814f4c8bc322cb5cdb6b8e46d0069e83a91f5c0bd3ed&amp;scene=21#wechat_redirect">不要忽略goroutine的启动时间</a>》介绍过，感兴趣的可以看下。顺便纠正下那篇文章的结论：goroutine的启动延迟是诱因，本质原因还是由于迭代获取的临时变量是同一个地址变量。</p>
<ul>
<li><strong>错误使用锁</strong></li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#00f">package</span> main

<span style="color:#00f">import</span> (
    <span style="color:#009c00">&#34;fmt&#34;</span>
    <span style="color:#009c00">&#34;sync&#34;</span>
)

<span style="color:#00f">func</span> <span style="color:#c34e00">valueMutex</span>(msg <span style="color:#00f">string</span>, mutex sync.Mutex)  {
    mutex.<span style="color:#c34e00">Lock</span>()
    <span style="color:#00f">defer</span> mutex.<span style="color:#c34e00">Unlock</span>()
    fmt.<span style="color:#c34e00">Println</span>(msg)
}

<span style="color:#00f">func</span> <span style="color:#c34e00">main</span>() {
    mu := sync.Mutex{}
    msg := <span style="color:#009c00">&#34;this is a message&#34;</span>
    <span style="color:#c34e00">valueMutex</span>(msg, mu)
}

$ <span style="color:#00f">go</span> run main.<span style="color:#00f">go</span>
this is a message

 $ <span style="color:#00f">go</span> vet main.<span style="color:#00f">go</span>
# command-line-arguments
./main.<span style="color:#00f">go</span>:8:35: valueMutex passes lock by value: sync.Mutex
./main.<span style="color:#00f">go</span>:17:18: call of valueMutex copies lock value: sync.Mutex
</code></pre></div><p>这种用法是非常危险的，函数参数中不能值传递锁（锁不能被复制，在《<a href="http://mp.weixin.qq.com/s?__biz=MzIwNTA4MDAwMQ==&amp;mid=2247484009&amp;idx=1&amp;sn=1dc6689045b8a1d04cb4d6dd67a6b66b&amp;chksm=973716c7a0409fd1440d74edfb8949d2c3f2d49984fdae08fd1ce0581ea7705cbf6513a3bcdf&amp;scene=21#wechat_redirect">no copy机制</a>》文中有介绍），应该使用指针（将参数类型sync.Mutex改为*sync.Mutex），否则极容易导致死锁。</p>
<ul>
<li><strong>不能到达的代码</strong></li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#00f">package</span> main

<span style="color:#00f">import</span> <span style="color:#009c00">&#34;fmt&#34;</span>

<span style="color:#00f">func</span> <span style="color:#c34e00">unreachable</span>(str <span style="color:#00f">string</span>) <span style="color:#00f">string</span> {
    <span style="color:#00f">return</span> str
    <span style="color:#f00;font-style:italic">// something work
</span><span style="color:#f00;font-style:italic"></span>    <span style="color:#00f">return</span> <span style="color:#009c00">&#34;result&#34;</span>
}

<span style="color:#00f">func</span> <span style="color:#c34e00">main</span>() {
    s := <span style="color:#c34e00">unreachable</span>(<span style="color:#009c00">&#34;init string&#34;</span>)
    fmt.<span style="color:#c34e00">Println</span>(s)
}

$ <span style="color:#00f">go</span> run main.<span style="color:#00f">go</span>
init <span style="color:#00f">string</span>

$ <span style="color:#00f">go</span> vet main.<span style="color:#00f">go</span>
# command-line-arguments
./main.<span style="color:#00f">go</span>:8:2: unreachable code
</code></pre></div><ul>
<li><strong>定义context，忽略了cancel</strong></li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#00f">package</span> main

<span style="color:#00f">import</span> (
    <span style="color:#009c00">&#34;context&#34;</span>
    <span style="color:#009c00">&#34;time&#34;</span>
)

<span style="color:#00f">func</span> <span style="color:#c34e00">child</span>(ctx context.Context) {
    <span style="color:#f00;font-style:italic">// do something
</span><span style="color:#f00;font-style:italic"></span>}

<span style="color:#00f">func</span> <span style="color:#c34e00">main</span>() {
    ctx, _ := context.<span style="color:#c34e00">WithTimeout</span>(context.<span style="color:#c34e00">Background</span>(), time.Second*5)
    <span style="color:#c34e00">child</span>(ctx)
}

 $ <span style="color:#00f">go</span> run main.<span style="color:#00f">go</span>
no problem

$ <span style="color:#00f">go</span> vet main.<span style="color:#00f">go</span>
# command-line-arguments
./main.<span style="color:#00f">go</span>:15:7: the cancel function returned by context.WithTimeout should be called, not discarded, to avoid a context leak
</code></pre></div><p><img src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="图片"></p>
<p><strong>总结</strong></p>
<p>go vet是检测go项目中静态错误的有效工具，清除go vet扫描出的错误，有利于提高代码质量和养成良好的编程习惯。但是，go vet也并不是万能的，它仅仅是帮助程序员排除可能的错误，代码的质量高低更取决于程序员的水平、代码规范和编码态度。</p>
<p>最后，vet作为一个有效的代码质量诊断工具，笔者希望每位gopher都能够充分利用。</p>
<p><a href="https://mp.weixin.qq.com/s/OW9Zx8M_8hc5RdCreGGTTQ">以上内容转载自机器铃砍菜刀</a></p>

    </div>
    <footer class="post-footer">
     
 
<div class="post-tags">     
     
    <a href="http://shanks.link/tags/go" rel="tag" title="go">#go#</a>
    
</div>



     <div class="post-nav">
    <div class="post-nav-next post-nav-item">
    
        <a href="http://shanks.link/blog/2021/04/27/go%E7%9A%84string%E4%B8%8Ebyte%E8%BD%AC%E6%8D%A2%E5%8E%9F%E7%90%86/" rel="next" title="Go的string与[]byte转换原理">
        <i class="fa fa-chevron-left"></i> Go的string与[]byte转换原理
        </a>
    
    </div>

    <div class="post-nav-prev post-nav-item">
    
        <a href="http://shanks.link/blog/2021/04/27/%E4%B8%8D%E8%83%BD%E5%BF%BD%E7%95%A5goroutinue%E7%9A%84%E5%90%AF%E5%8A%A8%E6%97%B6%E9%97%B4/" rel="prev" title="不能忽略GoRoutinue的启动时间">
        不能忽略GoRoutinue的启动时间 <i class="fa fa-chevron-right"></i>
        </a>
    
    </div>
</div>
      
     
     
     





<script src="https://utteranc.es/client.js"
        repo="shankusu2017@gmail.com/"
        issue-term="pathname"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>
<noscript>Please enable JavaScript to view the <a href="https://github.com/utterance">comments powered by utterances.</a></noscript>

    </footer>
  </article>
</section>

          </div>
        </div>
        <div class="sidebar-toggle">
  <div class="sidebar-toggle-line-wrap">
    <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
    <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
    <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
  </div>
</div>
<aside id="sidebar" class="sidebar">
  <div class="sidebar-inner">

    <section class="site-overview sidebar-panel  sidebar-panel-active ">
      <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image"
        src="http://shanks.link/img/logo.jpg"
        alt="shankusu2017@gmail.com" />
    <p class="site-author-name" itemprop="name">shankusu2017@gmail.com</p>
    <p class="site-description motion-element" itemprop="description"> </p>
</div>
      <nav class="site-state motion-element">
    <div class="site-state-item site-state-posts">
      <a href="http://shanks.link/post/">
        <span class="site-state-item-count">528</span>
        <span class="site-state-item-name">日志</span>
      </a>
    </div>
    <div class="site-state-item site-state-categories">    
        <a href="http://shanks.link/categories/">      
         
        <span class="site-state-item-count">41</span>
        
        <span class="site-state-item-name">分类</span>
        
        </a>
    </div>

    <div class="site-state-item site-state-tags">
        <a href="http://shanks.link/tags/">
         
        <span class="site-state-item-count">46</span>
        
        <span class="site-state-item-name">标签</span>
        </a>
    </div>
</nav>
      
      
<div class="links-of-author motion-element">
    
        <span class="links-of-author-item">
        <a href="https://github.com/shankusu2017" target="_blank" title="GitHub">
            <i class="fa fa-fw fa-github"></i>
            GitHub
        </a>
        </span>
    
</div>


      

      <div class="links-of-blogroll motion-element inline">
<script type="text/javascript" src="//rf.revolvermaps.com/0/0/8.js?i=5b4f2ucxar6&amp;m=0&amp;s=220&amp;c=ff0000&amp;cr1=ffffff&amp;f=arial&amp;l=33&amp;bv=35" async="async"></script>
</div>

    </section>
    
  </div>
</aside>

      </div>
    </main>
   
    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  <span itemprop="copyrightYear">  &copy; 
  2009 - 2023</span>
</div>
<div>
  <a href="https://beian.miit.gov.cn/" rel="noopener" target="_blank">粤ICP备2021068940号-1</a>
  <a href="https://www.beian.gov.cn/portal/registerSystemInfo?recordcode=44011302003059" rel="noopener" target="_blank">粤公网安备44011302003059</a>
</div>


      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
      <span id="scrollpercent"><span>0</span>%</span>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>
<script type="text/javascript" src="http://shanks.link/js/vendor/jquery/index.js?v=2.1.3"></script>
<script type="text/javascript" src="http://shanks.link/js/vendor/fastclick/lib/fastclick.min.js?v=1.0.6"></script> 
<script type="text/javascript" src="http://shanks.link/js/vendor/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
<script type="text/javascript" src="http://shanks.link/js/vendor/velocity/velocity.min.js?v=1.2.1"></script>
<script type="text/javascript" src="http://shanks.link/js/vendor/velocity/velocity.ui.min.js?v=1.2.1"></script>
<script src="http://shanks.link/js/vendor/ua-parser-js/dist/ua-parser.min.js?v=0.7.9"></script>

<script src="http://shanks.link/js/vendor/fancybox/jquery.fancybox.pack.js?v=2.1.5"></script>

<script type="text/javascript" src="http://shanks.link/js/utils.js"></script>
<script type="text/javascript" src="http://shanks.link/js/motion.js"></script>
<script type="text/javascript" src="http://shanks.link/js/affix.js"></script>
<script type="text/javascript" src="http://shanks.link/js/schemes/pisces.js"></script>

<script type="text/javascript" src="http://shanks.link/js/scrollspy.js"></script>
<script type="text/javascript" src="http://shanks.link/js/post-details.js"></script>
<script type="text/javascript" src="http://shanks.link/js/toc.js"></script>

<script type="text/javascript" src="http://shanks.link/js/bootstrap.js"></script>

<script type="text/javascript" src="http://shanks.link/js/search.js"></script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX", "output/HTML-CSS"],
    tex2jax: {
      inlineMath: [ ['$','$'] ],
      displayMath: [ ['$$','$$'] ],
      processEscapes: true
    },
    "HTML-CSS": { fonts: ["TeX"] }
  });
</script>
<script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML' async></script>
</body>
</html>