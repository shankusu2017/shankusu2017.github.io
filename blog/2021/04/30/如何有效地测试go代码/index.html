<!DOCTYPE HTML>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" /> 
    <title>如何有效地测试Go代码 - 愿星光伴你左右</title>
    <meta name="keywords" content="愿星光伴你左右,openresty,nginx,Lua,lua,Golang,go">
    
    <meta property="og:title" content="如何有效地测试Go代码">
    <meta property="og:site_name" content="愿星光伴你左右">
    <meta property="og:image" content="/img/author.jpg"> 
    <meta name="title" content="如何有效地测试Go代码 - 愿星光伴你左右" />
    <meta name="description" content="愿星光伴你左右"> 
    <link rel="shortcut icon" href="http://shanks.link/img/favicon.ico" />
    <link rel="apple-touch-icon" href="http://shanks.link/img/apple-touch-icon.png" />
    <link rel="apple-touch-icon-precomposed" href="http://shanks.link/img/apple-touch-icon.png" />
    <link href="http://shanks.link/js/vendor/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />
    <link href="http://shanks.link/js/vendor/fancybox/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />
    <link href="http://shanks.link/css/main.css" rel="stylesheet" type="text/css" />
    <link href="http://shanks.link/css/syntax.css" rel="stylesheet" type="text/css" />
    <script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post"},
     fancybox: true, 
    motion: true
  };
</script>
</head>
<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">
<div class="container one-collumn sidebar-position-left page-home  ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"> <div class="site-meta  custom-logo ">

  <div class="custom-logo-site-title">
    <a href="http://shanks.link/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">愿星光伴你左右</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle"></p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
    <ul id="menu" class="menu">
      
      
        <li class="menu-item ">
          <a href="http://shanks.link/post/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />首页
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/lua/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />lua
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/go/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />Golang
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/thinking/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />thinking
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/links/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />links
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/about/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />about
          </a>
        </li>
      
      <li class="menu-item menu-item-search">
        <a href="javascript:;" class="popup-trigger"> <i class="menu-item-icon fa fa-search fa-fw"></i> <br /> 搜索</a>
      </li>
    </ul>
    <div class="site-search">
      <div class="popup">
 <span class="search-icon fa fa-search"></span>
 <input type="text" id="local-search-input">
 <div id="local-search-result"></div>
 <span class="popup-btn-close">close</span>
</div>

    </div>
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
<section id="posts" class="posts-expand">
  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <header class="post-header">
      <h1 class="post-title" itemprop="name headline">
        <a class="post-title-link" href="http://shanks.link/blog/2021/04/30/%E5%A6%82%E4%BD%95%E6%9C%89%E6%95%88%E5%9C%B0%E6%B5%8B%E8%AF%95go%E4%BB%A3%E7%A0%81/" itemprop="url">
        如何有效地测试Go代码
        </a>
      </h1>
      <div class="post-meta">
      <span class="post-time">
<span class="post-meta-item-icon">
    <i class="fa fa-calendar-o"></i>
</span>
<span class="post-meta-item-text">时间：</span>
<time itemprop="dateCreated" datetime="2016-03-22T13:04:35+08:00" content="2021-04-30">
    2021-04-30
</time>
</span> 
      

  <span class="post-category" >
  &nbsp; | &nbsp;
  <span class="post-meta-item-icon">
    <i class="fa fa-folder-o"></i>
  </span>
  <span class="post-meta-item-text">分类：</span>
  
    <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
      <a href="http://shanks.link/categories/go" itemprop="url" rel="index">
        <span itemprop="name">go</span>
      </a>
      &nbsp; 
    </span>
  
</span>


       <span>
&nbsp; | &nbsp;
<span class="post-meta-item-icon">
    <i class="fa fa-eye"></i>
</span>
<span class="post-meta-item-text">阅读：</span>
<span class="leancloud-visitors-count">4506 字 ~9分钟</span>
</span>
      </div>
    </header>
    <div class="post-body" itemprop="articleBody">
    <h2 id="如何有效地测试go代码">如何有效地测试Go代码</h2>
<p><strong>单元测试</strong></p>
<p>如果把开发程序比作盖房子，那么我们必须确保所有的用料都是合格的，否则盖起来的房子就会存在问题。对于程序而言，我们可以将盖房子的砖头、钢筋、水泥等当做一个个功能单元，如果每个单元是合格的，我们将有信心认为程序是健壮的。单元测试（Unit Test,UT）就是检验功能单元是否合格的工具。</p>
<p>一个没有UT的项目，它的代码质量与工程保证是堪忧的。但在实际开发工作中，很多程序员往往并不写测试代码，他们的开发周期可能如下图所示。</p>
<p><img src="http://shanks.link/img/Go%E6%9C%89%E6%95%88%E6%B5%8B%E8%AF%95%E4%BB%A3%E7%A0%81/1.png" alt="img"></p>
<p>而做了充分UT的程序员，他们的项目开发周期更大概率如下。</p>
<p><img src="http://shanks.link/img/Go%E6%9C%89%E6%95%88%E6%B5%8B%E8%AF%95%E4%BB%A3%E7%A0%81/2.png" alt="img"></p>
<p>项目开发中，不写UT也许能使代码交付更快，但是我们无法保证写出来的代码真的能够正确地执行。写UT可以减少后期解决bug的时间，也能让我们放心地使用自己写出来的代码。从长远来看，后者更能有效地节省开发时间。</p>
<p>既然UT这么重要，是什么原因在阻止开发人员写UT呢？这是因为除了开发人员的惰性习惯之外，编写UT代码同样存在难点。</p>
<ol>
<li>代码耦合度高，缺少必要的抽象与拆分，以至于不知道如何写UT。</li>
<li>存在第三方依赖，例如依赖数据库连接、HTTP请求、数据缓存等。</li>
</ol>
<p>可见，编写可测试代码的难点就在于<strong>解耦</strong>与<strong>依赖</strong>。</p>
<p><strong>接口与Mock</strong></p>
<p>对于难点1，我们需要面向接口编程。在《<a href="http://mp.weixin.qq.com/s?__biz=MzIwNTA4MDAwMQ==&amp;mid=2247484121&amp;idx=1&amp;sn=00ede299a11ca326d1e0bfbb5cef0317&amp;chksm=97371677a0409f613004ef08fe2778b0776ac7cb9f8a67ec0eefe098ae6ba2aa9f1900d0f68b&amp;scene=21#wechat_redirect">接口Interface——塑造健壮与可扩展的Go应用程序</a>》一文中，我们讨论了使用接口给代码带来的灵活解耦与高扩展特性。接口是对一类对象的抽象性描述，表明该类对象能提供什么样的服务，它最主要的作用就是解耦调用者和实现者，这成为了可测试代码的关键。</p>
<p>对于难点2，我们可以通过Mock测试来解决。Mock测试就是在测试过程中，对于某些不容易构造或者不容易获取的对象，用一个虚拟的对象来创建以便测试的测试方法。</p>
<p>如果我们的代码都是面向接口编程，调用方与服务方将是松耦合的依赖关系。在测试代码中，我们就可以Mock 出另一种接口的实现，从而很容易地替换掉第三方的依赖。</p>
<p><img src="http://shanks.link/img/Go%E6%9C%89%E6%95%88%E6%B5%8B%E8%AF%95%E4%BB%A3%E7%A0%81/3.png" alt="img"></p>
<p><strong>测试工具</strong></p>
<p>**
**</p>
<p><strong>1. 自带测试库：testing</strong></p>
<p>在介绍Mock测试之前，先看一下Go中最简单的测试单元应该如何写。假设我们在<code>math.go</code>文件下有以下两个函数，现在我们需要对它们写测试案例。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#ae81ff">1</span><span style="color:#f92672">package</span> <span style="color:#a6e22e">math</span>
<span style="color:#ae81ff">2</span>
<span style="color:#ae81ff">3</span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">Add</span>(<span style="color:#a6e22e">x</span>, <span style="color:#a6e22e">y</span> <span style="color:#66d9ef">int</span>) <span style="color:#66d9ef">int</span> {
<span style="color:#ae81ff">4</span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">x</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">y</span>
<span style="color:#ae81ff">5</span>}
<span style="color:#ae81ff">6</span>
<span style="color:#ae81ff">7</span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">Multi</span>(<span style="color:#a6e22e">x</span>, <span style="color:#a6e22e">y</span> <span style="color:#66d9ef">int</span>) <span style="color:#66d9ef">int</span> {
<span style="color:#ae81ff">8</span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">x</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">y</span>
<span style="color:#ae81ff">9</span>}
</code></pre></div><p>如果我们的IDE是Goland，它有一个非常好用的一键测试代码生成功能。</p>
<p><img src="http://shanks.link/img/Go%E6%9C%89%E6%95%88%E6%B5%8B%E8%AF%95%E4%BB%A3%E7%A0%81/4.png" alt="img"></p>
<p>如上图所示，光标置于函数名之上，右键选择 Generate，我们可以选择生成整个package、当前file或者当前选中函数的测试代码。以 Tests for selection 为例，Goland 会自动在当前 <code>math.go</code> 同级目录新建测试文件<code>math_test.go</code>，内容如下。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"> <span style="color:#ae81ff">1</span><span style="color:#f92672">package</span> <span style="color:#a6e22e">math</span>
 <span style="color:#ae81ff">2</span>
 <span style="color:#ae81ff">3i</span><span style="color:#a6e22e">mport</span> <span style="color:#e6db74">&#34;testing&#34;</span>
 <span style="color:#ae81ff">4</span>
 <span style="color:#ae81ff">5</span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">TestAdd</span>(<span style="color:#a6e22e">t</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">testing</span>.<span style="color:#a6e22e">T</span>) {
 <span style="color:#ae81ff">6</span>    <span style="color:#66d9ef">type</span> <span style="color:#a6e22e">args</span> <span style="color:#66d9ef">struct</span> {
 <span style="color:#ae81ff">7</span>        <span style="color:#a6e22e">x</span> <span style="color:#66d9ef">int</span>
 <span style="color:#ae81ff">8</span>        <span style="color:#a6e22e">y</span> <span style="color:#66d9ef">int</span>
 <span style="color:#ae81ff">9</span>    }
<span style="color:#ae81ff">10</span>    <span style="color:#a6e22e">tests</span> <span style="color:#f92672">:=</span> []<span style="color:#66d9ef">struct</span> {
<span style="color:#ae81ff">11</span>        <span style="color:#a6e22e">name</span> <span style="color:#66d9ef">string</span>
<span style="color:#ae81ff">12</span>        <span style="color:#a6e22e">args</span> <span style="color:#a6e22e">args</span>
<span style="color:#ae81ff">13</span>        <span style="color:#a6e22e">want</span> <span style="color:#66d9ef">int</span>
<span style="color:#ae81ff">14</span>    }{
<span style="color:#ae81ff">15</span>        <span style="color:#75715e">// TODO: Add test cases.
</span><span style="color:#75715e"></span><span style="color:#ae81ff">16</span>    }
<span style="color:#ae81ff">17</span>    <span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">tt</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">tests</span> {
<span style="color:#ae81ff">18</span>        <span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">Run</span>(<span style="color:#a6e22e">tt</span>.<span style="color:#a6e22e">name</span>, <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">t</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">testing</span>.<span style="color:#a6e22e">T</span>) {
<span style="color:#ae81ff">19</span>            <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">got</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">Add</span>(<span style="color:#a6e22e">tt</span>.<span style="color:#a6e22e">args</span>.<span style="color:#a6e22e">x</span>, <span style="color:#a6e22e">tt</span>.<span style="color:#a6e22e">args</span>.<span style="color:#a6e22e">y</span>); <span style="color:#a6e22e">got</span> <span style="color:#f92672">!=</span> <span style="color:#a6e22e">tt</span>.<span style="color:#a6e22e">want</span> {
<span style="color:#ae81ff">20</span>                <span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;Add() = %v, want %v&#34;</span>, <span style="color:#a6e22e">got</span>, <span style="color:#a6e22e">tt</span>.<span style="color:#a6e22e">want</span>)
<span style="color:#ae81ff">21</span>            }
<span style="color:#ae81ff">22</span>        })
<span style="color:#ae81ff">23</span>    }
<span style="color:#ae81ff">24</span>}
</code></pre></div><p>可以看到，在Go测试惯例中，单元测试的默认组织方式就是写在以 <code>_test.go</code> 结尾的文件中，所有的测试方法也都是以 <code>Test</code> 开头并且只接受一个 <code>testing.T</code> 类型的参数。同时，如果我们要给函数名为 <code>Add</code> 的方法写单元测试，那么对应的测试方法一般会被写成 <code>TestAdd</code> 。</p>
<p>当测试模板生成之后，我们只需将测试案例添加至 <code>TODO</code> 即可。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback"> 1        {
 2            &#34;negative + negative&#34;,
 3            args{-1, -1},
 4            -2,
 5        },
 6        {
 7            &#34;negative + positive&#34;,
 8            args{-1, 1},
 9            0,
10        },
11        {
12            &#34;positive + positive&#34;,
13            args{1, 1},
14            2,
15        },
</code></pre></div><p>此时，运行测试文件，可以发现所有测试案例，均成功通过。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">1=== RUN   TestAdd
2--- PASS: TestAdd (0.00s)
3=== RUN   TestAdd/negative_+_negative
4    --- PASS: TestAdd/negative_+_negative (0.00s)
5=== RUN   TestAdd/negative_+_positive
6    --- PASS: TestAdd/negative_+_positive (0.00s)
7=== RUN   TestAdd/positive_+_positive
8    --- PASS: TestAdd/positive_+_positive (0.00s)
9PASS
</code></pre></div><h5 id="2-断言库testify">2. 断言库：testify</h5>
<p>简单了解了Go内置 testing 库的测试写法后，推荐一个好用的断言测试库：testify。testify具有常见断言和mock的工具链，最重要的是，它能够与内置库 testing 很好地配合使用，其项目地址位于https://github.com/stretchr/testify。</p>
<p>如果采用testify库，需要引入<code>&quot;github.com/stretchr/testify/assert&quot;</code>。之外，上述测试代码中以下部分</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">1            if got := Add(tt.args.x, tt.args.y); got != tt.want {
2                t.Errorf(&#34;Add() = %v, want %v&#34;, got, tt.want)
3            }
</code></pre></div><p>更改为如下断言形式</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">1     assert.Equal(t, Add(tt.args.x, tt.args.y), tt.want, tt.name)
</code></pre></div><p>testify 提供的断言方法帮助我们快速地对函数的返回值进行测试，从而减少测试代码工作量。它可断言的类型非常丰富，例如断言Equal、断言NIl、断言Type、断言两个指针是否指向同一对象、断言包含、断言子集等。</p>
<p>不要小瞧这一行代码，如果我们在测试案例中，将&quot;positive + positive&quot;的期望值改为3，那么测试结果中会自动提供报错信息。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback"> 1...
 2=== RUN   TestAdd/positive_+_positive
 3    math_test.go:36: 
 4            Error Trace:    math_test.go:36
 5            Error:          Not equal: 
 6                            expected: 2
 7                            actual  : 3
 8            Test:           TestAdd/positive_+_positive
 9            Messages:       positive + positive
10    --- FAIL: TestAdd/positive_+_positive (0.00s)
11
12
13Expected :2
14Actual   :3
15...
</code></pre></div><h5 id="3-接口mock框架gomock">3. 接口mock框架：gomock</h5>
<p>介绍完基本的测试方法的写法后，我们需要讨论基于接口的 Mock 方法。在Go语言中，最通用的 Mock 手段是通过Go官方的 gomock 框架来自动生成其 Mock 方法。该项目地址位于https://github.com/golang/mock。</p>
<p>为了方便读者理解，本文举一个小明玩手机的例子。小明喜欢玩手机，他每天都需要通过手机聊微信、玩王者、逛知乎，如果某天没有干这些事情，小明就没办法睡觉。在该情景中，我们可以将手机抽象成接口如下。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">1// mockDemo/equipment/phone.go
2type Phone interface {
3    WeiXin() bool
4    WangZhe() bool
5    ZhiHu() bool
6}
</code></pre></div><p>小明手上有一部非常老的IPhone6s，我们为该手机对象实现Phone接口。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback"> 1// mockDemo/equipment/phone6s.go
 2type Iphone6s struct {
 3}
 4
 5func NewIphone6s() *Iphone6s {
 6    return &amp;Iphone6s{}
 7}
 8
 9func (p *Iphone6s) WeiXin() bool {
10    fmt.Println(&#34;Iphone6s chat wei xin!&#34;)
11    return true
12}
13
14func (p *Iphone6s) WangZhe() bool {
15    fmt.Println(&#34;Iphone6s play wang zhe!&#34;)
16    return true
17}
18
19func (p *Iphone6s) ZhiHu() bool {
20    fmt.Println(&#34;Iphone6s read zhi hu!&#34;)
21    return true
22}
</code></pre></div><p>接着，我们定义<code>Person</code>对象用来表示小明，并定义<code>Person</code>对象的生活函数<code>dayLife</code>和入睡函数<code>goSleep</code>。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback"> 1// mockDemo/person.go
 2type Person struct {
 3    name  string
 4    phone equipment.Phone
 5}
 6
 7func NewPerson(name string, phone equipment.Phone) *Person {
 8    return &amp;Person{
 9        name:  name,
10        phone: phone,
11    }
12}
13
14func (x *Person) goSleep() {
15    fmt.Printf(&#34;%s go to sleep!&#34;, x.name)
16}
17
18func (x *Person) dayLife() bool {
19    fmt.Printf(&#34;%s&#39;s daily life:\n&#34;, x.name)
20    if x.phone.WeiXin() &amp;&amp; x.phone.WangZhe() &amp;&amp; x.phone.ZhiHu() {
21        x.goSleep()
22        return true
23    }
24    return false
25}
</code></pre></div><p>最后，我们把小明和iphone6s对象实例化出来，并开启他一天的生活。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback"> 1//mockDemo/main.go
 2func main() {
 3    phone := equipment.NewIphone6s()
 4    xiaoMing := NewPerson(&#34;xiaoMing&#34;, phone)
 5    xiaoMing.dayLife()
 6}
 7
 8// output
 9xiaoMing&#39;s daily life:
10Iphone6s chat wei xin!
11Iphone6s play wang zhe!
12Iphone6s read zhi hu!
13xiaoMing go to sleep!
14
</code></pre></div><p>由于小明每天必须刷完手机才能睡觉，即<code>Person.goSleep</code>，那么小明能否睡觉依赖于手机。</p>
<p><img src="http://shanks.link/img/Go%E6%9C%89%E6%95%88%E6%B5%8B%E8%AF%95%E4%BB%A3%E7%A0%81/5.png" alt="img"></p>
<p>按照当前代码，如果小明的手机坏了，或者小明换了一个手机，那他就没办法睡觉了，这肯定是万万不行的。因此我们需要把小明对某特定手机的依赖Mock掉，这个时候 gomock 框架排上了用场。</p>
<p>如果没有下载gomock库，则执行以下命令获取</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">1GO111MODULE=on go get github.com/golang/mock/mockgen
</code></pre></div><p>通过执行以下命令对phone.go中的Phone接口Mock</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#ae81ff">1</span><span style="color:#a6e22e">mockgen</span> <span style="color:#f92672">-</span><span style="color:#a6e22e">destination</span> <span style="color:#a6e22e">equipment</span><span style="color:#f92672">/</span><span style="color:#a6e22e">mock_iphone</span>.<span style="color:#66d9ef">go</span> <span style="color:#f92672">-</span><span style="color:#f92672">package</span> <span style="color:#a6e22e">equipment</span> <span style="color:#f92672">-</span><span style="color:#a6e22e">source</span> <span style="color:#a6e22e">equipment</span><span style="color:#f92672">/</span><span style="color:#a6e22e">phone</span>.<span style="color:#66d9ef">go</span>
</code></pre></div><p>在执行该命令前，当前项目的组织结构如下</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">1.
2├── equipment
3│   ├── iphone6s.go
4│   └── phone.go
5├── go.mod
6├── go.sum
7├── main.go
8└── person.go
</code></pre></div><p>执行<code>mockgen</code>命令之后，在<code>equipment/phone.go</code>的同级目录，新生成了测试文件 <code>mock_iphone.go</code>（它的代码自动生成功能，是通过Go自带generate工具完成的，感兴趣的读者可以阅读《<a href="http://mp.weixin.qq.com/s?__biz=MzIwNTA4MDAwMQ==&amp;mid=2247484083&amp;idx=1&amp;sn=7571b866c11930c48830060f7a002b82&amp;chksm=9737161da0409f0b50f62b48c5b83d61d9754a43a80e83797df459afb2adada2176a0e04c2eb&amp;scene=21#wechat_redirect">Go工具之generate</a>》一文），其部分内容如下</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback"> 1...
 2// MockPhone is a mock of Phone interface
 3type MockPhone struct {
 4    ctrl     *gomock.Controller
 5    recorder *MockPhoneMockRecorder
 6}
 7
 8// MockPhoneMockRecorder is the mock recorder for MockPhone
 9type MockPhoneMockRecorder struct {
10    mock *MockPhone
11}
12
13// NewMockPhone creates a new mock instance
14func NewMockPhone(ctrl *gomock.Controller) *MockPhone {
15    mock := &amp;MockPhone{ctrl: ctrl}
16    mock.recorder = &amp;MockPhoneMockRecorder{mock}
17    return mock
18}
19
20// EXPECT returns an object that allows the caller to indicate expected use
21func (m *MockPhone) EXPECT() *MockPhoneMockRecorder {
22    return m.recorder
23}
24
25// WeiXin mocks base method
26func (m *MockPhone) WeiXin() bool {
27    m.ctrl.T.Helper()
28    ret := m.ctrl.Call(m, &#34;WeiXin&#34;)
29    ret0, _ := ret[0].(bool)
30    return ret0
31}
32
33// WeiXin indicates an expected call of WeiXin
34func (mr *MockPhoneMockRecorder) WeiXin() *gomock.Call {
35    mr.mock.ctrl.T.Helper()
36    return mr.mock.ctrl.RecordCallWithMethodType(mr.mock, &#34;WeiXin&#34;, reflect.TypeOf((*MockPhone)(nil).WeiXin))
37}
38...
</code></pre></div><p>此时，我们的<code>person.go</code>中的 <code>Person.dayLife</code> 方法就可以测试了。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback"> 1func TestPerson_dayLife(t *testing.T) {
 2    type fields struct {
 3        name  string
 4        phone equipment.Phone
 5    }
 6
 7  // 生成mockPhone对象
 8    mockCtl := gomock.NewController(t)
 9    mockPhone := equipment.NewMockPhone(mockCtl)
10  // 设置mockPhone对象的接口方法返回值
11    mockPhone.EXPECT().ZhiHu().Return(true)
12    mockPhone.EXPECT().WeiXin().Return(true)
13    mockPhone.EXPECT().WangZhe().Return(true)
14
15    tests := []struct {
16        name   string
17        fields fields
18        want   bool
19    }{
20        {&#34;case1&#34;, fields{&#34;iphone6s&#34;, equipment.NewIphone6s()}, true},
21        {&#34;case2&#34;, fields{&#34;mocked phone&#34;, mockPhone}, true},
22    }
23    for _, tt := range tests {
24        t.Run(tt.name, func(t *testing.T) {
25            x := &amp;Person{
26                name:  tt.fields.name,
27                phone: tt.fields.phone,
28            }
29            assert.Equal(t, tt.want, x.dayLife())
30        })
31    }
32}
</code></pre></div><p>对接口进行Mock，可以让我们在未实现具体对象的接口功能前，或者该接口调用代价非常高时，也能对业务代码进行测试。而且在开发过程中，我们同样可以利用Mock对象，不用因为等待接口实现方实现相关功能，从而停滞后续的开发。</p>
<p>在这里我们能够体会到在Go程序中接口对于测试的重要性。没有接口的Go代码，单元测试会非常难写。所以，如果一个稍大型的项目中，没有任何接口，那么该项目的质量一定是堪忧的。</p>
<h5 id="4-常见三方mock依赖库"><strong>4. 常见三方mock依赖库</strong></h5>
<p>在上文中提到，因为存在某些存在第三方依赖，会让我们的代码难以测试。但其实已经有一些比较成熟的mock依赖库可供我们使用。由于篇幅原因，以下列出的一些mock库将不再贴出示例代码，详细信息可通过对应的项目地址进行了解。</p>
<ul>
<li>go-sqlmock</li>
</ul>
<p>这是Go语言中用以测试数据库交互的SQL模拟驱动库，其项目地址为 <a href="https://github.com/DATA-DOG/go-sqlmock">https://github.com/DATA-DOG/go-sqlmock</a>。它而无需真正地数据库连接，就能够在测试中模拟sql驱动程序行为，非常有助于维护测试驱动开发（TDD）的工作流程。</p>
<ul>
<li>httpmock</li>
</ul>
<p>用于模拟外部资源的http响应，它使用模式匹配的方式匹配 HTTP 请求的 URL，在匹配到特定的请求时就会返回预先设置好的响应。其项目地址为 <a href="https://github.com/jarcoal/httpmock">https://github.com/jarcoal/httpmock</a> 。</p>
<ul>
<li>gripmock</li>
</ul>
<p>它用于模拟gRPC服务的服务器，通过使用.proto文件生成对gRPC服务的实现，其项目地址为 <a href="https://github.com/tokopedia/gripmock">https://github.com/tokopedia/gripmock</a>。</p>
<ul>
<li>redismock</li>
</ul>
<p>用于测试与Redis服务器的交互，其项目地址位于 <a href="https://github.com/elliotchance/redismock">https://github.com/elliotchance/redismock</a>。</p>
<h5 id="5-猴子补丁monkey-patch"><strong>5. 猴子补丁：monkey patch</strong></h5>
<p>如果上述的方案都不能很好的写出测试代码，这时可以考虑使用猴子补丁。猴子补丁简单而言就是属性在运行时的动态替换，它在理论上可以替换运行时中的一切函数。这种测试方式在动态语言例如Python中比较合适。在Go中，monkey库通过在运行时重写正在运行的可执行文件并插入跳转到您要调用的函数来实现Monkey patching。项目作者写道：这个操作很不安全，<strong>不建议任何人在测试环境之外进行使用</strong>。其项目地址为https://github.com/bouk/monkey。</p>
<p>monkey库的API比较简单，例如可以通过调用 <code>monkey.Patch(&lt;target function&gt;, &lt;replacement function&gt;)</code>来实现对函数的替换，以下是操作示例。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"> <span style="color:#ae81ff">1</span><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>
 <span style="color:#ae81ff">2</span>
 <span style="color:#ae81ff">3i</span><span style="color:#a6e22e">mport</span> (
 <span style="color:#ae81ff">4</span>    <span style="color:#e6db74">&#34;fmt&#34;</span>
 <span style="color:#ae81ff">5</span>    <span style="color:#e6db74">&#34;os&#34;</span>
 <span style="color:#ae81ff">6</span>    <span style="color:#e6db74">&#34;strings&#34;</span>
 <span style="color:#ae81ff">7</span>
 <span style="color:#ae81ff">8</span>    <span style="color:#e6db74">&#34;bou.ke/monkey&#34;</span>
 <span style="color:#ae81ff">9</span>)
<span style="color:#ae81ff">10</span>
<span style="color:#ae81ff">11</span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
<span style="color:#ae81ff">12</span>    <span style="color:#a6e22e">monkey</span>.<span style="color:#a6e22e">Patch</span>(<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>, <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">a</span> <span style="color:#f92672">...</span><span style="color:#66d9ef">interface</span>{}) (<span style="color:#a6e22e">n</span> <span style="color:#66d9ef">int</span>, <span style="color:#a6e22e">err</span> <span style="color:#66d9ef">error</span>) {
<span style="color:#ae81ff">13</span>        <span style="color:#a6e22e">s</span> <span style="color:#f92672">:=</span> make([]<span style="color:#66d9ef">interface</span>{}, len(<span style="color:#a6e22e">a</span>))
<span style="color:#ae81ff">14</span>        <span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span>, <span style="color:#a6e22e">v</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">a</span> {
<span style="color:#ae81ff">15</span>            <span style="color:#a6e22e">s</span>[<span style="color:#a6e22e">i</span>] = <span style="color:#a6e22e">strings</span>.<span style="color:#a6e22e">Replace</span>(<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprint</span>(<span style="color:#a6e22e">v</span>), <span style="color:#e6db74">&#34;hell&#34;</span>, <span style="color:#e6db74">&#34;*bleep*&#34;</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>)
<span style="color:#ae81ff">16</span>        }
<span style="color:#ae81ff">17</span>        <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Fprintln</span>(<span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">Stdout</span>, <span style="color:#a6e22e">s</span><span style="color:#f92672">...</span>)
<span style="color:#ae81ff">18</span>    })
<span style="color:#ae81ff">19</span>    <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;what the hell?&#34;</span>) <span style="color:#75715e">// what the *bleep*?
</span><span style="color:#75715e"></span><span style="color:#ae81ff">20</span>}
</code></pre></div><p>需要注意的是，如果启用了内联，则monkey有时无法进行patching，因此，我们需要尝试在禁用内联的情况下运行测试。例如以上例子，我们需要通过以下命令执行。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">1$ go build -o main -gcflags=-l main.go;./main
2what the *bleep*?
</code></pre></div><p><strong>总结</strong></p>
<p>在项目开发中，单元测试是重要且必须的。对于单元测试的两大难点：<strong>解耦</strong>与<strong>依赖</strong>，我们的代码可以采用 <strong>面向接口+mock依赖</strong> 的方式进行组织，将依赖都做成可插拔的，那在单元测试里面隔离依赖就是一件水到渠成的事情。</p>
<p>另外，本文讨论了一些实用的测试工具，包括自带测试库testing的快速生成测试代码，断言库testify的断言使用，接口mock框架gomock如何mock接口方法和一些常见的三方依赖mock库推荐，最后再介绍了测试大杀器猴子补丁，当然，不到万不得已，不要使用猴子补丁。</p>
<p>最后，在这些测试工具的使用上，本文的内容也只是一些浅尝辄止的介绍，希望读者能够在实际项目中多写写单元测试，深入体会TDD的开发思想。</p>
<p><a href="https://mp.weixin.qq.com/s/HIRYk-KFb9LnQMhoQUQPRg">以上内容转载自机器铃砍柴刀</a></p>

    </div>
    <footer class="post-footer">
     
 
<div class="post-tags">     
     
    <a href="http://shanks.link/tags/go" rel="tag" title="go">#go#</a>
    
</div>



     <div class="post-nav">
    <div class="post-nav-next post-nav-item">
    
        <a href="http://shanks.link/blog/2021/04/30/go%E4%B8%AD%E7%9C%8B%E4%BC%BC%E7%AE%80%E5%8D%95%E7%9A%84waitgroup%E6%BA%90%E7%A0%81%E8%AE%BE%E8%AE%A1%E7%AB%9F%E7%84%B6%E6%9A%97%E5%90%AB%E8%BF%99%E4%B9%88%E5%A4%9A%E7%9F%A5%E8%AF%86/" rel="next" title="Go中看似简单的WaitGroup源码设计，竟然暗含这么多知识？">
        <i class="fa fa-chevron-left"></i> Go中看似简单的WaitGroup源码设计，竟然暗含这么多知识？
        </a>
    
    </div>

    <div class="post-nav-prev post-nav-item">
    
        <a href="http://shanks.link/blog/2021/04/30/%E5%90%8C%E6%AD%A5%E5%8E%9F%E7%90%86%E7%9A%84%E5%9F%BA%E7%9F%B3/" rel="prev" title="同步原理的基石">
        同步原理的基石 <i class="fa fa-chevron-right"></i>
        </a>
    
    </div>
</div>
      
     
     
     





<script src="https://utteranc.es/client.js"
        repo="shankusu2017@gmail.com/"
        issue-term="pathname"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>
<noscript>Please enable JavaScript to view the <a href="https://github.com/utterance">comments powered by utterances.</a></noscript>

    </footer>
  </article>
</section>

          </div>
        </div>
        <div class="sidebar-toggle">
  <div class="sidebar-toggle-line-wrap">
    <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
    <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
    <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
  </div>
</div>
<aside id="sidebar" class="sidebar">
  <div class="sidebar-inner">

    <section class="site-overview sidebar-panel  sidebar-panel-active ">
      <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image"
        src="http://shanks.link/img/logo.jpg"
        alt="shankusu2017@gmail.com" />
    <p class="site-author-name" itemprop="name">shankusu2017@gmail.com</p>
    <p class="site-description motion-element" itemprop="description"> </p>
</div>
      <nav class="site-state motion-element">
    <div class="site-state-item site-state-posts">
      <a href="http://shanks.link/post/">
        <span class="site-state-item-count">383</span>
        <span class="site-state-item-name">日志</span>
      </a>
    </div>
    <div class="site-state-item site-state-categories">    
        <a href="http://shanks.link/categories/">      
         
        <span class="site-state-item-count">20</span>
        
        <span class="site-state-item-name">分类</span>
        
        </a>
    </div>

    <div class="site-state-item site-state-tags">
        <a href="http://shanks.link/tags/">
         
        <span class="site-state-item-count">27</span>
        
        <span class="site-state-item-name">标签</span>
        </a>
    </div>
</nav>
      
      
<div class="links-of-author motion-element">
    
        <span class="links-of-author-item">
        <a href="https://github.com/shankusu2017" target="_blank" title="GitHub">
            <i class="fa fa-fw fa-github"></i>
            GitHub
        </a>
        </span>
    
</div>


      

      <div class="links-of-blogroll motion-element inline">
<script type="text/javascript" src="//rf.revolvermaps.com/0/0/8.js?i=5b4f2ucxar6&amp;m=0&amp;s=220&amp;c=ff0000&amp;cr1=ffffff&amp;f=arial&amp;l=33&amp;bv=35" async="async"></script>
</div>

    </section>
    
  </div>
</aside>

      </div>
    </main>
   
    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  <span itemprop="copyrightYear">  &copy; 
  2009 - 2022</span>
  <span class="with-love"><i class="fa fa-heart"></i></span>
  <span class="author" itemprop="copyrightHolder">愿星光伴你左右</span>
</div>
<div class="powered-by">
  Powered by - <a class="theme-link" href="http://gohugo.io" target="_blank" title="hugo" >Hugo v0.92.1</a>
</div>
<div class="theme-info">
  Theme by - <a class="theme-link" href="https://github.com/xtfly/hugo-theme-next" target="_blank"> NexT
  </a>
</div>


      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
      <span id="scrollpercent"><span>0</span>%</span>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>
<script type="text/javascript" src="http://shanks.link/js/vendor/jquery/index.js?v=2.1.3"></script>
<script type="text/javascript" src="http://shanks.link/js/vendor/fastclick/lib/fastclick.min.js?v=1.0.6"></script> 
<script type="text/javascript" src="http://shanks.link/js/vendor/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
<script type="text/javascript" src="http://shanks.link/js/vendor/velocity/velocity.min.js?v=1.2.1"></script>
<script type="text/javascript" src="http://shanks.link/js/vendor/velocity/velocity.ui.min.js?v=1.2.1"></script>
<script src="http://shanks.link/js/vendor/ua-parser-js/dist/ua-parser.min.js?v=0.7.9"></script>

<script src="http://shanks.link/js/vendor/fancybox/jquery.fancybox.pack.js?v=2.1.5"></script>

<script type="text/javascript" src="http://shanks.link/js/utils.js"></script>
<script type="text/javascript" src="http://shanks.link/js/motion.js"></script>
<script type="text/javascript" src="http://shanks.link/js/affix.js"></script>
<script type="text/javascript" src="http://shanks.link/js/schemes/pisces.js"></script>

<script type="text/javascript" src="http://shanks.link/js/scrollspy.js"></script>
<script type="text/javascript" src="http://shanks.link/js/post-details.js"></script>
<script type="text/javascript" src="http://shanks.link/js/toc.js"></script>

<script type="text/javascript" src="http://shanks.link/js/bootstrap.js"></script>

<script type="text/javascript" src="http://shanks.link/js/search.js"></script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX", "output/HTML-CSS"],
    tex2jax: {
      inlineMath: [ ['$','$'] ],
      displayMath: [ ['$$','$$'] ],
      processEscapes: true
    },
    "HTML-CSS": { fonts: ["TeX"] }
  });
</script>
<script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML' async></script>
</body>
</html>