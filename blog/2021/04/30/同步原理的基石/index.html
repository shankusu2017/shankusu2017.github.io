<!DOCTYPE HTML>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" /> 
    <title>同步原理的基石 - 愿星光伴你左右</title>
    <meta name="keywords" content="git,Git,Lua,lua,Golang,go">
    
    <meta property="og:title" content="同步原理的基石">
    <meta property="og:site_name" content="愿星光伴你左右">
    <meta property="og:image" content="/img/author.jpg"> 
    <meta name="title" content="同步原理的基石 - 愿星光伴你左右" />
    <meta name="description" content="愿星光伴你左右"> 
    <link rel="shortcut icon" href="http://shanks.link/img/favicon.ico" />
    <link rel="apple-touch-icon" href="http://shanks.link/img/apple-touch-icon.png" />
    <link rel="apple-touch-icon-precomposed" href="http://shanks.link/img/apple-touch-icon.png" />
    <link href="http://shanks.link/js/vendor/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />
    <link href="http://shanks.link/js/vendor/fancybox/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />
    <link href="http://shanks.link/css/main.css" rel="stylesheet" type="text/css" />
    <link href="http://shanks.link/css/syntax.css" rel="stylesheet" type="text/css" />
    <script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post"},
     fancybox: true, 
    motion: true
  };
</script>
</head>
<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">
<div class="container one-collumn sidebar-position-left page-home  ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"> <div class="site-meta  custom-logo ">

  <div class="custom-logo-site-title">
    <a href="http://shanks.link/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">愿星光伴你左右</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle"></p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
    <ul id="menu" class="menu">
      
      
        <li class="menu-item ">
          <a href="http://shanks.link/post/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />首页
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/thinking/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />随想录
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/prose/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />散文
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/%E7%94%9F%E6%B4%BB/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />生活
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/os/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />OS
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/lua/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />lua
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/redis/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />redis
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/go/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />Golang
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/c/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />C
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/openvpn/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />OpenVPN
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/web/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />web
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/openwrt/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />OpenWRT
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/%E8%BF%90%E7%BB%B4/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />运维
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/git/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />Git
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/it/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />IT杂谈
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/about/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />About Me
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/links/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />友情链接
          </a>
        </li>
      
      <li class="menu-item menu-item-search">
        <a href="javascript:;" class="popup-trigger"> <i class="menu-item-icon fa fa-search fa-fw"></i> <br /> 搜索</a>
      </li>
    </ul>
    <div class="site-search">
      <div class="popup">
 <span class="search-icon fa fa-search"></span>
 <input type="text" id="local-search-input">
 <div id="local-search-result"></div>
 <span class="popup-btn-close">close</span>
</div>

    </div>
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
<section id="posts" class="posts-expand">
  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <header class="post-header">
      <h1 class="post-title" itemprop="name headline">
        <a class="post-title-link" href="http://shanks.link/blog/2021/04/30/%E5%90%8C%E6%AD%A5%E5%8E%9F%E7%90%86%E7%9A%84%E5%9F%BA%E7%9F%B3/" itemprop="url">
        同步原理的基石
        </a>
      </h1>
      <div class="post-meta">
      <span class="post-time">
<span class="post-meta-item-icon">
    <i class="fa fa-calendar-o"></i>
</span>
<span class="post-meta-item-text">时间：</span>
<time itemprop="dateCreated" datetime="2016-03-22T13:04:35+08:00" content="2021-04-30">
    2021-04-30
</time>
</span> 
      

  <span class="post-category" >
  &nbsp; | &nbsp;
  <span class="post-meta-item-icon">
    <i class="fa fa-folder-o"></i>
  </span>
  <span class="post-meta-item-text">分类：</span>
  
    <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
      <a href="http://shanks.link/categories/go" itemprop="url" rel="index">
        <span itemprop="name">go</span>
      </a>
      &nbsp; 
    </span>
  
</span>


       <span>
&nbsp; | &nbsp;
<span class="post-meta-item-icon">
    <i class="fa fa-eye"></i>
</span>
<span class="post-meta-item-text">阅读：</span>
<span class="leancloud-visitors-count">3066 字 ~7分钟</span>
</span>
      </div>
    </header>
    <div class="post-body" itemprop="articleBody">
    <h2 id="同步原语的基石">同步原语的基石</h2>
<p>Go是一门以并发编程见长的语言，它提供了一系列的同步原语方便开发者使用，例如<code>sync</code>包下的<code>Mutex</code>、<code>RWMutex</code>、<code>WaitGroup</code>、<code>Once</code>、<code>Cond</code>，以及抽象层级更高的<code>Channel</code>。但是，它们的实现基石是原子操作。需要记住的是：<strong>软件原子操作离不开硬件指令的支持</strong>。本文拟通过探讨原子操作——**比较并交换(compare and swap, CAS)**的实现，来理解Go是如何借助硬件指令来实现这一过程的。</p>
<p><strong>什么是CAS</strong></p>
<p>看源码实现之前，我们先理解一下CAS。</p>
<p>维基百科定义：CAS是原子操作的一种，可用于在多线程编程中实现不被打断的数据交换操作，从而<strong>避免多线程同时改写某一数据时由于执行顺序不确定性以及中断的不可预知性产生的数据不一致问题</strong>。该操作通过将内存中的值与指定数据进行比较，当数值一样时将内存中的数据替换为新的值。</p>
<p>CAS的实现思想可以用以下伪代码表示</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>1bool Cas(int *val, int old, int new)
</span></span><span style="display:flex;"><span>2 Atomically:
</span></span><span style="display:flex;"><span>3    if(*val == old){
</span></span><span style="display:flex;"><span>4        *val = new;
</span></span><span style="display:flex;"><span>5        return 1;
</span></span><span style="display:flex;"><span>6    } else {
</span></span><span style="display:flex;"><span>7        return 0;
</span></span><span style="display:flex;"><span>8    }
</span></span></code></pre></div><p>在<code>sync/atomic/doc.go</code>中，定义了一系列原子操作函数原型。以<code>CompareAndSwapInt32</code>为例，有以下代码</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span> <span style="color:#ae81ff">1</span><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>
</span></span><span style="display:flex;"><span> <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span> <span style="color:#ae81ff">3i</span><span style="color:#a6e22e">mport</span> (
</span></span><span style="display:flex;"><span> <span style="color:#ae81ff">4</span>    <span style="color:#e6db74">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span> <span style="color:#ae81ff">5</span>    <span style="color:#e6db74">&#34;sync/atomic&#34;</span>
</span></span><span style="display:flex;"><span> <span style="color:#ae81ff">6</span>)
</span></span><span style="display:flex;"><span> <span style="color:#ae81ff">7</span>
</span></span><span style="display:flex;"><span> <span style="color:#ae81ff">8</span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span> <span style="color:#ae81ff">9</span>    <span style="color:#a6e22e">a</span> <span style="color:#f92672">:=</span> int32(<span style="color:#ae81ff">10</span>)
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">10</span>    <span style="color:#a6e22e">ok</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">atomic</span>.<span style="color:#a6e22e">CompareAndSwapInt32</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">a</span>, <span style="color:#ae81ff">10</span>, <span style="color:#ae81ff">100</span>)
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">11</span>    <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">a</span>, <span style="color:#a6e22e">ok</span>)
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">12</span>    <span style="color:#a6e22e">ok</span> = <span style="color:#a6e22e">atomic</span>.<span style="color:#a6e22e">CompareAndSwapInt32</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">a</span>, <span style="color:#ae81ff">10</span>, <span style="color:#ae81ff">50</span>)
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">13</span>    <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">a</span>, <span style="color:#a6e22e">ok</span>)
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">14</span>}
</span></span></code></pre></div><p>它的执行结果如下</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>1 $ go run main.go
</span></span><span style="display:flex;"><span>2100 true
</span></span><span style="display:flex;"><span>3100 false
</span></span></code></pre></div><p><strong>CAS能做什么</strong></p>
<p>CAS从线程层面来说，它是非阻塞的，其乐观地认为在数据更新期间没有其他线程影响，因此也常常被称为是一种轻量级的乐观锁。它关注的是并发安全，而并非并发同步。</p>
<p>在文章开头时，我们就已经提到原子操作是实现上层同步原语的基石。以互斥锁为例，为了方便理解，我们在这里将它的状态定义为0和1，0代表目前该锁空闲，1代表已被加锁。那么，这个时候，CAS就是管理状态的最佳选择。以下是<code>sync.Mutex</code>中<code>Lock</code>方法的部分实现代码。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span> 1func (m *Mutex) Lock() {
</span></span><span style="display:flex;"><span> 2    // Fast path: grab unlocked mutex.
</span></span><span style="display:flex;"><span> 3    if atomic.CompareAndSwapInt32(&amp;m.state, 0, mutexLocked) {
</span></span><span style="display:flex;"><span> 4        if race.Enabled {
</span></span><span style="display:flex;"><span> 5            race.Acquire(unsafe.Pointer(m))
</span></span><span style="display:flex;"><span> 6        }
</span></span><span style="display:flex;"><span> 7        return
</span></span><span style="display:flex;"><span> 8    }
</span></span><span style="display:flex;"><span> 9    // Slow path (outlined so that the fast path can be inlined)
</span></span><span style="display:flex;"><span>10    m.lockSlow()
</span></span><span style="display:flex;"><span>11}
</span></span></code></pre></div><p>在<code>atomic.CompareAndSwapInt32(&amp;m.state, 0, mutexLocked)</code>中，<code>m.state</code>代表锁的状态，通过CAS函数，判断锁此时的状态是否空闲（<code>m.state==0</code>），是，则对其加锁（这里<code>mutexLocked</code>的值为1）。</p>
<p><strong>源码解读</strong></p>
<p>同样还是以<code>CompareAndSwapInt32</code>为例，它在<code>sync/atomic/doc.go</code>中定义的函数原型如下</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>1func CompareAndSwapInt32(addr *int32, old, new int32) (swapped bool)
</span></span><span style="display:flex;"><span>2
</span></span></code></pre></div><p>对应的汇编代码位于<code>sync/atomic/asm.s</code>中</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>1TEXT ·CompareAndSwapInt32(SB),NOSPLIT,$0
</span></span><span style="display:flex;"><span>2    JMP runtime∕internal∕atomic·Cas(SB)
</span></span></code></pre></div><p>通过指令<code>JMP</code>，跳转到它的实际实现<code>runtime∕internal∕atomic·Cas(SB)</code>。这里需要注意的是，由于架构体系差异，其汇编实现也会存在差别。在本文，我们就以常见的<code>amd64</code>为例，因此进入<code>runtime/internal/atomic/asm_amd64.s</code>，汇编代码如下</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>1TEXT runtime∕internal∕atomic·Cas(SB),NOSPLIT,$0-17
</span></span><span style="display:flex;"><span>2    MOVQ    ptr+0(FP), BX
</span></span><span style="display:flex;"><span>3    MOVL    old+8(FP), AX
</span></span><span style="display:flex;"><span>4    MOVL    new+12(FP), CX
</span></span><span style="display:flex;"><span>5    LOCK
</span></span><span style="display:flex;"><span>6    CMPXCHGL    CX, 0(BX)
</span></span><span style="display:flex;"><span>7    SETEQ   ret+16(FP)
</span></span><span style="display:flex;"><span>8    RET
</span></span></code></pre></div><p>Go的汇编是基于 <code>Plan9</code> 的，我想是因为<strong>Ken Thompson</strong>（他是<code>Plan 9</code>操作系统的核心成员）吧。如果你不熟悉<code>Plan 9</code>，看到这段汇编可能比较懵。小菜刀觉得没必要花过多时间去学懂，因为它很复杂且另类，同时涉及到很多硬件知识。不过如果只是要求看懂简单的汇编代码，稍微研究下还是能够做到的。</p>
<p>由于本文的重点并不是plan 9，所以这里就只解释上述汇编代码的含义。</p>
<p><img src="http://shanks.link/img/go/11.png" alt="图片"></p>
<p><code>atomic.Cas(SB)</code>的函数原型为<code>func CompareAndSwapInt32(addr *int32, old, new int32) (swapped bool)</code>，其入参<code>addr</code>为8个字节（64位系统），<code>old</code>和<code>new</code>分别为4个字节，返回参数<code>swapped</code>为1个字节，所以17=8+4+4+1。</p>
<p><strong>FP（Frame pointer: arguments and locals）</strong>，它是伪寄存器，用来表示函数参数与局部变量。其通过<code>symbol+offset(FP)</code>的方式进行使用。在本函数中，我们可以把FP指向的内容表示为如下所示。</p>
<p><img src="http://shanks.link/img/go/12.png" alt="图片"></p>
<p><code>ptr+0(FP)</code>代表的意思就是ptr从FP偏移0byte处取内容。<code>AX</code>，<code>BX</code>，<code>CX</code>在这里，知道它们是存放数据的寄存器即可。<code>MOV X Y</code>所做的操作是将<code>X</code>上的内容复制到<code>Y</code>上去，<code>MOV</code>后缀<code>L</code>表示“长字”（32位，4个字节），<code>Q</code>表示“四字”（64位，8个字节）。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>1 MOVQ     ptr+0(FP), BX  // 第一个参数addr命名为ptr，放入BP(MOVQ，完成8个字节的复制)
</span></span><span style="display:flex;"><span>2 MOVL     old+8(FP), AX  // 第二个参数old，放入AX（MOVL，完成4个字节的复制）
</span></span><span style="display:flex;"><span>3 MOVL     new+12(FP), CX // 第三个参数new，放入CX（MOVL，完成4个字节的复制）
</span></span></code></pre></div><p>重点来了，<code>LOCK</code>指令。这里参考 Intel 的64位和IA-32架构开发手册</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>1Causes the processor’s LOCK# signal to be asserted during execution of the accompanying instruction (turns the instruction into an atomic instruction). In a multiprocessor environment, the LOCK# signal ensures that the processor has exclusive use of any shared memory while the signal is asserted.
</span></span></code></pre></div><p>在多处理器环境中，指令前缀LOCK能够确保，在执行LOCK随后的指令时，处理器拥有对任何共享内存的独占使用。</p>
<p>LOCK：是一个指令前缀，其后必须跟一条“<strong>读-改-写</strong>”性质的指令，它们可以是ADD, ADC, AND, BTC, BTR, BTS, CMPXCHG, CMPXCH8B, CMPXCHG16B, DEC, INC, NEG, NOT, OR, SBB, SUB, XOR, XADD,  XCHG。该指令是一种锁定协议，用于封锁<strong>总线</strong>，禁止其他 CPU 对内存的操作来保证原子性。</p>
<p>在汇编代码里给指令加上 LOCK 前缀，这是CPU 在<strong>硬件层面支持的原子操作</strong>。但这样的锁<strong>粒度太粗</strong>，其他无关的内存操作也会被阻塞，大幅<strong>降低系统性能</strong>，核数越多愈发显著。</p>
<p>为了提高性能，Intel 从 Pentium 486 开始引入了粒度较细的<strong>缓存锁：MESI协议</strong>（关于该协议，小菜刀在之前的文章《<a href="http://mp.weixin.qq.com/s?__biz=MzIwNTA4MDAwMQ==&amp;mid=2247484486&amp;idx=1&amp;sn=83ebd97be71caad3537502e459182f88&amp;chksm=973710e8a04099fe6f113c38a9e9940c0ff590877ad7ba0a0f4c383356e91619574f052a6064&amp;scene=21#wechat_redirect">CPU缓存体系对Go程序的影响</a>》有详细介绍过）。此时，尽管有LOCK前缀，但如果对应数据已经在 cache line里，也就不用锁定总线，仅锁住缓存行即可。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>1    LOCK
</span></span><span style="display:flex;"><span>2    CMPXCHGL    CX, 0(BX)
</span></span></code></pre></div><p><code>CMPXCHGL</code>，<code>L</code>代表4个字节。该指令会把<code>AX</code>（累加器寄存器）中的内容（<code>old</code>）和第二个操作数（<code>0(BX)</code>）中的内容（<code>ptr</code>所指向的数据）比较。如果相等，则把第一个操作数（<code>CX</code>）中的内容（<code>new</code>）赋值给第二个操作数。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>1 SETEQ    ret+16(FP)
</span></span><span style="display:flex;"><span>2 RET
</span></span></code></pre></div><p><code>SETEQ</code> 与<code>CMPXCHGL</code>是配合使用的，如果<code>CMPXCHGL</code>中比较结果是相等的，则设置<code>ret</code>（即函数原型中的<code>swapped</code>）为1，不等则设置为0。<code>RET</code>代表函数返回。</p>
<p><strong>总结</strong></p>
<p>本文探讨了<code>atomic.CompareAndSwapInt32</code>是如何通过硬件指令<code>LOCK</code>实现原子性操作的封装。但要记住，在不同的架构平台，依赖的机器指令是不同的，本文仅研究的是<code>amd64</code>下的汇编实现。</p>
<p>在Go提供的原子操作库atomic中，除了CAS还有许多有用的原子方法，<strong>它们共同筑起了Go同步原语体系的基石</strong>。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>1func SwapIntX(addr *intX, new intX) (old intX)
</span></span><span style="display:flex;"><span>2func CompareAndSwapIntX(addr *intX, old, new intX) (swapped bool)
</span></span><span style="display:flex;"><span>3func AddIntX(addr *intX, delta intX) (new intX)
</span></span><span style="display:flex;"><span>4func LoadIntX(addr *uintX) (val uintX)
</span></span><span style="display:flex;"><span>5func StoreIntX(addr *intX, val intX)
</span></span><span style="display:flex;"><span>6func XPointer(addr *unsafe.Pointer, val unsafe.Pointer)
</span></span><span style="display:flex;"><span>7
</span></span></code></pre></div><p>那么它们是如何实现的？小菜刀将它们实现的关键指令总结如下。</p>
<ul>
<li><strong>Swap</strong> : <code>XCHGQ</code></li>
<li><strong>CAS</strong> : <code>LOCK</code>+ <code>CMPXCHGQ</code></li>
<li><strong>Add</strong> : <code>LOCK</code> + <code>XADDQ</code></li>
<li><strong>Load</strong> : <code>MOVQ</code></li>
<li><strong>Store</strong> : <code>XCHGQ</code></li>
<li><strong>Pointer</strong> : 以上指令结合GC 调度</li>
</ul>
<p>这里大家可能会好奇，<code>Swap</code>和<code>Store</code>会对共享数据做修改，但是为啥它们没有加<code>LOCK</code>，小菜刀对此也同样疑惑。好在 Intel 的64位和IA-32架构开发手册中给出了答案：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>1If a memory operand is referenced, the processor’s locking protocol is automatically implemented for the duration of the exchange operation, regardless of the presence or absence of the LOCK prefix or of the value of the IOPL
</span></span></code></pre></div><p>在实现<code>Swap</code>和<code>Store</code>方法时，其实不管是否存在<code>LOCK</code>前缀，在交换操作期间（<code>XCHGQ</code>）将自动实现CPU的锁定协议。</p>
<p>除此之外，在<code>Load</code>和<code>Store/Swap</code>的实现中，前者没有使用锁定协议，而后者需要。两者结合，那这不就是一种读共享，写独占的思想吗？</p>
<p><a href="https://mp.weixin.qq.com/s/KpLJkxDV1tofIOnJeyH2mg">以上内容转载自机器铃砍柴刀</a></p>

    </div>
    <footer class="post-footer">
     
 
<div class="post-tags">     
     
    <a href="http://shanks.link/tags/go" rel="tag" title="go">#go#</a>
    
</div>



     <div class="post-nav">
    <div class="post-nav-next post-nav-item">
    
        <a href="http://shanks.link/blog/2021/04/30/%E5%A6%82%E4%BD%95%E6%9C%89%E6%95%88%E5%9C%B0%E6%B5%8B%E8%AF%95go%E4%BB%A3%E7%A0%81/" rel="next" title="如何有效地测试Go代码">
        <i class="fa fa-chevron-left"></i> 如何有效地测试Go代码
        </a>
    
    </div>

    <div class="post-nav-prev post-nav-item">
    
        <a href="http://shanks.link/blog/2021/04/30/golang-append%E6%89%A9%E5%AE%B9%E6%9C%BA%E5%88%B6/" rel="prev" title="Golang append扩容机制">
        Golang append扩容机制 <i class="fa fa-chevron-right"></i>
        </a>
    
    </div>
</div>
      
     
     
     





<script src="https://utteranc.es/client.js"
        repo="shankusu2017@gmail.com/"
        issue-term="pathname"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>
<noscript>Please enable JavaScript to view the <a href="https://github.com/utterance">comments powered by utterances.</a></noscript>

    </footer>
  </article>
</section>

          </div>
        </div>
        <div class="sidebar-toggle">
  <div class="sidebar-toggle-line-wrap">
    <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
    <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
    <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
  </div>
</div>
<aside id="sidebar" class="sidebar">
  <div class="sidebar-inner">

    <section class="site-overview sidebar-panel  sidebar-panel-active ">
      <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image"
        src="http://shanks.link/img/logo.jpg"
        alt="shankusu2017@gmail.com" />
    <p class="site-author-name" itemprop="name">shankusu2017@gmail.com</p>
    <p class="site-description motion-element" itemprop="description"> </p>
</div>
      <nav class="site-state motion-element">
    <div class="site-state-item site-state-posts">
      <a href="http://shanks.link/post/">
        <span class="site-state-item-count">486</span>
        <span class="site-state-item-name">日志</span>
      </a>
    </div>
    <div class="site-state-item site-state-categories">    
        <a href="http://shanks.link/categories/">      
         
        <span class="site-state-item-count">32</span>
        
        <span class="site-state-item-name">分类</span>
        
        </a>
    </div>

    <div class="site-state-item site-state-tags">
        <a href="http://shanks.link/tags/">
         
        <span class="site-state-item-count">37</span>
        
        <span class="site-state-item-name">标签</span>
        </a>
    </div>
</nav>
      
      
<div class="links-of-author motion-element">
    
        <span class="links-of-author-item">
        <a href="https://github.com/shankusu2017" target="_blank" title="GitHub">
            <i class="fa fa-fw fa-github"></i>
            GitHub
        </a>
        </span>
    
</div>


      

      <div class="links-of-blogroll motion-element inline">
<script type="text/javascript" src="//rf.revolvermaps.com/0/0/8.js?i=5b4f2ucxar6&amp;m=0&amp;s=220&amp;c=ff0000&amp;cr1=ffffff&amp;f=arial&amp;l=33&amp;bv=35" async="async"></script>
</div>

    </section>
    
  </div>
</aside>

      </div>
    </main>
   
    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  <span itemprop="copyrightYear">  &copy; 
  2009 - 2022</span>
  <span class="with-love"><i class="fa fa-heart"></i></span>
  <span class="author" itemprop="copyrightHolder">愿星光伴你左右</span>
</div>
<div class="powered-by">
  Powered by - <a class="theme-link" href="http://gohugo.io" target="_blank" title="hugo" >Hugo v0.101.0</a>
</div>
<div class="theme-info">
  Theme by - <a class="theme-link" href="https://github.com/xtfly/hugo-theme-next" target="_blank"> NexT
  </a>
</div>


      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
      <span id="scrollpercent"><span>0</span>%</span>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>
<script type="text/javascript" src="http://shanks.link/js/vendor/jquery/index.js?v=2.1.3"></script>
<script type="text/javascript" src="http://shanks.link/js/vendor/fastclick/lib/fastclick.min.js?v=1.0.6"></script> 
<script type="text/javascript" src="http://shanks.link/js/vendor/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
<script type="text/javascript" src="http://shanks.link/js/vendor/velocity/velocity.min.js?v=1.2.1"></script>
<script type="text/javascript" src="http://shanks.link/js/vendor/velocity/velocity.ui.min.js?v=1.2.1"></script>
<script src="http://shanks.link/js/vendor/ua-parser-js/dist/ua-parser.min.js?v=0.7.9"></script>

<script src="http://shanks.link/js/vendor/fancybox/jquery.fancybox.pack.js?v=2.1.5"></script>

<script type="text/javascript" src="http://shanks.link/js/utils.js"></script>
<script type="text/javascript" src="http://shanks.link/js/motion.js"></script>
<script type="text/javascript" src="http://shanks.link/js/affix.js"></script>
<script type="text/javascript" src="http://shanks.link/js/schemes/pisces.js"></script>

<script type="text/javascript" src="http://shanks.link/js/scrollspy.js"></script>
<script type="text/javascript" src="http://shanks.link/js/post-details.js"></script>
<script type="text/javascript" src="http://shanks.link/js/toc.js"></script>

<script type="text/javascript" src="http://shanks.link/js/bootstrap.js"></script>

<script type="text/javascript" src="http://shanks.link/js/search.js"></script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX", "output/HTML-CSS"],
    tex2jax: {
      inlineMath: [ ['$','$'] ],
      displayMath: [ ['$$','$$'] ],
      processEscapes: true
    },
    "HTML-CSS": { fonts: ["TeX"] }
  });
</script>
<script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML' async></script>
</body>
</html>