<!DOCTYPE HTML>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" /> 
    <title>Go函数调用惯例 - 愿星光伴你左右</title>
    <meta name="keywords" content="git,Git,Lua,lua,Golang,go">
    
    <meta property="og:title" content="Go函数调用惯例">
    <meta property="og:site_name" content="愿星光伴你左右">
    <meta property="og:image" content="/img/author.jpg"> 
    <meta name="title" content="Go函数调用惯例 - 愿星光伴你左右" />
    <meta name="description" content="愿星光伴你左右"> 
    <link rel="shortcut icon" href="http://shanks.link/img/favicon.ico" />
    <link rel="apple-touch-icon" href="http://shanks.link/img/apple-touch-icon.png" />
    <link rel="apple-touch-icon-precomposed" href="http://shanks.link/img/apple-touch-icon.png" />
    <link href="http://shanks.link/js/vendor/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />
    <link href="http://shanks.link/js/vendor/fancybox/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />
    <link href="http://shanks.link/css/main.css" rel="stylesheet" type="text/css" />
    <link href="http://shanks.link/css/syntax.css" rel="stylesheet" type="text/css" />
    <script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post"},
     fancybox: true, 
    motion: true
  };
</script>
</head>
<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">
<div class="container one-collumn sidebar-position-left page-home  ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"> <div class="site-meta  custom-logo ">

  <div class="custom-logo-site-title">
    <a href="http://shanks.link/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">愿星光伴你左右</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle"></p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
    <ul id="menu" class="menu">
      
      
        <li class="menu-item ">
          <a href="http://shanks.link/post/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />首页
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/thinking/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />随想录
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/prose/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />散文
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/%E7%94%9F%E6%B4%BB/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />生活
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/os/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />OS
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/lua/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />lua
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/redis/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />redis
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/go/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />Golang
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/c/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />C
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/openvpn/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />OpenVPN
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/web/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />web
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/openwrt/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />OpenWRT
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/%E8%BF%90%E7%BB%B4/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />运维
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/git/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />Git
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/it/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />IT杂谈
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/about/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />About Me
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/links/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />友情链接
          </a>
        </li>
      
      <li class="menu-item menu-item-search">
        <a href="javascript:;" class="popup-trigger"> <i class="menu-item-icon fa fa-search fa-fw"></i> <br /> 搜索</a>
      </li>
    </ul>
    <div class="site-search">
      <div class="popup">
 <span class="search-icon fa fa-search"></span>
 <input type="text" id="local-search-input">
 <div id="local-search-result"></div>
 <span class="popup-btn-close">close</span>
</div>

    </div>
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
<section id="posts" class="posts-expand">
  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <header class="post-header">
      <h1 class="post-title" itemprop="name headline">
        <a class="post-title-link" href="http://shanks.link/blog/2021/04/28/go%E5%87%BD%E6%95%B0%E8%B0%83%E7%94%A8%E6%83%AF%E4%BE%8B/" itemprop="url">
        Go函数调用惯例
        </a>
      </h1>
      <div class="post-meta">
      <span class="post-time">
<span class="post-meta-item-icon">
    <i class="fa fa-calendar-o"></i>
</span>
<span class="post-meta-item-text">时间：</span>
<time itemprop="dateCreated" datetime="2016-03-22T13:04:35+08:00" content="2021-04-28">
    2021-04-28
</time>
</span> 
      

  <span class="post-category" >
  &nbsp; | &nbsp;
  <span class="post-meta-item-icon">
    <i class="fa fa-folder-o"></i>
  </span>
  <span class="post-meta-item-text">分类：</span>
  
    <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
      <a href="http://shanks.link/categories/go" itemprop="url" rel="index">
        <span itemprop="name">go</span>
      </a>
      &nbsp; 
    </span>
  
</span>


       <span>
&nbsp; | &nbsp;
<span class="post-meta-item-icon">
    <i class="fa fa-eye"></i>
</span>
<span class="post-meta-item-text">阅读：</span>
<span class="leancloud-visitors-count">2973 字 ~6分钟</span>
</span>
      </div>
    </header>
    <div class="post-body" itemprop="articleBody">
    <h2 id="go函数调用惯例">Go函数调用惯例</h2>
<p>本文旨在探讨Go函数中的一个问题：**为什么Go函数能支持多参数返回，而C/C++、java不行？**这其实牵涉到了一个叫做函数调用惯例的问题。</p>
<p><strong>调用惯例</strong></p>
<p>在程序代码中，函数提供了最小功能单元，程序执行实际上就是函数间相互调用的过程。在调用时，函数调用方和被调用方必须遵守某种约定，它们的理解要一致，该约定就被称为函数调用惯例。</p>
<p>函数调用惯例往往由编译器来规定，本文主要关心两个点：</p>
<ul>
<li>
<p>函数的参数（入参与出参）是通过栈还是寄存器传递？</p>
</li>
<li>
<p>如果通过栈传递，是从左至右，还是从右至左入栈？</p>
</li>
<li>
<h5 id="栈">栈</h5>
</li>
</ul>
<p>栈是现代计算机程序里最为重要的概念之一，没有栈就没有函数，也没有局部变量。栈保存了一个函数调用所需要的维护信息，这常常被称为堆栈帧(Stack Frame)或活动记录 (Activate Record)。堆栈帧一般包括如下几方面内容：</p>
<ul>
<li>函数的返回地址和参数。</li>
<li>临时变量:包括函数的非静态局部变量以及编译器自动生成的其他临时变量。</li>
<li>保存的上下文信息:包括在函数调用前后需要保持不变的寄存器。</li>
</ul>
<p>一个堆栈帧可以用<strong>指向栈顶</strong>的栈指针寄存器<strong>SP</strong>与维护当前栈帧的基准地址的基准指针寄存器<strong>BP</strong>来表示。因此，一个典型的函数活动记录可以表示为如下</p>
<p><img src="http://shanks.link/img/Go%E5%87%BD%E6%95%B0%E8%B0%83%E7%94%A8/1.png" alt="img"></p>
<p>在参数及其之后的数据即当前函数的活动记录。BP固定在图中所示的位置（通过它便于索引参数与变量等），它不会随着函数的执行而变化。而SP始终指向栈顶，随着函数的执行，SP会不断变化。在BP之前是该函数的返回地址，在32位机器表示为BP+4，64位机器表示为BP+8，再往前就是压入栈中的参数。BP所直接指向的数据是调用该函数前BP的值，这样在函数返回的时候，BP可以通过读取这个值恢复到调用前的值。</p>
<ul>
<li>
<h5 id="汇编代码解析">汇编代码解析</h5>
</li>
</ul>
<p>下面，我们来对比分析C和Go调用惯例差异。</p>
<ol>
<li><strong>C调用惯例</strong></li>
</ol>
<p>假设有main.c的C程序源文件，其中main函数调用add函数，详细代码如下。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>1// main.c
</span></span><span style="display:flex;"><span>2int add(int arg1, int arg2, int arg3, int arg4,int arg5, int arg6,int arg7, int arg8) {
</span></span><span style="display:flex;"><span>3    return arg1 + arg2 + arg3 + arg4 + arg5 + arg6 + arg7 + arg8;
</span></span><span style="display:flex;"><span>4}
</span></span><span style="display:flex;"><span>5
</span></span><span style="display:flex;"><span>6int main() {
</span></span><span style="display:flex;"><span>7    int i = add(10, 20, 30, 40, 50, 60, 70, 80);
</span></span><span style="display:flex;"><span>8}
</span></span></code></pre></div><p>我们通过clang编译器在x86_64平台上进行编译。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>1$ clang -v
</span></span><span style="display:flex;"><span>2Apple clang version 12.0.0 (clang-1200.0.32.29)
</span></span><span style="display:flex;"><span>3Target: x86_64-apple-darwin19.5.0
</span></span></code></pre></div><p>main.c 编译后得到的汇编代码如下</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span> 1 $ clang -S main.c
</span></span><span style="display:flex;"><span> 2  ...
</span></span><span style="display:flex;"><span> 3_main:                                
</span></span><span style="display:flex;"><span> 4  ...
</span></span><span style="display:flex;"><span> 5    subq    $32, %rsp      
</span></span><span style="display:flex;"><span> 6    movl    $10, %edi    // 将参数1数据置于edi寄存器
</span></span><span style="display:flex;"><span> 7    movl    $20, %esi    // 将参数2数据置于esi寄存器
</span></span><span style="display:flex;"><span> 8    movl    $30, %edx    // 将参数3数据置于edx寄存器
</span></span><span style="display:flex;"><span> 9    movl    $40, %ecx    // 将参数4数据置于ecx寄存器
</span></span><span style="display:flex;"><span>10    movl    $50, %r8d    // 将参数5数据置于r8d寄存器
</span></span><span style="display:flex;"><span>11    movl    $60, %r9d    // 将参数6数据置于r9d寄存器
</span></span><span style="display:flex;"><span>12    movl    $70, (%rsp)  // 将参数7数据置于栈上
</span></span><span style="display:flex;"><span>13    movl    $80, 8(%rsp) // 将参数8数据置于栈上
</span></span><span style="display:flex;"><span>14    callq   _add         // 调用add函数
</span></span><span style="display:flex;"><span>15    xorl    %ecx, %ecx
</span></span><span style="display:flex;"><span>16    movl    %eax, -4(%rbp)
</span></span><span style="display:flex;"><span>17    movl    %ecx, %eax  // 最终通过eax寄存器承载着返回值返回
</span></span><span style="display:flex;"><span>18    addq    $32, %rsp
</span></span><span style="display:flex;"><span>19    popq    %rbp
</span></span><span style="display:flex;"><span>20    retq
</span></span><span style="display:flex;"><span>21  ...  
</span></span><span style="display:flex;"><span>22_add:                                 
</span></span><span style="display:flex;"><span>23  ...
</span></span><span style="display:flex;"><span>24    movl    24(%rbp), %eax  
</span></span><span style="display:flex;"><span>25    movl    16(%rbp), %r10d 
</span></span><span style="display:flex;"><span>26    movl    %edi, -4(%rbp)  // 将edi寄存器上的数据放置于栈上
</span></span><span style="display:flex;"><span>27    movl    %esi, -8(%rbp)  // 将esi寄存器上的数据放置于栈上
</span></span><span style="display:flex;"><span>28    movl    %edx, -12(%rbp) // 将edx寄存器上的数据放置于栈上
</span></span><span style="display:flex;"><span>29    movl    %ecx, -16(%rbp) // 将ecx寄存器上的数据放置于栈上
</span></span><span style="display:flex;"><span>30    movl    %r8d, -20(%rbp) // 将r8d寄存器上的数据放置于栈上
</span></span><span style="display:flex;"><span>31    movl    %r9d, -24(%rbp) // 将edi寄存器上的数据放置于栈上
</span></span><span style="display:flex;"><span>32    movl    -4(%rbp), %ecx  // 将栈上的数据 10 放置于ecx寄存器
</span></span><span style="display:flex;"><span>33    addl    -8(%rbp), %ecx  // 实际为：ecx = ecx + 20
</span></span><span style="display:flex;"><span>34    addl    -12(%rbp), %ecx // ecx = ecx + 30
</span></span><span style="display:flex;"><span>35    addl    -16(%rbp), %ecx // ecx = ecx + 40
</span></span><span style="display:flex;"><span>36    addl    -20(%rbp), %ecx // ecx = ecx + 50 
</span></span><span style="display:flex;"><span>37    addl    -24(%rbp), %ecx // ecx = ecx + 60
</span></span><span style="display:flex;"><span>38    addl    16(%rbp), %ecx  // ecx = ecx + 70
</span></span><span style="display:flex;"><span>39    addl    24(%rbp), %ecx  // ecx = ecx + 80
</span></span><span style="display:flex;"><span>40    movl    %eax, -28(%rbp)        
</span></span><span style="display:flex;"><span>41    movl    %ecx, %eax      // 最终通过eax寄存器承载着返回值返回
</span></span><span style="display:flex;"><span>42    popq    %rbp
</span></span><span style="display:flex;"><span>43    retq
</span></span><span style="display:flex;"><span>44  ...  
</span></span></code></pre></div><p>因此，在main函数调用add函数之前，其参数存放如下图所示</p>
<p><img src="http://shanks.link/img/Go%E5%87%BD%E6%95%B0%E8%B0%83%E7%94%A8/2.png" alt="img"></p>
<p>调用add函数后的数据存放如下图所示</p>
<p><img src="http://shanks.link/img/Go%E5%87%BD%E6%95%B0%E8%B0%83%E7%94%A8/3.png" alt="img"></p>
<p>因此，对于默认的C语言调用惯例（cdecl调用惯例），我们可以得出以下结论</p>
<ul>
<li>当函数参数不超过六个时，其参数会按照顺序分别使用 edi、esi、edx、ecx、r8d 和 r9d 六个寄存器进行传递；</li>
<li>当参数超过六个，那么超过的参数会使用栈传递，函数的参数会以从右到左的顺序依次入栈</li>
</ul>
<p><strong>C语言函数的返回值是通过寄存器传递完成的</strong>，不过根据返回值的大小，有以下三种情况。</p>
<ul>
<li>小于4字节，返回值存入eax寄存器，由函数调用方读取eax的值</li>
<li>返回值5到8字节，采用eax和edx寄存器联合返回</li>
<li>大于8个字节，首先在栈上额外开辟一部分空间temp，将temp对象的地址做为隐藏参数入栈。函数返回时将数据拷贝给temp对象，并将temp对象的地址用寄存器eax传出。调用方从eax指向的temp对象拷贝内容。</li>
</ul>
<p>可以看到，<strong>由于采用了寄存器传递返回值的设计，C语言的返回值只能有一个</strong>，这里回答了C为什么不能实现函数多值返回。</p>
<ol>
<li><strong>Go函数调用惯例</strong></li>
</ol>
<p>假设有main.go的Go程序源文件，和C中例子一样，其中main函数调用add函数，详细代码如下。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#ae81ff">1</span><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">3</span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">add</span>(<span style="color:#a6e22e">arg1</span>, <span style="color:#a6e22e">arg2</span>, <span style="color:#a6e22e">arg3</span>, <span style="color:#a6e22e">arg4</span>, <span style="color:#a6e22e">arg5</span>, <span style="color:#a6e22e">arg6</span>, <span style="color:#a6e22e">arg7</span>, <span style="color:#a6e22e">arg8</span> <span style="color:#66d9ef">int</span>) <span style="color:#66d9ef">int</span> {
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">4</span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">arg1</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">arg2</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">arg3</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">arg4</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">arg5</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">arg6</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">arg7</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">arg8</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">5</span>}
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">6</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">7</span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">8</span>    <span style="color:#a6e22e">_</span> = <span style="color:#a6e22e">add</span>(<span style="color:#ae81ff">10</span>, <span style="color:#ae81ff">20</span>, <span style="color:#ae81ff">30</span>, <span style="color:#ae81ff">40</span>, <span style="color:#ae81ff">50</span>, <span style="color:#ae81ff">60</span>, <span style="color:#ae81ff">70</span>, <span style="color:#ae81ff">80</span>)
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">9</span>}
</span></span></code></pre></div><p>使用<code>go tool compile -S -N -l main.go</code> 命令编译得到如下汇编代码</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span> 1&#34;&#34;.main STEXT size=122 args=0x0 locals=0x50
</span></span><span style="display:flex;"><span> 2        // 80代表栈帧大小为80个字节，0是入参和出参大小之和
</span></span><span style="display:flex;"><span> 3        0x0000 00000 (main.go:7)        TEXT    &#34;&#34;.main(SB), ABIInternal, $80-0
</span></span><span style="display:flex;"><span> 4        ...
</span></span><span style="display:flex;"><span> 5        0x000f 00015 (main.go:7)        SUBQ    $80, SP
</span></span><span style="display:flex;"><span> 6        0x0013 00019 (main.go:7)        MOVQ    BP, 72(SP)
</span></span><span style="display:flex;"><span> 7        0x0018 00024 (main.go:7)        LEAQ    72(SP), BP
</span></span><span style="display:flex;"><span> 8        ...
</span></span><span style="display:flex;"><span> 9        0x001d 00029 (main.go:8)        MOVQ    $10, (SP)  // 将数据填置栈上
</span></span><span style="display:flex;"><span>10        0x0025 00037 (main.go:8)        MOVQ    $20, 8(SP)
</span></span><span style="display:flex;"><span>11        0x002e 00046 (main.go:8)        MOVQ    $30, 16(SP)
</span></span><span style="display:flex;"><span>12        0x0037 00055 (main.go:8)        MOVQ    $40, 24(SP)
</span></span><span style="display:flex;"><span>13        0x0040 00064 (main.go:8)        MOVQ    $50, 32(SP)
</span></span><span style="display:flex;"><span>14        0x0049 00073 (main.go:8)        MOVQ    $60, 40(SP)
</span></span><span style="display:flex;"><span>15        0x0052 00082 (main.go:8)        MOVQ    $70, 48(SP)
</span></span><span style="display:flex;"><span>16        0x005b 00091 (main.go:8)        MOVQ    $80, 56(SP)
</span></span><span style="display:flex;"><span>17        0x0064 00100 (main.go:8)        PCDATA  $1, $0
</span></span><span style="display:flex;"><span>18        0x0064 00100 (main.go:8)        CALL    &#34;&#34;.add(SB) // 调用add函数
</span></span><span style="display:flex;"><span>19        0x0069 00105 (main.go:9)        MOVQ    72(SP), BP
</span></span><span style="display:flex;"><span>20        0x006e 00110 (main.go:9)        ADDQ    $80, SP
</span></span><span style="display:flex;"><span>21        0x0072 00114 (main.go:9)        RET
</span></span><span style="display:flex;"><span>22        ...
</span></span><span style="display:flex;"><span>23
</span></span><span style="display:flex;"><span>24&#34;&#34;.add STEXT nosplit size=55 args=0x48 locals=0x0
</span></span><span style="display:flex;"><span>25        // add栈帧大小为0字节，72是 8个入参 + 1个出参 的字节大小之和
</span></span><span style="display:flex;"><span>26        0x0000 00000 (main.go:3)        TEXT    &#34;&#34;.add(SB), NOSPLIT|ABIInternal, $0-72
</span></span><span style="display:flex;"><span>27        ...
</span></span><span style="display:flex;"><span>28        0x0000 00000 (main.go:3)        MOVQ    $0, &#34;&#34;.~r8+72(SP)  // 初始化返回值，将其置为0
</span></span><span style="display:flex;"><span>29        0x0009 00009 (main.go:4)        MOVQ    &#34;&#34;.arg1+8(SP), AX  // 开始将栈上的值放置在AX寄存器上
</span></span><span style="display:flex;"><span>30        0x000e 00014 (main.go:4)        ADDQ    &#34;&#34;.arg2+16(SP), AX // AX = AX + 20
</span></span><span style="display:flex;"><span>31        0x0013 00019 (main.go:4)        ADDQ    &#34;&#34;.arg3+24(SP), AX
</span></span><span style="display:flex;"><span>32        0x0018 00024 (main.go:4)        ADDQ    &#34;&#34;.arg4+32(SP), AX
</span></span><span style="display:flex;"><span>33        0x001d 00029 (main.go:4)        ADDQ    &#34;&#34;.arg5+40(SP), AX
</span></span><span style="display:flex;"><span>34        0x0022 00034 (main.go:4)        ADDQ    &#34;&#34;.arg6+48(SP), AX
</span></span><span style="display:flex;"><span>35        0x0027 00039 (main.go:4)        ADDQ    &#34;&#34;.arg7+56(SP), AX
</span></span><span style="display:flex;"><span>36        0x002c 00044 (main.go:4)        ADDQ    &#34;&#34;.arg8+64(SP), AX
</span></span><span style="display:flex;"><span>37        0x0031 00049 (main.go:4)        MOVQ    AX, &#34;&#34;.~r8+72(SP)  // 将结果AX填置到对应栈上位置
</span></span><span style="display:flex;"><span>38        0x0036 00054 (main.go:4)        RET
</span></span><span style="display:flex;"><span>39        ...
</span></span></code></pre></div><p>同样的，我们将main函数调用add函数时，其参数存放可视化出来如下所示</p>
<p><img src="http://shanks.link/img/Go%E5%87%BD%E6%95%B0%E8%B0%83%E7%94%A8/4.png" alt="img"></p>
<p>这里我们可以看到，add函数的入参压栈顺序和C一样，都是从右至左，即最后一个参数在靠近栈底方向的SP+56~SP+64，而第一个参数是在栈顶SP~SP+8。</p>
<p>调用add函数后的数据存放如下图所示</p>
<p><img src="http://shanks.link/img/Go%E5%87%BD%E6%95%B0%E8%B0%83%E7%94%A8/5.png" alt="img"></p>
<p>注意，这里与C中调用不同的是，由于通过栈传递参数，所以并不需要将寄存器中保存的参数再拷贝至栈上。在本例中，add帧直接调用main帧栈上的数据进行计算即可。通过将结果累加到AX寄存器上，最后再将最终的返回值置回栈中即可，返回值的位置是在最后一个入参之上。</p>
<p>因此我们知道，<strong>Go函数的出入参均是通过栈来传递的。所以，如果想返回多值，那么仅需要在栈上多分配一些内存即可</strong>。到这里也就回答了文章开头的问题。</p>
<p><strong>总结</strong></p>
<p>在函数调用惯例中，C语言和Go语言选择了不同的实现方式。C语言同时使用了寄存器与栈传递参数，而Go语言除了在函数计算过程中会临时使用例如AX这种累加寄存器之外，全部是通过栈完成参数的传递。</p>
<p>任何选择都会有它的优劣所在，<strong>总体来讲，C语言实现方式更多地是考虑性能，Go语言实现方式更多地是考虑复杂度</strong>。下面，我们详细比较一下两种调用惯例。</p>
<h6 id="c语言方式"><strong>C语言方式</strong></h6>
<p>CPU访问寄存器的效率会明显高于栈；</p>
<p>不同平台的寄存器存在差异，需要为每种架构设定对应的寄存器传递规则；</p>
<p>参数过多时，需要同时使用寄存器与栈传递，增加了实现复杂度，且此时函数调用性能和Go语言方式差别不再大；</p>
<p>只能支持一个返回值。</p>
<h6 id="go语言方式"><strong>Go语言方式</strong></h6>
<p>遵循Go语言的跨平台编译理念：都是通过栈传递，因此不用担心架构不同带来的寄存器差异；</p>
<p>参数较少的情况下，函数调用性能会比C语言方式低；</p>
<p>编译器易于维护；</p>
<p>可以支持多返回值。</p>
<p><a href="https://mp.weixin.qq.com/s/9XuRwpAjCJe9_cTDveqItg">以上内容转载自机器铃砍柴刀</a></p>

    </div>
    <footer class="post-footer">
     
 
<div class="post-tags">     
     
    <a href="http://shanks.link/tags/go" rel="tag" title="go">#go#</a>
    
</div>



     <div class="post-nav">
    <div class="post-nav-next post-nav-item">
    
        <a href="http://shanks.link/blog/2021/04/29/%E4%B8%80%E6%96%87%E8%AF%BB%E6%87%82channel%E8%AE%BE%E8%AE%A1/" rel="next" title="一文读懂channel设计">
        <i class="fa fa-chevron-left"></i> 一文读懂channel设计
        </a>
    
    </div>

    <div class="post-nav-prev post-nav-item">
    
        <a href="http://shanks.link/blog/2021/04/28/cpu%E7%BC%93%E5%AD%98%E4%BD%93%E7%B3%BB%E5%AF%B9%E7%A8%8B%E5%BA%8F%E7%9A%84%E5%BD%B1%E5%93%8D/" rel="prev" title="CPU缓存体系对程序的影响">
        CPU缓存体系对程序的影响 <i class="fa fa-chevron-right"></i>
        </a>
    
    </div>
</div>
      
     
     
     





<script src="https://utteranc.es/client.js"
        repo="shankusu2017@gmail.com/"
        issue-term="pathname"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>
<noscript>Please enable JavaScript to view the <a href="https://github.com/utterance">comments powered by utterances.</a></noscript>

    </footer>
  </article>
</section>

          </div>
        </div>
        <div class="sidebar-toggle">
  <div class="sidebar-toggle-line-wrap">
    <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
    <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
    <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
  </div>
</div>
<aside id="sidebar" class="sidebar">
  <div class="sidebar-inner">

    <section class="site-overview sidebar-panel  sidebar-panel-active ">
      <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image"
        src="http://shanks.link/img/logo.jpg"
        alt="shankusu2017@gmail.com" />
    <p class="site-author-name" itemprop="name">shankusu2017@gmail.com</p>
    <p class="site-description motion-element" itemprop="description"> </p>
</div>
      <nav class="site-state motion-element">
    <div class="site-state-item site-state-posts">
      <a href="http://shanks.link/post/">
        <span class="site-state-item-count">497</span>
        <span class="site-state-item-name">日志</span>
      </a>
    </div>
    <div class="site-state-item site-state-categories">    
        <a href="http://shanks.link/categories/">      
         
        <span class="site-state-item-count">32</span>
        
        <span class="site-state-item-name">分类</span>
        
        </a>
    </div>

    <div class="site-state-item site-state-tags">
        <a href="http://shanks.link/tags/">
         
        <span class="site-state-item-count">37</span>
        
        <span class="site-state-item-name">标签</span>
        </a>
    </div>
</nav>
      
      
<div class="links-of-author motion-element">
    
        <span class="links-of-author-item">
        <a href="https://github.com/shankusu2017" target="_blank" title="GitHub">
            <i class="fa fa-fw fa-github"></i>
            GitHub
        </a>
        </span>
    
</div>


      

      <div class="links-of-blogroll motion-element inline">
<script type="text/javascript" src="//rf.revolvermaps.com/0/0/8.js?i=5b4f2ucxar6&amp;m=0&amp;s=220&amp;c=ff0000&amp;cr1=ffffff&amp;f=arial&amp;l=33&amp;bv=35" async="async"></script>
</div>

    </section>
    
  </div>
</aside>

      </div>
    </main>
   
    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  <span itemprop="copyrightYear">  &copy; 
  2009 - 2022</span>
  <span class="with-love"><i class="fa fa-heart"></i></span>
  <span class="author" itemprop="copyrightHolder">愿星光伴你左右</span>
</div>
<div class="powered-by">
  Powered by - <a class="theme-link" href="http://gohugo.io" target="_blank" title="hugo" >Hugo v0.101.0</a>
</div>
<div class="theme-info">
  Theme by - <a class="theme-link" href="https://github.com/xtfly/hugo-theme-next" target="_blank"> NexT
  </a>
</div>


      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
      <span id="scrollpercent"><span>0</span>%</span>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>
<script type="text/javascript" src="http://shanks.link/js/vendor/jquery/index.js?v=2.1.3"></script>
<script type="text/javascript" src="http://shanks.link/js/vendor/fastclick/lib/fastclick.min.js?v=1.0.6"></script> 
<script type="text/javascript" src="http://shanks.link/js/vendor/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
<script type="text/javascript" src="http://shanks.link/js/vendor/velocity/velocity.min.js?v=1.2.1"></script>
<script type="text/javascript" src="http://shanks.link/js/vendor/velocity/velocity.ui.min.js?v=1.2.1"></script>
<script src="http://shanks.link/js/vendor/ua-parser-js/dist/ua-parser.min.js?v=0.7.9"></script>

<script src="http://shanks.link/js/vendor/fancybox/jquery.fancybox.pack.js?v=2.1.5"></script>

<script type="text/javascript" src="http://shanks.link/js/utils.js"></script>
<script type="text/javascript" src="http://shanks.link/js/motion.js"></script>
<script type="text/javascript" src="http://shanks.link/js/affix.js"></script>
<script type="text/javascript" src="http://shanks.link/js/schemes/pisces.js"></script>

<script type="text/javascript" src="http://shanks.link/js/scrollspy.js"></script>
<script type="text/javascript" src="http://shanks.link/js/post-details.js"></script>
<script type="text/javascript" src="http://shanks.link/js/toc.js"></script>

<script type="text/javascript" src="http://shanks.link/js/bootstrap.js"></script>

<script type="text/javascript" src="http://shanks.link/js/search.js"></script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX", "output/HTML-CSS"],
    tex2jax: {
      inlineMath: [ ['$','$'] ],
      displayMath: [ ['$$','$$'] ],
      processEscapes: true
    },
    "HTML-CSS": { fonts: ["TeX"] }
  });
</script>
<script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML' async></script>
</body>
</html>