<!DOCTYPE HTML>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" /> 
    <title>上下文Context - 愿星光伴你左右</title>
    <meta name="keywords" content="git,Git,Lua,lua,Golang,go">
    
    <meta property="og:title" content="上下文Context">
    <meta property="og:site_name" content="愿星光伴你左右">
    <meta property="og:image" content="/img/author.jpg"> 
    <meta name="title" content="上下文Context - 愿星光伴你左右" />
    <meta name="description" content="愿星光伴你左右"> 
    <link rel="shortcut icon" href="http://shanks.link/img/favicon.ico" />
    <link rel="apple-touch-icon" href="http://shanks.link/img/apple-touch-icon.png" />
    <link rel="apple-touch-icon-precomposed" href="http://shanks.link/img/apple-touch-icon.png" />
    <link href="http://shanks.link/js/vendor/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />
    <link href="http://shanks.link/js/vendor/fancybox/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />
    <link href="http://shanks.link/css/main.css" rel="stylesheet" type="text/css" />
    <link href="http://shanks.link/css/syntax.css" rel="stylesheet" type="text/css" />
    <script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post"},
     fancybox: true, 
    motion: true
  };
</script>
</head>
<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">
<div class="container one-collumn sidebar-position-left page-home  ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"> <div class="site-meta  custom-logo ">

  <div class="custom-logo-site-title">
    <a href="http://shanks.link/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">愿星光伴你左右</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle"></p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
    <ul id="menu" class="menu">
      
      
        <li class="menu-item ">
          <a href="http://shanks.link/post/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />首页
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/thinking/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />随想录
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/prose/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />散文
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/%E7%94%9F%E6%B4%BB/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />生活
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/os/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />OS
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/lua/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />lua
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/redis/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />redis
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/go/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />Golang
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/c/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />C
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/openvpn/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />OpenVPN
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/web/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />web
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/openwrt/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />OpenWRT
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/%E8%BF%90%E7%BB%B4/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />运维
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/git/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />Git
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/%E9%B8%9F%E5%93%A5%E7%9A%84%E7%A7%81%E6%88%BF%E8%8F%9C/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />鸟哥的私房菜
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/it/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />IT杂谈
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/about/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />About Me
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/links/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />友情链接
          </a>
        </li>
      
      <li class="menu-item menu-item-search">
        <a href="javascript:;" class="popup-trigger"> <i class="menu-item-icon fa fa-search fa-fw"></i> <br /> 搜索</a>
      </li>
    </ul>
    <div class="site-search">
      <div class="popup">
 <span class="search-icon fa fa-search"></span>
 <input type="text" id="local-search-input">
 <div id="local-search-result"></div>
 <span class="popup-btn-close">close</span>
</div>

    </div>
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
<section id="posts" class="posts-expand">
  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <header class="post-header">
      <h1 class="post-title" itemprop="name headline">
        <a class="post-title-link" href="http://shanks.link/blog/2021/04/15/%E4%B8%8A%E4%B8%8B%E6%96%87context/" itemprop="url">
        上下文Context
        </a>
      </h1>
      <div class="post-meta">
      <span class="post-time">
<span class="post-meta-item-icon">
    <i class="fa fa-calendar-o"></i>
</span>
<span class="post-meta-item-text">时间：</span>
<time itemprop="dateCreated" datetime="2016-03-22T13:04:35+08:00" content="2021-04-15">
    2021-04-15
</time>
</span> 
      

  <span class="post-category" >
  &nbsp; | &nbsp;
  <span class="post-meta-item-icon">
    <i class="fa fa-folder-o"></i>
  </span>
  <span class="post-meta-item-text">分类：</span>
  
    <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
      <a href="http://shanks.link/categories/go" itemprop="url" rel="index">
        <span itemprop="name">go</span>
      </a>
      &nbsp; 
    </span>
  
</span>


       <span>
&nbsp; | &nbsp;
<span class="post-meta-item-icon">
    <i class="fa fa-eye"></i>
</span>
<span class="post-meta-item-text">阅读：</span>
<span class="leancloud-visitors-count">3012 字 ~7分钟</span>
</span>
      </div>
    </header>
    <div class="post-body" itemprop="articleBody">
    <p><a href="https://draveness.me/golang/docs/part3-runtime/ch06-concurrency/golang-context/">以下内容转载自面向信仰编程</a></p>
<h1 id="61-上下文-context-">6.1 上下文 Context #</h1>
<p>上下文 context.Context Go 语言中用来设置截止日期、同步信号，传递请求相关值的结构体。上下文与 Goroutine 有比较密切的关系，是 Go 语言中独特的设计，在其他编程语言中我们很少见到类似的概念。</p>
<p>context.Context 是 Go 语言在 1.7 版本中引入标准库的接口1，该接口定义了四个需要实现的方法，其中包括：</p>
<ol>
<li>Deadline — 返回 context.Context 被取消的时间，也就是完成工作的截止日期；</li>
<li>Done — 返回一个 Channel，这个 Channel 会在当前工作完成或者上下文被取消后关闭，多次调用 Done 方法会返回同一个 Channel；</li>
<li>Err — 返回 context.Context 结束的原因，它只会在 Done 方法对应的 Channel 关闭时返回非空的值；
如果 context.Context 被取消，会返回 Canceled 错误；
如果 context.Context 超时，会返回 DeadlineExceeded 错误；</li>
<li>Value — 从 context.Context 中获取键对应的值，对于同一个上下文来说，多次调用 Value 并传入相同的 Key 会返回相同的结果，该方法可以用来传递请求特定的数据；</li>
</ol>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00f">type</span> Context <span style="color:#00f">interface</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#c34e00">Deadline</span>() (deadline time.Time, ok <span style="color:#00f">bool</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#c34e00">Done</span>() &lt;-<span style="color:#00f">chan</span> <span style="color:#00f">struct</span>{}
</span></span><span style="display:flex;"><span>	<span style="color:#c34e00">Err</span>() <span style="color:#00f">error</span>
</span></span><span style="display:flex;"><span>	<span style="color:#c34e00">Value</span>(key <span style="color:#00f">interface</span>{}) <span style="color:#00f">interface</span>{}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>context 包中提供的 context.Background、context.TODO、context.WithDeadline 和 context.WithValue 函数会返回实现该接口的私有结构体，我们会在后面详细介绍它们的工作原理。</p>
<h2 id="611-设计原理-">6.1.1 设计原理 #</h2>
<p>在 Goroutine 构成的树形结构中对信号进行同步以减少计算资源的浪费是 context.Context 的最大作用。Go 服务的每一个请求都是通过单独的 Goroutine 处理的2，HTTP/RPC 请求的处理器会启动新的 Goroutine 访问数据库和其他服务。</p>
<p>如下图所示，我们可能会创建多个 Goroutine 来处理一次请求，而 context.Context 的作用是在不同 Goroutine 之间同步请求特定数据、取消信号以及处理请求的截止日期。</p>
<p><img src="http://shanks.link/img/Go%E4%B8%8A%E4%B8%8B%E6%96%87Context/1.png" alt="img"></p>
<p><strong>图 6-1 Context 与 Goroutine 树</strong></p>
<p>每一个 context.Context 都会从最顶层的 Goroutine 一层一层传递到最下层。context.Context 可以在上层 Goroutine 执行出现错误时，将信号及时同步给下层。</p>
<p><img src="http://shanks.link/img/Go%E4%B8%8A%E4%B8%8B%E6%96%87Context/2.png" alt="img"></p>
<p><strong>图 6-2 不使用 Context 同步信号</strong></p>
<p>如上图所示，当最上层的 Goroutine 因为某些原因执行失败时，下层的 Goroutine 由于没有接收到这个信号所以会继续工作；但是当我们正确地使用 context.Context 时，就可以在下层及时停掉无用的工作以减少额外资源的消耗：</p>
<p><img src="http://shanks.link/img/Go%E4%B8%8A%E4%B8%8B%E6%96%87Context/3.png" alt="img"></p>
<p>图 6-3 使用 Context 同步信号</p>
<p>我们可以通过一个代码片段了解 context.Context 是如何对信号进行同步的。在这段代码中，我们创建了一个过期时间为 1s 的上下文，并向上下文传入 handle 函数，该方法会使用 500ms 的时间处理传入的请求：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00f">func</span> <span style="color:#c34e00">main</span>() {
</span></span><span style="display:flex;"><span>	ctx, cancel := context.<span style="color:#c34e00">WithTimeout</span>(context.<span style="color:#c34e00">Background</span>(), 1*time.Second)
</span></span><span style="display:flex;"><span>	<span style="color:#00f">defer</span> <span style="color:#c34e00">cancel</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#00f">go</span> <span style="color:#c34e00">handle</span>(ctx, 500*time.Millisecond)
</span></span><span style="display:flex;"><span>	<span style="color:#00f">select</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#00f">case</span> &lt;-ctx.<span style="color:#c34e00">Done</span>():
</span></span><span style="display:flex;"><span>		fmt.<span style="color:#c34e00">Println</span>(<span style="color:#009c00">&#34;main&#34;</span>, ctx.<span style="color:#c34e00">Err</span>())
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00f">func</span> <span style="color:#c34e00">handle</span>(ctx context.Context, duration time.Duration) {
</span></span><span style="display:flex;"><span>	<span style="color:#00f">select</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#00f">case</span> &lt;-ctx.<span style="color:#c34e00">Done</span>():
</span></span><span style="display:flex;"><span>		fmt.<span style="color:#c34e00">Println</span>(<span style="color:#009c00">&#34;handle&#34;</span>, ctx.<span style="color:#c34e00">Err</span>())
</span></span><span style="display:flex;"><span>	<span style="color:#00f">case</span> &lt;-time.<span style="color:#c34e00">After</span>(duration):
</span></span><span style="display:flex;"><span>		fmt.<span style="color:#c34e00">Println</span>(<span style="color:#009c00">&#34;process request with&#34;</span>, duration)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>因为过期时间大于处理时间，所以我们有足够的时间处理该请求，运行上述代码会打印出下面的内容：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ go run context.go
</span></span><span style="display:flex;"><span>process request with 500ms
</span></span><span style="display:flex;"><span>main context deadline exceeded
</span></span></code></pre></div><p>handle 函数没有进入超时的 select 分支，但是 main 函数的 select 却会等待 context.Context 超时并打印出 main context deadline exceeded。</p>
<p>如果我们将处理请求时间增加至 1500ms，整个程序都会因为上下文的过期而被中止，：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ go run context.go
</span></span><span style="display:flex;"><span>main context deadline exceeded
</span></span><span style="display:flex;"><span>handle context deadline exceeded
</span></span></code></pre></div><p>相信这两个例子能够帮助各位读者理解 context.Context 的使用方法和设计原理 — 多个 Goroutine 同时订阅 ctx.Done() 管道中的消息，一旦接收到取消信号就立刻停止当前正在执行的工作。</p>
<h2 id="612-默认上下文">6.1.2 默认上下文 </h2>
<p>context 包中最常用的方法还是 context.Background、context.TODO，这两个方法都会返回预先初始化好的私有变量 background 和 todo，它们会在同一个 Go 程序中被复用：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00f">func</span> <span style="color:#c34e00">Background</span>() Context {
</span></span><span style="display:flex;"><span>	<span style="color:#00f">return</span> background
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00f">func</span> <span style="color:#c34e00">TODO</span>() Context {
</span></span><span style="display:flex;"><span>	<span style="color:#00f">return</span> todo
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>这两个私有变量都是通过 new(emptyCtx) 语句初始化的，它们是指向私有结构体 context.emptyCtx 的指针，这是最简单、最常用的上下文类型：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00f">type</span> emptyCtx <span style="color:#00f">int</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00f">func</span> (*emptyCtx) <span style="color:#c34e00">Deadline</span>() (deadline time.Time, ok <span style="color:#00f">bool</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#00f">return</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00f">func</span> (*emptyCtx) <span style="color:#c34e00">Done</span>() &lt;-<span style="color:#00f">chan</span> <span style="color:#00f">struct</span>{} {
</span></span><span style="display:flex;"><span>	<span style="color:#00f">return</span> <span style="color:#00f">nil</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00f">func</span> (*emptyCtx) <span style="color:#c34e00">Err</span>() <span style="color:#00f">error</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#00f">return</span> <span style="color:#00f">nil</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00f">func</span> (*emptyCtx) <span style="color:#c34e00">Value</span>(key <span style="color:#00f">interface</span>{}) <span style="color:#00f">interface</span>{} {
</span></span><span style="display:flex;"><span>	<span style="color:#00f">return</span> <span style="color:#00f">nil</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>从上述代码中，我们不难发现 context.emptyCtx 通过空方法实现了 context.Context 接口中的所有方法，它没有任何功能。</p>
<p><img src="http://shanks.link/img/Go%E4%B8%8A%E4%B8%8B%E6%96%87Context/4.png" alt="img"></p>
<p><strong>图 6-4 Context 层级关系</strong></p>
<p>从源代码来看，context.Background 和 context.TODO 也只是互为别名，没有太大的差别，只是在使用和语义上稍有不同：</p>
<p>context.Background 是上下文的默认值，所有其他的上下文都应该从它衍生出来；
context.TODO 应该仅在不确定应该使用哪种上下文时使用；
在多数情况下，如果当前函数没有上下文作为入参，我们都会使用 context.Background 作为起始的上下文向下传递。</p>
<h2 id="613-取消信号">6.1.3 取消信号</h2>
<p>context.WithCancel 函数能够从 context.Context 中衍生出一个新的子上下文并返回用于取消该上下文的函数。一旦我们执行返回的取消函数，当前上下文以及它的子上下文都会被取消，所有的 Goroutine 都会同步收到这一取消信号。</p>
<p>golang-parent-cancel-context</p>
<p><img src="http://shanks.link/img/Go%E4%B8%8A%E4%B8%8B%E6%96%87Context/5.png" alt="img"></p>
<p>我们直接从 context.WithCancel 函数的实现来看它到底做了什么：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00f">func</span> <span style="color:#c34e00">WithCancel</span>(parent Context) (ctx Context, cancel CancelFunc) {
</span></span><span style="display:flex;"><span>	c := <span style="color:#c34e00">newCancelCtx</span>(parent)
</span></span><span style="display:flex;"><span>	<span style="color:#c34e00">propagateCancel</span>(parent, &amp;c)
</span></span><span style="display:flex;"><span>	<span style="color:#00f">return</span> &amp;c, <span style="color:#00f">func</span>() { c.<span style="color:#c34e00">cancel</span>(<span style="color:#00f">true</span>, Canceled) }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>context.newCancelCtx 将传入的上下文包装成私有结构体 context.cancelCtx；
context.propagateCancel 会构建父子上下文之间的关联，当父上下文被取消时，子上下文也会被取消：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00f">func</span> <span style="color:#c34e00">propagateCancel</span>(parent Context, child canceler) {
</span></span><span style="display:flex;"><span>	done := parent.<span style="color:#c34e00">Done</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#00f">if</span> done == <span style="color:#00f">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#00f">return</span> <span style="color:#f00;font-style:italic">// 父上下文不会触发取消信号
</span></span></span><span style="display:flex;"><span><span style="color:#f00;font-style:italic"></span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#00f">select</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#00f">case</span> &lt;-done:
</span></span><span style="display:flex;"><span>		child.<span style="color:#c34e00">cancel</span>(<span style="color:#00f">false</span>, parent.<span style="color:#c34e00">Err</span>()) <span style="color:#f00;font-style:italic">// 父上下文已经被取消
</span></span></span><span style="display:flex;"><span><span style="color:#f00;font-style:italic"></span>		<span style="color:#00f">return</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00f">default</span>:
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#00f">if</span> p, ok := <span style="color:#c34e00">parentCancelCtx</span>(parent); ok {
</span></span><span style="display:flex;"><span>		p.mu.<span style="color:#c34e00">Lock</span>()
</span></span><span style="display:flex;"><span>		<span style="color:#00f">if</span> p.err != <span style="color:#00f">nil</span> {
</span></span><span style="display:flex;"><span>			child.<span style="color:#c34e00">cancel</span>(<span style="color:#00f">false</span>, p.err)
</span></span><span style="display:flex;"><span>		} <span style="color:#00f">else</span> {
</span></span><span style="display:flex;"><span>			p.children[child] = <span style="color:#00f">struct</span>{}{}
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		p.mu.<span style="color:#c34e00">Unlock</span>()
</span></span><span style="display:flex;"><span>	} <span style="color:#00f">else</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#00f">go</span> <span style="color:#00f">func</span>() {
</span></span><span style="display:flex;"><span>			<span style="color:#00f">select</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#00f">case</span> &lt;-parent.<span style="color:#c34e00">Done</span>():
</span></span><span style="display:flex;"><span>				child.<span style="color:#c34e00">cancel</span>(<span style="color:#00f">false</span>, parent.<span style="color:#c34e00">Err</span>())
</span></span><span style="display:flex;"><span>			<span style="color:#00f">case</span> &lt;-child.<span style="color:#c34e00">Done</span>():
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>		}()
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>上述函数总共与父上下文相关的三种不同的情况：</p>
<ol>
<li>当 parent.Done() == nil，也就是 parent 不会触发取消事件时，当前函数会直接返回；</li>
<li>当 child 的继承链包含可以取消的上下文时，会判断 parent 是否已经触发了取消信号；
如果已经被取消，child 会立刻被取消；
如果没有被取消，child 会被加入 parent 的 children 列表中，等待 parent 释放取消信号；</li>
<li>当父上下文是开发者自定义的类型、实现了 context.Context 接口并在 Done() 方法中返回了非空的管道时；
运行一个新的 Goroutine 同时监听 parent.Done() 和 child.Done() 两个 Channel；
在 parent.Done() 关闭时调用 child.cancel 取消子上下文；
context.propagateCancel 的作用是在 parent 和 child 之间同步取消和结束的信号，保证在 parent 被取消时，child 也会收到对应的信号，不会出现状态不一致的情况。</li>
</ol>
<p>context.cancelCtx 实现的几个接口方法也没有太多值得分析的地方，该结构体最重要的方法是 context.cancelCtx.cancel，该方法会关闭上下文中的 Channel 并向所有的子上下文同步取消信号：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00f">func</span> (c *cancelCtx) <span style="color:#c34e00">cancel</span>(removeFromParent <span style="color:#00f">bool</span>, err <span style="color:#00f">error</span>) {
</span></span><span style="display:flex;"><span>	c.mu.<span style="color:#c34e00">Lock</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#00f">if</span> c.err != <span style="color:#00f">nil</span> {
</span></span><span style="display:flex;"><span>		c.mu.<span style="color:#c34e00">Unlock</span>()
</span></span><span style="display:flex;"><span>		<span style="color:#00f">return</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	c.err = err
</span></span><span style="display:flex;"><span>	<span style="color:#00f">if</span> c.done == <span style="color:#00f">nil</span> {
</span></span><span style="display:flex;"><span>		c.done = closedchan
</span></span><span style="display:flex;"><span>	} <span style="color:#00f">else</span> {
</span></span><span style="display:flex;"><span>		close(c.done)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#00f">for</span> child := <span style="color:#00f">range</span> c.children {
</span></span><span style="display:flex;"><span>		child.<span style="color:#c34e00">cancel</span>(<span style="color:#00f">false</span>, err)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	c.children = <span style="color:#00f">nil</span>
</span></span><span style="display:flex;"><span>	c.mu.<span style="color:#c34e00">Unlock</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#00f">if</span> removeFromParent {
</span></span><span style="display:flex;"><span>		<span style="color:#c34e00">removeChild</span>(c.Context, c)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>除了 context.WithCancel 之外，context 包中的另外两个函数 context.WithDeadline 和 context.WithTimeout 也都能创建可以被取消的计时器上下文 context.timerCtx：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00f">func</span> <span style="color:#c34e00">WithTimeout</span>(parent Context, timeout time.Duration) (Context, CancelFunc) {
</span></span><span style="display:flex;"><span>	<span style="color:#00f">return</span> <span style="color:#c34e00">WithDeadline</span>(parent, time.<span style="color:#c34e00">Now</span>().<span style="color:#c34e00">Add</span>(timeout))
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00f">func</span> <span style="color:#c34e00">WithDeadline</span>(parent Context, d time.Time) (Context, CancelFunc) {
</span></span><span style="display:flex;"><span>	<span style="color:#00f">if</span> cur, ok := parent.<span style="color:#c34e00">Deadline</span>(); ok &amp;&amp; cur.<span style="color:#c34e00">Before</span>(d) {
</span></span><span style="display:flex;"><span>		<span style="color:#00f">return</span> <span style="color:#c34e00">WithCancel</span>(parent)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	c := &amp;timerCtx{
</span></span><span style="display:flex;"><span>		cancelCtx: <span style="color:#c34e00">newCancelCtx</span>(parent),
</span></span><span style="display:flex;"><span>		deadline:  d,
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#c34e00">propagateCancel</span>(parent, c)
</span></span><span style="display:flex;"><span>	dur := time.<span style="color:#c34e00">Until</span>(d)
</span></span><span style="display:flex;"><span>	<span style="color:#00f">if</span> dur &lt;= 0 {
</span></span><span style="display:flex;"><span>		c.<span style="color:#c34e00">cancel</span>(<span style="color:#00f">true</span>, DeadlineExceeded) <span style="color:#f00;font-style:italic">// 已经过了截止日期
</span></span></span><span style="display:flex;"><span><span style="color:#f00;font-style:italic"></span>		<span style="color:#00f">return</span> c, <span style="color:#00f">func</span>() { c.<span style="color:#c34e00">cancel</span>(<span style="color:#00f">false</span>, Canceled) }
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	c.mu.<span style="color:#c34e00">Lock</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#00f">defer</span> c.mu.<span style="color:#c34e00">Unlock</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#00f">if</span> c.err == <span style="color:#00f">nil</span> {
</span></span><span style="display:flex;"><span>		c.timer = time.<span style="color:#c34e00">AfterFunc</span>(dur, <span style="color:#00f">func</span>() {
</span></span><span style="display:flex;"><span>			c.<span style="color:#c34e00">cancel</span>(<span style="color:#00f">true</span>, DeadlineExceeded)
</span></span><span style="display:flex;"><span>		})
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#00f">return</span> c, <span style="color:#00f">func</span>() { c.<span style="color:#c34e00">cancel</span>(<span style="color:#00f">true</span>, Canceled) }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>context.WithDeadline 在创建 context.timerCtx 的过程中判断了父上下文的截止日期与当前日期，并通过 time.AfterFunc 创建定时器，当时间超过了截止日期后会调用 context.timerCtx.cancel 同步取消信号。</p>
<p>context.timerCtx 内部不仅通过嵌入 context.cancelCtx 结构体继承了相关的变量和方法，还通过持有的定时器 timer 和截止时间 deadline 实现了定时取消的功能：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00f">type</span> timerCtx <span style="color:#00f">struct</span> {
</span></span><span style="display:flex;"><span>	cancelCtx
</span></span><span style="display:flex;"><span>	timer *time.Timer <span style="color:#f00;font-style:italic">// Under cancelCtx.mu.
</span></span></span><span style="display:flex;"><span><span style="color:#f00;font-style:italic"></span>
</span></span><span style="display:flex;"><span>	deadline time.Time
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00f">func</span> (c *timerCtx) <span style="color:#c34e00">Deadline</span>() (deadline time.Time, ok <span style="color:#00f">bool</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#00f">return</span> c.deadline, <span style="color:#00f">true</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00f">func</span> (c *timerCtx) <span style="color:#c34e00">cancel</span>(removeFromParent <span style="color:#00f">bool</span>, err <span style="color:#00f">error</span>) {
</span></span><span style="display:flex;"><span>	c.cancelCtx.<span style="color:#c34e00">cancel</span>(<span style="color:#00f">false</span>, err)
</span></span><span style="display:flex;"><span>	<span style="color:#00f">if</span> removeFromParent {
</span></span><span style="display:flex;"><span>		<span style="color:#c34e00">removeChild</span>(c.cancelCtx.Context, c)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	c.mu.<span style="color:#c34e00">Lock</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#00f">if</span> c.timer != <span style="color:#00f">nil</span> {
</span></span><span style="display:flex;"><span>		c.timer.<span style="color:#c34e00">Stop</span>()
</span></span><span style="display:flex;"><span>		c.timer = <span style="color:#00f">nil</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	c.mu.<span style="color:#c34e00">Unlock</span>()
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>context.timerCtx.cancel 方法不仅调用了 context.cancelCtx.cancel，还会停止持有的定时器减少不必要的资源浪费。</p>
<h2 id="614-传值方法">6.1.4 传值方法</h2>
<p>在最后我们需要了解如何使用上下文传值，context 包中的 context.WithValue 能从父上下文中创建一个子上下文，传值的子上下文使用 context.valueCtx 类型：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00f">func</span> <span style="color:#c34e00">WithValue</span>(parent Context, key, val <span style="color:#00f">interface</span>{}) Context {
</span></span><span style="display:flex;"><span>	<span style="color:#00f">if</span> key == <span style="color:#00f">nil</span> {
</span></span><span style="display:flex;"><span>		panic(<span style="color:#009c00">&#34;nil key&#34;</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#00f">if</span> !reflectlite.<span style="color:#c34e00">TypeOf</span>(key).<span style="color:#c34e00">Comparable</span>() {
</span></span><span style="display:flex;"><span>		panic(<span style="color:#009c00">&#34;key is not comparable&#34;</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#00f">return</span> &amp;valueCtx{parent, key, val}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>context.valueCtx 结构体会将除了 Value 之外的 Err、Deadline 等方法代理到父上下文中，它只会响应 context.valueCtx.Value 方法，该方法的实现也很简单：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00f">type</span> valueCtx <span style="color:#00f">struct</span> {
</span></span><span style="display:flex;"><span>	Context
</span></span><span style="display:flex;"><span>	key, val <span style="color:#00f">interface</span>{}
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00f">func</span> (c *valueCtx) <span style="color:#c34e00">Value</span>(key <span style="color:#00f">interface</span>{}) <span style="color:#00f">interface</span>{} {
</span></span><span style="display:flex;"><span>	<span style="color:#00f">if</span> c.key == key {
</span></span><span style="display:flex;"><span>		<span style="color:#00f">return</span> c.val
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#00f">return</span> c.Context.<span style="color:#c34e00">Value</span>(key)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>如果 context.valueCtx 中存储的键值对与 context.valueCtx.Value 方法中传入的参数不匹配，就会从父上下文中查找该键对应的值直到某个父上下文中返回 nil 或者查找到对应的值。</p>
<h2 id="615-小结">6.1.5 小结</h2>
<p>Go 语言中的 context.Context 的主要作用还是在多个 Goroutine 组成的树中同步取消信号以减少对资源的消耗和占用，虽然它也有传值的功能，但是这个功能我们还是很少用到。</p>
<p>在真正使用传值的功能时我们也应该非常谨慎，使用 context.Context 进行传递参数请求的所有参数一种非常差的设计，比较常见的使用场景是传递请求对应用户的认证令牌以及用于进行分布式追踪的请求 ID。</p>
<h2 id="616-延伸阅读">6.1.6 延伸阅读</h2>
<p>Package context · Golang
Go Concurrency Patterns: Context
Using context cancellation in Go</p>

    </div>
    <footer class="post-footer">
     
 
<div class="post-tags">     
     
    <a href="http://shanks.link/tags/go" rel="tag" title="go">#go#</a>
    
</div>



     <div class="post-nav">
    <div class="post-nav-next post-nav-item">
    
        <a href="http://shanks.link/blog/2021/04/15/go116%E6%96%B0%E7%89%B9%E6%80%A7goembed/" rel="next" title="Go116新特性Goembed">
        <i class="fa fa-chevron-left"></i> Go116新特性Goembed
        </a>
    
    </div>

    <div class="post-nav-prev post-nav-item">
    
        <a href="http://shanks.link/blog/2021/04/15/%E4%B8%80%E6%96%87%E5%90%83%E9%80%8F-go-%E8%AF%AD%E8%A8%80%E8%A7%A3%E5%AF%86%E4%B9%8B%E4%B8%8A%E4%B8%8B%E6%96%87-context/" rel="prev" title="一文吃透 Go 语言解密之上下文 context">
        一文吃透 Go 语言解密之上下文 context <i class="fa fa-chevron-right"></i>
        </a>
    
    </div>
</div>
      
     
     
     





<script src="https://utteranc.es/client.js"
        repo="shankusu2017@gmail.com/"
        issue-term="pathname"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>
<noscript>Please enable JavaScript to view the <a href="https://github.com/utterance">comments powered by utterances.</a></noscript>

    </footer>
  </article>
</section>

          </div>
        </div>
        <div class="sidebar-toggle">
  <div class="sidebar-toggle-line-wrap">
    <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
    <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
    <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
  </div>
</div>
<aside id="sidebar" class="sidebar">
  <div class="sidebar-inner">

    <section class="site-overview sidebar-panel  sidebar-panel-active ">
      <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image"
        src="http://shanks.link/img/logo.jpg"
        alt="shankusu2017@gmail.com" />
    <p class="site-author-name" itemprop="name">shankusu2017@gmail.com</p>
    <p class="site-description motion-element" itemprop="description"> </p>
</div>
      <nav class="site-state motion-element">
    <div class="site-state-item site-state-posts">
      <a href="http://shanks.link/post/">
        <span class="site-state-item-count">513</span>
        <span class="site-state-item-name">日志</span>
      </a>
    </div>
    <div class="site-state-item site-state-categories">    
        <a href="http://shanks.link/categories/">      
         
        <span class="site-state-item-count">34</span>
        
        <span class="site-state-item-name">分类</span>
        
        </a>
    </div>

    <div class="site-state-item site-state-tags">
        <a href="http://shanks.link/tags/">
         
        <span class="site-state-item-count">39</span>
        
        <span class="site-state-item-name">标签</span>
        </a>
    </div>
</nav>
      
      
<div class="links-of-author motion-element">
    
        <span class="links-of-author-item">
        <a href="https://github.com/shankusu2017" target="_blank" title="GitHub">
            <i class="fa fa-fw fa-github"></i>
            GitHub
        </a>
        </span>
    
</div>


      

      <div class="links-of-blogroll motion-element inline">
<script type="text/javascript" src="//rf.revolvermaps.com/0/0/8.js?i=5b4f2ucxar6&amp;m=0&amp;s=220&amp;c=ff0000&amp;cr1=ffffff&amp;f=arial&amp;l=33&amp;bv=35" async="async"></script>
</div>

    </section>
    
  </div>
</aside>

      </div>
    </main>
   
    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  <span itemprop="copyrightYear">  &copy; 
  2009 - 2022</span>
  <span class="with-love"><i class="fa fa-heart"></i></span>
  <span class="author" itemprop="copyrightHolder">愿星光伴你左右</span>
</div>
<div class="powered-by">
  Powered by - <a class="theme-link" href="http://gohugo.io" target="_blank" title="hugo" >Hugo v0.101.0</a>
</div>
<div class="theme-info">
  Theme by - <a class="theme-link" href="https://github.com/xtfly/hugo-theme-next" target="_blank"> NexT
  </a>
</div>


      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
      <span id="scrollpercent"><span>0</span>%</span>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>
<script type="text/javascript" src="http://shanks.link/js/vendor/jquery/index.js?v=2.1.3"></script>
<script type="text/javascript" src="http://shanks.link/js/vendor/fastclick/lib/fastclick.min.js?v=1.0.6"></script> 
<script type="text/javascript" src="http://shanks.link/js/vendor/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
<script type="text/javascript" src="http://shanks.link/js/vendor/velocity/velocity.min.js?v=1.2.1"></script>
<script type="text/javascript" src="http://shanks.link/js/vendor/velocity/velocity.ui.min.js?v=1.2.1"></script>
<script src="http://shanks.link/js/vendor/ua-parser-js/dist/ua-parser.min.js?v=0.7.9"></script>

<script src="http://shanks.link/js/vendor/fancybox/jquery.fancybox.pack.js?v=2.1.5"></script>

<script type="text/javascript" src="http://shanks.link/js/utils.js"></script>
<script type="text/javascript" src="http://shanks.link/js/motion.js"></script>
<script type="text/javascript" src="http://shanks.link/js/affix.js"></script>
<script type="text/javascript" src="http://shanks.link/js/schemes/pisces.js"></script>

<script type="text/javascript" src="http://shanks.link/js/scrollspy.js"></script>
<script type="text/javascript" src="http://shanks.link/js/post-details.js"></script>
<script type="text/javascript" src="http://shanks.link/js/toc.js"></script>

<script type="text/javascript" src="http://shanks.link/js/bootstrap.js"></script>

<script type="text/javascript" src="http://shanks.link/js/search.js"></script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX", "output/HTML-CSS"],
    tex2jax: {
      inlineMath: [ ['$','$'] ],
      displayMath: [ ['$$','$$'] ],
      processEscapes: true
    },
    "HTML-CSS": { fonts: ["TeX"] }
  });
</script>
<script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML' async></script>
</body>
</html>