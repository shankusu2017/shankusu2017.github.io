<!DOCTYPE HTML>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" /> 
    <title>一文吃透 Go 语言解密之上下文 context - 愿星光伴你左右</title>
    <meta name="keywords" content="愿星光伴你左右,openresty,nginx,Lua,lua,Golang,go">
    
    <meta property="og:title" content="一文吃透 Go 语言解密之上下文 context">
    <meta property="og:site_name" content="愿星光伴你左右">
    <meta property="og:image" content="/img/author.jpg"> 
    <meta name="title" content="一文吃透 Go 语言解密之上下文 context - 愿星光伴你左右" />
    <meta name="description" content="愿星光伴你左右"> 
    <link rel="shortcut icon" href="http://shanks.link/img/favicon.ico" />
    <link rel="apple-touch-icon" href="http://shanks.link/img/apple-touch-icon.png" />
    <link rel="apple-touch-icon-precomposed" href="http://shanks.link/img/apple-touch-icon.png" />
    <link href="http://shanks.link/js/vendor/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />
    <link href="http://shanks.link/js/vendor/fancybox/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />
    <link href="http://shanks.link/css/main.css" rel="stylesheet" type="text/css" />
    <link href="http://shanks.link/css/syntax.css" rel="stylesheet" type="text/css" />
    <script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post"},
     fancybox: true, 
    motion: true
  };
</script>
</head>
<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">
<div class="container one-collumn sidebar-position-left page-home  ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"> <div class="site-meta  custom-logo ">

  <div class="custom-logo-site-title">
    <a href="http://shanks.link/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">愿星光伴你左右</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle"></p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
    <ul id="menu" class="menu">
      
      
        <li class="menu-item ">
          <a href="http://shanks.link/post/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />首页
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/lua/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />lua
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/go/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />Golang
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/thinking/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />thinking
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/links/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />links
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/about/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />about
          </a>
        </li>
      
      <li class="menu-item menu-item-search">
        <a href="javascript:;" class="popup-trigger"> <i class="menu-item-icon fa fa-search fa-fw"></i> <br /> 搜索</a>
      </li>
    </ul>
    <div class="site-search">
      <div class="popup">
 <span class="search-icon fa fa-search"></span>
 <input type="text" id="local-search-input">
 <div id="local-search-result"></div>
 <span class="popup-btn-close">close</span>
</div>

    </div>
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
<section id="posts" class="posts-expand">
  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <header class="post-header">
      <h1 class="post-title" itemprop="name headline">
        <a class="post-title-link" href="http://shanks.link/blog/2021/04/15/%E4%B8%80%E6%96%87%E5%90%83%E9%80%8F-go-%E8%AF%AD%E8%A8%80%E8%A7%A3%E5%AF%86%E4%B9%8B%E4%B8%8A%E4%B8%8B%E6%96%87-context/" itemprop="url">
        一文吃透 Go 语言解密之上下文 context
        </a>
      </h1>
      <div class="post-meta">
      <span class="post-time">
<span class="post-meta-item-icon">
    <i class="fa fa-calendar-o"></i>
</span>
<span class="post-meta-item-text">时间：</span>
<time itemprop="dateCreated" datetime="2016-03-22T13:04:35+08:00" content="2021-04-15">
    2021-04-15
</time>
</span> 
      

  <span class="post-category" >
  &nbsp; | &nbsp;
  <span class="post-meta-item-icon">
    <i class="fa fa-folder-o"></i>
  </span>
  <span class="post-meta-item-text">分类：</span>
  
    <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
      <a href="http://shanks.link/categories/go" itemprop="url" rel="index">
        <span itemprop="name">go</span>
      </a>
      &nbsp; 
    </span>
  
</span>


       <span>
&nbsp; | &nbsp;
<span class="post-meta-item-icon">
    <i class="fa fa-eye"></i>
</span>
<span class="post-meta-item-text">阅读：</span>
<span class="leancloud-visitors-count">3817 字 ~8分钟</span>
</span>
      </div>
    </header>
    <div class="post-body" itemprop="articleBody">
    <h2 id="一文吃透-go-语言解密之上下文-context">一文吃透 Go 语言解密之上下文 context</h2>
<p><a href="https://mp.weixin.qq.com/s/A03G3_kCvVFN3TxB-92GVw">转载自煎鱼的blog</a></p>
<p>上下文（Context）是 Go 语言中非常有特色的一个特性， 在 Go 1.7 版本中正式引入新标准库 context。</p>
<p>其主要的作用是在 goroutine 中进行上下文的传递，而在传递信息中又包含了 goroutine 的运行控制、上下文信息传递等功能。</p>
<p><img src="http://shanks.link/img/Go%E4%B9%8Bcontext2/1.jpg" alt="img"></p>
<p>为加强大家对 Go 语言的 context 的设计，本文将对标准库 context 进行深入剖析，看看他里面到底暗含了何物，又为何能够做那么多事。</p>
<p>整体的描述结构是：“了解 context 特性，熟悉 context 流程，剖析 context 原理” 三个板块进行。目录如下：</p>
<p><img src="http://shanks.link/img/Go%E4%B9%8Bcontext2/2.png" alt="img"></p>
<h2 id="什么是-context">什么是 context</h2>
<p>Go 语言的独有的功能之一 Context，<strong>最常听说开发者说的一句话就是 “函数的第一个形参真的要传 ctx 吗？”，第二句话可能是 “有没有什么办法不传，就能达到传入的效果？”</strong>，听起来非常魔幻。</p>
<p>在 Go 语言中 context 作为一个 “一等公民” 的标准库，许多的开源库都一定会对他进行支持，因为标准库 context 的定位是上下文控制。会在跨 goroutine 中进行传播：</p>
<p><img src="http://shanks.link/img/Go%E4%B9%8Bcontext2/3.jpg" alt="img"></p>
<p>本质上 Go 语言是基于 context 来实现和搭建了各类 goroutine 控制的，并且与 <code>select-case</code>联合，就可以实现进行上下文的截止时间、信号控制、信息传递等跨 goroutine 的操作，是 Go 语言协程的重中之重。</p>
<h2 id="context-基本特性">context 基本特性</h2>
<p>演示代码：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">func main() {
 parentCtx := context.Background()
 ctx, cancel := context.WithTimeout(parentCtx, 1*time.Millisecond)
 defer cancel()

 select {
 case &lt;-time.After(1 * time.Second):
  fmt.Println(&#34;overslept&#34;)
 case &lt;-ctx.Done():
  fmt.Println(ctx.Err())
 }
}
</code></pre></div><p>输出结果：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">context deadline exceeded
</code></pre></div><p>我们通过调用标准库 <code>context.WithTimeout</code> 方法针对 <code>parentCtx</code> 变量设置了超时时间，并在随后调用 <code>select-case</code> 进行 <code>context.Done</code> 方法的监听，最后由于达到截止时间。因此逻辑上 <code>select</code> 走到了 <code>context.Err</code> 的 <code>case</code> 分支，最终输出 <code>context deadline exceeded</code>。</p>
<p>除了上述所描述的方法外，标准库 <code>context</code> 还支持下述方法：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">func WithCancel(parent Context) (ctx Context, cancel CancelFunc)
func WithDeadline(parent Context, d time.Time) (Context, CancelFunc)
func WithTimeout(parent Context, timeout time.Duration) (Context, CancelFunc)
type Context
    func Background() Context
    func TODO() Context
    func WithValue(parent Context, key, val interface{}) Context
</code></pre></div><ul>
<li>WithCancel：基于父级 context，创建一个可以取消的新 context。</li>
<li>WithDeadline：基于父级 context，创建一个具有截止时间（Deadline）的新 context。</li>
<li>WithTimeout：基于父级 context，创建一个具有超时时间（Timeout）的新 context。</li>
<li>Background：创建一个空的 context，一般常用于作为根的父级 context。</li>
<li>TODO：创建一个空的 context，一般用于未确定时的声明使用。</li>
<li>WithValue：基于某个 context 创建并存储对应的上下文信息。</li>
</ul>
<h2 id="context-本质">context 本质</h2>
<p>我们在基本特性中介绍了不少 context 的方法，其基本大同小异。看上去似乎不难，接下来我们看看其底层的基本原理和设计。</p>
<p>context 相关函数的标准返回如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">func WithXXXX(parent Context, xxx xxx) (Context, CancelFunc)
</code></pre></div><p>其返回值分别是 <code>Context</code> 和 <code>CancelFunc</code>，接下来我们将进行分析这两者的作用。</p>
<h3 id="接口">接口</h3>
<p>\1. Context 接口：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">type Context interface {
    Deadline() (deadline time.Time, ok bool)
    Done() &lt;-chan struct{}
    Err() error
    Value(key interface{}) interface{}
}
</code></pre></div><ul>
<li>Deadline：获取当前 context 的截止时间。</li>
<li>Done：获取一个只读的 channel，类型为结构体。可用于识别当前 channel 是否已经被关闭，其原因可能是到期，也可能是被取消了。</li>
<li>Err：获取当前 context 被关闭的原因。</li>
<li>Value：获取当前 context 对应所存储的上下文信息。</li>
</ul>
<p>\2. Canceler 接口：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">type canceler interface {
 cancel(removeFromParent bool, err error)
 Done() &lt;-chan struct{}
}
</code></pre></div><ul>
<li>cancel：调用当前 context 的取消方法。</li>
<li>Done：与前面一致，可用于识别当前 channel 是否已经被关闭。</li>
</ul>
<h3 id="基础结构">基础结构</h3>
<p>在标准库 context 的设计上，一共提供了四类 context 类型来实现上述接口。分别是 <code>emptyCtx</code>、<code>cancelCtx</code>、<code>timerCtx</code> 以及 <code>valueCtx</code>。</p>
<p><img src="http://shanks.link/img/Go%E4%B9%8Bcontext2/4.jpg" alt="img"></p>
<h4 id="emptyctx">emptyCtx</h4>
<p>在日常使用中，常常使用到的 <code>context.Background</code> 方法，又或是 <code>context.TODO</code> 方法。</p>
<p>源码如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">var (
 background = new(emptyCtx)
 todo       = new(emptyCtx)
)

func Background() Context {
 return background
}

func TODO() Context {
 return todo
}
</code></pre></div><p>其本质上都是基于 <code>emptyCtx</code> 类型的基本封装。而 <code>emptyCtx</code> 类型本质上是实现了 Context 接口：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">type emptyCtx int

func (*emptyCtx) Deadline() (deadline time.Time, ok bool) {
 return
}

func (*emptyCtx) Done() &lt;-chan struct{} {
 return nil
}

func (*emptyCtx) Err() error {
 return nil
}

func (*emptyCtx) Value(key interface{}) interface{} {
 return nil
}
</code></pre></div><p>实际上 <code>emptyCtx</code> 类型的 context 的实现非常简单，因为他是空 context 的定义，因此没有 deadline，更没有 timeout，可以认为就是一个基础空白 context 模板。</p>
<h4 id="cancelctx">cancelCtx</h4>
<p>在调用 <code>context.WithCancel</code> 方法时，我们会涉及到 <code>cancelCtx</code> 类型，其主要特性是取消事件。源码如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">func WithCancel(parent Context) (ctx Context, cancel CancelFunc) {
 c := newCancelCtx(parent)
 propagateCancel(parent, &amp;c)
 return &amp;c, func() { c.cancel(true, Canceled) }
}

func newCancelCtx(parent Context) cancelCtx {
 return cancelCtx{Context: parent}
}
</code></pre></div><p>其中的 <code>newCancelCtx</code> 方法将会生成出一个可以取消的新 context，如果该 context 执行取消，与其相关联的子 context 以及对应的 goroutine 也会收到取消信息。</p>
<p>首先 main goroutine 创建并传递了一个新的 context 给 goroutine b，此时 goroutine b 的 context 是 main goroutine context 的子集：</p>
<p><img src="http://shanks.link/img/Go%E4%B9%8Bcontext2/5.jpg" alt="img"></p>
<p>传递过程中，goroutine b 再将其 context 一个个传递给了 goroutine c、d、e。最后在运行时 goroutine b 调用了 <code>cancel</code> 方法。使得该 context 以及其对应的子集均接受到取消信号，对应的 goroutine 也进行了响应。</p>
<p>接下来我们针对 <code>cancelCtx</code> 类型来进一步看看：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">type cancelCtx struct {
 Context

 mu       sync.Mutex            // protects following fields
 done     chan struct{}         // created lazily, closed by first cancel call
 children map[canceler]struct{} // set to nil by the first cancel call
 err      error                 // set to non-nil by the first cancel call
}
</code></pre></div><p>该结构体所包含的属性也比较简单，主要是 <code>children</code> 字段，其包含了该 context 对应的所有子集 context，便于在后续发生取消事件的时候进行逐一通知和关联。</p>
<p>而其他的属性主要用于并发控制（互斥锁）、取消信息和错误的写入：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">func (c *cancelCtx) Value(key interface{}) interface{} {
 if key == &amp;cancelCtxKey {
  return c
 }
 return c.Context.Value(key)
}

func (c *cancelCtx) Done() &lt;-chan struct{} {
 c.mu.Lock()
 if c.done == nil {
  c.done = make(chan struct{})
 }
 d := c.done
 c.mu.Unlock()
 return d
}

func (c *cancelCtx) Err() error {
 c.mu.Lock()
 err := c.err
 c.mu.Unlock()
 return err
}
</code></pre></div><p>在上述代码中可以留意到，<code>done</code> 属性（只读 channel）是在真正调用到 <code>Done</code> 方法时才会去创建。需要配合 <code>select-case</code> 来使用。</p>
<h4 id="timerctx">timerCtx</h4>
<p>在调用 <code>context.WithTimeout</code> 方法时，我们会涉及到 <code>timerCtx</code> 类型，其主要特性是 Timeout 和 Deadline 事件，源码如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">func WithTimeout(parent Context, timeout time.Duration) (Context, CancelFunc) {
 return WithDeadline(parent, time.Now().Add(timeout))
}

func WithDeadline(parent Context, d time.Time) (Context, CancelFunc) {
 ...
 c := &amp;timerCtx{
  cancelCtx: newCancelCtx(parent),
  deadline:  d,
 }
}
</code></pre></div><p>你可以发现 <code>timerCtx</code> 类型是基于 <code>cancelCtx</code> 类型的。我们再进一步看看 <code>timerCtx</code> 结构体：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">type timerCtx struct {
 cancelCtx
 timer *time.Timer // Under cancelCtx.mu.

 deadline time.Time
}
</code></pre></div><p>其实 timerCtx 类型也就是 <code>cancelCtx</code> 类型，加上 <code>time.Timer</code> 和对应的 Deadline，也就是包含了时间属性的控制。</p>
<p>我们进一步看看其配套的 cancel 方法，思考一下其是如何进行取消动作的：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">func (c *timerCtx) Deadline() (deadline time.Time, ok bool) {
 return c.deadline, true
}

func (c *timerCtx) cancel(removeFromParent bool, err error) {
 c.cancelCtx.cancel(false, err)
 if removeFromParent {
  removeChild(c.cancelCtx.Context, c)
 }
 c.mu.Lock()
 if c.timer != nil {
  c.timer.Stop()
  c.timer = nil
 }
 c.mu.Unlock()
}
</code></pre></div><p>先会调用 <code>cancelCtx</code> 类型的取消事件。若存在父级节点，则移除当前 context 子节点，最后停止定时器并进行定时器重置。而 Deadline 或 Timeout 的行为则由 <code>timerCtx</code> 的 <code>WithDeadline</code> 方法实现：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">func WithDeadline(parent Context, d time.Time) (Context, CancelFunc) {
 if cur, ok := parent.Deadline(); ok &amp;&amp; cur.Before(d) {
  // The current deadline is already sooner than the new one.
  return WithCancel(parent)
 }
 ...
}
</code></pre></div><p>该方法会先进行前置判断，若父级节点的 Deadline 时间早于当前所指定的 Deadline 时间，将会直接生成一个 cancelCtx 的 context。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">func WithDeadline(parent Context, d time.Time) (Context, CancelFunc) {
 ...
 c := &amp;timerCtx{
  cancelCtx: newCancelCtx(parent),
  deadline:  d,
 }
 propagateCancel(parent, c)
 dur := time.Until(d)
 if dur &lt;= 0 {
  c.cancel(true, DeadlineExceeded) // deadline has already passed
  return c, func() { c.cancel(false, Canceled) }
 }
 c.mu.Lock()
 defer c.mu.Unlock()
 if c.err == nil {
  c.timer = time.AfterFunc(dur, func() {
   c.cancel(true, DeadlineExceeded)
  })
 }
 return c, func() { c.cancel(true, Canceled) }
}
</code></pre></div><p>接下来将会正式生成成为一个 <code>timeCtx</code> 类型，并将其加入到父级 context 是 children 属性中。最后进行当前时间与 Deadline 时间的计算，并通过调用 <code>time.AfterFunc</code> 在到期后自动调用 <code>cancel</code> 方法发起取消事件，自然也就会触发父子级的事件传播。</p>
<h4 id="valuectx">valueCtx</h4>
<p>在调用 <code>context.WithValue</code> 方法时，我们会涉及到 <code>valueCtx</code> 类型，其主要特性是涉及上下文信息传递，源码如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">func WithValue(parent Context, key, val interface{}) Context {
 ...
 if !reflectlite.TypeOf(key).Comparable() {
  panic(&#34;key is not comparable&#34;)
 }
 return &amp;valueCtx{parent, key, val}
}
</code></pre></div><p>你会发现 <code>valueCtx</code> 结构体也非常的简单，核心就是键值对：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">type valueCtx struct {
 Context
 key, val interface{}
}
</code></pre></div><p>其在配套方法上也不会太复杂，基本就是要求可比较，接着就是存储匹配：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">func (c *valueCtx) Value(key interface{}) interface{} {
 if c.key == key {
  return c.val
 }
 return c.Context.Value(key)
}
</code></pre></div><p>这时候你可能又有疑问了，那多个父子级 context 是如何实现跨 context 的上下文信息获取的？</p>
<p>这秘密其实在上面的 <code>valueCtx</code> 和 <code>Value</code> 方法中有所表现：</p>
<p><img src="http://shanks.link/img/Go%E4%B9%8Bcontext2/6.jpg" alt="img"></p>
<p>本质上 <code>valueCtx</code> 类型是一个单向链表，会在调用 <code>Value</code> 方法时先查询自己的节点是否有该值。若无，则会通过自身存储的上层父级节点的信息一层层向上寻找对应的值，直到找到为止。</p>
<p>而在实际的工程应用中，你会发现各大框架，例如：gin、grpc 等。他都是有自己再实现一套上下文信息的传输的二次封装，本意也是为了更好的管理和观察上下文信息。</p>
<h2 id="context-取消事件">context 取消事件</h2>
<p>在我们针对 context 的各类延伸类型和源码进行了分析后。我们进一步提出一个疑问点，<strong>context 是如何实现跨 goroutine 的取消事件并传播开来的，是如何实现的</strong>？</p>
<p>这个问题的答案就在于 <code>WithCancel</code> 和 <code>WithDeadline</code> 都会涉及到 <code>propagateCancel</code> 方法，其作用是构建父子级的上下文的关联关系，若出现取消事件时，就会进行处理：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">func propagateCancel(parent Context, child canceler) {
 done := parent.Done()
 if done == nil {
  return
 }

 select {
 case &lt;-done:
  child.cancel(false, parent.Err())
  return
 default:
 }
 ...
}
</code></pre></div><ul>
<li>当父级上下文（parent）的 <code>Done</code> 结果为 <code>nil</code> 时，将会直接返回，因为其不会具备取消事件的基本条件，可能该 context 是 <code>Background</code>、<code>TODO</code> 等方法产生的空白 context。</li>
<li>当父级上下文（parent）的 <code>Done</code> 结果不为 <code>nil</code> 时，则发现父级上下文已经被取消，作为其子级，该 context 将会触发取消事件并返回父级上下文的取消原因。</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">func propagateCancel(parent Context, child canceler) {
 ...
 if p, ok := parentCancelCtx(parent); ok {
  p.mu.Lock()
  if p.err != nil {
   child.cancel(false, p.err)
  } else {
   if p.children == nil {
    p.children = make(map[canceler]struct{})
   }
   p.children[child] = struct{}{}
  }
  p.mu.Unlock()
 } else {
  atomic.AddInt32(&amp;goroutines, +1)
  go func() {
   select {
   case &lt;-parent.Done():
    child.cancel(false, parent.Err())
   case &lt;-child.Done():
   }
  }()
 }
}
</code></pre></div><p>经过前面一个代码片段的判断，已得知父级 context 未触发取消事件，当前父级和子级 context 均正常（未取消）。</p>
<p>将会执行以下流程：</p>
<ul>
<li>调用 <code>parentCancelCtx</code> 方法找到具备取消功能的父级 context。并将当前 context，也就是 <code>child</code> 加入到 父级 context 的 children 列表中，等待后续父级 context 的取消事件通知和响应。</li>
<li>调用 <code>parentCancelCtx</code> 方法没有找到，将会启动一个新的 goroutine 去监听父子 context 的取消事件通知。</li>
</ul>
<p>通过对 context 的取消事件和整体源码分析，可得知 <code>cancelCtx</code> 类型的上下文包含了其下属的所有子节点信息：</p>
<p><img src="http://shanks.link/img/Go%E4%B9%8Bcontext2/7.jpg" alt="img"></p>
<p>也就是其在 <code>children</code> 属性的 <code>map[canceler]struct{}</code> 存储结构上就已经支持了子级关系的查找，也就自然可以进行取消事件传播了。</p>
<p>而具体的取消事件的实际行为，则是在前面提到的 <code>propagateCancel</code> 方法中，会在执行例如<code>cacenl</code> 方法时，会对父子级上下文分别进行状态判断，若满足则进行取消事件，并传播给子级同步取消。</p>
<h2 id="总结">总结</h2>
<p>作为 Go 语言的核心功能之一，其实标准库 context 非常的短小精悍，使用的都是基本的数据结构和理念。既满足了跨 goroutine 的调控控制，像是并发、超时控制等。</p>
<p>同时也满足了上下文的信息传递。在工程应用中，例如像是链路ID、公共参数、鉴权校验等，都会使用到 context 作为媒介。</p>
<p>目前官方对于 context 的建议是作为方法的首参数传入，虽有些麻烦，但也有人选择将其作为结构体中的一个属性传入。但这也会带来一些心智负担，需要识别是否重新 new 一个。</p>
<p>也有人提出希望 Go2 取消掉 context，换成另外一种方法，但总体而言目前未见到正式的提案，这是我们都需要再思考的。</p>

    </div>
    <footer class="post-footer">
     
 
<div class="post-tags">     
     
    <a href="http://shanks.link/tags/go" rel="tag" title="go">#go#</a>
    
</div>



     <div class="post-nav">
    <div class="post-nav-next post-nav-item">
    
        <a href="http://shanks.link/blog/2021/04/15/%E4%B8%8A%E4%B8%8B%E6%96%87context/" rel="next" title="上下文Context">
        <i class="fa fa-chevron-left"></i> 上下文Context
        </a>
    
    </div>

    <div class="post-nav-prev post-nav-item">
    
        <a href="http://shanks.link/blog/2021/04/15/%E4%B8%80%E6%96%87%E5%90%83%E9%80%8F-go-%E8%AF%AD%E8%A8%80%E8%A7%A3%E5%AF%86%E4%B9%8B%E6%8E%A5%E5%8F%A3-interface/" rel="prev" title="一文吃透 Go 语言解密之接口 interface">
        一文吃透 Go 语言解密之接口 interface <i class="fa fa-chevron-right"></i>
        </a>
    
    </div>
</div>
      
     
     
     





<script src="https://utteranc.es/client.js"
        repo="shankusu2017@gmail.com/"
        issue-term="pathname"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>
<noscript>Please enable JavaScript to view the <a href="https://github.com/utterance">comments powered by utterances.</a></noscript>

    </footer>
  </article>
</section>

          </div>
        </div>
        <div class="sidebar-toggle">
  <div class="sidebar-toggle-line-wrap">
    <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
    <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
    <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
  </div>
</div>
<aside id="sidebar" class="sidebar">
  <div class="sidebar-inner">

    <section class="site-overview sidebar-panel  sidebar-panel-active ">
      <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image"
        src="http://shanks.link/img/logo.jpg"
        alt="shankusu2017@gmail.com" />
    <p class="site-author-name" itemprop="name">shankusu2017@gmail.com</p>
    <p class="site-description motion-element" itemprop="description"> </p>
</div>
      <nav class="site-state motion-element">
    <div class="site-state-item site-state-posts">
      <a href="http://shanks.link/post/">
        <span class="site-state-item-count">385</span>
        <span class="site-state-item-name">日志</span>
      </a>
    </div>
    <div class="site-state-item site-state-categories">    
        <a href="http://shanks.link/categories/">      
         
        <span class="site-state-item-count">19</span>
        
        <span class="site-state-item-name">分类</span>
        
        </a>
    </div>

    <div class="site-state-item site-state-tags">
        <a href="http://shanks.link/tags/">
         
        <span class="site-state-item-count">26</span>
        
        <span class="site-state-item-name">标签</span>
        </a>
    </div>
</nav>
      
      
<div class="links-of-author motion-element">
    
        <span class="links-of-author-item">
        <a href="https://github.com/shankusu2017" target="_blank" title="GitHub">
            <i class="fa fa-fw fa-github"></i>
            GitHub
        </a>
        </span>
    
</div>


      

      <div class="links-of-blogroll motion-element inline">
<script type="text/javascript" src="//rf.revolvermaps.com/0/0/8.js?i=5b4f2ucxar6&amp;m=0&amp;s=220&amp;c=ff0000&amp;cr1=ffffff&amp;f=arial&amp;l=33&amp;bv=35" async="async"></script>
</div>

    </section>
    
  </div>
</aside>

      </div>
    </main>
   
    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  <span itemprop="copyrightYear">  &copy; 
  2009 - 2022</span>
  <span class="with-love"><i class="fa fa-heart"></i></span>
  <span class="author" itemprop="copyrightHolder">愿星光伴你左右</span>
</div>
<div class="powered-by">
  Powered by - <a class="theme-link" href="http://gohugo.io" target="_blank" title="hugo" >Hugo v0.92.1</a>
</div>
<div class="theme-info">
  Theme by - <a class="theme-link" href="https://github.com/xtfly/hugo-theme-next" target="_blank"> NexT
  </a>
</div>


      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
      <span id="scrollpercent"><span>0</span>%</span>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>
<script type="text/javascript" src="http://shanks.link/js/vendor/jquery/index.js?v=2.1.3"></script>
<script type="text/javascript" src="http://shanks.link/js/vendor/fastclick/lib/fastclick.min.js?v=1.0.6"></script> 
<script type="text/javascript" src="http://shanks.link/js/vendor/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
<script type="text/javascript" src="http://shanks.link/js/vendor/velocity/velocity.min.js?v=1.2.1"></script>
<script type="text/javascript" src="http://shanks.link/js/vendor/velocity/velocity.ui.min.js?v=1.2.1"></script>
<script src="http://shanks.link/js/vendor/ua-parser-js/dist/ua-parser.min.js?v=0.7.9"></script>

<script src="http://shanks.link/js/vendor/fancybox/jquery.fancybox.pack.js?v=2.1.5"></script>

<script type="text/javascript" src="http://shanks.link/js/utils.js"></script>
<script type="text/javascript" src="http://shanks.link/js/motion.js"></script>
<script type="text/javascript" src="http://shanks.link/js/affix.js"></script>
<script type="text/javascript" src="http://shanks.link/js/schemes/pisces.js"></script>

<script type="text/javascript" src="http://shanks.link/js/scrollspy.js"></script>
<script type="text/javascript" src="http://shanks.link/js/post-details.js"></script>
<script type="text/javascript" src="http://shanks.link/js/toc.js"></script>

<script type="text/javascript" src="http://shanks.link/js/bootstrap.js"></script>

<script type="text/javascript" src="http://shanks.link/js/search.js"></script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX", "output/HTML-CSS"],
    tex2jax: {
      inlineMath: [ ['$','$'] ],
      displayMath: [ ['$$','$$'] ],
      processEscapes: true
    },
    "HTML-CSS": { fonts: ["TeX"] }
  });
</script>
<script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML' async></script>
</body>
</html>