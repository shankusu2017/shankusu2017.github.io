<!DOCTYPE HTML>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" /> 
    <title>More Redis internals: Tracing a GET &amp; SET - 愿星光伴你左右</title>
    <meta name="keywords" content="git,Git,Lua,lua,Golang,go">
    
    <meta property="og:title" content="More Redis internals: Tracing a GET &amp; SET">
    <meta property="og:site_name" content="愿星光伴你左右">
    <meta property="og:image" content="/img/author.jpg"> 
    <meta name="title" content="More Redis internals: Tracing a GET &amp; SET - 愿星光伴你左右" />
    <meta name="description" content="愿星光伴你左右"> 
    <link rel="shortcut icon" href="http://shanks.link/img/favicon.ico" />
    <link rel="apple-touch-icon" href="http://shanks.link/img/apple-touch-icon.png" />
    <link rel="apple-touch-icon-precomposed" href="http://shanks.link/img/apple-touch-icon.png" />
    <link href="http://shanks.link/js/vendor/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />
    <link href="http://shanks.link/js/vendor/fancybox/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />
    <link href="http://shanks.link/css/main.css" rel="stylesheet" type="text/css" />
    <link href="http://shanks.link/css/syntax.css" rel="stylesheet" type="text/css" />
    <script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post"},
     fancybox: true, 
    motion: true
  };
</script>
</head>
<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">
<div class="container one-collumn sidebar-position-left page-home  ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"> <div class="site-meta  custom-logo ">

  <div class="custom-logo-site-title">
    <a href="http://shanks.link/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">愿星光伴你左右</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle"></p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
    <ul id="menu" class="menu">
      
      
        <li class="menu-item ">
          <a href="http://shanks.link/post/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />首页
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/thinking/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />随想录
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/prose/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />散文
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/%E7%94%9F%E6%B4%BB/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />生活
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/os/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />OS
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/lua/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />lua
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/redis/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />redis
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/go/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />Golang
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/c/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />C
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/openvpn/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />OpenVPN
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/web/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />web
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/openwrt/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />OpenWRT
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/%E8%BF%90%E7%BB%B4/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />运维
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/git/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />Git
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/%E9%B8%9F%E5%93%A5%E7%9A%84%E7%A7%81%E6%88%BF%E8%8F%9C/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />鸟哥的私房菜
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/it/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />IT杂谈
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/about/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />About Me
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/links/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />友情链接
          </a>
        </li>
      
      <li class="menu-item menu-item-search">
        <a href="javascript:;" class="popup-trigger"> <i class="menu-item-icon fa fa-search fa-fw"></i> <br /> 搜索</a>
      </li>
    </ul>
    <div class="site-search">
      <div class="popup">
 <span class="search-icon fa fa-search"></span>
 <input type="text" id="local-search-input">
 <div id="local-search-result"></div>
 <span class="popup-btn-close">close</span>
</div>

    </div>
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
<section id="posts" class="posts-expand">
  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <header class="post-header">
      <h1 class="post-title" itemprop="name headline">
        <a class="post-title-link" href="http://shanks.link/blog/2021/09/02/more-redis-internals-tracing-a-get-set/" itemprop="url">
        More Redis internals: Tracing a GET &amp; SET
        </a>
      </h1>
      <div class="post-meta">
      <span class="post-time">
<span class="post-meta-item-icon">
    <i class="fa fa-calendar-o"></i>
</span>
<span class="post-meta-item-text">时间：</span>
<time itemprop="dateCreated" datetime="2016-03-22T13:04:35+08:00" content="2021-09-02">
    2021-09-02
</time>
</span> 
      

  <span class="post-category" >
  &nbsp; | &nbsp;
  <span class="post-meta-item-icon">
    <i class="fa fa-folder-o"></i>
  </span>
  <span class="post-meta-item-text">分类：</span>
  
    <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
      <a href="http://shanks.link/categories/redis" itemprop="url" rel="index">
        <span itemprop="name">redis</span>
      </a>
      &nbsp; 
    </span>
  
</span>


       <span>
&nbsp; | &nbsp;
<span class="post-meta-item-icon">
    <i class="fa fa-eye"></i>
</span>
<span class="post-meta-item-text">阅读：</span>
<span class="leancloud-visitors-count">3629 字 ~8分钟</span>
</span>
      </div>
    </header>
    <div class="post-body" itemprop="articleBody">
    <p><a href="https://www.pauladamsmith.com/blog/2011/03/redis_get_set.html">原文链接</a></p>
<p>MARCH 10, 2011</p>
<p><img src="https://www.pauladamsmith.com/images/redis.png" alt="img"></p>
<p>In my <a href="https://www.pauladamsmith.com/articles/redis-under-the-hood.html">previous article</a>, I took a superficial look at how Redis starts up and prepares itself to process commands. In this article, I&rsquo;ll follow a <code>GET</code> and a <code>SET</code> command as they move from client through the server and back. The <code>GET</code> will be for a key that doesn&rsquo;t exist, and the <code>SET</code> will set that key. Then I&rsquo;ll look quickly at a subsequent <code>GET</code> and how it differs.</p>
<p>As before, I&rsquo;m exploring Redis with the source code open in my editor and indexed with a <code>tags</code> file, and the Redis server running under <code>gdb</code> in another terminal.</p>
<p>Caveat: this article was written against the codebase of Redis 2.2.1. With respect to my previous article, for a list of what has changed in Redis since I wrote it, see this <a href="http://news.ycombinator.com/item?id=2301804">comment on HN</a>.</p>
<p><strong>Edit:</strong> I made two minor changes based on feedback—Redis keys are not Redis objects, they are <code>sds</code> strings; and you don’t have to hack the Makefile to compile without optimizations.</p>
<h1 id="get">GET</h1>
<p>Let&rsquo;s execute the command <code>get users:1234</code> on Redis.</p>
<h2 id="preparing">Preparing</h2>
<p>If you inspect certain variables under <code>gdb</code>, you might not get what you want. Instead you see a message like &ldquo;.&rdquo; This is because the compiler has optimized the machine code in such a fashion that the portion of memory you wanted to look at that was never used, at least for the variable under inspection. To make stepping through the code and inspecting a little easier, we make sure that Redis is not compiled with optimizations. You can do this by either building Redis with the following invocation:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>make noopt
</span></span></code></pre></div><p>or by setting an environment variable:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>OPTIMIZATION= make
</span></span></code></pre></div><h2 id="sending-the-command-from-the-client">Sending the command from the client</h2>
<p>If we look at the <code>repl</code> loop of redis-cli, we see that it uses the <code>linenoise</code> library to split the arguments of the command. It dispatches on the first argument. The loop checks for client commands that aren&rsquo;t processed as a command by the Redis server, like <code>exit</code>/<code>quit</code>, <code>clear</code> (to clear the screen), and <code>connect</code> (which is a way to connect to a specified Redis server on host port, instead of the default host of 127.0.0.1 and port of 6379.</p>
<p>Any other argument is considered the name of a command to send to the server. The remaining arguments are the arugments for that command.</p>
<p>We&rsquo;re trying to get the on-the-wire representation of the <code>get users:1234</code> command. redis-cli uses a <code>redisContext</code> struct to encapsulate the state of the connection to the server, as well as the output buffer where the command in the form of the Redis protocol is written for sending to the server. We know from reading the source of hiredis (the Redis C client library that the redis-cli program is built on) that the <code>obuf</code> field is where the raw command is stored:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span># hiredis.h:107
</span></span><span style="display:flex;"><span>/* Context for a connection to Redis */
</span></span><span style="display:flex;"><span>typedef struct redisContext {
</span></span><span style="display:flex;"><span>    int fd;
</span></span><span style="display:flex;"><span>    int flags;
</span></span><span style="display:flex;"><span>    char *obuf; /* Write buffer */
</span></span><span style="display:flex;"><span>    int err; /* Error flags, 0 when there is no error */
</span></span><span style="display:flex;"><span>    char *errstr; /* String representation of error when applicable */
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    /* Function set for reply buildup and reply reader */
</span></span><span style="display:flex;"><span>    redisReplyObjectFunctions *fn;
</span></span><span style="display:flex;"><span>    void *reader;
</span></span><span style="display:flex;"><span>} redisContext;
</span></span></code></pre></div><p>If we set a breakpoint on <code>cliReadReply</code>, we can inspect the output buffer and see exactly how the command looks as a bytestring bound for the server.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>client $ gdb src/redis-cli
</span></span><span style="display:flex;"><span>(gdb) b cliReadReply
</span></span><span style="display:flex;"><span>(gdb) run
</span></span><span style="display:flex;"><span>Starting program: /home/paul/src/redis-2.2.0-RC2/src/redis-cli 
</span></span><span style="display:flex;"><span>Reading symbols for shared libraries +. done
</span></span><span style="display:flex;"><span>redis&gt; get users:1234
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Breakpoint 1, cliReadReply (output_raw_strings=0) at redis-cli.c:421
</span></span><span style="display:flex;"><span>421         if (redisGetReply(context,&amp;_reply) != REDIS_OK) {
</span></span><span style="display:flex;"><span>(gdb) p context-&gt;obuf 
</span></span><span style="display:flex;"><span>$1 = 0x100102428 &#34;*2\r\n$3\r\nget\r\n$10\r\nusers:1234\r\n&#34;
</span></span></code></pre></div><p>We see that the Redis command <code>get users:1234</code> as entered in our client is translated to <code>*2\r\n$3\r\nget\r\n$10\r\nusers:1234\r\n</code>. Any Redis client is going to convert our command expressed in its respective syntax to the same on-the-wire format. So in Python:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>&gt;&gt;&gt; redis_client.get(&#39;users:1234&#39;)
</span></span></code></pre></div><p>will send the same <code>*2\r\n$3\r\nget\r\n$10\r\nusers:1234\r\n</code> bytestring to the server.</p>
<p>Let&rsquo;s print that bytestring to screen and render those `\r\n&rsquo;s as line feeds so we can see an expanded view and get a better look at the protocol.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>*2
</span></span><span style="display:flex;"><span>$3
</span></span><span style="display:flex;"><span>get
</span></span><span style="display:flex;"><span>$10
</span></span><span style="display:flex;"><span>users:1234
</span></span></code></pre></div><p>The first bit is <code>*2</code>, which tells us that the arity of the command, including the command name, is 2. That is, the server should expect two arguments to follow.</p>
<p>The next bit is <code>$3</code>, which means that the length of the first argument in bytes is 3. The argument itself follows, our command name, <code>get</code>.</p>
<p>The next bit after that is <code>$10</code>, so the length in bytes of the second argument is 10. Our one and only argument to the command is next, <code>users:1234</code>, the key we are trying to <code>get</code>.</p>
<h2 id="receiving-the-command-on-the-server">Receiving the command on the server</h2>
<p>If you remember from the last article, <code>readQueryFromClient</code> is a good place to set a breakpoint in your debugger on the server side for inspecting an inbound client command.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>server $ gdb src/redis-server
</span></span><span style="display:flex;"><span>(gdb) b readQueryFromClient
</span></span><span style="display:flex;"><span>Breakpoint 1 at 0x100011445: file networking.c, line 882.
</span></span><span style="display:flex;"><span>(gdb) run redis.conf
</span></span><span style="display:flex;"><span>Starting program: /home/paul/src/redis-2.2.0-RC2/src/redis-server redis.conf
</span></span><span style="display:flex;"><span>Reading symbols for shared libraries +. done
</span></span><span style="display:flex;"><span>[63700] 01 Mar 11:04:40 * Server started, Redis version 2.2.1
</span></span><span style="display:flex;"><span>[63700] 01 Mar 11:04:40 * The server is now ready to accept connections on port 6379
</span></span></code></pre></div><p>Now back in the terminal with the client running in the debugger, continue to send the command to the server, which will stop at the breakpoint we set.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span># client
</span></span><span style="display:flex;"><span>(gdb) c
</span></span><span style="display:flex;"><span>Continuing.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># server
</span></span><span style="display:flex;"><span>Breakpoint 1, readQueryFromClient (el=0x100200000, fd=5, privdata=0x100804e00, mask=1) at networking.c:801
</span></span><span style="display:flex;"><span>801     void readQueryFromClient(aeEventLoop *el, int fd, void *privdata, int mask) {
</span></span></code></pre></div><p>Let&rsquo;s step to the following line:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span># src/networking.c:808
</span></span><span style="display:flex;"><span>nread = read(fd, buf, REDIS_IOBUF_LEN);
</span></span></code></pre></div><p>If we step to here in our debugger, we see that the server read 30 bytes. If you count the number of bytes in our Redis protocol-encoded command, <code>*2\r\n$3\r\nget\r\n$10\r\nusers:1234\r\n</code>, you&rsquo;ll see it&rsquo;s 30. Just for good measure, let&rsquo;s look at the 30 bytes beginning at the memory location pointed to by <code>buf</code>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>(gdb) p nread
</span></span><span style="display:flex;"><span>30
</span></span><span style="display:flex;"><span>(gdb) x/30cb buf
</span></span><span style="display:flex;"><span>0x7fff5fbfeaf0: 42 &#39;*&#39;  50 &#39;2&#39;  13 &#39;\r&#39; 10 &#39;\n&#39; 36 &#39;$&#39;  51 &#39;3&#39;  13 &#39;\r&#39; 10 &#39;\n&#39;
</span></span><span style="display:flex;"><span>0x7fff5fbfeaf8: 71 &#39;G&#39;  69 &#39;E&#39;  84 &#39;T&#39;  13 &#39;\r&#39; 10 &#39;\n&#39; 36 &#39;$&#39;  49 &#39;1&#39;  48 &#39;0&#39;
</span></span><span style="display:flex;"><span>0x7fff5fbfeb00: 13 &#39;\r&#39; 10 &#39;\n&#39; 117 &#39;u&#39; 115 &#39;s&#39; 101 &#39;e&#39; 114 &#39;r&#39; 115 &#39;s&#39; 58 &#39;:&#39;
</span></span><span style="display:flex;"><span>0x7fff5fbfeb08: 49 &#39;1&#39;  50 &#39;2&#39;  51 &#39;3&#39;  52 &#39;4&#39;  13 &#39;\r&#39; 10 &#39;\n&#39;
</span></span></code></pre></div><p>And we can see our whole command bytestring is there, byte by byte.</p>
<p>The server has now read in the entirety of our command in one step. (Because we had a relatively short command, one that fits inside a kernel buffer, and we are the only client on a loopback network device, this is the case, but it need not be. Since Redis is event-driven, this function, <code>readQueryFromClient</code>, is called whenever there are bytes from buffers to be read. If our command was particularly long, or there was a lot of network contention, the command may take more than one I/O event before it is fully read. For this reason, Redis builds up a buffer per client and appends bytes to it on each call to this function. It only proceeds with processing the command when it has been fully read. But we don&rsquo;t need to consider this in our simple example, so we will proceed.)</p>
<p>We&rsquo;re going to elide the processing of the input buffer. This is the point where the server takes the Redis protocol-encoded bytestring of our request and unpacks it into arguments on the client struct object. If you are interested in the details of that parsing, examine the function <code>processMultibulkBuffer</code> in <code>networking.c</code>. All we are interested in at this point is that the <code>argc</code> member of the client object is the number of command arguments (counting the command name itself) and <code>argv</code> is a pointer to the list of arguments.</p>
<p>The bit of code we care at this point is <code>processCommand</code>. The first thing the server does is look up the command in its command table (see &ldquo;Setting up command table&rdquo; in the previous article, but note that this lookup is now O(1), see the HN thread linked above). Assuming the command is found (which our <code>get</code> will be), the server will double-check that the arity of the command as defined in the command table matches the number of arguments received from the client (<code>c-&gt;argc</code>).</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span># redis.c:998
</span></span><span style="display:flex;"><span>cmd = lookupCommand(c-&gt;argv[0]-&gt;ptr);
</span></span><span style="display:flex;"><span>if (!cmd) {
</span></span><span style="display:flex;"><span>    addReplyErrorFormat(c,&#34;unknown command &#39;%s&#39;&#34;,
</span></span><span style="display:flex;"><span>        (char*)c-&gt;argv[0]-&gt;ptr);
</span></span><span style="display:flex;"><span>    return REDIS_OK;
</span></span><span style="display:flex;"><span>} else if ((cmd-&gt;arity &gt; 0 &amp;&amp; cmd-&gt;arity != c-&gt;argc) ||
</span></span><span style="display:flex;"><span>           (c-&gt;argc &lt; -cmd-&gt;arity)) {
</span></span><span style="display:flex;"><span>    addReplyErrorFormat(c,&#34;wrong number of arguments for &#39;%s&#39; command&#34;,
</span></span><span style="display:flex;"><span>        cmd-&gt;name);
</span></span><span style="display:flex;"><span>    return REDIS_OK;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Skip down to the end of <code>processCommand</code>. Because our humble <code>get</code> is not a &ldquo;multi&rdquo; command like <code>mget</code>, <code>mset</code>, etc., it doesn&rsquo;t require queue-like processing of the underlying multiple commands, so we go right to <code>call</code>, which is where our command is dispatched.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span># redis.c:953
</span></span><span style="display:flex;"><span>void call(redisClient *c, struct redisCommand *cmd) {
</span></span><span style="display:flex;"><span>    long long dirty;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    dirty = server.dirty;
</span></span><span style="display:flex;"><span>    cmd-&gt;proc(c);
</span></span><span style="display:flex;"><span>    dirty = server.dirty-dirty;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    if (server.appendonly &amp;&amp; dirty)
</span></span><span style="display:flex;"><span>        feedAppendOnlyFile(cmd,c-&gt;db-&gt;id,c-&gt;argv,c-&gt;argc);
</span></span><span style="display:flex;"><span>    if ((dirty || cmd-&gt;flags &amp; REDIS_CMD_FORCE_REPLICATION) &amp;&amp;
</span></span><span style="display:flex;"><span>        listLength(server.slaves))
</span></span><span style="display:flex;"><span>        replicationFeedSlaves(server.slaves,c-&gt;db-&gt;id,c-&gt;argv,c-&gt;argc);
</span></span><span style="display:flex;"><span>    if (listLength(server.monitors))
</span></span><span style="display:flex;"><span>        replicationFeedMonitors(server.monitors,c-&gt;db-&gt;id,c-&gt;argv,c-&gt;argc);
</span></span><span style="display:flex;"><span>    server.stat_numcommands++;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Let&rsquo;s focus on line 952, <code>cmd-&gt;proc(c);</code>. This is Redis&rsquo;s dynamic dispatching of command function calling. Redis makes this clean and simple by encapsulating commands and giving all the actual underlying command functions the same function signature, taking our client object, which carries the payload of our command&rsquo;s arguments. So we&rsquo;re interested in looking into the details of the Redis command object and the actual function that will handle our <code>get</code>.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span># redis.h:504
</span></span><span style="display:flex;"><span>struct redisCommand {
</span></span><span style="display:flex;"><span>    char *name;
</span></span><span style="display:flex;"><span>    redisCommandProc *proc;
</span></span><span style="display:flex;"><span>    int arity;
</span></span><span style="display:flex;"><span>    int flags;
</span></span><span style="display:flex;"><span>    /* Use a function to determine which keys need to be loaded
</span></span><span style="display:flex;"><span>     * in the background prior to executing this command. Takes precedence
</span></span><span style="display:flex;"><span>     * over vm_firstkey and others, ignored when NULL */
</span></span><span style="display:flex;"><span>    redisVmPreloadProc *vm_preload_proc;
</span></span><span style="display:flex;"><span>    /* What keys should be loaded in background when calling this command? */
</span></span><span style="display:flex;"><span>    int vm_firstkey; /* The first argument that&#39;s a key (0 = no keys) */
</span></span><span style="display:flex;"><span>    int vm_lastkey;  /* THe last argument that&#39;s a key */
</span></span><span style="display:flex;"><span>    int vm_keystep;  /* The step between first and last key */
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></div><p>If we pop up to the top of <code>redis.c</code>, we see the definition of the Redis command table, and our <code>get</code> is the first entry.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span># redis.c:71
</span></span><span style="display:flex;"><span>struct redisCommand readonlyCommandTable[] = {
</span></span><span style="display:flex;"><span>    {&#34;get&#34;,getCommand,2,0,NULL,1,1,1},
</span></span></code></pre></div><p><code>getCommand</code> is the function that does the actual work for our command. It&rsquo;s a thin wrapper for <code>getGenericCommand</code>.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span># t_string.c:62
</span></span><span style="display:flex;"><span>int getGenericCommand(redisClient *c) {
</span></span><span style="display:flex;"><span>    robj *o;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    if ((o = lookupKeyReadOrReply(c,c-&gt;argv[1],shared.nullbulk)) == NULL)
</span></span><span style="display:flex;"><span>        return REDIS_OK;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    if (o-&gt;type != REDIS_STRING) {
</span></span><span style="display:flex;"><span>        addReply(c,shared.wrongtypeerr);
</span></span><span style="display:flex;"><span>        return REDIS_ERR;
</span></span><span style="display:flex;"><span>    } else {
</span></span><span style="display:flex;"><span>        addReplyBulk(c,o);
</span></span><span style="display:flex;"><span>        return REDIS_OK;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>void getCommand(redisClient *c) {
</span></span><span style="display:flex;"><span>    getGenericCommand(c);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>The arguments to <code>lookupKeyReadOrReply</code> are the client object, the key <code>users:1234</code> we&rsquo;re trying to look up, and an object, <code>shared.nullbulk</code> that will be the default reply to the client if the key is not found.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span># db.c:58
</span></span><span style="display:flex;"><span>robj *lookupKeyReadOrReply(redisClient *c, robj *key, robj *reply) {
</span></span><span style="display:flex;"><span>    robj *o = lookupKeyRead(c-&gt;db, key);
</span></span><span style="display:flex;"><span>    if (!o) addReply(c,reply);
</span></span><span style="display:flex;"><span>    return o;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><code>lookupKeyRead</code> is a thin wrapper for <code>lookupKey</code> that handles removing keys that have been set to expire.</p>
<p>Now we get to the heart of the <code>get</code> command &ndash; looking up the key in the database.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span># db.c:9
</span></span><span style="display:flex;"><span>robj *lookupKey(redisDb *db, robj *key) {
</span></span><span style="display:flex;"><span>    dictEntry *de = dictFind(db-&gt;dict,key-&gt;ptr);
</span></span><span style="display:flex;"><span>    if (de) {
</span></span><span style="display:flex;"><span>        robj *val = dictGetEntryVal(de);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        /* Update the access time for the aging algorithm.
</span></span><span style="display:flex;"><span>         * Don&#39;t do it if we have a saving child, as this will trigger
</span></span><span style="display:flex;"><span>         * a copy on write madness. */
</span></span><span style="display:flex;"><span>        if (server.bgsavechildpid == -1 &amp;&amp; server.bgrewritechildpid == -1)
</span></span><span style="display:flex;"><span>            val-&gt;lru = server.lruclock;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        if (server.vm_enabled) {
</span></span><span style="display:flex;"><span>            if (val-&gt;storage == REDIS_VM_MEMORY ||
</span></span><span style="display:flex;"><span>                val-&gt;storage == REDIS_VM_SWAPPING)
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>                /* If we were swapping the object out, cancel the operation */
</span></span><span style="display:flex;"><span>                if (val-&gt;storage == REDIS_VM_SWAPPING)
</span></span><span style="display:flex;"><span>                    vmCancelThreadedIOJob(val);
</span></span><span style="display:flex;"><span>            } else {
</span></span><span style="display:flex;"><span>                int notify = (val-&gt;storage == REDIS_VM_LOADING);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                /* Our value was swapped on disk. Bring it at home. */
</span></span><span style="display:flex;"><span>                redisAssert(val-&gt;type == REDIS_VMPOINTER);
</span></span><span style="display:flex;"><span>                val = vmLoadObject(val);
</span></span><span style="display:flex;"><span>                dictGetEntryVal(de) = val;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                /* Clients blocked by the VM subsystem may be waiting for
</span></span><span style="display:flex;"><span>                 * this key... */
</span></span><span style="display:flex;"><span>                if (notify) handleClientsBlockedOnSwappedKey(db,key);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        server.stat_keyspace_hits++;
</span></span><span style="display:flex;"><span>        return val;
</span></span><span style="display:flex;"><span>    } else {
</span></span><span style="display:flex;"><span>        server.stat_keyspace_misses++;
</span></span><span style="display:flex;"><span>        return NULL;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Redis uses its own hash table implementation to store keys and their values in memory. Inside the <code>db</code> object, the field <code>dict</code> is a pointer to the hash value for the current Redis database (remember there can be up to 16 separate databases in a single Redis server instance, indexed by number).</p>
<p>First, Redis calls <code>dictFind</code> with the database&rsquo;s hash table and a pointer to the key&rsquo;s bytestring. <code>dictFind</code> looks up the hash of the key in the table, using a standard algorithm that should be familiar to anyone who&rsquo;s implemented a hash table (check out <code>dict.c</code> starting at line 391 if you&rsquo;re interested, the table is an array with linked lists for colliding hashes).</p>
<p>If the key is found in the table, <code>dictFind</code> returns a pointer to the entry in the table. Otherwise, it returns <code>NULL</code>. Back in <code>lookupKey</code>, if the entry is not null, Redis retrieves the value (i.e., the Redis object our key references) from the hash table via <code>dictGetEntryVal</code> and takes care of a bit of bookkeeping for expiry and VM, if the key was found, and stats in either case (hits and misses). If the entry was <code>NULL</code>, then <code>lookupKey</code> also returns <code>NULL</code>; we&rsquo;ll see how this is handled by Redis for a reply to the client when the key is not found, which is the case for us at this stage.</p>
<p>With the value of <code>lookupKey</code>, we&rsquo;ll go back up the stack to our callers. Back to <code>lookupKeyReadOrReply</code>, we look at line 60:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span># t_string.c:60
</span></span><span style="display:flex;"><span>        if (!o) addReply(c,reply);
</span></span></code></pre></div><p>Since we got <code>NULL</code> from <code>lookupKey</code> this time, we call <code>addReply</code>. The value of <code>reply</code> here comes from the call in <code>getGenericCommand</code>, and it is <code>shared.nullbulk</code>. This field in the global struct object <code>shared</code> is initialize thusly:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span># redis.c:712
</span></span><span style="display:flex;"><span>shared.nullbulk = createObject(REDIS_STRING,sdsnew(&#34;$-1\r\n&#34;));
</span></span></code></pre></div><p>We can see that it is a Redis string object who&rsquo;s on-the-wire value is <code>$-1\r\n</code>, meaning a length of -1, Redis&rsquo;s way of indicating null to a client, according to the protocol.</p>
<p><code>addReply</code> builds the reply to the client. It does this by first setting up a write event on the main event loop listener with <code>_installWriteEvent</code>. This makes sure that the reply is written out to the client connection when there are bytes present in the buffer. Next, Redis adds the reply to the client&rsquo;s buffer. If the reply object were an non-string value like an integer, or a list, or a set, Redis would first decode it to a bytestring that can be serialized to, for example, on a socket. Redis string objects are encoded &ldquo;raw,&rdquo; or as-is. The <code>nullbulk</code> object is technically a string object, so no decoding is necessary in our case. In any case, the reply bytestring is copied to the client&rsquo;s reply buffer with <code>_addReplyToBuffer</code>, which for all intents and purposes completes the execution of our <code>get</code> command on the server.</p>
<p>The client will read the on-the-wire reply of <code>$-1\r\n</code> and know that it is a string reply of length -1, and therefore is the null (or &ldquo;nil,&rdquo; in the context of <code>redis-cli</code>) object, and to convert that into the appropriate object for the language of the client. Back to our <code>redis-cli</code> client patiently waiting for a reply from our breakpointed server, which we continue from, that looks like:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>(nil)
</span></span><span style="display:flex;"><span>redis&gt;
</span></span></code></pre></div><h1 id="set">SET</h1>
<p>The <code>set</code> command proceeds much the same way as the <code>get</code>, up to the point of command dispatching on the server.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span># client
</span></span><span style="display:flex;"><span>redis&gt; set users:1234 &#34;Paul Smith&#34;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># server
</span></span><span style="display:flex;"><span>Breakpoint 1, readQueryFromClient (el=0x100400000, fd=6, privdata=0x100805e00, mask=1) at networking.c:801
</span></span><span style="display:flex;"><span>801     void readQueryFromClient(aeEventLoop *el, int fd, void *privdata, int mask) {
</span></span><span style="display:flex;"><span>(gdb) n
</span></span><span style="display:flex;"><span>802         redisClient *c = (redisClient*) privdata;
</span></span><span style="display:flex;"><span>(gdb) n
</span></span><span style="display:flex;"><span>808         nread = read(fd, buf, REDIS_IOBUF_LEN);
</span></span><span style="display:flex;"><span>(gdb) n
</span></span><span style="display:flex;"><span>809         if (nread == -1) {
</span></span><span style="display:flex;"><span>(gdb) print nread
</span></span><span style="display:flex;"><span>$1 = 47
</span></span><span style="display:flex;"><span>(gdb) x/47cb buf
</span></span><span style="display:flex;"><span>0x7fff5fbfeba0: 42 &#39;*&#39;  51 &#39;3&#39;  13 &#39;\r&#39; 10 &#39;\n&#39; 36 &#39;$&#39;  51 &#39;3&#39;  13 &#39;\r&#39; 10 &#39;\n&#39;
</span></span><span style="display:flex;"><span>0x7fff5fbfeba8: 115 &#39;s&#39; 101 &#39;e&#39; 116 &#39;t&#39; 13 &#39;\r&#39; 10 &#39;\n&#39; 36 &#39;$&#39;  49 &#39;1&#39;  48 &#39;0&#39;
</span></span><span style="display:flex;"><span>0x7fff5fbfebb0: 13 &#39;\r&#39; 10 &#39;\n&#39; 117 &#39;u&#39; 115 &#39;s&#39; 101 &#39;e&#39; 114 &#39;r&#39; 115 &#39;s&#39; 58 &#39;:&#39;
</span></span><span style="display:flex;"><span>0x7fff5fbfebb8: 49 &#39;1&#39;  50 &#39;2&#39;  51 &#39;3&#39;  52 &#39;4&#39;  13 &#39;\r&#39; 10 &#39;\n&#39; 36 &#39;$&#39;  49 &#39;1&#39;
</span></span><span style="display:flex;"><span>0x7fff5fbfebc0: 48 &#39;0&#39;  13 &#39;\r&#39; 10 &#39;\n&#39; 80 &#39;P&#39;  97 &#39;a&#39;  117 &#39;u&#39; 108 &#39;l&#39; 32 &#39; &#39;
</span></span><span style="display:flex;"><span>0x7fff5fbfebc8: 83 &#39;S&#39;  109 &#39;m&#39; 105 &#39;i&#39; 116 &#39;t&#39; 104 &#39;h&#39; 13 &#39;\r&#39; 10 &#39;\n&#39;
</span></span><span style="display:flex;"><span>(gdb) print (char *)buf
</span></span><span style="display:flex;"><span>$2 = 0x7fff5fbfeba0 &#34;*3\r\n$3\r\nset\r\n$10\r\nusers:1234\r\n$10\r\nPaul Smith\r\n&#34;
</span></span></code></pre></div><p>This time, our protocol-encoded bytestring is 47 bytes long, owing to the extra argument &ldquo;Paul Smith&rdquo; and the length tag it requires. Also notice the leading <code>*3</code> indicates there are three arguments: <code>set</code>, <code>users:1234</code>, <code>Paul Smith</code>.</p>
<p>Let&rsquo;s skip ahead now to the point in <code>call</code> in <code>redis.c</code>, after the command has been looked-up in the command table and the server is about ready to call the underlying <code>proc</code> function with the client object argument. The <code>set</code> command, in the form of a <code>redisCommand</code> struct, looks like this:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span># redis.c:73
</span></span><span style="display:flex;"><span>{&#34;set&#34;,setCommand,3,REDIS_CMD_DENYOOM,NULL,0,0,0},
</span></span></code></pre></div><p>Notice that the arity of the command is 3, which includes the leading command name, plus key and value, and matches what we expect from the client. The <code>set</code> command has a flag that <code>get</code> did not: the constant <code>REDIS_CMD_DENYOOM</code> means that, in out-of-memory situations where Redis can&rsquo;t allocate any more memory, the execution of the command should be denied. (The absence of this flag means that Redis can continue to serve client &ldquo;read&rdquo; requests like <code>get</code> even when the server can no longer write any new data.)</p>
<p>I set a breakpoint on <code>setCommand</code> and let the server continue running until that point:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span># server
</span></span><span style="display:flex;"><span>(gdb) b setCommand
</span></span><span style="display:flex;"><span>Breakpoint 2 at 0x10001a6e2: file t_string.c, line 48.
</span></span><span style="display:flex;"><span>(gdb) c
</span></span><span style="display:flex;"><span>Continuing.
</span></span><span style="display:flex;"><span>Breakpoint 2, setCommand (c=0x100805e00) at t_string.c:48
</span></span><span style="display:flex;"><span>48          c-&gt;argv[2] = tryObjectEncoding(c-&gt;argv[2]);
</span></span></code></pre></div><p>Incidentally, you can inspect the values of the client&rsquo;s command arguments at any time, with a simple <code>gdb</code> invocation. The arguments are of type <code>robj</code>, which has a field <code>ptr</code> that is a pointer to the actual value in memory. Since in our <code>set</code> case these are strings, we can inspect them by typecasting to <code>char *</code> like so:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>(gdb) p (char *)c-&gt;argv[0]-&gt;ptr
</span></span><span style="display:flex;"><span>$10 = 0x10032ae78 &#34;set&#34;
</span></span><span style="display:flex;"><span>(gdb) p (char *)c-&gt;argv[1]-&gt;ptr
</span></span><span style="display:flex;"><span>$11 = 0x10032b068 &#34;users:1234&#34;
</span></span><span style="display:flex;"><span>(gdb) p (char *)c-&gt;argv[2]-&gt;ptr
</span></span><span style="display:flex;"><span>$12 = 0x10032b098 &#34;Paul Smith&#34;
</span></span></code></pre></div><p>The first thing the server does in <code>setCommand</code> is encode the value being set with <code>tryObjectEncoding</code>. It will try to create an efficient encoding if the bytestring can be interpreted as an integer, for example. This can save space especially in the case where many numbers are being stored. Additionally, Redis will try to reuse shared integers as values instead of allocating resources for new ones &ndash; see the previous article for more on the creation and use of shared integers.</p>
<p>Once the value being set has been encoded, <code>setGenericCommand</code> is called (<code>set</code> shares <code>setGenericCommand</code> with the <code>setnx</code> and <code>setex</code> commands). From here, <code>dbAdd</code> is called, with the client, key, and value as arguments. <code>dbAdd</code> will only add the value to the database&rsquo;s hash table if the key does not already exist. In our case, since the key <code>users:1234</code> does not exist, the value of <code>dictFind</code> is null, and the function proceeds to add the value with <code>dictAdd</code>.</p>
<p><code>dictAdd</code> takes the dictionary hash table, key, and value as arguments. It uses <code>_dictKeyIndex</code> to find the index of a free slot in the hash table for our new entry. See the implementation in <code>dict.c</code> and <code>dict.h</code> for the details of key hashing, and the structure of the dictionary and its component hash tables (each Redis dictionary contains two hash tables in order to provide incremental rehashing as the dictionary grows). <code>dictAdd</code> allocates memory for the new entry and stores it in the new index.</p>
<p>The server returns back up the stack from <code>dictAdd</code> and <code>dbAdd</code> to <code>setGenericCommand</code>, where it increments the reference count on our new value. Redis uses reference counting in order to free memory used by values that have been deleted or have expired. It then &ldquo;touches&rdquo; the key so that if any clients are <code>watch</code>ing the key, the next <code>exec</code> command will fail. It also increments the server&rsquo;s <code>dirty</code> flag, which it uses to determine when to write out the dump file to disk. Finally, it writes out the reply to the client, which is a shared object, <code>shared.ok</code>. This is special Redis string object in the protocol that consists of the bytestring &ldquo;+OK\r\n&rdquo;. Clients will typically convert this into the equivalent &ldquo;true&rdquo; value for their language.</p>
<h1 id="get-redux">GET redux</h1>
<p>Our key is now set, so we can try the <code>get users:1234</code> command again and see how it differs for a found key.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span># db.c:9
</span></span><span style="display:flex;"><span>robj *lookupKey(redisDb *db, robj *key) {
</span></span><span style="display:flex;"><span>    dictEntry *de = dictFind(db-&gt;dict,key-&gt;ptr);
</span></span><span style="display:flex;"><span>    if (de) {
</span></span><span style="display:flex;"><span>        robj *val = dictGetEntryVal(de);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        // ... skipping the lru &amp; vm parts ... 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        server.stat_keyspace_hits++;
</span></span><span style="display:flex;"><span>        return val;
</span></span></code></pre></div><p>The point where a <code>get</code> on an existing key and a <code>get</code> on a non-existent key differ is line 11, where the <code>de</code> entry in the database&rsquo;s dictionary is found. <code>dictGetEntryVal</code> is a simple macro for accessing the field in the <code>de</code> struct that carries the value associated with the key. Redis updates its statistics to indicate a key hit and returns the value object.</p>
<p>Again, as with the key miss from above (remember the null value is a Redis object, too), the value is decoded into the Redis bytestring protocol. This is the response to the client, and we have concluded our <code>GET</code>/<code>SET</code>/<code>GET</code> dance.</p>
<h4 id="recent-posts">Recent posts</h4>
<ul>
<li><a href="https://www.pauladamsmith.com/blog/2011/01/bluecollarleague.html">The All-Blue-Collar League</a></li>
<li><a href="https://www.pauladamsmith.com/blog/2011/04/floppy.html">A partial list of metaphors, visual and otherwise, anti-skeuomorphism zealots have to tackle to reach utopia</a></li>
</ul>
<h4 id="about">About</h4>
<p>Paul Smith is a software engineer. <a href="https://www.pauladamsmith.com/about.html">More …</a></p>
<ul>
<li><strong><a href="tel:13124924668">+1-312-492-4668</a></strong></li>
<li><strong><a href="mailto:paulsmith@gmail.com">paulsmith@gmail.com</a></strong></li>
</ul>
<p>ⓒ Paul Smith</p>
<h4 id="elsewhere">Elsewhere</h4>
<ul>
<li><a href="https://twitter.com/paulsmith">@paulsmith</a></li>
<li><a href="http://www.flickr.com/photos/psmith">Flickr</a></li>
</ul>

    </div>
    <footer class="post-footer">
     
 
<div class="post-tags">     
     
    <a href="http://shanks.link/tags/redis" rel="tag" title="redis">#redis#</a>
    
</div>



     <div class="post-nav">
    <div class="post-nav-next post-nav-item">
    
        <a href="http://shanks.link/blog/2021/09/03/%E5%88%86%E5%B8%83%E5%BC%8F%E7%B3%BB%E7%BB%9F%E7%9A%84raft%E7%AE%97%E6%B3%95/" rel="next" title="分布式系统的Raft算法">
        <i class="fa fa-chevron-left"></i> 分布式系统的Raft算法
        </a>
    
    </div>

    <div class="post-nav-prev post-nav-item">
    
        <a href="http://shanks.link/blog/2021/09/01/under-the-hood/" rel="prev" title="under the hood">
        under the hood <i class="fa fa-chevron-right"></i>
        </a>
    
    </div>
</div>
      
     
     
     





<script src="https://utteranc.es/client.js"
        repo="shankusu2017@gmail.com/"
        issue-term="pathname"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>
<noscript>Please enable JavaScript to view the <a href="https://github.com/utterance">comments powered by utterances.</a></noscript>

    </footer>
  </article>
</section>

          </div>
        </div>
        <div class="sidebar-toggle">
  <div class="sidebar-toggle-line-wrap">
    <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
    <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
    <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
  </div>
</div>
<aside id="sidebar" class="sidebar">
  <div class="sidebar-inner">

    <section class="site-overview sidebar-panel  sidebar-panel-active ">
      <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image"
        src="http://shanks.link/img/logo.jpg"
        alt="shankusu2017@gmail.com" />
    <p class="site-author-name" itemprop="name">shankusu2017@gmail.com</p>
    <p class="site-description motion-element" itemprop="description"> </p>
</div>
      <nav class="site-state motion-element">
    <div class="site-state-item site-state-posts">
      <a href="http://shanks.link/post/">
        <span class="site-state-item-count">520</span>
        <span class="site-state-item-name">日志</span>
      </a>
    </div>
    <div class="site-state-item site-state-categories">    
        <a href="http://shanks.link/categories/">      
         
        <span class="site-state-item-count">34</span>
        
        <span class="site-state-item-name">分类</span>
        
        </a>
    </div>

    <div class="site-state-item site-state-tags">
        <a href="http://shanks.link/tags/">
         
        <span class="site-state-item-count">39</span>
        
        <span class="site-state-item-name">标签</span>
        </a>
    </div>
</nav>
      
      
<div class="links-of-author motion-element">
    
        <span class="links-of-author-item">
        <a href="https://github.com/shankusu2017" target="_blank" title="GitHub">
            <i class="fa fa-fw fa-github"></i>
            GitHub
        </a>
        </span>
    
</div>


      

      <div class="links-of-blogroll motion-element inline">
<script type="text/javascript" src="//rf.revolvermaps.com/0/0/8.js?i=5b4f2ucxar6&amp;m=0&amp;s=220&amp;c=ff0000&amp;cr1=ffffff&amp;f=arial&amp;l=33&amp;bv=35" async="async"></script>
</div>

    </section>
    
  </div>
</aside>

      </div>
    </main>
   
    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  <span itemprop="copyrightYear">  &copy; 
  2009 - 2022</span>
  <span class="with-love"><i class="fa fa-heart"></i></span>
  <span class="author" itemprop="copyrightHolder">愿星光伴你左右</span>
</div>
<div class="powered-by">
  Powered by - <a class="theme-link" href="http://gohugo.io" target="_blank" title="hugo" >Hugo v0.101.0</a>
</div>
<div class="theme-info">
  Theme by - <a class="theme-link" href="https://github.com/xtfly/hugo-theme-next" target="_blank"> NexT
  </a>
</div>


      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
      <span id="scrollpercent"><span>0</span>%</span>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>
<script type="text/javascript" src="http://shanks.link/js/vendor/jquery/index.js?v=2.1.3"></script>
<script type="text/javascript" src="http://shanks.link/js/vendor/fastclick/lib/fastclick.min.js?v=1.0.6"></script> 
<script type="text/javascript" src="http://shanks.link/js/vendor/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
<script type="text/javascript" src="http://shanks.link/js/vendor/velocity/velocity.min.js?v=1.2.1"></script>
<script type="text/javascript" src="http://shanks.link/js/vendor/velocity/velocity.ui.min.js?v=1.2.1"></script>
<script src="http://shanks.link/js/vendor/ua-parser-js/dist/ua-parser.min.js?v=0.7.9"></script>

<script src="http://shanks.link/js/vendor/fancybox/jquery.fancybox.pack.js?v=2.1.5"></script>

<script type="text/javascript" src="http://shanks.link/js/utils.js"></script>
<script type="text/javascript" src="http://shanks.link/js/motion.js"></script>
<script type="text/javascript" src="http://shanks.link/js/affix.js"></script>
<script type="text/javascript" src="http://shanks.link/js/schemes/pisces.js"></script>

<script type="text/javascript" src="http://shanks.link/js/scrollspy.js"></script>
<script type="text/javascript" src="http://shanks.link/js/post-details.js"></script>
<script type="text/javascript" src="http://shanks.link/js/toc.js"></script>

<script type="text/javascript" src="http://shanks.link/js/bootstrap.js"></script>

<script type="text/javascript" src="http://shanks.link/js/search.js"></script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX", "output/HTML-CSS"],
    tex2jax: {
      inlineMath: [ ['$','$'] ],
      displayMath: [ ['$$','$$'] ],
      processEscapes: true
    },
    "HTML-CSS": { fonts: ["TeX"] }
  });
</script>
<script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML' async></script>
</body>
</html>