<!DOCTYPE HTML>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" /> 
    <title>under the hood - 愿星光伴你左右</title>
    <meta name="keywords" content="git,Git,Lua,lua,Golang,go">
    
    <meta property="og:title" content="under the hood">
    <meta property="og:site_name" content="愿星光伴你左右">
    <meta property="og:image" content="/img/author.jpg"> 
    <meta name="title" content="under the hood - 愿星光伴你左右" />
    <meta name="description" content="愿星光伴你左右"> 
    <link rel="shortcut icon" href="http://shanks.link/img/favicon.ico" />
    <link rel="apple-touch-icon" href="http://shanks.link/img/apple-touch-icon.png" />
    <link rel="apple-touch-icon-precomposed" href="http://shanks.link/img/apple-touch-icon.png" />
    <link href="http://shanks.link/js/vendor/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />
    <link href="http://shanks.link/js/vendor/fancybox/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />
    <link href="http://shanks.link/css/main.css" rel="stylesheet" type="text/css" />
    <link href="http://shanks.link/css/syntax.css" rel="stylesheet" type="text/css" />
    <script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post"},
     fancybox: true, 
    motion: true
  };
</script>
</head>
<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">
<div class="container one-collumn sidebar-position-left page-home  ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"> <div class="site-meta  custom-logo ">

  <div class="custom-logo-site-title">
    <a href="http://shanks.link/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">愿星光伴你左右</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle"></p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
    <ul id="menu" class="menu">
      
      
        <li class="menu-item ">
          <a href="http://shanks.link/post/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />首页
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/thinking/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />随想录
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/prose/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />散文
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/%E7%94%9F%E6%B4%BB/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />生活
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/os/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />OS
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/lua/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />lua
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/redis/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />redis
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/go/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />Golang
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/c/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />C
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/openvpn/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />OpenVPN
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/web/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />web
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/openwrt/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />OpenWRT
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/%E8%BF%90%E7%BB%B4/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />运维
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/git/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />Git
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/categories/it/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />IT杂谈
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/about/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />About Me
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="http://shanks.link/links/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />友情链接
          </a>
        </li>
      
      <li class="menu-item menu-item-search">
        <a href="javascript:;" class="popup-trigger"> <i class="menu-item-icon fa fa-search fa-fw"></i> <br /> 搜索</a>
      </li>
    </ul>
    <div class="site-search">
      <div class="popup">
 <span class="search-icon fa fa-search"></span>
 <input type="text" id="local-search-input">
 <div id="local-search-result"></div>
 <span class="popup-btn-close">close</span>
</div>

    </div>
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
<section id="posts" class="posts-expand">
  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <header class="post-header">
      <h1 class="post-title" itemprop="name headline">
        <a class="post-title-link" href="http://shanks.link/blog/2021/09/01/under-the-hood/" itemprop="url">
        under the hood
        </a>
      </h1>
      <div class="post-meta">
      <span class="post-time">
<span class="post-meta-item-icon">
    <i class="fa fa-calendar-o"></i>
</span>
<span class="post-meta-item-text">时间：</span>
<time itemprop="dateCreated" datetime="2016-03-22T13:04:35+08:00" content="2021-09-01">
    2021-09-01
</time>
</span> 
      

  <span class="post-category" >
  &nbsp; | &nbsp;
  <span class="post-meta-item-icon">
    <i class="fa fa-folder-o"></i>
  </span>
  <span class="post-meta-item-text">分类：</span>
  
    <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
      <a href="http://shanks.link/categories/redis" itemprop="url" rel="index">
        <span itemprop="name">redis</span>
      </a>
      &nbsp; 
    </span>
  
</span>


       <span>
&nbsp; | &nbsp;
<span class="post-meta-item-icon">
    <i class="fa fa-eye"></i>
</span>
<span class="post-meta-item-text">阅读：</span>
<span class="leancloud-visitors-count">3752 字 ~18分钟</span>
</span>
      </div>
    </header>
    <div class="post-body" itemprop="articleBody">
    <p>by <a href="https://www.pauladamsmith.com/">Paul Smith</a> (<a href="http://twitter.com/paulsmith">@paulsmith</a>)</p>
<p><a href="http://code.google.com/p/redis/"><img src="https://www.pauladamsmith.com/articles/redis_under_the_hood/redis.png" alt="Redis logo"></a></p>
<p>How does the <a href="http://code.google.com/p/redis/">Redis</a> server work?</p>
<p>I was curious to learn more about Redis’s internals, so I’ve been familiarizing myself with the source, largely by reading and jumping around in Emacs. After I had peeled back enough of the onion’s layers, I realized I was trying to keep track of too many details in my head, and it wasn’t clear how it all hung together. I decided to write out in narrative form how an instance of the Redis server starts up and initializes itself, and how it handles the request/response cycle with a client, as a way of explaining it to myself, hopefully in a clear fashion. Luckily, Redis has a nice, clean code base that is easy to read and follow along. Armed with a <a href="http://ctags.sourceforge.net/">TAGS</a> file, my <code>$EDITOR</code>, and GDB, I set out to see how it all works under the hood. (Incidentally, I was working with the Redis code base as of <a href="http://github.com/antirez/redis/tree/b4f2e412d087bae0a523fe6ea40fcad30fe74b5b">commit b4f2e41</a>. Of course, internals such as I outline below are subject to change. However, the broad architecture of the server is unlikely to change very much, and I tried to keep that in mind as I went along.)</p>
<p>This article examines server startup and takes a high-level view of the request/response processing cycle. In a <a href="https://www.pauladamsmith.com/blog/2011/03/redis_get_set.html">subsequent article</a>, I’ll dive in to greater detail and trace a simple <code>SET</code>/<code>GET</code> command pair as they make their way through Redis.</p>
<ul>
<li>Redis: under the hood
<ul>
<li>Startup
<ul>
<li><a href="https://www.pauladamsmith.com/articles/redis-under-the-hood.html#beginning-global-server-state-initialization">Beginning global server state initialization</a></li>
<li><a href="https://www.pauladamsmith.com/articles/redis-under-the-hood.html#setting-up-command-table">Setting up command table</a></li>
<li><a href="https://www.pauladamsmith.com/articles/redis-under-the-hood.html#loading-config-file">Loading config file</a></li>
<li><code>initServer()</code>
<ul>
<li>Shared objects
<ul>
<li><a href="https://www.pauladamsmith.com/articles/redis-under-the-hood.html#shared-integers">Shared integers</a></li>
</ul>
</li>
<li><a href="https://www.pauladamsmith.com/articles/redis-under-the-hood.html#event-loop">Event loop</a></li>
<li><a href="https://www.pauladamsmith.com/articles/redis-under-the-hood.html#databases">Databases</a></li>
<li><a href="https://www.pauladamsmith.com/articles/redis-under-the-hood.html#tcp-socket">TCP socket</a></li>
<li><a href="https://www.pauladamsmith.com/articles/redis-under-the-hood.html#server-cron">Server cron</a></li>
<li><a href="https://www.pauladamsmith.com/articles/redis-under-the-hood.html#registering-connection-handler-with-event-loop">Registering connection handler with event loop</a></li>
<li><a href="https://www.pauladamsmith.com/articles/redis-under-the-hood.html#opening-the-aof">Opening the AOF</a></li>
</ul>
</li>
<li>Back up to <code>main()</code>
<ul>
<li><a href="https://www.pauladamsmith.com/articles/redis-under-the-hood.html#restoring-data">Restoring data</a></li>
<li><a href="https://www.pauladamsmith.com/articles/redis-under-the-hood.html#event-loop-setup">Event loop setup</a></li>
<li><a href="https://www.pauladamsmith.com/articles/redis-under-the-hood.html#entering-the-event-loop">Entering the event loop</a></li>
</ul>
</li>
</ul>
</li>
<li>Processing a request &amp; returning a response
<ul>
<li><a href="https://www.pauladamsmith.com/articles/redis-under-the-hood.html#handling-a-new-connection">Handling a new connection</a></li>
<li><a href="https://www.pauladamsmith.com/articles/redis-under-the-hood.html#reading-a-command-from-a-client">Reading a command from a client</a></li>
<li><a href="https://www.pauladamsmith.com/articles/redis-under-the-hood.html#executing-the-command-and-responding">Executing the command and responding</a></li>
</ul>
</li>
<li><a href="https://www.pauladamsmith.com/articles/redis-under-the-hood.html#summary">Summary</a></li>
<li><a href="https://www.pauladamsmith.com/articles/redis-under-the-hood.html#next-time-tracing-a-set-and-get">Next time — tracing a <code>SET</code> and <code>GET</code></a></li>
</ul>
</li>
</ul>
<h2 id="startup">Startup</h2>
<p>Let’s begin with the <code>main()</code> function in <code>redis.c</code>.</p>
<p><a href="https://www.pauladamsmith.com/articles/redis_under_the_hood/startup.png"><img src="https://www.pauladamsmith.com/articles/redis_under_the_hood/startup_th.png" alt="Startup   diagram"></a></p>
<h3 id="beginning-global-server-state-initialization">Beginning global server state initialization</h3>
<p>First, <code>initServerConfig()</code> is called. This partially initializes a variable <code>server</code>, which has the type <code>struct redisServer</code>, that serves as the global server state.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>// redis.h:338
</span></span><span style="display:flex;"><span>struct redisServer {
</span></span><span style="display:flex;"><span>    pthread_t mainthread;
</span></span><span style="display:flex;"><span>    int port;
</span></span><span style="display:flex;"><span>    int fd;
</span></span><span style="display:flex;"><span>    redisDb *db;
</span></span><span style="display:flex;"><span>    // ...
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>// redis.c:69
</span></span><span style="display:flex;"><span>struct redisServer server; /* server global state */
</span></span></code></pre></div><p>There are a huge number of members in this struct, but they generally fall into the following categories:</p>
<ul>
<li>general server state</li>
<li>statistics</li>
<li>configuration from config file</li>
<li>replication</li>
<li>sort parameters</li>
<li>virtual memory config, state, I/O threads, &amp; stats</li>
<li>zip structure</li>
<li>event loop helpers</li>
<li>pub/sub</li>
</ul>
<p>For example, this struct includes members that map to options in the configuration file (usually named <code>redis.conf</code>) such as the port the server listens on and how verbose logging should be, pointers to linked lists of connected clients and slave Redis servers as well as the Redis database(s) itself, and counters for statistics like the number of commands processed since startup.</p>
<p><code>initServerConfig()</code> provides default values for the members that can be configured by the user via the <code>redis.conf</code> config file.</p>
<h3 id="setting-up-command-table">Setting up command table</h3>
<p>The next thing <code>main()</code> does is sort the table of Redis commands. These are defined in a global variable <code>readonlyCommandTable</code> which is an array of <code>struct redisCommand</code>s.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>// redis.c:70
</span></span><span style="display:flex;"><span>struct redisCommand *commandTable;
</span></span><span style="display:flex;"><span>struct redisCommand readonlyCommandTable[] = {
</span></span><span style="display:flex;"><span>    {&#34;get&#34;,getCommand,2,REDIS_CMD_INLINE,NULL,1,1,1},
</span></span><span style="display:flex;"><span>    {&#34;set&#34;,setCommand,3,REDIS_CMD_BULK|REDIS_CMD_DENYOOM,NULL,0,0,0},
</span></span><span style="display:flex;"><span>    {&#34;setnx&#34;,setnxCommand,3,REDIS_CMD_BULK|REDIS_CMD_DENYOOM,NULL,0,0,0},
</span></span><span style="display:flex;"><span>    {&#34;setex&#34;,setexCommand,4,REDIS_CMD_BULK|REDIS_CMD_DENYOOM,NULL,0,0,0},
</span></span><span style="display:flex;"><span>    {&#34;append&#34;,appendCommand,3,REDIS_CMD_BULK|REDIS_CMD_DENYOOM,NULL,1,1,1},
</span></span><span style="display:flex;"><span>    // ...
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>// redis.h:458
</span></span><span style="display:flex;"><span>typedef void redisCommandProc(redisClient *c);
</span></span><span style="display:flex;"><span>// ...
</span></span><span style="display:flex;"><span>struct redisCommand {
</span></span><span style="display:flex;"><span>    char *name;
</span></span><span style="display:flex;"><span>    redisCommandProc *proc;
</span></span><span style="display:flex;"><span>    int arity;
</span></span><span style="display:flex;"><span>    int flags;
</span></span><span style="display:flex;"><span>    // ...
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></div><p>A <code>redisCommand</code> struct keeps track of its name — the mnemonic, i.e., “get” — a pointer to the actual C function that performs the command, the command’s arity, command flags such as whether it returns a bulk response, and a number of VM-specific members.)</p>
<p>The read-only table is ordered in source code so that commands are grouped by category, such as string commands, list commands, set commands, etc., to make it easier for a programmer to scan the table for similar commands. The sorted table of commands is pointed to by the global variable <code>commandTable</code>, and is used to lookup Redis commands with a standard binary search (<code>lookupCommand()</code>, which returns a pointer to a <code>redisCommand</code>).</p>
<h3 id="loading-config-file">Loading config file</h3>
<p><code>main()</code> moves on to processing command-line options given by the user starting up the redis-server executable. Currently, there is only a single argument that Redis takes — aside from the usual version <code>-v</code> and help <code>-h</code> flags — which is a path to a config file. If the path is given, Redis loads the config file and overrides any defaults already set by <code>initServerConfig()</code> by calling <code>loadServerConfig()</code>. This function is fairly straightforward, looping over each line in the config file and converting values that match directive names to appropriate types for the matching member in the <code>server</code> struct. At this point, Redis will daemonize and detach from the controlling terminal if it has been configured to do so.</p>
<h3 id="initserver"><code>initServer()</code></h3>
<p><code>initServer()</code> finishes the job of initializing the <code>server</code> struct that was begun by <code>initServerConfig()</code>. First, it sets up signal handling (<code>SIGHUP</code> and <code>SIGPIPE</code> signals are ignored — there is an opportunity to improve Redis by adding the ability to reload its config file when it receives a <code>SIGHUP</code>, in the fashion of other daemons), including printing a stacktrace if the server receives a <code>SIGSEGV</code> (and other related signals), see <code>segvHandler()</code>.</p>
<p>A number of doubly-linked lists (see <code>adlist.h</code>) are created to keep track of clients, slaves, monitors (a client that has sent the <code>MONITOR</code> command), and an object free list.</p>
<h4 id="shared-objects">Shared objects</h4>
<p>One interesting thing Redis does is create a number of shared objects, which are accessible via the global <code>shared</code> struct. Common Redis objects that are required by many different commands, response strings and error messages, for example, can be shared without having to allocate them each time, saving memory, with the tradeoff of a bit more initialization effort at startup time.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>// redis.c:662
</span></span><span style="display:flex;"><span>shared.crlf = createObject(REDIS_STRING,sdsnew(&#34;\r\n&#34;));
</span></span><span style="display:flex;"><span>shared.ok = createObject(REDIS_STRING,sdsnew(&#34;+OK\r\n&#34;));
</span></span><span style="display:flex;"><span>shared.err = createObject(REDIS_STRING,sdsnew(&#34;-ERR\r\n&#34;));
</span></span><span style="display:flex;"><span>shared.emptybulk = createObject(REDIS_STRING,sdsnew(&#34;$0\r\n\r\n&#34;));
</span></span><span style="display:flex;"><span>// ...
</span></span></code></pre></div><h5 id="shared-integers">Shared integers</h5>
<p>The greatest impact in terms of memory savings with shared objects comes from a large pool of shared integers.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>// redis.c:705
</span></span><span style="display:flex;"><span>for (j = 0; j &lt; REDIS_SHARED_INTEGERS; j++) {
</span></span><span style="display:flex;"><span>    shared.integers[j] = createObject(REDIS_STRING,(void*)(long)j);
</span></span><span style="display:flex;"><span>    shared.integers[j]-&gt;encoding = REDIS_ENCODING_INT;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><code>createSharedObjects()</code> creates an array of the first 10,000 non-negative integers as Redis objects (strings with an integer encoding). Various Redis objects like strings, sets, and lists often contain many small integers (for IDs or counters), and they can reuse the same objects already allocated in memory, for a large potential savings. One could imagine the constant that defines the number of shared integers to be created, <code>REDIS_SHARED_INTEGERS</code>, being exposed to configuration to give users the opportunity, based on knowledge of their applications and needs, to increase the number of shared integers for greater memory savings. The tradeoff is that Redis statically allocates slightly more memory at startup time, but this would likely be a small amount compared to the overall typical database sizes and potential savings.</p>
<h4 id="event-loop">Event loop</h4>
<p><code>initServer()</code> continues by creating the core event loop, calling <code>aeCreateEventLoop()</code> (see <code>ae.c</code>) and assigning the result to the <code>el</code> member of <code>server</code>.</p>
<p>One key aspect of Redis’s implementation is the use of locally-provided wrappers to simplify and hide the complexity of common tasks, without adding dependecies at build-time. For example, <code>zmalloc.h</code> defines a number of wrappers for the family of <code>*alloc()</code> functions, which keep track of how much memory Redis has allocated. <code>sds.h</code> defines an API to a dynamic strings library (basically, a string that keeps track of its length and whether its memory can be freed.</p>
<p><code>ae.h</code> provides a platform-independent wrapper for setting up I/O event notification loops, which uses <code>epoll</code> on Linux, <code>kqueue</code> on BSD, and falls back to <code>select</code> if the respective first choice is not available.) Redis’s event loop polls for new connections and I/O events (reading requests from and writing responses to a socket), being triggered when a new event arrives. This is what makes Redis so responsive, it can serve thousands of clients simultaneously without blocking while individual requests are processed and responded to.</p>
<h4 id="databases">Databases</h4>
<p><code>initServer()</code> also initializes a number of <code>redisDb</code> objects, which are structs that encapsulate the details of a particular Redis database, including tracking expiring keys, keys that are blocking (either from a <code>B{L,R}POP</code> command or from I/O), and keys that are being watched for check-and-set. (By default there are 16 separate databases, which can be thought of as namespaces within a Redis server.)</p>
<h4 id="tcp-socket">TCP socket</h4>
<p><code>initServer()</code> is where the socket that Redis listens for connections (by default, bound to port 6379) is set up. Another Redis-local wrapper, <code>anet.h</code>, defines <code>anetTcpServer()</code> and a number of other functions that simplify the usual complexity of setting up a new socket, binding, and listening to a port.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>// redis.c:791
</span></span><span style="display:flex;"><span>server.fd = anetTcpServer(server.neterr, server.port, server.bindaddr);
</span></span><span style="display:flex;"><span>if (server.fd == -1) {
</span></span><span style="display:flex;"><span>    redisLog(REDIS_WARNING, &#34;Opening TCP port: %s&#34;, server.neterr);
</span></span><span style="display:flex;"><span>    exit(1);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h4 id="server-cron">Server cron</h4>
<p><code>initServer()</code> further allocates various dicts and lists for databases and for pub/sub, resets stats and various flags, and notes the UNIX timestamp of the server start time. It registers <code>serverCron()</code> with the event loop as a time event, executing that function once every 100 milliseconds. (This is a bit tricky, because initially, <code>serverCron()</code> is set to run in 1 millisecond by <code>initServer()</code>, in order to have the cron cycle start right away with the server startup, but then the return value of <code>serverCron()</code>, which is 100, is plugged in to the calculation of the next time the time event process should be handled.)</p>
<p><code>serverCron()</code> performs a number of periodic tasks for Redis, including verbose logging of database size (# of keys and memory used) and connected clients, resizing hash tables, closing idle/timed-out client connections, performing any post-background save or AOF rewrite cleanup, kicking off a background save if the save conditions as configured have been met (so many keys changed in so many seconds), calculating LRU information and dealing with expired keys (Redis only expires a few timed-out keys per cron cycle, using a adaptive, statistical method to avoid tying up the server, but will get more aggressive if expiring keys can help avoid out-of-memory situations), swapping out values to disk if virtual memory is enabled, and syncing with a master if this server is a slave.</p>
<h4 id="registering-connection-handler-with-event-loop">Registering connection handler with event loop</h4>
<p>Crucially, <code>initServer()</code> hooks up the event loop with the server’s TCP socket by registering the socket’s descriptor, registering the <code>acceptHandler()</code> function to be called when a new connection is accepted. (More on this below in the “Processing a request” section.)</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>// redis.c:821
</span></span><span style="display:flex;"><span>if (aeCreateFileEvent(server.el, server.fd, AE_READABLE,
</span></span><span style="display:flex;"><span>    acceptHandler, NULL) == AE_ERR) oom(&#34;creating file event&#34;);
</span></span></code></pre></div><h4 id="opening-the-aof">Opening the AOF</h4>
<p><code>initServer()</code> creates or opens the append-only file (AOF), it the server was configured to use it.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>// redis.c:824
</span></span><span style="display:flex;"><span>if (server.appendonly) {
</span></span><span style="display:flex;"><span>    server.appendfd = open(server.appendfilename,O_WRONLY|O_APPEND|O_CREAT,0644);
</span></span></code></pre></div><p>Finally, <code>initServer()</code> initializes Redis’s virtual memory system, again, if the server had been configured for it.</p>
<h3 id="back-up-to-main">Back up to <code>main()</code></h3>
<p>If the server was configured to daemonize, Redis will now try to write out a pid file (the path of which is configurable, but defaults to <code>/var/run/redis.pid</code>).</p>
<p>At this point, the server has started up, and Redis will log this fact to its log file. However, there’s still a bit more to do in <code>main()</code> before Redis is fully ready.</p>
<h4 id="restoring-data">Restoring data</h4>
<p>If there is an AOF or a database dump file (eg., <code>dump.rdb</code>), it will be loaded, restoring data to the server from a previous session. (If both exist, the AOF takes priority.)</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>// redis.c:1452
</span></span><span style="display:flex;"><span>if (server.appendonly) {
</span></span><span style="display:flex;"><span>    if (loadAppendOnlyFile(server.appendfilename) == REDIS_OK)
</span></span><span style="display:flex;"><span>        redisLog(REDIS_NOTICE,&#34;DB loaded from append only file: %ld seconds&#34;,time(NULL)-start);
</span></span><span style="display:flex;"><span>} else {
</span></span><span style="display:flex;"><span>    if (rdbLoad(server.dbfilename) == REDIS_OK)
</span></span><span style="display:flex;"><span>        redisLog(REDIS_NOTICE,&#34;DB loaded from disk: %ld seconds&#34;,time(NULL)-start);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>The server is now ready to start accepting requests.</p>
<h4 id="event-loop-setup">Event loop setup</h4>
<p>To finish up, Redis registers a function to be called each time it enters the event loop, <code>beforeSleep()</code> (since the process essentially goes to sleep while it waits to be notified of events). <code>beforeSleep()</code> does two things: it deals with serving clients that have requested keys that were swapped to disk if the virtual memory system was enabled, and it flushes the AOF to disk. The writing of the AOF is handled by <code>flushAppendOnlyFile()</code>. The function encapsulates some tricky logic about flushing the buffer that holds pending AOF writes (the frequency of which is configurable by the user).</p>
<h4 id="entering-the-event-loop">Entering the event loop</h4>
<p>Redis now enters the main event loop by calling <code>aeMain()</code>, with the argument <code>server.el</code> (remember, this member contains a pointer to an <code>aeEventLoop</code>). If there are any time (i.e., server cron) or file events to process each time through the loop, their respective handler functions will be called. <code>aeProcessEvents()</code> encapsulates this logic — time events are handled by custom logic, whereas file events are handled by the underlying <code>epoll</code> or <code>kqueue</code> or <code>select</code> I/O event notification system.</p>
<p>Because of Redis’s need to respond to time events as well as file or I/O events, it implements a custom event/polling loop, <code>aeMain()</code>. By checking to see if any time events need processing, and utilizing file event notification, the event loop can efficiently sleep until there is work to be done, and not tie up the CPU in a tight <code>while</code> loop.</p>
<h2 id="processing-a-request--returning-a-response">Processing a request &amp; returning a response</h2>
<p><a href="https://www.pauladamsmith.com/articles/redis_under_the_hood/request-response.png"><img src="https://www.pauladamsmith.com/articles/redis_under_the_hood/request-response_th.png" alt="Request/response   diagram"></a></p>
<p>We are now inside Redis’s main event polling loop, listening on a port and waiting for clients to connect. It’s time to look at how Redis processes a command request.</p>
<h3 id="handling-a-new-connection">Handling a new connection</h3>
<p>Back under <code>initServer()</code>, Redis registered <code>acceptHandler()</code> to be called when there was an I/O event associated with the file descriptor of the socket the server is listening to (i.e., the socket has data waiting to be read or written). <code>acceptHandler()</code> creates a client object — pointer to a <code>redisClient</code>, a struct defined in <code>redis.h</code> — to represent a new client connection.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>// networking.c:347
</span></span><span style="display:flex;"><span>cfd = anetAccept(server.neterr, fd, cip, &amp;cport);
</span></span><span style="display:flex;"><span>if (cfd == AE_ERR) {
</span></span><span style="display:flex;"><span>    redisLog(REDIS_VERBOSE,&#34;Accepting client connection: %s&#34;, server.neterr);
</span></span><span style="display:flex;"><span>    return;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>redisLog(REDIS_VERBOSE,&#34;Accepted %s:%d&#34;, cip, cport);
</span></span><span style="display:flex;"><span>if ((c = createClient(cfd)) == NULL) {
</span></span><span style="display:flex;"><span>    redisLog(REDIS_WARNING,&#34;Error allocating resoures for the client&#34;);
</span></span><span style="display:flex;"><span>    close(cfd); /* May be already closed, just ingore errors */
</span></span><span style="display:flex;"><span>    return;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><code>createClient()</code> is called to allocate and initialize the client object. It selects database 0 by default (since there has to be at least one Redis db per server), and associates the client file descriptor generated by <a href="http://linux.die.net/man/2/accept"><code>accept(2)</code></a> in <code>acceptHandler()</code> with the client object. Other flags and members are initialized, and finally the client is appended to the global list of clients being tracked by <code>server.clients</code>. The key thing Redis does in <code>createClient()</code> is registering a handler with the event loop, the function <code>readQueryFromClient()</code>, for when there is data from the client connection to be read.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>// networking.c:20
</span></span><span style="display:flex;"><span>if (aeCreateFileEvent(server.el,fd,AE_READABLE, readQueryFromClient, c) == AE_ERR)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    close(fd);
</span></span><span style="display:flex;"><span>    zfree(c);
</span></span><span style="display:flex;"><span>    return NULL;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="reading-a-command-from-a-client">Reading a command from a client</h3>
<p><code>readQueryFromClient()</code> is called by the main event loop when the client makes a command request. (If you are debugging with GDB, this is a good function to set as a breakpoint.) It reads it as much as it can of the command — up to 1024 bytes — to a temporary buffer, then appends it to a client-specific query buffer. This allows Redis to process commands where the payload (command name plus arguments) is larger than 1024 bytes, or because of I/O reasons have been split up into multiple read events. It then calls <code>processInputBuffer()</code>, passing the client object as an argument.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>// networking.c:754
</span></span><span style="display:flex;"><span>void readQueryFromClient(aeEventLoop *el, int fd, void *privdata, int mask) {
</span></span><span style="display:flex;"><span>    redisClient *c = (redisClient*) privdata;
</span></span><span style="display:flex;"><span>    char buf[REDIS_IOBUF_LEN];
</span></span><span style="display:flex;"><span>    int nread;
</span></span><span style="display:flex;"><span>    // ...
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    nread = read(fd, buf, REDIS_IOBUF_LEN);
</span></span><span style="display:flex;"><span>    // ...
</span></span><span style="display:flex;"><span>    if (nread) {
</span></span><span style="display:flex;"><span>        size_t oldlen = sdslen(c-&gt;querybuf);
</span></span><span style="display:flex;"><span>        c-&gt;querybuf = sdscatlen(c-&gt;querybuf, buf, nread);
</span></span><span style="display:flex;"><span>        c-&gt;lastinteraction = time(NULL);
</span></span><span style="display:flex;"><span>        /* Scan this new piece of the query for the newline. We do this
</span></span><span style="display:flex;"><span>         * here in order to make sure we perform this scan just one time
</span></span><span style="display:flex;"><span>         * per piece of buffer, leading to an O(N) scan instead of O(N*N) */
</span></span><span style="display:flex;"><span>        if (c-&gt;bulklen == -1 &amp;&amp; c-&gt;newline == NULL)
</span></span><span style="display:flex;"><span>            c-&gt;newline = strchr(c-&gt;querybuf+oldlen,&#39;\n&#39;);
</span></span><span style="display:flex;"><span>    } else {
</span></span><span style="display:flex;"><span>        return;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    Processinputbuffer(c);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><code>processInputBuffer()</code> parses the raw query from the client into arguments for execution of a Redis command. It first has to contend with the possibility that the client is blocked in a <code>B{L,R}POP</code> command, and bails early if that is the case. The function then parses the raw query buffer into arguments, creating Redis string objects of each and storing them in an array on the client object. The query is in the form of the <a href="http://code.google.com/p/redis/wiki/ProtocolSpecification">Redis protocol</a>. <code>processInputBuffer()</code> is really a protocol parser, calling back to <code>processCommand()</code> to fully parse the query. Somewhat confusingly, the source code comments describe parsing the “multi bulk command type,” an alternative protocol originally meant for commands like <code>MSET</code>, but it actually is now the main Redis protocol for all commands. It is binary-safe and easy to parse and debug. (Note: this code has been refactored for the upcoming 2.2 release and is a bit easier to follow.) Now it’s time to actually execute the command the client has sent, by calling <code>processCommand()</code> on the client object.</p>
<p><code>processCommand()</code> takes the arguments of a command from a client and executes it. Before it gets to the actual execution of the command, it performs a number of checks — if any check fails, it appends a error message to the client object’s reply list and returns to the caller, <code>processInputBuffer()</code>. After handling the <code>QUIT</code> command as a special case (in order to shut down the client safely), <code>processCommand()</code> looks up the command name in the <code>commandTable</code> that was previously set up during Redis’s start up cycle. If it’s an unknown command, or the client got the arity of the command wrong, it’s an error. While it’s not commonly used, Redis can be configured to require a password to authenticate a client before it will accept commands, and this is the stage where Redis will check if the client is authenticate, and will set an error if not. If Redis is configured to use up to a maximum amount of memory, it will at this point try to free up memory if it can (be freeing objects from the free list and removing expired keys), otherwise if the server is over the limit, it won’t process commands with the <code>REDIS_CMD_DENYOOM</code> flag set (mainly writes like <code>SET</code>, <code>INCR</code>, <code>RPUSH</code>, <code>ZADD</code>, etc.), again, an error. One final check Redis makes is that a client can only issue <code>SUBSCRIBE</code> or <code>UNSUBSCRIBE</code> commands while there are outstanding channels subscribed to, otherwise, it’s an error. If all the checks have been passed, the command will be executed, by calling <code>call()</code> with the client object and the command object as arguments.</p>
<h3 id="executing-the-command-and-responding">Executing the command and responding</h3>
<p><code>call()</code>, gets a pointer to function of type <code>struct redisCommandProc</code>, from the <code>proc</code> member of the <code>command</code> object, which takes a single argument, that of a client object. The Redis command procedure is called.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>// redis.c:864
</span></span><span style="display:flex;"><span>void call(redisClient *c, struct redisCommand *cmd) {
</span></span><span style="display:flex;"><span>    long long dirty;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    dirty = server.dirty;
</span></span><span style="display:flex;"><span>    cmd-&gt;proc(c);
</span></span><span style="display:flex;"><span>    dirty = server.dirty-dirty;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>// ...
</span></span></code></pre></div><p>Each Redis command is responsible for setting the reply for the client. This is possible because the signature of a Redis command procedure is of a single argument, which is the client object. Likewise, each command procedure is responsible for encoding, or deserializing, arguments from the command, and for decoding, or serializing, Redis objects in memory for response to the client.</p>
<p>Write commands, like <code>SET</code> and <code>ZADD</code>, make the server “dirty,” in other words, the server is marked as having pages in memory that have changed. This is important for the automatic save process, which keeps track of how many keys have changed in a certain period, or the writing to the AOF. The function calls <code>feedAppendOnlyFile()</code> if use of the AOF has been enabled, which writes out the command buffer from the client to the AOF, so the command can be replayed. (It translates commands that set a relative key expiration to an absolute expiration, but otherwise it basically copies the command as it came in from the client, see <code>catAppendOnlyGenericCommand()</code>.) If any slaves are connected, <code>call()</code> will send the command to each of them to be executed locally, see <code>replicationFeedSlaves()</code>. Likewise, if any clients are connected and have issued the <code>MONITOR</code> command, Redis will send a representation of the command, prefixed with a timestamp, see <code>replicationFeedMonitors()</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>// redis.c:871 (call() cont.&#39;d)
</span></span><span style="display:flex;"><span>    // ...
</span></span><span style="display:flex;"><span>    if (server.appendonly &amp;&amp; dirty)
</span></span><span style="display:flex;"><span>        feedAppendOnlyFile(cmd,c-&gt;db-&gt;id,c-&gt;argv,c-&gt;argc);
</span></span><span style="display:flex;"><span>    if ((dirty || cmd-&gt;flags &amp; REDIS_CMD_FORCE_REPLICATION) &amp;&amp;
</span></span><span style="display:flex;"><span>        listLength(server.slaves))
</span></span><span style="display:flex;"><span>        replicationFeedSlaves(server.slaves,c-&gt;db-&gt;id,c-&gt;argv,c-&gt;argc);
</span></span><span style="display:flex;"><span>    if (listLength(server.monitors))
</span></span><span style="display:flex;"><span>        replicationFeedMonitors(server.monitors,c-&gt;db-&gt;id,c-&gt;argv,c-&gt;argc);
</span></span><span style="display:flex;"><span>    server.stat_numcommands++;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Control returns to the caller, <code>processCommand()</code>, which resets the client object for subsequent commands.</p>
<p>As mentioned, each Redis command procedure is itself responsible for setting the response to be sent to the client. After <code>readQueryFromClient()</code> exits and Redis returns the to event loop in <code>aeMain()</code>, <code>aeProcessEvents()</code> will pick up the waiting response in the write buffer and will copy it to the socket the client is connected on.</p>
<p>And that’s it! The response has been sent, and both client and server are back to a state where they can respectively emit and process more Redis commands.</p>
<h2 id="summary">Summary</h2>
<p>Redis starts up by initializing a global server state variable, and reading in an optional configuration file to override any defaults. It sets up a global command table that connects command names with the actual function that implements the command. It creates an event loop using the best available underlying system library for event/readiness notification, and registers a handler function for when there is a new client socket connection to accept. It also registers a periodic (i.e., time-based) event handler for dealing with <code>cron</code>-like tasks like key expiry that need to be addressed outside the regular client-handling path. Once a client has connected, a function is registered on the event loop for being notified when the client has data to be read (i.e., a query for a command). The client’s query is parsed and a command handler is called to execute the command and write the response back to the client (the writing of data to the client is also handled by the event-notification loop). The client object is reset and server is ready to process more queries.</p>
<h2 id="next-time--tracing-a-set-and-get">Next time — tracing a <code>SET</code> and <code>GET</code></h2>
<p>I’ll follow-up this article with one that takes a close look at the processing of two commands, <code>SET</code> and <code>GET</code>, by stepping through the implementation of each command’s procedure and examining the data structures Redis uses to store and index data. <strong>March 15, 2011</strong>: <a href="https://www.pauladamsmith.com/blog/2011/03/redis_get_set.html">here it is</a>.</p>
<p>—<a href="https://www.pauladamsmith.com/">Paul Smith</a> (<a href="http://twitter.com/paulsmith">follow me on the Twitter</a>)</p>
<p><em>Thanks to pietern on <code>#redis</code> for feedback on a draft of this article</em></p>
<p>October 18, 2010</p>

    </div>
    <footer class="post-footer">
     
 
<div class="post-tags">     
     
    <a href="http://shanks.link/tags/redis" rel="tag" title="redis">#redis#</a>
    
</div>



     <div class="post-nav">
    <div class="post-nav-next post-nav-item">
    
        <a href="http://shanks.link/blog/2021/09/02/more-redis-internals-tracing-a-get-set/" rel="next" title="More Redis internals: Tracing a GET &amp; SET">
        <i class="fa fa-chevron-left"></i> More Redis internals: Tracing a GET &amp; SET
        </a>
    
    </div>

    <div class="post-nav-prev post-nav-item">
    
        <a href="http://shanks.link/blog/2021/08/26/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3linux-io%E6%A8%A1%E5%9E%8B%E4%BA%8C/" rel="prev" title="深入理解Linux IO模型(二)">
        深入理解Linux IO模型(二) <i class="fa fa-chevron-right"></i>
        </a>
    
    </div>
</div>
      
     
     
     





<script src="https://utteranc.es/client.js"
        repo="shankusu2017@gmail.com/"
        issue-term="pathname"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>
<noscript>Please enable JavaScript to view the <a href="https://github.com/utterance">comments powered by utterances.</a></noscript>

    </footer>
  </article>
</section>

          </div>
        </div>
        <div class="sidebar-toggle">
  <div class="sidebar-toggle-line-wrap">
    <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
    <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
    <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
  </div>
</div>
<aside id="sidebar" class="sidebar">
  <div class="sidebar-inner">

    <section class="site-overview sidebar-panel  sidebar-panel-active ">
      <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image"
        src="http://shanks.link/img/logo.jpg"
        alt="shankusu2017@gmail.com" />
    <p class="site-author-name" itemprop="name">shankusu2017@gmail.com</p>
    <p class="site-description motion-element" itemprop="description"> </p>
</div>
      <nav class="site-state motion-element">
    <div class="site-state-item site-state-posts">
      <a href="http://shanks.link/post/">
        <span class="site-state-item-count">492</span>
        <span class="site-state-item-name">日志</span>
      </a>
    </div>
    <div class="site-state-item site-state-categories">    
        <a href="http://shanks.link/categories/">      
         
        <span class="site-state-item-count">32</span>
        
        <span class="site-state-item-name">分类</span>
        
        </a>
    </div>

    <div class="site-state-item site-state-tags">
        <a href="http://shanks.link/tags/">
         
        <span class="site-state-item-count">37</span>
        
        <span class="site-state-item-name">标签</span>
        </a>
    </div>
</nav>
      
      
<div class="links-of-author motion-element">
    
        <span class="links-of-author-item">
        <a href="https://github.com/shankusu2017" target="_blank" title="GitHub">
            <i class="fa fa-fw fa-github"></i>
            GitHub
        </a>
        </span>
    
</div>


      

      <div class="links-of-blogroll motion-element inline">
<script type="text/javascript" src="//rf.revolvermaps.com/0/0/8.js?i=5b4f2ucxar6&amp;m=0&amp;s=220&amp;c=ff0000&amp;cr1=ffffff&amp;f=arial&amp;l=33&amp;bv=35" async="async"></script>
</div>

    </section>
    
  </div>
</aside>

      </div>
    </main>
   
    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  <span itemprop="copyrightYear">  &copy; 
  2009 - 2022</span>
  <span class="with-love"><i class="fa fa-heart"></i></span>
  <span class="author" itemprop="copyrightHolder">愿星光伴你左右</span>
</div>
<div class="powered-by">
  Powered by - <a class="theme-link" href="http://gohugo.io" target="_blank" title="hugo" >Hugo v0.101.0</a>
</div>
<div class="theme-info">
  Theme by - <a class="theme-link" href="https://github.com/xtfly/hugo-theme-next" target="_blank"> NexT
  </a>
</div>


      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
      <span id="scrollpercent"><span>0</span>%</span>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>
<script type="text/javascript" src="http://shanks.link/js/vendor/jquery/index.js?v=2.1.3"></script>
<script type="text/javascript" src="http://shanks.link/js/vendor/fastclick/lib/fastclick.min.js?v=1.0.6"></script> 
<script type="text/javascript" src="http://shanks.link/js/vendor/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
<script type="text/javascript" src="http://shanks.link/js/vendor/velocity/velocity.min.js?v=1.2.1"></script>
<script type="text/javascript" src="http://shanks.link/js/vendor/velocity/velocity.ui.min.js?v=1.2.1"></script>
<script src="http://shanks.link/js/vendor/ua-parser-js/dist/ua-parser.min.js?v=0.7.9"></script>

<script src="http://shanks.link/js/vendor/fancybox/jquery.fancybox.pack.js?v=2.1.5"></script>

<script type="text/javascript" src="http://shanks.link/js/utils.js"></script>
<script type="text/javascript" src="http://shanks.link/js/motion.js"></script>
<script type="text/javascript" src="http://shanks.link/js/affix.js"></script>
<script type="text/javascript" src="http://shanks.link/js/schemes/pisces.js"></script>

<script type="text/javascript" src="http://shanks.link/js/scrollspy.js"></script>
<script type="text/javascript" src="http://shanks.link/js/post-details.js"></script>
<script type="text/javascript" src="http://shanks.link/js/toc.js"></script>

<script type="text/javascript" src="http://shanks.link/js/bootstrap.js"></script>

<script type="text/javascript" src="http://shanks.link/js/search.js"></script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX", "output/HTML-CSS"],
    tex2jax: {
      inlineMath: [ ['$','$'] ],
      displayMath: [ ['$$','$$'] ],
      processEscapes: true
    },
    "HTML-CSS": { fonts: ["TeX"] }
  });
</script>
<script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML' async></script>
</body>
</html>